<!-- Bills Global Inbox Section -->
<!-- Uses allocations_layout.html with hide_allocations=True -->
{% load static %}

{% include "core/components/allocations_layout.html" with section_id="billsInbox" main_table_columns=main_table_columns allocations_columns=allocations_columns hide_allocations=True viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Bills Inbox Section JS -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsInboxMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Inbox
    AllocationsManager.init({
        sectionId: 'billsInbox',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: false,
            confirmDelete: true,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false,
            emailViewer: true
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No bills in inbox.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || bill.attachment_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // 1. Xero Instance / Project dropdown
                var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                combinedSelect.append($('<option>').val('').text('Select...'));
                
                // Add Xero Instances
                if (window.billsInboxData && window.billsInboxData.xero_instances) {
                    var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                    combinedSelect.append(xeroHeader);
                    window.billsInboxData.xero_instances.forEach(function(instance) {
                        var option = $('<option>')
                            .val('xero_' + instance.xero_instance_pk)
                            .text('  ' + instance.xero_name);
                        if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                
                // Add Projects
                if (window.billsInboxData && window.billsInboxData.projects) {
                    var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                    combinedSelect.append(projectHeader);
                    window.billsInboxData.projects.forEach(function(project) {
                        var option = $('<option>')
                            .val('project_' + project.projects_pk)
                            .text('  ' + project.project);
                        if (bill.project_pk === project.projects_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                
                // Add Stocktake
                var stocktakeHeader = $('<option>').val('').text('─── Stocktake ───').prop('disabled', true);
                combinedSelect.append(stocktakeHeader);
                var stocktakeOption = $('<option>')
                    .val('stocktake_-1')
                    .text('  Stocktake');
                if (bill.project_pk === -1) {
                    stocktakeOption.prop('selected', true);
                }
                combinedSelect.append(stocktakeOption);
                
                row.append($('<td>').append(combinedSelect));
                
                // 2. Supplier dropdown with inline new supplier form
                var supplierCell = $('<td>').addClass('supplier-cell');
                var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                
                var xeroInstanceId = bill.xero_instance_id;
                if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
                    // Add "+ New Supplier" option
                    supplierSelect.append($('<option>').val('__new__').text('+ New Supplier').addClass('new-supplier-option'));
                    
                    window.billsInboxData.suppliers.forEach(function(supplier) {
                        if (supplier.xero_instance_id === xeroInstanceId) {
                            var option = $('<option>')
                                .val(supplier.contact_pk)
                                .text(supplier.name);
                            if (bill.contact_pk === supplier.contact_pk) {
                                option.prop('selected', true);
                            }
                            supplierSelect.append(option);
                        }
                    });
                } else {
                    supplierSelect.prop('disabled', true);
                    supplierSelect.find('option:first').text('Select Xero Instance first...');
                }
                supplierCell.append(supplierSelect);
                
                // Inline new supplier form (hidden by default)
                var newSupplierForm = $('<div>').addClass('new-supplier-form').hide();
                newSupplierForm.html(`
                    <div style="display: flex; gap: 4px; margin-top: 4px; align-items: center;">
                        <input type="text" class="form-control form-control-sm new-supplier-name" placeholder="Supplier Name" style="flex: 1; min-width: 100px;">
                        <button type="button" class="btn btn-sm btn-success create-supplier-btn" title="Create"><i class="fas fa-check"></i></button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-new-supplier-btn" title="Cancel"><i class="fas fa-times"></i></button>
                    </div>
                `);
                supplierCell.append(newSupplierForm);
                row.append(supplierCell);
                
                // 3. Bill # input
                var billNumberInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm bill-number-input')
                    .val(bill.supplier_bill_number || '');
                row.append($('<td>').append(billNumberInput));
                
                // 4. $ Gross (calculated: Net + GST)
                var netVal = bill.total_net !== null ? parseFloat(bill.total_net) : 0;
                var gstVal = bill.total_gst !== null ? parseFloat(bill.total_gst) : 0;
                var grossVal = netVal + gstVal;
                var grossCell = $('<td>').addClass('gross-cell').text(grossVal ? Utils.formatCurrency(grossVal) : '');
                row.append(grossCell);
                
                // 5. $ Net input
                var netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm net-input')
                    .val(bill.total_net !== null ? bill.total_net : '');
                row.append($('<td>').append(netInput));
                
                // 6. $ GST input
                var gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm gst-input')
                    .val(bill.total_gst !== null ? bill.total_gst : '');
                row.append($('<td>').append(gstInput));
                
                // 6. Email link
                var emailLink = $('<a>')
                    .attr('href', '#')
                    .text('email')
                    .addClass('email-link')
                    .attr('data-email-html', bill.email_body_html || '')
                    .attr('data-email-text', bill.email_body_text || '')
                    .attr('data-email-subject', bill.email_subject || '')
                    .attr('data-email-from', bill.email_from || '')
                    .attr('title', bill.email_subject + ' from ' + bill.email_from);
                row.append($('<td>').addClass('col-action-first').append(emailLink));
                
                // 7. Send button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary send-bill-btn')
                    .text('Send')
                    .attr('data-bill-pk', bill.bill_pk)
                    .prop('disabled', true);
                row.append($('<td>').addClass('col-action').append(sendBtn));
                
                // 8. Archive button
                var archiveBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger archive-bill-btn')
                    .html('<i class="fas fa-archive"></i>')
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('title', 'Archive');
                row.append($('<td>').addClass('col-action').append(archiveBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                window.currentBillData = cfg.data.currentItem;
                // Validate send button
                validateInboxSendButton(pk);
            }
        },
        api: {
            // No allocation loading for inbox
        },
        callbacks: {}
    });
    
    // Validate Send button for Inbox mode
    function validateInboxSendButton(billPk) {
        var button = $('button[data-bill-pk="' + billPk + '"].send-bill-btn');
        if (button.length === 0) return;
        
        var row = button.closest('tr');
        var isValid = true;
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        var supplierPk = row.find('.supplier-select').val();
        var billNumber = row.find('.bill-number-input').val();
        var netValue = row.find('.net-input').val();
        var gstValue = row.find('.gst-input').val();
        
        if (!xeroInstanceOrProject) isValid = false;
        if (!supplierPk) isValid = false;
        if (!billNumber || billNumber.trim() === '') isValid = false;
        if (!netValue || parseFloat(netValue) === 0) isValid = false;
        if (gstValue === null || gstValue === undefined || gstValue === '') isValid = false;
        
        if (isValid) {
            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
        } else {
            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
        }
    }
    
    // Load Bills Inbox data
    window.loadBillsInbox = function() {
        // Guard: ensure table exists before trying to load
        if (!$('#billsInboxMainTableBody').length) {
            return;
        }
        
        $.ajax({
            url: '{% url "core:get_bills_list" %}',
            type: 'GET',
            success: function(response) {
                
                // Store data globally
                window.billsInboxData = response;
                
                // Filter for Inbox bills (status = -2)
                var inboxBills = response.bills.filter(function(bill) {
                    return bill.bill_status === -2;
                });
                
                // Populate table
                AllocationsManager.populateMainTable('billsInbox', inboxBills);
                
                // Initialize searchable dropdowns for supplier selects
                initSupplierSearchableDropdowns();
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsInboxMainTable');
                
                // Bind validation to input changes
                bindInboxInputHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load bills:', error);
            }
        });
    };
    
    // Initialize searchable dropdowns for supplier selects
    function initSupplierSearchableDropdowns() {
        $('#billsInboxMainTableBody .supplier-select').each(function() {
            var $select = $(this);
            // Skip if already initialized or disabled
            if ($select.data('searchable-dropdown') || $select.prop('disabled')) {
                return;
            }
            
            Utils.createSearchableDropdown($select, {
                pinnedValues: ['__new__'],
                placeholder: 'Search suppliers...',
                onChange: function(value, text, $sel) {
                    var row = $sel.closest('tr');
                    
                    // Trigger the existing change handler for "+ New Supplier" logic
                    if (value === '__new__') {
                        row.find('.searchable-dropdown-wrapper').hide();
                        row.find('.new-supplier-form').show();
                        row.find('.new-supplier-name').val('').focus();
                    }
                    
                    // Validate send button
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                }
            });
        });
    }
    
    // Bind input change handlers for validation
    function bindInboxInputHandlers() {
        $(document).off('change.billsInbox input.billsInbox', '#billsInboxMainTableBody');
        
        $(document).on('change.billsInbox input.billsInbox', '#billsInboxMainTableBody .xero-project-select, #billsInboxMainTableBody .supplier-select, #billsInboxMainTableBody .bill-number-input, #billsInboxMainTableBody .net-input, #billsInboxMainTableBody .gst-input', function() {
            var row = $(this).closest('tr');
            var billPk = row.attr('data-bill-pk');
            validateInboxSendButton(billPk);
            
            // Auto-calculate GST when Net changes
            if ($(this).hasClass('net-input')) {
                var netValue = parseFloat($(this).val()) || 0;
                var gstValue = (netValue * 0.1).toFixed(2);
                row.find('.gst-input').val(gstValue);
            }
            
            // Update $ Gross when Net or GST changes
            if ($(this).hasClass('net-input') || $(this).hasClass('gst-input')) {
                var netVal = parseFloat(row.find('.net-input').val()) || 0;
                var gstVal = parseFloat(row.find('.gst-input').val()) || 0;
                var grossVal = netVal + gstVal;
                row.find('.gross-cell').text(grossVal ? Utils.formatCurrency(grossVal) : '');
            }
            
            // Update supplier dropdown when Xero Instance changes
            if ($(this).hasClass('xero-project-select')) {
                updateSupplierDropdown(row, $(this).val());
            }
        });
    }
    
    // Update supplier dropdown based on Xero Instance selection
    function updateSupplierDropdown(row, selectedValue) {
        var supplierSelect = row.find('.supplier-select');
        supplierSelect.empty().append($('<option>').val('').text('Select Supplier...'));
        
        // Hide any open new supplier form
        row.find('.new-supplier-form').hide();
        // Show the searchable dropdown wrapper, not the hidden original select
        row.find('.searchable-dropdown-wrapper').show();
        
        var xeroInstanceId = null;
        if (selectedValue && selectedValue.startsWith('xero_')) {
            xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
        } else if (selectedValue && selectedValue.startsWith('project_')) {
            var projectPk = parseInt(selectedValue.replace('project_', ''));
            var project = window.billsInboxData.projects.find(function(p) {
                return p.projects_pk === projectPk;
            });
            if (project) xeroInstanceId = project.xero_instance_id;
        } else if (selectedValue && selectedValue.startsWith('stocktake_')) {
            // Stocktake uses the first available Xero instance
            if (window.billsInboxData && window.billsInboxData.xero_instances && window.billsInboxData.xero_instances.length > 0) {
                xeroInstanceId = window.billsInboxData.xero_instances[0].xero_instance_pk;
            }
        }
        
        // Store xeroInstanceId on the row for later use
        row.attr('data-xero-instance-id', xeroInstanceId || '');
        
        if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
            supplierSelect.prop('disabled', false);
            // Add "+ New Supplier" option
            supplierSelect.append($('<option>').val('__new__').text('+ New Supplier'));
            
            window.billsInboxData.suppliers.forEach(function(supplier) {
                if (supplier.xero_instance_id === xeroInstanceId) {
                    supplierSelect.append($('<option>').val(supplier.contact_pk).text(supplier.name));
                }
            });
            
            // Refresh or initialize searchable dropdown
            var controller = supplierSelect.data('searchable-dropdown');
            if (controller) {
                controller.refresh();
            } else {
                Utils.createSearchableDropdown(supplierSelect, {
                    pinnedValues: ['__new__'],
                    placeholder: 'Search suppliers...',
                    onChange: function(value, text, $sel) {
                        var r = $sel.closest('tr');
                        if (value === '__new__') {
                            r.find('.searchable-dropdown-wrapper').hide();
                            r.find('.new-supplier-form').show();
                            r.find('.new-supplier-name').val('').focus();
                        }
                        var billPk = r.attr('data-bill-pk');
                        validateInboxSendButton(billPk);
                    }
                });
            }
        } else {
            supplierSelect.prop('disabled', true);
            supplierSelect.find('option:first').text('Select Xero Instance first...');
            // Destroy searchable dropdown if disabled
            var controller = supplierSelect.data('searchable-dropdown');
            if (controller) {
                controller.destroy();
            }
        }
    }
    
    // Handle "+ New Supplier" selection - show inline form
    $(document).off('change.billsInbox', '.supplier-select');
    $(document).on('change.billsInbox', '.supplier-select', function() {
        var row = $(this).closest('tr');
        var selectedValue = $(this).val();
        
        if (selectedValue === '__new__') {
            // Show inline form, hide dropdown
            row.find('.supplier-select').hide();
            row.find('.new-supplier-form').show();
            row.find('.new-supplier-name').val('').focus();
        }
        
        // Trigger validation
        var billPk = row.attr('data-bill-pk');
        validateInboxSendButton(billPk);
    });
    
    // Cancel new supplier form
    $(document).off('click.billsInbox', '.cancel-new-supplier-btn');
    $(document).on('click.billsInbox', '.cancel-new-supplier-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var row = $(this).closest('tr');
        row.find('.new-supplier-form').hide();
        // Show the searchable dropdown wrapper, reset value
        row.find('.searchable-dropdown-wrapper').show();
        var controller = row.find('.supplier-select').val('').data('searchable-dropdown');
        if (controller) controller.refresh();
        
        var billPk = row.attr('data-bill-pk');
        validateInboxSendButton(billPk);
    });
    
    // Create new supplier
    $(document).off('click.billsInbox', '.create-supplier-btn');
    $(document).on('click.billsInbox', '.create-supplier-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var btn = $(this);
        var row = btn.closest('tr');
        var supplierName = row.find('.new-supplier-name').val().trim();
        
        if (!supplierName) {
            row.find('.new-supplier-name').focus();
            return;
        }
        
        // Get xero instance ID from row or from the dropdown selection
        var xeroInstanceId = row.attr('data-xero-instance-id');
        if (!xeroInstanceId) {
            var xeroProjectVal = row.find('.xero-project-select').val();
            if (xeroProjectVal && xeroProjectVal.startsWith('xero_')) {
                xeroInstanceId = parseInt(xeroProjectVal.replace('xero_', ''));
            } else if (xeroProjectVal && xeroProjectVal.startsWith('project_')) {
                var projectPk = parseInt(xeroProjectVal.replace('project_', ''));
                var project = window.billsInboxData.projects.find(function(p) {
                    return p.projects_pk === projectPk;
                });
                if (project) xeroInstanceId = project.xero_instance_id;
            } else if (xeroProjectVal && xeroProjectVal.startsWith('stocktake_')) {
                // Stocktake uses first Xero instance
                if (window.billsInboxData && window.billsInboxData.xero_instances && window.billsInboxData.xero_instances.length > 0) {
                    xeroInstanceId = window.billsInboxData.xero_instances[0].xero_instance_pk;
                }
            }
        }
        
        if (!xeroInstanceId) {
            alert('Please select a Xero Instance or Project first.');
            return;
        }
        
        // Show loading state
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/create_supplier/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({
                name: supplierName,
                xero_instance_id: parseInt(xeroInstanceId)
            }),
            success: function(response) {
                if (response.status === 'success') {
                    var newSupplier = response.supplier;
                    
                    // Add to beginning of global suppliers list (so it stays at top on refresh)
                    if (window.billsInboxData && window.billsInboxData.suppliers) {
                        window.billsInboxData.suppliers.unshift(newSupplier);
                    }
                    
                    // Add option to dropdown right after "+ New Supplier" and select it
                    var supplierSelect = row.find('.supplier-select');
                    var newOption = $('<option>').val(newSupplier.contact_pk).text(newSupplier.name);
                    // Insert after the "+ New Supplier" option (which is the second option)
                    supplierSelect.find('option[value="__new__"]').after(newOption);
                    supplierSelect.val(newSupplier.contact_pk);
                    
                    // Hide form, show searchable dropdown wrapper
                    row.find('.new-supplier-form').hide();
                    row.find('.searchable-dropdown-wrapper').show();
                    // Refresh searchable dropdown to show new option
                    var controller = supplierSelect.data('searchable-dropdown');
                    if (controller) controller.refresh();
                    
                    // Validate send button
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                } else {
                    alert('Error creating supplier: ' + response.message);
                    btn.prop('disabled', false).html('<i class="fas fa-check"></i>');
                }
            },
            error: function(xhr) {
                var errorMsg = 'Failed to create supplier.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMsg);
                btn.prop('disabled', false).html('<i class="fas fa-check"></i>');
            }
        });
    });
    
    // Handle Enter key in new supplier name input
    $(document).off('keypress.billsInbox', '.new-supplier-name');
    $(document).on('keypress.billsInbox', '.new-supplier-name', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).closest('.new-supplier-form').find('.create-supplier-btn').click();
        }
    });
    
    // Archive button handler
    $(document).off('click.billsInbox', '.archive-bill-btn');
    $(document).on('click.billsInbox', '.archive-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var billPk = $(this).attr('data-bill-pk');
        var row = $(this).closest('tr');
        
        if (confirm('Are you sure you want to archive this Bill?')) {
            $.ajax({
                url: '{% url "core:archive_bill" %}',
                type: 'POST',
                headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                data: JSON.stringify({ bill_pk: billPk }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.status === 'success') {
                        row.fadeOut(300, function() { $(this).remove(); });
                        
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    } else {
                        alert('Failed to archive bill: ' + response.message);
                    }
                },
                error: function() {
                    alert('Failed to archive bill. Please try again.');
                }
            });
        }
    });
    
    // Send button handler
    // Note: Email viewing is now handled by AllocationsManager with emailViewer: true
    $(document).off('click.billsInbox', '.send-bill-btn');
    $(document).on('click.billsInbox', '.send-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var row = button.closest('tr');
        var billPk = button.attr('data-bill-pk');
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        var supplierPk = row.find('.supplier-select').val();
        var billNumber = row.find('.bill-number-input').val();
        var totalNet = parseFloat(row.find('.net-input').val());
        var totalGst = parseFloat(row.find('.gst-input').val());
        
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/send_bill/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({
                bill_pk: parseInt(billPk),
                xero_instance_or_project: xeroInstanceOrProject,
                supplier_pk: parseInt(supplierPk),
                bill_number: billNumber,
                total_net: totalNet,
                total_gst: totalGst
            }),
            success: function(response) {
                if (response.status === 'success') {
                    // Get next row (or previous if no next) before fade
                    var nextRow = row.next('tr');
                    if (!nextRow.length) {
                        nextRow = row.prev('tr');
                    }
                    
                    AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                        
                        // Auto-select next row after fade completes
                        if (nextRow.length) {
                            nextRow.click();
                        }
                    });
                } else {
                    alert('Error: ' + response.message);
                    button.prop('disabled', false).text('Send');
                }
            },
            error: function(xhr) {
                var errorMsg = 'Failed to send bill. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMsg);
                button.prop('disabled', false).text('Send');
            }
        });
    });
    
    // Make function globally available
    window.loadBillsInbox = window.loadBillsInbox;
    
})();
</script>
