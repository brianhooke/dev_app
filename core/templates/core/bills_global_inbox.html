<!-- Bills Global Inbox Section -->
<!-- Uses allocations_layout.html with hide_allocations=True -->
{% load static %}

{% include "core/components/allocations_layout.html" with section_id="billsInbox" main_table_columns=main_table_columns allocations_columns=allocations_columns hide_allocations=True viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Bills Inbox Section JS -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsInboxMainTableBody').length === 0) {
        console.log('Bills Inbox section: Table not found, skipping init');
        return;
    }
    
    console.log('Bills Inbox section: Self-initializing...');
    
    // Initialize AllocationsManager for Bills Inbox
    AllocationsManager.init({
        sectionId: 'billsInbox',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: false,
            confirmDelete: true,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false,
            emailViewer: true
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No bills in inbox.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || bill.attachment_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // 1. Xero Instance / Project dropdown
                var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                combinedSelect.append($('<option>').val('').text('Select...'));
                
                // Add Xero Instances
                if (window.billsInboxData && window.billsInboxData.xero_instances) {
                    var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                    combinedSelect.append(xeroHeader);
                    window.billsInboxData.xero_instances.forEach(function(instance) {
                        var option = $('<option>')
                            .val('xero_' + instance.xero_instance_pk)
                            .text('  ' + instance.xero_name);
                        if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                
                // Add Projects
                if (window.billsInboxData && window.billsInboxData.projects) {
                    var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                    combinedSelect.append(projectHeader);
                    window.billsInboxData.projects.forEach(function(project) {
                        var option = $('<option>')
                            .val('project_' + project.projects_pk)
                            .text('  ' + project.project);
                        if (bill.project_pk === project.projects_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                row.append($('<td>').append(combinedSelect));
                
                // 2. Supplier dropdown
                var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                
                var xeroInstanceId = bill.xero_instance_id;
                if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
                    window.billsInboxData.suppliers.forEach(function(supplier) {
                        if (supplier.xero_instance_id === xeroInstanceId) {
                            var option = $('<option>')
                                .val(supplier.contact_pk)
                                .text(supplier.name);
                            if (bill.contact_pk === supplier.contact_pk) {
                                option.prop('selected', true);
                            }
                            supplierSelect.append(option);
                        }
                    });
                } else {
                    supplierSelect.prop('disabled', true);
                    supplierSelect.find('option:first').text('Select Xero Instance first...');
                }
                row.append($('<td>').append(supplierSelect));
                
                // 3. Bill # input
                var billNumberInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm bill-number-input')
                    .val(bill.supplier_bill_number || '');
                row.append($('<td>').append(billNumberInput));
                
                // 4. $ Net input
                var netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm net-input')
                    .val(bill.total_net !== null ? bill.total_net : '');
                row.append($('<td>').append(netInput));
                
                // 5. $ GST input
                var gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm gst-input')
                    .val(bill.total_gst !== null ? bill.total_gst : '');
                row.append($('<td>').append(gstInput));
                
                // 6. Email link
                var emailLink = $('<a>')
                    .attr('href', '#')
                    .text('email')
                    .addClass('email-link')
                    .attr('data-email-html', bill.email_body_html || '')
                    .attr('data-email-text', bill.email_body_text || '')
                    .attr('data-email-subject', bill.email_subject || '')
                    .attr('data-email-from', bill.email_from || '')
                    .attr('title', bill.email_subject + ' from ' + bill.email_from);
                row.append($('<td>').addClass('col-action-first').append(emailLink));
                
                // 7. Send button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary send-bill-btn')
                    .text('Send')
                    .attr('data-bill-pk', bill.bill_pk)
                    .prop('disabled', true);
                row.append($('<td>').addClass('col-action').append(sendBtn));
                
                // 8. Archive button
                var archiveBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger archive-bill-btn')
                    .html('<i class="fas fa-archive"></i>')
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('title', 'Archive');
                row.append($('<td>').addClass('col-action').append(archiveBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                console.log('Bill row selected:', pk);
                window.currentSelectedBillPk = pk;
                window.currentBillData = cfg.data.currentItem;
                // Validate send button
                validateInboxSendButton(pk);
            }
        },
        api: {
            // No allocation loading for inbox
        },
        callbacks: {}
    });
    
    // Validate Send button for Inbox mode
    function validateInboxSendButton(billPk) {
        var button = $('button[data-bill-pk="' + billPk + '"].send-bill-btn');
        if (button.length === 0) return;
        
        var row = button.closest('tr');
        var isValid = true;
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        var supplierPk = row.find('.supplier-select').val();
        var billNumber = row.find('.bill-number-input').val();
        var netValue = row.find('.net-input').val();
        var gstValue = row.find('.gst-input').val();
        
        if (!xeroInstanceOrProject) isValid = false;
        if (!supplierPk) isValid = false;
        if (!billNumber || billNumber.trim() === '') isValid = false;
        if (!netValue || parseFloat(netValue) === 0) isValid = false;
        if (gstValue === null || gstValue === undefined || gstValue === '') isValid = false;
        
        if (isValid) {
            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
        } else {
            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
        }
    }
    
    // Load Bills Inbox data
    window.loadBillsInbox = function() {
        console.log('Loading Bills Inbox...');
        
        $.ajax({
            url: '{% url "core:get_bills_list" %}',
            type: 'GET',
            success: function(response) {
                console.log('Bills loaded:', response);
                
                // Store data globally
                window.billsInboxData = response;
                
                // Filter for Inbox bills (status = -2)
                var inboxBills = response.bills.filter(function(bill) {
                    return bill.bill_status === -2;
                });
                
                // Populate table
                AllocationsManager.populateMainTable('billsInbox', inboxBills);
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsInboxMainTable');
                
                // Bind validation to input changes
                bindInboxInputHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load bills:', error);
            }
        });
    };
    
    // Bind input change handlers for validation
    function bindInboxInputHandlers() {
        $(document).off('change.billsInbox input.billsInbox', '#billsInboxMainTableBody');
        
        $(document).on('change.billsInbox input.billsInbox', '#billsInboxMainTableBody .xero-project-select, #billsInboxMainTableBody .supplier-select, #billsInboxMainTableBody .bill-number-input, #billsInboxMainTableBody .net-input, #billsInboxMainTableBody .gst-input', function() {
            var row = $(this).closest('tr');
            var billPk = row.attr('data-bill-pk');
            validateInboxSendButton(billPk);
            
            // Auto-calculate GST when Net changes
            if ($(this).hasClass('net-input')) {
                var netValue = parseFloat($(this).val()) || 0;
                var gstValue = (netValue * 0.1).toFixed(2);
                row.find('.gst-input').val(gstValue);
            }
            
            // Update supplier dropdown when Xero Instance changes
            if ($(this).hasClass('xero-project-select')) {
                updateSupplierDropdown(row, $(this).val());
            }
        });
    }
    
    // Update supplier dropdown based on Xero Instance selection
    function updateSupplierDropdown(row, selectedValue) {
        var supplierSelect = row.find('.supplier-select');
        supplierSelect.empty().append($('<option>').val('').text('Select Supplier...'));
        
        var xeroInstanceId = null;
        if (selectedValue && selectedValue.startsWith('xero_')) {
            xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
        } else if (selectedValue && selectedValue.startsWith('project_')) {
            var projectPk = parseInt(selectedValue.replace('project_', ''));
            var project = window.billsInboxData.projects.find(function(p) {
                return p.projects_pk === projectPk;
            });
            if (project) xeroInstanceId = project.xero_instance_id;
        }
        
        if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
            supplierSelect.prop('disabled', false);
            window.billsInboxData.suppliers.forEach(function(supplier) {
                if (supplier.xero_instance_id === xeroInstanceId) {
                    supplierSelect.append($('<option>').val(supplier.contact_pk).text(supplier.name));
                }
            });
        } else {
            supplierSelect.prop('disabled', true);
            supplierSelect.find('option:first').text('Select Xero Instance first...');
        }
    }
    
    // Archive button handler
    $(document).off('click.billsInbox', '.archive-bill-btn');
    $(document).on('click.billsInbox', '.archive-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var billPk = $(this).attr('data-bill-pk');
        var row = $(this).closest('tr');
        
        if (confirm('Are you sure you want to archive this Bill?')) {
            $.ajax({
                url: '{% url "core:archive_bill" %}',
                type: 'POST',
                headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                data: JSON.stringify({ bill_pk: billPk }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.status === 'success') {
                        row.fadeOut(300, function() { $(this).remove(); });
                        
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    } else {
                        alert('Failed to archive bill: ' + response.message);
                    }
                },
                error: function() {
                    alert('Failed to archive bill. Please try again.');
                }
            });
        }
    });
    
    // Send button handler
    // Note: Email viewing is now handled by AllocationsManager with emailViewer: true
    $(document).off('click.billsInbox', '.send-bill-btn');
    $(document).on('click.billsInbox', '.send-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var row = button.closest('tr');
        var billPk = button.attr('data-bill-pk');
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        var supplierPk = row.find('.supplier-select').val();
        var billNumber = row.find('.bill-number-input').val();
        var totalNet = parseFloat(row.find('.net-input').val());
        var totalGst = parseFloat(row.find('.gst-input').val());
        
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/send_bill/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({
                bill_pk: parseInt(billPk),
                xero_instance_or_project: xeroInstanceOrProject,
                supplier_pk: parseInt(supplierPk),
                bill_number: billNumber,
                total_net: totalNet,
                total_gst: totalGst
            }),
            success: function(response) {
                if (response.status === 'success') {
                    AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    });
                } else {
                    alert('Error: ' + response.message);
                    button.prop('disabled', false).text('Send');
                }
            },
            error: function(xhr) {
                var errorMsg = 'Failed to send bill. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMsg);
                button.prop('disabled', false).text('Send');
            }
        });
    });
    
    // Make function globally available
    window.loadBillsInbox = window.loadBillsInbox;
    
})();
</script>
