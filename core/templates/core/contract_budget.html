{% load static %}
<!--
Template: Contract Budget (contract_budget.html)

Purpose:
Contract Budget section using allocations_layout.html pattern (like contacts.html).
Displays budget items with category grouping.

Backend: contract_budget_view in contract_budget.py
- Passes is_construction, is_tender flags
- Passes main_table_columns with subheading support for construction mode

Column Behaviors:
- Category/Item: Display only (indented for items)
- Unit: Display only
- Contract Budget: Display only (execution mode)
- Working Budget: Calculated (Uncommitted + Committed)
- Uncommitted (non-construction): Input field
- Qty/Rate (construction): Input fields
- Amount (construction): Calculated (Qty Ã— Rate)
- Committed: Input field
- Cost to Complete, Billed, Fixed on Site: Display only (execution mode)
-->

<!-- Pass project type flags from Django context -->
<script>
    window.contractBudgetProjectPk = '{{ project_pk }}' !== 'None' ? '{{ project_pk }}' : null;
    window.contractBudgetIsConstruction = {{ is_construction|yesno:"true,false" }};
    window.contractBudgetIsTender = {{ is_tender|yesno:"true,false" }};
</script>

<style>
    /* Contract Budget specific styles - extend allocations_layout styles */
    
    /* Table container with fixed footer outside scroll */
    .contractBudget-container .reusable-table-container {
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 200px);
        border: 1px solid black;
        border-radius: 6px;
        overflow: hidden;
    }
    
    /* Scrollable area for table content */
    #contractBudgetTableContainer {
        flex: 1 1 auto;
        overflow-y: auto;
        min-height: 0;
    }
    
    /* Ensure table doesn't break sticky positioning */
    #contractBudgetMainTable {
        overflow: visible;
    }
    
    /* Hide the original tfoot (we'll use a fixed footer instead) */
    #contractBudgetMainTableFooter {
        display: none !important;
    }
    
    /* Fixed footer outside scroll area */
    #contractBudgetFixedFooter {
        flex-shrink: 0;
        background: var(--color-bg-muted);
        border-top: 1px solid black;
    }
    
    #contractBudgetFixedFooter table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }
    
    #contractBudgetFixedFooter td {
        padding: 4px 8px;
        font-weight: 600;
        font-size: 13px;
        border: none;
        box-shadow: none;
    }
    
    /* Add visual separation between Uncommitted and Committed column groups */
    .contractBudget-container .reusable-table th.uncommitted-group,
    .contractBudget-container .reusable-table th.committed-group {
        position: relative;
        box-shadow: none; /* Remove default box-shadow border */
    }
    
    .contractBudget-container .reusable-table th.uncommitted-group::after,
    .contractBudget-container .reusable-table th.committed-group::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 8px;
        right: 8px;
        height: 1px;
        background-color: black;
    }
    
    /* Internal category styling - purple */
    .contractBudget-container .reusable-table tr.category-row.internal-category {
        background-color: #e6d5f5;
        color: #6f2da8;
    }
    
    .contractBudget-container .reusable-table tr.category-row.internal-category:hover {
        background-color: #d9c5ed;
    }
    
    .contractBudget-container .reusable-table tr.item-row.internal-item {
        color: #6f2da8;
    }
    
    .contractBudget-container .reusable-table tr.item-row.internal-item td {
        color: #6f2da8;
    }
    
    /* Labour category styling - pink-purple */
    .contractBudget-container .reusable-table tr.category-row.labour-category {
        background-color: #fce4ec;
        color: #c2185b;
    }
    
    .contractBudget-container .reusable-table tr.category-row.labour-category:hover {
        background-color: #f8bbd9;
    }
    
    .contractBudget-container .reusable-table tr.item-row.labour-item {
        color: #c2185b;
    }
    
    .contractBudget-container .reusable-table tr.item-row.labour-item td {
        color: #c2185b;
    }
    
    /* Item row indent */
    .contractBudget-container .reusable-table td.indent {
        padding-left: 30px;
    }
    
    /* Collapsible category rows */
    .contractBudget-container .reusable-table tr.category-row {
        cursor: pointer;
    }
    
    .contractBudget-container .reusable-table tr.category-row .collapse-icon {
        margin-right: 6px;
        transition: transform 0.2s ease;
        display: inline-block;
        width: 12px;
    }
    
    .contractBudget-container .reusable-table tr.category-row.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    .contractBudget-container .reusable-table tr.category-row .subtotal-cell {
        font-weight: normal;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .contractBudget-container .reusable-table tr.category-row.collapsed .subtotal-cell {
        opacity: 1;
    }
    
    .contractBudget-container .reusable-table tr.item-row.hidden-by-collapse {
        display: none;
    }
    
    /* Compact inputs for contract budget - right-align */
    .contractBudget-container .reusable-table input[type="number"] {
        width: 100%;
        text-align: right;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
    }
    
    /* Left-align all cells (same as quotes) - inherits from reusable-table */
    .contractBudget-container .reusable-table tbody td,
    .contractBudget-container .reusable-table thead th {
        text-align: left;
    }
    
    /* Click-to-edit cells */
    .contractBudget-container .click-to-edit {
        color: var(--color-primary, #007bff);
        cursor: pointer;
        text-decoration: none;
    }
    
    .contractBudget-container .click-to-edit:hover {
        text-decoration: underline;
    }
    
    /* Notepad icon - blue border when empty, blue fill when has notes */
    .contractBudget-container .notes-icon {
        cursor: pointer;
        font-size: 14px;
        color: transparent;
        -webkit-text-stroke: 1.5px var(--onyx-blue, #007bff);
        transition: all 0.15s ease;
    }
    
    .contractBudget-container .notes-icon:hover {
        color: var(--onyx-blue, #007bff);
        -webkit-text-stroke: 0;
    }
    
    .contractBudget-container .notes-icon.has-notes {
        color: var(--onyx-blue, #007bff);
        -webkit-text-stroke: 0;
    }
    
    /* Notes row styles - inline expansion */
    .contractBudget-container .notes-row {
        background-color: var(--color-bg-muted, #f8f9fa);
    }
    
    .contractBudget-container .notes-row td {
        padding: 8px 12px !important;
    }
    
    .contractBudget-container .notes-row textarea {
        width: 100%;
        min-height: 60px;
        padding: 8px;
        border: 1px solid var(--color-border, #dee2e6);
        border-radius: 4px;
        font-size: 13px;
        resize: vertical;
    }
    
    .contractBudget-container .notes-row textarea:focus {
        outline: none;
        border-color: var(--color-primary, #007bff);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
    }
    
    /* Active notes icon when row is expanded */
    .contractBudget-container .notes-icon.active {
        color: var(--onyx-blue, #007bff);
        -webkit-text-stroke: 0;
    }
    
    /* Green clickable committed cells with values */
    .contractBudget-container .committed-clickable,
    .contractBudget-container .billed-clickable {
        color: var(--color-success, #28a745);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .contractBudget-container .committed-clickable:hover,
    .contractBudget-container .billed-clickable:hover {
        text-decoration: underline;
    }
    
    /* Green clickable contract budget cells with HC variations */
    .contractBudget-container .contract-budget-clickable {
        color: var(--color-success, #28a745);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .contractBudget-container .contract-budget-clickable:hover {
        text-decoration: underline;
    }
    
    .contractBudget-container .contract-budget-clickable.active {
        font-weight: 600;
    }
    
    /* Committed details row - green styling (similar to notes row) */
    .contractBudget-container .committed-details-row {
        background-color: rgba(40, 167, 69, 0.08);
    }
    
    .contractBudget-container .committed-details-row > td {
        padding: 8px 12px !important;
        overflow: visible;
        position: relative;
    }
    
    .contractBudget-container .committed-details-box {
        border: 1px solid var(--color-success, #28a745);
        border-radius: 4px;
        padding: 8px 12px;
        background-color: rgba(40, 167, 69, 0.05);
        background-color: #fff;
        min-width: 320px;
        position: relative;
        z-index: 10;
    }
    
    .contractBudget-container .committed-details-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
        table-layout: auto;
    }
    
    .contractBudget-container .committed-details-table th {
        text-align: left;
        font-weight: 600;
        color: var(--color-text, #212529);
        padding: 4px 8px;
        border-bottom: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .contractBudget-container .committed-details-table td {
        padding: 4px 8px !important;
        text-align: left;
        color: var(--color-text);
    }
</style>

<!-- Include the reusable allocations layout -->
{% include 'core/components/allocations_layout.html' %}

<!-- Fix Contract Budget Section will be injected via JavaScript -->

<script>
(function() {
    'use strict';
    
    
    // Get configuration from backend
    var projectPk = window.contractBudgetProjectPk;
    var isConstruction = window.contractBudgetIsConstruction || false;
    var isTender = window.contractBudgetIsTender || false;
    
    
    // Initialize when DOM is ready
    setTimeout(function() {
        if (projectPk) {
            loadContractBudget(projectPk);
        } else {
            $('#contractBudgetMainTableBody').html(
                '<tr><td colspan="' + getColCount() + '" style="text-align: center; padding: 40px; color: var(--color-text-muted);">No project selected</td></tr>'
            );
        }
    }, 100);
    
    // Create fixed footer outside scrollable area
    setTimeout(function() {
        createFixedFooter();
    }, 50);
    
    function createFixedFooter() {
        // Insert fixed footer after the scrollable container
        var tableContainer = $('#contractBudgetTableContainer');
        if (!tableContainer.length) return;
        
        // Get column widths from the main table colgroup
        var colWidths = [];
        $('#contractBudgetMainTable colgroup col').each(function() {
            colWidths.push($(this).css('width') || $(this).attr('style').match(/width:\s*([^;]+)/)[1]);
        });
        
        // Build footer HTML with matching columns
        var footerHtml = '<div id="contractBudgetFixedFooter"><table><colgroup>';
        colWidths.forEach(function(w) {
            footerHtml += '<col style="width: ' + w + ';">';
        });
        footerHtml += '</colgroup><tbody id="contractBudgetFixedFooterBody"></tbody></table></div>';
        
        // Insert after the scrollable container (inside reusable-table-container)
        tableContainer.after(footerHtml);
    }
    
    // Format date as dd-mmm-yy (e.g., 07-Feb-26)
    function formatDateDDMMMYY(dateStr) {
        if (!dateStr || dateStr === '-') return '-';
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        var day = ('0' + d.getDate()).slice(-2);
        var month = months[d.getMonth()];
        var year = String(d.getFullYear()).slice(-2);
        return day + '-' + month + '-' + year;
    }
    
    // Get column count based on mode
    // Construction has Committed Qty|Rate|Amount (3 cols), non-construction has single Committed col
    function getColCount() {
        if (isTender) {
            return isConstruction ? 10 : 6;  // Construction: +2 for committed qty/rate
        } else {
            return isConstruction ? 14 : 10;  // Construction: +2 for committed qty/rate
        }
    }
    
    // Load contract budget data
    function loadContractBudget(pk) {
        
        var tbody = $('#contractBudgetMainTableBody');
        var tfoot = $('#contractBudgetMainTableFooter');
        var colCount = getColCount();
        
        tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; padding: 20px;">Loading...</td></tr>');
        
        // Determine tender_or_execution value (1=tender, 2=execution)
        var tenderOrExecution = isTender ? 1 : 2;
        
        // Load categories, items, and committed amounts in parallel
        Promise.all([
            $.ajax({ url: '/core/get_project_categories/' + pk + '/', type: 'GET' }),
            $.ajax({ url: '/core/get_project_items/' + pk + '/?tender_or_execution=' + tenderOrExecution, type: 'GET' }),
            $.ajax({ url: '/core/get_project_committed_amounts/' + pk + '/?tender_or_execution=' + tenderOrExecution, type: 'GET' })
        ]).then(function(results) {
            var categories = results[0].categories || [];
            var items = results[1].items || [];
            var committedAmounts = results[2].committed_amounts || {};
            var billedAmounts = results[2].billed_amounts || {};
            
            console.log('Contract Budget - Committed Amounts from backend:', committedAmounts);
            console.log('Contract Budget - Billed Amounts from backend:', billedAmounts);
            
            renderTable(categories, items, committedAmounts, billedAmounts);
        }).catch(function(error) {
            console.error('Error loading contract budget:', error);
            tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; color: #dc3545; padding: 20px;">Error loading data</td></tr>');
        });
    }
    
    // Render the table
    function renderTable(categories, items, committedAmounts, billedAmounts) {
        var tbody = $('#contractBudgetMainTableBody');
        var tfoot = $('#contractBudgetMainTableFooter');
        var colCount = getColCount();
        
        tbody.empty();
        
        if (!categories || categories.length === 0) {
            tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; color: #6c757d; padding: 20px;">No categories yet. Add categories and items in the Items section first.</td></tr>');
            return;
        }
        
        // Sort categories by order_in_list
        categories.sort(function(a, b) { return a.order_in_list - b.order_in_list; });
        
        // Totals tracking
        var totals = {
            contract_budget: 0,
            working_budget: 0,
            uncommitted: 0,
            committed: 0,
            committed_qty: 0,
            committed_rate: 0,
            cost_to_complete: 0,
            billed: 0,
            fixed_on_site: 0
        };
        
        // Render each category and its items
        categories.forEach(function(category) {
            var isInternal = category.category === 'Internal';
            var isLabour = category.category === 'Labour';
            
            // Render category row
            var categoryRow = renderCategoryRow(category, isInternal, isLabour);
            tbody.append(categoryRow);
            
            // Get items for this category
            var categoryItems = items.filter(function(item) {
                return item.category__category === category.category;
            });
            categoryItems.sort(function(a, b) { return a.order_in_list - b.order_in_list; });
            
            // Render item rows
            categoryItems.forEach(function(item) {
                var committedData = committedAmounts[item.costing_pk];
                var billedAmount = billedAmounts[item.costing_pk] || 0;
                // For construction types, committedData is {qty, rate, amount}; for others, it's a number
                var committedAmount = isConstruction ? 
                    (committedData ? committedData.amount : 0) : 
                    (committedData || 0);
                var row = renderItemRow(item, committedData, billedAmount, isInternal, isLabour, category.category);
                tbody.append(row);
                
                // Update totals (include all items including internal category)
                var uncommittedAmount = isConstruction ? 
                    (parseFloat(item.uncommitted_qty) || 0) * (parseFloat(item.uncommitted_rate) || 0) :
                    (parseFloat(item.uncommitted_amount) || 0);
                
                totals.uncommitted += uncommittedAmount;
                totals.committed += committedAmount;
                if (isConstruction && committedData) {
                    totals.committed_qty += committedData.qty || 0;
                }
                totals.working_budget += uncommittedAmount + committedAmount;
                
                if (!isTender) {
                    totals.contract_budget += parseFloat(item.contract_budget) || 0;
                    // C2C = Working Budget - Billed
                    var workingBudgetForItem = uncommittedAmount + committedAmount;
                    totals.cost_to_complete += workingBudgetForItem - billedAmount;
                    totals.billed += billedAmount;
                    totals.fixed_on_site += parseFloat(item.fixed_on_site || 0);
                }
            });
        });
        
        // Render totals footer
        renderTotalsFooter(tfoot, totals);
        
        // Calculate subtotals for all collapsed categories
        $('tr.category-row.collapsed').each(function() {
            var categoryName = $(this).attr('data-category');
            updateCategorySubtotals(categoryName);
        });
    }
    
    // Render a category row with collapsible subtotals
    function renderCategoryRow(category, isInternal, isLabour) {
        var row = $('<tr class="category-row collapsed"></tr>');
        row.attr('data-category', category.category);
        if (isInternal) row.addClass('internal-category');
        if (isLabour) row.addClass('labour-category');
        
        // Category name with collapse icon
        row.append('<td><i class="fas fa-chevron-down collapse-icon"></i><strong>' + Utils.escapeHtml(category.category) + '</strong></td>');
        
        // Unit column (empty)
        row.append('<td class="subtotal-cell"></td>');
        
        if (!isTender) {
            // Contract Budget subtotal
            row.append('<td class="subtotal-cell" data-subtotal="contract_budget"></td>');
        }
        
        // Working Budget subtotal
        row.append('<td class="subtotal-cell" data-subtotal="working_budget"></td>');
        
        if (isConstruction) {
            row.append('<td class="subtotal-cell"></td>');  // Uncommitted Qty (empty)
            row.append('<td class="subtotal-cell"></td>');  // Uncommitted Rate (empty)
            row.append('<td class="subtotal-cell" data-subtotal="uncommitted"></td>');  // Uncommitted Amount
            row.append('<td class="subtotal-cell"></td>');  // Notes (empty)
            // Committed columns for construction
            row.append('<td class="subtotal-cell"></td>');  // Committed Qty (empty)
            row.append('<td class="subtotal-cell"></td>');  // Committed Rate (empty)
            row.append('<td class="subtotal-cell" data-subtotal="committed"></td>');  // Committed Amount
        } else {
            row.append('<td class="subtotal-cell" data-subtotal="uncommitted"></td>');  // Uncommitted
            row.append('<td class="subtotal-cell"></td>');  // Notes (empty)
            // Committed subtotal (non-construction)
            row.append('<td class="subtotal-cell" data-subtotal="committed"></td>');
        }
        
        if (!isTender) {
            row.append('<td class="subtotal-cell" data-subtotal="cost_to_complete"></td>');
            row.append('<td class="subtotal-cell" data-subtotal="billed"></td>');
            row.append('<td class="subtotal-cell" data-subtotal="fixed_on_site"></td>');
        }
        
        // Add click handler for collapse/expand
        row.on('click', function(e) {
            // Don't toggle if clicking on notes icon
            if ($(e.target).hasClass('notes-icon')) return;
            toggleCategory(category.category);
        });
        
        return row;
    }
    
    // Render an item row
    function renderItemRow(item, committedData, billedAmount, isInternal, isLabour, categoryName) {
        // For construction types, committedData is {qty, rate, amount, has_multiple_rates}; for others, it's a number
        var committedAmount = isConstruction ? 
            (committedData ? committedData.amount : 0) : 
            (committedData || 0);
        var committedQty = isConstruction && committedData ? (committedData.qty || 0) : 0;
        var committedRate = isConstruction && committedData ? (committedData.rate || 0) : 0;
        var hasMultipleRates = isConstruction && committedData ? (committedData.has_multiple_rates || false) : false;
        
        var row = $('<tr class="item-row hidden-by-collapse"></tr>');
        if (isInternal) {
            row.addClass('internal-item');
            row.attr('data-is-internal', 'true');
        }
        if (isLabour) {
            row.addClass('labour-item');
        }
        row.attr('data-item-pk', item.costing_pk);
        row.attr('data-category', categoryName);
        
        // Category / Item column with indent
        row.append('<td class="indent">' + Utils.escapeHtml(item.item) + '</td>');
        
        // Unit column
        row.append('<td>' + Utils.escapeHtml(item.unit || '-') + '</td>');
        
        if (!isTender) {
            // Contract Budget column (execution mode only)
            // Make clickable if item has HC variation allocations
            var hasHcVariations = (item.hc_variation_amount || 0) > 0;
            var contractBudgetClickableClass = hasHcVariations ? ' contract-budget-clickable' : '';
            var contractBudgetTd = $('<td class="contract-budget-cell' + contractBudgetClickableClass + '" data-item-pk="' + item.costing_pk + '" data-base-budget="' + (item.base_contract_budget || 0) + '" data-hc-variation="' + (item.hc_variation_amount || 0) + '">' + Utils.formatCurrency(item.contract_budget || 0) + '</td>');
            if (hasHcVariations) {
                contractBudgetTd.on('click', function() { toggleContractBudgetDetailsRow(item.costing_pk); });
            }
            row.append(contractBudgetTd);
        }
        
        // Working Budget column (calculated: Uncommitted + Committed)
        var uncommittedAmount = isConstruction ?
            (parseFloat(item.uncommitted_qty) || 0) * (parseFloat(item.uncommitted_rate) || 0) :
            (parseFloat(item.uncommitted_amount) || 0);
        var workingBudget = uncommittedAmount + committedAmount;
        row.append('<td class="working-budget-cell" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(workingBudget) + '</td>');
        
        // Internal category items in execution mode: show blank/non-editable uncommitted fields
        var internalInExecution = isInternal && !isTender;
        
        if (isConstruction) {
            // Uncommitted: Qty | Rate | Amount | Notes (construction mode)
            if (internalInExecution) {
                // Internal in execution: show blank non-editable cells
                row.append('<td class="qty-cell" data-item-pk="' + item.costing_pk + '"></td>');
                row.append('<td class="rate-cell" data-item-pk="' + item.costing_pk + '"></td>');
                row.append('<td class="uncommitted-amount" data-item-pk="' + item.costing_pk + '"></td>');
                row.append('<td style="text-align: center;"></td>');  // No notes icon
            } else {
                // Qty - clickable text that becomes input
                var qtyVal = parseFloat(item.uncommitted_qty || 0);
                var qtyTd = $('<td class="qty-cell" data-item-pk="' + item.costing_pk + '"></td>');
                var qtyLink = $('<a href="#" class="click-to-edit qty-display" data-item-pk="' + item.costing_pk + '" data-value="' + qtyVal + '">' + Utils.formatNumber(qtyVal, 2) + '</a>');
                qtyLink.on('click', function(e) {
                    e.preventDefault();
                    convertToInput(item.costing_pk, 'qty');
                });
                qtyTd.append(qtyLink);
                row.append(qtyTd);
                
                // Rate - clickable text that becomes input
                var rateVal = parseFloat(item.uncommitted_rate || 0);
                var rateTd = $('<td class="rate-cell" data-item-pk="' + item.costing_pk + '"></td>');
                var rateLink = $('<a href="#" class="click-to-edit rate-display" data-item-pk="' + item.costing_pk + '" data-value="' + rateVal + '">' + Utils.formatNumber(rateVal, 2) + '</a>');
                rateLink.on('click', function(e) {
                    e.preventDefault();
                    convertToInput(item.costing_pk, 'rate');
                });
                rateTd.append(rateLink);
                row.append(rateTd);
                
                // Amount (calculated)
                row.append('<td class="uncommitted-amount" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(uncommittedAmount) + '</td>');
                
                // Notes - notepad icon (store notes on row data attribute for live updates)
                var hasNotes = item.uncommitted_notes && item.uncommitted_notes.trim() !== '';
                row.attr('data-notes', item.uncommitted_notes || '');
                var notesIcon = $('<i class="fas fa-sticky-note notes-icon' + (hasNotes ? ' has-notes' : '') + '" data-item-pk="' + item.costing_pk + '"></i>');
                notesIcon.attr('title', hasNotes ? item.uncommitted_notes : 'Add notes');
                notesIcon.on('click', function() {
                    // Read current notes from row data attribute (updated after save)
                    var currentNotes = $('tr.item-row[data-item-pk="' + item.costing_pk + '"]').attr('data-notes') || '';
                    toggleNotesRow(item.costing_pk, currentNotes);
                });
                row.append($('<td style="text-align: center;"></td>').append(notesIcon));
            }
        } else {
            // Uncommitted: single Amount field with click-to-edit (non-construction mode)
            if (internalInExecution) {
                // Internal in execution: show blank non-editable cell
                row.append('<td class="amount-cell" data-item-pk="' + item.costing_pk + '"></td>');
                row.append('<td style="text-align: center;"></td>');  // No notes icon
            } else {
                // Amount - clickable text that becomes input (same UX as construction)
                var amountVal = parseFloat(item.uncommitted_amount || 0);
                var amountTd = $('<td class="amount-cell" data-item-pk="' + item.costing_pk + '"></td>');
                var amountLink = $('<a href="#" class="click-to-edit amount-display" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(amountVal) + '</a>');
                amountLink.on('click', function(e) {
                    e.preventDefault();
                    convertToInputNonConstruction(item.costing_pk);
                });
                amountTd.append(amountLink);
                row.append(amountTd);
                
                // Notes - notepad icon (same as construction)
                var hasNotes = item.uncommitted_notes && item.uncommitted_notes.trim() !== '';
                row.attr('data-notes', item.uncommitted_notes || '');
                var notesIcon = $('<i class="fas fa-sticky-note notes-icon' + (hasNotes ? ' has-notes' : '') + '" data-item-pk="' + item.costing_pk + '"></i>');
                notesIcon.attr('title', hasNotes ? item.uncommitted_notes : 'Add notes');
                notesIcon.on('click', function() {
                    var currentNotes = $('tr.item-row[data-item-pk="' + item.costing_pk + '"]').attr('data-notes') || '';
                    toggleNotesRow(item.costing_pk, currentNotes);
                });
                row.append($('<td style="text-align: center;"></td>').append(notesIcon));
            }
        }
        
        // Committed column(s) (display only - calculated from quote allocations)
        // Make cells green and clickable if they have values
        var hasCommittedValue = committedAmount > 0;
        var clickableClass = hasCommittedValue ? ' committed-clickable' : '';
        
        if (isConstruction) {
            // Construction: Committed Qty | Rate | Amount
            if (isInternal) {
                // Internal items: blank committed cells (no allocations allowed)
                row.append('<td></td>');  // Qty - blank
                row.append('<td></td>');  // Rate - blank
                row.append('<td></td>');  // Amount - blank
            } else if (isLabour) {
                // Labour items: blank Qty/Rate, show Amount from staff hours allocations
                row.append('<td></td>');  // Qty - blank
                row.append('<td></td>');  // Rate - blank
                var amountTd = $('<td class="committed-cell" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(committedAmount) + '</td>');
                row.append(amountTd);
            } else {
                // If multiple rates exist, show "multiple" for qty and rate
                var qtyDisplay = hasMultipleRates ? 'multiple' : Utils.formatNumber(committedQty, 2);
                var rateDisplay = hasMultipleRates ? 'multiple' : Utils.formatNumber(committedRate, 2);
                
                var qtyTd = $('<td class="committed-qty-cell' + clickableClass + '" data-item-pk="' + item.costing_pk + '">' + qtyDisplay + '</td>');
                var rateTd = $('<td class="committed-rate-cell' + clickableClass + '" data-item-pk="' + item.costing_pk + '">' + rateDisplay + '</td>');
                var amountTd = $('<td class="committed-cell' + clickableClass + '" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(committedAmount) + '</td>');
                
                if (hasCommittedValue) {
                    qtyTd.on('click', function() { toggleCommittedDetailsRow(item.costing_pk); });
                    rateTd.on('click', function() { toggleCommittedDetailsRow(item.costing_pk); });
                    amountTd.on('click', function() { toggleCommittedDetailsRow(item.costing_pk); });
                }
                
                row.append(qtyTd);
                row.append(rateTd);
                row.append(amountTd);
            }
        } else {
            // Non-construction: single Committed amount column
            var amountTd = $('<td class="committed-cell' + clickableClass + '" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(committedAmount) + '</td>');
            if (hasCommittedValue) {
                amountTd.on('click', function() { toggleCommittedDetailsRow(item.costing_pk); });
            }
            row.append(amountTd);
        }
        
        if (!isTender) {
            // Execution mode extra columns
            // C2C = Working Budget - Billed
            var c2cValue = workingBudget - billedAmount;
            row.append('<td class="c2c-cell" data-item-pk="' + item.costing_pk + '" data-billed="' + billedAmount + '">' + Utils.formatCurrency(c2cValue) + '</td>');
            // Billed - clickable if has value (green like committed)
            var hasBilledValue = billedAmount > 0;
            var billedClickableClass = hasBilledValue ? ' billed-clickable' : '';
            var billedTd = $('<td class="billed-cell' + billedClickableClass + '" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(billedAmount) + '</td>');
            if (hasBilledValue) {
                billedTd.on('click', function() { toggleBilledDetailsRow(item.costing_pk); });
            }
            row.append(billedTd);
            
            // Fixed on Site - clickable/editable like Uncommitted
            var fixedOnSiteVal = parseFloat(item.fixed_on_site || 0);
            var fixedOnSiteTd = $('<td class="fixed-on-site-cell" data-item-pk="' + item.costing_pk + '"></td>');
            var fixedOnSiteLink = $('<a href="#" class="click-to-edit fixed-on-site-display" data-item-pk="' + item.costing_pk + '" data-value="' + fixedOnSiteVal + '">' + Utils.formatCurrency(fixedOnSiteVal) + '</a>');
            fixedOnSiteLink.on('click', function(e) {
                e.preventDefault();
                convertFixedOnSiteToInput(item.costing_pk);
            });
            fixedOnSiteTd.append(fixedOnSiteLink);
            row.append(fixedOnSiteTd);
        }
        
        return row;
    }
    
    // Convert click-to-edit link to input field
    function convertToInput(itemPk, field) {
        var displaySelector = '.' + field + '-display[data-item-pk="' + itemPk + '"]';
        var display = $(displaySelector);
        if (!display.length) return;
        
        // Use data-value attribute for accurate value (avoids formatting issues)
        var currentVal = parseFloat(display.attr('data-value')) || 0;
        var td = display.parent();
        
        // Create input
        var input = $('<input type="number" step="0.01" min="0">')
            .addClass('uncommitted-' + field)
            .attr('data-item-pk', itemPk)
            .val(currentVal.toFixed(2))
            .css('width', '100%');
        
        // Replace link with input
        td.empty().append(input);
        input.focus().select();
        
        // Handle input changes
        input.on('input', function() {
            updateUncommittedAmount(itemPk);
        });
        
        // Handle Enter key - submit and blur
        input.on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $(this).blur();
            }
        });
        
        // Handle blur - convert back to link and save
        input.on('blur', function() {
            var newVal = parseFloat($(this).val()) || 0;
            var newLink = $('<a href="#" class="click-to-edit ' + field + '-display" data-item-pk="' + itemPk + '" data-value="' + newVal + '">' + Utils.formatNumber(newVal, 2) + '</a>');
            newLink.on('click', function(e) {
                e.preventDefault();
                convertToInput(itemPk, field);
            });
            td.empty().append(newLink);
        });
    }
    
    // Convert click-to-edit link to input field (non-construction mode)
    function convertToInputNonConstruction(itemPk) {
        var displaySelector = '.amount-display[data-item-pk="' + itemPk + '"]';
        var display = $(displaySelector);
        if (!display.length) return;
        
        var currentVal = parseFloat(display.text().replace(/[^0-9.-]/g, '')) || 0;
        var td = display.parent();
        
        // Create input
        var input = $('<input type="number" step="0.01" min="0">')
            .addClass('uncommitted-amount-input')
            .attr('data-item-pk', itemPk)
            .val(currentVal.toFixed(2))
            .css('width', '100%');
        
        // Replace link with input
        td.empty().append(input);
        input.focus().select();
        
        // Handle input changes - update working budget live
        input.on('input', function() {
            updateWorkingBudget(itemPk);
        });
        
        // Handle Enter key - submit and blur
        input.on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $(this).blur();
            }
        });
        
        // Handle blur - convert back to link and save
        input.on('blur', function() {
            var newVal = parseFloat($(this).val()) || 0;
            var newLink = $('<a href="#" class="click-to-edit amount-display" data-item-pk="' + itemPk + '">' + Utils.formatCurrency(newVal) + '</a>');
            newLink.on('click', function(e) {
                e.preventDefault();
                convertToInputNonConstruction(itemPk);
            });
            td.empty().append(newLink);
            
            // Save to database
            saveUncommittedNonConstruction(itemPk, newVal);
        });
    }
    
    // Save uncommitted amount for non-construction mode
    function saveUncommittedNonConstruction(itemPk, amount) {
        var data = {
            costing_pk: itemPk,
            uncommitted: amount
        };
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
            },
            error: function(error) {
                console.error('Error saving uncommitted:', error);
            }
        });
    }
    
    // Convert Fixed on Site cell to input field
    function convertFixedOnSiteToInput(itemPk) {
        var displaySelector = '.fixed-on-site-display[data-item-pk="' + itemPk + '"]';
        var display = $(displaySelector);
        if (!display.length) return;
        
        var currentVal = parseFloat(display.attr('data-value')) || 0;
        var td = display.parent();
        
        // Create input
        var input = $('<input type="number" step="0.01" min="0">')
            .addClass('fixed-on-site-input')
            .attr('data-item-pk', itemPk)
            .val(currentVal.toFixed(2))
            .css('width', '100%');
        
        // Replace link with input
        td.empty().append(input);
        input.focus().select();
        
        // Handle Enter key - submit and blur
        input.on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $(this).blur();
            }
        });
        
        // Handle blur - convert back to link and save
        input.on('blur', function() {
            var newVal = parseFloat($(this).val()) || 0;
            var newLink = $('<a href="#" class="click-to-edit fixed-on-site-display" data-item-pk="' + itemPk + '" data-value="' + newVal + '">' + Utils.formatCurrency(newVal) + '</a>');
            newLink.on('click', function(e) {
                e.preventDefault();
                convertFixedOnSiteToInput(itemPk);
            });
            td.empty().append(newLink);
            
            // Save to database
            saveFixedOnSite(itemPk, newVal);
        });
    }
    
    // Save Fixed on Site amount
    function saveFixedOnSite(itemPk, amount) {
        var data = {
            costing_pk: itemPk,
            fixed_on_site: amount
        };
        
        $.ajax({
            url: '/core/update_fixedonsite/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Fixed on Site saved:', response.fixed_on_site);
                }
            },
            error: function(error) {
                console.error('Error saving Fixed on Site:', error);
            }
        });
    }
    
    // Get amount value for non-construction (from input or display link)
    function getAmountValue(itemPk) {
        var input = $('.uncommitted-amount-input[data-item-pk="' + itemPk + '"]');
        if (input.length) return parseFloat(input.val()) || 0;
        var display = $('.amount-display[data-item-pk="' + itemPk + '"]');
        if (display.length) return parseFloat(display.text().replace(/[^0-9.-]/g, '')) || 0;
        return 0;
    }
    
    // Get qty value (from input or display link)
    function getQtyValue(itemPk) {
        var input = $('.uncommitted-qty[data-item-pk="' + itemPk + '"]');
        if (input.length) return parseFloat(input.val()) || 0;
        var display = $('.qty-display[data-item-pk="' + itemPk + '"]');
        if (display.length) return parseFloat(display.text().replace(/,/g, '')) || 0;
        return 0;
    }
    
    // Get rate value (from input or display link)
    function getRateValue(itemPk) {
        var input = $('.uncommitted-rate[data-item-pk="' + itemPk + '"]');
        if (input.length) return parseFloat(input.val()) || 0;
        var display = $('.rate-display[data-item-pk="' + itemPk + '"]');
        if (display.length) return parseFloat(display.text().replace(/,/g, '')) || 0;
        return 0;
    }
    
    // Close any open notes row (save first if has content)
    function closeOpenNotesRow() {
        var openRow = $('.notes-row');
        if (openRow.length) {
            var textarea = openRow.find('textarea');
            var itemPk = textarea.attr('data-item-pk');
            var notes = textarea.val();
            
            // Save before closing
            if (itemPk) {
                saveNotes(itemPk, notes);
            }
            
            // Remove row and reset icon
            $('.notes-icon[data-item-pk="' + itemPk + '"]').removeClass('active');
            openRow.remove();
        }
    }
    
    // Toggle category collapse/expand
    function toggleCategory(categoryName) {
        var categoryRow = $('tr.category-row[data-category="' + categoryName + '"]');
        var isCollapsed = categoryRow.hasClass('collapsed');
        
        if (isCollapsed) {
            // Expand: show item rows
            categoryRow.removeClass('collapsed');
            $('tr.item-row[data-category="' + categoryName + '"]').removeClass('hidden-by-collapse');
            // Also show any notes rows for this category
            $('tr.item-row[data-category="' + categoryName + '"]').each(function() {
                var itemPk = $(this).attr('data-item-pk');
                $('#notes-row-' + itemPk).removeClass('hidden-by-collapse');
            });
        } else {
            // Collapse: hide item rows and calculate subtotals
            categoryRow.addClass('collapsed');
            $('tr.item-row[data-category="' + categoryName + '"]').addClass('hidden-by-collapse');
            // Also hide any notes rows for this category
            $('tr.item-row[data-category="' + categoryName + '"]').each(function() {
                var itemPk = $(this).attr('data-item-pk');
                $('#notes-row-' + itemPk).addClass('hidden-by-collapse');
            });
            
            // Calculate and display subtotals
            updateCategorySubtotals(categoryName);
        }
    }
    
    // Calculate and update subtotals for a collapsed category
    function updateCategorySubtotals(categoryName) {
        var categoryRow = $('tr.category-row[data-category="' + categoryName + '"]');
        var subtotals = {
            contract_budget: 0,
            working_budget: 0,
            uncommitted: 0,
            committed: 0,
            cost_to_complete: 0,
            billed: 0,
            fixed_on_site: 0
        };
        
        // Sum up values from item rows in this category
        $('tr.item-row[data-category="' + categoryName + '"]').each(function() {
            var itemPk = $(this).attr('data-item-pk');
            
            // Uncommitted
            var uncommitted = 0;
            if (isConstruction) {
                uncommitted = getQtyValue(itemPk) * getRateValue(itemPk);
            } else {
                uncommitted = getAmountValue(itemPk);
            }
            
            // Committed (from display cell)
            var committedText = $('.committed-cell[data-item-pk="' + itemPk + '"]').text();
            var committed = parseFloat(committedText.replace(/[^0-9.-]/g, '')) || 0;
            
            // Working budget
            var workingBudgetText = $('.working-budget-cell[data-item-pk="' + itemPk + '"]').text();
            var workingBudget = parseFloat(workingBudgetText.replace(/[^0-9.-]/g, '')) || 0;
            
            subtotals.uncommitted += uncommitted;
            subtotals.committed += committed;
            subtotals.working_budget += workingBudget;
        });
        
        // For non-tender mode, also get contract_budget, cost_to_complete, billed, fixed_on_site from the row text
        if (!isTender) {
            $('tr.item-row[data-category="' + categoryName + '"]').each(function() {
                var cells = $(this).find('td');
                // Contract budget is the 3rd cell (index 2) in execution mode
                var contractBudgetText = cells.eq(2).text();
                subtotals.contract_budget += parseFloat(contractBudgetText.replace(/[^0-9.-]/g, '')) || 0;
                
                // Cost to complete, billed, fixed on site are the last 3 cells
                var cellCount = cells.length;
                var costToCompleteText = cells.eq(cellCount - 3).text();
                var billedText = cells.eq(cellCount - 2).text();
                var fixedOnSiteText = cells.eq(cellCount - 1).text();
                
                subtotals.cost_to_complete += parseFloat(costToCompleteText.replace(/[^0-9.-]/g, '')) || 0;
                subtotals.billed += parseFloat(billedText.replace(/[^0-9.-]/g, '')) || 0;
                subtotals.fixed_on_site += parseFloat(fixedOnSiteText.replace(/[^0-9.-]/g, '')) || 0;
            });
        }
        
        // Update subtotal cells in the category row
        categoryRow.find('[data-subtotal="contract_budget"]').text(Utils.formatCurrency(subtotals.contract_budget));
        categoryRow.find('[data-subtotal="working_budget"]').text(Utils.formatCurrency(subtotals.working_budget));
        categoryRow.find('[data-subtotal="uncommitted"]').text(Utils.formatCurrency(subtotals.uncommitted));
        categoryRow.find('[data-subtotal="committed"]').text(Utils.formatCurrency(subtotals.committed));
        categoryRow.find('[data-subtotal="cost_to_complete"]').text(Utils.formatCurrency(subtotals.cost_to_complete));
        categoryRow.find('[data-subtotal="billed"]').text(Utils.formatCurrency(subtotals.billed));
        categoryRow.find('[data-subtotal="fixed_on_site"]').text(Utils.formatCurrency(subtotals.fixed_on_site));
    }
    
    // Toggle notes row - inline expansion (only one at a time)
    function toggleNotesRow(itemPk, currentNotes) {
        var existingRow = $('#notes-row-' + itemPk);
        var icon = $('.notes-icon[data-item-pk="' + itemPk + '"]');
        
        // If clicking the same row's icon, just close it
        if (existingRow.length) {
            closeOpenNotesRow();
            return;
        }
        
        // Close any other open notes row first
        closeOpenNotesRow();
        
        // Create notes row - position textarea under Uncommitted columns only
        var itemRow = $('tr.item-row[data-item-pk="' + itemPk + '"]');
        
        // Calculate column spans based on mode
        // Columns before Uncommitted: Category/Item, Unit, [Contract Budget if execution], Working Budget
        var colsBeforeUncommitted = isTender ? 3 : 4;
        // Uncommitted columns: (Qty, Rate, Amount, Notes) for construction, (Amount, Notes) for non-construction
        var uncommittedCols = isConstruction ? 4 : 2;
        // Remaining columns after Uncommitted
        var colsAfterUncommitted = getColCount() - colsBeforeUncommitted - uncommittedCols;
        
        var notesRow = $('<tr id="notes-row-' + itemPk + '" class="notes-row" data-item-pk="' + itemPk + '"></tr>');
        
        // Empty cells before Uncommitted
        notesRow.append('<td colspan="' + colsBeforeUncommitted + '"></td>');
        
        // Textarea cell spanning Uncommitted columns
        var td = $('<td colspan="' + uncommittedCols + '"></td>');
        var textarea = $('<textarea class="notes-textarea" data-item-pk="' + itemPk + '" placeholder="Enter notes..." maxlength="1000"></textarea>');
        textarea.val(currentNotes);
        td.append(textarea);
        notesRow.append(td);
        
        // Empty cells after Uncommitted (Committed columns)
        if (colsAfterUncommitted > 0) {
            notesRow.append('<td colspan="' + colsAfterUncommitted + '"></td>');
        }
        
        itemRow.after(notesRow);
        textarea.focus();
        
        icon.addClass('active');
    }
    
    // Toggle committed details row - shows quote allocations for this item
    function toggleCommittedDetailsRow(itemPk) {
        var existingRow = $('#committed-details-row-' + itemPk);
        
        // If clicking the same row, just close it
        if (existingRow.length) {
            existingRow.remove();
            $('.committed-clickable[data-item-pk="' + itemPk + '"]').removeClass('active');
            return;
        }
        
        // Close any other open committed details row
        $('.committed-details-row').remove();
        $('.committed-clickable').removeClass('active');
        
        // Also close any open notes row
        closeOpenNotesRow();
        
        // Fetch quote allocations for this item
        $.ajax({
            url: '/core/get_item_quote_allocations/' + itemPk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success' && response.allocations.length > 0) {
                    renderCommittedDetailsRow(itemPk, response.allocations);
                }
            },
            error: function(xhr) {
                console.error('Failed to fetch quote allocations:', xhr);
            }
        });
        
        // Mark cells as active
        $('.committed-clickable[data-item-pk="' + itemPk + '"]').addClass('active');
    }
    
    // Render the committed details row with quote allocations
    // Columns: Supplier (under Rate+Amount), Quote # (under Notes), then Qty, Rate, Amount align with Committed cols
    function renderCommittedDetailsRow(itemPk, allocations) {
        var itemRow = $('tr.item-row[data-item-pk="' + itemPk + '"]');
        
        // For construction tender mode columns are:
        // Cat/Item, Unit, Working, UncommQty, UncommRate, UncommAmt, UncommNotes, CommQty, CommRate, CommAmt
        // Green box starts at UncommRate, spans: Rate+Amt+Notes+CommQty+CommRate+CommAmt = 6 cols
        
        // Columns before Uncommitted Rate: Cat/Item, Unit, Working, UncommQty = 4 cols in tender
        var colsBeforeBox = isTender ? 4 : 5;
        // Box spans from UncommRate to end of Committed section
        // Execution + Construction: extend to include C2C (7 cols)
        // Tender + Construction: 6 cols
        // Non-construction: 4 cols
        var boxCols = isConstruction ? (isTender ? 6 : 7) : 4;
        
        var detailsRow = $('<tr id="committed-details-row-' + itemPk + '" class="committed-details-row" data-item-pk="' + itemPk + '"></tr>');
        
        // Empty cells before the box
        detailsRow.append('<td colspan="' + colsBeforeBox + '"></td>');
        
        // Green box cell spanning the right columns
        var boxTd = $('<td colspan="' + boxCols + '"></td>');
        var box = $('<div class="committed-details-box"></div>');
        
        // Build internal table with column widths matching parent alignment
        // Supplier (Rate+Amount = 2 cols), Quote # (Notes = 1 col), Qty, Rate, Amount (1 col each)
        var table = $('<table class="committed-details-table"></table>');
        
        if (isConstruction) {
            // 6 columns total: Supplier spans 2, Quote# 1, Qty 1, Rate 1, Amount 1
            var colgroup = $('<colgroup><col style="width:33.3%"><col style="width:16.7%"><col style="width:16.7%"><col style="width:16.7%"><col style="width:16.6%"></colgroup>');
            table.append(colgroup);
            var thead = $('<thead><tr><th>Supplier</th><th>Quote #</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead>');
            table.append(thead);
        } else {
            var colgroup = $('<colgroup><col style="width:50%"><col style="width:25%"><col style="width:25%"></colgroup>');
            table.append(colgroup);
            var thead = $('<thead><tr><th>Supplier</th><th>Quote #</th><th>Amount</th></tr></thead>');
            table.append(thead);
        }
        
        var tbody = $('<tbody></tbody>');
        allocations.forEach(function(alloc) {
            var tr = $('<tr></tr>');
            tr.append('<td>' + Utils.escapeHtml(alloc.contact_name) + '</td>');
            tr.append('<td>#' + Utils.escapeHtml(alloc.supplier_quote_number) + '</td>');
            if (isConstruction) {
                tr.append('<td>' + Utils.formatNumber(alloc.qty, 2) + '</td>');
                tr.append('<td>' + Utils.formatNumber(alloc.rate, 2) + '</td>');
            }
            tr.append('<td>' + Utils.formatCurrency(alloc.amount) + '</td>');
            tbody.append(tr);
        });
        table.append(tbody);
        
        box.append(table);
        boxTd.append(box);
        detailsRow.append(boxTd);
        
        itemRow.after(detailsRow);
    }
    
    // Toggle billed details row - shows bill allocations for this item
    function toggleBilledDetailsRow(itemPk) {
        var existingRow = $('#billed-details-row-' + itemPk);
        
        // If clicking the same row, just close it
        if (existingRow.length) {
            existingRow.remove();
            $('.billed-clickable[data-item-pk="' + itemPk + '"]').removeClass('active');
            return;
        }
        
        // Close any other open billed/committed details row
        $('.billed-details-row').remove();
        $('.committed-details-row').remove();
        $('.billed-clickable').removeClass('active');
        $('.committed-clickable').removeClass('active');
        
        // Also close any open notes row
        closeOpenNotesRow();
        
        // Fetch bill allocations for this item
        $.ajax({
            url: '/core/get_item_bill_allocations/' + itemPk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success' && response.allocations.length > 0) {
                    renderBilledDetailsRow(itemPk, response.allocations);
                }
            },
            error: function(xhr) {
                console.error('Failed to fetch bill allocations:', xhr);
            }
        });
        
        // Mark cell as active
        $('.billed-clickable[data-item-pk="' + itemPk + '"]').addClass('active');
    }
    
    // Render the billed details row with bill allocations
    function renderBilledDetailsRow(itemPk, allocations) {
        var itemRow = $('tr.item-row[data-item-pk="' + itemPk + '"]');
        
        // Count total columns in item row to calculate positions
        var totalCols = itemRow.find('td').length;
        // Extend box 4 columns to the left (8 cols total)
        var colsBeforeBox = totalCols - 8;
        var boxCols = 8;
        
        var detailsRow = $('<tr id="billed-details-row-' + itemPk + '" class="billed-details-row committed-details-row" data-item-pk="' + itemPk + '"></tr>');
        
        // Empty cells before the box
        detailsRow.append('<td colspan="' + colsBeforeBox + '"></td>');
        
        // Green box cell
        var boxTd = $('<td colspan="' + boxCols + '"></td>');
        var box = $('<div class="committed-details-box"></div>');
        
        // Build internal table
        var table = $('<table class="committed-details-table"></table>');
        
        var colgroup = $('<colgroup><col style="width:25%"><col style="width:18%"><col style="width:12%"><col style="width:12%"><col style="width:33%"></colgroup>');
        table.append(colgroup);
        var thead = $('<thead><tr><th>Supplier</th><th>Bill #</th><th>Type</th><th>Amount</th><th>Notes</th></tr></thead>');
        table.append(thead);
        
        var tbody = $('<tbody></tbody>');
        allocations.forEach(function(alloc) {
            var tr = $('<tr></tr>');
            tr.append('<td>' + Utils.escapeHtml(alloc.contact_name) + '</td>');
            tr.append('<td>' + Utils.escapeHtml(alloc.bill_number) + '</td>');
            tr.append('<td>' + Utils.escapeHtml(alloc.bill_type_display) + '</td>');
            tr.append('<td>' + Utils.formatCurrency(alloc.amount) + '</td>');
            tr.append('<td>' + Utils.escapeHtml(alloc.notes || '-') + '</td>');
            tbody.append(tr);
        });
        table.append(tbody);
        
        box.append(table);
        boxTd.append(box);
        detailsRow.append(boxTd);
        
        itemRow.after(detailsRow);
    }
    
    // Toggle contract budget details row - shows base budget and HC variation allocations
    function toggleContractBudgetDetailsRow(itemPk) {
        var existingRow = $('#contract-budget-details-row-' + itemPk);
        
        // If clicking the same row, just close it
        if (existingRow.length) {
            existingRow.remove();
            $('.contract-budget-clickable[data-item-pk="' + itemPk + '"]').removeClass('active');
            return;
        }
        
        // Close any other open details rows
        $('.contract-budget-details-row').remove();
        $('.billed-details-row').remove();
        $('.committed-details-row').remove();
        $('.contract-budget-clickable').removeClass('active');
        $('.billed-clickable').removeClass('active');
        $('.committed-clickable').removeClass('active');
        
        // Also close any open notes row
        closeOpenNotesRow();
        
        // Fetch HC variation allocations for this item
        $.ajax({
            url: '/core/get_item_hc_variation_allocations/' + itemPk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    renderContractBudgetDetailsRow(itemPk, response.base_contract_budget, response.allocations);
                }
            },
            error: function(xhr) {
                console.error('Failed to fetch HC variation allocations:', xhr);
            }
        });
        
        // Mark cell as active
        $('.contract-budget-clickable[data-item-pk="' + itemPk + '"]').addClass('active');
    }
    
    // Render the contract budget details row with base budget and HC variations
    function renderContractBudgetDetailsRow(itemPk, baseBudget, allocations) {
        var itemRow = $('tr.item-row[data-item-pk="' + itemPk + '"]');
        
        // Count total columns in item row to calculate positions
        var totalCols = itemRow.find('td').length;
        // Box spans from Contract Budget column (3rd column, index 2) for 3 cols
        var colsBeforeBox = 2;  // Category/Item + Unit
        var boxCols = 3;  // Contract Budget + Working Budget + Committed Amount
        var colsAfterBox = totalCols - colsBeforeBox - boxCols;
        
        var detailsRow = $('<tr id="contract-budget-details-row-' + itemPk + '" class="contract-budget-details-row committed-details-row" data-item-pk="' + itemPk + '"></tr>');
        
        // Empty cells before the box
        detailsRow.append('<td colspan="' + colsBeforeBox + '"></td>');
        
        // Blue box cell
        var boxTd = $('<td colspan="' + boxCols + '"></td>');
        var box = $('<div class="committed-details-box"></div>');
        
        // Build internal table
        var table = $('<table class="committed-details-table"></table>');
        
        var colgroup = $('<colgroup><col style="width:50%"><col style="width:25%"><col style="width:25%"></colgroup>');
        table.append(colgroup);
        var thead = $('<thead><tr><th>Source</th><th>Date</th><th>Amount</th></tr></thead>');
        table.append(thead);
        
        var tbody = $('<tbody></tbody>');
        
        // Add base contract budget row
        var baseTr = $('<tr></tr>');
        baseTr.append('<td>Contract Budget</td>');
        baseTr.append('<td>-</td>');
        baseTr.append('<td>' + Utils.formatCurrency(baseBudget) + '</td>');
        tbody.append(baseTr);
        
        // Add HC variation allocation rows
        allocations.forEach(function(alloc) {
            var tr = $('<tr></tr>');
            tr.append('<td>HC Variation</td>');
            tr.append('<td>' + formatDateDDMMMYY(alloc.variation_date) + '</td>');
            tr.append('<td>' + Utils.formatCurrency(alloc.amount) + '</td>');
            tbody.append(tr);
        });
        
        table.append(tbody);
        
        box.append(table);
        boxTd.append(box);
        detailsRow.append(boxTd);
        
        // Empty cells after the box
        if (colsAfterBox > 0) {
            detailsRow.append('<td colspan="' + colsAfterBox + '"></td>');
        }
        
        itemRow.after(detailsRow);
    }
    
    // Close notes/committed/billed details rows when clicking outside
    $(document).on('click', function(e) {
        var target = $(e.target);
        
        // Don't close if clicking on notes row, textarea, or notes icon
        if (target.closest('.notes-row').length || 
            target.hasClass('notes-icon') || 
            target.closest('.notes-icon').length) {
            return;
        }
        
        // Don't close if clicking on committed/billed/contract-budget details row or clickable cells
        if (target.closest('.committed-details-row').length || 
            target.closest('.billed-details-row').length ||
            target.closest('.contract-budget-details-row').length ||
            target.closest('.committed-clickable').length ||
            target.closest('.billed-clickable').length ||
            target.closest('.contract-budget-clickable').length) {
            return;
        }
        
        // Close any open notes row
        closeOpenNotesRow();
        
        // Close any open committed/billed/contract-budget details row
        $('.committed-details-row').remove();
        $('.billed-details-row').remove();
        $('.contract-budget-details-row').remove();
        $('.committed-clickable').removeClass('active');
        $('.contract-budget-clickable').removeClass('active');
        $('.billed-clickable').removeClass('active');
    });
    
    // Save notes to server
    function saveNotes(itemPk, notes) {
        var data = {
            costing_pk: itemPk,
            notes: notes
        };
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                
                // Update local data on the row so re-clicking shows current value
                $('tr.item-row[data-item-pk="' + itemPk + '"]').attr('data-notes', notes);
                
                // Update icon state
                var icon = $('.notes-icon[data-item-pk="' + itemPk + '"]');
                if (notes && notes.trim() !== '') {
                    icon.addClass('has-notes');
                    icon.attr('title', notes);
                } else {
                    icon.removeClass('has-notes');
                    icon.attr('title', 'Add notes');
                }
            },
            error: function(error) {
                console.error('Error saving notes:', error);
            }
        });
    }
    
    // Update uncommitted amount (Qty Ã— Rate) for construction mode
    function updateUncommittedAmount(itemPk) {
        var qty = getQtyValue(itemPk);
        var rate = getRateValue(itemPk);
        var amount = qty * rate;
        
        $('.uncommitted-amount[data-item-pk="' + itemPk + '"]').text(Utils.formatCurrency(amount));
        updateWorkingBudget(itemPk);
        
        // Auto-save after a delay
        clearTimeout(window.contractBudgetSaveTimeout);
        window.contractBudgetSaveTimeout = setTimeout(function() {
            saveUncommitted(itemPk);
        }, 1000);
    }
    
    // Update working budget (Uncommitted + Committed) and C2C (Working Budget - Billed)
    function updateWorkingBudget(itemPk) {
        var uncommitted = 0;
        if (isConstruction) {
            uncommitted = getQtyValue(itemPk) * getRateValue(itemPk);
        } else {
            uncommitted = getAmountValue(itemPk);
        }
        
        // Committed is display-only - parse from cell text
        var committedText = $('.committed-cell[data-item-pk="' + itemPk + '"]').text();
        var committed = parseFloat(committedText.replace(/[^0-9.-]/g, '')) || 0;
        var workingBudget = uncommitted + committed;
        
        $('.working-budget-cell[data-item-pk="' + itemPk + '"]').text(Utils.formatCurrency(workingBudget));
        
        // Update C2C = Working Budget - Billed (execution mode only)
        if (!isTender) {
            var $c2cCell = $('.c2c-cell[data-item-pk="' + itemPk + '"]');
            var billed = parseFloat($c2cCell.attr('data-billed')) || 0;
            var c2c = workingBudget - billed;
            $c2cCell.text(Utils.formatCurrency(c2c));
        }
        
        // Update totals
        updateTotals();
    }
    
    // Update totals footer
    function updateTotals() {
        var totals = { uncommitted: 0, committed: 0, working_budget: 0, cost_to_complete: 0, billed: 0 };
        
        $('#contractBudgetMainTableBody tr.item-row').each(function() {
            var itemPk = $(this).attr('data-item-pk');
            var uncommitted = 0;
            
            if (isConstruction) {
                uncommitted = getQtyValue(itemPk) * getRateValue(itemPk);
            } else {
                uncommitted = getAmountValue(itemPk);
            }
            
            // Committed is display-only - parse from cell text
            var committedText = $('.committed-cell[data-item-pk="' + itemPk + '"]').text();
            var committed = parseFloat(committedText.replace(/[^0-9.-]/g, '')) || 0;
            
            var workingBudget = uncommitted + committed;
            
            totals.uncommitted += uncommitted;
            totals.committed += committed;
            totals.working_budget += workingBudget;
            
            // C2C and Billed (execution mode only)
            if (!isTender) {
                var $c2cCell = $('.c2c-cell[data-item-pk="' + itemPk + '"]');
                var billed = parseFloat($c2cCell.attr('data-billed')) || 0;
                var c2c = workingBudget - billed;
                totals.billed += billed;
                totals.cost_to_complete += c2c;
            }
        });
        
        $('#totalUncommitted').text(Utils.formatCurrency(totals.uncommitted));
        $('#totalCommitted').text(Utils.formatCurrency(totals.committed));
        $('#totalWorkingBudget').text(Utils.formatCurrency(totals.working_budget));
        
        if (!isTender) {
            $('#totalCostToComplete').text(Utils.formatCurrency(totals.cost_to_complete));
            $('#totalBilled').text(Utils.formatCurrency(totals.billed));
        }
    }
    
    // Render totals footer (now targets fixed footer)
    function renderTotalsFooter(tfoot, totals) {
        // Use fixed footer instead of original tfoot
        var fixedFooterBody = $('#contractBudgetFixedFooterBody');
        if (fixedFooterBody.length) {
            fixedFooterBody.empty();
        } else {
            // Fallback to original if fixed footer not ready
            tfoot.empty().show();
        }
        
        var row = $('<tr style="background: var(--color-bg-muted); font-weight: 600;"></tr>');
        
        row.append('<td><strong>TOTALS</strong></td>');
        row.append('<td></td>');  // Unit
        
        if (!isTender) {
            row.append('<td id="totalContractBudget">' + Utils.formatCurrency(totals.contract_budget) + '</td>');
        }
        
        row.append('<td id="totalWorkingBudget">' + Utils.formatCurrency(totals.working_budget) + '</td>');
        
        if (isConstruction) {
            row.append('<td></td>');  // Uncommitted Qty
            row.append('<td></td>');  // Uncommitted Rate
            row.append('<td id="totalUncommitted">' + Utils.formatCurrency(totals.uncommitted) + '</td>');
            row.append('<td></td>');  // Notes
            // Committed columns for construction
            row.append('<td></td>');  // Committed Qty
            row.append('<td></td>');  // Committed Rate
            row.append('<td id="totalCommitted">' + Utils.formatCurrency(totals.committed) + '</td>');
        } else {
            row.append('<td id="totalUncommitted">' + Utils.formatCurrency(totals.uncommitted) + '</td>');
            row.append('<td></td>');  // Notes
            row.append('<td id="totalCommitted">' + Utils.formatCurrency(totals.committed) + '</td>');
        }
        
        if (!isTender) {
            row.append('<td id="totalCostToComplete">' + Utils.formatCurrency(totals.cost_to_complete) + '</td>');
            row.append('<td id="totalBilled">' + Utils.formatCurrency(totals.billed) + '</td>');
            row.append('<td id="totalFixedOnSite">' + Utils.formatCurrency(totals.fixed_on_site) + '</td>');
        }
        
        // Append to fixed footer if available, otherwise original tfoot
        var fixedFooterBody = $('#contractBudgetFixedFooterBody');
        if (fixedFooterBody.length) {
            fixedFooterBody.append(row);
        } else {
            tfoot.append(row);
        }
    }
    
    // Save uncommitted data to server
    function saveUncommitted(itemPk) {
        var data = { costing_pk: itemPk };
        
        if (isConstruction) {
            data.uncommitted_qty = getQtyValue(itemPk);
            data.uncommitted_rate = getRateValue(itemPk);
            data.uncommitted = data.uncommitted_qty * data.uncommitted_rate;
        } else {
            data.uncommitted = parseFloat($('.uncommitted-amount-input[data-item-pk="' + itemPk + '"]').val()) || 0;
        }
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
            },
            error: function(error) {
                console.error('Error saving uncommitted:', error);
            }
        });
    }
    
    // Make loadContractBudget available globally for refresh
    window.loadContractBudget = loadContractBudget;
    
    // Apply column group borders for construction types
    if (isConstruction) {
        $(document).ready(function() {
            applyColumnGroupBorders();
        });
    }
    
    function applyColumnGroupBorders() {
        var $thead = $('#contractBudgetMainTable thead');
        
        // Find parent headers (row 1) and add classes
        $thead.find('tr:first th[colspan]').each(function() {
            var headerText = $(this).text().trim();
            if (headerText === 'Uncommitted') {
                $(this).addClass('uncommitted-group');
            } else if (headerText === 'Committed') {
                $(this).addClass('committed-group');
            }
        });
        
        // Find subheadings (row 2) and add classes
        var inUncommitted = false;
        var inCommitted = false;
        var uncommittedCount = 0;
        var committedCount = 0;
        
        // Get the colspan values to know how many subheadings each group has
        var uncommittedColspan = 0;
        var committedColspan = 0;
        $thead.find('tr:first th[colspan]').each(function() {
            var headerText = $(this).text().trim();
            if (headerText === 'Uncommitted') {
                uncommittedColspan = parseInt($(this).attr('colspan')) || 0;
            } else if (headerText === 'Committed') {
                committedColspan = parseInt($(this).attr('colspan')) || 0;
            }
        });
        
        // Apply classes to subheading row
        $thead.find('tr:eq(1) th').each(function(index) {
            if (uncommittedCount < uncommittedColspan) {
                $(this).addClass('uncommitted-subheading');
                if (uncommittedCount === 0) {
                    $(this).addClass('uncommitted-subheading-first');
                }
                if (uncommittedCount === uncommittedColspan - 1) {
                    $(this).addClass('uncommitted-subheading-last');
                }
                uncommittedCount++;
            } else if (committedCount < committedColspan) {
                $(this).addClass('committed-subheading');
                if (committedCount === 0) {
                    $(this).addClass('committed-subheading-first');
                }
                if (committedCount === committedColspan - 1) {
                    $(this).addClass('committed-subheading-last');
                }
                committedCount++;
            }
        });
    }
    
    // Show Fix Contract Budget button only in Tender mode
    if (isTender && projectPk) {
        // Inject the button section into the layout (after the table container)
        var fixBudgetHtml = `
            <div id="fixContractBudgetSection" style="margin-top: 12px; padding: 0 12px;">
                <button id="fixContractBudgetBtn" class="btn btn-success">Fix Contract Budget</button>
                <div style="color: #dc3545; font-size: 12px; margin-top: 8px; max-width: 400px;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Fixing the Contract Budget moves the project from Tender to Execution. Tender values are saved for reference but this action is irreversible.
                </div>
            </div>
        `;
        // Insert after the table container inside the left panel
        $('.contractBudget-table-container').first().after(fixBudgetHtml);
    }
    
    // Fix Contract Budget button click handler (use .off first to prevent duplicate handlers)
    $(document).off('click', '#fixContractBudgetBtn').on('click', '#fixContractBudgetBtn', function() {
        var btn = $(this);
        btn.prop('disabled', true).text('Validating...');
        
        // Step 1: Validate all costing items have xero_account_code
        $.ajax({
            url: '/core/validate_fix_contract_budget/' + projectPk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status !== 'success') {
                    alert(response.message || 'Validation failed');
                    btn.prop('disabled', false).text('Fix Contract Budget');
                    return;
                }
                
                // Check for missing xero_account_code (mandatory)
                if (response.missing_xero_account_codes && response.missing_xero_account_codes.length > 0) {
                    alert('All Budget Items Must Have an Associated Xero Account. Fill in Missing Xero Accounts in BOM.');
                    btn.prop('disabled', false).text('Fix Contract Budget');
                    return;
                }
                
                // Check for missing xero_tracking_category (optional warning)
                if (response.missing_xero_tracking_categories && response.missing_xero_tracking_categories.length > 0) {
                    if (!confirm('Some Contract Budget Items Do Not Have an Associated Xero Tracking Category. Return to BOM if required.\n\nClick OK to proceed anyway, or Cancel to return.')) {
                        btn.prop('disabled', false).text('Fix Contract Budget');
                        return;
                    }
                }
                
                // Final confirmation
                if (!confirm('Fixing the Contract Budget is Irreversible. Proceed?')) {
                    btn.prop('disabled', false).text('Fix Contract Budget');
                    return;
                }
                
                // Proceed with fixing the contract budget
                btn.text('Processing...');
                $.ajax({
                    url: '/core/fix_contract_budget/' + projectPk + '/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    success: function(fixResponse) {
                        if (fixResponse.status === 'success') {
                            alert('Contract Budget has been fixed. Project is now in Execution mode.');
                            // Reload the page to reflect execution mode
                            window.location.reload();
                        } else {
                            alert(fixResponse.message || 'Error fixing contract budget');
                            btn.prop('disabled', false).text('Fix Contract Budget');
                        }
                    },
                    error: function() {
                        alert('Error fixing contract budget');
                        btn.prop('disabled', false).text('Fix Contract Budget');
                    }
                });
            },
            error: function() {
                alert('Error validating contract budget');
                btn.prop('disabled', false).text('Fix Contract Budget');
            }
        });
    });
    
})();
</script>
