{% load static %}
<!--
Template: Contract Budget (contract_budget.html)

Purpose:
Contract Budget section using allocations_layout.html pattern (like contacts.html).
Displays budget items with category grouping.

Backend: contract_budget_view in contract_budget.py
- Passes is_construction, is_tender flags
- Passes main_table_columns with subheading support for construction mode

Column Behaviors:
- Category/Item: Display only (indented for items)
- Unit: Display only
- Contract Budget: Display only (execution mode)
- Working Budget: Calculated (Uncommitted + Committed)
- Uncommitted (non-construction): Input field
- Qty/Rate (construction): Input fields
- Amount (construction): Calculated (Qty × Rate)
- Committed: Input field
- Cost to Complete, Billed, Fixed on Site: Display only (execution mode)
-->

<!-- Pass project type flags from Django context -->
<script>
    window.contractBudgetProjectPk = '{{ project_pk }}' !== 'None' ? '{{ project_pk }}' : null;
    window.contractBudgetIsConstruction = {{ is_construction|yesno:"true,false" }};
    window.contractBudgetIsTender = {{ is_tender|yesno:"true,false" }};
</script>

<style>
    /* Contract Budget specific styles - extend allocations_layout styles */
    
    /* Internal category styling - purple */
    .contractBudget-container .reusable-table tr.category-row.internal-category {
        background-color: #e6d5f5;
        color: #6f2da8;
    }
    
    .contractBudget-container .reusable-table tr.category-row.internal-category:hover {
        background-color: #d9c5ed;
    }
    
    .contractBudget-container .reusable-table tr.item-row.internal-item {
        color: #6f2da8;
    }
    
    .contractBudget-container .reusable-table tr.item-row.internal-item td {
        color: #6f2da8;
    }
    
    /* Item row indent */
    .contractBudget-container .reusable-table td.indent {
        padding-left: 30px;
    }
    
    /* Compact inputs for contract budget - right-align */
    .contractBudget-container .reusable-table input[type="number"] {
        width: 100%;
        text-align: right;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
    }
    
    /* Left-align all cells (same as quotes) - inherits from reusable-table */
    .contractBudget-container .reusable-table tbody td,
    .contractBudget-container .reusable-table thead th {
        text-align: left;
    }
    
    /* Click-to-edit cells */
    .contractBudget-container .click-to-edit {
        color: var(--color-primary, #007bff);
        cursor: pointer;
        text-decoration: none;
    }
    
    .contractBudget-container .click-to-edit:hover {
        text-decoration: underline;
    }
    
    /* Notepad icon */
    .contractBudget-container .notes-icon {
        color: var(--color-text-muted, #6c757d);
        cursor: pointer;
        font-size: 14px;
    }
    
    .contractBudget-container .notes-icon:hover {
        color: var(--color-primary, #007bff);
    }
    
    .contractBudget-container .notes-icon.has-notes {
        color: var(--color-success, #28a745);
    }
    
    /* Notes row styles - inline expansion */
    .contractBudget-container .notes-row {
        background-color: var(--color-bg-muted, #f8f9fa);
    }
    
    .contractBudget-container .notes-row td {
        padding: 8px 12px !important;
    }
    
    .contractBudget-container .notes-row textarea {
        width: 100%;
        min-height: 60px;
        padding: 8px;
        border: 1px solid var(--color-border, #dee2e6);
        border-radius: 4px;
        font-size: 13px;
        resize: vertical;
    }
    
    .contractBudget-container .notes-row textarea:focus {
        outline: none;
        border-color: var(--color-primary, #007bff);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
    }
    
    /* Active notes icon when row is expanded */
    .contractBudget-container .notes-icon.active {
        color: var(--color-primary, #007bff);
    }
</style>

<!-- Include the reusable allocations layout -->
{% include 'core/components/allocations_layout.html' %}

<script>
(function() {
    'use strict';
    
    console.log('Contract Budget script loaded');
    
    // Get configuration from backend
    var projectPk = window.contractBudgetProjectPk;
    var isConstruction = window.contractBudgetIsConstruction || false;
    var isTender = window.contractBudgetIsTender || false;
    
    console.log('Contract Budget config: projectPk=' + projectPk + ', isConstruction=' + isConstruction + ', isTender=' + isTender);
    
    // Initialize when DOM is ready
    setTimeout(function() {
        if (projectPk) {
            loadContractBudget(projectPk);
        } else {
            console.log('Contract Budget: No project_pk provided');
            $('#contractBudgetMainTableBody').html(
                '<tr><td colspan="' + getColCount() + '" style="text-align: center; padding: 40px; color: var(--color-text-muted);">No project selected</td></tr>'
            );
        }
    }, 100);
    
    // Get column count based on mode
    function getColCount() {
        if (isTender) {
            return isConstruction ? 8 : 5;  // 8 cols with Notes sub-column
        } else {
            return isConstruction ? 12 : 9;  // 12 cols with Notes sub-column
        }
    }
    
    // Load contract budget data
    function loadContractBudget(pk) {
        console.log('Loading contract budget for project:', pk);
        
        var tbody = $('#contractBudgetMainTableBody');
        var tfoot = $('#contractBudgetMainTableFooter');
        var colCount = getColCount();
        
        tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; padding: 20px;">Loading...</td></tr>');
        
        // Load categories, items, and committed amounts in parallel
        Promise.all([
            $.ajax({ url: '/core/get_project_categories/' + pk + '/', type: 'GET' }),
            $.ajax({ url: '/core/get_project_items/' + pk + '/', type: 'GET' }),
            $.ajax({ url: '/core/get_project_committed_amounts/' + pk + '/', type: 'GET' })
        ]).then(function(results) {
            var categories = results[0].categories || [];
            var items = results[1].items || [];
            var committedAmounts = results[2].committed_amounts || {};
            
            console.log('Loaded:', categories.length, 'categories,', items.length, 'items');
            renderTable(categories, items, committedAmounts);
        }).catch(function(error) {
            console.error('Error loading contract budget:', error);
            tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; color: #dc3545; padding: 20px;">Error loading data</td></tr>');
        });
    }
    
    // Render the table
    function renderTable(categories, items, committedAmounts) {
        var tbody = $('#contractBudgetMainTableBody');
        var tfoot = $('#contractBudgetMainTableFooter');
        var colCount = getColCount();
        
        tbody.empty();
        
        if (!categories || categories.length === 0) {
            tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; color: #6c757d; padding: 20px;">No categories yet. Add categories and items in the Items section first.</td></tr>');
            return;
        }
        
        // Sort categories by order_in_list
        categories.sort(function(a, b) { return a.order_in_list - b.order_in_list; });
        
        // Totals tracking
        var totals = {
            contract_budget: 0,
            working_budget: 0,
            uncommitted: 0,
            committed: 0,
            cost_to_complete: 0,
            billed: 0,
            fixed_on_site: 0
        };
        
        // Render each category and its items
        categories.forEach(function(category) {
            var isInternal = category.category === 'Internal';
            
            // Render category row
            var categoryRow = renderCategoryRow(category, isInternal);
            tbody.append(categoryRow);
            
            // Get items for this category
            var categoryItems = items.filter(function(item) {
                return item.category__category === category.category;
            });
            categoryItems.sort(function(a, b) { return a.order_in_list - b.order_in_list; });
            
            // Render item rows
            categoryItems.forEach(function(item) {
                var committedAmount = committedAmounts[item.costing_pk] || 0;
                var row = renderItemRow(item, committedAmount, isInternal, category.category);
                tbody.append(row);
                
                // Update totals (only for non-internal items or all items depending on logic)
                if (!isInternal) {
                    var uncommittedAmount = isConstruction ? 
                        (parseFloat(item.uncommitted_qty) || 0) * (parseFloat(item.uncommitted_rate) || 0) :
                        (parseFloat(item.uncommitted_amount) || 0);
                    
                    totals.uncommitted += uncommittedAmount;
                    totals.committed += committedAmount;
                    totals.working_budget += uncommittedAmount + committedAmount;
                }
                
                if (!isTender) {
                    totals.contract_budget += parseFloat(item.contract_budget) || 0;
                    totals.cost_to_complete += parseFloat(item.cost_to_complete) || 0;
                    totals.billed += parseFloat(item.billd_amount) || 0;
                    totals.fixed_on_site += parseFloat(item.fixed_on_site_amount) || 0;
                }
            });
        });
        
        // Render totals footer
        renderTotalsFooter(tfoot, totals);
    }
    
    // Render a category row
    function renderCategoryRow(category, isInternal) {
        var row = $('<tr class="category-row"></tr>');
        if (isInternal) row.addClass('internal-category');
        
        row.append('<td><strong>' + Utils.escapeHtml(category.category) + '</strong></td>');
        
        // Add empty cells based on mode (no dashes)
        var emptyCells = getColCount() - 1;
        for (var i = 0; i < emptyCells; i++) {
            row.append('<td></td>');
        }
        
        return row;
    }
    
    // Render an item row
    function renderItemRow(item, committedAmount, isInternal, categoryName) {
        var row = $('<tr class="item-row"></tr>');
        if (isInternal) {
            row.addClass('internal-item');
            row.attr('data-is-internal', 'true');
        }
        row.attr('data-item-pk', item.costing_pk);
        row.attr('data-category', categoryName);
        
        // Category / Item column with indent
        row.append('<td class="indent">' + Utils.escapeHtml(item.item) + '</td>');
        
        // Unit column
        row.append('<td>' + Utils.escapeHtml(item.unit || '-') + '</td>');
        
        if (!isTender) {
            // Contract Budget column (execution mode only)
            row.append('<td>' + Utils.formatCurrency(item.contract_budget || 0) + '</td>');
        }
        
        // Working Budget column (calculated: Uncommitted + Committed)
        var uncommittedAmount = isConstruction ?
            (parseFloat(item.uncommitted_qty) || 0) * (parseFloat(item.uncommitted_rate) || 0) :
            (parseFloat(item.uncommitted_amount) || 0);
        var workingBudget = uncommittedAmount + committedAmount;
        row.append('<td class="working-budget-cell" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(workingBudget) + '</td>');
        
        if (isConstruction) {
            // Uncommitted: Qty | Rate | Amount | Notes (construction mode)
            if (isInternal) {
                row.append('<td>-</td>');  // Qty
                row.append('<td>-</td>');  // Rate
                row.append('<td>-</td>');  // Amount
                row.append('<td>-</td>');  // Notes
            } else {
                // Qty - clickable text that becomes input
                var qtyVal = parseFloat(item.uncommitted_qty || 0).toFixed(2);
                var qtyTd = $('<td class="qty-cell" data-item-pk="' + item.costing_pk + '"></td>');
                var qtyLink = $('<a href="#" class="click-to-edit qty-display" data-item-pk="' + item.costing_pk + '">' + qtyVal + '</a>');
                qtyLink.on('click', function(e) {
                    e.preventDefault();
                    convertToInput(item.costing_pk, 'qty');
                });
                qtyTd.append(qtyLink);
                row.append(qtyTd);
                
                // Rate - clickable text that becomes input
                var rateVal = parseFloat(item.uncommitted_rate || 0).toFixed(2);
                var rateTd = $('<td class="rate-cell" data-item-pk="' + item.costing_pk + '"></td>');
                var rateLink = $('<a href="#" class="click-to-edit rate-display" data-item-pk="' + item.costing_pk + '">' + rateVal + '</a>');
                rateLink.on('click', function(e) {
                    e.preventDefault();
                    convertToInput(item.costing_pk, 'rate');
                });
                rateTd.append(rateLink);
                row.append(rateTd);
                
                // Amount (calculated)
                row.append('<td class="uncommitted-amount" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(uncommittedAmount) + '</td>');
                
                // Notes - notepad icon (store notes on row data attribute for live updates)
                var hasNotes = item.uncommitted_notes && item.uncommitted_notes.trim() !== '';
                row.attr('data-notes', item.uncommitted_notes || '');
                var notesIcon = $('<i class="fas fa-sticky-note notes-icon' + (hasNotes ? ' has-notes' : '') + '" data-item-pk="' + item.costing_pk + '"></i>');
                notesIcon.attr('title', hasNotes ? item.uncommitted_notes : 'Add notes');
                notesIcon.on('click', function() {
                    // Read current notes from row data attribute (updated after save)
                    var currentNotes = $('tr.item-row[data-item-pk="' + item.costing_pk + '"]').attr('data-notes') || '';
                    toggleNotesRow(item.costing_pk, currentNotes);
                });
                row.append($('<td style="text-align: center;"></td>').append(notesIcon));
            }
        } else {
            // Uncommitted: single Amount field (non-construction mode)
            if (isInternal) {
                row.append('<td>-</td>');
            } else {
                var amountInput = $('<input type="number" step="0.01" min="0" class="uncommitted-amount-input">');
                amountInput.attr('data-item-pk', item.costing_pk);
                amountInput.val(parseFloat(item.uncommitted_amount || 0).toFixed(2));
                amountInput.on('input', function() { updateWorkingBudget(item.costing_pk); });
                row.append($('<td></td>').append(amountInput));
            }
        }
        
        // Committed column (display only - calculated from quote allocations)
        row.append('<td class="committed-cell" data-item-pk="' + item.costing_pk + '">' + Utils.formatCurrency(committedAmount) + '</td>');
        
        if (!isTender) {
            // Execution mode extra columns
            row.append('<td>' + Utils.formatCurrency(item.cost_to_complete || 0) + '</td>');
            row.append('<td>' + Utils.formatCurrency(item.billd_amount || 0) + '</td>');
            row.append('<td>' + Utils.formatCurrency(item.fixed_on_site_amount || 0) + '</td>');
        }
        
        return row;
    }
    
    // Convert click-to-edit link to input field
    function convertToInput(itemPk, field) {
        var displaySelector = '.' + field + '-display[data-item-pk="' + itemPk + '"]';
        var display = $(displaySelector);
        if (!display.length) return;
        
        var currentVal = parseFloat(display.text()) || 0;
        var td = display.parent();
        
        // Create input
        var input = $('<input type="number" step="0.01" min="0">')
            .addClass('uncommitted-' + field)
            .attr('data-item-pk', itemPk)
            .val(currentVal.toFixed(2))
            .css('width', '100%');
        
        // Replace link with input
        td.empty().append(input);
        input.focus().select();
        
        // Handle input changes
        input.on('input', function() {
            updateUncommittedAmount(itemPk);
        });
        
        // Handle blur - convert back to link
        input.on('blur', function() {
            var newVal = parseFloat($(this).val()) || 0;
            var newLink = $('<a href="#" class="click-to-edit ' + field + '-display" data-item-pk="' + itemPk + '">' + newVal.toFixed(2) + '</a>');
            newLink.on('click', function(e) {
                e.preventDefault();
                convertToInput(itemPk, field);
            });
            td.empty().append(newLink);
        });
    }
    
    // Get qty value (from input or display link)
    function getQtyValue(itemPk) {
        var input = $('.uncommitted-qty[data-item-pk="' + itemPk + '"]');
        if (input.length) return parseFloat(input.val()) || 0;
        var display = $('.qty-display[data-item-pk="' + itemPk + '"]');
        if (display.length) return parseFloat(display.text()) || 0;
        return 0;
    }
    
    // Get rate value (from input or display link)
    function getRateValue(itemPk) {
        var input = $('.uncommitted-rate[data-item-pk="' + itemPk + '"]');
        if (input.length) return parseFloat(input.val()) || 0;
        var display = $('.rate-display[data-item-pk="' + itemPk + '"]');
        if (display.length) return parseFloat(display.text()) || 0;
        return 0;
    }
    
    // Close any open notes row (save first if has content)
    function closeOpenNotesRow() {
        var openRow = $('.notes-row');
        if (openRow.length) {
            var textarea = openRow.find('textarea');
            var itemPk = textarea.attr('data-item-pk');
            var notes = textarea.val();
            
            // Save before closing
            if (itemPk) {
                saveNotes(itemPk, notes);
            }
            
            // Remove row and reset icon
            $('.notes-icon[data-item-pk="' + itemPk + '"]').removeClass('active');
            openRow.remove();
        }
    }
    
    // Toggle notes row - inline expansion (only one at a time)
    function toggleNotesRow(itemPk, currentNotes) {
        var existingRow = $('#notes-row-' + itemPk);
        var icon = $('.notes-icon[data-item-pk="' + itemPk + '"]');
        
        // If clicking the same row's icon, just close it
        if (existingRow.length) {
            closeOpenNotesRow();
            return;
        }
        
        // Close any other open notes row first
        closeOpenNotesRow();
        
        // Create notes row
        var itemRow = $('tr.item-row[data-item-pk="' + itemPk + '"]');
        var colCount = getColCount();
        
        var notesRow = $('<tr id="notes-row-' + itemPk + '" class="notes-row" data-item-pk="' + itemPk + '"></tr>');
        var td = $('<td colspan="' + colCount + '"></td>');
        
        var textarea = $('<textarea class="notes-textarea" data-item-pk="' + itemPk + '" placeholder="Enter notes..." maxlength="1000"></textarea>');
        textarea.val(currentNotes);
        
        td.append(textarea);
        notesRow.append(td);
        itemRow.after(notesRow);
        textarea.focus();
        
        icon.addClass('active');
    }
    
    // Close notes row when clicking outside
    $(document).on('click', function(e) {
        var target = $(e.target);
        
        // Don't close if clicking on notes row, textarea, or notes icon
        if (target.closest('.notes-row').length || 
            target.hasClass('notes-icon') || 
            target.closest('.notes-icon').length) {
            return;
        }
        
        // Close any open notes row
        closeOpenNotesRow();
    });
    
    // Save notes to server
    function saveNotes(itemPk, notes) {
        var data = {
            costing_pk: itemPk,
            notes: notes
        };
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                console.log('Saved notes for item:', itemPk);
                
                // Update local data on the row so re-clicking shows current value
                $('tr.item-row[data-item-pk="' + itemPk + '"]').attr('data-notes', notes);
                
                // Update icon state
                var icon = $('.notes-icon[data-item-pk="' + itemPk + '"]');
                if (notes && notes.trim() !== '') {
                    icon.addClass('has-notes');
                    icon.attr('title', notes);
                } else {
                    icon.removeClass('has-notes');
                    icon.attr('title', 'Add notes');
                }
            },
            error: function(error) {
                console.error('Error saving notes:', error);
            }
        });
    }
    
    // Update uncommitted amount (Qty × Rate) for construction mode
    function updateUncommittedAmount(itemPk) {
        var qty = getQtyValue(itemPk);
        var rate = getRateValue(itemPk);
        var amount = qty * rate;
        
        $('.uncommitted-amount[data-item-pk="' + itemPk + '"]').text(Utils.formatCurrency(amount));
        updateWorkingBudget(itemPk);
        
        // Auto-save after a delay
        clearTimeout(window.contractBudgetSaveTimeout);
        window.contractBudgetSaveTimeout = setTimeout(function() {
            saveUncommitted(itemPk);
        }, 1000);
    }
    
    // Update working budget (Uncommitted + Committed)
    function updateWorkingBudget(itemPk) {
        var uncommitted = 0;
        if (isConstruction) {
            uncommitted = getQtyValue(itemPk) * getRateValue(itemPk);
        } else {
            uncommitted = parseFloat($('.uncommitted-amount-input[data-item-pk="' + itemPk + '"]').val()) || 0;
        }
        
        // Committed is display-only - parse from cell text
        var committedText = $('.committed-cell[data-item-pk="' + itemPk + '"]').text();
        var committed = parseFloat(committedText.replace(/[^0-9.-]/g, '')) || 0;
        var workingBudget = uncommitted + committed;
        
        $('.working-budget-cell[data-item-pk="' + itemPk + '"]').text(Utils.formatCurrency(workingBudget));
        
        // Update totals
        updateTotals();
    }
    
    // Update totals footer
    function updateTotals() {
        var totals = { uncommitted: 0, committed: 0, working_budget: 0 };
        
        $('#contractBudgetMainTableBody tr.item-row:not([data-is-internal="true"])').each(function() {
            var itemPk = $(this).attr('data-item-pk');
            var uncommitted = 0;
            
            if (isConstruction) {
                uncommitted = getQtyValue(itemPk) * getRateValue(itemPk);
            } else {
                uncommitted = parseFloat($('.uncommitted-amount-input[data-item-pk="' + itemPk + '"]').val()) || 0;
            }
            
            // Committed is display-only - parse from cell text
            var committedText = $('.committed-cell[data-item-pk="' + itemPk + '"]').text();
            var committed = parseFloat(committedText.replace(/[^0-9.-]/g, '')) || 0;
            
            totals.uncommitted += uncommitted;
            totals.committed += committed;
            totals.working_budget += uncommitted + committed;
        });
        
        $('#totalUncommitted').text(Utils.formatCurrency(totals.uncommitted));
        $('#totalCommitted').text(Utils.formatCurrency(totals.committed));
        $('#totalWorkingBudget').text(Utils.formatCurrency(totals.working_budget));
    }
    
    // Render totals footer
    function renderTotalsFooter(tfoot, totals) {
        tfoot.empty().show();
        
        var row = $('<tr style="background: var(--color-bg-muted); font-weight: 600;"></tr>');
        
        row.append('<td><strong>TOTALS</strong></td>');
        row.append('<td></td>');  // Unit
        
        if (!isTender) {
            row.append('<td id="totalContractBudget">' + Utils.formatCurrency(totals.contract_budget) + '</td>');
        }
        
        row.append('<td id="totalWorkingBudget">' + Utils.formatCurrency(totals.working_budget) + '</td>');
        
        if (isConstruction) {
            row.append('<td></td>');  // Qty
            row.append('<td></td>');  // Rate
            row.append('<td id="totalUncommitted">' + Utils.formatCurrency(totals.uncommitted) + '</td>');
            row.append('<td></td>');  // Notes
        } else {
            row.append('<td id="totalUncommitted">' + Utils.formatCurrency(totals.uncommitted) + '</td>');
        }
        
        row.append('<td id="totalCommitted">' + Utils.formatCurrency(totals.committed) + '</td>');
        
        if (!isTender) {
            row.append('<td id="totalCostToComplete">' + Utils.formatCurrency(totals.cost_to_complete) + '</td>');
            row.append('<td id="totalBilled">' + Utils.formatCurrency(totals.billed) + '</td>');
            row.append('<td id="totalFixedOnSite">' + Utils.formatCurrency(totals.fixed_on_site) + '</td>');
        }
        
        tfoot.append(row);
    }
    
    // Save uncommitted data to server
    function saveUncommitted(itemPk) {
        var data = { costing_pk: itemPk };
        
        if (isConstruction) {
            data.uncommitted_qty = getQtyValue(itemPk);
            data.uncommitted_rate = getRateValue(itemPk);
            data.uncommitted = data.uncommitted_qty * data.uncommitted_rate;
        } else {
            data.uncommitted = parseFloat($('.uncommitted-amount-input[data-item-pk="' + itemPk + '"]').val()) || 0;
        }
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                console.log('Saved uncommitted for item:', itemPk);
            },
            error: function(error) {
                console.error('Error saving uncommitted:', error);
            }
        });
    }
    
    // Make loadContractBudget available globally for refresh
    window.loadContractBudget = loadContractBudget;
    
})();
</script>
