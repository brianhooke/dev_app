<!-- Items Management for Project Tender View - HTML Only -->
{% include 'core/components/rates_table.html' %}
<style>
    .items-container {
        display: flex;
        height: 100%;
        gap: 15px;
    }
    
    .items-left-panel {
        width: 50%;
        overflow-y: auto;
    }
    
    .items-right-panel {
        width: 50%;
        overflow-y: auto;
    }
    
    .items-section {
        margin-bottom: 30px;
    }
    
    .items-section h5 {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }
    
    /* Compact form inputs for items tables */
    .items-left-panel .reusable-table input[type="text"],
    .items-left-panel .reusable-table select {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    
    .items-add-btn {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .items-add-btn.disabled {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    
    .items-add-btn.enabled {
        background-color: #28a745;
        color: white;
    }
    
    .items-add-btn.enabled:hover {
        background-color: #218838;
    }
</style>

<div class="items-container">
    <!-- Left Panel: Add Category/Item/Unit Forms + CSV Upload -->
    <div class="items-left-panel">
        <!-- Add Category/Item/Unit forms container (rendered by component) -->
        <div id="itemsInputFormsContainer"></div>
        
        <!-- Bulk Upload via CSV Section -->
        <div class="items-section">
            <h5>Bulk Upload via CSV</h5>
            <div style="padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                <p style="margin-bottom: 10px; font-size: 12px; color: #6c757d;">
                    Upload categories and items in bulk using a CSV file. Download the example template below to see the required format.
                </p>
                
                <div style="display: flex; gap: 10px;">
                    <button id="downloadExampleCsvBtn" class="btn btn-sm btn-info">
                        <i class="fas fa-download"></i> Download Example CSV
                    </button>
                    
                    <button id="uploadCsvBtn" class="btn btn-sm btn-success">
                        <i class="fas fa-upload"></i> Upload CSV
                    </button>
                </div>
                
                <!-- Hidden file input -->
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                
                <p style="margin-top: 10px; margin-bottom: 0; font-size: 11px; color: #dc3545;">
                    <strong>Note:</strong> Upload will add to existing categories/items, not replace them.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Right Panel: Category / Item Display Table (uses shared component) -->
    <div class="items-right-panel">
        <div id="itemsDisplayTableBody">
            <div class="rates-flex-empty">
                No items yet. Add a category and items to get started.
            </div>
        </div>
    </div>
</div>

<!-- Self-contained Items Section JS -->
<script>
$(document).ready(function() {
    // Auto-initialize if the items section is loaded
    if ($('#itemsDisplayTableBody').length > 0) {
        initializeItemsSection();
    }
    
    // Initialize Items Section Function
    function initializeItemsSection() {
            // Clear global variables for items management
            window.itemsCategories = [];
            window.itemsItems = [];
            
            // Clear the table immediately to prevent showing stale data
            var tbody = $('#tenderContentArea #itemsDisplayTableBody');
            if (tbody.length > 0) {
                tbody.html('<tr><td style="text-align: center; color: #6c757d; padding: 20px;">Loading...</td></tr>');
            }
            
            // Dropdown update functions
            // Update category order dropdown
            function updateCategoryOrderDropdown() {
                var select = document.querySelector('#tenderContentArea #categoryOrderSelect');
                if (!select) return;
                
                // Add 1 to number of categories: if 0 categories, show option 1; if 3 categories, show 1,2,3,4
                var maxOrder = window.itemsCategories.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Update item category dropdown
            function updateItemCategoryDropdown() {
                var select = document.querySelector('#tenderContentArea #itemCategorySelect');
                if (!select) return;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select category...</option>';
                window.itemsCategories.forEach(function(category) {
                    optionsHTML += '<option value="' + category.categories_pk + '">' + category.category + '</option>';
                });
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Load and populate unit dropdown
            function loadAndPopulateUnits() {
                $.ajax({
                    url: '/core/get_units/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Store units for renderRatesTable
                            window.itemsUnits = response.units;
                            
                            var select = document.querySelector('#tenderContentArea #itemUnitSelect');
                            if (!select) return;
                            
                            // Build options HTML string
                            var optionsHTML = '<option value="">Select unit...</option>';
                            response.units.forEach(function(unit) {
                                optionsHTML += '<option value="' + unit.unit_pk + '">' + unit.unit_name + '</option>';
                            });
                            
                            // Replace select's innerHTML
                            select.innerHTML = optionsHTML;
                        } else {
                            console.error('Error loading units:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading units:', error);
                    }
                });
            }
            
            // Update item order dropdown based on selected category
            function updateItemOrderDropdown(categoryPk) {
                var select = document.querySelector('#tenderContentArea #itemOrderSelect');
                if (!select) return;
                
                if (!categoryPk) {
                    select.innerHTML = '<option value="">Select category first...</option>';
                    select.disabled = true;
                    return;
                }
                
                // Count items in this category
                var itemsInCategory = window.itemsItems.filter(function(item) {
                    return item.category__category === getCategoryName(categoryPk);
                });
                
                // Add 1 to number of items: if 0 items, show option 1; if 3 items, show 1,2,3,4
                var maxOrder = itemsInCategory.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
                select.disabled = false;
            }
            
            // Get category name by PK
            function getCategoryName(categoryPk) {
                var category = window.itemsCategories.find(function(cat) {
                    return cat.categories_pk == categoryPk;
                });
                return category ? category.category : '';
            }
            
            // Load units for the unit dropdown
            loadAndPopulateUnits();
            
            // Load categories and items for current project
            if (window.currentTenderProject && window.currentTenderProject.pk) {
                loadProjectItems(window.currentTenderProject.pk);
            }
            
            // Load categories and items for a project
            function loadProjectItems(projectPk) {
                
                // Load categories
                $.ajax({
                    url: '/core/get_project_categories/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsCategories = response.categories;
                            updateCategoryOrderDropdown();
                            updateItemCategoryDropdown();
                            loadItems(projectPk);
                        } else {
                            console.error('Error loading categories:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load categories:', error);
                    }
                });
            }
            
            // Load items
            function loadItems(projectPk) {
                $.ajax({
                    url: '/core/get_project_items/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsItems = response.items;
                            renderItemsInputForms();
                            renderItemsTable();
                        } else {
                            console.error('Error loading items:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load items:', error);
                    }
                });
            }
            
            // Render input forms using shared component
            function renderItemsInputForms() {
                if (typeof window.renderRatesInputForms === 'function') {
                    var projectPk = window.currentTenderProject ? window.currentTenderProject.pk : null;
                    window.renderRatesInputForms('#tenderContentArea #itemsInputFormsContainer', {
                        mode: 'project',
                        modeValue: projectPk,
                        categories: window.itemsCategories || [],
                        items: window.itemsItems || [],
                        units: window.itemsUnits || [],
                        showListColumn: false,
                        onReload: function() {
                            loadProjectItems(projectPk);
                        }
                    });
                }
            }
            
            // Render items table using shared component
            function renderItemsTable() {
                if (typeof window.renderRatesTable === 'function') {
                    window.renderRatesTable('#tenderContentArea #itemsDisplayTableBody', window.itemsCategories, window.itemsItems, {
                        allowDrag: true,
                        allowDelete: true,
                        projectPk: window.currentTenderProject ? window.currentTenderProject.pk : null,
                        units: window.itemsUnits || [],
                        onReload: function() {
                            loadProjectItems(window.currentTenderProject.pk);
                        }
                    });
                }
            }
            
            // Add Category/Item validation and handlers now in renderRatesInputForms component
            // Legacy functions kept as stubs for compatibility
            function validateCategoryForm() {}
            function validateItemForm() {}
            function updateItemOrderDropdown() {}
            
            // Download Example CSV button
            $('#tenderContentArea').off('click', '#downloadExampleCsvBtn').on('click', '#downloadExampleCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger download of example CSV
                window.location.href = '/core/download_items_csv_template/';
            });
            
            // Upload CSV button - triggers file picker
            $('#tenderContentArea').off('click', '#uploadCsvBtn').on('click', '#uploadCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger the hidden file input
                $('#tenderContentArea #csvFileInput').click();
            });
            
            // CSV File input change handler - immediately upload when file selected
            $('#tenderContentArea').off('change', '#csvFileInput').on('change', '#csvFileInput', function() {
                const fileInput = this;
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Validate file type
                if (!file.name.endsWith('.csv')) {
                    alert('Please select a valid CSV file');
                    fileInput.value = '';
                    return;
                }
                
                // Create FormData and upload
                const formData = new FormData();
                formData.append('csv_file', file);
                formData.append('project_pk', window.currentTenderProject.pk);
                
                // Show uploading state on upload button
                const uploadBtn = $('#uploadCsvBtn');
                const originalText = uploadBtn.html();
                uploadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                
                $.ajax({
                    url: '/core/upload_items_csv/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            let message = `Success! Created ${response.categories_created} categories and ${response.items_created} items.`;
                            
                            // Add warnings if any
                            if (response.warnings && response.warnings.length > 0) {
                                message += '\n\nWarnings:\n' + response.warnings.slice(0, 5).join('\n');
                                if (response.warnings.length > 5) {
                                    message += `\n... and ${response.warnings.length - 5} more warnings`;
                                }
                            }
                            
                            alert(message);
                            
                            // Reload items to show new data
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear file input
                            fileInput.value = '';
                        } else {
                            alert('Error: ' + response.message);
                        }
                        
                        uploadBtn.prop('disabled', false).html(originalText);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to upload CSV:', error);
                        let errorMessage = 'Failed to upload CSV';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to upload CSV: ' + error;
                        }
                        alert(errorMessage);
                        uploadBtn.prop('disabled', false).html(originalText);
                        fileInput.value = '';
                    }
                });
            });
        }
    });
</script>
