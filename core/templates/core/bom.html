<!-- Items Management for Project Tender View - HTML Only -->
{% include 'core/components/rates_table.html' %}
<style>
    .items-container {
        display: flex;
        height: 100%;
        gap: 15px;
        align-items: flex-start;
    }
    
    .items-left-panel {
        width: 30%;
        overflow-y: auto;
    }
    
    .items-right-panel {
        width: 70%;
        overflow-y: auto;
    }
    
    .items-section {
        margin-bottom: 30px;
    }
    
    .items-section h5 {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }
    
    /* Compact form inputs for items tables */
    .items-left-panel .reusable-table input[type="text"],
    .items-left-panel .reusable-table select {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    
    .items-add-btn {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .items-add-btn.disabled {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    
    .items-add-btn.enabled {
        background-color: #28a745;
        color: white;
    }
    
    .items-add-btn.enabled:hover {
        background-color: #218838;
    }
</style>

<div class="items-container">
    <!-- Left Panel: Add Category/Item/Unit Forms + CSV Upload -->
    <div class="items-left-panel">
        <!-- Add Category/Item/Unit forms container (rendered by component) -->
        <div id="itemsInputFormsContainer"></div>
    </div>
    
    <!-- Right Panel: Category / Item Display Table (uses shared component) -->
    <div class="items-right-panel">
        <div id="itemsDisplayTableBody">
            <div class="rates-flex-empty">
                No items yet. Add a category and items to get started.
            </div>
        </div>
    </div>
</div>

<!-- Self-contained Items Section JS -->
<script>
$(document).ready(function() {
    // Auto-initialize if the items section is loaded
    if ($('#itemsDisplayTableBody').length > 0) {
        initializeItemsSection();
    }
    
    // Initialize Items Section Function
    function initializeItemsSection() {
            // Clear global variables for items management
            window.itemsCategories = [];
            window.itemsItems = [];
            
            // Clear the table immediately to prevent showing stale data
            var tbody = $('#tenderContentArea #itemsDisplayTableBody');
            if (tbody.length > 0) {
                tbody.html('<tr><td style="text-align: center; color: #6c757d; padding: 20px;">Loading...</td></tr>');
            }
            
            // Dropdown update functions
            // Update category order dropdown
            function updateCategoryOrderDropdown() {
                var select = document.querySelector('#tenderContentArea #categoryOrderSelect');
                if (!select) return;
                
                // Add 1 to number of categories: if 0 categories, show option 1; if 3 categories, show 1,2,3,4
                var maxOrder = window.itemsCategories.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Update item category dropdown
            function updateItemCategoryDropdown() {
                var select = document.querySelector('#tenderContentArea #itemCategorySelect');
                if (!select) return;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select category...</option>';
                window.itemsCategories.forEach(function(category) {
                    optionsHTML += '<option value="' + category.categories_pk + '">' + category.category + '</option>';
                });
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Load and populate unit dropdown for specific project
            function loadAndPopulateUnits(projectPk) {
                var url = '/core/get_units/';
                if (projectPk) {
                    url += '?project_pk=' + projectPk;
                }
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Store units for renderRatesTable
                            window.itemsUnits = response.units;
                            
                            var select = document.querySelector('#tenderContentArea #itemUnitSelect');
                            if (!select) return;
                            
                            // Build options HTML string
                            var optionsHTML = '<option value="">Select unit...</option>';
                            response.units.forEach(function(unit) {
                                optionsHTML += '<option value="' + unit.unit_pk + '">' + unit.unit_name + '</option>';
                            });
                            
                            // Replace select's innerHTML
                            select.innerHTML = optionsHTML;
                        } else {
                            console.error('Error loading units:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading units:', error);
                    }
                });
            }
            
            // Update item order dropdown based on selected category
            function updateItemOrderDropdown(categoryPk) {
                var select = document.querySelector('#tenderContentArea #itemOrderSelect');
                if (!select) return;
                
                if (!categoryPk) {
                    select.innerHTML = '<option value="">Select category first...</option>';
                    select.disabled = true;
                    return;
                }
                
                // Count items in this category
                var itemsInCategory = window.itemsItems.filter(function(item) {
                    return item.category__category === getCategoryName(categoryPk);
                });
                
                // Add 1 to number of items: if 0 items, show option 1; if 3 items, show 1,2,3,4
                var maxOrder = itemsInCategory.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
                select.disabled = false;
            }
            
            // Get category name by PK
            function getCategoryName(categoryPk) {
                var category = window.itemsCategories.find(function(cat) {
                    return cat.categories_pk == categoryPk;
                });
                return category ? category.category : '';
            }
            
            // Load categories and items for current project
            if (window.currentTenderProject && window.currentTenderProject.pk) {
                // Load units for the specific project
                loadAndPopulateUnits(window.currentTenderProject.pk);
                loadProjectItems(window.currentTenderProject.pk);
            }
            
            // Load categories and items for a project
            function loadProjectItems(projectPk) {
                
                // Load units first, then categories/items (chain to ensure units are available for rendering)
                var url = '/core/get_units/';
                if (projectPk) {
                    url += '?project_pk=' + projectPk;
                }
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update units
                            window.itemsUnits = response.units;
                            
                            // Update item unit dropdown
                            var select = document.querySelector('#tenderContentArea #itemUnitSelect');
                            if (select) {
                                var optionsHTML = '<option value="">Select unit...</option>';
                                response.units.forEach(function(unit) {
                                    optionsHTML += '<option value="' + unit.unit_pk + '">' + unit.unit_name + '</option>';
                                });
                                select.innerHTML = optionsHTML;
                            }
                            
                            // Now load categories
                            loadCategories(projectPk);
                        } else {
                            console.error('Error loading units:', response.message);
                            // Still try to load categories even if units fail
                            loadCategories(projectPk);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading units:', error);
                        // Still try to load categories even if units fail
                        loadCategories(projectPk);
                    }
                });
            }
            
            // Load categories (called after units are loaded)
            function loadCategories(projectPk) {
                $.ajax({
                    url: '/core/get_project_categories/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsCategories = response.categories;
                            updateCategoryOrderDropdown();
                            updateItemCategoryDropdown();
                            loadItems(projectPk);
                        } else {
                            console.error('Error loading categories:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load categories:', error);
                    }
                });
            }
            
            // Load items
            function loadItems(projectPk) {
                $.ajax({
                    url: '/core/get_project_items/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsItems = response.items;
                            // Load Xero dropdown data, then render
                            loadXeroDropdownData(projectPk);
                        } else {
                            console.error('Error loading items:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load items:', error);
                    }
                });
            }
            
            // Load Xero accounts and tracking categories for dropdowns
            function loadXeroDropdownData(projectPk) {
                $.ajax({
                    url: '/core/get_xero_dropdown_data/?project_pk=' + projectPk,
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsXeroAccounts = response.xero_accounts || [];
                            window.itemsTrackingCategories = response.tracking_categories || [];
                        } else {
                            console.error('Error loading Xero dropdown data:', response.message);
                            window.itemsXeroAccounts = [];
                            window.itemsTrackingCategories = [];
                        }
                        renderItemsInputForms();
                        renderItemsTable();
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load Xero dropdown data:', error);
                        window.itemsXeroAccounts = [];
                        window.itemsTrackingCategories = [];
                        renderItemsInputForms();
                        renderItemsTable();
                    }
                });
            }
            
            // Render input forms using shared component
            function renderItemsInputForms() {
                if (typeof window.renderRatesInputForms === 'function') {
                    var projectPk = window.currentTenderProject ? window.currentTenderProject.pk : null;
                    window.renderRatesInputForms('#tenderContentArea #itemsInputFormsContainer', {
                        mode: 'project',
                        modeValue: projectPk,
                        categories: window.itemsCategories || [],
                        items: window.itemsItems || [],
                        units: window.itemsUnits || [],
                        showListColumn: false,
                        showUnitQtyColumn: true,
                        onReload: function() {
                            loadProjectItems(projectPk);
                        }
                    });
                }
            }
            
            // Render items table using shared component
            function renderItemsTable() {
                if (typeof window.renderRatesTable === 'function') {
                    window.renderRatesTable('#tenderContentArea #itemsDisplayTableBody', window.itemsCategories, window.itemsItems, {
                        allowDrag: true,
                        allowDelete: true,
                        projectPk: window.currentTenderProject ? window.currentTenderProject.pk : null,
                        units: window.itemsUnits || [],
                        xeroAccounts: window.itemsXeroAccounts || [],
                        trackingCategories: window.itemsTrackingCategories || [],
                        showQuantityColumn: true,
                        defaultExpanded: true,
                        showCopyToContractButton: true,
                        onReload: function() {
                            loadProjectItems(window.currentTenderProject.pk);
                        }
                    });
                }
            }
            
            // Add Category/Item validation and handlers now in renderRatesInputForms component
            // Legacy functions kept as stubs for compatibility
            function validateCategoryForm() {}
            function validateItemForm() {}
            function updateItemOrderDropdown() {}
            
        }
    });
</script>
