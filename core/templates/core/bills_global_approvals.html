<!-- Bills Global Approvals Section -->
<!-- Uses allocations_layout.html with read-only allocations -->
{% load static %}

{% include "core/components/allocations_layout.html" with section_id="billsApprovals" main_table_columns=main_table_columns allocations_columns=allocations_columns hide_allocations=False viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Bills Approvals Section JS -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsApprovalsMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Approvals
    AllocationsManager.init({
        sectionId: 'billsApprovals',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: true,
            confirmDelete: false,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No approved bills waiting to be sent to Xero.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // 1. Project
                var projectName = bill.project_name || '-';
                row.append($('<td>').attr('title', projectName).text(projectName));
                
                // 2. Xero Instance
                var xeroInstanceName = bill.xero_instance_name || '-';
                row.append($('<td>').attr('title', xeroInstanceName).text(xeroInstanceName));
                
                // 3. Supplier
                var supplierName = bill.supplier_name || '-';
                row.append($('<td>').attr('title', supplierName).text(supplierName));
                
                // 4. $ Gross
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gross)));
                
                // 5. $ Net
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_net)));
                
                // 6. $ GST
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gst)));
                
                // 7. Date
                var billDate = bill.bill_date ? Utils.formatDate(bill.bill_date) : '-';
                row.append($('<td>').text(billDate));
                
                // 8. Due Date
                var dueDate = bill.bill_due_date ? Utils.formatDate(bill.bill_due_date) : '-';
                row.append($('<td>').text(dueDate));
                
                // 9. Send to Xero button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-success approvals-send-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Send');
                row.append($('<td>').addClass('col-action-first').css('text-align', 'center').append(sendBtn));
                
                // 10. Mark X button (marks as sent without actually sending to Xero)
                var markXBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary approvals-mark-x-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Mark X')
                    .attr('title', 'Mark as sent to Xero without sending');
                row.append($('<td>').addClass('col-action').css('text-align', 'center').append(markXBtn));
                
                // 11. Return to Project button
                var returnBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning approvals-return-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .html('<i class="fas fa-undo"></i>')
                    .attr('title', 'Return to Project');
                row.append($('<td>').addClass('col-action').css('text-align', 'center').append(returnBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                
                // Find full bill data
                var bill = window.billsApprovalsData.find(function(b) {
                    return b.bill_pk === parseInt(pk);
                });
                window.currentBillData = bill;
                
                // Load allocations for this bill (read-only)
                loadBillAllocations(bill);
            }
        },
        allocations: {
            editable: false,
            showStillToAllocate: false,
            columnWidths: ['18%', '18%', '14%', '12%', '12%', '12%', '14%']
        },
        api: {},
        callbacks: {}
    });
    
    // Load bill allocations (read-only display)
    function loadBillAllocations(bill) {
        var allocationsTableBody = $('#billsApprovalsAllocationsTableBody');
        allocationsTableBody.empty();
        
        if (bill && bill.allocations && bill.allocations.length > 0) {
            bill.allocations.forEach(function(alloc) {
                var row = $('<tr>');
                
                // 1. Xero Account (20%)
                row.append($('<td>').text(alloc.xero_account_name || '-'));
                
                // 2. Tracking Category (20%)
                row.append($('<td>').text(alloc.tracking_category_name || '-'));
                
                // 3. Costing Item (14%)
                row.append($('<td>').text(alloc.costing_name || '-'));
                
                // 4. $ Gross (12%)
                var allocNet = parseFloat(alloc.amount) || 0;
                var allocGst = parseFloat(alloc.gst_amount) || 0;
                row.append($('<td>').text('$' + Utils.formatMoney(allocNet + allocGst)));
                
                // 5. $ Net (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.amount)));
                
                // 6. $ GST (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.gst_amount)));
                
                // 7. Notes (14%)
                row.append($('<td>').text(alloc.notes || ''));
                
                allocationsTableBody.append(row);
            });
        }
        
        // Hide allocations footer (not needed for approvals)
        $('#billsApprovalsAllocationsFooter').hide();
        
        // Apply column widths for proper alignment (tbody uses display:block for scrolling)
        Utils.applyColumnStyles('billsApprovals', ['18%', '18%', '14%', '12%', '12%', '12%', '14%'], { addEditableClass: false });
    }
    
    // Load Approved Bills data
    window.loadApprovedBills = function() {
        console.log('=== loadApprovedBills called ===');
        
        $.ajax({
            url: '{% url "core:get_approved_bills" %}',
            type: 'GET',
            success: function(response) {
                // Guard: ensure table still exists (user may have navigated away)
                if (!$('#billsApprovalsMainTableBody').length) {
                    return;
                }
                
                console.log('Approvals - API response:', response);
                console.log('Approvals - Bills count:', response.bills ? response.bills.length : 0);
                if (response.bills) {
                    response.bills.forEach(function(b) {
                        console.log('  bill_pk=' + b.bill_pk + ', status=' + b.bill_status + ', project=' + b.project_name);
                    });
                }
                
                // Store data globally
                window.billsApprovalsData = response.bills;
                
                // Populate table
                AllocationsManager.populateMainTable('billsApprovals', response.bills);
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsApprovalsMainTable');
                
                // Bind event handlers
                bindApprovalsEventHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load approved bills:', error);
                $('#billsApprovalsMainTableBody').html('<tr><td colspan="11" class="text-center text-danger">Failed to load bills</td></tr>');
            }
        });
    };
    
    // Bind event handlers for Approvals mode
    function bindApprovalsEventHandlers() {
        var ns = '.billsApprovals';
        
        // Unbind previous handlers
        $(document).off(ns);
        
        // Send to Xero button - shows PDF preview modal first
        // Note: Actual send logic is in the second script block below (confirmSendToXeroBtn handler)
        
        // Mark X button - marks as sent without actually sending to Xero
        $(document).on('click' + ns, '.approvals-mark-x-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var button = $(this);
            var billPk = button.attr('data-bill-pk');
            var row = button.closest('tr');
            
            if (confirm('Mark this bill as sent to Xero WITHOUT actually sending it?\n\nThis will update the status as if sent, but no data will be pushed to Xero.')) {
                button.prop('disabled', true).text('...');
                
                $.ajax({
                    url: '/core/mark_bill_as_sent/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    contentType: 'application/json',
                    data: JSON.stringify({ bill_pk: billPk }),
                    success: function(response) {
                        if (response.status === 'success') {
                            AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                                if (window.currentSelectedBillPk == billPk) {
                                    $('#billsApprovalsAllocationsTableBody').empty();
                                    $('#billsApprovalsPdfViewer').hide();
                                    $('#billsApprovalsViewerPlaceholder').show();
                                    window.currentSelectedBillPk = null;
                                    window.currentBillData = null;
                                }
                                
                                // Check if table is now empty
                                if ($('#billsApprovalsMainTableBody tr').length === 0) {
                                    $('#billsApprovalsMainTableBody').html('<tr><td colspan="11" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                                }
                            });
                        } else {
                            alert('Error: ' + response.message);
                            button.prop('disabled', false).text('Mark X');
                        }
                    },
                    error: function(xhr) {
                        alert('Failed to mark bill: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        button.prop('disabled', false).text('Mark X');
                    }
                });
            }
        });
        
        // Return to Project button
        $(document).on('click' + ns, '.approvals-return-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var button = $(this);
            var billPk = button.attr('data-bill-pk');
            var row = button.closest('tr');
            
            if (confirm('Return this bill to the project?')) {
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '{% url "core:return_bill_to_project" invoice_id=0 %}'.replace('0', billPk),
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    success: function(response) {
                        AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                            if (window.currentSelectedBillPk == billPk) {
                                $('#billsApprovalsAllocationsTableBody').empty();
                                $('#billsApprovalsPdfViewer').hide();
                                $('#billsApprovalsViewerPlaceholder').show();
                                window.currentSelectedBillPk = null;
                                window.currentBillData = null;
                            }
                            
                            // Check if table is now empty
                            if ($('#billsApprovalsMainTableBody tr').length === 0) {
                                $('#billsApprovalsMainTableBody').html('<tr><td colspan="11" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                            }
                        });
                    },
                    error: function(xhr) {
                        alert('Failed to return bill: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        button.prop('disabled', false).html('<i class="fas fa-undo"></i>');
                    }
                });
            }
        });
    }
    
})();
</script>

<!-- PDF Confirmation Modal -->
<style>
    #pdfConfirmModal { z-index: 1060 !important; }
    #pdfConfirmModal + .modal-backdrop { z-index: 1055 !important; }
</style>
<div class="modal fade" id="pdfConfirmModal" tabindex="-1" aria-labelledby="pdfConfirmModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-height: 90vh; margin-top: 5vh;">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h5 class="modal-title" id="pdfConfirmModalLabel">Confirm PDF Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 140px);">
                <div class="alert alert-info mb-2 py-2">
                    <strong>PDF Source:</strong> <span id="pdfSourceInfo">Loading...</span>
                </div>
                <div class="alert alert-warning mb-2 py-2" id="pdfUrlDisplay">
                    <strong>URL:</strong> <code id="pdfUrlText" style="word-break: break-all; font-size: 0.8em;"></code>
                </div>
                <div id="pdfPreviewContainer" style="height: 350px; border: 1px solid #ddd; background: #f5f5f5;">
                    <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
                    <div id="pdfPreviewError" class="text-center text-danger p-4" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Could not load PDF preview. The URL may be invalid or inaccessible.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSendToXeroBtn">
                    <i class="fas fa-check"></i> Confirm & Send to Xero
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    var pendingBillPk = null;
    var pendingButton = null;
    var pendingRow = null;
    var pdfConfirmModal = null;
    
    // Initialize modal
    $(document).ready(function() {
        var modalEl = document.getElementById('pdfConfirmModal');
        if (modalEl) {
            // Move modal to body to escape any overflow:hidden containers
            document.body.appendChild(modalEl);
            
            pdfConfirmModal = new bootstrap.Modal(modalEl, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Ensure modal gets focus when shown
            modalEl.addEventListener('shown.bs.modal', function() {
                modalEl.focus();
                $('#confirmSendToXeroBtn').focus();
            });
        }
    });
    
    // Override the send button handler to show confirmation first
    $(document).off('click.billsApprovals', '.approvals-send-btn');
    $(document).on('click.pdfConfirm', '.approvals-send-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var billPk = button.attr('data-bill-pk');
        var row = button.closest('tr');
        
        // Debug: Log bill data including dates
        console.log('=== SEND TO XERO - BUTTON CLICKED ===');
        console.log('Bill PK:', billPk);
        // Get the bill data from window.currentBillData or find from table
        var billData = null;
        if (window.billsData && window.billsData.approvals) {
            billData = window.billsData.approvals.find(function(b) { return b.bill_pk == billPk; });
        }
        if (billData) {
            console.log('Bill Data from cache:', billData);
            console.log('  bill_date (raw):', billData.bill_date);
            console.log('  bill_due_date (raw):', billData.bill_due_date);
            console.log('  bill_date type:', typeof billData.bill_date);
            console.log('  bill_due_date type:', typeof billData.bill_due_date);
        } else {
            console.log('Bill data not found in cache, will check row cells');
            var cells = row.find('td');
            console.log('  Date cell (7th):', cells.eq(6).text());
            console.log('  Due Date cell (8th):', cells.eq(7).text());
        }
        
        // Store for later
        pendingBillPk = billPk;
        pendingButton = button;
        pendingRow = row;
        
        // Fetch PDF info from backend
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/get_bill_pdf_info/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: billPk }),
            success: function(response) {
                button.prop('disabled', false).text('Send');
                
                if (response.status === 'success') {
                    // Show PDF info in modal
                    $('#pdfSourceInfo').text(response.source || 'Unknown');
                    $('#pdfUrlText').text(response.pdf_url || 'No URL');
                    
                    // Load PDF in iframe
                    var pdfUrl = response.pdf_url;
                    if (pdfUrl) {
                        $('#pdfPreviewFrame').attr('src', pdfUrl).show();
                        $('#pdfPreviewError').hide();
                        $('#pdfUrlDisplay').removeClass('alert-danger').addClass('alert-warning');
                    } else {
                        $('#pdfPreviewFrame').hide();
                        $('#pdfPreviewError').show();
                        $('#pdfUrlDisplay').removeClass('alert-warning').addClass('alert-danger');
                        $('#pdfSourceInfo').text('NO PDF FOUND - ' + (response.source || 'Unknown'));
                    }
                    
                    // Show modal
                    pdfConfirmModal.show();
                } else {
                    alert('Error getting PDF info: ' + response.message);
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).text('Send');
                alert('Failed to get PDF info: ' + (xhr.responseJSON?.message || 'Unknown error'));
            }
        });
    });
    
    // Confirm send button
    $(document).on('click', '#confirmSendToXeroBtn', function() {
        if (!pendingBillPk || !pendingButton) return;
        
        // === DEBUG: Log bill data BEFORE sending to Xero ===
        console.log('=== CONFIRM SEND TO XERO - PRE-SEND DEBUG ===');
        console.log('pendingBillPk:', pendingBillPk);
        
        // Try to find bill data from cache
        var billData = null;
        if (window.billsData && window.billsData.approvals) {
            billData = window.billsData.approvals.find(function(b) { return b.bill_pk == pendingBillPk; });
        }
        if (billData) {
            console.log('Bill Data from cache:');
            console.log('  bill_date (raw):', billData.bill_date);
            console.log('  bill_due_date (raw):', billData.bill_due_date);
            console.log('  supplier_bill_number:', billData.supplier_bill_number);
            console.log('  Full bill object:', JSON.stringify(billData, null, 2));
        } else {
            console.log('Bill data not found in window.billsData.approvals');
            // Check row cells as fallback
            if (pendingRow) {
                var cells = pendingRow.find('td');
                console.log('Row cell values:');
                console.log('  Date cell (7th):', cells.eq(6).text());
                console.log('  Due Date cell (8th):', cells.eq(7).text());
            }
        }
        console.log('Sending POST to /core/send_bill_to_xero/ with bill_pk:', pendingBillPk);
        
        var confirmBtn = $(this);
        confirmBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
        
        $.ajax({
            url: '/core/send_bill_to_xero/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: pendingBillPk }),
            success: function(response) {
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                
                // Log full response for debugging
                console.log('=== SEND TO XERO RESPONSE ===');
                console.log('Full response:', response);
                console.log('Status:', response.status);
                console.log('Message:', response.message);
                console.log('Xero Invoice ID:', response.xero_invoice_id);
                console.log('Attachment Status:', response.attachment_status);
                if (response.attachment_debug) {
                    console.log('=== ATTACHMENT DEBUG INFO ===');
                    console.log('PDF Source:', response.attachment_debug.pdf_source);
                    console.log('PDF URL:', response.attachment_debug.pdf_url);
                    console.log('Filename:', response.attachment_debug.filename);
                    console.log('Encoded Filename:', response.attachment_debug.encoded_filename);
                    console.log('Download Status:', response.attachment_debug.download_status);
                    console.log('File Size:', response.attachment_debug.file_size);
                    console.log('Content-Type Received:', response.attachment_debug.content_type_received);
                    console.log('Is Valid PDF:', response.attachment_debug.is_valid_pdf);
                    console.log('Xero Response Status:', response.attachment_debug.xero_response_status);
                    console.log('Xero Response Text:', response.attachment_debug.xero_response_text);
                    console.log('Error:', response.attachment_debug.error);
                    console.log('Exception:', response.attachment_debug.exception);
                    console.log('Full attachment_debug:', JSON.stringify(response.attachment_debug, null, 2));
                }
                
                if (response.status === 'success') {
                    // Hide modal BEFORE showing alert
                    pdfConfirmModal.hide();
                    
                    // Small delay to ensure modal is fully hidden before alert
                    setTimeout(function() {
                        var msg = 'Bill sent to Xero!';
                        if (response.attachment_status) {
                            msg += '\nAttachment status: ' + response.attachment_status;
                        }
                        alert(msg);
                    }, 100);
                    
                    AllocationsManager.showSuccessAndFadeRow(pendingButton, pendingRow, function() {
                        if (window.currentSelectedBillPk == pendingBillPk) {
                            $('#billsApprovalsAllocationsTableBody').empty();
                            $('#billsApprovalsPdfViewer').hide();
                            $('#billsApprovalsViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    });
                } else {
                    // Log the error details
                    console.log('=== SEND TO XERO ERROR ===');
                    console.log('Error message:', response.message);
                    console.log('Full response:', response);
                    
                    // Keep modal open on error so user can retry or cancel
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // Keep modal open on error so user can retry or cancel
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                var errMsg = 'Failed to send to Xero.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errMsg += '\n' + xhr.responseJSON.message;
                } else if (xhr.status) {
                    errMsg += '\nStatus: ' + xhr.status + ' ' + error;
                }
                console.error('Send to Xero error:', xhr, status, error);
                
                // Log debug info if available
                if (xhr.responseJSON && xhr.responseJSON.debug) {
                    console.log('=== XERO DEBUG INFO ===');
                    console.log('Debug data:', JSON.stringify(xhr.responseJSON.debug, null, 2));
                    errMsg += '\n\n--- Debug Info ---';
                    errMsg += '\nSupplier Bill #: ' + xhr.responseJSON.debug.supplier_bill_number;
                    errMsg += '\nBill Date (raw): ' + xhr.responseJSON.debug.bill_date_raw;
                    errMsg += '\nBill Date (sent): ' + xhr.responseJSON.debug.bill_date_formatted;
                    errMsg += '\nBill Xero ID: ' + (xhr.responseJSON.debug.bill_xero_id || 'None');
                }
                
                alert(errMsg);
            }
        });
    });
    
    // Fix: Ensure modal close buttons work after alert - more aggressive approach
    $(document).on('click', '#pdfConfirmModal .btn-close, #pdfConfirmModal .btn-secondary', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Modal close button clicked - forcing close');
        forceCloseModal();
    });
    
    // Also handle Escape key
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && $('#pdfConfirmModal').hasClass('show')) {
            console.log('Escape pressed - forcing modal close');
            forceCloseModal();
        }
    });
    
    // Force close modal function
    function forceCloseModal() {
        var modalEl = document.getElementById('pdfConfirmModal');
        if (modalEl) {
            // Try Bootstrap's hide first
            if (pdfConfirmModal) {
                try { pdfConfirmModal.hide(); } catch(e) { console.log('pdfConfirmModal.hide() error:', e); }
            }
            var bsModal = bootstrap.Modal.getInstance(modalEl);
            if (bsModal) {
                try { bsModal.hide(); } catch(e) { console.log('bsModal.hide() error:', e); }
            }
            
            // Force remove modal classes and backdrop
            $(modalEl).removeClass('show').css('display', 'none');
            $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
            $('.modal-backdrop').remove();
            
            // Reset pending state
            pendingBillPk = null;
            pendingButton = null;
            pendingRow = null;
        }
    }
    
})();

// Debug function for table column layout
window.debugApprovalsTable = function() {
    console.log('=== BILLS APPROVALS TABLE DEBUG ===');
    
    var table = document.getElementById('billsApprovalsMainTable');
    if (!table) {
        console.log('Table not found!');
        return;
    }
    
    // Colgroup columns
    var colgroup = table.querySelector('colgroup');
    var cols = colgroup ? colgroup.querySelectorAll('col') : [];
    console.log('Colgroup columns:', cols.length);
    cols.forEach(function(col, i) {
        console.log('  Col ' + i + ': width=' + col.style.width);
    });
    
    // Header columns
    var headerRow = table.querySelector('thead tr');
    var headers = headerRow ? headerRow.querySelectorAll('th') : [];
    console.log('Header columns:', headers.length);
    headers.forEach(function(th, i) {
        console.log('  TH ' + i + ': "' + th.textContent.trim() + '" width=' + th.style.width);
    });
    
    // Body rows
    var bodyRows = table.querySelectorAll('tbody tr');
    console.log('Body rows:', bodyRows.length);
    
    if (bodyRows.length > 0) {
        var firstRow = bodyRows[0];
        var cells = firstRow.querySelectorAll('td');
        console.log('First row cells:', cells.length);
        cells.forEach(function(td, i) {
            var btn = td.querySelector('button');
            var content = btn ? ('BUTTON: ' + (btn.textContent.trim() || btn.innerHTML.trim())) : td.textContent.trim().substring(0, 30);
            console.log('  TD ' + i + ': ' + content);
        });
    }
    
    // Check for Mark X button
    var markXBtns = document.querySelectorAll('.approvals-mark-x-btn');
    console.log('Mark X buttons found:', markXBtns.length);
    
    // Check for Send button
    var sendBtns = document.querySelectorAll('.approvals-send-btn');
    console.log('Send buttons found:', sendBtns.length);
    
    // Check for Return button
    var returnBtns = document.querySelectorAll('.approvals-return-btn');
    console.log('Return buttons found:', returnBtns.length);
    
    console.log('=== END DEBUG ===');
};
</script>
