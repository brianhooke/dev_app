<!-- Bills Global Approvals Section -->
<!-- Uses allocations_layout.html with read-only allocations -->
{% load static %}

{% include "core/components/allocations_layout.html" with section_id="billsApprovals" main_table_columns=main_table_columns allocations_columns=allocations_columns hide_allocations=False viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Bills Approvals Section JS -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsApprovalsMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Approvals
    AllocationsManager.init({
        sectionId: 'billsApprovals',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: true,
            confirmDelete: false,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No approved bills waiting to be sent to Xero.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // 1. Project
                var projectName = bill.project_name || '-';
                row.append($('<td>').attr('title', projectName).text(projectName));
                
                // 2. Xero Instance
                var xeroInstanceName = bill.xero_instance_name || '-';
                row.append($('<td>').attr('title', xeroInstanceName).text(xeroInstanceName));
                
                // 3. Supplier
                var supplierName = bill.supplier_name || '-';
                row.append($('<td>').attr('title', supplierName).text(supplierName));
                
                // 4. $ Gross
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gross)));
                
                // 5. $ Net
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_net)));
                
                // 6. $ GST
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gst)));
                
                // 7. Send to Xero button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-success approvals-send-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Send');
                row.append($('<td>').addClass('col-action-first').css('text-align', 'center').append(sendBtn));
                
                // 9. Return to Project button
                var returnBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning approvals-return-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .html('<i class="fas fa-undo"></i>')
                    .attr('title', 'Return to Project');
                row.append($('<td>').addClass('col-action').css('text-align', 'center').append(returnBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                
                // Find full bill data
                var bill = window.billsApprovalsData.find(function(b) {
                    return b.bill_pk === parseInt(pk);
                });
                window.currentBillData = bill;
                
                // Load allocations for this bill (read-only)
                loadBillAllocations(bill);
            }
        },
        allocations: {
            editable: false,
            showStillToAllocate: false,
            columnWidths: ['18%', '18%', '14%', '12%', '12%', '12%', '14%']
        },
        api: {},
        callbacks: {}
    });
    
    // Load bill allocations (read-only display)
    function loadBillAllocations(bill) {
        var allocationsTableBody = $('#billsApprovalsAllocationsTableBody');
        allocationsTableBody.empty();
        
        if (bill && bill.allocations && bill.allocations.length > 0) {
            bill.allocations.forEach(function(alloc) {
                var row = $('<tr>');
                
                // 1. Xero Account (20%)
                row.append($('<td>').text(alloc.xero_account_name || '-'));
                
                // 2. Tracking Category (20%)
                row.append($('<td>').text(alloc.tracking_category_name || '-'));
                
                // 3. Costing Item (14%)
                row.append($('<td>').text(alloc.costing_name || '-'));
                
                // 4. $ Gross (12%)
                var allocNet = parseFloat(alloc.amount) || 0;
                var allocGst = parseFloat(alloc.gst_amount) || 0;
                row.append($('<td>').text('$' + Utils.formatMoney(allocNet + allocGst)));
                
                // 5. $ Net (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.amount)));
                
                // 6. $ GST (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.gst_amount)));
                
                // 7. Notes (14%)
                row.append($('<td>').text(alloc.notes || ''));
                
                allocationsTableBody.append(row);
            });
        }
        
        // Hide allocations footer (not needed for approvals)
        $('#billsApprovalsAllocationsFooter').hide();
        
        // Apply column widths for proper alignment (tbody uses display:block for scrolling)
        Utils.applyColumnStyles('billsApprovals', ['18%', '18%', '14%', '12%', '12%', '12%', '14%'], { addEditableClass: false });
    }
    
    // Load Approved Bills data
    window.loadApprovedBills = function() {
        console.log('=== loadApprovedBills called ===');
        
        $.ajax({
            url: '{% url "core:get_approved_bills" %}',
            type: 'GET',
            success: function(response) {
                // Guard: ensure table still exists (user may have navigated away)
                if (!$('#billsApprovalsMainTableBody').length) {
                    return;
                }
                
                console.log('Approvals - API response:', response);
                console.log('Approvals - Bills count:', response.bills ? response.bills.length : 0);
                if (response.bills) {
                    response.bills.forEach(function(b) {
                        console.log('  bill_pk=' + b.bill_pk + ', status=' + b.bill_status + ', project=' + b.project_name);
                    });
                }
                
                // Store data globally
                window.billsApprovalsData = response.bills;
                
                // Populate table
                AllocationsManager.populateMainTable('billsApprovals', response.bills);
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsApprovalsMainTable');
                
                // Bind event handlers
                bindApprovalsEventHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load approved bills:', error);
                $('#billsApprovalsMainTableBody').html('<tr><td colspan="9" class="text-center text-danger">Failed to load bills</td></tr>');
            }
        });
    };
    
    // Bind event handlers for Approvals mode
    function bindApprovalsEventHandlers() {
        var ns = '.billsApprovals';
        
        // Unbind previous handlers
        $(document).off(ns);
        
        // Send to Xero button - shows PDF preview modal first
        // Note: Actual send logic is in the second script block below (confirmSendToXeroBtn handler)
        
        // Return to Project button
        $(document).on('click' + ns, '.approvals-return-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var button = $(this);
            var billPk = button.attr('data-bill-pk');
            var row = button.closest('tr');
            
            if (confirm('Return this bill to the project?')) {
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '{% url "core:return_bill_to_project" invoice_id=0 %}'.replace('0', billPk),
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    success: function(response) {
                        AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                            if (window.currentSelectedBillPk == billPk) {
                                $('#billsApprovalsAllocationsTableBody').empty();
                                $('#billsApprovalsPdfViewer').hide();
                                $('#billsApprovalsViewerPlaceholder').show();
                                window.currentSelectedBillPk = null;
                                window.currentBillData = null;
                            }
                            
                            // Check if table is now empty
                            if ($('#billsApprovalsMainTableBody tr').length === 0) {
                                $('#billsApprovalsMainTableBody').html('<tr><td colspan="9" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                            }
                        });
                    },
                    error: function(xhr) {
                        alert('Failed to return bill: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        button.prop('disabled', false).html('<i class="fas fa-undo"></i>');
                    }
                });
            }
        });
    }
    
})();
</script>

<!-- PDF Confirmation Modal -->
<style>
    #pdfConfirmModal { z-index: 1060 !important; }
    #pdfConfirmModal + .modal-backdrop { z-index: 1055 !important; }
</style>
<div class="modal fade" id="pdfConfirmModal" tabindex="-1" aria-labelledby="pdfConfirmModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-height: 90vh; margin-top: 5vh;">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h5 class="modal-title" id="pdfConfirmModalLabel">Confirm PDF Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 140px);">
                <div class="alert alert-info mb-2 py-2">
                    <strong>PDF Source:</strong> <span id="pdfSourceInfo">Loading...</span>
                </div>
                <div class="alert alert-warning mb-2 py-2" id="pdfUrlDisplay">
                    <strong>URL:</strong> <code id="pdfUrlText" style="word-break: break-all; font-size: 0.8em;"></code>
                </div>
                <div id="pdfPreviewContainer" style="height: 350px; border: 1px solid #ddd; background: #f5f5f5;">
                    <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
                    <div id="pdfPreviewError" class="text-center text-danger p-4" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Could not load PDF preview. The URL may be invalid or inaccessible.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSendToXeroBtn">
                    <i class="fas fa-check"></i> Confirm & Send to Xero
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    var pendingBillPk = null;
    var pendingButton = null;
    var pendingRow = null;
    var pdfConfirmModal = null;
    
    // Initialize modal
    $(document).ready(function() {
        var modalEl = document.getElementById('pdfConfirmModal');
        if (modalEl) {
            // Move modal to body to escape any overflow:hidden containers
            document.body.appendChild(modalEl);
            
            pdfConfirmModal = new bootstrap.Modal(modalEl, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Ensure modal gets focus when shown
            modalEl.addEventListener('shown.bs.modal', function() {
                modalEl.focus();
                $('#confirmSendToXeroBtn').focus();
            });
        }
    });
    
    // Override the send button handler to show confirmation first
    $(document).off('click.billsApprovals', '.approvals-send-btn');
    $(document).on('click.pdfConfirm', '.approvals-send-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var billPk = button.attr('data-bill-pk');
        var row = button.closest('tr');
        
        // Store for later
        pendingBillPk = billPk;
        pendingButton = button;
        pendingRow = row;
        
        // Fetch PDF info from backend
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/get_bill_pdf_info/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: billPk }),
            success: function(response) {
                button.prop('disabled', false).text('Send');
                
                if (response.status === 'success') {
                    // Show PDF info in modal
                    $('#pdfSourceInfo').text(response.source || 'Unknown');
                    $('#pdfUrlText').text(response.pdf_url || 'No URL');
                    
                    // Load PDF in iframe
                    var pdfUrl = response.pdf_url;
                    if (pdfUrl) {
                        $('#pdfPreviewFrame').attr('src', pdfUrl).show();
                        $('#pdfPreviewError').hide();
                        $('#pdfUrlDisplay').removeClass('alert-danger').addClass('alert-warning');
                    } else {
                        $('#pdfPreviewFrame').hide();
                        $('#pdfPreviewError').show();
                        $('#pdfUrlDisplay').removeClass('alert-warning').addClass('alert-danger');
                        $('#pdfSourceInfo').text('NO PDF FOUND - ' + (response.source || 'Unknown'));
                    }
                    
                    // Show modal
                    pdfConfirmModal.show();
                } else {
                    alert('Error getting PDF info: ' + response.message);
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).text('Send');
                alert('Failed to get PDF info: ' + (xhr.responseJSON?.message || 'Unknown error'));
            }
        });
    });
    
    // Confirm send button
    $(document).on('click', '#confirmSendToXeroBtn', function() {
        if (!pendingBillPk || !pendingButton) return;
        
        var confirmBtn = $(this);
        confirmBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
        
        $.ajax({
            url: '/core/send_bill_to_xero/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: pendingBillPk }),
            success: function(response) {
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                
                // Log full response for debugging
                console.log('=== SEND TO XERO RESPONSE ===');
                console.log('Full response:', response);
                console.log('Status:', response.status);
                console.log('Message:', response.message);
                console.log('Xero Invoice ID:', response.xero_invoice_id);
                console.log('Attachment Status:', response.attachment_status);
                if (response.attachment_debug) {
                    console.log('=== ATTACHMENT DEBUG INFO ===');
                    console.log('PDF Source:', response.attachment_debug.pdf_source);
                    console.log('PDF URL:', response.attachment_debug.pdf_url);
                    console.log('Filename:', response.attachment_debug.filename);
                    console.log('Encoded Filename:', response.attachment_debug.encoded_filename);
                    console.log('Download Status:', response.attachment_debug.download_status);
                    console.log('File Size:', response.attachment_debug.file_size);
                    console.log('Content-Type Received:', response.attachment_debug.content_type_received);
                    console.log('Is Valid PDF:', response.attachment_debug.is_valid_pdf);
                    console.log('Xero Response Status:', response.attachment_debug.xero_response_status);
                    console.log('Xero Response Text:', response.attachment_debug.xero_response_text);
                    console.log('Error:', response.attachment_debug.error);
                    console.log('Exception:', response.attachment_debug.exception);
                    console.log('Full attachment_debug:', JSON.stringify(response.attachment_debug, null, 2));
                }
                
                if (response.status === 'success') {
                    pdfConfirmModal.hide();
                    // Show attachment status
                    var msg = 'Bill sent to Xero!';
                    if (response.attachment_status) {
                        msg += '\nAttachment status: ' + response.attachment_status;
                    }
                    alert(msg);
                    
                    AllocationsManager.showSuccessAndFadeRow(pendingButton, pendingRow, function() {
                        if (window.currentSelectedBillPk == pendingBillPk) {
                            $('#billsApprovalsAllocationsTableBody').empty();
                            $('#billsApprovalsPdfViewer').hide();
                            $('#billsApprovalsViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    });
                } else {
                    // Keep modal open on error so user can retry or cancel
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // Keep modal open on error so user can retry or cancel
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                var errMsg = 'Failed to send to Xero.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errMsg += '\n' + xhr.responseJSON.message;
                } else if (xhr.status) {
                    errMsg += '\nStatus: ' + xhr.status + ' ' + error;
                }
                console.error('Send to Xero error:', xhr, status, error);
                alert(errMsg);
            }
        });
    });
    
})();
</script>
