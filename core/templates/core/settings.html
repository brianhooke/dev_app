<!-- Settings Section -->
<div id="settingsSection" style="display: none; flex-direction: column; height: 100%;">

<style>
    /* Settings table styling */
    .settings-container .project-type-cell,
    .settings-container .xero-instance-cell,
    .settings-container .rates-based-cell {
        cursor: pointer;
    }
    
    .settings-container .project-type-cell:hover,
    .settings-container .xero-instance-cell:hover,
    .settings-container .rates-based-cell:hover {
        background-color: var(--color-bg-muted);
    }
    
    .settings-container .project-type-display {
        display: inline-block;
        padding: 2px 8px;
        min-height: 1.5em;
    }
    
    .settings-container .project-type-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-size: inherit;
        box-sizing: border-box;
    }
    
    .settings-container .xero-instance-display {
        display: inline-block;
        padding: 2px 8px;
        min-height: 1.5em;
        min-width: 100px;
    }
    
    .settings-container .xero-instance-display.not-set {
        color: var(--color-text-muted);
        font-style: italic;
    }
    
    .settings-container .xero-instance-select {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-size: inherit;
    }
    
    .settings-container .rates-based-display {
        display: inline-block;
        padding: 2px 8px;
        min-height: 1.5em;
        min-width: 50px;
    }
    
    .settings-container .rates-based-select {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-size: inherit;
    }
    
    /* Input row styling */
    .settings-container .input-row input[type="text"],
    .settings-container .input-row select {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-size: inherit;
        box-sizing: border-box;
    }
    
    .settings-container .add-btn {
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .settings-container .add-btn.disabled {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    
    .settings-container .add-btn.enabled {
        background-color: #28a745;
        color: white;
    }
    
    .settings-container .add-btn.enabled:hover {
        background-color: #218838;
    }
    
    .settings-container .archive-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        color: #dc3545;
    }
    
    .settings-container .archive-btn:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .settings-container .archive-btn.restore {
        color: #28a745;
    }
    
    .settings-container .archive-btn.restore:hover {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    </style>

<div class="settings-container" style="height: 100%; display: flex; flex-direction: column;">
    <div style="display: flex; flex: 1; overflow: hidden;">
        <!-- Left side: Main Table -->
        <div class="settings-left-panel" style="width: 100%; display: flex; flex-direction: column; height: 100%; gap: 12px; padding: 12px 0 6px 0;">
            <!-- Main Table Container -->
            <div class="settings-table-container reusable-table-container" style="flex: 0 0 auto; display: flex; flex-direction: column; overflow: hidden;">
                <div id="settingsTableContainer" style="overflow-y: auto;">
                    <table id="settingsMainTable" class="reusable-table">
                        <thead>
                            <tr>
                                <th style="width: 30%; text-align: left;">Project Type</th>
                                <th style="width: 30%; text-align: left;">Xero Instance</th>
                                <th style="width: 15%; text-align: left;">Rates Based</th>
                                <th style="width: 10%; text-align: center;">Add</th>
                                <th style="width: 15%; text-align: center;">Archive</th>
                            </tr>
                            <tr class="input-row">
                                <td>
                                    <input type="text" id="newProjectTypeInput" maxlength="50" placeholder="Enter project type name">
                                </td>
                                <td>
                                    <select id="newXeroInstanceSelect">
                                        <option value="">-- Select Xero Instance --</option>
                                    </select>
                                </td>
                                <td>
                                    <select id="newRatesBasedSelect">
                                        <option value="">-- Select --</option>
                                        <option value="1">Yes</option>
                                        <option value="0">No</option>
                                    </select>
                                </td>
                                <td style="text-align: center;">
                                    <button id="addProjectTypeBtn" class="add-btn disabled" disabled>Add</button>
                                </td>
                                <td></td>
                            </tr>
                        </thead>
                        <tbody id="settingsMainTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 40px; color: var(--color-text-muted);">
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Footer with toggle button - fixed at bottom -->
    <div id="settingsFooter" style="display: flex; justify-content: flex-start; align-items: center; margin-top: 15px; flex-shrink: 0; padding-top: 15px; border-top: 1px solid #e9ecef;">
        <button id="toggleArchivedBtn" class="btn btn-outline-secondary btn-sm" data-showing-archived="0">
            <i class="fas fa-archive"></i> Show Archived
        </button>
    </div>
</div>

<script>
$(document).ready(function() {
    var xeroInstances = [];
    
    // ============================================
    // LOAD SETTINGS TABLE
    // ============================================
    window.loadSettingsTable = function(showArchived) {
        const tbody = $('#settingsMainTableBody');
        const archived = showArchived ? '1' : '0';
        
        // Load Xero instances first, then project types
        Promise.all([
            $.ajax({ url: '/core/get_xero_instances_list/', type: 'GET' }),
            $.ajax({ url: '/core/get_project_types/', type: 'GET', data: { archived: archived } })
        ]).then(function(results) {
            xeroInstances = results[0].xero_instances || [];
            var projectTypes = results[1].project_types || [];
            
            // Populate the input row's Xero Instance dropdown
            var $inputSelect = $('#newXeroInstanceSelect');
            $inputSelect.empty().append('<option value="">-- Select Xero Instance --</option>');
            xeroInstances.forEach(function(instance) {
                $inputSelect.append('<option value="' + instance.xero_instance_pk + '">' + Utils.escapeHtml(instance.xero_name) + '</option>');
            });
            
            tbody.empty();
            
            if (projectTypes.length === 0) {
                var message = showArchived ? 'No archived project types found.' : 'No project types found.';
                tbody.html('<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--color-text-muted);">' + message + '</td></tr>');
                return;
            }
            
            projectTypes.forEach(function(pt) {
                var row = $('<tr></tr>');
                row.attr('data-project-type-pk', pt.project_type_pk);
                
                // Project Type column - clickable
                var ptCell = $('<td class="project-type-cell"></td>');
                var ptDisplay = $('<span class="project-type-display"></span>')
                    .text(pt.project_type)
                    .attr('data-project-type-pk', pt.project_type_pk);
                ptCell.append(ptDisplay);
                row.append(ptCell);
                
                // Xero Instance column - clickable
                var xeroCell = $('<td class="xero-instance-cell"></td>');
                var displayText = pt.xero_instance_name || 'Not set';
                var displayClass = pt.xero_instance_name ? '' : 'not-set';
                var display = $('<span class="xero-instance-display ' + displayClass + '"></span>')
                    .text(displayText)
                    .attr('data-project-type-pk', pt.project_type_pk)
                    .attr('data-xero-instance-pk', pt.xero_instance_pk || '');
                
                xeroCell.append(display);
                row.append(xeroCell);
                
                // Rates Based column - clickable
                var ratesCell = $('<td class="rates-based-cell"></td>');
                var ratesDisplayText = pt.rates_based === 1 ? 'Yes' : 'No';
                var ratesDisplay = $('<span class="rates-based-display"></span>')
                    .text(ratesDisplayText)
                    .attr('data-project-type-pk', pt.project_type_pk)
                    .attr('data-rates-based', pt.rates_based || 0);
                ratesCell.append(ratesDisplay);
                row.append(ratesCell);
                
                // Empty cell for Add column
                row.append('<td></td>');
                
                // Archive button column
                var archiveCell = $('<td style="text-align: center;"></td>');
                var isArchived = pt.archived === 1;
                var btnClass = isArchived ? 'archive-btn restore' : 'archive-btn';
                var iconClass = isArchived ? 'fa-box-open' : 'fa-archive';
                var btnTitle = isArchived ? 'Restore' : 'Archive';
                var archiveBtn = $('<button class="' + btnClass + '" title="' + btnTitle + '"><i class="fas ' + iconClass + '"></i></button>')
                    .attr('data-project-type-pk', pt.project_type_pk)
                    .attr('data-archived', pt.archived);
                archiveCell.append(archiveBtn);
                row.append(archiveCell);
                
                tbody.append(row);
            });
        }).catch(function(error) {
            console.error('Error loading settings:', error);
            tbody.html('<tr><td colspan="3" style="text-align: center; color: #dc3545; padding: 20px;">Error loading data</td></tr>');
        });
    };
    
    // ============================================
    // INPUT VALIDATION FOR ADD BUTTON
    // ============================================
    function validateAddButton() {
        var projectType = $('#newProjectTypeInput').val().trim();
        var xeroInstance = $('#newXeroInstanceSelect').val();
        var ratesBased = $('#newRatesBasedSelect').val();
        
        if (projectType && xeroInstance && ratesBased !== '') {
            $('#addProjectTypeBtn').removeClass('disabled').addClass('enabled').prop('disabled', false);
        } else {
            $('#addProjectTypeBtn').removeClass('enabled').addClass('disabled').prop('disabled', true);
        }
    }
    
    $('#newProjectTypeInput').on('input', validateAddButton);
    $('#newXeroInstanceSelect').on('change', validateAddButton);
    $('#newRatesBasedSelect').on('change', validateAddButton);
    
    // ============================================
    // ADD PROJECT TYPE
    // ============================================
    $('#addProjectTypeBtn').on('click', function() {
        if ($(this).hasClass('disabled')) return;
        
        var projectType = $('#newProjectTypeInput').val().trim();
        var xeroInstancePk = $('#newXeroInstanceSelect').val();
        var ratesBased = $('#newRatesBasedSelect').val();
        
        if (!projectType || !xeroInstancePk || ratesBased === '') {
            alert('Please enter a project type, select a Xero instance, and select Rates Based.');
            return;
        }
        
        // Check max length
        if (projectType.length > 50) {
            alert('Project type name must be 50 characters or less.');
            return;
        }
        
        $.ajax({
            url: '/core/create_project_type/',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            data: JSON.stringify({
                project_type: projectType,
                xero_instance_pk: xeroInstancePk,
                rates_based: parseInt(ratesBased)
            }),
            success: function(response) {
                if (response.status === 'success') {
                    // Clear inputs
                    $('#newProjectTypeInput').val('');
                    $('#newXeroInstanceSelect').val('');
                    $('#newRatesBasedSelect').val('');
                    $('#addProjectTypeBtn').removeClass('enabled').addClass('disabled').prop('disabled', true);
                    
                    // Reload table
                    loadSettingsTable();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                var message = 'Error creating project type';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert(message);
            }
        });
    });
    
    // ============================================
    // CLICK TO EDIT PROJECT TYPE NAME
    // ============================================
    $(document).on('click', '.project-type-display', function(e) {
        var $display = $(this);
        var $cell = $display.parent();
        var projectTypePk = $display.attr('data-project-type-pk');
        var currentName = $display.text();
        
        // Don't convert if already an input
        if ($cell.find('input').length > 0) return;
        
        // Create input field
        var $input = $('<input type="text" class="project-type-input" maxlength="50">')
            .val(currentName)
            .attr('data-project-type-pk', projectTypePk)
            .attr('data-original-value', currentName);
        
        // Replace display with input
        $cell.empty().append($input);
        $input.focus().select();
    });
    
    // ============================================
    // SAVE PROJECT TYPE NAME ON BLUR/ENTER
    // ============================================
    $(document).on('blur', '.project-type-input', function(e) {
        saveProjectTypeName($(this));
    });
    
    $(document).on('keydown', '.project-type-input', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $(this).blur();
        } else if (e.key === 'Escape') {
            // Revert to original value
            var $input = $(this);
            var originalValue = $input.attr('data-original-value');
            var projectTypePk = $input.attr('data-project-type-pk');
            var $cell = $input.parent();
            
            var $display = $('<span class="project-type-display"></span>')
                .text(originalValue)
                .attr('data-project-type-pk', projectTypePk);
            $cell.empty().append($display);
        }
    });
    
    function saveProjectTypeName($input) {
        var $cell = $input.parent();
        var projectTypePk = $input.attr('data-project-type-pk');
        var newName = $input.val().trim();
        var originalValue = $input.attr('data-original-value');
        
        // Prevent double-firing
        if ($input.data('saving')) return;
        
        // Validate - cannot be empty
        if (!newName) {
            alert('Project type name cannot be empty.');
            $input.val(originalValue).focus();
            return;
        }
        
        // If unchanged, just revert to display
        if (newName === originalValue) {
            var $display = $('<span class="project-type-display"></span>')
                .text(originalValue)
                .attr('data-project-type-pk', projectTypePk);
            $cell.empty().append($display);
            return;
        }
        
        $input.data('saving', true);
        
        // Save to backend
        $.ajax({
            url: '/core/update_project_type_name/' + projectTypePk + '/',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            data: JSON.stringify({ project_type: newName }),
            success: function(response) {
                if (response.status === 'success') {
                    var $display = $('<span class="project-type-display"></span>')
                        .text(response.project_type)
                        .attr('data-project-type-pk', projectTypePk);
                    $cell.empty().append($display);
                } else {
                    alert('Error: ' + response.message);
                    $input.data('saving', false);
                    $input.val(originalValue).focus();
                }
            },
            error: function(xhr, status, error) {
                var message = 'Error updating project type name';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert(message);
                $input.data('saving', false);
                $input.val(originalValue).focus();
            }
        });
    }
    
    // ============================================
    // CLICK TO EDIT XERO INSTANCE
    // ============================================
    $(document).on('click', '.xero-instance-display', function(e) {
        var $display = $(this);
        var $cell = $display.parent();
        var projectTypePk = $display.attr('data-project-type-pk');
        var currentXeroInstancePk = $display.attr('data-xero-instance-pk');
        
        // Don't convert if already a select
        if ($cell.find('select').length > 0) return;
        
        // Create select dropdown
        var $select = $('<select class="xero-instance-select"></select>')
            .attr('data-project-type-pk', projectTypePk);
        
        // Add empty option
        $select.append('<option value="">-- None --</option>');
        
        // Add Xero instance options
        xeroInstances.forEach(function(instance) {
            var selected = (instance.xero_instance_pk == currentXeroInstancePk) ? ' selected' : '';
            $select.append('<option value="' + instance.xero_instance_pk + '"' + selected + '>' + Utils.escapeHtml(instance.xero_name) + '</option>');
        });
        
        // Replace display with select
        $cell.empty().append($select);
        $select.focus();
    });
    
    // ============================================
    // SAVE XERO INSTANCE ON CHANGE/BLUR
    // ============================================
    $(document).on('change blur', '.xero-instance-select', function(e) {
        var $select = $(this);
        var $cell = $select.parent();
        var projectTypePk = $select.attr('data-project-type-pk');
        var xeroInstancePk = $select.val();
        
        // Prevent double-firing
        if ($select.data('saving')) return;
        $select.data('saving', true);
        
        // Save to backend
        $.ajax({
            url: '/core/update_project_type_xero_instance/' + projectTypePk + '/',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            data: JSON.stringify({ xero_instance_pk: xeroInstancePk || null }),
            success: function(response) {
                if (response.status === 'success') {
                    // Replace select with display
                    var displayText = response.xero_instance_name || 'Not set';
                    var displayClass = response.xero_instance_name ? '' : 'not-set';
                    var $display = $('<span class="xero-instance-display ' + displayClass + '"></span>')
                        .text(displayText)
                        .attr('data-project-type-pk', projectTypePk)
                        .attr('data-xero-instance-pk', response.xero_instance_pk || '');
                    
                    $cell.empty().append($display);
                } else {
                    alert('Error: ' + response.message);
                    $select.data('saving', false);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating Xero instance:', error);
                alert('Error updating Xero instance');
                $select.data('saving', false);
            }
        });
    });
    
    // ============================================
    // CLICK TO EDIT RATES BASED
    // ============================================
    $(document).on('click', '.rates-based-display', function(e) {
        var $display = $(this);
        var $cell = $display.parent();
        var projectTypePk = $display.attr('data-project-type-pk');
        var currentRatesBased = $display.attr('data-rates-based');
        
        // Don't convert if already a select
        if ($cell.find('select').length > 0) return;
        
        // Create select dropdown
        var $select = $('<select class="rates-based-select"></select>')
            .attr('data-project-type-pk', projectTypePk);
        
        // Add options
        $select.append('<option value="1"' + (currentRatesBased == '1' ? ' selected' : '') + '>Yes</option>');
        $select.append('<option value="0"' + (currentRatesBased == '0' ? ' selected' : '') + '>No</option>');
        
        $cell.empty().append($select);
        $select.focus();
    });
    
    // ============================================
    // SAVE RATES BASED ON CHANGE/BLUR
    // ============================================
    $(document).on('change blur', '.rates-based-select', function(e) {
        var $select = $(this);
        var $cell = $select.parent();
        var projectTypePk = $select.attr('data-project-type-pk');
        var ratesBased = parseInt($select.val());
        
        // Prevent double-firing
        if ($select.data('saving')) return;
        $select.data('saving', true);
        
        // Save to backend
        $.ajax({
            url: '/core/update_project_type_rates_based/' + projectTypePk + '/',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            data: JSON.stringify({ rates_based: ratesBased }),
            success: function(response) {
                if (response.status === 'success') {
                    // Replace select with display
                    var displayText = response.rates_based === 1 ? 'Yes' : 'No';
                    var $display = $('<span class="rates-based-display"></span>')
                        .text(displayText)
                        .attr('data-project-type-pk', projectTypePk)
                        .attr('data-rates-based', response.rates_based);
                    
                    $cell.empty().append($display);
                } else {
                    alert('Error: ' + response.message);
                    $select.data('saving', false);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating rates based:', error);
                alert('Error updating rates based');
                $select.data('saving', false);
            }
        });
    });
    
    // ============================================
    // TOGGLE ARCHIVED BUTTON
    // ============================================
    $('#toggleArchivedBtn').click(function() {
        const currentlyShowingArchived = $(this).data('showing-archived') === 1;
        const newShowingArchived = !currentlyShowingArchived;
        
        // Update button state
        $(this).data('showing-archived', newShowingArchived ? 1 : 0);
        
        if (newShowingArchived) {
            $(this).html('<i class="fas fa-list"></i> Show Active');
        } else {
            $(this).html('<i class="fas fa-archive"></i> Show Archived');
        }
        
        // Load project types with new filter
        loadSettingsTable(newShowingArchived);
    });
    
    // ============================================
    // ARCHIVE PROJECT TYPE BUTTON
    // ============================================
    $(document).on('click', '.archive-btn', function(e) {
        e.stopPropagation();
        
        var $btn = $(this);
        var projectTypePk = $btn.attr('data-project-type-pk');
        var isCurrentlyArchived = parseInt($btn.attr('data-archived')) === 1;
        var action = isCurrentlyArchived ? 'restore' : 'archive';
        var row = $btn.closest('tr');
        var projectTypeName = row.find('.project-type-display').text() || row.find('.project-type-input').val();
        
        if (!confirm('Are you sure you want to ' + action + ' "' + projectTypeName + '"?')) {
            return;
        }
        
        $.ajax({
            url: '/core/toggle_project_type_archive/' + projectTypePk + '/',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            data: JSON.stringify({ archived: isCurrentlyArchived ? 0 : 1 }),
            success: function(response) {
                if (response.status === 'success') {
                    // Reload the current view
                    var showingArchived = $('#toggleArchivedBtn').data('showing-archived') === 1;
                    loadSettingsTable(showingArchived);
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                var message = 'Error ' + action + 'ing project type';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert(message);
            }
        });
    });
    
    // Initialize sortable table
    Utils.initSortableTable('settingsMainTable', { tbodyId: 'settingsMainTableBody' });
});
</script>
</div> <!-- End Settings Section -->
