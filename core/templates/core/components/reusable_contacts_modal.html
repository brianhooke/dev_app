{% load static %}

<!-- Base Contacts Modal -->
<div class="modal fade" id="contactsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 800px;">
        <div class="modal-content" style="border: 3px solid black;">
            <div class="modal-header" style="text-align: center; background: var(--gradient-primary-45deg);">
                <h5 class="modal-title">Contacts</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: calc(100vh - 210px); overflow-y: auto; overflow-x: hidden; position: relative;">
                {% block contacts_modal_body %}
                {% include 'core/components/reusable_table.html' with columns=contacts_columns rows=contacts_rows show_totals=False %}
                {% endblock %}
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                {% block contacts_modal_footer %}
                <div>
                    <button type="button" class="btn btn-info" id="pullXeroContactsBtn">Pull/Update Xero Contacts</button>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" id="addContactBtn">Add Contact</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
                {% endblock %}
            </div>
        </div>
    </div>
</div>

<script>
// Validation function for contact fields (global scope for reuse)
function validateContactFields(row, options = {}) {
        const requireName = options.requireName || false;
        const requireEmail = options.requireEmail || false;
        
        // Get input values
        const nameInput = row.find('.name-input');
        const emailInput = row.find('.email-input');
        const bsbInput = row.find('.bsb-input');
        const accountInput = row.find('.account-input');
        const abnInput = row.find('.abn-input');
        
        const name = nameInput.val() ? nameInput.val().trim() : '';
        const email = emailInput.val() ? emailInput.val().trim() : '';
        const bsb = bsbInput.val() || '';
        const account = accountInput.val() || '';
        const abn = abnInput.val() || '';
        
        // Extract digits only
        const bsbDigits = bsb.replace(/[^0-9]/g, '');
        const accountDigits = account.replace(/[^0-9]/g, '');
        const abnDigits = abn.replace(/[^0-9]/g, '');
        
        // Name validation (for add only)
        if (requireName && !name) {
            return {
                valid: false,
                message: 'Name is required',
                focusElement: nameInput
            };
        }
        
        // Email required validation (for add only)
        if (requireEmail && !email) {
            return {
                valid: false,
                message: 'Email is required',
                focusElement: emailInput
            };
        }
        
        // Email format validation (if email is provided)
        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return {
                    valid: false,
                    message: 'Please enter a valid email address',
                    focusElement: emailInput
                };
            }
        }
        
        // BSB and Account validation - both must be filled together
        if ((bsbDigits || accountDigits) && !(bsbDigits && accountDigits)) {
            return {
                valid: false,
                message: 'Both BSB and Account Number must be filled in together',
                focusElement: null
            };
        }
        
        // BSB length validation
        if (bsbDigits && bsbDigits.length !== 6) {
            return {
                valid: false,
                message: 'BSB must have exactly 6 digits',
                focusElement: bsbInput
            };
        }
        
        // Account number length validation
        if (accountDigits && accountDigits.length < 6) {
            return {
                valid: false,
                message: 'Account number must have at least 6 digits',
                focusElement: accountInput
            };
        }
        
        // ABN length validation
        if (abnDigits && abnDigits.length !== 11) {
            return {
                valid: false,
                message: 'ABN must have exactly 11 digits',
                focusElement: abnInput
            };
        }
        
        // All validations passed
        return {
            valid: true,
            values: {
                name: name,
                email: email,
                bsbDigits: bsbDigits,
                accountDigits: accountDigits,
                abnDigits: abnDigits
            }
        };
}

$(document).ready(function() {
    // Load contacts function
    window.loadContacts = function(instancePk) {
        if (!instancePk) {
            const tbody = $('#contactsSection:visible tbody, #contactsModal tbody');
            tbody.html(`<tr><td colspan="7" style="text-align: center;">Please select a Xero instance</td></tr>`);
            return;
        }
        
        fetch(`/get_contacts_by_instance/${instancePk}/`)
            .then(response => response.json())
            .then(contacts => {
                // Target either workspace contacts table or modal contacts table
                const tbody = $('#contactsSection:visible tbody, #contactsModal tbody');
                tbody.empty();
                
                if (contacts.length === 0) {
                    tbody.html(`<tr><td colspan="7" style="text-align: center;">No contacts found. Click "Pull Xero Contacts" to import.</td></tr>`);
                } else {
                    contacts.forEach(contact => {
                        // Create row element and attach data using jQuery
                        let row = $(`<tr data-contact-pk="${contact.contact_pk}"></tr>`);
                        row.data('contact', contact);
                        
                        // Format BSB as XXX-XXX
                        let formattedBsb = '';
                        if (contact.bank_bsb && contact.bank_bsb.length === 6) {
                            formattedBsb = contact.bank_bsb.substring(0, 3) + '-' + contact.bank_bsb.substring(3);
                        } else {
                            formattedBsb = contact.bank_bsb || '';
                        }
                        
                        // Format ABN as XX XXX XXX XXX
                        let formattedAbn = '';
                        if (contact.tax_number) {
                            const abn = contact.tax_number.replace(/\s/g, '');
                            if (abn.length === 11) {
                                formattedAbn = abn.substring(0, 2) + ' ' + abn.substring(2, 5) + ' ' + abn.substring(5, 8) + ' ' + abn.substring(8);
                            } else {
                                formattedAbn = contact.tax_number;
                            }
                        }
                        
                        // Add verified badge based on status
                        let verifiedBadge = '';
                        if (contact.verified === 1) {
                            verifiedBadge = ' <span class="badge badge-success verified-badge" style="font-size: 0.7em;">✓ Verified</span>';
                        } else if (contact.verified === 2) {
                            verifiedBadge = ' <span class="badge badge-danger verified-badge" style="font-size: 0.7em;">✗ Details Changed</span>';
                        }
                        
                        row.append(`
                            <td class="contact-name">${contact.name || ''}${verifiedBadge}</td>
                            <td class="contact-email">${contact.email || ''}</td>
                            <td class="contact-bsb" style="white-space: nowrap;" data-bsb="${contact.bank_bsb || ''}">${formattedBsb}</td>
                            <td class="contact-account" data-account="${contact.bank_account_number || ''}">${contact.bank_account_number || ''}</td>
                            <td class="contact-abn" style="white-space: nowrap;" data-abn="${contact.tax_number || ''}">${formattedAbn}</td>
                            <td><button class="btn btn-sm btn-info verify-contact-btn">Verify</button></td>
                            <td><button class="btn btn-sm btn-primary update-contact-btn">Update</button></td>
                        `);
                        
                        tbody.append(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading contacts:', error);
                const tbody = $('#contactsSection:visible tbody, #contactsModal tbody');
                tbody.html(`<tr><td colspan="7" style="text-align: center; color: red;">Error loading contacts</td></tr>`);
            });
    };
    
    // Load contacts when modal is shown
    $('#contactsModal').on('shown.bs.modal', function() {
        const instancePk = $('#xeroInstanceSelect').val();
        loadContacts(instancePk);
        
        // Debug scrolling
        setTimeout(() => {
            const modalBody = $('#contactsModal .modal-body');
            const table = $('#contactsModal .reusable-table');
            const tbody = $('#contactsModal tbody');
            console.log('=== CONTACTS MODAL DEBUG ===');
            console.log('Modal Body Height:', modalBody.height());
            console.log('Modal Body Scroll Height:', modalBody[0].scrollHeight);
            console.log('Modal Body Overflow-Y:', modalBody.css('overflow-y'));
            console.log('Modal Body Max-Height:', modalBody.css('max-height'));
            console.log('Table Height:', table.height());
            console.log('TBody Height:', tbody.height());
            console.log('TBody Row Count:', tbody.find('tr').length);
            console.log('Can Scroll:', modalBody[0].scrollHeight > modalBody.height());
            console.log('Modal Body scrollTop:', modalBody[0].scrollTop);
            console.log('Modal Body clientHeight:', modalBody[0].clientHeight);
            
            // Try to scroll programmatically
            console.log('Attempting scroll...');
            modalBody[0].scrollTop = 100;
            console.log('ScrollTop after attempt:', modalBody[0].scrollTop);
        }, 1000);
    });
    
    // Reload contacts when dropdown changes
    $(document).on('change', '#xeroInstanceSelect', function() {
        const instancePk = $(this).val();
        loadContacts(instancePk);
    });
    
    // Update contact button handler - convert row to editable inputs
    $(document).on('click', '.update-contact-btn', function() {
        const button = $(this);
        const row = button.closest('tr');
        
        // Get current values
        const emailCell = row.find('.contact-email');
        const bsbCell = row.find('.contact-bsb');
        const accountCell = row.find('.contact-account');
        const abnCell = row.find('.contact-abn');
        
        const email = emailCell.text().trim();
        const bsb = String(bsbCell.data('bsb') || '');
        const account = String(accountCell.data('account') || '');
        const abn = String(abnCell.data('abn') || '');
        
        // Format BSB for input (XXX-XXX)
        let bsbFormatted = '';
        if (bsb.length === 6) {
            bsbFormatted = bsb.substring(0, 3) + '-' + bsb.substring(3);
        } else {
            bsbFormatted = bsb;
        }
        
        // Format ABN for input (XX XXX XXX XXX)
        let abnFormatted = '';
        if (abn) {
            const abnClean = abn.replace(/\s/g, '');
            if (abnClean.length === 11) {
                abnFormatted = abnClean.substring(0, 2) + ' ' + abnClean.substring(2, 5) + ' ' + abnClean.substring(5, 8) + ' ' + abnClean.substring(8);
            } else {
                abnFormatted = abn;
            }
        }
        
        // Replace cells with input fields
        emailCell.html(`<input type="text" class="form-control form-control-sm email-input" value="${email}" style="width: 180px;">`);
        bsbCell.html(`<input type="text" class="form-control form-control-sm bsb-input" value="${bsbFormatted}" maxlength="7" style="width: 80px;">`);
        accountCell.html(`<input type="text" class="form-control form-control-sm account-input" value="${account}" style="width: 120px;">`);
        abnCell.html(`<input type="text" class="form-control form-control-sm abn-input" value="${abnFormatted}" maxlength="14" style="width: 130px;">`);
        
        // Change button to Save/Cancel
        button.replaceWith(`
            <button class="btn btn-sm btn-success save-contact-btn">Save</button>
            <button class="btn btn-sm btn-secondary cancel-contact-btn">Cancel</button>
        `);
    });
    
    // BSB input handler - maintain fixed dash
    $(document).on('input', '.bsb-input', function() {
        let value = $(this).val().replace(/[^0-9]/g, ''); // Remove non-digits
        
        if (value.length > 6) {
            value = value.substring(0, 6);
        }
        
        // Format as XXX-XXX
        if (value.length > 3) {
            $(this).val(value.substring(0, 3) + '-' + value.substring(3));
        } else {
            $(this).val(value);
        }
    });
    
    // Account number input handler - numbers only
    $(document).on('input', '.account-input', function() {
        let value = $(this).val().replace(/[^0-9]/g, '');
        $(this).val(value);
    });
    
    // ABN input handler - maintain fixed spaces
    $(document).on('input', '.abn-input', function() {
        let value = $(this).val().replace(/[^0-9]/g, ''); // Remove non-digits
        
        if (value.length > 11) {
            value = value.substring(0, 11);
        }
        
        // Format as XX XXX XXX XXX
        let formatted = '';
        if (value.length > 0) {
            formatted = value.substring(0, 2);
            if (value.length > 2) {
                formatted += ' ' + value.substring(2, 5);
            }
            if (value.length > 5) {
                formatted += ' ' + value.substring(5, 8);
            }
            if (value.length > 8) {
                formatted += ' ' + value.substring(8);
            }
        }
        
        $(this).val(formatted);
    });
    
    // Save button handler - validate and update contact in Xero
    $(document).on('click', '.save-contact-btn', function() {
        const button = $(this);
        const row = button.closest('tr');
        const contactPk = row.data('contact-pk');
        const instancePk = $('#contactsXeroInstanceSelect').val() || $('#xeroInstanceSelect').val();
        
        // Validate using common function (no required fields for update)
        const validation = validateContactFields(row, {
            requireName: false,
            requireEmail: false
        });
        
        if (!validation.valid) {
            alert(validation.message);
            if (validation.focusElement) {
                validation.focusElement.focus();
            }
            return;
        }
        
        const { email, bsbDigits, accountDigits, abnDigits } = validation.values;
        
        // Show processing state
        const inputs = row.find('input');
        inputs.prop('disabled', true).css('background-color', '#e9ecef');
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        row.find('.cancel-contact-btn').prop('disabled', true);
        
        // Make AJAX call to update contact
        fetch(`/update_contact_details/${instancePk}/${contactPk}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            body: JSON.stringify({
                email: email,
                bsb: bsbDigits,
                account_number: accountDigits,
                tax_number: abnDigits
            })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            // Handle OAuth authorization needed
            if (status === 401 && body.needs_auth) {
                inputs.prop('disabled', false).css('background-color', '');
                button.prop('disabled', false).html('Save');
                row.find('.cancel-contact-btn').prop('disabled', false);
                
                if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                    window.location.href = `/core/xero_oauth_authorize/${instancePk}/`;
                }
                return;
            }
            
            if (body.status === 'success') {
                // Success - reload contacts to show updated values in display mode
                loadContacts(instancePk);
                alert('Contact updated successfully!');
            } else {
                throw new Error(body.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error updating contact:', error);
            
            // Revert to editable state on error
            inputs.prop('disabled', false).css('background-color', '');
            button.prop('disabled', false).html('Save');
            row.find('.cancel-contact-btn').prop('disabled', false);
            
            // Show specific error message
            if (error.message.includes('408') || error.message.includes('timeout')) {
                alert('Request timed out. The Xero API is not responding. Please try again.');
            } else if (error.message.includes('503') || error.message.includes('Connection')) {
                alert('Connection error. Cannot reach Xero API. Please check your internet connection.');
            } else {
                alert(`Failed to update contact: ${error.message}`);
            }
        });
    });
    
    // Cancel button handler - revert to display mode
    $(document).on('click', '.cancel-contact-btn', function() {
        const instancePk = $('#contactsXeroInstanceSelect').val() || $('#xeroInstanceSelect').val();
        
        // Reload contacts to reset the row
        if (instancePk) {
            loadContacts(instancePk);
        }
    });
    
    // Pull Xero Contacts button handler
    $(document).on('click', '#pullXeroContactsBtn', function() {
        // Check workspace dropdown first, then modal dropdown
        const xeroInstancePk = $('#contactsXeroInstanceSelect').val() || $('#xeroInstanceSelect').val();
        
        if (!xeroInstancePk) {
            alert('Please select a Xero instance');
            return;
        }
        
        // Disable button and show loading state
        const button = $(this);
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Pulling Contacts...');
        
        fetch(`/pull_xero_contacts/${xeroInstancePk}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            }
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            // Handle OAuth authorization needed
            if (status === 401 && body.needs_auth) {
                button.prop('disabled', false).html('Pull/Update Xero Contacts');
                if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                    window.location.href = `/core/xero_oauth_authorize/${xeroInstancePk}/`;
                }
                return;
            }
            
            if (body.status === 'success') {
                alert(`Success! ${body.details.new_contacts_added} new contacts added, ${body.details.contacts_updated} contacts updated, ${body.details.contacts_unchanged} contacts unchanged.`);
                // Reload contacts table
                loadContacts(xeroInstancePk);
                button.prop('disabled', false).html('Pull/Update Xero Contacts');
            } else {
                alert(`Error: ${body.message}`);
                button.prop('disabled', false).html('Pull/Update Xero Contacts');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to pull contacts. Please try again.');
            button.prop('disabled', false).html('Pull/Update Xero Contacts');
        });
    });
    
    // Add Contact button handler - insert blank row at top
    $(document).on('click', '#addContactBtn', function() {
        // Check workspace dropdown first, then modal dropdown
        const instancePk = $('#contactsXeroInstanceSelect').val() || $('#xeroInstanceSelect').val();
        
        if (!instancePk) {
            alert('Please select a Xero instance');
            return;
        }
        
        // Check if add row already exists (check both workspace and modal)
        const tbody = $('#contactsSection:visible tbody, #contactsModal tbody');
        if (tbody.find('.add-contact-row').length > 0) {
            alert('Please complete or cancel the current add operation');
            return;
        }
        
        // Create blank input row
        const addRow = $(`<tr class="add-contact-row" style="background-color: #f8f9fa;"></tr>`);
        addRow.append(`
            <td><input type="text" class="form-control form-control-sm name-input" placeholder="Name *" style="width: 150px;"></td>
            <td><input type="text" class="form-control form-control-sm email-input" placeholder="Email *" style="width: 180px;"></td>
            <td><input type="text" class="form-control form-control-sm bsb-input" placeholder="XXX-XXX" maxlength="7" style="width: 80px;"></td>
            <td><input type="text" class="form-control form-control-sm account-input" placeholder="Account" style="width: 120px;"></td>
            <td><input type="text" class="form-control form-control-sm abn-input" placeholder="XX XXX XXX XXX" maxlength="14" style="width: 130px;"></td>
            <td></td>
            <td>
                <button class="btn btn-sm btn-success add-new-contact-btn">Add</button>
                <button class="btn btn-sm btn-secondary cancel-add-contact-btn">Cancel</button>
            </td>
        `);
        
        // Insert at the top of tbody (workspace or modal)
        tbody.prepend(addRow);
        
        // Focus on name input
        addRow.find('.name-input').focus();
    });
    
    // Add new contact save button handler
    $(document).on('click', '.add-new-contact-btn', function() {
        const button = $(this);
        const row = button.closest('tr');
        const instancePk = $('#contactsXeroInstanceSelect').val() || $('#xeroInstanceSelect').val();
        
        // Validate using common function (name and email required for add)
        const validation = validateContactFields(row, {
            requireName: true,
            requireEmail: true
        });
        
        if (!validation.valid) {
            alert(validation.message);
            if (validation.focusElement) {
                validation.focusElement.focus();
            }
            return;
        }
        
        const { name, email, bsbDigits, accountDigits, abnDigits } = validation.values;
        
        // Show processing state
        const inputs = row.find('input');
        inputs.prop('disabled', true).css('background-color', '#e9ecef');
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        row.find('.cancel-add-contact-btn').prop('disabled', true);
        
        // Make AJAX call to create contact
        fetch(`/create_contact/${instancePk}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            body: JSON.stringify({
                name: name,
                email: email,
                bsb: bsbDigits,
                account_number: accountDigits,
                tax_number: abnDigits
            })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            // Handle OAuth authorization needed
            if (status === 401 && body.needs_auth) {
                inputs.prop('disabled', false).css('background-color', '');
                button.prop('disabled', false).html('Add');
                row.find('.cancel-add-contact-btn').prop('disabled', false);
                
                if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                    window.location.href = `/core/xero_oauth_authorize/${instancePk}/`;
                }
                return;
            }
            
            if (body.status === 'success') {
                // Success - replace the add row with a display row
                const contact = body.contact;
                
                // Format BSB as XXX-XXX
                let formattedBsb = '';
                if (contact.bank_bsb && contact.bank_bsb.length === 6) {
                    formattedBsb = contact.bank_bsb.substring(0, 3) + '-' + contact.bank_bsb.substring(3);
                } else {
                    formattedBsb = contact.bank_bsb || '';
                }
                
                // Format ABN as XX XXX XXX XXX
                let formattedAbn = '';
                if (contact.tax_number) {
                    const abn = contact.tax_number.replace(/\s/g, '');
                    if (abn.length === 11) {
                        formattedAbn = abn.substring(0, 2) + ' ' + abn.substring(2, 5) + ' ' + abn.substring(5, 8) + ' ' + abn.substring(8);
                    } else {
                        formattedAbn = contact.tax_number;
                    }
                }
                
                // Create new display row
                let newRow = $(`<tr data-contact-pk="${contact.contact_pk}" style="background-color: #d4edda;"></tr>`);
                newRow.data('contact', contact);
                
                newRow.append(`
                    <td class="contact-name">${contact.name || ''}</td>
                    <td class="contact-email">${contact.email || ''}</td>
                    <td class="contact-bsb" style="white-space: nowrap;" data-bsb="${contact.bank_bsb || ''}">${formattedBsb}</td>
                    <td class="contact-account" data-account="${contact.bank_account_number || ''}">${contact.bank_account_number || ''}</td>
                    <td class="contact-abn" style="white-space: nowrap;" data-abn="${contact.tax_number || ''}">${formattedAbn}</td>
                    <td><button class="btn btn-sm btn-primary update-contact-btn">Update</button></td>
                `);
                
                // Replace add row with new row
                row.replaceWith(newRow);
                
                alert('Contact created successfully!');
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    newRow.css('background-color', '');
                }, 3000);
            } else {
                throw new Error(body.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error creating contact:', error);
            
            // Revert to editable state on error
            inputs.prop('disabled', false).css('background-color', '');
            button.prop('disabled', false).html('Add');
            row.find('.cancel-add-contact-btn').prop('disabled', false);
            
            // Show specific error message
            if (error.message.includes('408') || error.message.includes('timeout')) {
                alert('Request timed out. The Xero API is not responding. Please try again.');
            } else if (error.message.includes('503') || error.message.includes('Connection')) {
                alert('Connection error. Cannot reach Xero API. Please check your internet connection.');
            } else {
                alert(`Failed to create contact: ${error.message}`);
            }
        });
    });
    
    // Cancel add contact button handler
    $(document).on('click', '.cancel-add-contact-btn', function() {
        const row = $(this).closest('tr');
        row.remove();
    });
    
    // Expose loadContacts globally for dashboard controller
    window.loadContacts = loadContacts;
});
</script>

<style>
/* Ensure Add Supplier modal appears above Bills modal */
#addSupplierModal {
    z-index: 1060 !important;
}
#addSupplierModal ~ .modal-backdrop {
    z-index: 1055 !important;
}
</style>

<!-- Add Supplier Modal (Smaller version for quick add) -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document" style="max-width: 700px;">
        <div class="modal-content" style="border: 3px solid black;">
            <div class="modal-header" style="text-align: center; background: var(--gradient-primary-45deg);">
                <h5 class="modal-title">Add Supplier</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="overflow-x: auto;">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th style="min-width: 100px;">Name</th>
                                <th style="min-width: 130px;">Email Address</th>
                                <th style="min-width: 70px;">BSB</th>
                                <th style="min-width: 90px;">Account Number</th>
                                <th style="min-width: 110px;">ABN</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="addSupplierRow">
                                <td><input type="text" class="form-control form-control-sm name-input" placeholder="Name *" style="width: 100%;"></td>
                                <td><input type="text" class="form-control form-control-sm email-input" placeholder="Email *" style="width: 100%;"></td>
                                <td><input type="text" class="form-control form-control-sm bsb-input" placeholder="XXX-XXX" maxlength="7" style="width: 100%;"></td>
                                <td><input type="text" class="form-control form-control-sm account-input" placeholder="Account" style="width: 100%;"></td>
                                <td><input type="text" class="form-control form-control-sm abn-input" placeholder="XX XXX XXX XXX" maxlength="14" style="width: 100%;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addSupplierBtn">Add</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Store the Xero Instance ID for the add supplier modal
    let addSupplierXeroInstanceId = null;
    let addSupplierBillRow = null;
    
    // Function to open Add Supplier modal with Xero Instance context
    window.openAddSupplierModal = function(xeroInstanceId, billRow) {
        addSupplierXeroInstanceId = xeroInstanceId;
        addSupplierBillRow = billRow;
        
        // Clear inputs
        $('#addSupplierRow input').val('');
        
        // Show modal
        $('#addSupplierModal').modal('show');
        
        // Ensure backdrop is properly layered
        setTimeout(() => {
            $('.modal-backdrop').last().css('z-index', 1055);
            $('#addSupplierRow .name-input').focus();
        }, 100);
    };
    
    // Add Supplier button handler
    $('#addSupplierBtn').click(function() {
        const button = $(this);
        const row = $('#addSupplierRow');
        
        if (!addSupplierXeroInstanceId) {
            alert('No Xero Instance selected');
            return;
        }
        
        // Validate using the same validation function
        const validation = validateContactFields(row, {
            requireName: true,
            requireEmail: true
        });
        
        if (!validation.valid) {
            alert(validation.message);
            if (validation.focusElement) {
                validation.focusElement.focus();
            }
            return;
        }
        
        const { name, email, bsbDigits, accountDigits, abnDigits } = validation.values;
        
        // Show processing state
        const inputs = row.find('input');
        inputs.prop('disabled', true).css('background-color', '#e9ecef');
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Adding...');
        
        // Make AJAX call to create contact
        fetch(`/create_contact/${addSupplierXeroInstanceId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            body: JSON.stringify({
                name: name,
                email: email,
                bsb: bsbDigits,
                account_number: accountDigits,
                tax_number: abnDigits
            })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            // Handle OAuth authorization needed
            if (status === 401 && body.needs_auth) {
                inputs.prop('disabled', false).css('background-color', '');
                button.prop('disabled', false).html('Add');
                
                if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                    window.location.href = `/core/xero_oauth_authorize/${addSupplierXeroInstanceId}/`;
                }
                return;
            }
            
            if (body.status === 'success') {
                const contact = body.contact;
                
                // Add to global suppliers list at the beginning
                if (window.billsData && window.billsData.suppliers) {
                    window.billsData.suppliers.unshift({
                        contact_pk: contact.contact_pk,
                        name: contact.name,
                        xero_instance_id: addSupplierXeroInstanceId
                    });
                }
                
                // Update the supplier dropdown in the bill row if provided
                if (addSupplierBillRow) {
                    const supplierSelect = addSupplierBillRow.find('.supplier-select');
                    
                    // Add new option to dropdown - insert after the second separator (separator2)
                    const newOption = $('<option>')
                        .val(contact.contact_pk)
                        .text(contact.name)
                        .attr('data-xero-instance', addSupplierXeroInstanceId);
                    
                    // Find separator2 and insert after it (top of supplier list)
                    const separator2 = supplierSelect.find('option[disabled][value="separator2"]');
                    if (separator2.length > 0) {
                        separator2.after(newOption);
                    } else {
                        supplierSelect.append(newOption);
                    }
                    
                    // Select the new supplier
                    supplierSelect.val(contact.contact_pk);
                }
                
                // Reset form
                inputs.prop('disabled', false).css('background-color', '').val('');
                button.prop('disabled', false).html('Add');
                
                // Close modal
                $('#addSupplierModal').modal('hide');
                
                alert('Supplier added successfully!');
            } else {
                throw new Error(body.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error creating supplier:', error);
            
            // Revert to editable state on error
            inputs.prop('disabled', false).css('background-color', '');
            button.prop('disabled', false).html('Add');
            
            // Show specific error message
            if (error.message.includes('408') || error.message.includes('timeout')) {
                alert('Request timed out. The Xero API is not responding. Please try again.');
            } else if (error.message.includes('503') || error.message.includes('Connection')) {
                alert('Connection error. Cannot reach Xero API. Please check your internet connection.');
            } else {
                alert(`Failed to create supplier: ${error.message}`);
            }
        });
    });
});
</script>
