<!-- Shared Rates Table Component - Flexbox Category/Item Display -->
<style>
    /* CSS Variables for rates table */
    :root {
        --color-bg-surface: #ffffff;
        --color-bg-muted: #f8f9fa;
        --color-border: #dee2e6;
        --color-text: #212529;
        --color-text-muted: #6c757d;
        --onyx-blue: #0d6efd;
    }
    
    /* ========================================
       FLEXBOX TABLE - Rates Table Component
       ======================================== */
    
    .rates-heading-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .rates-heading-row h5 {
        margin: 0;
        font-size: 13px;
        font-weight: 700;
        line-height: 1;
    }
    
    .rates-heading-row #copyToContractBudgetBtn {
        font-size: 12px;
        padding: 4px 12px;
    }
    
    .rates-table-container {
        height: 100%;
        overflow-y: auto;
    }
    
    .rates-flex-table {
        border: 1px solid #000;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 180px);
    }
    
    /* Header Row 1 - Main headings */
    .rates-flex-header-row1 {
        display: flex;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg-muted);
        padding: 6px;
        font-weight: 600;
        font-size: 14px;
        line-height: 1;
        color: var(--color-text);
    }
    
    .rates-flex-header-row1 .col-name {
        width: 170px;
        min-width: 170px;
        padding: 0 6px;
    }
    
    .rates-flex-header-row1 .col-xero-acc,
    .rates-flex-header-row1 .col-tracking-cat {
        width: 125px;
        min-width: 125px;
        padding: 0 6px;
        text-align: center;
    }
    
    .rates-flex-header-row1 .col-rate {
        width: 100px;
        min-width: 100px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-header-row1 .col-bom-group {
        flex: 1;
        border-left: 1px solid var(--color-border);
        border-right: 1px solid var(--color-border);
        padding: 0 6px;
        margin: -6px 0;
        padding-top: 6px;
        padding-bottom: 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    /* Header Row 2 - Sub-headings */
    .rates-flex-header-row2 {
        display: flex;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg-muted);
        padding: 4px 6px;
        font-weight: 500;
        font-size: 12px;
        line-height: 1;
        color: var(--color-text-muted);
    }
    
    .rates-flex-header-row2 .col-name {
        width: 170px;
        min-width: 170px;
        padding: 0 6px;
    }
    
    .rates-flex-header-row2 .col-xero-acc,
    .rates-flex-header-row2 .col-tracking-cat {
        width: 125px;
        min-width: 125px;
        padding: 0 6px;
    }
    
    .rates-flex-header-row2 .col-rate {
        width: 100px;
        min-width: 100px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-header-row2 .col-unit {
        flex: 1;
        border-left: 1px solid var(--color-border);
        padding: 0 6px;
        margin: -4px 0;
        padding-top: 4px;
        padding-bottom: 4px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-header-row2 .col-operator,
    .rates-flex-header-row2 .col-value {
        flex: 1;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-header-row2 .col-value {
        border-right: 1px solid var(--color-border);
        margin: -4px 0;
        padding-top: 4px;
        padding-bottom: 4px;
    }
    
    /* Body container */
    .rates-flex-body {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    
    /* Category Row - ~25px height */
    .rates-flex-category {
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--color-border);
        padding: 6px;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
        background: var(--color-bg-muted);
        color: var(--color-text);
        cursor: pointer;
    }
    
    .rates-flex-category:hover {
        background: #e9ecef;
    }
    
    .rates-flex-category.internal-category {
        background-color: #e6d5f5;
        color: #6f2da8;
    }
    
    .rates-flex-category.internal-category:hover {
        background-color: #d9c5ed;
    }
    
    .rates-flex-category.labour-category {
        background-color: #fce4ec;
        color: #c2185b;
    }
    
    .rates-flex-category.labour-category:hover {
        background-color: #f8bbd9;
    }
    
    .rates-flex-category .col-name {
        width: 170px;
        min-width: 170px;
        padding: 0 6px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .rates-flex-category .col-xero-acc,
    .rates-flex-category .col-tracking-cat {
        width: 125px;
        min-width: 125px;
        padding: 0 6px;
        text-align: center;
    }
    
    .rates-flex-category .col-rate {
        width: 100px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-category .col-unit,
    .rates-flex-category .col-operator,
    .rates-flex-category .col-value {
        flex: 1;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    /* Collapse indicator */
    .rates-collapse-indicator {
        font-size: 10px;
        color: var(--color-text-muted);
        width: 14px;
        transition: transform 0.2s;
    }
    
    .rates-collapse-indicator.collapsed {
        transform: rotate(0deg);
    }
    
    .rates-collapse-indicator.expanded {
        transform: rotate(90deg);
    }
    
    /* Items Container (collapsible) - slide/roll animation */
    .rates-flex-items-container {
        overflow: hidden;
        max-height: 2000px; /* Large enough for any reasonable number of items */
        transition: max-height 0.3s ease-out;
    }
    
    .rates-flex-items-container.collapsed {
        max-height: 0;
        transition: max-height 0.2s ease-in;
    }
    
    /* Item Row - compact height */
    .rates-flex-item {
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--color-border);
        padding: 2px 6px;
        font-size: 12px;
        font-weight: 400;
        line-height: 1;
        background: var(--color-bg-surface);
        color: var(--color-text);
    }
    
    .rates-flex-item:hover {
        background: var(--color-bg-muted);
    }
    
    .rates-flex-item.internal-item {
        color: #6f2da8;
    }
    
    .rates-flex-item.labour-item {
        color: #c2185b;
    }
    
    .rates-flex-item .col-name {
        width: 170px;
        min-width: 170px;
        padding: 0 6px 0 30px; /* indent for hierarchy */
    }
    
    .rates-flex-item .col-xero-acc,
    .rates-flex-item .col-tracking-cat {
        width: 125px;
        min-width: 125px;
        padding: 0 6px;
        text-align: center;
        color: var(--color-text-muted);
        font-size: 11px;
        cursor: pointer;
    }
    
    /* Xero Account dropdown styling */
    .rates-flex-item .xero-acc-select,
    .rates-flex-item .tracking-cat-select {
        width: 100%;
        padding: 2px 4px;
        font-size: 10px;
        border: 1px solid var(--color-border);
        border-radius: 3px;
        background: var(--color-bg-surface);
        color: var(--color-text);
        cursor: pointer;
    }
    
    .rates-flex-item .xero-acc-select:hover,
    .rates-flex-item .tracking-cat-select:hover {
        border-color: var(--onyx-blue);
    }
    
    .rates-flex-item .xero-acc-select:focus,
    .rates-flex-item .tracking-cat-select:focus {
        outline: none;
        border-color: var(--onyx-blue);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Display spans for xero account and tracking category */
    .xero-acc-display,
    .tracking-cat-display {
        cursor: pointer;
        display: inline-block;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        min-height: 1em;
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .xero-acc-display:hover,
    .tracking-cat-display:hover {
        background: var(--color-bg-muted);
        border-color: var(--color-border);
    }
    
    .rates-flex-item .col-rate {
        width: 100px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
        color: var(--color-text-muted);
        min-height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .rates-flex-item .col-unit,
    .rates-flex-item .col-operator,
    .rates-flex-item .col-value {
        flex: 1;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
        color: var(--color-text-muted);
        min-height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Ensure display spans fill their cells for clickability even when empty */
    .rates-flex-item .rate-display,
    .rates-flex-item .unit-display,
    .rates-flex-item .value-display {
        display: inline-block;
        width: 100%;
        min-height: 16px;
        line-height: 16px;
    }
    
    /* Quantity column styling */
    .col-quantity {
        width: 90px;
        min-width: 90px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-item .col-quantity {
        color: var(--color-text-muted);
    }
    
    /* Total column styling */
    .col-total {
        width: 110px;
        min-width: 110px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .rates-flex-item .col-total {
        color: var(--color-text);
        font-weight: 500;
    }
    
    /* Footer row styling */
    .rates-flex-footer {
        display: flex;
        align-items: center;
        border-top: 2px solid var(--color-border);
        padding: 8px 6px;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
        background: var(--color-bg-muted);
        color: var(--color-text);
    }
    
    .rates-flex-footer .col-name {
        width: 170px;
        min-width: 170px;
        padding: 0 6px;
    }
    
    .rates-flex-footer .col-xero-acc,
    .rates-flex-footer .col-tracking-cat {
        width: 125px;
        min-width: 125px;
        padding: 0 6px;
    }
    
    .rates-flex-footer .col-rate {
        width: 100px;
        padding: 0 6px;
        box-sizing: border-box;
    }
    
    .rates-flex-footer .col-unit,
    .rates-flex-footer .col-operator,
    .rates-flex-footer .col-value {
        flex: 1;
        padding: 0 6px;
        box-sizing: border-box;
    }
    
    .rates-flex-footer .col-total {
        font-weight: 700;
    }
    
    /* Delete column styling */
    .col-delete {
        width: 40px;
        min-width: 40px;
        padding: 0 6px;
        box-sizing: border-box;
        text-align: center;
    }
    
    .delete-icon {
        color: #dc3545;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    .delete-icon:hover {
        opacity: 1;
    }
    
    .rates-flex-category .delete-icon {
        font-size: 11px;
    }
    
    /* Unit dropdown styling */
    .rates-flex-item .unit-select {
        width: 100%;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid var(--color-border);
        border-radius: 3px;
        background: var(--color-bg-surface);
        color: var(--color-text);
        cursor: pointer;
        text-align: center;
    }
    
    .rates-flex-item .unit-select:hover {
        border-color: var(--onyx-blue);
    }
    
    .rates-flex-item .unit-select:focus {
        outline: none;
        border-color: var(--onyx-blue);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Operator dropdown styling */
    .rates-flex-item .operator-select {
        width: 100%;
        padding: 2px 4px;
        font-size: 13px;
        border: 1px solid var(--color-border);
        border-radius: 3px;
        background: var(--color-bg-surface);
        color: var(--color-text);
        cursor: pointer;
        text-align: center;
    }
    
    .rates-flex-item .operator-select:hover {
        border-color: var(--onyx-blue);
    }
    
    .rates-flex-item .operator-select:focus {
        outline: none;
        border-color: var(--onyx-blue);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Click-to-edit display spans */
    .name-display,
    .unit-display,
    .value-display,
    .rate-display {
        cursor: pointer;
    }
    
    /* Operator display - larger font for visibility */
    .operator-display {
        cursor: pointer;
        font-size: 16px;
        display: inline-block;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        min-height: 1em;
        min-width: 20px;
        width: 100%;
        box-sizing: border-box;
    }
    
    .name-display:hover,
    .unit-display:hover,
    .operator-display:hover,
    .value-display:hover,
    .rate-display:hover {
        background: var(--color-bg-muted);
        border-color: var(--color-border);
    }
    
    /* Make entire cell clickable */
    .rates-flex-item .col-unit,
    .rates-flex-item .col-operator,
    .rates-flex-item .col-value,
    .rates-flex-item .col-rate {
        cursor: pointer;
    }
    
    /* Name input styling */
    .name-input {
        width: calc(100% - 50px);
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid var(--onyx-blue);
        border-radius: 3px;
        background: var(--color-bg-surface);
        color: var(--color-text);
        box-sizing: border-box;
    }
    
    .name-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Value and Rate input styling */
    .rates-flex-item .value-input,
    .rates-flex-item .rate-input {
        width: 100%;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid var(--onyx-blue);
        border-radius: 3px;
        background: var(--color-bg-surface);
        color: var(--color-text);
        text-align: center;
        box-sizing: border-box;
    }
    
    .rates-flex-item .value-input:focus,
    .rates-flex-item .rate-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Draggable rows */
    .rates-flex-category.draggable,
    .rates-flex-item.draggable {
        cursor: grab;
    }
    
    .rates-flex-category.draggable:active,
    .rates-flex-item.draggable:active {
        cursor: grabbing;
    }
    
    /* Drag handle icon */
    .rates-drag-handle {
        color: var(--color-text-muted);
        font-size: 12px;
        margin-right: 6px;
        cursor: grab;
    }
    
    /* Drag-and-drop styles */
    .rates-drag-over {
        border-top: 3px solid var(--onyx-blue) !important;
        background-color: #e3f2fd !important;
    }
    
    /* Delete button styling */
    .rates-delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 14px;
        padding: 0 5px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    .rates-delete-btn:hover {
        opacity: 1;
    }
    
    .rates-delete-btn:disabled {
        color: var(--color-text-muted);
        cursor: not-allowed;
        opacity: 0.3;
    }
    
    /* Empty state */
    .rates-flex-empty {
        padding: 20px;
        text-align: center;
        color: var(--color-text-muted);
        font-size: 13px;
    }
    
    /* Input form tables - Add border around tables */
    .rates-section table,
    .reusable-table {
        border: 1px solid #000;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 4px;
        overflow: hidden;
        width: 100%;
        table-layout: fixed;
    }
    
    /* Remove table border when inside a container that already has a border */
    .reusable-table-container .reusable-table {
        border: none;
        border-radius: 0;
    }
    
    /* Add Item table column widths (5-column table: Item, Category, Order, Unit, Add) */
    .rates-section.item-section .reusable-table th:nth-child(1),
    .rates-section.item-section .reusable-table td:nth-child(1) {
        width: 33%; /* Item */
    }
    
    .rates-section.item-section .reusable-table th:nth-child(2),
    .rates-section.item-section .reusable-table td:nth-child(2) {
        width: 25%; /* Category */
    }
    
    .rates-section.item-section .reusable-table th:nth-child(3),
    .rates-section.item-section .reusable-table td:nth-child(3) {
        width: 12%; /* Order */
    }
    
    .rates-section.item-section .reusable-table th:nth-child(4),
    .rates-section.item-section .reusable-table td:nth-child(4) {
        width: 15%; /* Unit */
    }
    
    /* Add Category table column widths (3-column table: Category, Order, Add) */
    .rates-section.category-section .reusable-table th:nth-child(1),
    .rates-section.category-section .reusable-table td:nth-child(1) {
        width: 60%; /* Category */
    }
    
    .rates-section.category-section .reusable-table th:nth-child(2),
    .rates-section.category-section .reusable-table td:nth-child(2) {
        width: 20%; /* Order */
    }
    
    /* Section headings - slightly smaller with reduced spacing */
    .rates-section h5 {
        font-size: 13px;
        margin-top: 0;
        margin-bottom: 4px;
    }
    
    /* Reduce spacing between sections */
    .rates-section {
        margin-bottom: 12px;
    }
    
    /* Replace black box-shadow with grey border below thead row, match font size to rates-flex-header-row1 */
    .rates-section table thead th {
        box-shadow: none;
        border-bottom: 1px solid var(--color-border);
        font-size: 14px;
    }
    
    /* Input form tables - Add column styling */
    .rates-section table th.col-add,
    .rates-section table td.col-add {
        width: 60px;
        min-width: 60px;
        text-align: center;
        padding: 4px 8px;
    }
    
    .rates-section table th,
    .rates-section table td {
        text-align: left;
    }
    
    .rates-section table .rates-add-btn {
        display: inline-block;
        margin: 0;
        white-space: nowrap;
    }
    
    /* Unit list rows - compact styling to match rates table */
    .unit-list-row td {
        font-size: 11px;
        padding: 2px 8px;
        line-height: 1.2;
    }
    
    /* Unit table delete column */
    .unit-section table th.col-delete,
    .unit-section table td.col-delete {
        width: 30px;
        text-align: center;
        padding: 2px;
    }
    
    /* Unit name cell - click to edit */
    .unit-name-cell {
        cursor: pointer;
    }
    
    .unit-name-display {
        display: inline-block;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        min-width: 40px;
    }
    
    .unit-name-display:hover {
        background: var(--color-bg-muted);
        border-color: var(--color-border);
    }
    
    .unit-name-input {
        width: 100%;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid var(--onyx-blue);
        border-radius: 3px;
        box-sizing: border-box;
    }
    
    .unit-name-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    /* Draggable unit rows */
    .unit-list-row.draggable-unit {
        cursor: grab;
    }
    
    .unit-list-row.draggable-unit:active {
        cursor: grabbing;
    }
    
    .unit-list-row.draggable-unit.dragging {
        opacity: 0.5;
        background: var(--color-bg-muted);
    }
    
    .unit-list-row.draggable-unit.drag-over {
        border-top: 2px solid var(--onyx-blue);
    }
    
    /* Unit section table - tighter row spacing */
    .rates-section.unit-section table td,
    .rates-section.unit-section table th {
        padding: 4px 8px;
    }
    
    /* Scrollable unit table only */
    .rates-section.unit-section table tbody {
        display: block;
        max-height: calc(8 * 24px + 36px); /* 8 unit rows + input row */
        overflow-y: scroll;
    }
    
    /* Always show scrollbar on webkit browsers */
    .rates-section.unit-section table tbody::-webkit-scrollbar {
        width: 8px;
    }
    
    .rates-section.unit-section table tbody::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .rates-section.unit-section table tbody::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    .rates-section.unit-section table tbody::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }
    
    .rates-section.unit-section table thead,
    .rates-section.unit-section table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    
    /* Unit section column widths when Unit Qty is NOT shown (default - rates.html) */
    .rates-section.unit-section:not(.show-unit-qty) th:first-child,
    .rates-section.unit-section:not(.show-unit-qty) td:first-child {
        width: 80%;
    }
    
    .rates-section.unit-section:not(.show-unit-qty) th.col-add,
    .rates-section.unit-section:not(.show-unit-qty) td.col-add {
        width: 20%;
    }
    
    /* Unit section column widths when Unit Qty IS shown (bom.html) */
    .rates-section.unit-section.show-unit-qty th.col-add,
    .rates-section.unit-section.show-unit-qty td.col-add {
        width: 17.5%;
    }
    
    .rates-section.unit-section.show-unit-qty th.col-unit-qty,
    .rates-section.unit-section.show-unit-qty td.col-unit-qty {
        width: 25%;
        text-align: center;
    }
    
    .rates-section.unit-section.show-unit-qty th:first-child,
    .rates-section.unit-section.show-unit-qty td:first-child {
        width: 62.5%;
    }
    
    /* Unit qty input styling */
    .unit-qty-input {
        width: 80%;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid var(--color-border);
        border-radius: 3px;
        text-align: center;
    }
    
    .unit-qty-input:focus {
        outline: none;
        border-color: var(--onyx-blue);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
</style>

<script>
// Rates Table Component - Reusable table rendering for categories/items
(function() {
    'use strict';
    
    // Local CSRF token getter for this component
    function getCSRFToken() {
        // First try to get from cookie
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        // Fallback to hidden input
        if (!cookieValue) {
            var $input = $('input[name=csrfmiddlewaretoken]');
            if ($input.length) {
                cookieValue = $input.val();
            }
        }
        return cookieValue;
    }
    
    // Track collapsed state for categories (shared across instances)
    var ratesCollapsedCategories = {};
    
    // Expose render function globally
    window.renderRatesTable = function(containerSelector, categories, items, options) {
        options = options || {};
        var allowDrag = options.allowDrag !== false; // default true
        var allowDelete = options.allowDelete !== false; // default true
        var projectPk = options.projectPk || (window.currentTenderProject ? window.currentTenderProject.pk : null);
        var units = options.units || []; // Units list for dropdown
        var xeroAccounts = options.xeroAccounts || []; // Xero accounts list for dropdown
        var trackingCategories = options.trackingCategories || []; // Tracking categories list for dropdown
        var showQuantityColumn = options.showQuantityColumn === true; // default false
        var defaultExpanded = options.defaultExpanded === true; // default false (collapsed)
        var showCopyToContractButton = options.showCopyToContractButton === true; // default false
        var ratesBased = options.ratesBased || 0; // 0=not rates-based, 1=rates-based
        
        var container = $(containerSelector);
        if (container.length === 0) {
            console.error('Rates table container not found:', containerSelector);
            return;
        }
        
        container.empty();
        
        // Add heading row with optional button
        var headingRow = $('<div class="rates-heading-row"></div>');
        headingRow.append('<h5>Rates and Quantities</h5>');
        if (showCopyToContractButton) {
            headingRow.append('<button id="copyToContractBudgetBtn" class="btn btn-sm btn-outline-primary">Copy to Contract Budget</button>');
        }
        container.append(headingRow);
        
        // Create the table wrapper
        var tableWrapper = $('<div class="rates-flex-table"></div>');
        
        // Create header row 1 - main headings
        var headerRow1 = $('<div class="rates-flex-header-row1"></div>');
        headerRow1.append('<div class="col-name">Category / Item</div>');
        headerRow1.append('<div class="col-xero-acc">Xero Account</div>');
        headerRow1.append('<div class="col-tracking-cat">Tracking Category</div>');
        headerRow1.append('<div class="col-rate">' + (showQuantityColumn ? 'Rate ($/Qty)' : 'Rate ($)') + '</div>');
        headerRow1.append('<div class="col-bom-group">BOM Calculation Inputs</div>');
        if (showQuantityColumn) {
            headerRow1.append('<div class="col-quantity">Qty</div>');
            headerRow1.append('<div class="col-total">Total ($)</div>');
        }
        headerRow1.append('<div class="col-delete"></div>');
        tableWrapper.append(headerRow1);
        
        // Create header row 2 - sub-headings
        var headerRow2 = $('<div class="rates-flex-header-row2"></div>');
        headerRow2.append('<div class="col-name"></div>');
        headerRow2.append('<div class="col-xero-acc"></div>');
        headerRow2.append('<div class="col-tracking-cat"></div>');
        headerRow2.append('<div class="col-rate"></div>');
        headerRow2.append('<div class="col-unit">Unit</div>');
        headerRow2.append('<div class="col-operator">Operator</div>');
        headerRow2.append('<div class="col-value">Value</div>');
        if (showQuantityColumn) {
            headerRow2.append('<div class="col-quantity"></div>');
            headerRow2.append('<div class="col-total"></div>');
        }
        headerRow2.append('<div class="col-delete"></div>');
        tableWrapper.append(headerRow2);
        
        // Create body container
        var bodyContainer = $('<div class="rates-flex-body"></div>');
        
        if ((!items || items.length === 0) && (!categories || categories.length === 0)) {
            var emptyMessage = options.emptyMessage || 'No categories or items yet. Add a category and items to get started.';
            bodyContainer.append('<div class="rates-flex-empty">' + emptyMessage + '</div>');
            tableWrapper.append(bodyContainer);
            container.append(tableWrapper);
            return;
        }
        
        // Group items by category
        var groupedItems = {};
        (items || []).forEach(function(item) {
            var categoryName = item.category__category;
            if (!groupedItems[categoryName]) {
                groupedItems[categoryName] = [];
            }
            groupedItems[categoryName].push(item);
        });
        
        // Sort categories by order_in_list
        var sortedCategories = (categories || []).slice().sort(function(a, b) {
            return a.order_in_list - b.order_in_list;
        });
        
        // Render each category and its items
        sortedCategories.forEach(function(category) {
            var categoryItems = groupedItems[category.category] || [];
            
            // Sort items by order_in_list
            categoryItems.sort(function(a, b) {
                return (a.order_in_list || 0) - (b.order_in_list || 0);
            });
            
            // Check collapsed state (respects defaultExpanded option)
            var isCollapsed = ratesCollapsedCategories[category.categories_pk] !== undefined 
                ? ratesCollapsedCategories[category.categories_pk] 
                : !defaultExpanded;
            
            // Render category header row
            var isInternal = category.category === 'Internal';
            var isLabour = category.category === 'Labour';
            var categoryRow = $('<div></div>')
                .addClass('rates-flex-category')
                .attr('data-category-pk', category.categories_pk)
                .attr('data-category-order', category.order_in_list);
            
            if (isInternal) {
                categoryRow.addClass('internal-category');
            } else if (isLabour) {
                categoryRow.addClass('labour-category');
            } else if (allowDrag) {
                categoryRow.addClass('draggable').attr('draggable', 'true');
            }
            
            // Build category name cell with collapse indicator and drag handle
            var nameCell = $('<div class="col-name"></div>');
            
            // Collapse indicator
            var collapseIndicator = $('<span class="rates-collapse-indicator"></span>')
                .addClass(isCollapsed ? 'collapsed' : 'expanded')
                .text('▶');
            nameCell.append(collapseIndicator);
            
            // Drag handle (only for non-internal/non-labour and if drag allowed)
            if (!isInternal && !isLabour && allowDrag) {
                nameCell.append('<span class="rates-drag-handle">⋮⋮</span>');
            }
            
            // Category name - click to edit
            var categoryNameDisplay = $('<span class="name-display" data-category-pk="' + category.categories_pk + '">' + category.category + '</span>');
            var categoryNameInput = $('<input type="text" class="name-input" data-category-pk="' + category.categories_pk + '" data-type="category" style="display:none;">');
            categoryNameInput.val(category.category);
            nameCell.append(categoryNameDisplay);
            nameCell.append(categoryNameInput);
            categoryRow.append(nameCell);
            
            // Empty cells for category rows (categories don't have values)
            categoryRow.append('<div class="col-xero-acc"></div>');
            categoryRow.append('<div class="col-tracking-cat"></div>');
            categoryRow.append('<div class="col-rate"></div>');
            categoryRow.append('<div class="col-unit"></div>');
            categoryRow.append('<div class="col-operator"></div>');
            categoryRow.append('<div class="col-value"></div>');
            if (showQuantityColumn) {
                categoryRow.append('<div class="col-quantity"></div>');
                categoryRow.append('<div class="col-total"></div>');
            }
            
            // Delete cell for category (not for Internal category)
            var categoryDeleteCell = $('<div class="col-delete"></div>');
            if (!isInternal) {
                categoryDeleteCell.append('<i class="fas fa-trash delete-icon delete-category" data-category-pk="' + category.categories_pk + '" data-category-name="' + category.category.replace(/"/g, '&quot;') + '"></i>');
            }
            categoryRow.append(categoryDeleteCell);
            
            bodyContainer.append(categoryRow);
            
            // Items container (collapsible)
            var itemsContainer = $('<div class="rates-flex-items-container"></div>')
                .attr('data-category-pk', category.categories_pk);
            if (isCollapsed) {
                itemsContainer.addClass('collapsed');
            }
            
            // Render items under this category
            categoryItems.forEach(function(item, itemIndex) {
                var itemRow = $('<div></div>')
                    .addClass('rates-flex-item')
                    .attr('data-item-pk', item.costing_pk)
                    .attr('data-category-pk', category.categories_pk)
                    .attr('data-item-order', item.order_in_list || (itemIndex + 1));
                
                if (allowDrag) {
                    itemRow.addClass('draggable').attr('draggable', 'true');
                }
                
                if (isInternal) {
                    itemRow.addClass('internal-item');
                }
                
                if (isLabour) {
                    itemRow.addClass('labour-item');
                }
                
                // Item name cell - click to edit
                var itemNameCell = $('<div class="col-name"></div>');
                var itemNameDisplay = $('<span class="name-display" data-item-pk="' + item.costing_pk + '">' + item.item + '</span>');
                var itemNameInput = $('<input type="text" class="name-input" data-item-pk="' + item.costing_pk + '" data-type="item" style="display:none;">');
                itemNameInput.val(item.item);
                itemNameCell.append(itemNameDisplay);
                itemNameCell.append(itemNameInput);
                itemRow.append(itemNameCell);
                
                // Xero Account Code cell - click to show dropdown with optgroup headers
                var xeroAccCell = $('<div class="col-xero-acc"></div>');
                // Find the full display name for this account code
                var xeroAccDisplayText = '';
                if (item.xero_account_code) {
                    var matchedAcc = xeroAccounts.find(function(acc) { return acc.account_code === item.xero_account_code; });
                    xeroAccDisplayText = matchedAcc ? (matchedAcc.account_code + ' - ' + matchedAcc.account_name) : item.xero_account_code;
                }
                var xeroAccDisplay = $('<span class="xero-acc-display" data-item-pk="' + item.costing_pk + '"></span>').text(xeroAccDisplayText);
                if (xeroAccDisplayText) xeroAccDisplay.attr('title', xeroAccDisplayText);
                var xeroAccSelect = $('<select class="xero-acc-select" data-item-pk="' + item.costing_pk + '" style="display:none;"></select>');
                xeroAccSelect.append('<option value=""></option>');
                
                // Build grouped options with optgroup headers by account_type
                var currentOptGroup = null;
                var currentType = null;
                xeroAccounts.forEach(function(acc) {
                    // Create new optgroup when account_type changes
                    if (acc.account_type !== currentType) {
                        currentType = acc.account_type;
                        currentOptGroup = $('<optgroup label="' + (currentType || 'OTHER') + '"></optgroup>');
                        xeroAccSelect.append(currentOptGroup);
                    }
                    var selected = (item.xero_account_code === acc.account_code) ? ' selected' : '';
                    var displayText = acc.display_name || (acc.account_code + ' - ' + acc.account_name);
                    var option = $('<option value="' + acc.account_code + '"' + selected + '>' + displayText + '</option>');
                    if (currentOptGroup) {
                        currentOptGroup.append(option);
                    } else {
                        xeroAccSelect.append(option);
                    }
                });
                xeroAccCell.append(xeroAccDisplay);
                xeroAccCell.append(xeroAccSelect);
                itemRow.append(xeroAccCell);
                
                // Tracking Category cell - click to show dropdown (format: "name - option_name")
                var trackingCatCell = $('<div class="col-tracking-cat"></div>');
                var trackingCatDisplayText = item.xero_tracking_category || '';
                var trackingCatDisplay = $('<span class="tracking-cat-display" data-item-pk="' + item.costing_pk + '"></span>').text(trackingCatDisplayText);
                if (trackingCatDisplayText) trackingCatDisplay.attr('title', trackingCatDisplayText);
                var trackingCatSelect = $('<select class="tracking-cat-select" data-item-pk="' + item.costing_pk + '" style="display:none;"></select>');
                trackingCatSelect.append('<option value=""></option>');
                trackingCategories.forEach(function(cat) {
                    // Match by the full "name - option_name" string or just option_name for backwards compatibility
                    var selected = (item.xero_tracking_category === cat.name || item.xero_tracking_category === cat.option_name) ? ' selected' : '';
                    trackingCatSelect.append('<option value="' + cat.name + '"' + selected + '>' + cat.name + '</option>');
                });
                trackingCatCell.append(trackingCatDisplay);
                trackingCatCell.append(trackingCatSelect);
                itemRow.append(trackingCatCell);
                
                // Rate cell - click to edit
                var rateCell = $('<div class="col-rate"></div>');
                var rateDisplayValue = '';
                if (item.rate !== null && item.rate !== undefined) {
                    rateDisplayValue = parseFloat(item.rate).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 5
                    });
                }
                var rateDisplay = $('<span class="rate-display" data-item-pk="' + item.costing_pk + '">' + rateDisplayValue + '</span>');
                var rateInput = $('<input type="number" class="rate-input" data-item-pk="' + item.costing_pk + '" step="0.00001" style="display:none;">');
                rateInput.val(item.rate || '');
                rateCell.append(rateDisplay);
                rateCell.append(rateInput);
                itemRow.append(rateCell);
                
                // Unit cell - click to show dropdown
                var unitCell = $('<div class="col-unit"></div>');
                var unitDisplayText = item.unit || '';
                var unitDisplay = $('<span class="unit-display" data-item-pk="' + item.costing_pk + '">' + unitDisplayText + '</span>');
                var unitSelect = $('<select class="unit-select" data-item-pk="' + item.costing_pk + '" style="display:none;"></select>');
                unitSelect.append('<option value=""></option>');
                units.forEach(function(u) {
                    var selected = (item.unit === u.unit_name) ? ' selected' : '';
                    unitSelect.append('<option value="' + u.unit_pk + '"' + selected + '>' + u.unit_name + '</option>');
                });
                unitCell.append(unitDisplay);
                unitCell.append(unitSelect);
                itemRow.append(unitCell);
                
                // Operator cell - click to show dropdown
                var operatorCell = $('<div class="col-operator"></div>');
                var operatorDisplayText = item.operator === 1 ? '×' : (item.operator === 2 ? '÷' : '');
                var operatorDisplay = $('<span class="operator-display" data-item-pk="' + item.costing_pk + '">' + operatorDisplayText + '</span>');
                var operatorSelect = $('<select class="operator-select" data-item-pk="' + item.costing_pk + '" style="display:none;"></select>');
                operatorSelect.append('<option value=""></option>');
                operatorSelect.append('<option value="1"' + (item.operator === 1 ? ' selected' : '') + '>×</option>');
                operatorSelect.append('<option value="2"' + (item.operator === 2 ? ' selected' : '') + '>÷</option>');
                operatorCell.append(operatorDisplay);
                operatorCell.append(operatorSelect);
                itemRow.append(operatorCell);
                
                // Value cell - click to edit
                var valueCell = $('<div class="col-value"></div>');
                // Format with thousand separators, preserving up to 5dp
                var displayValue = '';
                if (item.operator_value !== null && item.operator_value !== undefined) {
                    displayValue = parseFloat(item.operator_value).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 5
                    });
                }
                var valueDisplay = $('<span class="value-display" data-item-pk="' + item.costing_pk + '">' + displayValue + '</span>');
                var valueInput = $('<input type="number" class="value-input" data-item-pk="' + item.costing_pk + '" step="0.00001" style="display:none;">');
                valueInput.val(item.operator_value || '');
                valueCell.append(valueDisplay);
                valueCell.append(valueInput);
                itemRow.append(valueCell);
                
                // Quantity cell (optional, only shown when showQuantityColumn is true)
                if (showQuantityColumn) {
                    // Calculate quantity: Units.unit_qty * operator_value (multiply) or Units.unit_qty / operator_value (divide)
                    // Find the matching unit to get its unit_qty
                    var matchingUnit = units.find(function(u) {
                        return u.unit_name === item.unit;
                    });
                    var unitQty = matchingUnit && matchingUnit.unit_qty !== null && matchingUnit.unit_qty !== undefined 
                        ? parseFloat(matchingUnit.unit_qty) : null;
                    
                    var calculatedQty = null;
                    if (unitQty !== null && 
                        item.operator_value !== null && item.operator_value !== undefined && 
                        item.operator) {
                        var opValue = parseFloat(item.operator_value);
                        if (item.operator === 1) { // multiply
                            calculatedQty = unitQty * opValue;
                        } else if (item.operator === 2 && opValue !== 0) { // divide
                            calculatedQty = unitQty / opValue;
                        }
                    }
                    
                    var quantityCell = $('<div class="col-quantity"></div>');
                    quantityCell.attr('data-item-pk', item.costing_pk);
                    quantityCell.attr('data-unit-name', item.unit || '');
                    var quantityDisplayValue = '';
                    if (calculatedQty !== null) {
                        quantityDisplayValue = calculatedQty.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 2
                        });
                    }
                    quantityCell.text(quantityDisplayValue);
                    quantityCell.attr('data-qty-value', calculatedQty || 0);
                    itemRow.append(quantityCell);
                    
                    // Total cell: Rate * Qty
                    var totalCell = $('<div class="col-total"></div>');
                    totalCell.attr('data-item-pk', item.costing_pk);
                    var totalValue = null;
                    if (item.rate !== null && item.rate !== undefined && calculatedQty !== null) {
                        totalValue = parseFloat(item.rate) * calculatedQty;
                    }
                    var totalDisplayValue = '';
                    if (totalValue !== null) {
                        totalDisplayValue = totalValue.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                    totalCell.text(totalDisplayValue);
                    totalCell.attr('data-total-value', totalValue || 0);
                    itemRow.append(totalCell);
                }
                
                // Delete cell for item (items in Internal category CAN be deleted)
                var itemDeleteCell = $('<div class="col-delete"></div>');
                itemDeleteCell.append('<i class="fas fa-trash delete-icon delete-item" data-item-pk="' + item.costing_pk + '" data-item-name="' + item.item.replace(/"/g, '&quot;') + '"></i>');
                itemRow.append(itemDeleteCell);
                
                itemsContainer.append(itemRow);
            });
            
            bodyContainer.append(itemsContainer);
        });
        
        // Finalize table structure
        tableWrapper.append(bodyContainer);
        
        // Add footer row (optional, only for showQuantityColumn)
        if (showQuantityColumn) {
            var footerRow = $('<div class="rates-flex-footer"></div>');
            footerRow.append('<div class="col-name">Total</div>');
            footerRow.append('<div class="col-rate"></div>');
            footerRow.append('<div class="col-unit"></div>');
            footerRow.append('<div class="col-operator"></div>');
            footerRow.append('<div class="col-value"></div>');
            footerRow.append('<div class="col-quantity"></div>');
            
            // Calculate total sum
            var totalSum = 0;
            tableWrapper.find('.col-total[data-total-value]').each(function() {
                totalSum += parseFloat($(this).attr('data-total-value')) || 0;
            });
            var totalSumDisplay = totalSum.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            footerRow.append('<div class="col-total" id="ratesTableTotalSum">' + totalSumDisplay + '</div>');
            footerRow.append('<div class="col-delete"></div>');
            tableWrapper.append(footerRow);
        }
        
        container.append(tableWrapper);
        
        // Store units globally for dynamic updates
        window.ratesTableUnits = units;
        
        // Attach event handlers
        attachRatesTableHandlers(containerSelector, projectPk, allowDrag, allowDelete, options.onReload, options.useRatesEndpoint, options.projectType, showQuantityColumn, units, showCopyToContractButton, ratesBased);
    };
    
    // Attach event handlers for the rates table
    function attachRatesTableHandlers(containerSelector, projectPk, allowDrag, allowDelete, onReload, useRatesEndpoint, projectType, showQuantityColumn, units, showCopyToContractButton, ratesBased) {
        var container = $(containerSelector);
        
        // DEBUG: Log handler attachment
        console.log('=== ATTACH HANDLERS DEBUG ===');
        console.log('Container selector:', containerSelector);
        console.log('Container found:', container.length);
        console.log('Rate cells found:', container.find('.col-rate').length);
        console.log('Unit cells found:', container.find('.col-unit').length);
        console.log('Value cells found:', container.find('.col-value').length);
        console.log('Items found:', container.find('.rates-flex-item').length);
        container.find('.rates-flex-item').each(function(i) {
            console.log('  Item ' + i + ': pk=' + $(this).attr('data-item-pk') + ', internal=' + $(this).hasClass('internal-item'));
        });
        console.log('=============================');
        
        
        // Helper function to update Qty and Total cells dynamically
        function updateQtyAndTotal(itemPk) {
            if (!showQuantityColumn) return;
            
            var $itemRow = container.find('.rates-flex-item[data-item-pk="' + itemPk + '"]');
            if ($itemRow.length === 0) return;
            
            // Get current values
            var rate = parseFloat($itemRow.find('.rate-input').val()) || 0;
            var operator = parseInt($itemRow.find('.operator-select').val()) || 0;
            var opValue = parseFloat($itemRow.find('.value-input').val()) || 0;
            
            // Get the unit name for this item and look up unit_qty from global array (which gets updated)
            var unitName = $itemRow.find('.unit-display').text() || $itemRow.find('.unit-select option:selected').text();
            var unitsToSearch = window.ratesTableUnits || units;
            var matchingUnit = unitsToSearch ? unitsToSearch.find(function(u) {
                return u.unit_name === unitName;
            }) : null;
            var unitQty = matchingUnit && matchingUnit.unit_qty !== null && matchingUnit.unit_qty !== undefined 
                ? parseFloat(matchingUnit.unit_qty) : null;
            
            // Calculate quantity using unit_qty instead of rate
            var calculatedQty = null;
            if (unitQty !== null && opValue && operator) {
                if (operator === 1) { // multiply
                    calculatedQty = unitQty * opValue;
                } else if (operator === 2 && opValue !== 0) { // divide
                    calculatedQty = unitQty / opValue;
                }
            }
            
            // Update Qty cell
            var $qtyCell = $itemRow.find('.col-quantity');
            $qtyCell.attr('data-unit-name', unitName);
            if (calculatedQty !== null) {
                $qtyCell.text(calculatedQty.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }));
                $qtyCell.attr('data-qty-value', calculatedQty);
            } else {
                $qtyCell.text('');
                $qtyCell.attr('data-qty-value', 0);
            }
            
            // Calculate and update Total cell (Rate * Qty)
            var totalValue = null;
            if (rate && calculatedQty !== null) {
                totalValue = rate * calculatedQty;
            }
            
            var $totalCell = $itemRow.find('.col-total');
            if (totalValue !== null) {
                $totalCell.text(totalValue.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));
                $totalCell.attr('data-total-value', totalValue);
            } else {
                $totalCell.text('');
                $totalCell.attr('data-total-value', 0);
            }
            
            // Update footer total sum
            updateFooterTotal();
        }
        
        // Helper function to update all items using a specific unit
        function updateAllItemsWithUnit(unitName) {
            if (!showQuantityColumn) return;
            
            container.find('.col-quantity[data-unit-name="' + unitName + '"]').each(function() {
                var itemPk = $(this).attr('data-item-pk');
                if (itemPk) {
                    updateQtyAndTotal(itemPk);
                }
            });
        }
        
        // Expose updateAllItemsWithUnit globally for unit qty input handler
        window.updateAllItemsWithUnit = updateAllItemsWithUnit;
        
        // Helper function to update footer total
        function updateFooterTotal() {
            if (!showQuantityColumn) return;
            
            var totalSum = 0;
            container.find('.col-total[data-total-value]').not('#ratesTableTotalSum').each(function() {
                totalSum += parseFloat($(this).attr('data-total-value')) || 0;
            });
            var totalSumDisplay = totalSum.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            container.find('#ratesTableTotalSum').text(totalSumDisplay);
        }
        
        // Copy to Contract Budget button handler
        if (showCopyToContractButton) {
            $('#copyToContractBudgetBtn').off('click').on('click', function() {
                // Different behavior based on rates_based
                var confirmMsg = ratesBased === 1 
                    ? 'Are you sure you want to copy the Rate and Qty values to Contract Budget? This will overwrite existing uncommitted_rate and uncommitted_qty values.'
                    : 'Are you sure you want to copy the Total values to Contract Budget? This will overwrite existing uncommitted_amount values.';
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // Gather all item data
                var updates = [];
                container.find('.rates-flex-item').each(function() {
                    var $row = $(this);
                    var itemPk = $row.attr('data-item-pk');
                    
                    if (itemPk) {
                        if (ratesBased === 1) {
                            // rates_based=1: Copy rate and qty
                            var rate = parseFloat($row.find('.rate-input').val()) || null;
                            var qty = parseFloat($row.find('.col-quantity').attr('data-qty-value')) || null;
                            updates.push({
                                costing_pk: parseInt(itemPk),
                                uncommitted_rate: rate,
                                uncommitted_qty: qty
                            });
                        } else {
                            // rates_based=0: Only copy total to uncommitted_amount
                            var total = parseFloat($row.find('.col-total').attr('data-total-value')) || 0;
                            updates.push({
                                costing_pk: parseInt(itemPk),
                                uncommitted_amount: total
                            });
                        }
                    }
                });
                
                if (updates.length === 0) {
                    alert('No items to copy.');
                    return;
                }
                
                var csrfToken = getCSRFToken();
                
                $.ajax({
                    url: '/core/copy_to_contract_budget/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'X-CSRFToken': csrfToken },
                    data: JSON.stringify({ updates: updates, rates_based: ratesBased }),
                    success: function(response) {
                        if (response.status === 'success') {
                            alert('Successfully copied ' + response.updated_count + ' items to Contract Budget.');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to copy to Contract Budget';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            });
        }
        
        // Unit display click handler - show dropdown (using event delegation)
        container.off('click', '.unit-display').on('click', '.unit-display', function(e) {
            e.stopPropagation();
            var $display = $(this);
            var $select = $display.siblings('.unit-select');
            $display.hide();
            $select.show().focus();
        });
        
        // Unit select change/blur handler (using event delegation)
        container.off('change blur', '.unit-select').on('change blur', '.unit-select', function(e) {
            var $select = $(this);
            var $display = $select.siblings('.unit-display');
            var itemPk = $select.attr('data-item-pk');
            var unitPk = $select.val() || null;
            var selectedText = $select.find('option:selected').text();
            
            if (e.type === 'change') {
                $.ajax({
                    url: '/core/update_item_unit/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        item_pk: itemPk,
                        unit_pk: unitPk,
                        project_type: projectType
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            $display.text(selectedText);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update unit';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            }
            
            $select.hide();
            $display.show();
        });
        
        // Xero Account display click handler - show dropdown (using event delegation)
        container.off('click', '.xero-acc-display').on('click', '.xero-acc-display', function(e) {
            e.stopPropagation();
            var $display = $(this);
            var $select = $display.siblings('.xero-acc-select');
            $display.hide();
            $select.show().focus();
        });
        
        // Xero Account select change/blur handler (using event delegation)
        container.off('change blur', '.xero-acc-select').on('change blur', '.xero-acc-select', function(e) {
            var $select = $(this);
            var $display = $select.siblings('.xero-acc-display');
            var itemPk = $select.attr('data-item-pk');
            var xeroAccCode = $select.val() || '';
            
            if (e.type === 'change') {
                $.ajax({
                    url: '/core/update_item_xero_account/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    data: JSON.stringify({
                        item_pk: itemPk,
                        xero_account_code: xeroAccCode
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Show full display text from selected option
                            var selectedText = $select.find('option:selected').text() || xeroAccCode;
                            $display.text(selectedText);
                            $display.attr('title', selectedText || '');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update Xero account';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            }
            
            $select.hide();
            $display.show();
        });
        
        // Tracking Category display click handler - show dropdown (using event delegation)
        container.off('click', '.tracking-cat-display').on('click', '.tracking-cat-display', function(e) {
            e.stopPropagation();
            var $display = $(this);
            var $select = $display.siblings('.tracking-cat-select');
            $display.hide();
            $select.show().focus();
        });
        
        // Tracking Category select change/blur handler (using event delegation)
        container.off('change blur', '.tracking-cat-select').on('change blur', '.tracking-cat-select', function(e) {
            var $select = $(this);
            var $display = $select.siblings('.tracking-cat-display');
            var itemPk = $select.attr('data-item-pk');
            var trackingCat = $select.val() || '';
            
            if (e.type === 'change') {
                $.ajax({
                    url: '/core/update_item_tracking_category/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    data: JSON.stringify({
                        item_pk: itemPk,
                        xero_tracking_category: trackingCat
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            $display.text(trackingCat);
                            $display.attr('title', trackingCat || '');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update tracking category';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            }
            
            $select.hide();
            $display.show();
        });
        
        // Operator display click handler - show dropdown (using event delegation)
        container.off('click', '.operator-display').on('click', '.operator-display', function(e) {
            e.stopPropagation();
            var $display = $(this);
            var $select = $display.siblings('.operator-select');
            $display.hide();
            $select.show().focus();
        });
        
        // Operator select change/blur handler (using event delegation)
        container.off('change blur', '.operator-select').on('change blur', '.operator-select', function(e) {
            var $select = $(this);
            var $display = $select.siblings('.operator-display');
            var itemPk = $select.attr('data-item-pk');
            var operatorVal = $select.val() || null;
            var selectedText = $select.find('option:selected').text();
            
            if (e.type === 'change') {
                $.ajax({
                    url: '/core/update_item_operator/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        item_pk: itemPk,
                        operator: operatorVal ? parseInt(operatorVal) : null
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            $display.text(selectedText);
                            updateQtyAndTotal(itemPk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update operator';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            }
            
            $select.hide();
            $display.show();
        });
        
        // Name display click handler - show input (using event delegation)
        container.off('click', '.name-display').on('click', '.name-display', function(e) {
            e.stopPropagation();
            var $display = $(this);
            var $input = $display.siblings('.name-input');
            $display.hide();
            $input.show().focus().select();
        });
        
        // Name input blur/enter handler (using event delegation)
        container.off('blur keydown', '.name-input').on('blur keydown', '.name-input', function(e) {
            if (e.type === 'keydown' && e.key !== 'Enter') return;
            if (e.type === 'keydown') e.preventDefault();
            
            var $input = $(this);
            var $display = $input.siblings('.name-display');
            var newName = $input.val().trim();
            var dataType = $input.attr('data-type');
            var pk = dataType === 'category' ? $input.attr('data-category-pk') : $input.attr('data-item-pk');
            var url = dataType === 'category' ? '/core/update_category_name/' : '/core/update_item_name/';
            
            if (!newName) {
                $input.hide();
                $display.show();
                return;
            }
            
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    pk: pk,
                    name: newName
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        $display.text(newName);
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    var msg = 'Failed to update name';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
            
            $input.hide();
            $display.show();
        });
        
        // Value display click handler - show input (using event delegation)
        container.off('click', '.value-display').on('click', '.value-display', function() {
            var $display = $(this);
            var $input = $display.siblings('.value-input');
            $display.hide();
            $input.show().focus().select();
        });
        
        // Value input - constrain to 5dp max while typing (using event delegation)
        container.off('input', '.value-input').on('input', '.value-input', function() {
            var val = $(this).val();
            if (val.indexOf('.') !== -1) {
                var parts = val.split('.');
                if (parts[1] && parts[1].length > 5) {
                    $(this).val(parts[0] + '.' + parts[1].substring(0, 5));
                }
            }
        });
        
        // Value input blur/enter handler - save and show display (using event delegation)
        container.off('blur keydown', '.value-input').on('blur keydown', '.value-input', function(e) {
            if (e.type === 'keydown' && e.key !== 'Enter') return;
            if (e.type === 'keydown') e.preventDefault();
            
            var $input = $(this);
            var $display = $input.siblings('.value-display');
            var itemPk = $input.attr('data-item-pk');
            var newValue = $input.val();
            
            console.log('[Value Update] itemPk:', itemPk, 'raw value:', newValue);
            
            // Round to 5dp if needed
            if (newValue !== '') {
                newValue = parseFloat(newValue);
                if (!isNaN(newValue)) {
                    newValue = Math.round(newValue * 100000) / 100000;
                } else {
                    newValue = null;
                }
            } else {
                newValue = null;
            }
            
            console.log('[Value Update] Sending to server - itemPk:', itemPk, 'operator_value:', newValue);
            
            $.ajax({
                url: '/core/update_item_operator_value/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    item_pk: itemPk,
                    operator_value: newValue
                }),
                success: function(response) {
                    console.log('[Value Update] Server response:', response);
                    if (response.status === 'success') {
                        var formattedValue = '';
                        if (newValue !== null) {
                            formattedValue = parseFloat(newValue).toLocaleString('en-US', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 5
                            });
                        }
                        $display.text(formattedValue);
                        $input.val(newValue || '');
                        updateQtyAndTotal(itemPk);
                    } else {
                        console.error('[Value Update] Error from server:', response.message);
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('[Value Update] AJAX error:', status, error);
                    console.error('[Value Update] Response:', xhr.responseText);
                    var msg = 'Failed to update value';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
            
            $input.hide();
            $display.show();
        });
        
        // Rate display click handler - show input (using event delegation)
        container.off('click', '.rate-display').on('click', '.rate-display', function() {
            var $display = $(this);
            var $input = $display.siblings('.rate-input');
            $display.hide();
            $input.show().focus().select();
        });
        
        // Rate cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-rate').on('click', '.col-rate', function(e) {
            console.log('=== RATE CELL CLICK DEBUG ===');
            console.log('Clicked element:', e.target);
            console.log('Cell:', this);
            console.log('Is internal item:', $(this).closest('.rates-flex-item').hasClass('internal-item'));
            console.log('Item PK:', $(this).closest('.rates-flex-item').attr('data-item-pk'));
            
            if ($(e.target).hasClass('rate-input')) return; // Don't trigger if clicking input
            var $display = $(this).find('.rate-display');
            var $input = $(this).find('.rate-input');
            console.log('Found display:', $display.length, 'Found input:', $input.length);
            if ($display.length && $input.length) {
                $display.hide();
                $input.show().focus().select();
            }
            console.log('=============================');
        });
        
        // Rate input - constrain to 5dp max while typing (using event delegation)
        container.off('input', '.rate-input').on('input', '.rate-input', function() {
            var val = $(this).val();
            if (val.indexOf('.') !== -1) {
                var parts = val.split('.');
                if (parts[1] && parts[1].length > 5) {
                    $(this).val(parts[0] + '.' + parts[1].substring(0, 5));
                }
            }
        });
        
        // Rate input blur/enter handler - save and show display (using event delegation)
        container.off('blur keydown', '.rate-input').on('blur keydown', '.rate-input', function(e) {
            if (e.type === 'keydown' && e.key !== 'Enter') return;
            if (e.type === 'keydown') e.preventDefault();
            
            var $input = $(this);
            var $display = $input.siblings('.rate-display');
            var itemPk = $input.attr('data-item-pk');
            var newRate = $input.val();
            
            // Round to 5dp if needed
            if (newRate !== '') {
                newRate = parseFloat(newRate);
                if (!isNaN(newRate)) {
                    newRate = Math.round(newRate * 100000) / 100000;
                } else {
                    newRate = null;
                }
            } else {
                newRate = null;
            }
            
            $.ajax({
                url: '/core/update_item_rate/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    item_pk: itemPk,
                    rate: newRate
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        var formattedRate = '';
                        if (newRate !== null) {
                            formattedRate = parseFloat(newRate).toLocaleString('en-US', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 5
                            });
                        }
                        $display.text(formattedRate);
                        $input.val(newRate || '');
                        updateQtyAndTotal(itemPk);
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    var msg = 'Failed to update rate';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
            
            $input.hide();
            $display.show();
        });
        
        // Value cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-value').on('click', '.col-value', function(e) {
            console.log('=== VALUE CELL CLICK DEBUG ===');
            console.log('Is internal item:', $(this).closest('.rates-flex-item').hasClass('internal-item'));
            console.log('Item PK:', $(this).closest('.rates-flex-item').attr('data-item-pk'));
            
            if ($(e.target).hasClass('value-input')) return; // Don't trigger if clicking input
            var $display = $(this).find('.value-display');
            var $input = $(this).find('.value-input');
            console.log('Found display:', $display.length, 'Found input:', $input.length);
            if ($display.length && $input.length) {
                $display.hide();
                $input.show().focus().select();
            }
            console.log('==============================');
        });
        
        // Unit cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-unit').on('click', '.col-unit', function(e) {
            console.log('=== UNIT CELL CLICK DEBUG ===');
            console.log('Is internal item:', $(this).closest('.rates-flex-item').hasClass('internal-item'));
            console.log('Item PK:', $(this).closest('.rates-flex-item').attr('data-item-pk'));
            
            if ($(e.target).hasClass('unit-select')) return; // Don't trigger if clicking select
            var $display = $(this).find('.unit-display');
            var $select = $(this).find('.unit-select');
            console.log('Found display:', $display.length, 'Found select:', $select.length);
            if ($display.length && $select.length) {
                $display.hide();
                $select.show().focus();
                console.log('Showing select');
            }
            console.log('=============================');
        });
        
        // Xero Account cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-xero-acc').on('click', '.col-xero-acc', function(e) {
            if ($(e.target).hasClass('xero-acc-select')) return;
            var $display = $(this).find('.xero-acc-display');
            var $select = $(this).find('.xero-acc-select');
            if ($display.length && $select.length) {
                $display.hide();
                $select.show().focus();
            }
        });
        
        // Tracking Category cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-tracking-cat').on('click', '.col-tracking-cat', function(e) {
            if ($(e.target).hasClass('tracking-cat-select')) return;
            var $display = $(this).find('.tracking-cat-display');
            var $select = $(this).find('.tracking-cat-select');
            if ($display.length && $select.length) {
                $display.hide();
                $select.show().focus();
            }
        });
        
        // Operator cell click handler - make whole cell clickable (using event delegation)
        container.off('click', '.col-operator').on('click', '.col-operator', function(e) {
            if ($(e.target).hasClass('operator-select')) return; // Don't trigger if clicking select
            var $display = $(this).find('.operator-display');
            var $select = $(this).find('.operator-select');
            if ($display.length && $select.length) {
                $display.hide();
                $select.show().focus();
            }
        });
        
        // Delete category handler (works for both project_type and project modes) (using event delegation)
        container.off('click', '.delete-category').on('click', '.delete-category', function(e) {
            e.stopPropagation();
            var categoryPk = $(this).attr('data-category-pk');
            var categoryName = $(this).attr('data-category-name');
            
            var itemCount = container.find('.rates-flex-items-container[data-category-pk="' + categoryPk + '"] .rates-flex-item').length;
            var message = 'Are you sure you want to delete the "' + categoryName + '" Category?';
            if (itemCount > 0) {
                message += '\n\nThis will also delete ' + itemCount + ' item(s) in this category.';
            }
            
            if (!confirm(message)) return;
            
            var deleteData = { category_pk: categoryPk };
            if (useRatesEndpoint && projectType) {
                deleteData.project_type = projectType;
            } else if (projectPk) {
                deleteData.project_pk = projectPk;
            }
            
            $.ajax({
                url: '/core/delete_category_or_item/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(deleteData),
                success: function(response) {
                    if (response.status === 'success') {
                        if (onReload) onReload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    var msg = 'Failed to delete category';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
        });
        
        // Delete item handler (works for both project_type and project modes) (using event delegation)
        container.off('click', '.delete-item').on('click', '.delete-item', function(e) {
            e.stopPropagation();
            var itemPk = $(this).attr('data-item-pk');
            var itemName = $(this).attr('data-item-name');
            
            if (!confirm('Are you sure you want to delete the "' + itemName + '" Costing?')) return;
            
            var deleteData = { item_pk: itemPk };
            if (useRatesEndpoint && projectType) {
                deleteData.project_type = projectType;
            } else if (projectPk) {
                deleteData.project_pk = projectPk;
            }
            
            $.ajax({
                url: '/core/delete_category_or_item/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(deleteData),
                success: function(response) {
                    if (response.status === 'success') {
                        if (onReload) onReload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    var msg = 'Failed to delete item';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
        });
        
        // Category collapse toggle (using event delegation)
        container.off('click', '.rates-flex-category').on('click', '.rates-flex-category', function(e) {
            if ($(e.target).hasClass('rates-delete-btn') || $(e.target).closest('.rates-delete-btn').length) {
                return;
            }
            if ($(e.target).hasClass('delete-icon') || $(e.target).closest('.delete-icon').length) {
                return;
            }
            
            var categoryPk = $(this).attr('data-category-pk');
            var indicator = $(this).find('.rates-collapse-indicator');
            var itemsContainer = container.find('.rates-flex-items-container[data-category-pk="' + categoryPk + '"]');
            
            if (indicator.hasClass('expanded')) {
                indicator.removeClass('expanded').addClass('collapsed');
                itemsContainer.addClass('collapsed');
                ratesCollapsedCategories[categoryPk] = true;
            } else {
                indicator.removeClass('collapsed').addClass('expanded');
                itemsContainer.removeClass('collapsed');
                ratesCollapsedCategories[categoryPk] = false;
            }
        });
        
        // Enable drag for rates endpoint (uses projectType) or project-based endpoint (uses projectPk)
        var canDrag = allowDrag && (projectPk || useRatesEndpoint);
        
        if (canDrag) {
            var draggedElement = null;
            var draggedType = null;
            
            // Category drag handlers
            container.find('.rates-flex-category.draggable').on('dragstart', function(e) {
                draggedElement = this;
                draggedType = 'category';
                $(this).css('opacity', '0.4');
                e.originalEvent.dataTransfer.effectAllowed = 'move';
            });
            
            container.find('.rates-flex-category').on('dragend', function() {
                $(this).css('opacity', '1');
                container.find('.rates-drag-over').removeClass('rates-drag-over');
            });
            
            container.find('.rates-flex-category').on('dragover', function(e) {
                e.preventDefault();
                e.originalEvent.dataTransfer.dropEffect = 'move';
                if (this !== draggedElement) {
                    $(this).addClass('rates-drag-over');
                }
                return false;
            });
            
            container.find('.rates-flex-category').on('dragleave', function() {
                $(this).removeClass('rates-drag-over');
            });
            
            container.find('.rates-flex-category').on('drop', function(e) {
                e.stopPropagation();
                $(this).removeClass('rates-drag-over');
                
                if (draggedElement !== this && draggedType === 'category') {
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryOrder = parseInt($(this).attr('data-category-order'));
                    
                    if (useRatesEndpoint) {
                        reorderRatesEntry('category', projectType, draggedCategoryPk, targetCategoryOrder, null, onReload);
                    } else {
                        reorderCategory(projectPk, draggedCategoryPk, targetCategoryOrder, onReload);
                    }
                }
                return false;
            });
            
            // Item drag handlers
            var currentDropTarget = null;
            
            container.find('.rates-flex-item.draggable').on('dragstart', function(e) {
                draggedElement = this;
                draggedType = 'item';
                $(this).css('opacity', '0.4');
                e.originalEvent.dataTransfer.effectAllowed = 'move';
                // Store dragged element data for reference
                e.originalEvent.dataTransfer.setData('text/plain', $(this).attr('data-item-pk'));
            });
            
            container.find('.rates-flex-item').on('dragend', function() {
                $(this).css('opacity', '1');
                container.find('.rates-drag-over').removeClass('rates-drag-over');
                currentDropTarget = null;
            });
            
            // Use dragenter instead of dragover for more stable highlighting
            container.find('.rates-flex-item').on('dragenter', function(e) {
                e.preventDefault();
                
                if (draggedType !== 'item' || this === draggedElement) return;
                
                var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                var targetCategoryPk = $(this).attr('data-category-pk');
                var allowCrossCategory = useRatesEndpoint;
                
                if (allowCrossCategory || draggedCategoryPk === targetCategoryPk) {
                    // Clear previous highlight
                    if (currentDropTarget && currentDropTarget !== this) {
                        $(currentDropTarget).removeClass('rates-drag-over');
                    }
                    currentDropTarget = this;
                    $(this).addClass('rates-drag-over');
                }
            });
            
            container.find('.rates-flex-item').on('dragover', function(e) {
                e.preventDefault();
                if (draggedType === 'item' && this !== draggedElement) {
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryPk = $(this).attr('data-category-pk');
                    var allowCrossCategory = useRatesEndpoint;
                    
                    if (allowCrossCategory || draggedCategoryPk === targetCategoryPk) {
                        e.originalEvent.dataTransfer.dropEffect = 'move';
                    } else {
                        e.originalEvent.dataTransfer.dropEffect = 'none';
                    }
                }
                return false;
            });
            
            container.find('.rates-flex-item').on('dragleave', function(e) {
                // Only remove highlight if we're leaving the element entirely (not entering a child)
                var relatedTarget = e.originalEvent.relatedTarget;
                if (!relatedTarget || !$.contains(this, relatedTarget)) {
                    if (currentDropTarget === this) {
                        $(this).removeClass('rates-drag-over');
                        currentDropTarget = null;
                    }
                }
            });
            
            container.find('.rates-flex-item').on('drop', function(e) {
                e.stopPropagation();
                e.preventDefault();
                $(this).removeClass('rates-drag-over');
                currentDropTarget = null;
                
                var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                var targetCategoryPk = $(this).attr('data-category-pk');
                var allowCrossCategory = useRatesEndpoint;
                
                if (draggedElement !== this && draggedType === 'item') {
                    if (allowCrossCategory || draggedCategoryPk === targetCategoryPk) {
                        var draggedItemPk = $(draggedElement).attr('data-item-pk');
                        var draggedItemOrder = parseInt($(draggedElement).attr('data-item-order'));
                        var targetItemOrder = parseInt($(this).attr('data-item-order'));
                        
                        console.log('[Drag] Item drag/drop:', {
                            draggedPk: draggedItemPk,
                            draggedOrder: draggedItemOrder,
                            targetOrder: targetItemOrder,
                            targetCategoryPk: targetCategoryPk
                        });
                        
                        if (useRatesEndpoint) {
                            reorderRatesEntry('item', projectType, draggedItemPk, targetItemOrder, targetCategoryPk, onReload);
                        } else {
                            reorderItem(projectPk, draggedItemPk, targetItemOrder, onReload);
                        }
                    }
                }
                return false;
            });
        }
        
        if (allowDelete && projectPk) {
            // Delete category handler (using event delegation)
            container.off('click', '.rates-delete-category-btn').on('click', '.rates-delete-category-btn', function(e) {
                e.stopPropagation();
                var categoryPk = $(this).attr('data-category-pk');
                var categoryName = $(this).attr('data-category-name');
                
                var itemCount = container.find('.rates-flex-items-container[data-category-pk="' + categoryPk + '"] .rates-flex-item').length;
                var message = 'Are you sure you want to delete the category "' + categoryName + '"?';
                if (itemCount > 0) {
                    message += '\n\nThis will also delete ' + itemCount + ' item(s) in this category.';
                }
                
                if (!confirm(message)) return;
                
                $.ajax({
                    url: '/core/delete_category/' + projectPk + '/' + categoryPk + '/',
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            if (onReload) onReload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to delete category';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            });
            
            // Delete item handler (using event delegation)
            container.off('click', '.rates-delete-item-btn').on('click', '.rates-delete-item-btn', function(e) {
                e.stopPropagation();
                var itemPk = $(this).attr('data-item-pk');
                var itemName = $(this).attr('data-item-name');
                
                if (!confirm('Are you sure you want to delete the item "' + itemName + '"?')) return;
                
                $.ajax({
                    url: '/core/delete_item/' + projectPk + '/' + itemPk + '/',
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            if (onReload) onReload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to delete item';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            });
        }
    }
    
    // Reorder category via AJAX
    function reorderCategory(projectPk, categoryPk, newOrder, onReload) {
        $.ajax({
            url: '/core/reorder_category/' + projectPk + '/' + categoryPk + '/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ new_order: newOrder }),
            success: function(response) {
                if (response.status === 'success') {
                    if (onReload) onReload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                var msg = 'Failed to reorder category';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                alert(msg);
            }
        });
    }
    
    // Reorder item via AJAX
    function reorderItem(projectPk, itemPk, newOrder, onReload) {
        $.ajax({
            url: '/core/reorder_item/' + projectPk + '/' + itemPk + '/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ new_order: newOrder }),
            success: function(response) {
                if (response.status === 'success') {
                    if (onReload) onReload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                var msg = 'Failed to reorder item';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                alert(msg);
            }
        });
    }
    
    // Reorder category/item via rates endpoint (uses project_type instead of project_pk)
    function reorderRatesEntry(entryType, projectType, pk, newOrder, newCategoryPk, onReload) {
        var payload = {
            type: entryType,
            project_type: projectType,
            pk: pk,
            new_order: newOrder
        };
        
        // For items, include target category pk for cross-category moves
        if (entryType === 'item' && newCategoryPk) {
            payload.new_category_pk = newCategoryPk;
        }
        
        $.ajax({
            url: '/core/update_category_costing_order_in_list/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                if (response.status === 'success') {
                    if (onReload) onReload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr) {
                var msg = 'Failed to reorder ' + entryType;
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                alert(msg);
            }
        });
    }
    
    /**
     * Render Add Category/Item/Unit input forms
     * @param {string} containerSelector - jQuery selector for container
     * @param {object} options
     *   - mode: 'project_type' or 'project'
     *   - modeValue: project_type string or project_pk number
     *   - categories: array of categories for dropdowns
     *   - items: array of items for dropdowns
     *   - units: array of units for dropdowns
     *   - onReload: callback function to reload data after create
     *   - showListColumn: boolean, whether to show List column (default true for project_type mode)
     */
    window.renderRatesInputForms = function(containerSelector, options) {
        var container = $(containerSelector);
        container.empty();
        
        var mode = options.mode || 'project_type';
        var modeValue = options.modeValue;
        var categories = options.categories || [];
        var items = options.items || [];
        var units = options.units || [];
        var onReload = options.onReload;
        var showListColumn = options.showListColumn !== false && mode === 'project_type';
        var showUnitQtyColumn = options.showUnitQtyColumn === true;
        var isDisabled = options.disabled === true;
        
        // Generate unique prefix for IDs to avoid conflicts
        var prefix = mode === 'project_type' ? 'rates' : 'items';
        
        // Build Category Order dropdown options
        var categoryOrderOptions = '';
        for (var i = 1; i <= categories.length + 1; i++) {
            categoryOrderOptions += '<option value="' + i + '">' + i + '</option>';
        }
        if (!categoryOrderOptions) categoryOrderOptions = '<option value="1">1</option>';
        
        // Build Category List dropdown options
        var categoryListOptions = '<option value="">Select...</option>';
        categories.forEach(function(cat) {
            var catPk = cat.categories_pk || cat.pk;
            var catName = cat.category || cat.name;
            categoryListOptions += '<option value="' + catPk + '">' + catName + '</option>';
        });
        
        // Build Item Category dropdown options
        var itemCategoryOptions = '<option value="">Select category...</option>';
        categories.forEach(function(cat) {
            var catPk = cat.categories_pk || cat.pk;
            var catName = cat.category || cat.name;
            itemCategoryOptions += '<option value="' + catPk + '">' + catName + '</option>';
        });
        
        // Build Item List dropdown options
        var itemListOptions = '<option value="">Select...</option>';
        items.forEach(function(item) {
            var itemPk = item.costing_pk || item.pk;
            var itemName = item.item || item.name;
            itemListOptions += '<option value="' + itemPk + '">' + itemName + '</option>';
        });
        
        // Build Unit Order dropdown options
        var unitOrderOptions = '';
        for (var i = 1; i <= units.length + 1; i++) {
            unitOrderOptions += '<option value="' + i + '">' + i + '</option>';
        }
        if (!unitOrderOptions) unitOrderOptions = '<option value="1">1</option>';
        
        // Build Unit List dropdown options
        var unitListOptions = '<option value="">Select...</option>';
        units.forEach(function(unit) {
            var unitPk = unit.unit_pk || unit.pk;
            var unitName = unit.unit_name || unit.name;
            unitListOptions += '<option value="' + unitPk + '">' + unitName + '</option>';
        });
        
        var disabledAttr = isDisabled ? ' disabled' : '';
        
        // Add Category Section (no List column)
        var categoryHtml = '<div class="rates-section category-section">' +
            '<h5>Add Category</h5>' +
            '<table class="reusable-table"><thead><tr>' +
            '<th>Category</th><th>Order</th><th class="col-add">Add</th>' +
            '</tr></thead><tbody><tr>' +
            '<td><input type="text" id="' + prefix + 'CategoryNameInput" maxlength="100" placeholder="Enter category name"' + disabledAttr + '></td>' +
            '<td><select id="' + prefix + 'CategoryOrderSelect"' + disabledAttr + '>' + categoryOrderOptions + '</select></td>' +
            '<td class="col-add"><button id="' + prefix + 'AddCategoryBtn" class="rates-add-btn disabled" disabled>Add</button></td>' +
            '</tr></tbody></table></div>';
        
        // Add Item Section (with Unit column, no List column)
        var itemHtml = '<div class="rates-section item-section">' +
            '<h5>Add Item</h5>' +
            '<table class="reusable-table"><thead><tr>' +
            '<th>Item</th><th>Category</th><th>Order</th><th>Unit</th><th class="col-add">Add</th>' +
            '</tr></thead><tbody><tr>' +
            '<td><input type="text" id="' + prefix + 'ItemNameInput" maxlength="100" placeholder="Enter item name"' + disabledAttr + '></td>' +
            '<td><select id="' + prefix + 'ItemCategorySelect"' + disabledAttr + '>' + itemCategoryOptions + '</select></td>' +
            '<td><select id="' + prefix + 'ItemOrderSelect"' + disabledAttr + '><option value="1">1</option></select></td>' +
            '<td><select id="' + prefix + 'ItemUnitSelect"' + disabledAttr + '>' + unitListOptions + '</select></td>' +
            '<td class="col-add"><button id="' + prefix + 'AddItemBtn" class="rates-add-btn disabled" disabled>Add</button></td>' +
            '</tr></tbody></table></div>';
        
        // Add Unit Section - input row + list of existing units
        var unitRowsHtml = '';
        // Sort units by order_in_list
        var sortedUnits = units.slice().sort(function(a, b) {
            return (a.order_in_list || 0) - (b.order_in_list || 0);
        });
        sortedUnits.forEach(function(unit) {
            var unitPk = unit.unit_pk || unit.pk;
            var unitName = unit.unit_name || unit.name || '';
            var unitQty = unit.unit_qty;
            var unitQtyValue = (unitQty !== null && unitQty !== undefined) ? unitQty : '';
            var deleteCell = '<td class="col-delete"><i class="fas fa-trash delete-icon delete-unit" data-unit-pk="' + unitPk + '" data-unit-name="' + unitName.replace(/"/g, '&quot;') + '"></i></td>';
            var nameCell = '<td class="unit-name-cell"><span class="unit-name-display" data-unit-pk="' + unitPk + '">' + unitName + '</span><input type="text" class="unit-name-input" data-unit-pk="' + unitPk + '" value="' + unitName.replace(/"/g, '&quot;') + '" style="display:none;"' + disabledAttr + '></td>';
            if (showUnitQtyColumn) {
                unitRowsHtml += '<tr class="unit-list-row draggable-unit" data-unit-pk="' + unitPk + '" draggable="true">' + nameCell + '<td class="col-add"></td><td class="col-unit-qty"><input type="number" class="unit-qty-input" data-unit-pk="' + unitPk + '" step="0.00001" value="' + unitQtyValue + '"' + disabledAttr + '></td>' + deleteCell + '</tr>';
            } else {
                unitRowsHtml += '<tr class="unit-list-row draggable-unit" data-unit-pk="' + unitPk + '" draggable="true">' + nameCell + '<td class="col-add"></td>' + deleteCell + '</tr>';
            }
        });
        
        var unitSectionClass = 'rates-section unit-section' + (showUnitQtyColumn ? ' show-unit-qty' : '');
        var unitQtyHeader = showUnitQtyColumn ? '<th class="col-unit-qty">Unit Qty</th>' : '';
        var unitQtyInputCell = showUnitQtyColumn ? '<td class="col-unit-qty"></td>' : '';
        
        var unitHtml = '<div class="' + unitSectionClass + '">' +
            '<h5>Add BOM Calculation Unit</h5>' +
            '<table class="reusable-table"><thead><tr>' +
            '<th>Unit</th><th class="col-add">Add</th>' + unitQtyHeader + '<th class="col-delete"></th>' +
            '</tr></thead><tbody><tr>' +
            '<td><input type="text" id="' + prefix + 'UnitNameInput" maxlength="50" placeholder="Enter unit name"' + disabledAttr + '></td>' +
            '<td class="col-add"><button id="' + prefix + 'AddUnitBtn" class="rates-add-btn disabled" disabled>Add</button></td>' + unitQtyInputCell + '<td class="col-delete"></td>' +
            '</tr>' + unitRowsHtml + '</tbody></table></div>';
        
        container.append(unitHtml);
        container.append(categoryHtml);
        container.append(itemHtml);
        
        // Only attach event handlers if not disabled
        if (!isDisabled) {
            attachInputFormHandlers(prefix, mode, modeValue, categories, items, units, onReload, showUnitQtyColumn);
        }
    };
    
    // Attach event handlers for input forms
    function attachInputFormHandlers(prefix, mode, modeValue, categories, items, units, onReload, showUnitQtyColumn) {
        // Unit Qty input handlers - constrain to 5dp and POST on change
        if (showUnitQtyColumn) {
            $('.unit-qty-input').off('input').on('input', function() {
                var val = $(this).val();
                // Constrain to 5 decimal places while typing
                if (val.indexOf('.') !== -1) {
                    var parts = val.split('.');
                    if (parts[1] && parts[1].length > 5) {
                        $(this).val(parts[0] + '.' + parts[1].substring(0, 5));
                    }
                }
            });
            
            $('.unit-qty-input').off('blur keydown').on('blur keydown', function(e) {
                if (e.type === 'keydown' && e.key !== 'Enter') return;
                if (e.type === 'keydown') e.preventDefault();
                
                var $input = $(this);
                var unitPk = $input.attr('data-unit-pk');
                var newValue = $input.val();
                
                // Get the unit name from the same row
                var unitName = $input.closest('tr').find('td:first').text().trim();
                
                // Round to 5dp if needed
                if (newValue !== '') {
                    newValue = parseFloat(newValue);
                    if (!isNaN(newValue)) {
                        newValue = Math.round(newValue * 100000) / 100000;
                        $input.val(newValue);
                    } else {
                        newValue = null;
                    }
                } else {
                    newValue = null;
                }
                
                var csrfToken = getCSRFToken();
                
                $.ajax({
                    url: '/core/update_unit_qty/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'X-CSRFToken': csrfToken },
                    data: JSON.stringify({
                        unit_pk: unitPk,
                        unit_qty: newValue
                    }),
                    success: function(response) {
                        if (response.status !== 'success') {
                            alert('Error: ' + response.message);
                        } else {
                            // Update the global units array with the new value
                            if (window.ratesTableUnits) {
                                var unit = window.ratesTableUnits.find(function(u) {
                                    return u.unit_pk == unitPk || u.pk == unitPk;
                                });
                                if (unit) {
                                    unit.unit_qty = newValue;
                                }
                            }
                            // Trigger recalculation of all items using this unit
                            if (typeof window.updateAllItemsWithUnit === 'function') {
                                window.updateAllItemsWithUnit(unitName);
                            }
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update unit qty';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            });
        }
        
        // Unit row drag-drop handlers
        var draggedUnitRow = null;
        
        $('.unit-list-row.draggable-unit').off('dragstart').on('dragstart', function(e) {
            draggedUnitRow = this;
            $(this).addClass('dragging');
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            e.originalEvent.dataTransfer.setData('text/plain', $(this).attr('data-unit-pk'));
        });
        
        $('.unit-list-row.draggable-unit').off('dragend').on('dragend', function(e) {
            $(this).removeClass('dragging');
            $('.unit-list-row').removeClass('drag-over');
            draggedUnitRow = null;
        });
        
        $('.unit-list-row.draggable-unit').off('dragover').on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'move';
            if (this !== draggedUnitRow) {
                $(this).addClass('drag-over');
            }
        });
        
        $('.unit-list-row.draggable-unit').off('dragleave').on('dragleave', function(e) {
            $(this).removeClass('drag-over');
        });
        
        $('.unit-list-row.draggable-unit').off('drop').on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            
            if (draggedUnitRow && this !== draggedUnitRow) {
                var $draggedRow = $(draggedUnitRow);
                var $targetRow = $(this);
                
                // Insert the dragged row before the target row
                $draggedRow.insertBefore($targetRow);
                
                // Collect new order of unit PKs
                var unitOrder = [];
                $draggedRow.closest('tbody').find('.unit-list-row.draggable-unit').each(function() {
                    unitOrder.push(parseInt($(this).attr('data-unit-pk')));
                });
                
                // Post new order to backend
                var csrfToken = getCSRFToken();
                var payload = { unit_order: unitOrder };
                
                // Add mode context
                if (mode === 'project_type') {
                    payload.project_type = modeValue;
                } else {
                    payload.project_pk = modeValue;
                }
                
                $.ajax({
                    url: '/core/update_unit_order/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'X-CSRFToken': csrfToken },
                    data: JSON.stringify(payload),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Trigger reload to update dropdowns with new order
                            if (onReload) onReload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        var msg = 'Failed to update unit order';
                        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        alert(msg);
                    }
                });
            }
        });
        
        // Delete unit handler
        $('.delete-unit').off('click').on('click', function(e) {
            e.stopPropagation();
            var unitPk = $(this).attr('data-unit-pk');
            var unitName = $(this).attr('data-unit-name');
            
            if (!confirm('Are you sure you want to delete the unit "' + unitName + '"?')) return;
            
            var csrfToken = getCSRFToken();
            var payload = { unit_pk: unitPk };
            
            // Add mode context
            if (mode === 'project_type') {
                payload.project_type = modeValue;
            } else {
                payload.project_pk = modeValue;
            }
            
            $.ajax({
                url: '/core/delete_unit/',
                type: 'POST',
                contentType: 'application/json',
                headers: { 'X-CSRFToken': csrfToken },
                data: JSON.stringify(payload),
                success: function(response) {
                    if (response.status === 'success') {
                        if (onReload) onReload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    var msg = 'Failed to delete unit';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                }
            });
        });
        
        // Unit name click to edit handler
        $('.unit-name-display').off('click').on('click', function() {
            var $display = $(this);
            var $input = $display.siblings('.unit-name-input');
            
            $display.hide();
            $input.show().focus().select();
        });
        
        // Unit name input blur/enter handler
        $('.unit-name-input').off('blur keydown').on('blur keydown', function(e) {
            if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== 'Escape') return;
            
            var $input = $(this);
            var $display = $input.siblings('.unit-name-display');
            var unitPk = $input.attr('data-unit-pk');
            var newName = $input.val().trim();
            var oldName = $display.text();
            
            // If Escape, revert
            if (e.type === 'keydown' && e.key === 'Escape') {
                $input.val(oldName);
                $input.hide();
                $display.show();
                return;
            }
            
            // If empty or unchanged, revert
            if (!newName || newName === oldName) {
                $input.val(oldName);
                $input.hide();
                $display.show();
                return;
            }
            
            // Update via AJAX
            var csrfToken = getCSRFToken();
            
            $.ajax({
                url: '/core/update_unit_name/',
                type: 'POST',
                contentType: 'application/json',
                headers: { 'X-CSRFToken': csrfToken },
                data: JSON.stringify({
                    unit_pk: unitPk,
                    unit_name: newName
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        $display.text(newName);
                        $input.val(newName);
                        // Update delete icon data attribute
                        $input.closest('tr').find('.delete-unit').attr('data-unit-name', newName);
                        // Reload to update dropdowns
                        if (onReload) onReload();
                    } else {
                        alert('Error: ' + response.message);
                        $input.val(oldName);
                    }
                    $input.hide();
                    $display.show();
                },
                error: function(xhr) {
                    var msg = 'Failed to update unit name';
                    if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                    alert(msg);
                    $input.val(oldName);
                    $input.hide();
                    $display.show();
                }
            });
        });
        
        // Category name input validation
        $('#' + prefix + 'CategoryNameInput').off('input').on('input', function() {
            var name = $(this).val().trim();
            var btn = $('#' + prefix + 'AddCategoryBtn');
            if (name) {
                btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
            } else {
                btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
            }
        });
        
        // Item category select - update order dropdown
        $('#' + prefix + 'ItemCategorySelect').off('change').on('change', function() {
            var categoryPk = $(this).val();
            var orderSelect = $('#' + prefix + 'ItemOrderSelect');
            
            if (!categoryPk) {
                orderSelect.html('<option value="">Select category first...</option>').prop('disabled', true);
                return;
            }
            
            // Count items in selected category from the items array
            var itemCount = 0;
            items.forEach(function(item) {
                var itemCatPk = item.category_pk || (item.category && item.category.categories_pk);
                if (itemCatPk == categoryPk) {
                    itemCount++;
                }
            });
            
            // Build order options
            var orderOptions = '';
            for (var i = 1; i <= itemCount + 1; i++) {
                orderOptions += '<option value="' + i + '">' + i + '</option>';
            }
            if (!orderOptions) orderOptions = '<option value="1">1</option>';
            
            orderSelect.html(orderOptions).prop('disabled', false);
            orderSelect.val(itemCount + 1);
            
            // Re-validate item form
            validateItemForm(prefix);
        });
        
        // Item name input validation
        $('#' + prefix + 'ItemNameInput').off('input').on('input', function() {
            validateItemForm(prefix);
        });
        
        // Unit name input validation
        $('#' + prefix + 'UnitNameInput').off('input').on('input', function() {
            var name = $(this).val().trim();
            var btn = $('#' + prefix + 'AddUnitBtn');
            if (name) {
                btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
            } else {
                btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
            }
        });
        
        // Add Category button click
        $('#' + prefix + 'AddCategoryBtn').off('click').on('click', function() {
            if ($(this).hasClass('disabled')) return;
            
            var name = $('#' + prefix + 'CategoryNameInput').val().trim();
            var order = parseInt($('#' + prefix + 'CategoryOrderSelect').val()) || 1;
            
            if (!name) {
                alert('Please enter a category name.');
                return;
            }
            
            createRatesEntry('category', name, order, null, mode, modeValue, onReload);
            
            // Clear input
            $('#' + prefix + 'CategoryNameInput').val('');
            $(this).removeClass('enabled').addClass('disabled').prop('disabled', true);
        });
        
        // Add Item button click
        $('#' + prefix + 'AddItemBtn').off('click').on('click', function() {
            if ($(this).hasClass('disabled')) return;
            
            var categoryPk = $('#' + prefix + 'ItemCategorySelect').val();
            var name = $('#' + prefix + 'ItemNameInput').val().trim();
            var order = parseInt($('#' + prefix + 'ItemOrderSelect').val()) || 1;
            var unitPk = $('#' + prefix + 'ItemUnitSelect').val() || null;
            
            if (!categoryPk) {
                alert('Please select a category.');
                return;
            }
            if (!name) {
                alert('Please enter an item name.');
                return;
            }
            
            createRatesEntry('item', name, order, parseInt(categoryPk), mode, modeValue, onReload, unitPk);
            
            // Clear inputs
            $('#' + prefix + 'ItemNameInput').val('');
            $('#' + prefix + 'ItemUnitSelect').val('');
            $(this).removeClass('enabled').addClass('disabled').prop('disabled', true);
        });
        
        // Add Unit button click - uses last available order by default
        $('#' + prefix + 'AddUnitBtn').off('click').on('click', function() {
            if ($(this).hasClass('disabled')) return;
            
            var name = $('#' + prefix + 'UnitNameInput').val().trim();
            // Get current unit count from displayed rows and add 1 for next order
            var currentUnitCount = $(this).closest('table').find('.unit-list-row').length;
            var order = currentUnitCount + 1;
            
            if (!name) {
                alert('Please enter a unit name.');
                return;
            }
            
            // Check for duplicate unit name (case-insensitive)
            var duplicate = false;
            units.forEach(function(unit) {
                var existingName = unit.unit_name || unit.name || '';
                if (existingName.toLowerCase() === name.toLowerCase()) {
                    duplicate = true;
                }
            });
            
            if (duplicate) {
                alert('Unit name "' + name + '" already exists. Please choose a different name.');
                return;
            }
            
            createRatesEntry('unit', name, order, null, mode, modeValue, onReload);
            
            // Clear input
            $('#' + prefix + 'UnitNameInput').val('');
            $(this).removeClass('enabled').addClass('disabled').prop('disabled', true);
        });
    }
    
    // Validate item form
    function validateItemForm(prefix) {
        var category = $('#' + prefix + 'ItemCategorySelect').val();
        var name = $('#' + prefix + 'ItemNameInput').val().trim();
        var btn = $('#' + prefix + 'AddItemBtn');
        
        if (category && name) {
            btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
        } else {
            btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
        }
    }
    
    // Create entry via AJAX - handles both project_type and project modes
    function createRatesEntry(modelType, name, orderInList, categoryPk, mode, modeValue, onReload, unitPk) {
        console.log('[CreateEntry] Called with:', {
            modelType: modelType,
            name: name,
            orderInList: orderInList,
            categoryPk: categoryPk,
            mode: mode,
            modeValue: modeValue,
            unitPk: unitPk
        });
        
        if (!modeValue) {
            console.error('[CreateEntry] No modeValue provided');
            alert(mode === 'project_type' ? 'Please select a project type first.' : 'No project selected.');
            return;
        }
        
        var payload = {
            model_type: modelType,
            name: name,
            order_in_list: orderInList
        };
        
        // Set either project_type or project_pk based on mode
        if (mode === 'project_type') {
            payload.project_type = modeValue;
        } else {
            payload.project_pk = modeValue;
        }
        
        if (categoryPk) {
            payload.category_pk = categoryPk;
        }
        
        if (unitPk) {
            payload.unit_pk = parseInt(unitPk);
        }
        
        var csrfToken = typeof getCSRFToken === 'function' ? getCSRFToken() : $('input[name=csrfmiddlewaretoken]').val();
        console.log('[CreateEntry] CSRF Token:', csrfToken);
        console.log('[CreateEntry] Payload:', JSON.stringify(payload, null, 2));
        
        var requestUrl = '/core/create_new_category_costing_unit_quantity/';
        console.log('[CreateEntry] Making POST request to:', requestUrl);
        
        $.ajax({
            url: requestUrl,
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': csrfToken },
            xhrFields: { withCredentials: true },
            data: JSON.stringify(payload),
            success: function(response, textStatus, xhr) {
                console.log('[CreateEntry] AJAX success callback');
                console.log('[CreateEntry] Response status code:', xhr.status);
                console.log('[CreateEntry] Full response:', response);
                console.log('[CreateEntry] Response type:', typeof response);
                
                if (response && response.status === 'success') {
                    console.log('[CreateEntry] Entry created successfully, pk:', response.pk);
                    if (onReload) onReload();
                } else {
                    console.error('[CreateEntry] Response status not success');
                    console.error('[CreateEntry] response.message:', response ? response.message : 'no response');
                    alert('Error: ' + (response ? response.message : 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('[CreateEntry] AJAX error callback');
                console.error('[CreateEntry] XHR status:', xhr.status);
                console.error('[CreateEntry] XHR statusText:', xhr.statusText);
                console.error('[CreateEntry] XHR responseText:', xhr.responseText);
                console.error('[CreateEntry] Status:', status);
                console.error('[CreateEntry] Error:', error);
                
                var errorMsg = 'Error creating ' + modelType + '.';
                try {
                    var errorResponse = JSON.parse(xhr.responseText);
                    console.error('[CreateEntry] Parsed error response:', errorResponse);
                    if (errorResponse.message) {
                        errorMsg = errorResponse.message;
                    }
                    if (errorResponse.traceback) {
                        console.error('[CreateEntry] Server traceback:', errorResponse.traceback);
                    }
                } catch(e) {
                    console.error('[CreateEntry] Could not parse responseText as JSON');
                    if (xhr.responseText && xhr.responseText.includes('<!DOCTYPE html>')) {
                        console.error('[CreateEntry] Response appears to be HTML (likely login redirect)');
                        errorMsg = 'Session expired. Please refresh the page.';
                    }
                }
                alert(errorMsg);
            }
        });
    }
})();
</script>
