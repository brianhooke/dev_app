{% extends "core/dashboard_master.html" %}
{% load static %}

<!--
Template: Staff Hours Module

Purpose:
Staff hours management interface that integrates with Xero Payroll API.
Displays employee data including:
- Active status
- Leave balances
- Pay templates (wages/earnings)
- Superannuation details

Xero Payroll AU API Data Available:
- Employee status (ACTIVE/TERMINATED)
- Leave balances (annual, sick, etc.)
- Pay template (earnings rates, deductions)
- Super memberships

Note: Public holidays are NOT available from Xero API - hardcoded in backend.

Backend Endpoints:
- GET /core/staff_hours/employees/ - Fetch all employees
- GET /core/staff_hours/employee/{id}/ - Get employee detail
- GET /core/staff_hours/leave_balances/ - Get leave balances
- GET /core/staff_hours/pay_items/ - Get pay items (earnings rates, etc.)
- GET /core/staff_hours/payroll_calendars/ - Get payroll calendars
- GET /core/staff_hours/super_funds/ - Get super funds
- GET /core/staff_hours/public_holidays/ - Get public holidays (hardcoded)
-->

{% block title %}Staff Hours{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-user-clock me-2"></i>Staff Hours
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <!-- Xero Instance Selector -->
                    <div class="d-flex align-items-center">
                        <label for="xeroInstanceSelect" class="me-2 text-nowrap">Xero Instance:</label>
                        <select id="xeroInstanceSelect" class="form-select form-select-sm" style="min-width: 200px;">
                            <option value="">Select Xero Instance...</option>
                            {% for instance in xero_instances %}
                            <option value="{{ instance.xero_instance_pk }}">{{ instance.xero_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="refreshDataBtn" class="btn btn-outline-primary btn-sm" disabled>
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center py-5 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading staff data from Xero...</p>
    </div>

    <!-- No Instance Selected Message -->
    <div id="noInstanceMessage" class="text-center py-5">
        <i class="fas fa-building fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Select a Xero Instance</h5>
        <p class="text-muted">Choose a Xero instance from the dropdown above to view staff data.</p>
    </div>

    <!-- Main Content (hidden until data loads) -->
    <div id="mainContent" class="d-none">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75">Active Employees</h6>
                                <h3 class="card-title mb-0" id="activeEmployeeCount">0</h3>
                            </div>
                            <i class="fas fa-users fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75">On Leave</h6>
                                <h3 class="card-title mb-0" id="onLeaveCount">0</h3>
                            </div>
                            <i class="fas fa-umbrella-beach fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75">Total Leave Days</h6>
                                <h3 class="card-title mb-0" id="totalLeaveDays">0</h3>
                            </div>
                            <i class="fas fa-calendar-alt fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75">Public Holidays</h6>
                                <h3 class="card-title mb-0" id="upcomingHolidays">0</h3>
                            </div>
                            <i class="fas fa-star fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="staffTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">
                    <i class="fas fa-users me-1"></i>Employees
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="leave-tab" data-bs-toggle="tab" data-bs-target="#leave" type="button" role="tab">
                    <i class="fas fa-calendar-check me-1"></i>Leave Balances
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">
                    <i class="fas fa-dollar-sign me-1"></i>Pay Items
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="super-tab" data-bs-toggle="tab" data-bs-target="#super" type="button" role="tab">
                    <i class="fas fa-piggy-bank me-1"></i>Super Funds
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="holidays-tab" data-bs-toggle="tab" data-bs-target="#holidays" type="button" role="tab">
                    <i class="fas fa-star me-1"></i>Public Holidays
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="staffTabContent">
            <!-- Employees Tab -->
            <div class="tab-pane fade show active" id="employees" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Employee List</h5>
                        <div class="d-flex gap-2">
                            <select id="statusFilter" class="form-select form-select-sm" style="width: auto;">
                                <option value="ACTIVE">Active Only</option>
                                <option value="">All</option>
                                <option value="TERMINATED">Terminated</option>
                            </select>
                            <input type="text" id="employeeSearch" class="form-control form-control-sm" placeholder="Search employees..." style="width: 200px;">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0" id="employeesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Job Title</th>
                                        <th>Status</th>
                                        <th>Start Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            No employees loaded
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Balances Tab -->
            <div class="tab-pane fade" id="leave" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Leave Balances</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0" id="leaveTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Employee</th>
                                        <th>Leave Type</th>
                                        <th>Balance (Hours)</th>
                                        <th>Balance (Days)</th>
                                    </tr>
                                </thead>
                                <tbody id="leaveTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            No leave data loaded
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pay Items Tab -->
            <div class="tab-pane fade" id="payroll" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Pay Items (Earnings Rates)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0" id="payItemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Rate Type</th>
                                        <th>Rate Per Unit</th>
                                        <th>Account Code</th>
                                    </tr>
                                </thead>
                                <tbody id="payItemsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            No pay items loaded
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Super Funds Tab -->
            <div class="tab-pane fade" id="super" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Super Funds</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0" id="superFundsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fund Name</th>
                                        <th>Type</th>
                                        <th>ABN</th>
                                        <th>USI</th>
                                    </tr>
                                </thead>
                                <tbody id="superFundsTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            No super funds loaded
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Public Holidays Tab -->
            <div class="tab-pane fade" id="holidays" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Public Holidays</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <label class="mb-0 text-muted small">State:</label>
                            <select id="stateFilter" class="form-select form-select-sm" style="width: auto;">
                                <option value="">National Only</option>
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="SA">SA</option>
                                <option value="WA">WA</option>
                                <option value="TAS">TAS</option>
                                <option value="NT">NT</option>
                                <option value="ACT">ACT</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="alert alert-info m-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Public holidays are not available from the Xero API. This data is hardcoded and may need manual updates.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0" id="holidaysTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Holiday</th>
                                        <th>Days Until</th>
                                    </tr>
                                </thead>
                                <tbody id="holidaysTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            No holidays loaded
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Employee Detail Modal -->
<div class="modal fade" id="employeeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Employee Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="employeeDetailContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // State
    let currentXeroInstanceId = null;
    let employeesData = [];
    let leaveData = [];
    let payItemsData = {};
    let superFundsData = [];
    let holidaysData = [];
    
    // DOM Elements
    const xeroInstanceSelect = document.getElementById('xeroInstanceSelect');
    const refreshDataBtn = document.getElementById('refreshDataBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noInstanceMessage = document.getElementById('noInstanceMessage');
    const mainContent = document.getElementById('mainContent');
    const statusFilter = document.getElementById('statusFilter');
    const employeeSearch = document.getElementById('employeeSearch');
    const stateFilter = document.getElementById('stateFilter');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
    });
    
    function setupEventListeners() {
        // Xero instance change
        xeroInstanceSelect.addEventListener('change', function() {
            currentXeroInstanceId = this.value;
            console.log('=== XERO INSTANCE SELECTED ===');
            console.log('Instance ID:', currentXeroInstanceId);
            console.log('Instance Name:', this.options[this.selectedIndex].text);
            if (currentXeroInstanceId) {
                refreshDataBtn.disabled = false;
                // First test the auth/permissions
                testPayrollPermissions();
                loadAllData();
            } else {
                refreshDataBtn.disabled = true;
                showNoInstanceMessage();
            }
        });
        
        // Test payroll permissions
        async function testPayrollPermissions() {
            console.log('=== TESTING PAYROLL API PERMISSIONS ===');
            const url = `/core/staff_hours/employees/?xero_instance_id=${currentXeroInstanceId}&status=ACTIVE`;
            console.log('Test URL:', url);
            
            try {
                const response = await fetch(url);
                console.log('Response Status:', response.status);
                console.log('Response OK:', response.ok);
                
                const data = await response.json();
                console.log('Response Data:', data);
                
                if (response.status === 401) {
                    console.error('❌ AUTH FAILED (401) - Token may be expired or missing payroll scopes');
                    console.error('Error details:', data);
                } else if (response.status === 403) {
                    console.error('❌ FORBIDDEN (403) - Payroll scopes not authorized');
                    console.error('Error details:', data);
                } else if (response.ok) {
                    console.log('✅ PAYROLL API ACCESS GRANTED');
                    console.log('Employees found:', data.count || 0);
                } else {
                    console.warn('⚠️ Unexpected response:', response.status, data);
                }
            } catch (error) {
                console.error('❌ FETCH ERROR:', error);
            }
        }
        
        // Refresh button
        refreshDataBtn.addEventListener('click', function() {
            if (currentXeroInstanceId) {
                loadAllData();
            }
        });
        
        // Status filter change
        statusFilter.addEventListener('change', function() {
            loadEmployees();
        });
        
        // Employee search
        employeeSearch.addEventListener('input', function() {
            filterEmployeesTable();
        });
        
        // State filter for holidays
        stateFilter.addEventListener('change', function() {
            loadPublicHolidays();
        });
    }
    
    function showLoading() {
        loadingIndicator.classList.remove('d-none');
        noInstanceMessage.classList.add('d-none');
        mainContent.classList.add('d-none');
    }
    
    function hideLoading() {
        loadingIndicator.classList.add('d-none');
    }
    
    function showMainContent() {
        mainContent.classList.remove('d-none');
        noInstanceMessage.classList.add('d-none');
    }
    
    function showNoInstanceMessage() {
        noInstanceMessage.classList.remove('d-none');
        mainContent.classList.add('d-none');
    }
    
    async function loadAllData() {
        showLoading();
        
        try {
            await Promise.all([
                loadEmployees(),
                loadPayItems(),
                loadSuperFunds(),
                loadPublicHolidays()
            ]);
            
            hideLoading();
            showMainContent();
        } catch (error) {
            console.error('Error loading data:', error);
            hideLoading();
            alert('Error loading data from Xero. Please try again.');
        }
    }
    
    async function loadEmployees() {
        const status = statusFilter.value;
        const url = `/core/staff_hours/employees/?xero_instance_id=${currentXeroInstanceId}&status=${status}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                employeesData = data.employees;
                renderEmployeesTable();
                updateEmployeeStats();
                
                // Also extract leave data
                extractLeaveData();
            } else {
                console.error('Error loading employees:', data.message);
            }
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }
    
    function extractLeaveData() {
        leaveData = [];
        employeesData.forEach(emp => {
            if (emp.leave_balances && emp.leave_balances.length > 0) {
                emp.leave_balances.forEach(leave => {
                    leaveData.push({
                        employee_name: `${emp.first_name} ${emp.last_name}`,
                        employee_id: emp.employee_id,
                        leave_type: leave.LeaveName || leave.LeaveType || 'Unknown',
                        balance_hours: leave.NumberOfUnits || 0,
                        balance_days: (leave.NumberOfUnits || 0) / 7.6 // Assuming 7.6 hour day
                    });
                });
            }
        });
        renderLeaveTable();
    }
    
    function renderEmployeesTable() {
        const tbody = document.getElementById('employeesTableBody');
        
        if (employeesData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No employees found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = employeesData.map(emp => `
            <tr data-employee-id="${emp.employee_id}">
                <td>
                    <strong>${emp.first_name || ''} ${emp.last_name || ''}</strong>
                </td>
                <td>${emp.email || '-'}</td>
                <td>${emp.job_title || '-'}</td>
                <td>
                    <span class="badge ${emp.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                        ${emp.status || 'Unknown'}
                    </span>
                </td>
                <td>${formatDate(emp.start_date)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-employee-btn" data-employee-id="${emp.employee_id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        // Add click handlers for view buttons
        tbody.querySelectorAll('.view-employee-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const employeeId = this.dataset.employeeId;
                viewEmployeeDetail(employeeId);
            });
        });
    }
    
    function filterEmployeesTable() {
        const searchTerm = employeeSearch.value.toLowerCase();
        const rows = document.querySelectorAll('#employeesTableBody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }
    
    function renderLeaveTable() {
        const tbody = document.getElementById('leaveTableBody');
        
        if (leaveData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        No leave balances found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = leaveData.map(leave => `
            <tr>
                <td>${leave.employee_name}</td>
                <td>${leave.leave_type}</td>
                <td>${leave.balance_hours.toFixed(2)}</td>
                <td>${leave.balance_days.toFixed(1)}</td>
            </tr>
        `).join('');
    }
    
    async function loadPayItems() {
        const url = `/core/staff_hours/pay_items/?xero_instance_id=${currentXeroInstanceId}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                payItemsData = {
                    earnings_rates: data.earnings_rates || [],
                    deduction_types: data.deduction_types || [],
                    leave_types: data.leave_types || []
                };
                renderPayItemsTable();
            } else {
                console.error('Error loading pay items:', data.message);
            }
        } catch (error) {
            console.error('Error loading pay items:', error);
        }
    }
    
    function renderPayItemsTable() {
        const tbody = document.getElementById('payItemsTableBody');
        const earningsRates = payItemsData.earnings_rates || [];
        
        if (earningsRates.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        No pay items found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = earningsRates.map(item => `
            <tr>
                <td>${item.Name || '-'}</td>
                <td>${item.EarningsType || '-'}</td>
                <td>${item.RateType || '-'}</td>
                <td>${item.RatePerUnit ? '$' + parseFloat(item.RatePerUnit).toFixed(2) : '-'}</td>
                <td>${item.AccountCode || '-'}</td>
            </tr>
        `).join('');
    }
    
    async function loadSuperFunds() {
        const url = `/core/staff_hours/super_funds/?xero_instance_id=${currentXeroInstanceId}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                superFundsData = data.super_funds || [];
                renderSuperFundsTable();
            } else {
                console.error('Error loading super funds:', data.message);
            }
        } catch (error) {
            console.error('Error loading super funds:', error);
        }
    }
    
    function renderSuperFundsTable() {
        const tbody = document.getElementById('superFundsTableBody');
        
        if (superFundsData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        No super funds found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = superFundsData.map(fund => `
            <tr>
                <td>${fund.Name || '-'}</td>
                <td>${fund.Type || '-'}</td>
                <td>${fund.ABN || '-'}</td>
                <td>${fund.USI || '-'}</td>
            </tr>
        `).join('');
    }
    
    async function loadPublicHolidays() {
        const state = stateFilter.value;
        const url = `/core/staff_hours/public_holidays/?state=${state}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                holidaysData = data.holidays || [];
                renderHolidaysTable();
                updateHolidayStats();
            } else {
                console.error('Error loading holidays:', data.message);
            }
        } catch (error) {
            console.error('Error loading holidays:', error);
        }
    }
    
    function renderHolidaysTable() {
        const tbody = document.getElementById('holidaysTableBody');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (holidaysData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        No holidays found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = holidaysData.map(holiday => {
            const holidayDate = new Date(holiday.date);
            const dayName = holidayDate.toLocaleDateString('en-AU', { weekday: 'long' });
            const daysUntil = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));
            const isPast = daysUntil < 0;
            
            return `
                <tr class="${isPast ? 'text-muted' : ''}">
                    <td>${formatDate(holiday.date)}</td>
                    <td>${dayName}</td>
                    <td>${holiday.name}</td>
                    <td>
                        ${isPast 
                            ? '<span class="text-muted">Past</span>' 
                            : daysUntil === 0 
                                ? '<span class="badge bg-success">Today!</span>'
                                : `<span class="badge bg-info">${daysUntil} days</span>`
                        }
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function updateEmployeeStats() {
        const activeCount = employeesData.filter(e => e.status === 'ACTIVE').length;
        document.getElementById('activeEmployeeCount').textContent = activeCount;
        
        // Calculate total leave days available
        let totalLeaveDays = 0;
        leaveData.forEach(leave => {
            totalLeaveDays += leave.balance_days;
        });
        document.getElementById('totalLeaveDays').textContent = totalLeaveDays.toFixed(1);
        
        // On leave count would require additional API call for leave applications
        document.getElementById('onLeaveCount').textContent = '-';
    }
    
    function updateHolidayStats() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const upcomingHolidays = holidaysData.filter(h => new Date(h.date) >= today).length;
        document.getElementById('upcomingHolidays').textContent = upcomingHolidays;
    }
    
    async function viewEmployeeDetail(employeeId) {
        const url = `/core/staff_hours/employee/${employeeId}/?xero_instance_id=${currentXeroInstanceId}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                const emp = data.employee;
                renderEmployeeDetailModal(emp);
                const modal = new bootstrap.Modal(document.getElementById('employeeDetailModal'));
                modal.show();
            } else {
                alert('Error loading employee details: ' + data.message);
            }
        } catch (error) {
            console.error('Error loading employee detail:', error);
            alert('Error loading employee details');
        }
    }
    
    function renderEmployeeDetailModal(emp) {
        const content = document.getElementById('employeeDetailContent');
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Personal Information</h6>
                    <table class="table table-sm">
                        <tr><th>Name</th><td>${emp.FirstName || ''} ${emp.LastName || ''}</td></tr>
                        <tr><th>Email</th><td>${emp.Email || '-'}</td></tr>
                        <tr><th>Phone</th><td>${emp.Phone || '-'}</td></tr>
                        <tr><th>Mobile</th><td>${emp.Mobile || '-'}</td></tr>
                        <tr><th>Date of Birth</th><td>${formatDate(emp.DateOfBirth)}</td></tr>
                        <tr><th>Gender</th><td>${emp.Gender || '-'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Employment Details</h6>
                    <table class="table table-sm">
                        <tr><th>Status</th><td><span class="badge ${emp.Status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${emp.Status || '-'}</span></td></tr>
                        <tr><th>Job Title</th><td>${emp.JobTitle || '-'}</td></tr>
                        <tr><th>Classification</th><td>${emp.Classification || '-'}</td></tr>
                        <tr><th>Start Date</th><td>${formatDate(emp.StartDate)}</td></tr>
                        <tr><th>Termination Date</th><td>${formatDate(emp.TerminationDate) || '-'}</td></tr>
                    </table>
                </div>
            </div>
            
            ${emp.LeaveBalances && emp.LeaveBalances.length > 0 ? `
                <hr>
                <h6 class="text-muted mb-3">Leave Balances</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Leave Type</th>
                            <th>Balance (Hours)</th>
                            <th>Balance (Days)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${emp.LeaveBalances.map(leave => `
                            <tr>
                                <td>${leave.LeaveName || leave.LeaveType || 'Unknown'}</td>
                                <td>${(leave.NumberOfUnits || 0).toFixed(2)}</td>
                                <td>${((leave.NumberOfUnits || 0) / 7.6).toFixed(1)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
            
            ${emp.SuperMemberships && emp.SuperMemberships.length > 0 ? `
                <hr>
                <h6 class="text-muted mb-3">Superannuation</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Super Fund</th>
                            <th>Member Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${emp.SuperMemberships.map(s => `
                            <tr>
                                <td>${s.SuperFundID || '-'}</td>
                                <td>${s.EmployeeNumber || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
        `;
    }
    
    // Utility functions
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            // Handle Xero date format /Date(timestamp)/
            if (dateStr.includes('/Date(')) {
                const timestamp = parseInt(dateStr.match(/\d+/)[0]);
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-AU');
            }
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-AU');
        } catch (e) {
            return dateStr;
        }
    }
    
})();
</script>

<style>
#staffTabs .nav-link {
    color: #6c757d;
}
#staffTabs .nav-link.active {
    color: #0d6efd;
    font-weight: 500;
}
.table th {
    font-weight: 600;
    white-space: nowrap;
}
.badge {
    font-weight: 500;
}
</style>
{% endblock %}
