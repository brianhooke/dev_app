<!--
Template: Staff Hours Module (Section)

Purpose:
Staff hours management interface that integrates with Xero Payroll API.
Included as a section in dashboard.html for SPA navigation.

Backend Endpoints:
- GET /core/staff_hours/employees/ - Fetch all employees
- GET /core/staff_hours/employee/{id}/ - Get employee detail
- GET /core/staff_hours/leave_balances/ - Get leave balances
- GET /core/staff_hours/pay_items/ - Get pay items (earnings rates, etc.)
- GET /core/staff_hours/payroll_calendars/ - Get payroll calendars
- GET /core/staff_hours/super_funds/ - Get super funds
- GET /core/staff_hours/public_holidays/ - Get public holidays from database
-->

<!-- Staff Hours Section -->
<div id="staffHoursSection" style="display: none; flex-direction: column; height: 100%;">
<div class="container-fluid py-4" style="height: 100%; overflow-y: auto;">
    <!-- Google Fonts for Manila Theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

    <!-- Staff Hours Styles -->
    <style>
        /* Manila Folder Theme Colors */
        :root {
            --manila-dark: #b8a888;
            --manila-mid: #d4c4a8;
            --manila-light: #e8dcc8;
            --manila-lighter: #f5efe5;
            --manila-paper: #faf7f2;
            --manila-text: #5c4a32;
            --manila-text-muted: #8b7355;
            --manila-border: #c4b494;
        }
        
        /* Typography */
        #staffHoursSection {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #staffHoursSection h1,
        #staffHoursSection h2,
        #staffHoursSection h3,
        #staffHoursSection h4,
        #staffHoursSection h5,
        #staffHoursSection h6,
        #staffHoursSection .reusable-table-title {
            font-family: 'Merriweather', Georgia, serif;
        }
        #staffTabs .nav-link {
            font-family: 'Merriweather', Georgia, serif;
        }
        
        /* Page Background */
        #staffHoursSection > .container-fluid {
            background: linear-gradient(135deg, var(--manila-lighter) 0%, var(--manila-paper) 100%);
        }
        
        /* Xero Instance Selector */
        .staff-hours-selector {
            margin-bottom: 15px;
            background: var(--manila-paper);
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--manila-border);
            box-shadow: 0 2px 4px rgba(92, 74, 50, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .staff-hours-selector h5 {
            margin: 0;
            color: var(--manila-text);
            font-weight: 600;
            white-space: nowrap;
        }
        .staff-hours-selector select {
            width: 100%;
            max-width: 300px;
            padding: 8px;
            font-size: 13px;
            border: 1px solid var(--manila-border);
            border-radius: 4px;
            background: white;
            color: var(--manila-text);
        }
        .staff-hours-selector .refresh-btn {
            margin-top: 0;
            background: var(--manila-mid);
            border-color: var(--manila-border);
            color: var(--manila-text);
            height: 38px;
            vertical-align: middle;
        }
        .staff-hours-selector .refresh-btn:hover {
            background: var(--manila-dark);
            border-color: var(--manila-dark);
            color: white;
        }
        
        /* Manila Folder Tabs */
        #staffTabs {
            border-bottom: none;
            gap: 4px;
            margin-bottom: 0 !important;
            position: relative;
        }
        #staffTabs .nav-item {
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }
        #staffTabs .nav-link {
            border: 1px solid var(--manila-border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(to bottom, var(--manila-light) 0%, var(--manila-mid) 100%);
            color: var(--manila-text);
            transition: all 0.15s ease;
            margin-bottom: -1px;
        }
        #staffTabs .nav-link:hover {
            background: linear-gradient(to bottom, var(--manila-lighter) 0%, var(--manila-light) 100%);
        }
        #staffTabs .nav-link:focus,
        #staffTabs .nav-link:focus-visible {
            outline: none;
            box-shadow: none;
        }
        #staffTabs .nav-link.active {
            background: var(--manila-paper);
            border-color: var(--manila-border);
            border-bottom: none;
            color: var(--manila-text);
            position: relative;
            z-index: 2;
        }
        #staffTabContent {
            border: 1px solid var(--manila-border);
            border-radius: 0 8px 8px 8px;
            padding: 16px;
            background: var(--manila-paper);
            position: relative;
            overflow: hidden;
            height: calc(100vh - 175px);
        }
        
        /* Table Overrides for Manila Theme */
        #staffHoursSection .reusable-table-container {
            border: 1px solid var(--manila-border);
            border-radius: 6px;
            overflow: hidden;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        #staffHoursSection .reusable-table thead {
            background: linear-gradient(to bottom, var(--manila-light) 0%, var(--manila-mid) 100%);
        }
        #staffHoursSection .reusable-table {
            border: none !important;
        }
        #staffHoursSection .reusable-table thead th {
            color: var(--manila-text);
            border: none !important;
            border-bottom: 1px solid var(--manila-border) !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            box-shadow: none !important;
        }
        #staffHoursSection .reusable-table thead tr {
            border: none !important;
        }
        #staffHoursSection .reusable-table thead {
            border: none !important;
        }
        #staffHoursSection .reusable-table tbody tr {
            background: white;
        }
        #staffHoursSection .reusable-table tbody tr:nth-child(even) {
            background: var(--manila-paper);
        }
        #staffHoursSection .reusable-table tbody tr:hover {
            background: var(--manila-lighter);
        }
        #staffHoursSection .reusable-table tbody td {
            border-bottom: 1px solid var(--manila-border);
            color: var(--manila-text);
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #staffHoursSection .reusable-table thead th {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
        }
        #staffHoursSection .reusable-table-title {
            color: var(--manila-text);
        }
        
        /* Alert/Info boxes */
        #staffHoursSection .alert-info {
            background: var(--manila-lighter);
            border-color: var(--manila-border);
            color: var(--manila-text);
        }
        
        /* Cards for Super Funds, etc. */
        #staffHoursSection .card {
            background: var(--manila-paper);
            border: 1px solid var(--manila-border);
            box-shadow: 0 2px 4px rgba(92, 74, 50, 0.08);
        }
        #staffHoursSection .card-header {
            background: linear-gradient(to bottom, var(--manila-light) 0%, var(--manila-mid) 100%);
            border-bottom: 1px solid var(--manila-border);
            color: var(--manila-text);
        }
        
        /* Calendar Panel Overrides */
        #staffHoursSection .calendar-header {
            background: linear-gradient(to bottom, var(--manila-light) 0%, var(--manila-mid) 100%);
            color: var(--manila-text);
        }
        #staffHoursSection #dayDetailsPanel {
            background: var(--manila-paper);
            border: 1px solid var(--manila-border);
        }
        #staffHoursSection #dayDetailsPanel h6 {
            color: var(--manila-text);
        }
        
        /* Form Controls */
        #staffHoursSection .form-select,
        #staffHoursSection .form-control {
            border-color: var(--manila-border);
            background: white;
            color: var(--manila-text);
        }
        #staffHoursSection .form-select:focus,
        #staffHoursSection .form-control:focus {
            border-color: var(--manila-dark);
            box-shadow: 0 0 0 2px rgba(184, 168, 136, 0.25);
        }
        
        /* Manila-styled dropdowns */
        #staffHoursSection .manila-select {
            border: 1px solid var(--manila-border);
            border-radius: 4px;
            background: white;
            color: var(--manila-text);
            font-size: 13px;
        }
        #staffHoursSection .manila-select:focus {
            border-color: var(--manila-dark);
            box-shadow: 0 0 0 2px rgba(184, 168, 136, 0.25);
            outline: none;
        }
        
        /* Buttons */
        #staffHoursSection .btn-primary {
            background: var(--manila-dark);
            border-color: var(--manila-dark);
            color: white;
        }
        #staffHoursSection .btn-primary:hover {
            background: #a08868;
            border-color: #a08868;
        }
        #staffHoursSection .btn-outline-primary {
            color: var(--manila-text);
            border-color: var(--manila-border);
        }
        #staffHoursSection .btn-outline-primary:hover {
            background: var(--manila-mid);
            border-color: var(--manila-dark);
            color: var(--manila-text);
        }
        
        /* Text colors */
        #staffHoursSection .text-muted {
            color: var(--manila-text-muted) !important;
        }
        
        /* Public Holidays Tab Styling */
        #holidays h5 {
            color: var(--manila-text);
            font-family: 'Merriweather', Georgia, serif;
        }
        #holidays .table-active {
            background: var(--manila-lighter) !important;
        }
        
        /* Sticky headers for holiday tables */
        .holiday-table-wrapper {
            position: relative;
        }
        .holiday-table-wrapper .reusable-table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: visible !important;
        }
        .holiday-table-wrapper .reusable-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--manila-light);
            box-shadow: 0 1px 0 var(--manila-border);
        }
        
        /* Delete buttons - compact and subtle */
        #staffHoursSection .btn-danger.delete-calendar-btn,
        #staffHoursSection .btn-danger.delete-holiday-btn {
            padding: 2px 6px;
            font-size: 10px;
            line-height: 1;
            border-radius: 3px;
            background: transparent;
            border: 1px solid var(--manila-border);
            color: var(--manila-text-muted);
        }
        #staffHoursSection .btn-danger.delete-calendar-btn:hover,
        #staffHoursSection .btn-danger.delete-holiday-btn:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        #staffHoursSection .btn-danger.delete-calendar-btn i,
        #staffHoursSection .btn-danger.delete-holiday-btn i {
            font-size: 10px;
        }
        
        /* Set default button */
        #staffHoursSection .set-default-btn {
            padding: 2px 8px;
            font-size: 10px;
            line-height: 1;
            border-radius: 3px;
            background: var(--manila-light);
            border: 1px solid var(--manila-border);
            color: var(--manila-text);
        }
        #staffHoursSection .set-default-btn:hover {
            background: var(--manila-mid);
        }
        
        /* Success button for Add */
        #staffHoursSection .btn-success {
            background: var(--manila-dark);
            border-color: var(--manila-dark);
            color: white;
            font-size: 12px;
            padding: 4px 12px;
        }
        #staffHoursSection .btn-success:hover {
            background: #a08868;
            border-color: #a08868;
        }
    </style>

    <!-- Xero Instance Selector -->
    <div class="staff-hours-selector">
        <h5>Xero Instance</h5>
        <select id="staffHoursXeroSelect">
            <option value="">Select Xero Instance...</option>
        </select>
        <button id="refreshDataBtn" class="btn btn-outline-primary btn-sm refresh-btn" disabled>
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>

    <!-- Loading Indicator - Paper Shuffle -->
    <div id="loadingIndicator" class="text-center py-5 d-none">
        <style>
            .paper-loader { position: relative; width: 40px; height: 50px; margin: 0 auto; }
            .paper-loader .paper { position: absolute; width: 35px; height: 45px; background: var(--manila-paper); border: 1px solid var(--manila-border); border-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
            .paper-loader .paper:nth-child(1) { animation: paperShuffle1 1.2s ease-in-out infinite; }
            .paper-loader .paper:nth-child(2) { animation: paperShuffle2 1.2s ease-in-out infinite 0.1s; }
            .paper-loader .paper:nth-child(3) { animation: paperShuffle3 1.2s ease-in-out infinite 0.2s; }
            @keyframes paperShuffle1 { 0%, 100% { transform: rotate(-5deg) translateY(0); } 50% { transform: rotate(-5deg) translateY(-10px); } }
            @keyframes paperShuffle2 { 0%, 100% { transform: rotate(0deg) translateY(0); } 50% { transform: rotate(0deg) translateY(-15px); } }
            @keyframes paperShuffle3 { 0%, 100% { transform: rotate(5deg) translateY(0); } 50% { transform: rotate(5deg) translateY(-8px); } }
        </style>
        <div class="paper-loader">
            <div class="paper"></div>
            <div class="paper"></div>
            <div class="paper"></div>
        </div>
        <p class="mt-3" style="color: var(--manila-text); font-family: 'Merriweather', serif; font-size: 14px;">Loading staff data...</p>
    </div>

    <!-- No Instance Selected Message -->
    <div id="noInstanceMessage" class="text-center py-5">
        <i class="fas fa-building fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Select a Xero Instance</h5>
        <p class="text-muted">Choose a Xero instance from the dropdown above to view staff data.</p>
    </div>

    <!-- Main Content (hidden until data loads) -->
    <div id="mainContent" class="d-none">
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="staffTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab">Staff Hours</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">Employees</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">Pay Items</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="holidays-tab" data-bs-toggle="tab" data-bs-target="#holidays" type="button" role="tab">Public Holidays</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="staffTabContent">
            <!-- Employees Tab -->
            <div class="tab-pane fade" id="employees" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="reusable-table-title">Employee List</div>
                    <select id="statusFilter" class="form-select form-select-sm" style="width: auto; height: 24px; font-size: 12px; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--manila-border);">
                        <option value="ACTIVE">Active Only</option>
                        <option value="">All</option>
                        <option value="TERMINATED">Terminated</option>
                    </select>
                </div>
                <div class="reusable-table-container">
                    <table class="reusable-table" id="employeesTable">
                        <colgroup>
                            <col style="width: 15%;">
                            <col style="width: 15%;">
                            <col style="width: 12%;">
                            <col style="width: 13%;">
                            <col style="width: 45%;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Job Title</th>
                                <th>Status</th>
                                <th>Start Date</th>
                                <th>Leave Balance</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                                    No employees loaded
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pay Items Tab -->
            <div class="tab-pane fade" id="payroll" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="reusable-table-title">Pay Items (Earnings Rates)</div>
                </div>
                <div class="alert alert-info py-1 px-2 mb-2" style="font-size: 11px;">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Timesheet-valid rates</strong> are highlighted. Only <em>Ordinary Time</em> and <em>Overtime</em> earnings types with per-unit rates can be used in timesheets.
                </div>
                <div class="reusable-table-container">
                    <table class="reusable-table" id="payItemsTable">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 22%;">
                            <col style="width: 15%;">
                            <col style="width: 13%;">
                            <col style="width: 10%;">
                            <col style="width: 10%;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Rate Type</th>
                                <th>Rate/Unit</th>
                                <th>Account</th>
                                <th style="text-align: center;">Timesheet</th>
                            </tr>
                        </thead>
                        <tbody id="payItemsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                                    No pay items loaded
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Employee Calendar Tab -->
            <div class="tab-pane fade show active" id="calendar" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 me-3">Employee Calendar</h5>
                            <button id="recalcSuperBtn" class="btn btn-sm" style="font-size: 11px; background: var(--manila-accent); color: white; border: none;" title="Recalculate all allocations with super">
                                Recalc Super
                            </button>
                        </div>
                        <div class="d-flex align-items-center">
                            <label class="mb-0" style="color: var(--manila-text); font-size: 14px; font-weight: 500; margin-right: 8px;">Employee:</label>
                            <select id="calendarEmployeeSelect" class="form-select manila-select" style="width: 220px; font-size: 14px; padding: 6px 10px; margin-right: 24px;">
                            </select>
                            <label class="mb-0" style="color: var(--manila-text); font-size: 14px; font-weight: 500; margin-right: 8px;">State:</label>
                            <select id="calendarStateSelect" class="form-select manila-select" style="width: 110px; font-size: 14px; padding: 6px 10px;">
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="SA">SA</option>
                                <option value="WA">WA</option>
                                <option value="TAS">TAS</option>
                                <option value="NT">NT</option>
                                <option value="ACT">ACT</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-3">
                            <!-- Calendar Grid (Left) -->
                            <div class="calendar-left flex-grow-1" style="max-width: 70%;">
                                <!-- Month Navigation - Centered above calendar -->
                                <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                                    <button id="calendarPrevMonth" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="calendarMonthYear" class="fw-bold" style="min-width: 140px; text-align: center; font-family: 'Merriweather', serif; color: var(--manila-text);">January 2026</span>
                                    <button id="calendarNextMonth" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <div id="calendarContainer">
                                    <div id="calendarNoEmployee" class="text-center py-5 text-muted d-none">
                                        <i class="fas fa-user fa-3x mb-3"></i>
                                        <p>Select an employee to view their calendar</p>
                                    </div>
                                    <div id="calendarGrid" class="">
                                        <div class="calendar-header">
                                            <div class="calendar-day-header">Mon</div>
                                            <div class="calendar-day-header">Tue</div>
                                            <div class="calendar-day-header">Wed</div>
                                            <div class="calendar-day-header">Thu</div>
                                            <div class="calendar-day-header">Fri</div>
                                            <div class="calendar-day-header weekend">Sat</div>
                                            <div class="calendar-day-header weekend">Sun</div>
                                        </div>
                                        <div id="calendarBody" class="calendar-body">
                                            <!-- Calendar days populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Calendar Legend -->
                                <div class="calendar-legend mt-3 d-flex gap-3 flex-wrap justify-content-center">
                                    <span class="legend-item"><span class="legend-color bg-success"></span> Worked</span>
                                    <span class="legend-item"><span class="legend-color bg-danger"></span> Sick Leave</span>
                                    <span class="legend-item"><span class="legend-color bg-info"></span> Annual Leave</span>
                                    <span class="legend-item"><span class="legend-color bg-warning"></span> Public Holiday</span>
                                    <span class="legend-item"><span class="legend-color bg-secondary"></span> Weekend</span>
                                </div>
                                
                                <!-- Calendar Summary -->
                                <div id="calendarSummary" class="mt-2 d-none">
                                    <div class="d-flex justify-content-around text-center" style="font-size: 11px;">
                                        <div>
                                            <div class="text-success fw-bold" id="summaryWorkedDays">0</div>
                                            <div class="text-muted">Worked</div>
                                        </div>
                                        <div>
                                            <div class="text-danger fw-bold" id="summarySickDays">0</div>
                                            <div class="text-muted">Sick</div>
                                        </div>
                                        <div>
                                            <div class="text-info fw-bold" id="summaryAnnualDays">0</div>
                                            <div class="text-muted">Annual</div>
                                        </div>
                                        <div>
                                            <div class="text-warning fw-bold" id="summaryHolidays">0</div>
                                            <div class="text-muted">Holidays</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Day Details Panel (Right) -->
                            <div class="calendar-right" style="width: 30%; min-width: 250px; display: flex; flex-direction: column; max-height: calc(100vh - 240px);">
                                <div class="day-details-header" style="background: var(--manila-light); border-radius: 2px; padding: 4px 2px; text-align: center; font-weight: 600; font-size: 0.7rem; color: var(--manila-text); border-bottom: 2px solid var(--manila-border); margin-bottom: 0; margin-top: 47px; flex-shrink: 0;">Day Details</div>
                                <div id="dayDetailsPanel" class="p-1 border rounded" style="background: var(--manila-paper); border-color: var(--manila-border); font-size: 12px; flex: 1; margin-top: 0; overflow-y: auto; min-height: 0;">
                                    <div id="dayDetailsEmpty" class="text-center text-muted py-3">
                                        <i class="fas fa-calendar-day mb-2"></i>
                                        <div>Click a day to view/edit</div>
                                    </div>
                                    <div id="dayDetailsContent" class="d-none">
                                        <div class="fw-bold mb-1" id="selectedDayTitle" style="font-size: 13px;">-</div>
                                        <!-- Status row removed to save space -->
                                        <div id="selectedDayStatus" class="d-none">-</div>
                                        
                                        <!-- Combined Work + Leave Input Section -->
                                        <div id="dayInputSection" class="d-none">
                                            <!-- Work Hours + Allocations grouped together -->
                                            <div id="workAllocationsGroup" style="border: 1px solid #dee2e6; border-radius: 6px; padding: 6px; background: #fafafa;">
                                            <!-- Work Hours Section -->
                                            <div class="mb-1">
                                                <label class="text-muted small fw-bold mb-1 d-block">Work Hours</label>
                                                <div class="work-rows-container" style="border: 1px solid var(--manila-border); border-radius: 4px; max-height: 100px; overflow-y: auto; background: #f8f9fa;">
                                                    <div id="workRowsContainer" style="padding: 4px;">
                                                        <!-- Work rows will be added here dynamically -->
                                                    </div>
                                                </div>
                                                <button type="button" id="addWorkRowBtn" class="btn btn-sm btn-outline-success mt-1" style="font-size: 10px; padding: 2px 6px;">+ Add Work Row</button>
                                            </div>
                                        <!-- Hours Allocation Section (inside work group) -->
                                        <div id="hoursAllocationSection" class="d-none" style="padding-top: 6px; margin-top: 6px; border-top: 1px dashed #ccc;">
                                            <label class="text-muted small fw-bold mb-1 d-block">Allocate Hours</label>
                                            <div class="allocation-table-container" style="border: 1px solid var(--manila-border); border-radius: 4px; max-height: 150px; overflow-y: auto;">
                                                <table id="allocationTable" class="reusable-table w-100" style="font-size: 11px; margin-bottom: 0;">
                                                    <thead>
                                                        <tr>
                                                            <th style="padding: 4px 3px; text-align: left; width: 85px;">Type</th>
                                                            <th style="padding: 4px 3px; text-align: left;">Details</th>
                                                            <th style="padding: 4px 3px; text-align: center; width: 45px;">Hrs</th>
                                                            <th style="padding: 4px 3px; width: 20px;"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="allocationRows">
                                                        <!-- Allocation rows inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="allocationEditControls">
                                                <div class="d-flex justify-content-between align-items-center mt-1">
                                                    <button id="addAllocationRowBtn" class="btn btn-sm p-1 px-2" style="font-size: 10px; background: #28a745; color: white; border: none;">+ Add Row</button>
                                                    <div class="small">
                                                        <span id="allocatedHours" class="fw-bold">0</span>/<span id="totalDayHours">0</span>h
                                                    </div>
                                                </div>
                                                <button id="saveAllocationsBtn" class="btn btn-sm w-100 mt-1" style="font-size: 11px; padding: 4px; background: #6c757d; color: white; border: none;" disabled>Save Allocations</button>
                                            </div>
                                            <div id="allocationDisplayControls" class="d-none">
                                                <div class="d-flex justify-content-between align-items-center mt-2">
                                                    <button id="updateAllocationsBtn" class="btn btn-sm p-1 px-2" style="font-size: 11px; background: #fd7e14; color: white; border: none;">Update</button>
                                                    <div class="small">
                                                        <span id="allocatedHoursDisplay" class="fw-bold">0</span>/<span id="totalDayHoursDisplay">0</span>h
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Daily Cost Display -->
                                            <div id="dailyCostDisplay" class="mt-2 pt-2 d-none" style="border-top: 1px dashed var(--manila-border);">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="text-muted small">Wages:</span>
                                                    <span id="wagesCostAmount" class="small" style="color: var(--manila-text);">$0.00</span>
                                                </div>
                                                <div id="superRow" class="d-flex justify-content-between align-items-center mb-1 d-none">
                                                    <span class="text-muted small">Super (<span id="superRateDisplay">0</span>%):</span>
                                                    <span id="superAmount" class="small" style="color: var(--manila-text);">$0.00</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center pt-1" style="border-top: 1px solid var(--manila-border);">
                                                    <span class="text-muted small fw-bold">Daily Total:</span>
                                                    <span id="dailyCostAmount" class="fw-bold" style="color: var(--manila-text);">$0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        </div><!-- Close workAllocationsGroup -->
                                        </div><!-- Close dayInputSection -->
                                        
                                        <!-- Display Section (read-only for saved days) -->
                                        <div id="dayDisplaySection" class="d-none">
                                            <div id="workDisplayRow" class="mb-1 d-none">
                                                <span class="text-muted small">Work:</span>
                                                <span id="selectedDayRate" class="small">-</span> -
                                                <span id="selectedDayHours" class="fw-bold">0</span>h
                                                <span class="text-muted small">@ $<span id="selectedDayPayRate">0</span>/hr</span>
                                                <button id="deleteWorkBtn" class="btn btn-sm btn-link text-danger p-0 ms-2" style="font-size: 11px;" title="Delete work hours"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                            <!-- Allocation Display (read-only) -->
                                            <div id="allocationDisplaySection" class="mb-1 d-none" style="border: 1px solid #dee2e6; border-radius: 4px; padding: 4px; background: #f8f9fa;">
                                                <div class="text-muted small fw-bold mb-1">Allocations:</div>
                                                <div id="allocationDisplayList" style="font-size: 11px;">
                                                    <!-- Allocation items will be inserted here -->
                                                </div>
                                            </div>
                                            <div id="leaveDisplayRow" class="mb-1 d-none">
                                                <span class="text-muted small">Leave:</span>
                                                <span id="selectedLeaveType" class="small">-</span> -
                                                <span id="selectedLeaveHours" class="fw-bold">0</span>h
                                                <button id="deleteLeaveBtn" class="btn btn-sm btn-link text-danger p-0 ms-2" style="font-size: 11px;" title="Delete leave"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                            <button id="editDayBtn" class="btn btn-sm btn-outline-primary mt-2" style="font-size: 11px;">Edit</button>
                                        </div>
                                        
                                        <!-- Leave Section (below allocations) -->
                                        <div id="leaveSection" class="d-none" style="border-top: 1px solid var(--manila-border); padding-top: 4px; margin-top: 4px;">
                                            <label class="text-muted small fw-bold mb-1 d-block">Leave</label>
                                            <div class="leave-rows-container" style="border: 1px solid var(--manila-border); border-radius: 4px; max-height: 100px; overflow-y: auto; background: #e8f4f8;">
                                                <div id="leaveRowsContainer" style="padding: 4px;">
                                                    <!-- Leave rows will be added here dynamically -->
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                <button type="button" id="addLeaveRowBtn" class="btn btn-sm p-1 px-2" style="font-size: 10px; background: #17a2b8; color: white; border: none;">+ Add Row</button>
                                                <button id="saveLeaveBtn" class="btn btn-sm" style="font-size: 10px; padding: 2px 8px; background: #6c757d; color: white; border: none;" disabled>Save Leave</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Public Holidays Tab -->
            <div class="tab-pane fade" id="holidays" role="tabpanel">
                <div style="display: flex; gap: 16px; height: 100%;">
                    <!-- Left: Calendars List (35%) -->
                    <div style="width: 35%; display: flex; flex-direction: column;">
                        <h5 style="margin: 0 0 8px 0; font-weight: 600;">Holiday Calendars</h5>
                        <div class="reusable-table-container holiday-table-wrapper" style="flex: 1; overflow-y: auto;">
                                <table id="holidayCalendarsTable" class="reusable-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%; text-align: left;">Name</th>
                                            <th style="width: 18%; text-align: left;">State</th>
                                            <th style="width: 15%; text-align: center;">Default</th>
                                            <th style="width: 17%; text-align: center;">Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody id="holidayCalendarsTableBody">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--manila-text-muted);">
                                                Loading...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; flex-shrink: 0;">
                            <input type="text" id="newCalendarName" class="form-control form-control-sm" placeholder="Calendar name" style="flex: 1;">
                            <select id="newCalendarState" class="form-control form-control-sm" style="width: 80px;">
                                <option value="NAT">National</option>
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="SA">SA</option>
                                <option value="WA">WA</option>
                                <option value="TAS">TAS</option>
                                <option value="NT">NT</option>
                                <option value="ACT">ACT</option>
                            </select>
                            <button id="addCalendarBtn" class="btn btn-sm btn-success">Add</button>
                        </div>
                    </div>
                    
                    <!-- Right: Holidays in Selected Calendar (65%) -->
                    <div style="width: 65%; display: flex; flex-direction: column;">
                        <h5 style="margin: 0 0 8px 0; font-weight: 600;">Holidays in: <span id="selectedCalendarName" style="color: var(--manila-dark);">Select a calendar</span></h5>
                        <div class="reusable-table-container holiday-table-wrapper" style="flex: 1; overflow-y: auto;">
                                <table id="holidaysTable" class="reusable-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%; text-align: left;">Holiday Name</th>
                                            <th style="width: 25%; text-align: left;">Date</th>
                                            <th style="width: 15%; text-align: left;">Day</th>
                                            <th style="width: 10%; text-align: center;">Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody id="holidaysTableBody">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--manila-text-muted);">
                                                Select a calendar to view holidays
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                        <div id="addHolidayRow" style="display: none; gap: 8px; margin-top: 8px; flex-shrink: 0;">
                            <input type="text" id="newHolidayName" class="form-control form-control-sm" placeholder="Holiday name" style="flex: 1;">
                            <input type="date" id="newHolidayDate" class="form-control form-control-sm" style="width: 150px;">
                            <button id="addHolidayBtn" class="btn btn-sm btn-success">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // State
    let currentXeroInstanceId = null;
    let employeesData = [];
    let leaveData = [];
    let payItemsData = {};
    let superFundsData = [];
    let holidaysData = [];
    
    // DOM Elements
    const xeroInstanceSelect = document.getElementById('staffHoursXeroSelect');
    const refreshDataBtn = document.getElementById('refreshDataBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noInstanceMessage = document.getElementById('noInstanceMessage');
    const mainContent = document.getElementById('mainContent');
    const statusFilter = document.getElementById('statusFilter');
    
    // Allocation type constants
    const ALLOC_TYPE = {
        PROJECT: 1,
        UNCHARGEABLE: 2,
        OTHER_CHARGEABLE: 3
    };
    
    // Standardized error message extraction
    function getErrorMessage(error, fallback = 'An error occurred') {
        if (!error) return fallback;
        if (typeof error === 'string') return error;
        if (error.message) return error.message;
        if (error.error) return error.error;
        return fallback;
    }
    
    // Standardized fetch wrapper with CSRF handling
    async function staffHoursApi(url, options = {}) {
        const config = {
            headers: { 'Content-Type': 'application/json' },
            ...options
        };
        if (options.method && options.method !== 'GET') {
            config.headers['X-CSRFToken'] = Utils.getCSRFToken();
        }
        if (options.body && typeof options.body === 'object') {
            config.body = JSON.stringify(options.body);
        }
        const response = await fetch(url, config);
        return response.json();
    }
    
    // Initialize Staff Hours section - called when section is shown
    window.initStaffHoursSection = function() {
        // Apply manila theme to parent container
        const dynamicContentArea = document.getElementById('dynamicContentArea');
        if (dynamicContentArea) {
            dynamicContentArea.style.background = 'linear-gradient(135deg, #f5efe5 0%, #faf7f2 100%)';
        }
        
        // Populate xero instances dropdown from dashboard's global data
        // Only show instances where staff_hours_tracking=1
        if (window.xeroInstancesData && xeroInstanceSelect) {
            // Clear existing options
            xeroInstanceSelect.innerHTML = '';
            
            // Filter to only instances with staff_hours_tracking=1
            const staffHoursInstances = window.xeroInstancesData.filter(
                instance => instance.staff_hours_tracking === 1
            );
            
            // Add filtered instances to dropdown
            staffHoursInstances.forEach(function(instance) {
                const option = document.createElement('option');
                option.value = instance.xero_instance_pk;
                option.textContent = instance.xero_name;
                xeroInstanceSelect.appendChild(option);
            });
            
            // Setup event listeners first
            setupEventListeners();
            
            // Auto-select first instance and load its data
            if (staffHoursInstances.length > 0) {
                xeroInstanceSelect.value = staffHoursInstances[0].xero_instance_pk;
                xeroInstanceSelect.dispatchEvent(new Event('change'));
            }
        }
    };
    
    function setupEventListeners() {
        // Initialize Bootstrap tabs manually (needed for SPA context)
        document.querySelectorAll('#staffTabs button[data-bs-toggle="tab"]').forEach(function(tabBtn) {
            tabBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-bs-target');
                
                // Remove active from all tabs and panes
                document.querySelectorAll('#staffTabs .nav-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#staffTabContent .tab-pane').forEach(p => {
                    p.classList.remove('show', 'active');
                });
                
                // Add active to clicked tab and target pane
                this.classList.add('active');
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            });
        });
        
        // Xero instance change
        xeroInstanceSelect.addEventListener('change', function() {
            currentXeroInstanceId = this.value;
            if (currentXeroInstanceId) {
                refreshDataBtn.disabled = false;
                loadAllData();
            } else {
                refreshDataBtn.disabled = true;
                showNoInstanceMessage();
            }
        });
        
        // Refresh button
        refreshDataBtn.addEventListener('click', function() {
            if (currentXeroInstanceId) {
                loadAllData();
            }
        });
        
        // Status filter change
        statusFilter.addEventListener('change', function() {
            loadEmployees();
        });
    }
    
    function showLoading() {
        loadingIndicator.classList.remove('d-none');
        noInstanceMessage.classList.add('d-none');
        mainContent.classList.add('d-none');
    }
    
    function hideLoading() {
        loadingIndicator.classList.add('d-none');
    }
    
    function showMainContent() {
        mainContent.classList.remove('d-none');
        noInstanceMessage.classList.add('d-none');
    }
    
    function showNoInstanceMessage() {
        noInstanceMessage.classList.remove('d-none');
        mainContent.classList.add('d-none');
    }
    
    async function loadAllData() {
        showLoading();
        
        try {
            await Promise.all([
                loadEmployees(),
                loadPayItems(),
                loadPublicHolidays()
            ]);
            
            hideLoading();
            showMainContent();
        } catch (error) {
            hideLoading();
            alert('Error loading data from Xero. Please try again.');
        }
    }
    
    async function loadEmployees() {
        const status = statusFilter.value;
        const url = `/core/staff_hours/employees/?xero_instance_id=${currentXeroInstanceId}&status=${status}`;
        
        const data = await staffHoursApi(url);
        if (data.status === 'success') {
            employeesData = data.employees;
            renderEmployeesTable();
            extractLeaveData();
            populateCalendarEmployeeDropdown();
            syncPayRates();
        }
    }
    
    async function syncPayRates() {
        try {
            await staffHoursApi('/core/staff_hours/sync_pay_rates/', {
                method: 'POST',
                body: { xero_instance_id: currentXeroInstanceId }
            });
        } catch (error) {
            // Silently fail - pay rate sync is non-critical
        }
    }
    
    function extractLeaveData() {
        leaveData = [];
        employeesData.forEach(emp => {
            if (emp.leave_balances && emp.leave_balances.length > 0) {
                emp.leave_balances.forEach(leave => {
                    leaveData.push({
                        employee_name: `${emp.first_name} ${emp.last_name}`,
                        employee_id: emp.employee_id,
                        leave_type: leave.LeaveName || leave.LeaveType || 'Unknown',
                        balance_hours: leave.NumberOfUnits || 0,
                        balance_days: (leave.NumberOfUnits || 0) / 7.6 // Assuming 7.6 hour day
                    });
                });
            }
        });
    }
    
    function renderEmployeesTable() {
        const tbody = document.getElementById('employeesTableBody');
        
        if (employeesData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                        No employees found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = employeesData.map(emp => {
            // Calculate total leave balance (sum all leave types)
            let leaveDisplay = '-';
            if (emp.leave_balances && emp.leave_balances.length > 0) {
                const leaveItems = emp.leave_balances.map(leave => {
                    const days = ((leave.NumberOfUnits || 0) / 7.6).toFixed(1);
                    const name = (leave.LeaveName || leave.LeaveType || 'Leave').replace(/Leave/gi, '').trim();
                    return `${name}: ${days}d`;
                });
                leaveDisplay = leaveItems.join(' | ');
            }
            
            const statusColor = emp.status === 'ACTIVE' ? 'var(--color-success)' : 'var(--color-text-muted)';
            
            return `
            <tr data-employee-id="${emp.employee_id}">
                <td>${emp.first_name || ''} ${emp.last_name || ''}</td>
                <td>${emp.job_title || '-'}</td>
                <td style="color: ${statusColor};">${emp.status || 'Unknown'}</td>
                <td>${formatDate(emp.start_date)}</td>
                <td>${leaveDisplay}</td>
            </tr>
        `}).join('');
    }
    
    async function loadPayItems() {
        const url = `/core/staff_hours/pay_items/?xero_instance_id=${currentXeroInstanceId}`;
        const data = await staffHoursApi(url);
        if (data.status === 'success') {
            payItemsData = {
                earnings_rates: data.earnings_rates || [],
                deduction_types: data.deduction_types || [],
                leave_types: data.leave_types || []
            };
            renderPayItemsTable();
        }
    }
    
    function renderPayItemsTable() {
        const tbody = document.getElementById('payItemsTableBody');
        const earningsRates = payItemsData.earnings_rates || [];
        
        if (earningsRates.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--color-text-muted);">
                        No pay items found
                    </td>
                </tr>
            `;
            return;
        }
        
        // Timesheet-valid types
        const timesheetValidTypes = ['ORDINARYTIMEEARNINGS', 'OVERTIMEEARNINGS'];
        
        // Sort: timesheet-valid first, then alphabetically by name
        const sortedRates = [...earningsRates].sort((a, b) => {
            const aValid = (a.CurrentRecord !== false) && (a.RateType !== 'FIXEDAMOUNT') && timesheetValidTypes.includes(a.EarningsType);
            const bValid = (b.CurrentRecord !== false) && (b.RateType !== 'FIXEDAMOUNT') && timesheetValidTypes.includes(b.EarningsType);
            
            if (aValid && !bValid) return -1;
            if (!aValid && bValid) return 1;
            return (a.Name || '').localeCompare(b.Name || '');
        });
        
        tbody.innerHTML = sortedRates.map(item => {
            const isActive = item.CurrentRecord !== false;
            const isValidRateType = item.RateType !== 'FIXEDAMOUNT';
            const isTimesheetType = timesheetValidTypes.includes(item.EarningsType);
            const isTimesheetValid = isActive && isValidRateType && isTimesheetType;
            
            const rowStyle = isTimesheetValid ? 'background: rgba(25, 135, 84, 0.08);' : 'opacity: 0.6;';
            const timesheetIcon = isTimesheetValid 
                ? '<span style="color: var(--color-success);" title="Valid for timesheets"><i class="fas fa-check-circle"></i></span>'
                : '<span style="color: var(--color-text-muted);" title="Not valid for timesheets"><i class="fas fa-minus-circle"></i></span>';
            
            return `
            <tr style="${rowStyle}">
                <td>${item.Name || '-'}</td>
                <td>${item.EarningsType || '-'}</td>
                <td>${item.RateType || '-'}</td>
                <td>${item.RatePerUnit ? '$' + parseFloat(item.RatePerUnit).toFixed(2) : '-'}</td>
                <td>${item.AccountCode || '-'}</td>
                <td style="text-align: center;">${timesheetIcon}</td>
            </tr>
        `}).join('');
    }
    
    async function loadSuperFunds() {
        try {
            const data = await staffHoursApi(`/core/staff_hours/super_funds/?xero_instance_id=${currentXeroInstanceId}`);
            if (data.status === 'success') {
                superFundsData = data.super_funds || [];
                renderSuperFundsTable();
            }
        } catch (error) {
            // Silently fail
        }
    }
    
    function renderSuperFundsTable() {
        const tbody = document.getElementById('superFundsTableBody');
        
        if (superFundsData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        No super funds found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = superFundsData.map(fund => `
            <tr>
                <td>${fund.Name || '-'}</td>
                <td>${fund.Type || '-'}</td>
                <td>${fund.ABN || '-'}</td>
                <td>${fund.USI || '-'}</td>
            </tr>
        `).join('');
    }
    
    // ============================================
    // PUBLIC HOLIDAYS / CALENDAR MANAGEMENT
    // ============================================
    let holidayCalendarsLoaded = false;
    let selectedCalendarPk = null;
    
    async function loadPublicHolidays() {
        loadHolidayCalendars();
    }
    
    async function loadHolidayCalendars() {
        const tbody = document.getElementById('holidayCalendarsTableBody');
        
        try {
            const response = await staffHoursApi('/core/staff_hours/holiday_calendars/');
            holidayCalendarsLoaded = true;
            tbody.innerHTML = '';
            
            if (!response.calendars || response.calendars.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--manila-text-muted);">No calendars. Add one below.</td></tr>';
                return;
            }
            
            response.calendars.forEach(cal => {
                const row = document.createElement('tr');
                row.dataset.calendarPk = cal.calendar_pk;
                row.style.cursor = 'pointer';
                row.innerHTML = `
                    <td>${Utils.escapeHtml(cal.name)} <span style="color: var(--manila-text-muted); font-size: 0.85em;">(${cal.holiday_count})</span></td>
                    <td>${cal.state}</td>
                    <td style="text-align: center;">${cal.is_default ? '<i class="fas fa-check text-success"></i>' : '<button class="btn btn-xs btn-outline-secondary set-default-btn" data-calendar-pk="' + cal.calendar_pk + '">Set</button>'}</td>
                    <td style="text-align: center;"><button class="btn btn-xs btn-danger delete-calendar-btn" data-calendar-pk="${cal.calendar_pk}" data-calendar-name="${Utils.escapeHtml(cal.name)}"><i class="fas fa-times"></i></button></td>
                `;
                tbody.appendChild(row);
            });
            
            if (!selectedCalendarPk && response.calendars.length > 0) {
                selectCalendar(response.calendars[0].calendar_pk, response.calendars[0].name);
            }
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545; padding: 20px;">Error loading calendars</td></tr>';
        }
    }
    
    function selectCalendar(calendarPk, calendarName) {
        selectedCalendarPk = calendarPk;
        document.getElementById('selectedCalendarName').textContent = calendarName;
        document.getElementById('addHolidayRow').style.display = 'flex';
        
        // Highlight selected row
        document.querySelectorAll('#holidayCalendarsTableBody tr').forEach(r => r.classList.remove('table-active'));
        const selectedRow = document.querySelector(`#holidayCalendarsTableBody tr[data-calendar-pk="${calendarPk}"]`);
        if (selectedRow) selectedRow.classList.add('table-active');
        
        loadCalendarHolidays(calendarPk);
    }
    
    async function loadCalendarHolidays(calendarPk) {
        const tbody = document.getElementById('holidaysTableBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Loading...</td></tr>';
        
        try {
            const response = await staffHoursApi(`/core/staff_hours/holiday_calendars/${calendarPk}/holidays/`);
            tbody.innerHTML = '';
            
            if (!response.holidays || response.holidays.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--manila-text-muted);">No holidays. Add one below.</td></tr>';
                return;
            }
            
            response.holidays.forEach(h => {
                const date = new Date(h.date);
                const dayName = date.toLocaleDateString('en-AU', { weekday: 'long' });
                const dateFormatted = date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
                
                const row = document.createElement('tr');
                row.dataset.holidayPk = h.holiday_pk;
                row.innerHTML = `
                    <td>${Utils.escapeHtml(h.name)}</td>
                    <td>${dateFormatted}</td>
                    <td>${dayName}</td>
                    <td style="text-align: center;"><button class="btn btn-xs btn-danger delete-holiday-btn" data-holiday-pk="${h.holiday_pk}" data-holiday-name="${Utils.escapeHtml(h.name)}"><i class="fas fa-times"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #dc3545; padding: 20px;">Error loading holidays</td></tr>';
        }
    }
    
    
    // Calendar row click handler
    document.addEventListener('click', function(e) {
        const calendarRow = e.target.closest('#holidayCalendarsTableBody tr');
        if (calendarRow && !e.target.closest('button')) {
            const calendarPk = calendarRow.dataset.calendarPk;
            const calendarName = calendarRow.querySelector('td:first-child').textContent.replace(/\s*\(\d+\)$/, '');
            if (calendarPk) {
                selectCalendar(calendarPk, calendarName);
            }
        }
        
        // Set default button
        if (e.target.closest('.set-default-btn')) {
            const btn = e.target.closest('.set-default-btn');
            const calendarPk = btn.dataset.calendarPk;
            
            staffHoursApi(`/core/staff_hours/holiday_calendars/${calendarPk}/update/`, {
                method: 'POST',
                body: { is_default: 1 }
            }).then(response => {
                if (response.status === 'success') {
                    loadHolidayCalendars();
                } else {
                    alert('Error: ' + getErrorMessage(response));
                }
            });
        }
        
        // Delete calendar button
        if (e.target.closest('.delete-calendar-btn')) {
            const btn = e.target.closest('.delete-calendar-btn');
            const calendarPk = btn.dataset.calendarPk;
            const calendarName = btn.dataset.calendarName;
            
            if (!confirm(`Delete calendar "${calendarName}" and all its holidays?`)) return;
            
            staffHoursApi(`/core/staff_hours/holiday_calendars/${calendarPk}/delete/`, {
                method: 'DELETE'
            }).then(response => {
                if (response.status === 'success') {
                    if (selectedCalendarPk == calendarPk) {
                        selectedCalendarPk = null;
                        document.getElementById('selectedCalendarName').textContent = 'Select a calendar';
                        document.getElementById('addHolidayRow').style.display = 'none';
                        document.getElementById('holidaysTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--manila-text-muted);">Select a calendar to view holidays</td></tr>';
                    }
                    loadHolidayCalendars();
                } else {
                    alert('Error: ' + getErrorMessage(response));
                }
            });
        }
        
        // Delete holiday button
        if (e.target.closest('.delete-holiday-btn')) {
            const btn = e.target.closest('.delete-holiday-btn');
            const holidayPk = btn.dataset.holidayPk;
            const holidayName = btn.dataset.holidayName;
            
            if (!confirm(`Delete holiday "${holidayName}"?`)) return;
            
            staffHoursApi(`/core/staff_hours/holidays/${holidayPk}/delete/`, {
                method: 'DELETE'
            }).then(response => {
                if (response.status === 'success') {
                    loadCalendarHolidays(selectedCalendarPk);
                    holidayCalendarsLoaded = false;
                    loadHolidayCalendars();
                } else {
                    alert('Error: ' + getErrorMessage(response));
                }
            });
        }
    });
    
    // Add calendar button
    const addCalendarBtn = document.getElementById('addCalendarBtn');
    if (addCalendarBtn) {
        addCalendarBtn.addEventListener('click', function() {
            const name = document.getElementById('newCalendarName').value.trim();
            const state = document.getElementById('newCalendarState').value;
            
            if (!name) {
                alert('Please enter a calendar name');
                return;
            }
            
            staffHoursApi('/core/staff_hours/holiday_calendars/create/', {
                method: 'POST',
                body: { name: name, state: state }
            }).then(response => {
                if (response.status === 'success') {
                    document.getElementById('newCalendarName').value = '';
                    loadHolidayCalendars();
                    selectCalendar(response.calendar.calendar_pk, response.calendar.name);
                } else {
                    alert('Error: ' + getErrorMessage(response));
                }
            });
        });
    }
    
    // Add holiday button
    const addHolidayBtn = document.getElementById('addHolidayBtn');
    if (addHolidayBtn) {
        addHolidayBtn.addEventListener('click', function() {
            if (!selectedCalendarPk) {
                alert('Please select a calendar first');
                return;
            }
            
            const name = document.getElementById('newHolidayName').value.trim();
            const date = document.getElementById('newHolidayDate').value;
            
            if (!name || !date) {
                alert('Please enter holiday name and date');
                return;
            }
            
            staffHoursApi(`/core/staff_hours/holiday_calendars/${selectedCalendarPk}/holidays/create/`, {
                method: 'POST',
                body: { name: name, date: date }
            }).then(response => {
                if (response.status === 'success') {
                    document.getElementById('newHolidayName').value = '';
                    document.getElementById('newHolidayDate').value = '';
                    loadCalendarHolidays(selectedCalendarPk);
                    holidayCalendarsLoaded = false;
                    loadHolidayCalendars();
                } else {
                    alert('Error: ' + getErrorMessage(response));
                }
            });
        });
    }
    
    // Utility functions
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let date;
            
            // Handle Xero date format /Date(timestamp)/
            if (dateStr.includes('/Date(')) {
                const timestamp = parseInt(dateStr.match(/\d+/)[0]);
                date = new Date(timestamp);
            } else {
                date = new Date(dateStr);
            }
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = String(date.getFullYear()).slice(-2);
            return `${day}-${month}-${year}`;
        } catch (e) {
            return dateStr;
        }
    }
    
    // ============================================
    // EMPLOYEE CALENDAR FUNCTIONALITY
    // ============================================
    
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth() + 1; // 1-12
    let calendarData = null;
    let calendarLeaveTypes = {};
    
    const calendarEmployeeSelect = document.getElementById('calendarEmployeeSelect');
    const calendarStateSelect = document.getElementById('calendarStateSelect');
    const calendarPrevMonth = document.getElementById('calendarPrevMonth');
    const calendarNextMonth = document.getElementById('calendarNextMonth');
    const calendarMonthYear = document.getElementById('calendarMonthYear');
    const calendarBody = document.getElementById('calendarBody');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarNoEmployee = document.getElementById('calendarNoEmployee');
    const calendarSummary = document.getElementById('calendarSummary');
    
    // Setup calendar event listeners
    function setupCalendarEventListeners() {
        // Recalc Super button
        const recalcSuperBtn = document.getElementById('recalcSuperBtn');
        if (recalcSuperBtn) {
            recalcSuperBtn.addEventListener('click', async function() {
                if (!currentXeroInstanceId) {
                    alert('Please select a Xero instance first');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Calculating...';
                
                try {
                    const data = await staffHoursApi(`/core/staff_hours/allocations/super-summary/?xero_instance_id=${currentXeroInstanceId}`);
                    
                    if (data.status === 'success') {
                        alert(`Super Recalculation Complete!\n\n` +
                            `Total Allocations: ${data.total_allocations}\n` +
                            `Total Hours: ${data.total_hours}\n` +
                            `Wages: $${data.total_wages.toLocaleString('en-AU', {minimumFractionDigits: 2})}\n` +
                            `Super: $${data.total_super.toLocaleString('en-AU', {minimumFractionDigits: 2})}\n` +
                            `Total Cost (incl. super): $${data.total_cost.toLocaleString('en-AU', {minimumFractionDigits: 2})}\n\n` +
                            `All project labour costs now include superannuation.`);
                    } else {
                        alert('Error: ' + getErrorMessage(data));
                    }
                } catch (e) {
                    alert('Error: ' + getErrorMessage(e, 'Failed to recalculate super'));
                } finally {
                    this.disabled = false;
                    this.textContent = 'Recalc Super';
                }
            });
        }
        
        if (calendarEmployeeSelect) {
            calendarEmployeeSelect.addEventListener('change', function() {
                if (this.value) {
                    loadCalendarData();
                } else {
                    showCalendarNoEmployee();
                }
            });
        }
        
        if (calendarStateSelect) {
            calendarStateSelect.addEventListener('change', function() {
                if (calendarEmployeeSelect.value) {
                    loadCalendarData();
                }
            });
        }
        
        if (calendarPrevMonth) {
            calendarPrevMonth.addEventListener('click', function() {
                calendarMonth--;
                if (calendarMonth < 1) {
                    calendarMonth = 12;
                    calendarYear--;
                }
                if (calendarEmployeeSelect.value) {
                    loadCalendarData();
                } else {
                    updateCalendarMonthDisplay();
                }
            });
        }
        
        if (calendarNextMonth) {
            calendarNextMonth.addEventListener('click', function() {
                calendarMonth++;
                if (calendarMonth > 12) {
                    calendarMonth = 1;
                    calendarYear++;
                }
                if (calendarEmployeeSelect.value) {
                    loadCalendarData();
                } else {
                    updateCalendarMonthDisplay();
                }
            });
        }
    }
    
    // Call setup after main event listeners and render empty calendar
    setTimeout(function() {
        setupCalendarEventListeners();
        updateCalendarMonthDisplay();
        renderCalendar();
    }, 100);
    
    function updateCalendarMonthDisplay() {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        if (calendarMonthYear) {
            calendarMonthYear.textContent = `${monthNames[calendarMonth - 1]} ${calendarYear}`;
        }
    }
    
    function showCalendarNoEmployee() {
        if (calendarNoEmployee) calendarNoEmployee.classList.remove('d-none');
        if (calendarGrid) calendarGrid.classList.add('d-none');
        if (calendarSummary) calendarSummary.classList.add('d-none');
    }
    
    function showCalendarGrid() {
        if (calendarNoEmployee) calendarNoEmployee.classList.add('d-none');
        if (calendarGrid) calendarGrid.classList.remove('d-none');
        if (calendarSummary) calendarSummary.classList.remove('d-none');
    }
    
    // Populate calendar employee dropdown when employees data loads
    function populateCalendarEmployeeDropdown() {
        if (!calendarEmployeeSelect) return;
        
        calendarEmployeeSelect.innerHTML = '';
        let firstEmployeeId = null;
        employeesData.forEach(emp => {
            if (emp.status === 'ACTIVE') {
                const option = document.createElement('option');
                option.value = emp.employee_id;
                option.textContent = `${emp.first_name} ${emp.last_name}`;
                calendarEmployeeSelect.appendChild(option);
                if (!firstEmployeeId) firstEmployeeId = emp.employee_id;
            }
        });
        
        // Auto-select first employee and load calendar
        if (firstEmployeeId) {
            calendarEmployeeSelect.value = firstEmployeeId;
            loadCalendarData();
        }
    }
    
    async function loadCalendarData() {
        const employeeId = calendarEmployeeSelect.value;
        const state = calendarStateSelect.value;
        
        if (!employeeId || !currentXeroInstanceId) return;
        
        updateCalendarMonthDisplay();
        
        const url = `/core/staff_hours/employee_calendar/?xero_instance_id=${currentXeroInstanceId}&employee_id=${employeeId}&year=${calendarYear}&month=${calendarMonth}&state=${state}`;
        
        try {
            const data = await staffHoursApi(url);
            if (data.status === 'success') {
                calendarData = data;
                calendarLeaveTypes = data.leave_types || {};
            } else {
                calendarData = { public_holidays: [], worked_days: [], leave_days: [] };
            }
        } catch (error) {
            calendarData = { public_holidays: [], worked_days: [], leave_days: [] };
        }
        renderCalendar();
        showCalendarGrid();
        autoSelectToday();
    }
    
    // Auto-select today's date if visible in current month
    function autoSelectToday() {
        const todayElement = document.querySelector('.calendar-day.today');
        if (todayElement && todayElement.dataset.dayinfo) {
            window.selectCalendarDay(todayElement);
        }
    }
    
    // Refresh calendar and re-select the same day
    async function refreshCalendarAndSelectDay(dateStr) {
        await loadCalendarData();
        const dayElement = document.querySelector(`.calendar-day[data-dayinfo*='"date":"${dateStr}"']`);
        if (dayElement) window.selectCalendarDay(dayElement);
    }
    
    function renderCalendar() {
        if (!calendarBody) return;
        
        // Get first day of month and number of days
        const firstDay = new Date(calendarYear, calendarMonth - 1, 1);
        const lastDay = new Date(calendarYear, calendarMonth, 0);
        const daysInMonth = lastDay.getDate();
        
        // Monday = 0, Sunday = 6 (adjusted from JS default)
        let startDayOfWeek = firstDay.getDay() - 1;
        if (startDayOfWeek < 0) startDayOfWeek = 6;
        
        // Build lookup maps for quick access
        const holidayMap = {};
        const workedMap = {};
        const leaveMap = {};
        
        if (calendarData) {
            (calendarData.public_holidays || []).forEach(h => {
                holidayMap[h.date] = h.name;
            });
            
            (calendarData.worked_days || []).forEach(w => {
                if (!workedMap[w.date]) {
                    workedMap[w.date] = { hours: 0, earnings_rate_id: w.earnings_rate_id };
                }
                workedMap[w.date].hours += w.hours;
            });
            
            (calendarData.leave_days || []).forEach(l => {
                leaveMap[l.date] = l;
            });
        }
        
        // Summary counters
        let workedCount = 0;
        let sickCount = 0;
        let annualCount = 0;
        let holidayCount = Object.keys(holidayMap).length;
        
        // Build calendar HTML
        let html = '';
        let dayCounter = 1;
        const totalCells = Math.ceil((daysInMonth + startDayOfWeek) / 7) * 7;
        
        for (let i = 0; i < totalCells; i++) {
            if (i % 7 === 0) html += '<div class="calendar-week">';
            
            const isWeekend = (i % 7 === 5) || (i % 7 === 6);
            
            if (i < startDayOfWeek || dayCounter > daysInMonth) {
                html += '<div class="calendar-day empty"></div>';
            } else {
                const dateStr = `${calendarYear}-${String(calendarMonth).padStart(2, '0')}-${String(dayCounter).padStart(2, '0')}`;
                const isHoliday = holidayMap[dateStr];
                const isWorked = workedMap[dateStr];
                const isLeave = leaveMap[dateStr];
                
                let dayClass = 'calendar-day';
                let tooltip = '';
                let hoursDisplay = '';
                
                // Check for mixed day (both work AND leave)
                const isMixed = isWorked && isLeave;
                
                if (isHoliday) {
                    dayClass += ' holiday';
                    tooltip = isHoliday;
                } else if (isMixed) {
                    // Mixed day: both work and leave
                    dayClass += ' mixed-day';
                    const leaveType = calendarLeaveTypes[isLeave.leave_type_id];
                    const leaveName = leaveType?.name || isLeave.title || 'Leave';
                    const leaveHrs = isLeave.hours || 0;
                    tooltip = `${isWorked.hours}h work + ${leaveHrs}h ${leaveName}`;
                    hoursDisplay = `<span class="hours">${isWorked.hours}h+${leaveHrs}h</span>`;
                    workedCount++;
                    if (leaveName.toLowerCase().includes('sick') || leaveName.toLowerCase().includes('personal')) {
                        sickCount++;
                    } else {
                        annualCount++;
                    }
                } else if (isLeave) {
                    const leaveType = calendarLeaveTypes[isLeave.leave_type_id];
                    const leaveName = leaveType?.name || isLeave.title || 'Leave';
                    const leaveHrs = isLeave.hours || 0;
                    
                    if (leaveName.toLowerCase().includes('sick') || leaveName.toLowerCase().includes('personal')) {
                        dayClass += ' sick-leave';
                        sickCount++;
                    } else {
                        dayClass += ' annual-leave';
                        annualCount++;
                    }
                    tooltip = leaveName;
                    if (leaveHrs > 0) hoursDisplay = `<span class="hours">${leaveHrs}h</span>`;
                } else if (isWorked) {
                    dayClass += ' worked';
                    tooltip = `${isWorked.hours}h worked`;
                    hoursDisplay = `<span class="hours">${isWorked.hours}h</span>`;
                    workedCount++;
                } else if (isWeekend) {
                    dayClass += ' weekend';
                }
                
                const isToday = (new Date().toISOString().split('T')[0] === dateStr);
                if (isToday) dayClass += ' today';
                
                // Store day info for click handler
                // Get earnings rate name and pay rate for worked days
                let earningsRateName = '';
                let ratePerUnit = null;
                if (isWorked && isWorked.earnings_rate_id && payItemsData.earnings_rates) {
                    const rate = payItemsData.earnings_rates.find(r => r.EarningsRateID === isWorked.earnings_rate_id);
                    earningsRateName = rate ? rate.Name : '';
                    ratePerUnit = rate ? rate.RatePerUnit : null;
                }
                
                const dayInfo = JSON.stringify({
                    date: dateStr,
                    hours: isWorked ? isWorked.hours : 0,
                    workHours: isWorked ? isWorked.hours : 0,
                    leaveHours: isLeave ? (isLeave.hours || 0) : 0,
                    isHoliday: !!isHoliday,
                    holidayName: isHoliday || '',
                    isLeave: !!isLeave,
                    leaveType: isLeave ? (calendarLeaveTypes[isLeave.leave_type_id]?.name || isLeave.title || 'Leave') : '',
                    leaveTypeId: isLeave ? isLeave.leave_type_id : '',
                    isWeekend: isWeekend,
                    isWorked: !!isWorked,
                    isMixed: !!(isWorked && isLeave),
                    earningsRateId: isWorked ? isWorked.earnings_rate_id : '',
                    earningsRateName: earningsRateName,
                    ratePerUnit: ratePerUnit,
                    canEdit: !isHoliday
                }).replace(/"/g, '&quot;');
                
                html += `<div class="${dayClass} clickable" title="${tooltip || 'Click to view'}" data-dayinfo="${dayInfo}" onclick="selectCalendarDay(this)">
                    <span class="day-number">${dayCounter}</span>
                    ${hoursDisplay}
                </div>`;
                
                dayCounter++;
            }
            
            if (i % 7 === 6) html += '</div>';
        }
        
        calendarBody.innerHTML = html;
        
        // Update summary
        document.getElementById('summaryWorkedDays').textContent = workedCount;
        document.getElementById('summarySickDays').textContent = sickCount;
        document.getElementById('summaryAnnualDays').textContent = annualCount;
        document.getElementById('summaryHolidays').textContent = holidayCount;
    }
    
    // Day Details Side Panel Functions
    let selectedDayData = null;
    let earningsRatesLoaded = false;
    let workRowCounter = 0;
    let leaveRowCounter = 0;
    const dayDetailsEmpty = document.getElementById('dayDetailsEmpty');
    const dayDetailsContent = document.getElementById('dayDetailsContent');
    const selectedDayTitle = document.getElementById('selectedDayTitle');
    const selectedDayStatus = document.getElementById('selectedDayStatus');
    const dayInputSection = document.getElementById('dayInputSection');
    const dayDisplaySection = document.getElementById('dayDisplaySection');
    const leaveSection = document.getElementById('leaveSection');
    const workRowsContainer = document.getElementById('workRowsContainer');
    const leaveRowsContainer = document.getElementById('leaveRowsContainer');
    const dayTotalHours = document.getElementById('dayTotalHours');
    // saveDayBtn removed - work hours now saved via Save Allocations button
    const editDayBtn = document.getElementById('editDayBtn');
    const deleteWorkBtn = document.getElementById('deleteWorkBtn');
    const deleteLeaveBtn = document.getElementById('deleteLeaveBtn');
    const selectedLeaveType = document.getElementById('selectedLeaveType');
    const selectedLeaveHours = document.getElementById('selectedLeaveHours');
    const selectedDayRate = document.getElementById('selectedDayRate');
    const selectedDayPayRate = document.getElementById('selectedDayPayRate');
    const selectedDayHours = document.getElementById('selectedDayHours');
    const workDisplayRow = document.getElementById('workDisplayRow');
    const leaveDisplayRow = document.getElementById('leaveDisplayRow');
    const addWorkRowBtn = document.getElementById('addWorkRowBtn');
    const addLeaveRowBtn = document.getElementById('addLeaveRowBtn');
    
    // Create a work row element
    function createWorkRow(earningsRateId = '', hours = 0) {
        const rowId = `work-row-${++workRowCounter}`;
        const row = document.createElement('div');
        row.id = rowId;
        row.className = 'work-row d-flex align-items-center mb-1';
        row.innerHTML = `
            <label class="text-muted mb-0" style="width: 50px; font-size: 13px;">Work:</label>
            <select class="form-select form-select-sm earnings-rate-select" style="font-size: 13px; flex: 1; height: 31px; margin-right: 10px;">
                <option value="">Select rate...</option>
            </select>
            <input type="number" class="form-control form-control-sm work-hours-input" min="0" max="24" step="0.5" value="${hours}" style="width: 60px; font-size: 13px; height: 31px;">
            <span class="text-muted" style="font-size: 13px; margin-left: 6px; margin-right: 6px;">hrs</span>
            <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-work-row" style="font-size: 11px;" title="Remove"><i class="fas fa-times"></i></button>
        `;
        
        // Populate earnings rates dropdown
        const select = row.querySelector('.earnings-rate-select');
        populateEarningsRateSelect(select, earningsRateId);
        
        // Add event listeners
        row.querySelector('.work-hours-input').addEventListener('input', updateDayTotalHours);
        row.querySelector('.remove-work-row').addEventListener('click', () => {
            row.remove();
            updateDayTotalHours();
        });
        
        return row;
    }
    
    // Create a leave row element (single-line layout matching allocation rows)
    function createLeaveRow(leaveTypeId = '', hours = 0, comment = '') {
        const rowId = `leave-row-${++leaveRowCounter}`;
        const row = document.createElement('div');
        row.id = rowId;
        row.className = 'leave-row d-flex align-items-center mb-1';
        row.style.cssText = 'gap: 4px;';
        row.innerHTML = `
            <select class="form-select form-select-sm leave-type-select" style="font-size: 10px; padding: 2px; width: 100px; flex-shrink: 0;">
                <option value="">Select...</option>
            </select>
            <input type="text" class="form-control form-control-sm leave-comment-input" placeholder="Note..." value="${comment}" style="font-size: 10px; padding: 2px 4px; flex: 1; min-width: 60px;">
            <input type="number" class="form-control form-control-sm leave-hours-input" min="0" max="24" step="0.5" value="${hours}" style="width: 45px; font-size: 10px; padding: 2px; text-align: center;">
            <span class="text-muted" style="font-size: 10px; white-space: nowrap;">(<span class="leave-balance">-</span>)</span>
            <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-leave-row" style="font-size: 10px;" title="Remove"><i class="fas fa-times"></i></button>
        `;
        
        // Populate leave types dropdown
        const select = row.querySelector('.leave-type-select');
        populateLeaveTypeSelect(select, leaveTypeId);
        
        // Add event listeners
        row.querySelector('.leave-hours-input').addEventListener('input', function() {
            updateDayTotalHours();
            validateLeave();
        });
        row.querySelector('.leave-type-select').addEventListener('change', function() {
            updateLeaveBalanceForRow(row);
            validateLeave();
        });
        row.querySelector('.remove-leave-row').addEventListener('click', () => {
            row.remove();
            updateDayTotalHours();
            validateLeave();
        });
        
        return row;
    }
    
    // Populate earnings rate select
    function populateEarningsRateSelect(select, selectedValue = '') {
        select.innerHTML = '<option value="">Select rate...</option>';
        if (payItemsData.earnings_rates && payItemsData.earnings_rates.length > 0) {
            const timesheetValidTypes = ['ORDINARYTIMEEARNINGS', 'OVERTIMEEARNINGS'];
            const validRates = payItemsData.earnings_rates.filter(rate => {
                const isActive = rate.CurrentRecord !== false;
                const isValidType = rate.RateType !== 'FIXEDAMOUNT';
                const isTimesheetType = timesheetValidTypes.includes(rate.EarningsType);
                return isActive && isValidType && isTimesheetType;
            });
            validRates.forEach(rate => {
                const option = document.createElement('option');
                option.value = rate.EarningsRateID;
                option.textContent = rate.Name;
                if (rate.EarningsRateID === selectedValue) option.selected = true;
                select.appendChild(option);
            });
        }
    }
    
    // Populate leave type select
    function populateLeaveTypeSelect(select, selectedValue = '') {
        select.innerHTML = '<option value="">Select leave...</option>';
        const currentEmployeeId = calendarEmployeeSelect?.value;
        const employee = employeesData.find(e => e.employee_id === currentEmployeeId);
        
        const assignedLeaveTypeIds = new Set();
        if (employee && employee.leave_balances) {
            employee.leave_balances.forEach(lb => {
                if (lb.LeaveTypeID) assignedLeaveTypeIds.add(lb.LeaveTypeID);
            });
        }
        
        if (payItemsData.leave_types && payItemsData.leave_types.length > 0 && assignedLeaveTypeIds.size > 0) {
            payItemsData.leave_types.forEach(lt => {
                if (lt.CurrentRecord !== false && assignedLeaveTypeIds.has(lt.LeaveTypeID)) {
                    const option = document.createElement('option');
                    option.value = lt.LeaveTypeID;
                    option.textContent = lt.Name;
                    if (lt.LeaveTypeID === selectedValue) option.selected = true;
                    select.appendChild(option);
                }
            });
        }
    }
    
    // Update leave balance display for a specific row
    function updateLeaveBalanceForRow(row) {
        const balanceSpan = row.querySelector('.leave-balance');
        const leaveTypeSelect = row.querySelector('.leave-type-select');
        if (!balanceSpan || !leaveTypeSelect) return;
        
        const selectedLeaveTypeId = leaveTypeSelect.value;
        if (!selectedLeaveTypeId) {
            balanceSpan.textContent = '-';
            return;
        }
        
        const currentEmployeeId = calendarEmployeeSelect?.value;
        const employee = employeesData.find(e => e.employee_id === currentEmployeeId);
        if (employee && employee.leave_balances) {
            const balance = employee.leave_balances.find(lb => lb.LeaveTypeID === selectedLeaveTypeId);
            if (balance) {
                balanceSpan.textContent = `${balance.NumberOfUnits || 0}h`;
                return;
            }
        }
        balanceSpan.textContent = '-';
    }
    
    // Update total hours display when inputs change
    function updateDayTotalHours() {
        let totalWork = 0;
        let totalLeave = 0;
        
        document.querySelectorAll('#workRowsContainer .work-hours-input').forEach(input => {
            totalWork += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('#leaveRowsContainer .leave-hours-input').forEach(input => {
            totalLeave += parseFloat(input.value) || 0;
        });
        
        const total = totalWork + totalLeave;
        if (dayTotalHours) dayTotalHours.textContent = total;
        
        // Update allocation section target hours (work hours only, not leave)
        const totalDayHoursEl = document.getElementById('totalDayHours');
        if (totalDayHoursEl) totalDayHoursEl.textContent = totalWork;
        
        // Also update the display version
        const totalDayHoursDisplayEl = document.getElementById('totalDayHoursDisplay');
        if (totalDayHoursDisplayEl) totalDayHoursDisplayEl.textContent = totalWork;
        
        // Re-validate allocations if section is visible
        const allocationSection = document.getElementById('hoursAllocationSection');
        if (allocationSection && !allocationSection.classList.contains('d-none')) {
            validateAllocations();
        }
    }
    
    // Add row button handlers
    if (addWorkRowBtn) {
        addWorkRowBtn.addEventListener('click', () => {
            const row = createWorkRow();
            workRowsContainer.appendChild(row);
        });
    }
    
    if (addLeaveRowBtn) {
        addLeaveRowBtn.addEventListener('click', () => {
            const row = createLeaveRow();
            leaveRowsContainer.appendChild(row);
        });
    }
    
    // Initialize day input section with one work row and one leave row
    function initDayInputRows(workEntries = [], leaveEntries = []) {
        workRowsContainer.innerHTML = '';
        leaveRowsContainer.innerHTML = '';
        workRowCounter = 0;
        leaveRowCounter = 0;
        
        // Add work rows (at least one empty row if no data)
        if (workEntries.length === 0) {
            workRowsContainer.appendChild(createWorkRow());
        } else {
            workEntries.forEach(entry => {
                workRowsContainer.appendChild(createWorkRow(entry.earningsRateId, entry.hours));
            });
        }
        
        // Add leave rows (at least one empty row if no data)
        if (leaveEntries.length === 0) {
            leaveRowsContainer.appendChild(createLeaveRow());
        } else {
            leaveEntries.forEach(entry => {
                leaveRowsContainer.appendChild(createLeaveRow(entry.leaveTypeId, entry.hours, entry.comment || ''));
            });
        }
        
        updateDayTotalHours();
    }
    
    // Gather all work entries from the form
    function gatherWorkEntries() {
        const entries = [];
        document.querySelectorAll('#workRowsContainer .work-row').forEach(row => {
            const earningsRateId = row.querySelector('.earnings-rate-select')?.value;
            const hours = parseFloat(row.querySelector('.work-hours-input')?.value) || 0;
            if (hours > 0 && earningsRateId) {
                entries.push({ earningsRateId, hours });
            }
        });
        return entries;
    }
    
    // Gather all leave entries from the form
    function gatherLeaveEntries() {
        const entries = [];
        document.querySelectorAll('#leaveRowsContainer .leave-row').forEach(row => {
            const leaveTypeId = row.querySelector('.leave-type-select')?.value;
            const hours = parseFloat(row.querySelector('.leave-hours-input')?.value) || 0;
            const comment = row.querySelector('.leave-comment-input')?.value?.trim() || '';
            if (hours > 0 && leaveTypeId) {
                entries.push({ leaveTypeId, hours, comment });
            }
        });
        return entries;
    }
    
    // Delete Work Hours Handler
    if (deleteWorkBtn) {
        deleteWorkBtn.addEventListener('click', async function() {
            if (!selectedDayData || !confirm('Delete work hours for this day?')) return;
            
            const currentEmployeeId = calendarEmployeeSelect?.value;
            if (!currentEmployeeId || !currentXeroInstanceId) return;
            
            deleteWorkBtn.disabled = true;
            deleteWorkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const data = await staffHoursApi('/core/staff_hours/timesheets/delete/', {
                    method: 'POST',
                    body: {
                        xero_instance_id: currentXeroInstanceId,
                        employee_id: currentEmployeeId,
                        date: selectedDayData.date
                    }
                });
                
                if (data.status === 'success') {
                    await refreshCalendarAndSelectDay(selectedDayData.date);
                } else {
                    alert('Error: ' + getErrorMessage(data, 'Failed to delete'));
                }
            } catch (e) {
                alert('Error: ' + getErrorMessage(e, 'Failed to delete work hours'));
            } finally {
                deleteWorkBtn.disabled = false;
                deleteWorkBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            }
        });
    }
    
    // Delete Leave Handler
    if (deleteLeaveBtn) {
        deleteLeaveBtn.addEventListener('click', async function() {
            if (!selectedDayData || !confirm('Delete leave for this day?')) return;
            
            const currentEmployeeId = calendarEmployeeSelect?.value;
            if (!currentEmployeeId || !currentXeroInstanceId) return;
            
            deleteLeaveBtn.disabled = true;
            deleteLeaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const data = await staffHoursApi('/core/staff_hours/leave/delete/', {
                    method: 'POST',
                    body: {
                        xero_instance_id: currentXeroInstanceId,
                        employee_id: currentEmployeeId,
                        date: selectedDayData.date,
                        leave_type_id: selectedDayData.leaveTypeId
                    }
                });
                
                if (data.status === 'success') {
                    await refreshCalendarAndSelectDay(selectedDayData.date);
                } else {
                    alert('Error: ' + getErrorMessage(data, 'Failed to delete'));
                }
            } catch (e) {
                alert('Error: ' + getErrorMessage(e, 'Failed to delete leave'));
            } finally {
                deleteLeaveBtn.disabled = false;
                deleteLeaveBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            }
        });
    }
    
    // Edit Day Button Handler - switches from display to edit mode
    if (editDayBtn) {
        editDayBtn.addEventListener('click', function() {
            if (!selectedDayData) return;
            
            // Switch to input section
            if (dayInputSection) dayInputSection.classList.remove('d-none');
            if (dayDisplaySection) dayDisplaySection.classList.add('d-none');
            if (leaveSection) leaveSection.classList.remove('d-none');
            
            // Build work entries from existing data
            const workEntries = [];
            if (selectedDayData.workHours > 0 && selectedDayData.earningsRateId) {
                workEntries.push({
                    earningsRateId: selectedDayData.earningsRateId,
                    hours: selectedDayData.workHours
                });
            }
            
            // Build leave entries from existing data
            const leaveEntries = [];
            if (selectedDayData.leaveHours > 0 && selectedDayData.leaveTypeId) {
                leaveEntries.push({
                    leaveTypeId: selectedDayData.leaveTypeId,
                    hours: selectedDayData.leaveHours,
                    comment: ''
                });
            }
            
            // Initialize rows with existing data
            initDayInputRows(workEntries, leaveEntries);
            
            // Show allocation section
            if (selectedDayData.workHours > 0) {
                showAllocationSection(selectedDayData);
            }
        });
    }
    
    // Show allocation section when work hours are entered - using event delegation for dynamic rows
    if (workRowsContainer) {
        workRowsContainer.addEventListener('input', function(e) {
            if (!e.target.classList.contains('work-hours-input')) return;
            
            // Calculate total work hours from all rows
            let totalWork = 0;
            document.querySelectorAll('#workRowsContainer .work-hours-input').forEach(input => {
                totalWork += parseFloat(input.value) || 0;
            });
            
            // Always update the target hours in allocation section
            const totalDayHoursEl = document.getElementById('totalDayHours');
            if (totalDayHoursEl) totalDayHoursEl.textContent = totalWork;
            
            if (totalWork > 0 && selectedDayData) {
                // Show allocation section immediately
                const section = document.getElementById('hoursAllocationSection');
                if (section && section.classList.contains('d-none')) {
                    section.classList.remove('d-none');
                    // Only initialize if no rows exist yet
                    const tbody = document.getElementById('allocationRows');
                    const existingRows = tbody?.querySelectorAll('tr[id^="alloc-row-"]');
                    if (!existingRows || existingRows.length === 0) {
                        loadAllocationProjects().then(() => {
                            if (tbody) tbody.innerHTML = '';
                            tbody.appendChild(createAllocationRow());
                            validateAllocations();
                        });
                    } else {
                        validateAllocations();
                    }
                } else {
                    validateAllocations();
                }
            } else {
                const section = document.getElementById('hoursAllocationSection');
                if (section && !section.classList.contains('d-none')) {
                    validateAllocations();
                }
            }
        });
    }
    
    // Save Day button removed - work hours now saved via Save Allocations button
    // Leave hours saved via Save Leave button
    
    window.selectCalendarDay = function(element) {
        // Remove selection from other days
        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
        element.classList.add('selected');
        
        // Parse day info
        const dayInfo = JSON.parse(element.dataset.dayinfo);
        selectedDayData = dayInfo;
        
        // Format date for display
        const date = new Date(dayInfo.date);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const formatted = `${daysOfWeek[date.getDay()]} ${date.getDate()}-${months[date.getMonth()]}-${String(date.getFullYear()).slice(-2)}`;
        
        // Update panel
        dayDetailsEmpty.classList.add('d-none');
        dayDetailsContent.classList.remove('d-none');
        selectedDayTitle.textContent = formatted;
        
        // Set status
        let statusParts = [];
        if (dayInfo.isHoliday) {
            statusParts.push(`<span class="text-warning">${dayInfo.holidayName}</span>`);
        }
        if (dayInfo.isWorked) {
            statusParts.push(`<span class="text-success">Worked</span>`);
        }
        if (dayInfo.isLeave) {
            statusParts.push(`<span class="text-info">${dayInfo.leaveType}</span>`);
        }
        if (statusParts.length === 0) {
            if (dayInfo.isWeekend) {
                statusParts.push(`<span class="text-muted">Weekend</span>`);
            } else {
                statusParts.push(`<span class="text-muted">No entry</span>`);
            }
        }
        selectedDayStatus.innerHTML = statusParts.join(' + ');
        
        // Determine if day can be edited (not a public holiday, not already submitted)
        const canEdit = dayInfo.canEdit && !dayInfo.isHoliday;
        
        // Check if day has existing data
        const hasExistingData = dayInfo.isWorked || dayInfo.isLeave;
        
        if (canEdit && !hasExistingData) {
            // New entry - show input section immediately
            if (dayInputSection) dayInputSection.classList.remove('d-none');
            if (dayDisplaySection) dayDisplaySection.classList.add('d-none');
            if (leaveSection) leaveSection.classList.remove('d-none');
            
            // Initialize with empty rows
            initDayInputRows([], []);
            
            // Hide allocation section until work hours entered
            hideAllocationSection();
        } else if (hasExistingData) {
            // Already has data - show display section
            if (dayInputSection) dayInputSection.classList.add('d-none');
            if (dayDisplaySection) dayDisplaySection.classList.remove('d-none');
            if (leaveSection) leaveSection.classList.add('d-none');
            
            // Show work row if worked
            if (workDisplayRow) {
                if (dayInfo.isWorked && dayInfo.workHours > 0) {
                    workDisplayRow.classList.remove('d-none');
                    if (selectedDayRate) selectedDayRate.textContent = dayInfo.earningsRateName || 'Unknown';
                    if (selectedDayHours) selectedDayHours.textContent = dayInfo.workHours;
                    if (selectedDayPayRate) selectedDayPayRate.textContent = dayInfo.ratePerUnit ? parseFloat(dayInfo.ratePerUnit).toFixed(2) : '0';
                } else {
                    workDisplayRow.classList.add('d-none');
                }
            }
            
            // Show leave row if on leave
            if (leaveDisplayRow) {
                if (dayInfo.isLeave) {
                    leaveDisplayRow.classList.remove('d-none');
                    if (selectedLeaveType) selectedLeaveType.textContent = dayInfo.leaveType || 'Leave';
                    if (selectedLeaveHours) selectedLeaveHours.textContent = dayInfo.leaveHours || 0;
                } else {
                    leaveDisplayRow.classList.add('d-none');
                }
            }
            
            // Show allocation section for worked days (work hours only)
            if (dayInfo.isWorked && dayInfo.workHours > 0) {
                showAllocationSection(dayInfo);
            } else {
                hideAllocationSection();
            }
        } else {
            // Holiday or empty weekend - hide both sections
            if (dayInputSection) dayInputSection.classList.add('d-none');
            if (dayDisplaySection) dayDisplaySection.classList.add('d-none');
            if (leaveSection) leaveSection.classList.add('d-none');
            hideAllocationSection();
        }
    };
    
    // Allocation handling - Table-based
    let allocationProjects = [];
    let allocationCostings = {};
    let allocationRowCount = 0;
    
    async function loadAllocationProjects() {
        try {
            const data = await staffHoursApi(`/core/staff_hours/projects/?xero_instance_id=${currentXeroInstanceId}`);
            if (data.status === 'success') {
                allocationProjects = data.projects;
            }
        } catch (e) {
            // Silently fail
        }
    }
    
    async function loadCostingsForProject(projectId, selectElement) {
        if (!projectId) {
            selectElement.innerHTML = '<option value="">Costing...</option>';
            selectElement.disabled = true;
            return;
        }
        if (allocationCostings[projectId]) {
            populateCostingSelect(selectElement, allocationCostings[projectId]);
            return;
        }
        try {
            const data = await staffHoursApi(`/core/staff_hours/costings/?project_id=${projectId}`);
            if (data.status === 'success') {
                allocationCostings[projectId] = data.costings;
                populateCostingSelect(selectElement, data.costings);
            }
        } catch (e) {
            // Silently fail
        }
    }
    
    function populateCostingSelect(select, costings) {
        select.innerHTML = '<option value="">Costing...</option>';
        costings.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.item}</option>`;
        });
        select.disabled = false;
    }
    
    function createAllocationRow(existingData = null) {
        const rowId = allocationRowCount++;
        const tr = document.createElement('tr');
        tr.id = `alloc-row-${rowId}`;
        tr.dataset.allocationId = existingData?.id || '';
        
        const allocType = existingData?.allocation_type || ALLOC_TYPE.PROJECT;
        
        // Project select options
        let projectOptions = '<option value="">Project...</option>';
        allocationProjects.forEach(p => {
            const selected = existingData?.project_id == p.id ? 'selected' : '';
            projectOptions += `<option value="${p.id}" ${selected}>${p.name}</option>`;
        });
        
        // Costing select (will be populated on project change)
        let costingOptions = '<option value="">Costing...</option>';
        if (existingData?.costing_id && allocationCostings[existingData.project_id]) {
            allocationCostings[existingData.project_id].forEach(c => {
                const selected = existingData.costing_id == c.id ? 'selected' : '';
                costingOptions += `<option value="${c.id}" ${selected}>${c.item}</option>`;
            });
        }
        
        tr.innerHTML = `
            <td style="padding: 2px; width: 85px;">
                <select class="form-select form-select-sm alloc-type" style="font-size: 10px; padding: 2px; width: 100%; max-width: 81px;" data-row="${rowId}">
                    <option value="${ALLOC_TYPE.PROJECT}" ${allocType == ALLOC_TYPE.PROJECT ? 'selected' : ''}>Project</option>
                    <option value="${ALLOC_TYPE.UNCHARGEABLE}" ${allocType == ALLOC_TYPE.UNCHARGEABLE ? 'selected' : ''}>Unchargeable</option>
                    <option value="${ALLOC_TYPE.OTHER_CHARGEABLE}" ${allocType == ALLOC_TYPE.OTHER_CHARGEABLE ? 'selected' : ''}>Other Chargeable</option>
                </select>
            </td>
            <td style="padding: 2px;">
                <div class="alloc-project-fields" style="display: ${allocType == ALLOC_TYPE.PROJECT ? 'flex' : 'none'}; gap: 2px;">
                    <select class="form-select form-select-sm alloc-project" style="font-size: 10px; padding: 2px; width: 50%;" data-row="${rowId}">
                        ${projectOptions}
                    </select>
                    <select class="form-select form-select-sm alloc-costing" style="font-size: 10px; padding: 2px; width: 50%;" data-row="${rowId}" ${existingData?.costing_id ? '' : 'disabled'}>
                        ${costingOptions}
                    </select>
                </div>
                <div class="alloc-note-field" style="${allocType != ALLOC_TYPE.PROJECT ? '' : 'display:none;'}">
                    <input type="text" class="form-control form-control-sm alloc-note" style="font-size: 10px; padding: 2px; width: 100%;" 
                           placeholder="Note (required)..." value="${existingData?.note || ''}" data-row="${rowId}">
                </div>
            </td>
            <td style="padding: 2px;">
                <input type="number" class="form-control form-control-sm alloc-hours" style="font-size: 11px; padding: 2px; text-align: center;" 
                       min="0" max="24" step="0.5" value="${existingData?.hours || ''}" data-row="${rowId}">
            </td>
            <td style="padding: 2px; text-align: center;">
                <button class="btn btn-sm p-0 alloc-remove" style="font-size: 12px; color: #dc3545; line-height: 1;" data-row="${rowId}">&times;</button>
            </td>
        `;
        
        // Wire up events
        const typeSelect = tr.querySelector('.alloc-type');
        const projectFields = tr.querySelector('.alloc-project-fields');
        const noteField = tr.querySelector('.alloc-note-field');
        const projectSelect = tr.querySelector('.alloc-project');
        const costingSelect = tr.querySelector('.alloc-costing');
        const noteInput = tr.querySelector('.alloc-note');
        const hoursInput = tr.querySelector('.alloc-hours');
        const removeBtn = tr.querySelector('.alloc-remove');
        
        typeSelect.addEventListener('change', function() {
            if (this.value == '1') {
                projectFields.style.display = 'flex';
                noteField.style.display = 'none';
            } else {
                projectFields.style.display = 'none';
                noteField.style.display = '';
            }
            validateAllocations();
        });
        projectSelect.addEventListener('change', function() {
            loadCostingsForProject(this.value, costingSelect);
            validateAllocations();
        });
        costingSelect.addEventListener('change', validateAllocations);
        noteInput.addEventListener('input', validateAllocations);
        hoursInput.addEventListener('input', validateAllocations);
        removeBtn.addEventListener('click', function() {
            tr.remove();
            validateAllocations();
        });
        
        return tr;
    }
    
    function validateAllocations() {
        // Calculate total work hours from current inputs (not saved data)
        let totalHours = 0;
        document.querySelectorAll('#workRowsContainer .work-hours-input').forEach(input => {
            totalHours += parseFloat(input.value) || 0;
        });
        const rows = document.querySelectorAll('#allocationRows tr');
        let sum = 0;
        let allValid = true;
        
        rows.forEach(row => {
            const allocType = row.querySelector('.alloc-type')?.value || String(ALLOC_TYPE.PROJECT);
            const hours = parseFloat(row.querySelector('.alloc-hours')?.value) || 0;
            sum += hours;
            
            if (hours <= 0) {
                allValid = false;
            } else if (allocType === String(ALLOC_TYPE.PROJECT)) {
                // Project type: need project and costing
                const project = row.querySelector('.alloc-project')?.value;
                const costing = row.querySelector('.alloc-costing')?.value;
                if (!project || !costing) allValid = false;
            } else {
                // Unchargeable or Other Chargeable: need note
                const note = row.querySelector('.alloc-note')?.value?.trim();
                if (!note) allValid = false;
            }
        });
        
        document.getElementById('allocatedHours').textContent = sum.toFixed(1);
        document.getElementById('totalDayHours').textContent = totalHours;
        
        const saveBtn = document.getElementById('saveAllocationsBtn');
        const isValid = allValid && rows.length > 0 && Math.abs(sum - totalHours) < 0.01;
        
        if (isValid) {
            saveBtn.disabled = false;
            saveBtn.style.background = '#28a745';
        } else {
            saveBtn.disabled = true;
            saveBtn.style.background = '#6c757d';
        }
    }
    
    let allocationEditMode = true;
    let savedAllocations = [];
    
    async function loadAllocations(employeeId, dateStr, hours = 0) {
        try {
            const url = `/core/staff_hours/allocations/?xero_instance_id=${currentXeroInstanceId}&employee_id=${employeeId}&date=${dateStr}&hours=${hours}`;
            const data = await staffHoursApi(url);
            savedAllocations = data.allocations || [];
            
            // Update daily cost display (with wages, super, and total) and pay rate
            updateDailyCostDisplay({
                wages_cost: data.wages_cost,
                super_rate: data.super_rate,
                super_amount: data.super_amount,
                daily_cost: data.daily_cost
            });
            if (data.rate_per_unit) {
                const payRateEl = document.getElementById('selectedDayPayRate');
                if (payRateEl) payRateEl.textContent = parseFloat(data.rate_per_unit).toFixed(2);
            }
            
            if (savedAllocations.length > 0) {
                renderAllocationDisplayTable(savedAllocations);
            } else {
                renderAllocationEditTable([]);
            }
        } catch (e) {
            renderAllocationEditTable([]);
            updateDailyCostDisplay(null);
        }
    }
    
    function updateDailyCostDisplay(data) {
        const costDisplay = document.getElementById('dailyCostDisplay');
        const wagesCostEl = document.getElementById('wagesCostAmount');
        const superRowEl = document.getElementById('superRow');
        const superRateEl = document.getElementById('superRateDisplay');
        const superAmountEl = document.getElementById('superAmount');
        const dailyCostEl = document.getElementById('dailyCostAmount');
        
        if (!costDisplay || !dailyCostEl) return;
        
        // Handle both old format (number) and new format (object)
        if (data !== null && data !== undefined) {
            if (typeof data === 'number') {
                // Legacy format - just daily cost number
                if (wagesCostEl) wagesCostEl.textContent = `$${data.toFixed(2)}`;
                if (superRowEl) superRowEl.classList.add('d-none');
                dailyCostEl.textContent = `$${data.toFixed(2)}`;
            } else {
                // New format with wages, super, and total
                const wagesCost = data.wages_cost || 0;
                const superRate = data.super_rate;
                const superAmount = data.super_amount || 0;
                const dailyCost = data.daily_cost || wagesCost;
                
                if (wagesCostEl) wagesCostEl.textContent = `$${wagesCost.toFixed(2)}`;
                
                if (superRate && superAmount > 0) {
                    if (superRowEl) superRowEl.classList.remove('d-none');
                    if (superRateEl) superRateEl.textContent = superRate.toFixed(1);
                    if (superAmountEl) superAmountEl.textContent = `$${superAmount.toFixed(2)}`;
                } else {
                    if (superRowEl) superRowEl.classList.add('d-none');
                }
                
                dailyCostEl.textContent = `$${dailyCost.toFixed(2)}`;
            }
            costDisplay.classList.remove('d-none');
        } else {
            costDisplay.classList.add('d-none');
        }
    }
    
    function createDisplayRow(allocation) {
        const tr = document.createElement('tr');
        const allocType = allocation.allocation_type || ALLOC_TYPE.PROJECT;
        const typeName = allocation.allocation_type_display || (allocType === ALLOC_TYPE.PROJECT ? 'Project' : allocType === ALLOC_TYPE.UNCHARGEABLE ? 'Unchargeable' : 'Other Chargeable');
        
        let details = '';
        if (allocType === ALLOC_TYPE.PROJECT) {
            const projectName = allocationProjects.find(p => p.id == allocation.project_id)?.name || allocation.project_name || '-';
            const costingName = allocation.costing_item || '-';
            details = `${projectName} / ${costingName}`;
        } else {
            details = allocation.note || '-';
        }
        
        tr.innerHTML = `
            <td style="padding: 4px 3px; font-size: 11px;">${typeName}</td>
            <td style="padding: 4px 3px; font-size: 11px;">${details}</td>
            <td style="padding: 4px 3px; font-size: 11px; text-align: center;">${allocation.hours}</td>
            <td style="padding: 4px 3px;"></td>
        `;
        return tr;
    }
    
    function renderAllocationDisplayTable(allocations) {
        allocationEditMode = false;
        const tbody = document.getElementById('allocationRows');
        tbody.innerHTML = '';
        
        let totalAllocated = 0;
        allocations.forEach(a => {
            tbody.appendChild(createDisplayRow(a));
            totalAllocated += parseFloat(a.hours) || 0;
        });
        
        const totalHours = parseFloat(selectedDayData?.hours) || 0;
        document.getElementById('allocatedHoursDisplay').textContent = totalAllocated.toFixed(1);
        document.getElementById('totalDayHoursDisplay').textContent = totalHours;
        
        document.getElementById('allocationEditControls').classList.add('d-none');
        document.getElementById('allocationDisplayControls').classList.remove('d-none');
        
        // Also update the summary allocation display in dayDisplaySection
        updateAllocationSummaryDisplay(allocations);
    }
    
    // Update the allocation summary display in the read-only dayDisplaySection
    function updateAllocationSummaryDisplay(allocations) {
        const displaySection = document.getElementById('allocationDisplaySection');
        const displayList = document.getElementById('allocationDisplayList');
        
        if (!displaySection || !displayList) return;
        
        if (allocations && allocations.length > 0) {
            displayList.innerHTML = '';
            allocations.forEach(a => {
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center mb-1';
                item.style.cssText = 'padding: 2px 0; border-bottom: 1px dotted #dee2e6;';
                
                let label = '';
                if (a.allocation_type === ALLOC_TYPE.PROJECT || a.allocation_type_display === 'Project') {
                    // Project allocation
                    label = `<span class="text-primary">${a.project_name || 'Project'}</span>`;
                    if (a.costing_item) {
                        label += ` <span class="text-muted"> ${a.costing_item}</span>`;
                    }
                } else if (a.allocation_type === ALLOC_TYPE.UNCHARGEABLE || a.allocation_type_display === 'Unchargeable') {
                    label = `<span class="text-secondary">Unchargeable</span>`;
                    if (a.note) label += ` <span class="text-muted">(${a.note})</span>`;
                } else {
                    label = `<span class="text-info">Other Chargeable</span>`;
                    if (a.note) label += ` <span class="text-muted">(${a.note})</span>`;
                }
                
                item.innerHTML = `
                    <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${label}</div>
                    <div class="fw-bold ms-2" style="white-space: nowrap;">${parseFloat(a.hours).toFixed(1)}h</div>
                `;
                displayList.appendChild(item);
            });
            displaySection.classList.remove('d-none');
        } else {
            displaySection.classList.add('d-none');
        }
    }
    
    function renderAllocationEditTable(allocations) {
        allocationEditMode = true;
        const tbody = document.getElementById('allocationRows');
        tbody.innerHTML = '';
        allocationRowCount = 0;
        
        if (allocations.length === 0) {
            tbody.appendChild(createAllocationRow());
        } else {
            allocations.forEach(a => {
                tbody.appendChild(createAllocationRow(a));
            });
        }
        
        document.getElementById('allocationEditControls').classList.remove('d-none');
        document.getElementById('allocationDisplayControls').classList.add('d-none');
        validateAllocations();
    }
    
    function switchToEditMode() {
        renderAllocationEditTable(savedAllocations);
    }
    
    function showAllocationSection(dayInfo) {
        const section = document.getElementById('hoursAllocationSection');
        if (!section) return;
        
        section.classList.remove('d-none');
        
        // Clear existing data immediately
        const tbody = document.getElementById('allocationRows');
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>';
        
        loadAllocationProjects().then(() => {
            loadAllocations(calendarEmployeeSelect.value, dayInfo.date, dayInfo.hours);
        });
    }
    
    function hideAllocationSection() {
        const section = document.getElementById('hoursAllocationSection');
        if (section) {
            section.classList.add('d-none');
            savedAllocations = [];
        }
    }
    
    // Gather allocation data from DOM rows
    function gatherAllocationsFromRows(includeDisplayInfo = false) {
        const rows = document.querySelectorAll('#allocationRows tr');
        const allocations = [];
        
        rows.forEach(row => {
            const typeSelect = row.querySelector('.alloc-type');
            const projectSelect = row.querySelector('.alloc-project');
            const costingSelect = row.querySelector('.alloc-costing');
            const noteInput = row.querySelector('.alloc-note');
            const hoursInput = row.querySelector('.alloc-hours');
            
            const allocType = parseInt(typeSelect?.value) || ALLOC_TYPE.PROJECT;
            const hours = parseFloat(hoursInput?.value) || 0;
            
            if (hours <= 0) return;
            
            const alloc = { allocation_type: allocType, hours: hours };
            
            if (allocType === ALLOC_TYPE.PROJECT) {
                alloc.project_id = projectSelect?.value;
                alloc.costing_id = costingSelect?.value;
                alloc.note = '';
                if (includeDisplayInfo) {
                    alloc.project_name = projectSelect?.options[projectSelect.selectedIndex]?.text || '';
                    alloc.costing_item = costingSelect?.options[costingSelect.selectedIndex]?.text || '';
                }
            } else {
                alloc.project_id = null;
                alloc.costing_id = null;
                alloc.note = noteInput?.value?.trim() || '';
                if (includeDisplayInfo) {
                    alloc.project_name = null;
                    alloc.costing_item = null;
                }
            }
            if (includeDisplayInfo) {
                alloc.allocation_type_display = typeSelect?.options[typeSelect.selectedIndex]?.text || '';
            }
            allocations.push(alloc);
        });
        return allocations;
    }
    
    // Save allocations to backend
    async function saveAllocationsToBackend(allocations) {
        for (let i = 0; i < allocations.length; i++) {
            const alloc = allocations[i];
            await staffHoursApi('/core/staff_hours/allocations/save/', {
                method: 'POST',
                body: {
                    xero_instance_id: currentXeroInstanceId,
                    employee_id: calendarEmployeeSelect.value,
                    date: selectedDayData.date,
                    allocation_type: alloc.allocation_type,
                    project_id: alloc.project_id,
                    costing_id: alloc.costing_id,
                    hours: alloc.hours,
                    note: alloc.note,
                    clear_existing: i === 0
                }
            });
        }
    }
    
    // Helper function called from Save Day to save allocations silently
    async function saveAllocationsFromSaveDay() {
        const allocations = gatherAllocationsFromRows();
        if (allocations.length === 0) return;
        
        try {
            await saveAllocationsToBackend(allocations);
        } catch (e) {
            // Silently fail
        }
    }
    
    async function saveAllAllocations() {
        const saveBtn = document.getElementById('saveAllocationsBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            // STEP 1: Save work hours to Xero first
            const workEntries = gatherWorkEntries();
            
            if (workEntries.length > 0) {
                for (const entry of workEntries) {
                    const result = await staffHoursApi('/core/staff_hours/timesheets/save/', {
                        method: 'POST',
                        body: {
                            xero_instance_id: currentXeroInstanceId,
                            employee_id: calendarEmployeeSelect.value,
                            date: selectedDayData.date,
                            hours: entry.hours,
                            earnings_rate_id: entry.earningsRateId
                        }
                    });
                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Failed to save work hours');
                    }
                }
            }
            
            // STEP 2: Save allocations to local DB
            const allocations = gatherAllocationsFromRows(true);
            await saveAllocationsToBackend(allocations);
            savedAllocations = allocations;
            saveBtn.textContent = 'Saved!';
            
            // Refresh calendar to show updated data
            await refreshCalendarAndSelectDay(selectedDayData.date);
            
            setTimeout(() => {
                saveBtn.textContent = 'Save Allocations';
            }, 1000);
        } catch (e) {
            saveBtn.textContent = 'Error';
            alert('Error: ' + getErrorMessage(e, 'Failed to save'));
            setTimeout(() => {
                saveBtn.textContent = 'Save Allocations';
                validateAllocations();
            }, 1500);
        }
    }
    
    // Save leave entries independently
    async function saveLeaveEntries() {
        const leaveEntries = gatherLeaveEntries();
        
        const saveBtn = document.getElementById('saveLeaveBtn');
        if (!saveBtn) return;
        
        if (leaveEntries.length === 0) {
            alert('Please enter leave hours with a leave type selected');
            return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            for (const entry of leaveEntries) {
                const result = await staffHoursApi('/core/staff_hours/create_leave_application/', {
                    method: 'POST',
                    body: {
                        xero_instance_id: currentXeroInstanceId,
                        employee_id: calendarEmployeeSelect.value,
                        leave_type_id: entry.leaveTypeId,
                        date: selectedDayData.date,
                        hours: entry.hours,
                        description: entry.comment
                    }
                });
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Failed to save leave');
                }
            }
            
            saveBtn.textContent = 'Saved!';
            saveBtn.style.background = '#28a745';
            
            // Refresh calendar
            await refreshCalendarAndSelectDay(selectedDayData.date);
            
            setTimeout(() => {
                saveBtn.textContent = 'Save Leave';
                saveBtn.style.background = '#6c757d';
                validateLeave();
            }, 1000);
        } catch (e) {
            saveBtn.textContent = 'Error';
            saveBtn.style.background = '#dc3545';
            alert('Error: ' + getErrorMessage(e, 'Failed to save leave'));
            setTimeout(() => {
                saveBtn.textContent = 'Save Leave';
                saveBtn.style.background = '#6c757d';
                validateLeave();
            }, 1500);
        }
    }
    
    // Validate leave entries and enable/disable save button
    function validateLeave() {
        const leaveEntries = gatherLeaveEntries();
        const saveBtn = document.getElementById('saveLeaveBtn');
        if (!saveBtn) return;
        
        if (leaveEntries.length > 0) {
            saveBtn.disabled = false;
            saveBtn.style.background = '#17a2b8';
        } else {
            saveBtn.disabled = true;
            saveBtn.style.background = '#6c757d';
        }
    }
    
    // Wire up allocation UI events
    document.getElementById('addAllocationRowBtn')?.addEventListener('click', function() {
        document.getElementById('allocationRows').appendChild(createAllocationRow());
        validateAllocations();
    });
    document.getElementById('saveAllocationsBtn')?.addEventListener('click', saveAllAllocations);
    document.getElementById('updateAllocationsBtn')?.addEventListener('click', switchToEditMode);
    document.getElementById('saveLeaveBtn')?.addEventListener('click', saveLeaveEntries);
    
    // Override renderEmployeesTable to also populate calendar dropdown
    const originalRenderEmployeesTable = renderEmployeesTable;
    renderEmployeesTable = function() {
        originalRenderEmployeesTable();
        populateCalendarEmployeeDropdown();
    };
    
})();
</script>

<style>
#staffTabs .nav-link {
    color: #6c757d;
}
#staffTabs .nav-link.active {
    color: #0d6efd;
    font-weight: 500;
}
.table th {
    font-weight: 600;
    white-space: nowrap;
}
.badge {
    font-weight: 500;
}

/* Calendar Styles - Compact to fit screen */
#calendar .card-body {
    padding: 0.75rem;
}
.calendar-legend {
    font-size: 0.75rem;
    margin-bottom: 0.5rem !important;
    gap: 0.75rem !important;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}
.legend-color {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    margin-bottom: 0;
    border-bottom: 2px solid var(--manila-border);
}
.calendar-day-header {
    text-align: center;
    font-weight: 600;
    padding: 6px 2px;
    background: var(--manila-light);
    border-radius: 2px 2px 0 0;
    font-size: 0.75rem;
    color: var(--manila-text);
}
.calendar-day-header.weekend {
    color: var(--manila-text-muted);
}

.calendar-body {
    display: flex;
    flex-direction: column;
    gap: 1px;
}
.calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
}

.calendar-day {
    height: 80px;
    border: 1px solid #dee2e6;
    border-radius: 2px;
    padding: 2px 4px;
    display: flex;
    flex-direction: column;
    position: relative;
    cursor: default;
}
.calendar-day.clickable {
    cursor: pointer;
}
.calendar-day.clickable:hover {
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    border-color: var(--color-accent, #3b82f6);
}
.calendar-day.selected {
    box-shadow: 0 0 0 2px var(--color-accent, #3b82f6);
}
.calendar-day:hover:not(.empty):not(.clickable) {
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.calendar-day.empty {
    background: #f8f9fa;
    border-color: transparent;
}
.calendar-day .day-number {
    font-weight: 600;
    font-size: 0.7rem;
    line-height: 1;
}
.calendar-day .hours {
    font-size: 0.6rem;
    color: #fff;
    margin-top: auto;
    line-height: 1;
}

/* Day type colors */
.calendar-day.worked {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: #fff;
    border-color: #198754;
}
.calendar-day.sick-leave {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: #fff;
    border-color: #dc3545;
}
.calendar-day.annual-leave {
    background: linear-gradient(135deg, #0dcaf0 0%, #6f42c1 100%);
    color: #fff;
    border-color: #0dcaf0;
}
.calendar-day.holiday {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: #212529;
    border-color: #ffc107;
}
.calendar-day.weekend {
    background: #f1f3f5;
    color: #6c757d;
}
.calendar-day.today {
    box-shadow: 0 0 0 2px #0d6efd;
}
/* Mixed day: work + leave split diagonally (green/blue) */
.calendar-day.mixed-day {
    background: linear-gradient(135deg, #198754 0%, #198754 50%, #0dcaf0 50%, #0dcaf0 100%);
    color: #fff;
    border-color: #198754;
}

/* Summary styles - compact */
#calendarSummary {
    margin-top: 0.5rem !important;
}
#calendarSummary hr {
    margin: 0.5rem 0;
}
#calendarSummary h5 {
    font-size: 1rem;
    margin-bottom: 0 !important;
}
#calendarSummary small {
    font-size: 0.65rem;
}
</style>
</div> <!-- End Staff Hours Section -->
