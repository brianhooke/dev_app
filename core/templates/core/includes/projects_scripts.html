<script>
    $(document).ready(function() {
        // Function to reset tender view state (make it global so other scripts can call it)
        window.resetTenderViewState = function() {
            // Reset all tender navigation buttons to default state
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Hide all dynamic action buttons
            $('#newQuoteBtn').hide();
            
            // Clear tender content area
            $('#tenderContentArea').html(`
                <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
            `);
            
            // Clear current tender project
            window.currentTenderProject = null;
        };
        
        // Projects controller - shows inline in workspace
        $('#projectsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            if (typeof window.hideAllSections === 'function') {
                window.hideAllSections();
            }
            
            // Reset tender view state when returning to projects
            resetTenderViewState();
            
            // Reset construction view state when returning to projects
            if (typeof window.resetConstructionViewState === 'function') {
                resetConstructionViewState();
            }
            
            // Hide tender and construction views if showing
            $('#tenderView').hide();
            $('#constructionView').hide();
            
            // Show projects section and add has-content class to hide background
            $('#projectsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Show projects header and grid
            $('#projectsHeader').show();
            $('#projectsGridContainer').show();
            
            // Load projects data
            loadProjects();
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Function to load and display projects
        function loadProjects(showArchived) {
            const archived = showArchived ? '1' : '0';
            
            $.ajax({
                url: '{% url "core:get_projects" %}',
                type: 'GET',
                data: { archived: archived },
                success: function(response) {
                    if (response.status === 'success') {
                        populateProjectsTable(response.projects, showArchived);
                    } else {
                        alert('Error loading projects: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading projects:', error);
                    alert('Failed to load projects. Please try again.');
                }
            });
        }
        
        // Function to populate projects table with data
        // Populate projects as card grid (replaces old table-based populateProjectsTable)
        function populateProjectsTable(projects, showingArchived) {
            const grid = $('#projectsGrid');
            
            console.log('üìä Populating projects grid with', projects.length, 'projects');
            
            // Clear existing cards
            grid.empty();
            
            if (projects.length === 0) {
                const message = showingArchived ? 'No archived projects found.' : 'No projects found. Click "Add Project" to create one.';
                grid.html(`<div class="projects-empty"><i class="fas fa-folder-open"></i><p>${message}</p></div>`);
                return;
            }
            
            // Determine archive button appearance based on view
            const archiveBtnClass = showingArchived ? 'btn-outline-success' : 'btn-outline-danger';
            const archiveBtnIcon = showingArchived ? 'fa-box-open' : 'fa-archive';
            const archiveBtnTitle = showingArchived ? 'Restore' : 'Archive';
            
            // Add project cards
            projects.forEach(project => {
                console.log(`üìÅ Project: ${project.project}`);
                
                const typeClass = project.project_type || 'general';
                
                const card = $(`
                    <div class="project-card" data-project-pk="${project.projects_pk}">
                        <div class="card-header">
                            <h5 class="card-title">${project.project}</h5>
                        </div>
                        <div class="card-body">
                            <div class="card-info">
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-tag"></i></span>
                                    <span class="type-badge ${typeClass}">${project.project_type_display || 'General'}</span>
                                </div>
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-user"></i></span>
                                    <span class="card-label">Manager:</span>
                                    <span class="card-value">${project.manager || '-'}</span>
                                </div>
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-building"></i></span>
                                    <span class="card-label">Xero:</span>
                                    <span class="card-value">${project.xero_instance_name || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <a href="#" class="project-status-link" data-status="${project.project_status}">Tender</a>
                                <a href="#" class="construction-link">Execution</a>
                            </div>
                            <div class="card-actions">
                                <button class="btn ${archiveBtnClass} btn-sm archive-project-btn" title="${archiveBtnTitle}">
                                    <i class="fas ${archiveBtnIcon}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                // Store project data on the card for click handlers
                card.data('project-pk', project.projects_pk);
                card.data('original-project', project.project);
                card.data('original-sales-account', project.xero_sales_account || '');
                card.data('original-manager', project.manager || '');
                card.data('original-manager-email', project.manager_email || '');
                card.data('original-contracts-admin-emails', project.contracts_admin_emails || '');
                card.data('xero-instance-pk', project.xero_instance_pk);
                card.data('project-type', project.project_type);
                
                grid.append(card);
            });
        }
        
        // Toggle Archive button handler
        $('#toggleArchiveBtn').click(function() {
            const currentlyShowingArchived = $(this).data('showing-archived') === 1;
            const newShowingArchived = !currentlyShowingArchived;
            
            // Update button state
            $(this).data('showing-archived', newShowingArchived ? 1 : 0);
            
            if (newShowingArchived) {
                $(this).html('<i class="fas fa-list"></i> Show Active');
            } else {
                $(this).html('<i class="fas fa-archive"></i> Show Archived');
            }
            
            // Load projects with new filter
            loadProjects(newShowingArchived);
        });
        
        // ========== PROJECT CARDS (MODALS) FUNCTIONALITY ==========
        var currentModalProject = null;
        var isEditMode = false;
        var isCreateMode = false;
        var xeroInstancesCache = null;
        var xeroAccountsCache = {};
        
        // Add Project button - open modal in create mode
        $(document).on('click', '#addProjectBtn', function() {
            openProjectModal(null, true);
        });
        
        // Click on project card to open modal
        $(document).on('click', '.project-card', function(e) {
            // Don't open modal if clicking on a button or link
            if ($(e.target).closest('a, button').length) return;
            
            const card = $(this);
            const project = {
                projects_pk: card.data('project-pk'),
                project: card.find('.card-title').text(),
                project_type: card.data('project-type'),
                manager: card.data('original-manager'),
                manager_email: card.data('original-manager-email'),
                contracts_admin_emails: card.data('original-contracts-admin-emails'),
                xero_instance_pk: card.data('xero-instance-pk'),
                xero_sales_account: card.data('original-sales-account')
            };
            openProjectModal(project, false);
        });
        
        // Open project modal
        function openProjectModal(project, createMode) {
            currentModalProject = project;
            isCreateMode = createMode;
            isEditMode = false;
            
            // Reset modal state
            clearValidationErrors();
            
            // Load Xero instances for dropdown
            loadXeroInstances().then(function() {
                if (createMode) {
                    // Create mode
                    $('#projectModalTitle').text('New Project');
                    
                    // Clear all fields
                    $('#modalProjectName').val('');
                    $('#modalProjectType').val('general');
                    $('#modalManager').val('');
                    $('#modalManagerEmail').val('');
                    $('#modalContractsAdminEmails').val('');
                    $('#modalXeroInstance').val('');
                    $('#modalSalesAccount').html('<option value="">Select Xero Instance first...</option>');
                    
                    // Enable all inputs for create mode
                    enableFormInputs(true);
                    
                    // Show create button, hide others
                    $('#modalUpdateBtn').hide();
                    $('#modalSaveBtn').hide();
                    $('#modalCreateBtn').show();
                    $('.nav-buttons').hide();
                } else {
                    // View mode
                    $('#projectModalTitle').text(project.project);
                    
                    // Populate fields
                    $('#modalProjectName').val(project.project);
                    $('#modalProjectType').val(project.project_type);
                    $('#modalManager').val(project.manager || '');
                    $('#modalManagerEmail').val(project.manager_email || '');
                    $('#modalContractsAdminEmails').val(project.contracts_admin_emails || '');
                    $('#modalXeroInstance').val(project.xero_instance_pk || '');
                    
                    // Load sales accounts for the selected Xero instance
                    if (project.xero_instance_pk) {
                        loadXeroAccounts(project.xero_instance_pk).then(function() {
                            $('#modalSalesAccount').val(project.xero_sales_account || '');
                        });
                    }
                    
                    // Disable all inputs (view mode)
                    enableFormInputs(false);
                    
                    // Show update button, hide save/create
                    $('#modalUpdateBtn').show();
                    $('#modalSaveBtn').hide();
                    $('#modalCreateBtn').hide();
                    $('.nav-buttons').show();
                }
                
                $('#projectModal').addClass('show');
            });
        }
        
        // Load Xero instances for Project modal dropdown
        function loadXeroInstances() {
            if (xeroInstancesCache) {
                populateXeroInstances(xeroInstancesCache);
                return Promise.resolve();
            }
            
            return $.ajax({
                url: '/core/get_xero_instances/',
                type: 'GET'
            }).then(function(response) {
                // API returns array directly
                xeroInstancesCache = Array.isArray(response) ? response : [];
                populateXeroInstances(xeroInstancesCache);
            });
        }

        // Populate Xero instances dropdown for Project modal
        function populateXeroInstances(instances) {
            const select = $('#modalXeroInstance');
            select.html('<option value="">Select Xero Instance...</option>');
            instances.forEach(function(inst) {
                select.append(`<option value="${inst.xero_instance_pk}">${inst.xero_name}</option>`);
            });
        }
        
        // Load Xero accounts for an instance (with optional target select)
        function loadXeroAccounts(instancePk, targetSelect) {
            const select = targetSelect || $('#modalSalesAccount');
            
            if (xeroAccountsCache[instancePk]) {
                populateXeroAccounts(xeroAccountsCache[instancePk], select);
                return Promise.resolve();
            }
            
            return $.ajax({
                url: `/core/get_xero_accounts/${instancePk}/`,
                type: 'GET'
            }).then(function(response) {
                const accounts = response.accounts || [];
                // Filter for revenue/sales accounts
                const filtered = accounts.filter(acc => 
                    acc.account_type === 'REVENUE' || 
                    acc.account_type === 'SALES' || 
                    acc.account_type === 'OTHERINCOME'
                );
                xeroAccountsCache[instancePk] = filtered;
                populateXeroAccounts(filtered, select);
            }).catch(function() {
                select.prop('disabled', true).html('<option value="">Error loading accounts</option>');
            });
        }
        
        function populateXeroAccounts(accounts, targetSelect) {
            const select = targetSelect || $('#modalSalesAccount');
            select.prop('disabled', false);
            select.html('<option value="">Select Sales Account...</option>');
            accounts.forEach(function(acc) {
                select.append(`<option value="${acc.account_code}">${acc.account_code} - ${acc.account_name}</option>`);
            });
        }
        
        // Xero instance change handler
        $('#modalXeroInstance').on('change', function() {
            const instancePk = $(this).val();
            if (instancePk) {
                loadXeroAccounts(instancePk);
            } else {
                $('#modalSalesAccount').html('<option value="">Select Xero Instance first...</option>');
            }
        });
        
        // Enable/disable form inputs
        function enableFormInputs(enable) {
            $('#modalProjectName').prop('disabled', !enable);
            $('#modalProjectType').prop('disabled', !enable);
            $('#modalManager').prop('disabled', !enable);
            $('#modalManagerEmail').prop('disabled', !enable);
            $('#modalContractsAdminEmails').prop('disabled', !enable);
            $('#modalXeroInstance').prop('disabled', !enable);
            $('#modalSalesAccount').prop('disabled', !enable);
        }
        
        // Form Validation
        function validateForm() {
            let isValid = true;
            clearValidationErrors();
            
            // Project name required
            if (!$('#modalProjectName').val().trim()) {
                $('#modalProjectName').addClass('is-invalid');
                isValid = false;
            }
            
            // Xero instance required
            if (!$('#modalXeroInstance').val()) {
                $('#modalXeroInstance').addClass('is-invalid');
                isValid = false;
            }
            
            // Sales account required
            if (!$('#modalSalesAccount').val()) {
                $('#modalSalesAccount').addClass('is-invalid');
                isValid = false;
            }
            
            return isValid;
        }
        
        function clearValidationErrors() {
            $('.form-control').removeClass('is-invalid');
        }
        
        // Update button - enable edit mode
        $('#modalUpdateBtn').on('click', function() {
            isEditMode = true;
            enableFormInputs(true);
            // Disable project type change for existing projects
            $('#modalProjectType').prop('disabled', true);
            
            $(this).hide();
            $('#modalSaveBtn').show();
        });
        
        // Save Changes button
        $('#modalSaveBtn').on('click', function() {
            if (!validateForm()) return;
            
            const formData = new FormData();
            formData.append('project_name', $('#modalProjectName').val().trim());
            formData.append('xero_instance_pk', $('#modalXeroInstance').val());
            formData.append('xero_sales_account', $('#modalSalesAccount').val());
            formData.append('manager', $('#modalManager').val().trim());
            formData.append('manager_email', $('#modalManagerEmail').val().trim());
            formData.append('contracts_admin_emails', $('#modalContractsAdminEmails').val().trim());
            
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            
            $.ajax({
                url: `/core/update_project/${currentModalProject.projects_pk}/`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#projectModal').removeClass('show');
                        loadProjects($('#toggleArchiveBtn').data('showing-archived') === 1);
                    } else {
                        alert(response.message || 'Error saving project');
                    }
                    btn.prop('disabled', false).html('Save Changes');
                },
                error: function() {
                    alert('Error saving project');
                    btn.prop('disabled', false).html('Save Changes');
                }
            });
        });
        
        // Create Project button
        $('#modalCreateBtn').on('click', function() {
            if (!validateForm()) return;
            
            const formData = new FormData();
            formData.append('project_name', $('#modalProjectName').val().trim());
            formData.append('project_type', $('#modalProjectType').val());
            formData.append('xero_instance_pk', $('#modalXeroInstance').val());
            formData.append('xero_sales_account', $('#modalSalesAccount').val());
            formData.append('manager', $('#modalManager').val().trim());
            formData.append('manager_email', $('#modalManagerEmail').val().trim());
            formData.append('contracts_admin_emails', $('#modalContractsAdminEmails').val().trim());
            
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');
            
            $.ajax({
                url: '/core/create_project/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#projectModal').removeClass('show');
                        loadProjects(false);
                    } else {
                        alert(response.message || 'Error creating project');
                    }
                    btn.prop('disabled', false).html('Create Project');
                },
                error: function() {
                    alert('Error creating project');
                    btn.prop('disabled', false).html('Create Project');
                }
            });
        });
        
        // Modal Tender button clicked --> trigger tender view
        $('#modalTenderBtn').on('click', function(e) {
            e.preventDefault();
            if (!currentModalProject) return;
            
            // Close modal and trigger tender view
            $('#projectModal').removeClass('show');
            
            // Find the card and trigger tender link click
            const card = $(`.project-card[data-project-pk="${currentModalProject.projects_pk}"]`);
            card.find('.project-status-link').click();
        });
        
        // Modal Execution button
        $('#modalExecutionBtn').on('click', function(e) {
            e.preventDefault();
            if (!currentModalProject) return;
            
            // Close modal and trigger execution view
            $('#projectModal').removeClass('show');
            
            // Find the card and trigger construction link click
            const card = $(`.project-card[data-project-pk="${currentModalProject.projects_pk}"]`);
            card.find('.construction-link').click();
        });
        
        // Close modal handlers
        $('#projectModalClose, #modalCancelBtn').on('click', function() {
            $('#projectModal').removeClass('show');
            currentModalProject = null;
            isEditMode = false;
            isCreateMode = false;
        });
        
        // Click outside modal to close
        $('#projectModal').on('click', function(e) {
            if ($(e.target).hasClass('project-modal')) {
                $(this).removeClass('show');
                currentModalProject = null;
                isEditMode = false;
                isCreateMode = false;
            }
        });
        // ========== END PROJECT MODAL FUNCTIONALITY ==========
        
        // Handle Xero Instance selection for inline add rows (reuses loadXeroAccounts)
        $(document).on('change', '.add-xero-instance', function() {
            const xeroInstancePk = $(this).val();
            const salesAccountSelect = $(this).closest('tr').find('.add-sales-account');
            
            if (!xeroInstancePk) {
                salesAccountSelect.prop('disabled', true).html('<option value="">Select Xero Instance first</option>');
                return;
            }
            
            loadXeroAccounts(xeroInstancePk, salesAccountSelect);
        });
        
        // Save new project handler
        $(document).on('click', '.save-new-project-btn', function() {
            const row = $(this).closest('tr');
            const projectName = row.find('.add-project-name').val().trim();
            const projectType = row.find('.add-project-type').val();
            const xeroInstancePk = row.find('.add-xero-instance').val();
            const salesAccount = row.find('.add-sales-account').val();
            const manager = row.find('.add-manager').val().trim();
            const managerEmail = row.find('.add-manager-email').val().trim();
            const contractsAdminEmails = row.find('.add-contracts-admin-emails').val().trim();
            
            // Validate required fields
            if (!projectName) {
                alert('Project name is required');
                row.find('.add-project-name').focus();
                return;
            }
            
            if (!xeroInstancePk) {
                alert('Xero Instance is required');
                row.find('.add-xero-instance').focus();
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('project_name', projectName);
            formData.append('project_type', projectType);
            formData.append('xero_instance_pk', xeroInstancePk);
            if (salesAccount) {
                formData.append('xero_sales_account', salesAccount);
            }
            if (manager) {
                formData.append('manager', manager);
            }
            if (managerEmail) {
                formData.append('manager_email', managerEmail);
            }
            if (contractsAdminEmails) {
                formData.append('contracts_admin_emails', contractsAdminEmails);
            }
            // Note: project_status will default to 0 (Tender) in the backend
            
            // Show processing state
            $(this).prop('disabled', true).text('Saving...');
            
            // Make AJAX call to create project
            $.ajax({
                url: '{% url "core:create_project" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        // Remove add row
                        row.remove();
                        
                        // Reload projects list to show new project
                        loadProjects();
                        
                        alert('Project created successfully!');
                    } else {
                        alert('Error creating project: ' + response.message);
                        row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating project:', error);
                    alert('Failed to create project. Please try again.');
                    row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                }
            });
        });
        
        // Cancel add project handler
        $(document).on('click', '.cancel-add-project-btn', function() {
            const row = $(this).closest('tr');
            row.remove();
            
            // If no rows left, show empty state
            const tbody = $('#projectsTableBody');
            if (tbody.find('tr').length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #6c757d;">
                            No projects found. Click "Add Project" to create one.
                        </td>
                    </tr>
                `);
            }
        });
        
        // Handle Construction link click - show construction view (Execution mode)
        $(document).on('click', '.construction-link', function(e) {
            e.preventDefault();
            
            // Support both card grid and legacy table row
            const card = $(this).closest('.project-card');
            const row = card.length ? card : $(this).closest('tr');
            
            const projectPk = row.data('project-pk');
            const projectName = card.length ? card.find('.card-title').text() : row.find('.project-name').text();
            const xeroInstancePk = row.data('xero-instance-pk');
            const projectType = row.data('project-type');
            
            console.log(`Opening construction view for project: ${projectName} (pk=${projectPk})`);
            console.log(`Xero Instance PK: ${xeroInstancePk}`);
            console.log(`Project Type: ${projectType}`);
            
            // Store current project info globally
            window.currentConstructionProject = {
                pk: projectPk,
                name: projectName,
                xero_instance_pk: xeroInstancePk,
                project_type: projectType
            };
            
            // Hide projects header and grid
            $('#projectsHeader').hide();
            $('#projectsGridContainer').hide();
            
            // Reset all construction nav buttons to outline state (none selected initially)
            $('.construction-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            $('#billsButtonGroup').removeClass('active');
            
            // Clear content area with placeholder
            $('#constructionContentArea').html('<p style="text-align: center; color: #6c757d; padding: 40px;">Select a section above to view content.</p>');
            
            // Show construction view
            $('#constructionView').css('display', 'flex').show();
            $('#constructionProjectName').text(projectName);
        });
        
        // Handle Construction navigation button clicks
        $(document).on('click', '.construction-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Construction section clicked: ${section}`);
            
            // Remove active class from all buttons (except bills main btn which is handled separately)
            $('.construction-nav-btn:not(.bills-main-btn)').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Deactivate bills button group if clicking another section
            if (section !== 'bills') {
                $('#billsButtonGroup').removeClass('active');
                $('.bills-main-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            }
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#constructionNewQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadConstructionQuotesSection();
            } else if (section === 'pos') {
                loadConstructionPOSection();
            } else if (section === 'contract-budget') {
                loadConstructionContractBudgetSection();
            } else if (section === 'hc-variations') {
                loadConstructionHCVariationsSection();
            } else if (section === 'hc-claims') {
                loadConstructionHCClaimsSection();
            } else if (section === 'bills') {
                // Activate the bills button group and show sub-buttons
                $('#billsButtonGroup').addClass('active');
                $('.bills-main-btn').removeClass('btn-outline-primary').addClass('btn-primary');
                // Default to unallocated if no sub-button is active
                const activeSubBtn = $('.bills-sub-btn.active');
                const subsection = activeSubBtn.length ? activeSubBtn.data('subsection') : 'unallocated';
                loadConstructionBillsSection(subsection);
            } else if (section === 'documents') {
                loadConstructionDocumentsSection();
            }
        });
        
        // Handle Bills sub-menu button clicks
        $(document).on('click', '.bills-sub-btn', function() {
            const subsection = $(this).data('subsection');
            console.log(`Bills subsection clicked: ${subsection}`);
            
            // Update active state on sub-buttons
            $('.bills-sub-btn').removeClass('active');
            $(this).addClass('active');
            
            // Load the appropriate bills view
            loadConstructionBillsSection(subsection);
        });
        
        // ==========================================
        // QUOTES SECTION - Navigation only
        // All quote logic is now in quotes.html (self-contained)
        // ==========================================
        
        // Load the quotes section view for CONSTRUCTION
        // REFACTORED: Only sets project context and loads template - quotes.html handles everything else
        function loadConstructionQuotesSection() {
            console.log('Loading quotes section - quotes.html handles initialization');
            
            // Set shared project reference for quotes (quotes.html will use this)
            window.currentQuotesProject = {
                pk: window.currentConstructionProject.pk,
                project_type: window.currentConstructionProject.project_type,
                contacts: window.constructionProjectContacts || []
            };
            
            // Load contacts for the project if not already loaded
            if (!window.constructionProjectContacts || window.constructionProjectContacts.length === 0) {
                const projectPk = window.currentConstructionProject.pk;
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectPk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.constructionProjectContacts = response.contacts;
                            window.currentQuotesProject.contacts = response.contacts;
                            console.log('Loaded', response.contacts.length, 'contacts for quotes');
                        }
                    }
                });
            }
            
            var projectPk = window.currentConstructionProject ? window.currentConstructionProject.pk : null;
            
            $.ajax({
                url: '{% url "core:quotes" %}?project_pk=' + projectPk,
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                    // Clone New Quote button to title actions area
                    var newQuoteBtn = $('#constructionNewQuoteBtn').clone().attr('id', 'quoteTitleNewQuoteBtn');
                    $('#quoteTitleActions').empty().append(newQuoteBtn.show());
                    newQuoteBtn.on('click', function() {
                        $('#constructionQuotePdfInput').click();
                    });
                    // quotes.html self-initializes via its own script
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Quotes</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
                
        // Load construction documents section for CONSTRUCTION
        function loadConstructionDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction contract budget section for CONSTRUCTION
        function loadConstructionContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction PO section for CONSTRUCTION
        function loadConstructionPOSection() {
            window.loadSharedPOSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction HC Variations section for CONSTRUCTION
        function loadConstructionHCVariationsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-exchange-alt" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Variations</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // Load construction HC Claims section for CONSTRUCTION
        function loadConstructionHCClaimsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-file-bill-dollar" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Claims</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // Load bills section - Gold Standard: minimal fetch, all logic in bills_project.html
        function loadConstructionBillsSection(subsection = 'unallocated') {
            console.log(`Loading bills section: ${subsection}`);
            
            var projectPk = window.currentConstructionProject ? window.currentConstructionProject.pk : null;
            var templateType = subsection === 'allocated' ? 'allocated' : 'unallocated';
            
            $.ajax({
                url: '{% url "core:bills" %}?project_pk=' + projectPk + '&template=' + templateType,
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Bills</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // ==========================================
        // SHARED DOCUMENTS FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedDocumentsSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for documents');
                return;
            }
            
            // Load the documents template from hidden storage
            var documentsHtml = $('#documentsTemplateStorage').html();
            $(`#${contentAreaId}`).html(documentsHtml);
            
            // Initialize DocumentsManager module with container context
            DocumentsManager.init({
                projectPk: projectObj.pk,
                containerSelector: `#${contentAreaId}`
            });
            
            console.log('Documents section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED CONTRACT BUDGET FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedContractBudgetSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for contract budget');
                return;
            }
            
            // Set global context variables BEFORE loading template
            // The template's inline script will read these
            window.currentContractBudgetProject = projectObj;
            window.currentContractBudgetContainer = `#${contentAreaId}`;
            
            // Load the contract budget template from hidden storage
            var contractBudgetHtml = $('#contractBudgetTemplateStorage').html();
            $(`#${contentAreaId}`).html(contractBudgetHtml);
            
            console.log('Contract Budget section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED PO FUNCTION (used by Construction and future project types)
        // ==========================================
        
        // Load PO section - minimal fetch, all logic in po.html (Gold Standard)
        window.loadSharedPOSection = function(config) {
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for POs');
                return;
            }
            
            $.ajax({
                url: '{% url "core:po" %}?project_pk=' + projectObj.pk,
                type: 'GET',
                success: function(response) {
                    $(`#${contentAreaId}`).html(response);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load PO section:', error);
                    $(`#${contentAreaId}`).html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading POs</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        };
        
        // Handle Tender navigation button clicks
        $(document).on('click', '.tender-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Tender section clicked: ${section}`);
            
            // Remove active class from all buttons
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#newQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadQuotesSection();
            } else if (section === 'items') {
                // Load Items section from hidden storage - items.html self-initializes
                var itemsContent = $('#itemsTemplateStorage').html();
                $('#tenderContentArea').html(itemsContent);
                console.log('Items section loaded - items.html handles initialization');
            } else if (section === 'documents') {
                // Load Documents section
                loadDocumentsSection();
            } else if (section === 'contract-budget') {
                // Load Contract Budget section
                loadContractBudgetSection();
            } else {
                // Placeholder for other sections
                $('#tenderContentArea').html(`
                    <h4>${section.charAt(0).toUpperCase() + section.slice(1).replace('-', ' ')}</h4>
                    <p style="color: #6c757d;">Content for ${section} will be implemented next.</p>
                `);
            }
        });
        
        // Tender Quote Functions - Uses same template as Construction
        
        // Load the quotes section view for TENDER
        // REFACTORED: Only sets project context and loads template - quotes.html handles everything else
        function loadQuotesSection() {
            console.log('Loading quotes section for Tender - quotes.html handles initialization');
            
            // Set shared project reference for quotes (quotes.html will use this)
            window.currentQuotesProject = {
                pk: window.currentTenderProject.pk,
                project_type: window.currentTenderProject.project_type,
                contacts: window.projectContacts || []
            };
            
            // Load contacts for the project if not already loaded
            if (!window.projectContacts || window.projectContacts.length === 0) {
                const projectPk = window.currentTenderProject.pk;
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectPk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.projectContacts = response.contacts;
                            window.currentQuotesProject.contacts = response.contacts;
                            console.log('Loaded', response.contacts.length, 'contacts for Tender quotes');
                        }
                    }
                });
            }
            
            var projectPk = window.currentTenderProject ? window.currentTenderProject.pk : null;
            
            $.ajax({
                url: '{% url "core:quotes" %}?project_pk=' + projectPk,
                type: 'GET',
                success: function(response) {
                    $('#tenderContentArea').html(response);
                    // Clone New Quote button to title actions area
                    var newQuoteBtn = $('#newQuoteBtn').clone().attr('id', 'quoteTitleNewQuoteBtn');
                    $('#quoteTitleActions').empty().append(newQuoteBtn.show());
                    newQuoteBtn.on('click', function() {
                        $('#quotePdfInput').click();
                    });
                    // quotes.html self-initializes via its own script
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes section:', error);
                    $('#tenderContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Quotes</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load the documents section view for TENDER
        function loadDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
        
        // Load the contract budget section view for TENDER
        function loadContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
    });
</script>
