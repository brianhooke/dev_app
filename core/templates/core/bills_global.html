<!-- Bills Global - Consolidated Template -->
<!-- Contains Inbox, Direct, and Approvals sections -->
{% load static %}

<!-- =====================================================
     INBOX SECTION
     ===================================================== -->
<div id="billsInboxSectionWrapper" style="display: flex; flex-direction: column; height: 100%; flex: 1;">
{% include "core/components/allocations_layout.html" with section_id="billsInbox" main_table_columns=inbox_main_columns allocations_columns=inbox_alloc_columns hide_allocations=True viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}
</div>

<!-- =====================================================
     DIRECT SECTION
     ===================================================== -->
<div id="billsDirectSectionWrapper" style="display: none; flex-direction: column; height: 100%; flex: 1;">
{% include "core/components/allocations_layout.html" with section_id="billsDirect" main_table_columns=direct_main_columns allocations_columns=direct_alloc_columns hide_allocations=False viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}
</div>

<!-- =====================================================
     APPROVALS SECTION
     ===================================================== -->
<div id="billsApprovalsSectionWrapper" style="display: none; flex-direction: column; height: 100%; flex: 1;">
{% include "core/components/allocations_layout.html" with section_id="billsApprovals" main_table_columns=approvals_main_columns allocations_columns=approvals_alloc_columns hide_allocations=False viewer_placeholder_text="Click on a bill to view the PDF" viewer_placeholder_icon="fas fa-file-pdf" %}
</div>

<!-- Toggle switch for Pending vs Sent bills in Approvals -->
<style>
    .approvals-toggle-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .approvals-toggle-switch {
        position: relative;
        width: 32px;
        height: 16px;
        background: #ccc;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .approvals-toggle-switch.active {
        background: #4a90d9;
    }
    .approvals-toggle-switch .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        transition: left 0.2s;
    }
    .approvals-toggle-switch.active .toggle-slider {
        left: 18px;
    }
    .approvals-toggle-label {
        font-size: 11px;
        color: #888;
        cursor: pointer;
    }
    .approvals-toggle-label.active {
        color: #333;
        font-weight: 600;
    }
</style>
<script>
$(document).ready(function() {
    // Add toggle switch to the approvals section (after it's visible)
    var toggleAdded = false;
    function addToggleSwitch() {
        if (toggleAdded || !$('.billsApprovals-left-panel').length) return;
        var toggleHtml = '<div class="approvals-toggle-container">' +
            '<span class="approvals-toggle-label active" data-mode="pending">Pending</span>' +
            '<div class="approvals-toggle-switch">' +
            '<div class="toggle-slider"></div>' +
            '</div>' +
            '<span class="approvals-toggle-label" data-mode="sent">Sent</span>' +
            '</div>';
        $('.billsApprovals-table-container').first().before(toggleHtml);
        toggleAdded = true;
    }
    
    // Call when approvals section becomes visible
    var observer = new MutationObserver(function(mutations) {
        if ($('#billsApprovalsSectionWrapper').css('display') !== 'none') {
            addToggleSwitch();
            // Reset toggle to Pending mode when section becomes visible
            resetToggleToPending();
        }
    });
    observer.observe(document.getElementById('billsApprovalsSectionWrapper') || document.body, { attributes: true, attributeFilter: ['style'] });
    
    // Reset toggle to Pending state
    function resetToggleToPending() {
        $('.approvals-toggle-switch').removeClass('active');
        $('.approvals-toggle-label[data-mode="pending"]').addClass('active');
        $('.approvals-toggle-label[data-mode="sent"]').removeClass('active');
        window.approvalsMode = 'pending';
    }
    
    // Toggle switch click handler
    $(document).on('click', '.approvals-toggle-switch, .approvals-toggle-label', function() {
        var clickedMode = $(this).data('mode');
        var isCurrentlySent = window.approvalsMode === 'sent';
        
        // Determine new mode
        var newMode;
        if (clickedMode === 'pending') {
            newMode = 'pending';
        } else if (clickedMode === 'sent') {
            newMode = 'sent';
        } else {
            // Clicked on switch itself - toggle
            newMode = isCurrentlySent ? 'pending' : 'sent';
        }
        
        // Don't do anything if mode hasn't changed
        if (newMode === window.approvalsMode) return;
        
        window.approvalsMode = newMode;
        
        // Update toggle UI
        if (newMode === 'sent') {
            $('.approvals-toggle-switch').addClass('active');
            $('.approvals-toggle-label[data-mode="pending"]').removeClass('active');
            $('.approvals-toggle-label[data-mode="sent"]').addClass('active');
            loadSentBills();
        } else {
            $('.approvals-toggle-switch').removeClass('active');
            $('.approvals-toggle-label[data-mode="pending"]').addClass('active');
            $('.approvals-toggle-label[data-mode="sent"]').removeClass('active');
            loadApprovedBills();
        }
    });
    
    // Load Sent Bills data (status 3, 4, or 104)
    window.loadSentBills = function() {
        console.log('=== loadSentBills called ===');
        
        $.ajax({
            url: '{% url "core:get_sent_bills" %}',
            type: 'GET',
            success: function(response) {
                if (!$('#billsApprovalsMainTableBody').length) return;
                
                console.log('Sent Bills - count:', response.bills ? response.bills.length : 0);
                window.billsApprovalsData = response.bills;
                
                // Custom render for sent bills - replace action columns with Sent date
                var tbody = $('#billsApprovalsMainTableBody');
                tbody.empty();
                
                if (!response.bills || response.bills.length === 0) {
                    tbody.html('<tr><td colspan="12" class="text-center text-muted p-4">No sent bills found</td></tr>');
                    return;
                }
                
                // Remove last 2 col elements from colgroup for sent mode
                $('#billsApprovalsMainTable colgroup col:nth-child(11), #billsApprovalsMainTable colgroup col:nth-child(12)').remove();
                // Remove last 2 th elements
                $('#billsApprovalsMainTable thead th:nth-child(11), #billsApprovalsMainTable thead th:nth-child(12)').remove();
                // Update 10th header to "Sent" and make it sortable
                $('#billsApprovalsMainTable thead th:nth-child(10)').text('Sent').addClass('sortable');
                
                // Set new column widths (10 columns = 100%)
                var sentWidths = ['11%', '11%', '11%', '11%', '10%', '10%', '9%', '9%', '9%', '9%'];
                var colgroup = $('#billsApprovalsMainTable colgroup col');
                var headers = $('#billsApprovalsMainTable thead th');
                for (var i = 0; i < 10; i++) {
                    colgroup.eq(i).attr('style', 'width: ' + sentWidths[i]);
                    headers.eq(i).attr('style', 'width: ' + sentWidths[i]);
                }
                
                // Now render rows with only 10 cells
                response.bills.forEach(function(bill) {
                    var pdfUrl = bill.pdf_url || '';
                    var row = $('<tr>')
                        .attr('data-pk', bill.bill_pk)
                        .attr('data-bill-pk', bill.bill_pk)
                        .attr('data-pdf-url', pdfUrl);
                    
                    row.append($('<td>').attr('title', bill.project_name || '-').text(bill.project_name || '-'));
                    row.append($('<td>').attr('title', bill.xero_instance_name || '-').text(bill.xero_instance_name || '-'));
                    row.append($('<td>').attr('title', bill.supplier_name || '-').text(bill.supplier_name || '-'));
                    row.append($('<td>').attr('title', bill.supplier_bill_number || '-').text(bill.supplier_bill_number || '-'));
                    row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gross)));
                    row.append($('<td>').text('$' + Utils.formatMoney(bill.total_net)));
                    row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gst)));
                    row.append($('<td>').text(bill.bill_date ? Utils.formatDateDMY(bill.bill_date) : '-'));
                    row.append($('<td>').text(bill.bill_due_date ? Utils.formatDateDMY(bill.bill_due_date) : '-'));
                    row.append($('<td>').text(bill.sent_at ? Utils.formatDateDMY(bill.sent_at) : '-'));
                    
                    tbody.append(row);
                });
                
                Utils.addTruncationTooltips('billsApprovalsMainTable');
                
                // Initialize sortable table functionality for sent mode
                Utils.initSortableTable('billsApprovalsMainTable', {
                    tbodyId: 'billsApprovalsMainTableBody'
                });
            },
            error: function(xhr, status, error) {
                console.error('Failed to load sent bills:', error);
                $('#billsApprovalsMainTableBody').html('<tr><td colspan="12" class="text-center text-danger">Failed to load bills</td></tr>');
            }
        });
    };
    
    // Debug function to show all column styling
    window.debugApprovalsColumns = function() {
        var table = document.getElementById('billsApprovalsMainTable');
        if (!table) {
            console.log('Table not found');
            return;
        }
        
        console.log('--- Table Styles ---');
        var tableStyles = window.getComputedStyle(table);
        console.log('table-layout:', tableStyles.tableLayout);
        console.log('width:', tableStyles.width);
        console.log('table offsetWidth:', table.offsetWidth);
        console.log('table style attribute:', table.getAttribute('style'));
        
        console.log('\n--- Parent Chain ---');
        var el = table.parentElement;
        while (el && el !== document.body) {
            var s = window.getComputedStyle(el);
            console.log(el.tagName + '#' + el.id + ': width=' + s.width + ', padding=' + s.padding + ', overflow=' + s.overflow);
            el = el.parentElement;
        }
        
        console.log('\n--- Colgroup Col Elements ---');
        var cols = table.querySelectorAll('colgroup col');
        cols.forEach(function(col, i) {
            var styles = window.getComputedStyle(col);
            console.log('col[' + i + ']: width=' + styles.width + ', visibility=' + styles.visibility + ', display=' + styles.display);
        });
        
        console.log('\n--- Header TH Elements ---');
        var ths = table.querySelectorAll('thead th');
        var totalThWidth = 0;
        ths.forEach(function(th, i) {
            var styles = window.getComputedStyle(th);
            var rect = th.getBoundingClientRect();
            totalThWidth += rect.width;
            console.log('th[' + i + ']: computed=' + styles.width + ', actual=' + rect.width.toFixed(1) + 'px, visibility=' + styles.visibility + ', display=' + styles.display + ', text="' + th.textContent.trim() + '"');
        });
        console.log('Total TH width:', totalThWidth.toFixed(1) + 'px');
        
        console.log('\n--- First Row TD Elements ---');
        var firstRow = table.querySelector('tbody tr');
        if (firstRow) {
            var tds = firstRow.querySelectorAll('td');
            var totalTdWidth = 0;
            tds.forEach(function(td, i) {
                var styles = window.getComputedStyle(td);
                var rect = td.getBoundingClientRect();
                totalTdWidth += rect.width;
                console.log('td[' + i + ']: computed=' + styles.width + ', actual=' + rect.width.toFixed(1) + 'px, visibility=' + styles.visibility);
            });
            console.log('Total TD width:', totalTdWidth.toFixed(1) + 'px');
        }
        
        console.log('\n--- Container ---');
        var container = document.getElementById('billsApprovalsTableContainer');
        if (container) {
            var cs = window.getComputedStyle(container);
            console.log('Container width:', container.offsetWidth + 'px', 'clientWidth:', container.clientWidth + 'px');
            console.log('Container padding:', cs.padding, 'overflow:', cs.overflow);
        }
    };
    
    // Override loadApprovedBills to restore headers when switching back to pending
    var originalLoadApprovedBills = window.loadApprovedBills;
    window.loadApprovedBills = function() {
        // Restore columns if they were removed (sent mode removes cols 11 & 12)
        var colgroup = $('#billsApprovalsMainTable colgroup');
        var thead = $('#billsApprovalsMainTable thead tr');
        
        // If only 10 cols, we need to restore 11 & 12
        if (colgroup.find('col').length === 10) {
            colgroup.append('<col style="width: 7%;">');
            colgroup.append('<col style="width: 5%;">');
            thead.append('<th style="width: 7%;" class="col-action">Mark X</th>');
            thead.append('<th style="width: 5%;" class="col-action">Return</th>');
        }
        
        // Restore 10th header text and remove sortable class (Send button column isn't sortable)
        $('#billsApprovalsMainTable thead th:nth-child(10)').text('Send').removeClass('sortable');
        
        // Restore original column widths for pending mode (12 columns)
        var pendingWidths = ['10%', '10%', '10%', '9%', '8%', '8%', '7%', '7%', '7%', '7%', '7%', '5%'];
        var cols = $('#billsApprovalsMainTable colgroup col');
        var headers = $('#billsApprovalsMainTable thead th');
        pendingWidths.forEach(function(w, i) {
            cols.eq(i).attr('style', 'width: ' + w);
            headers.eq(i).attr('style', 'width: ' + w);
        });
        
        if (typeof originalLoadApprovedBills === 'function') {
            originalLoadApprovedBills();
        }
    };
});
</script>

<!-- Bills Inbox compact styling -->
<style>
    /* Hide searchable dropdown wrapper for stocktake rows */
    tr.stocktake-mode .searchable-dropdown-wrapper {
        display: none !important;
    }
    
    /* Add left padding to bills left panels */
    .billsInbox-left-panel,
    .billsDirect-left-panel,
    .billsApprovals-left-panel {
        padding-left: 12px !important;
    }
    
    /* Compact styling for entire Bills Inbox table */
    #billsInboxMainTable {
        font-size: 10px;
    }
    #billsInboxMainTable thead th {
        font-size: 10px;
        padding: 4px 2px;
    }
    #billsInboxMainTableBody .form-control-sm {
        font-size: 10px;
        padding: 1px 3px;
        height: 22px;
    }
    #billsInboxMainTableBody select.form-control-sm {
        padding-right: 16px;
    }
    #billsInboxMainTableBody td {
        padding: 3px 2px;
        font-size: 10px;
        vertical-align: middle;
    }
    #billsInboxMainTableBody .btn-sm {
        font-size: 10px;
        padding: 1px 5px;
    }
    /* Hidden date inputs - only show the display span */
    #billsInboxMainTableBody .hidden-date-input {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        pointer-events: none;
    }
    #billsInboxMainTableBody .date-picker-cell {
        position: relative;
    }
    
    /* FX: Orange row styling for unfixed FX bills - Added 2026-02-14 */
    /* Applied to Bills Inbox, Direct, Approvals, and bills_project tables */
    /* Apply to both tr AND td to ensure visibility regardless of cell backgrounds */
    #billsInboxMainTableBody tr.fx-unfixed,
    #billsInboxMainTableBody tr.fx-unfixed td,
    #billsDirectMainTableBody tr.fx-unfixed,
    #billsDirectMainTableBody tr.fx-unfixed td,
    #billsApprovalsMainTableBody tr.fx-unfixed,
    #billsApprovalsMainTableBody tr.fx-unfixed td,
    tr.fx-unfixed,
    tr.fx-unfixed td {
        background-color: rgba(255, 140, 0, 0.5) !important;
    }
    #billsInboxMainTableBody tr.fx-unfixed:hover,
    #billsInboxMainTableBody tr.fx-unfixed:hover td,
    #billsDirectMainTableBody tr.fx-unfixed:hover,
    #billsDirectMainTableBody tr.fx-unfixed:hover td,
    #billsApprovalsMainTableBody tr.fx-unfixed:hover,
    #billsApprovalsMainTableBody tr.fx-unfixed:hover td,
    tr.fx-unfixed:hover,
    tr.fx-unfixed:hover td {
        background-color: rgba(255, 140, 0, 0.6) !important;
    }
    #billsInboxMainTableBody tr.fx-unfixed.selected-row,
    #billsInboxMainTableBody tr.fx-unfixed.selected-row td,
    #billsDirectMainTableBody tr.fx-unfixed.selected-row,
    #billsDirectMainTableBody tr.fx-unfixed.selected-row td,
    #billsApprovalsMainTableBody tr.fx-unfixed.selected-row,
    #billsApprovalsMainTableBody tr.fx-unfixed.selected-row td,
    tr.fx-unfixed.selected-row,
    tr.fx-unfixed.selected-row td {
        background-color: rgba(255, 140, 0, 0.7) !important;
    }
    /* Currency selector styling */
    #billsInboxMainTableBody .currency-select {
        width: 60px;
        text-align: center;
    }
    #billsInboxMainTableBody .date-picker-cell {
        text-align: center;
        white-space: nowrap;
    }
    #billsInboxMainTableBody .date-display {
        font-size: 10px;
    }
    #billsInboxMainTableBody .date-display:hover {
        text-decoration: underline;
    }
    /* Other inputs narrower */
    #billsInboxMainTableBody .net-input,
    #billsInboxMainTableBody .gst-input {
        width: 65px;
    }
    #billsInboxMainTableBody .bill-number-input {
        width: 70px;
    }
    #billsInboxMainTableBody .xero-project-select {
        max-width: 100%;
    }
    #billsInboxMainTableBody .supplier-select {
        max-width: 100%;
    }
    #billsInboxMainTableBody .gross-cell {
        white-space: nowrap;
    }
    /* Action columns need more space */
    #billsInboxMainTableBody .col-action,
    #billsInboxMainTableBody .col-action-first {
        white-space: nowrap;
        text-align: center;
    }
    
    /* ===== DIRECT SECTION COMPACT STYLING ===== */
    #billsDirectMainTable {
        font-size: 10px;
    }
    #billsDirectMainTable thead th {
        font-size: 10px;
        padding: 4px 2px;
    }
    #billsDirectMainTableBody td {
        padding: 3px 2px;
        font-size: 10px;
        vertical-align: middle;
    }
    #billsDirectMainTableBody .btn-sm {
        font-size: 10px;
        padding: 1px 5px;
    }
    #billsDirectMainTableBody .col-action,
    #billsDirectMainTableBody .col-action-first {
        white-space: nowrap;
        text-align: center;
    }
    
    /* ===== APPROVALS SECTION COMPACT STYLING ===== */
    #billsApprovalsMainTable {
        font-size: 10px;
    }
    #billsApprovalsMainTable thead th {
        font-size: 10px;
        padding: 4px 2px;
    }
    #billsApprovalsMainTableBody td {
        padding: 3px 2px;
        font-size: 10px;
        vertical-align: middle;
    }
    #billsApprovalsMainTableBody .btn-sm {
        font-size: 10px;
        padding: 1px 5px;
    }
    #billsApprovalsMainTableBody .col-action,
    #billsApprovalsMainTableBody .col-action-first {
        white-space: nowrap;
        text-align: center;
    }
</style>

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- =====================================================
     INBOX SECTION JS
     ===================================================== -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsInboxMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Inbox
    AllocationsManager.init({
        sectionId: 'billsInbox',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: false,
            confirmDelete: true,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false,
            emailViewer: true
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No bills in inbox.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || bill.attachment_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // FX: Add orange highlighting for unfixed FX bills
                if (isUnfixedFxBill(bill)) {
                    row.addClass('fx-unfixed').css('background-color', 'rgba(255, 140, 0, 0.5)');
                    console.log('[FX] Row', bill.bill_pk, 'is unfixed FX - adding orange styling');
                }
                
                // 1. Xero Instance / Project dropdown
                var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                combinedSelect.append($('<option>').val('').text('Select...'));
                
                // Add Xero Instances
                if (window.billsInboxData && window.billsInboxData.xero_instances) {
                    var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                    combinedSelect.append(xeroHeader);
                    window.billsInboxData.xero_instances.forEach(function(instance) {
                        var option = $('<option>')
                            .val('xero_' + instance.xero_instance_pk)
                            .text('  ' + instance.xero_name);
                        if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                
                // Add Projects
                if (window.billsInboxData && window.billsInboxData.projects) {
                    var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                    combinedSelect.append(projectHeader);
                    window.billsInboxData.projects.forEach(function(project) {
                        var option = $('<option>')
                            .val('project_' + project.projects_pk)
                            .text('  ' + project.project);
                        if (bill.project_pk === project.projects_pk) {
                            option.prop('selected', true);
                        }
                        combinedSelect.append(option);
                    });
                }
                
                // Add Stocktake
                var stocktakeHeader = $('<option>').val('').text('─── Stocktake ───').prop('disabled', true);
                combinedSelect.append(stocktakeHeader);
                var stocktakeOption = $('<option>')
                    .val('stocktake_-1')
                    .text('  Stocktake');
                if (bill.project_pk === -1) {
                    stocktakeOption.prop('selected', true);
                }
                combinedSelect.append(stocktakeOption);
                
                row.append($('<td>').append(combinedSelect));
                
                // 2. Supplier dropdown with inline new supplier form
                var supplierCell = $('<td>').addClass('supplier-cell');
                var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                
                var xeroInstanceId = bill.xero_instance_id;
                if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
                    // Add "+ New Supplier" option
                    supplierSelect.append($('<option>').val('__new__').text('+ New Supplier').addClass('new-supplier-option'));
                    
                    window.billsInboxData.suppliers.forEach(function(supplier) {
                        if (supplier.xero_instance_id === xeroInstanceId) {
                            var option = $('<option>')
                                .val(supplier.contact_pk)
                                .text(supplier.name);
                            if (bill.contact_pk === supplier.contact_pk) {
                                option.prop('selected', true);
                            }
                            supplierSelect.append(option);
                        }
                    });
                } else {
                    supplierSelect.prop('disabled', true);
                    supplierSelect.find('option:first').text('Select Xero Instance first...');
                }
                supplierCell.append(supplierSelect);
                
                // Inline new supplier form (hidden by default)
                var newSupplierForm = $('<div>').addClass('new-supplier-form').hide();
                newSupplierForm.html(`
                    <div style="display: flex; gap: 4px; margin-top: 4px; align-items: center;">
                        <input type="text" class="form-control form-control-sm new-supplier-name" placeholder="Supplier Name" style="flex: 1; min-width: 100px;">
                        <button type="button" class="btn btn-sm btn-success create-supplier-btn" title="Create"><i class="fas fa-check"></i></button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-new-supplier-btn" title="Cancel"><i class="fas fa-times"></i></button>
                    </div>
                `);
                supplierCell.append(newSupplierForm);
                row.append(supplierCell);
                
                // 3. Bill # input
                var billNumberInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm bill-number-input')
                    .val(bill.supplier_bill_number || '');
                row.append($('<td>').append(billNumberInput));
                
                // 4. Currency selector (FX support - added 2026-02-14)
                var currencySelect = $('<select>').addClass('form-control form-control-sm currency-select');
                FX_CURRENCIES.forEach(function(curr) {
                    var option = $('<option>').val(curr).text(curr);
                    if ((bill.currency || 'AUD') === curr) {
                        option.prop('selected', true);
                    }
                    currencySelect.append(option);
                });
                var currencyCell = $('<td>').append(currencySelect);
                row.append(currencyCell);
                console.log('[FX] Inbox row', bill.bill_pk, 'currency:', bill.currency || 'AUD');
                
                // 5. $ Gross (calculated: Net + GST)
                var netVal = bill.total_net !== null ? parseFloat(bill.total_net) : 0;
                var gstVal = bill.total_gst !== null ? parseFloat(bill.total_gst) : 0;
                var grossVal = netVal + gstVal;
                var grossCell = $('<td>').addClass('gross-cell').text(grossVal ? Utils.formatCurrency(grossVal) : '');
                row.append(grossCell);
                
                // 6. $ Net input
                var netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm net-input')
                    .val(bill.total_net !== null ? bill.total_net : '');
                row.append($('<td>').append(netInput));
                
                // 7. $ GST input
                var gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm gst-input')
                    .val(bill.total_gst !== null ? bill.total_gst : '');
                row.append($('<td>').append(gstInput));
                
                // 8. Date (required) - clickable icon/text with hidden date picker
                var dateCell = $('<td>').addClass('date-picker-cell');
                var dateInput = $('<input>')
                    .attr('type', 'date')
                    .addClass('bill-date-input hidden-date-input')
                    .val(bill.bill_date || '');
                var dateDisplay = $('<span>')
                    .addClass('date-display')
                    .css({'cursor': 'pointer', 'color': bill.bill_date ? '#212529' : '#6c757d'})
                    .html(bill.bill_date ? Utils.formatDateDMY(bill.bill_date) : '<i class="fas fa-calendar-alt"></i>')
                    .attr('title', 'Click to select date');
                dateDisplay.on('click', function() { dateInput.focus(); dateInput[0].showPicker(); });
                dateInput.on('change', function() {
                    var val = $(this).val();
                    dateDisplay.html(val ? Utils.formatDateDMY(val) : '<i class="fas fa-calendar-alt"></i>');
                    dateDisplay.css('color', val ? '#212529' : '#6c757d');
                    // Trigger validation
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                });
                dateCell.append(dateInput).append(dateDisplay);
                row.append(dateCell);
                
                // 9. Due Date (required) - clickable icon/text with hidden date picker
                var dueDateCell = $('<td>').addClass('date-picker-cell');
                var dueDateInput = $('<input>')
                    .attr('type', 'date')
                    .addClass('bill-due-date-input hidden-date-input')
                    .val(bill.bill_due_date || '');
                var dueDateDisplay = $('<span>')
                    .addClass('date-display')
                    .css({'cursor': 'pointer', 'color': bill.bill_due_date ? '#212529' : '#6c757d'})
                    .html(bill.bill_due_date ? Utils.formatDateDMY(bill.bill_due_date) : '<i class="fas fa-calendar-alt"></i>')
                    .attr('title', 'Click to select due date');
                dueDateDisplay.on('click', function() { dueDateInput.focus(); dueDateInput[0].showPicker(); });
                dueDateInput.on('change', function() {
                    var val = $(this).val();
                    dueDateDisplay.html(val ? Utils.formatDateDMY(val) : '<i class="fas fa-calendar-alt"></i>');
                    dueDateDisplay.css('color', val ? '#212529' : '#6c757d');
                    // Trigger validation
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                });
                dueDateCell.append(dueDateInput).append(dueDateDisplay);
                row.append(dueDateCell);
                
                // 9. Email link
                var emailLink = $('<a>')
                    .attr('href', '#')
                    .text('email')
                    .addClass('email-link')
                    .attr('data-email-html', bill.email_body_html || '')
                    .attr('data-email-text', bill.email_body_text || '')
                    .attr('data-email-subject', bill.email_subject || '')
                    .attr('data-email-from', bill.email_from || '')
                    .attr('title', bill.email_subject + ' from ' + bill.email_from);
                row.append($('<td>').addClass('col-action-first').append(emailLink));
                
                // 11. Send button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary send-bill-btn')
                    .text('Send')
                    .attr('data-bill-pk', bill.bill_pk)
                    .prop('disabled', true);
                row.append($('<td>').addClass('col-action').append(sendBtn));
                
                // 12. Archive button
                var archiveBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger archive-bill-btn')
                    .html('<i class="fas fa-archive"></i>')
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('title', 'Archive');
                row.append($('<td>').addClass('col-action').append(archiveBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                window.currentBillData = cfg.data.currentItem;
                // Validate send button
                validateInboxSendButton(pk);
            }
        },
        api: {
            // No allocation loading for inbox
        },
        callbacks: {}
    });
    
    // Validate Send button for Inbox mode
    function validateInboxSendButton(billPk) {
        console.log('=== validateInboxSendButton called for billPk:', billPk, '===');
        
        var button = $('button[data-bill-pk="' + billPk + '"].send-bill-btn');
        console.log('  Button found:', button.length > 0);
        if (button.length === 0) return;
        
        var row = button.closest('tr');
        var isValid = true;
        var failReasons = [];
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        // Check both normal supplier-select AND stocktake-supplier-dropdown (used when Stocktake is selected)
        var supplierPk = row.find('.supplier-select').val() || row.find('.stocktake-supplier-dropdown').val();
        var billNumber = row.find('.bill-number-input').val();
        var netValue = row.find('.net-input').val();
        var gstValue = row.find('.gst-input').val();
        var billDate = row.find('.bill-date-input').val();
        var billDueDate = row.find('.bill-due-date-input').val();
        
        console.log('  Field values:');
        console.log('    xeroInstanceOrProject:', JSON.stringify(xeroInstanceOrProject));
        console.log('    supplierPk:', JSON.stringify(supplierPk), '(from supplier-select or stocktake-supplier-dropdown)');
        console.log('    billNumber:', JSON.stringify(billNumber));
        console.log('    netValue:', JSON.stringify(netValue), 'parsed:', parseFloat(netValue));
        console.log('    gstValue:', JSON.stringify(gstValue));
        console.log('    billDate:', JSON.stringify(billDate));
        console.log('    billDueDate:', JSON.stringify(billDueDate));
        
        if (!xeroInstanceOrProject) { isValid = false; failReasons.push('xeroInstanceOrProject empty'); }
        if (!supplierPk) { isValid = false; failReasons.push('supplierPk empty'); }
        if (!billNumber || billNumber.trim() === '') { isValid = false; failReasons.push('billNumber empty'); }
        if (!netValue || parseFloat(netValue) === 0) { isValid = false; failReasons.push('netValue empty or 0'); }
        if (gstValue === null || gstValue === undefined || gstValue === '') { isValid = false; failReasons.push('gstValue empty'); }
        if (!billDate) { isValid = false; failReasons.push('billDate empty'); }
        if (!billDueDate) { isValid = false; failReasons.push('billDueDate empty'); }
        
        console.log('  isValid:', isValid, 'failReasons:', failReasons);
        
        if (isValid) {
            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
            console.log('  -> Button ENABLED (green)');
        } else {
            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
            console.log('  -> Button DISABLED (grey)');
        }
    }
    
    // Load Bills Inbox data
    window.loadBillsInbox = function() {
        // Guard: ensure table exists before trying to load
        if (!$('#billsInboxMainTableBody').length) {
            return;
        }
        
        $.ajax({
            url: '{% url "core:get_bills_list" %}',
            type: 'GET',
            success: function(response) {
                // Guard: ensure table still exists (user may have navigated away)
                if (!$('#billsInboxMainTableBody').length) {
                    return;
                }
                
                // Store data globally
                window.billsInboxData = response;
                
                // Filter for Inbox bills (status = -2)
                var inboxBills = response.bills.filter(function(bill) {
                    return bill.bill_status === -2;
                });
                
                // Populate table
                AllocationsManager.populateMainTable('billsInbox', inboxBills);
                
                // Initialize searchable dropdowns for supplier selects
                initSupplierSearchableDropdowns();
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsInboxMainTable');
                
                // Bind validation to input changes
                bindInboxInputHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load bills:', error);
            }
        });
    };
    
    // Initialize searchable dropdowns for supplier selects
    function initSupplierSearchableDropdowns() {
        $('#billsInboxMainTableBody .supplier-select').each(function() {
            var $select = $(this);
            // Skip if already initialized or disabled
            if ($select.data('searchable-dropdown') || $select.prop('disabled')) {
                return;
            }
            
            // Skip if row has stocktake selected (handled separately)
            var $row = $select.closest('tr');
            var projectVal = $row.find('.xero-project-select').val();
            if (projectVal && projectVal.startsWith('stocktake_')) {
                return;
            }
            
            Utils.createSearchableDropdown($select, {
                pinnedValues: ['__new__'],
                placeholder: 'Search suppliers...',
                onChange: function(value, text, $sel) {
                    var row = $sel.closest('tr');
                    
                    // Trigger the existing change handler for "+ New Supplier" logic
                    if (value === '__new__') {
                        row.find('.searchable-dropdown-wrapper').hide();
                        row.find('.new-supplier-form').show();
                        row.find('.new-supplier-name').val('').focus();
                    }
                    
                    // Validate send button
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                }
            });
        });
    }
    
    // Bind input change handlers for validation
    function bindInboxInputHandlers() {
        $(document).off('change.billsInbox input.billsInbox', '#billsInboxMainTableBody');
        
        // Updated 2026-02-14: Added .currency-select for FX support
        $(document).on('change.billsInbox input.billsInbox', '#billsInboxMainTableBody .xero-project-select, #billsInboxMainTableBody .supplier-select, #billsInboxMainTableBody .bill-number-input, #billsInboxMainTableBody .currency-select, #billsInboxMainTableBody .net-input, #billsInboxMainTableBody .gst-input, #billsInboxMainTableBody .bill-date-input, #billsInboxMainTableBody .bill-due-date-input', function() {
            var row = $(this).closest('tr');
            var billPk = row.attr('data-bill-pk');
            validateInboxSendButton(billPk);
            
            // FX: Log currency changes
            if ($(this).hasClass('currency-select')) {
                var currency = $(this).val();
                console.log('[FX] Currency changed for bill', billPk, 'to:', currency);
                // Mark row as unfixed if non-AUD currency selected
                if (currency !== 'AUD') {
                    row.addClass('fx-unfixed').css('background-color', 'rgba(255, 140, 0, 0.5)');
                    console.log('[FX] Bill', billPk, 'marked as unfixed FX');
                } else {
                    row.removeClass('fx-unfixed').css('background-color', '');
                }
            }
            
            // Auto-calculate GST when Net changes
            if ($(this).hasClass('net-input')) {
                var netValue = parseFloat($(this).val()) || 0;
                var gstValue = (netValue * 0.1).toFixed(2);
                row.find('.gst-input').val(gstValue);
            }
            
            // Update $ Gross when Net or GST changes
            if ($(this).hasClass('net-input') || $(this).hasClass('gst-input')) {
                var netVal = parseFloat(row.find('.net-input').val()) || 0;
                var gstVal = parseFloat(row.find('.gst-input').val()) || 0;
                var grossVal = netVal + gstVal;
                row.find('.gross-cell').text(grossVal ? Utils.formatCurrency(grossVal) : '');
            }
            
            // Update supplier dropdown when Xero Instance changes
            if ($(this).hasClass('xero-project-select')) {
                updateSupplierDropdown(row, $(this).val());
            }
        });
    }
    
    // Update supplier dropdown based on Xero Instance selection
    function updateSupplierDropdown(row, selectedValue) {
        console.log('=== updateSupplierDropdown called ===');
        console.log('  selectedValue:', selectedValue);
        
        var supplierSelect = row.find('.supplier-select');
        supplierSelect.empty().append($('<option>').val('').text('Select Supplier...'));
        
        // Hide any open new supplier form
        row.find('.new-supplier-form').hide();
        // Show the searchable dropdown wrapper, not the hidden original select
        row.find('.searchable-dropdown-wrapper').show();
        
        var xeroInstanceId = null;
        if (selectedValue && selectedValue.startsWith('xero_')) {
            xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
        } else if (selectedValue && selectedValue.startsWith('project_')) {
            var projectPk = parseInt(selectedValue.replace('project_', ''));
            var project = window.billsInboxData.projects.find(function(p) {
                return p.projects_pk === projectPk;
            });
            if (project) xeroInstanceId = project.xero_instance_id;
        } else if (selectedValue && selectedValue.startsWith('stocktake_')) {
            // Stocktake uses the first available Xero instance
            if (window.billsInboxData && window.billsInboxData.xero_instances && window.billsInboxData.xero_instances.length > 0) {
                xeroInstanceId = window.billsInboxData.xero_instances[0].xero_instance_pk;
                console.log('  Stocktake mode: using first xero instance pk:', xeroInstanceId);
            }
        }
        
        console.log('  xeroInstanceId:', xeroInstanceId);
        
        // Store xeroInstanceId on the row for later use
        row.attr('data-xero-instance-id', xeroInstanceId || '');
        
        if (xeroInstanceId && window.billsInboxData && window.billsInboxData.suppliers) {
            supplierSelect.prop('disabled', false);
            // Add "+ New Supplier" option
            supplierSelect.append($('<option>').val('__new__').text('+ New Supplier'));
            
            var matchingSuppliers = 0;
            window.billsInboxData.suppliers.forEach(function(supplier) {
                if (supplier.xero_instance_id === xeroInstanceId) {
                    supplierSelect.append($('<option>').val(supplier.contact_pk).text(supplier.name));
                    matchingSuppliers++;
                }
            });
            console.log('  Total suppliers in data:', window.billsInboxData.suppliers.length);
            console.log('  Suppliers matching xeroInstanceId:', matchingSuppliers);
            console.log('  Sample supplier xero_instance_id:', window.billsInboxData.suppliers[0]?.xero_instance_id);
            
            // Refresh or initialize searchable dropdown
            var controller = supplierSelect.data('searchable-dropdown');
            console.log('  Searchable dropdown controller exists:', !!controller);
            if (controller) {
                console.log('  Calling controller.refresh()');
                controller.refresh();
            } else {
                console.log('  Creating NEW searchable dropdown');
                Utils.createSearchableDropdown(supplierSelect, {
                    pinnedValues: ['__new__'],
                    placeholder: 'Search suppliers...',
                    onChange: function(value, text, $sel) {
                        console.log('[Supplier onChange] value:', value, 'text:', text);
                        var r = $sel.closest('tr');
                        if (value === '__new__') {
                            r.find('.searchable-dropdown-wrapper').hide();
                            r.find('.new-supplier-form').show();
                            r.find('.new-supplier-name').val('').focus();
                        }
                        var billPk = r.attr('data-bill-pk');
                        validateInboxSendButton(billPk);
                    }
                });
            }
        } else {
            supplierSelect.prop('disabled', true);
            supplierSelect.find('option:first').text('Select Xero Instance first...');
            // Destroy searchable dropdown if disabled
            var controller = supplierSelect.data('searchable-dropdown');
            if (controller) {
                controller.destroy();
            }
        }
    }
    
    // DEBUG: Global click handler to test if searchable dropdown clicks are working
    $(document).on('click', '.searchable-dropdown-item', function(e) {
        console.log('[GLOBAL] searchable-dropdown-item clicked:', $(this).text(), 'value:', $(this).attr('data-value'));
    });
    
    // DEBUG: Comprehensive diagnostic function
    window.debugSupplierDropdown = function() {
        console.log('========== SUPPLIER DROPDOWN DIAGNOSTIC ==========');
        
        // 1. Find the supplier select in the current row
        var row = $('#billsInboxMainTableBody tr[data-bill-pk="68"]');
        console.log('1. Row found:', row.length > 0);
        
        if (row.length === 0) {
            row = $('#billsInboxMainTableBody tr').first();
            console.log('   Using first row instead, data-bill-pk:', row.attr('data-bill-pk'));
        }
        
        var supplierSelect = row.find('.supplier-select');
        console.log('2. Supplier select found:', supplierSelect.length > 0);
        console.log('   Supplier select visible:', supplierSelect.is(':visible'));
        console.log('   Supplier select value:', supplierSelect.val());
        console.log('   Supplier select options count:', supplierSelect.find('option').length);
        
        // 3. Check searchable dropdown controller
        var controller = supplierSelect.data('searchable-dropdown');
        console.log('3. Controller exists:', !!controller);
        
        // 4. Check wrapper
        var wrapper = row.find('.searchable-dropdown-wrapper');
        console.log('4. Wrapper found:', wrapper.length > 0);
        console.log('   Wrapper visible:', wrapper.is(':visible'));
        console.log('   Wrapper position:', wrapper.offset());
        
        // 5. Find all dropdown menus in body
        var allDropdowns = $('body > .searchable-dropdown-menu');
        console.log('5. All dropdown menus in body:', allDropdowns.length);
        
        allDropdowns.each(function(i) {
            var $d = $(this);
            console.log('   Dropdown ' + i + ':');
            console.log('     - hasClass open:', $d.hasClass('open'));
            console.log('     - visible:', $d.is(':visible'));
            console.log('     - css display:', $d.css('display'));
            console.log('     - position:', $d.css('position'));
            console.log('     - top/left:', $d.css('top'), $d.css('left'));
            console.log('     - z-index:', $d.css('z-index'));
            console.log('     - items count:', $d.find('.searchable-dropdown-item').length);
            
            // Check items
            var items = $d.find('.searchable-dropdown-item');
            console.log('     - first 3 items:');
            items.slice(0, 3).each(function(j) {
                console.log('       Item ' + j + ':', $(this).text().substring(0, 30), 'value:', $(this).attr('data-value'));
            });
        });
        
        // 6. Check for overlapping elements
        console.log('6. Checking for overlapping elements...');
        var openDropdown = $('body > .searchable-dropdown-menu.open');
        if (openDropdown.length > 0) {
            var offset = openDropdown.offset();
            var width = openDropdown.outerWidth();
            var height = openDropdown.outerHeight();
            console.log('   Open dropdown bounds:', offset, 'size:', width, 'x', height);
            
            // Check what element is at the center of the dropdown
            var centerX = offset.left + width/2;
            var centerY = offset.top + height/2;
            var elementAtPoint = document.elementFromPoint(centerX - window.scrollX, centerY - window.scrollY);
            console.log('   Element at dropdown center:', elementAtPoint);
            console.log('   Element tagName:', elementAtPoint?.tagName);
            console.log('   Element classes:', elementAtPoint?.className);
        }
        
        // 7. Try clicking an item programmatically
        console.log('7. Attempting programmatic click on first visible item...');
        var firstItem = $('body > .searchable-dropdown-menu.open .searchable-dropdown-item:visible:first');
        if (firstItem.length > 0) {
            console.log('   Found item:', firstItem.text().substring(0, 30));
            console.log('   Triggering click...');
            firstItem.trigger('click');
            console.log('   Click triggered. Check if value changed.');
            console.log('   Supplier select value after click:', supplierSelect.val());
        } else {
            console.log('   No visible item found in open dropdown');
        }
        
        console.log('========== END DIAGNOSTIC ==========');
        return 'Run this while the supplier dropdown is OPEN';
    };
    
    console.log('[DEBUG] Run window.debugSupplierDropdown() while the supplier dropdown is open');
    
    // Handle "+ New Supplier" selection - show inline form
    $(document).off('change.billsInbox', '.supplier-select');
    $(document).on('change.billsInbox', '.supplier-select', function() {
        var row = $(this).closest('tr');
        var selectedValue = $(this).val();
        
        if (selectedValue === '__new__') {
            // Show inline form, hide dropdown
            row.find('.supplier-select').hide();
            row.find('.new-supplier-form').show();
            row.find('.new-supplier-name').val('').focus();
        }
        
        // Trigger validation
        var billPk = row.attr('data-bill-pk');
        validateInboxSendButton(billPk);
    });
    
    // Cancel new supplier form
    $(document).off('click.billsInbox', '.cancel-new-supplier-btn');
    $(document).on('click.billsInbox', '.cancel-new-supplier-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var row = $(this).closest('tr');
        row.find('.new-supplier-form').hide();
        // Show the searchable dropdown wrapper, reset value
        row.find('.searchable-dropdown-wrapper').show();
        var controller = row.find('.supplier-select').val('').data('searchable-dropdown');
        if (controller) controller.refresh();
        
        var billPk = row.attr('data-bill-pk');
        validateInboxSendButton(billPk);
    });
    
    // Create new supplier
    $(document).off('click.billsInbox', '.create-supplier-btn');
    $(document).on('click.billsInbox', '.create-supplier-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var btn = $(this);
        var row = btn.closest('tr');
        var supplierName = row.find('.new-supplier-name').val().trim();
        
        if (!supplierName) {
            row.find('.new-supplier-name').focus();
            return;
        }
        
        // Get xero instance ID from row or from the dropdown selection
        var xeroInstanceId = row.attr('data-xero-instance-id');
        if (!xeroInstanceId) {
            var xeroProjectVal = row.find('.xero-project-select').val();
            if (xeroProjectVal && xeroProjectVal.startsWith('xero_')) {
                xeroInstanceId = parseInt(xeroProjectVal.replace('xero_', ''));
            } else if (xeroProjectVal && xeroProjectVal.startsWith('project_')) {
                var projectPk = parseInt(xeroProjectVal.replace('project_', ''));
                var project = window.billsInboxData.projects.find(function(p) {
                    return p.projects_pk === projectPk;
                });
                if (project) xeroInstanceId = project.xero_instance_id;
            } else if (xeroProjectVal && xeroProjectVal.startsWith('stocktake_')) {
                // Stocktake uses first Xero instance
                if (window.billsInboxData && window.billsInboxData.xero_instances && window.billsInboxData.xero_instances.length > 0) {
                    xeroInstanceId = window.billsInboxData.xero_instances[0].xero_instance_pk;
                }
            }
        }
        
        if (!xeroInstanceId) {
            alert('Please select a Xero Instance or Project first.');
            return;
        }
        
        // Show loading state
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/create_supplier/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({
                name: supplierName,
                xero_instance_id: parseInt(xeroInstanceId)
            }),
            success: function(response) {
                if (response.status === 'success') {
                    var newSupplier = response.supplier;
                    
                    // Add to beginning of global suppliers list (so it stays at top on refresh)
                    if (window.billsInboxData && window.billsInboxData.suppliers) {
                        window.billsInboxData.suppliers.unshift(newSupplier);
                    }
                    
                    // Add option to dropdown right after "+ New Supplier" and select it
                    var supplierSelect = row.find('.supplier-select');
                    var newOption = $('<option>').val(newSupplier.contact_pk).text(newSupplier.name);
                    // Insert after the "+ New Supplier" option (which is the second option)
                    supplierSelect.find('option[value="__new__"]').after(newOption);
                    supplierSelect.val(newSupplier.contact_pk);
                    
                    // Hide form, show searchable dropdown wrapper
                    row.find('.new-supplier-form').hide();
                    row.find('.searchable-dropdown-wrapper').show();
                    // Refresh searchable dropdown to show new option
                    var controller = supplierSelect.data('searchable-dropdown');
                    if (controller) controller.refresh();
                    
                    // Validate send button
                    var billPk = row.attr('data-bill-pk');
                    validateInboxSendButton(billPk);
                } else {
                    alert('Error creating supplier: ' + response.message);
                    btn.prop('disabled', false).html('<i class="fas fa-check"></i>');
                }
            },
            error: function(xhr) {
                var errorMsg = 'Failed to create supplier.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMsg);
                btn.prop('disabled', false).html('<i class="fas fa-check"></i>');
            }
        });
    });
    
    // Handle Enter key in new supplier name input
    $(document).off('keypress.billsInbox', '.new-supplier-name');
    $(document).on('keypress.billsInbox', '.new-supplier-name', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).closest('.new-supplier-form').find('.create-supplier-btn').click();
        }
    });
    
    // Archive button handler
    $(document).off('click.billsInbox', '.archive-bill-btn');
    $(document).on('click.billsInbox', '.archive-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var billPk = $(this).attr('data-bill-pk');
        var row = $(this).closest('tr');
        
        if (confirm('Are you sure you want to archive this Bill?')) {
            $.ajax({
                url: '{% url "core:archive_bill" %}',
                type: 'POST',
                headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                data: JSON.stringify({ bill_pk: billPk }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.status === 'success') {
                        row.fadeOut(300, function() { $(this).remove(); });
                        
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    } else {
                        alert('Failed to archive bill: ' + response.message);
                    }
                },
                error: function() {
                    alert('Failed to archive bill. Please try again.');
                }
            });
        }
    });
    
    // Send button handler
    // Note: Email viewing is now handled by AllocationsManager with emailViewer: true
    $(document).off('click.billsInbox', '.send-bill-btn');
    $(document).on('click.billsInbox', '.send-bill-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var row = button.closest('tr');
        var billPk = button.attr('data-bill-pk');
        
        var xeroInstanceOrProject = row.find('.xero-project-select').val();
        var supplierPk = row.find('.supplier-select').val();
        var billNumber = row.find('.bill-number-input').val();
        var totalNet = parseFloat(row.find('.net-input').val());
        var totalGst = parseFloat(row.find('.gst-input').val());
        var billDate = row.find('.bill-date-input').val();
        var billDueDate = row.find('.bill-due-date-input').val();
        // FX: Get currency from selector (added 2026-02-14)
        var currency = row.find('.currency-select').val() || 'AUD';
        
        console.log('[FX] Sending bill', billPk, 'with currency:', currency);
        
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/send_bill/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({
                bill_pk: parseInt(billPk),
                xero_instance_or_project: xeroInstanceOrProject,
                supplier_pk: parseInt(supplierPk),
                bill_number: billNumber,
                total_net: totalNet,
                total_gst: totalGst,
                bill_date: billDate,
                bill_due_date: billDueDate,
                // FX fields
                currency: currency
            }),
            success: function(response) {
                if (response.status === 'success') {
                    // Get next row (or previous if no next) before fade
                    var nextRow = row.next('tr');
                    if (!nextRow.length) {
                        nextRow = row.prev('tr');
                    }
                    
                    AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                        if (window.currentSelectedBillPk === billPk) {
                            $('#billsInboxPdfViewer').hide();
                            $('#billsInboxViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                        
                        // Auto-select next row after fade completes
                        if (nextRow.length) {
                            nextRow.click();
                        }
                    });
                } else {
                    alert('Error: ' + response.message);
                    button.prop('disabled', false).text('Send');
                }
            },
            error: function(xhr) {
                var errorMsg = 'Failed to send bill. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                alert('Error: ' + errorMsg);
                button.prop('disabled', false).text('Send');
            }
        });
    });
    
    // Make function globally available
    window.loadBillsInbox = window.loadBillsInbox;
    
})();
</script>

<!-- =====================================================
     DIRECT SECTION JS
     ===================================================== -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsDirectMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Direct
    AllocationsManager.init({
        sectionId: 'billsDirect',
        features: {
            saveRowBtn: false,
            deleteRowBtn: true,
            constructionMode: false,
            gstField: true,
            confirmDelete: true,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: true,
            emailViewer: true
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No bills in Direct mode.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || bill.attachment_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl)
                    .attr('data-xero-instance-id', bill.xero_instance_pk || bill.xero_instance_id || '')
                    .attr('data-supplier-pk', bill.contact_pk || '')
                    .attr('data-bill-number', bill.supplier_bill_number || '')
                    .attr('data-total-net', bill.total_net || 0)
                    .attr('data-total-gst', bill.total_gst || 0);
                
                // 1. Xero Instance / Project (display only - already set)
                var xeroProjectName = '';
                if (bill.xero_instance_id && window.billsDirectData) {
                    var instance = window.billsDirectData.xero_instances.find(function(x) {
                        return x.xero_instance_pk === bill.xero_instance_id;
                    });
                    if (instance) xeroProjectName = instance.xero_name;
                }
                row.append($('<td>').text(xeroProjectName));
                
                // 2. Supplier (display only)
                var supplierName = '';
                if (bill.contact_pk && window.billsDirectData) {
                    var supplier = window.billsDirectData.suppliers.find(function(s) {
                        return s.contact_pk === bill.contact_pk;
                    });
                    if (supplier) supplierName = supplier.name;
                }
                row.append($('<td>').text(supplierName));
                
                // 3. Bill # (display only)
                row.append($('<td>').text(bill.supplier_bill_number || ''));
                
                // 4. Currency (FX - display only, added 2026-02-14)
                var currencyDisplay = (bill.currency && bill.currency !== 'AUD') ? bill.currency : '';
                row.append($('<td>').addClass('currency-cell').text(currencyDisplay));
                // Add fx-unfixed class and inline style for orange highlighting
                if (isUnfixedFxBill(bill)) {
                    row.addClass('fx-unfixed').css('background-color', 'rgba(255, 140, 0, 0.5)');
                    console.log('[FX] Direct row', bill.bill_pk, 'is unfixed FX - adding orange styling');
                }
                
                // 5. $ Gross (calculated: Net + GST)
                var netVal = parseFloat(bill.total_net) || 0;
                var gstVal = parseFloat(bill.total_gst) || 0;
                row.append($('<td>').text('$' + Utils.formatMoney(netVal + gstVal)));
                
                // 6. $ Net (display only)
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_net)));
                
                // 7. $ GST (display only)
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gst)));
                
                // 8. Date (display only, dd-mmm-yy format)
                row.append($('<td>').text(bill.bill_date ? Utils.formatDateDMY(bill.bill_date) : '-'));
                
                // 9. Due Date (display only, dd-mmm-yy format)
                row.append($('<td>').text(bill.bill_due_date ? Utils.formatDateDMY(bill.bill_due_date) : '-'));
                
                // 10. Email link
                var emailLink = $('<a>')
                    .attr('href', '#')
                    .text('email')
                    .addClass('email-link')
                    .attr('data-email-html', bill.email_body_html || '')
                    .attr('data-email-text', bill.email_body_text || '')
                    .attr('data-email-subject', bill.email_subject || '')
                    .attr('data-email-from', bill.email_from || '')
                    .attr('title', bill.email_subject + ' from ' + bill.email_from);
                row.append($('<td>').addClass('col-action-first').append(emailLink));
                
                // 11. Approve button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary approve-btn')
                    .text('Approve')
                    .attr('data-bill-pk', bill.bill_pk)
                    .prop('disabled', true);
                row.append($('<td>').addClass('col-action').append(sendBtn));
                
                // 12. Return to Inbox button
                var returnBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning return-to-inbox-btn')
                    .html('<i class="fas fa-undo"></i>')
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('title', 'Return to Inbox');
                row.append($('<td>').addClass('col-action').append(returnBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                
                // Find full bill data
                var bill = window.billsDirectData.bills.find(function(b) {
                    return b.bill_pk === parseInt(pk);
                });
                window.currentBillData = bill;
                
                // Load allocations for this bill
                loadBillAllocations(pk, bill);
            }
        },
        allocations: {
            editable: true,
            showStillToAllocate: true,
            renderEditableRow: function(alloc, cfg) {
                alloc = alloc || {};  // Handle undefined allocation for new rows
                var row = $('<tr>').attr('data-allocation-pk', alloc.allocation_pk || '');
                
                // 1. Xero Account dropdown
                var accountSelect = $('<select>')
                    .addClass('form-control form-control-sm xero-account-select');
                accountSelect.append($('<option>').val('').text('Select Account...'));
                row.append($('<td>').append(accountSelect));
                
                // Store xero_account_pk for later selection
                if (alloc.xero_account_pk) {
                    row.attr('data-xero-account-pk', alloc.xero_account_pk);
                }
                
                // 2. Tracking Category dropdown
                var trackingSelect = $('<select>')
                    .addClass('form-control form-control-sm tracking-category-select');
                trackingSelect.append($('<option>').val('').text('Select...'));
                row.append($('<td>').append(trackingSelect));
                
                // Store tracking_category_pk for later selection
                if (alloc.tracking_category_pk) {
                    row.attr('data-tracking-category-pk', alloc.tracking_category_pk);
                }
                
                // 3. $ Gross (calculated: Net + GST, display only)
                var allocNetVal = parseFloat(alloc.amount) || 0;
                var allocGstVal = parseFloat(alloc.gst_amount) || 0;
                var grossCell = $('<td>').addClass('allocation-gross-cell').text('$' + Utils.formatMoney(allocNetVal + allocGstVal));
                row.append(grossCell);
                
                // 4. $ Net input
                var netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm allocation-net-input')
                    .val(alloc.amount || '');
                row.append($('<td>').append(netInput));
                
                // 5. $ GST input
                var gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm allocation-gst-input')
                    .val(alloc.gst_amount || '');
                row.append($('<td>').append(gstInput));
                
                // 6. Notes input
                var notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm allocation-notes-input')
                    .attr('placeholder', 'Description...')
                    .val(alloc.notes || '');
                row.append($('<td>').append(notesInput));
                
                // 6. Delete button
                var deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger delete-allocation-btn')
                    .html('<i class="fas fa-times"></i>')
                    .attr('data-allocation-pk', alloc.allocation_pk)
                    .attr('title', 'Delete allocation');
                row.append($('<td>').addClass('col-action-first').append(deleteBtn));
                
                return row;
            }
        },
        api: {
            // Allocations loaded manually in onRowSelect
        },
        callbacks: {}
    });
    
    // Load bill allocations
    function loadBillAllocations(billPk, bill) {
        var allocationsTableBody = $('#billsDirectAllocationsTableBody');
        allocationsTableBody.empty();
        
        var cfg = AllocationsManager.getConfig('billsDirect');
        var instancePk = bill ? (bill.xero_instance_pk || bill.xero_instance_id) : null;
        
        if (bill && bill.allocations && bill.allocations.length > 0) {
            // Render existing allocations
            bill.allocations.forEach(function(alloc) {
                var row = cfg.allocations.renderEditableRow(alloc, cfg);
                allocationsTableBody.append(row);
            });
        } else {
            // No allocations - add a blank editable row
            var blankAlloc = { allocation_pk: '', amount: '', gst_amount: '', notes: '' };
            var row = cfg.allocations.renderEditableRow(blankAlloc, cfg);
            allocationsTableBody.append(row);
        }
        
        // Populate Xero Account and Tracking Category dropdowns for all rows
        if (instancePk) {
            populateAllXeroAccountDropdowns(instancePk);
            populateAllTrackingCategoryDropdowns(instancePk);
        }
        
        // Update remaining allocations display
        updateRemainingAllocations();
        
        // Apply column widths for proper alignment (tbody uses display:block for scrolling)
        Utils.applyColumnStyles('billsDirect', ['23%', '18%', '11%', '11%', '11%', '21%', '5%'], { addEditableClass: true });
        
        // Show Add Row button (since we're always in edit mode)
        $('#billsDirectAddAllocationBtn').show();
        
        // Validate send button
        validateDirectSendButton(billPk);
    }
    
    // Populate Xero Account dropdowns for all allocation rows
    function populateAllXeroAccountDropdowns(instancePk) {
        if (!instancePk) return;
        
        $.ajax({
            url: '/core/get_xero_accounts/' + instancePk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success' && response.accounts) {
                    $('#billsDirectAllocationsTableBody tr').each(function() {
                        var row = $(this);
                        var accountSelect = row.find('.xero-account-select');
                        var storedAccountPk = row.attr('data-xero-account-pk');
                        
                        // Clear existing options except first
                        accountSelect.find('option:not(:first)').remove();
                        
                        response.accounts.forEach(function(account) {
                            accountSelect.append($('<option>')
                                .val(account.xero_account_pk)
                                .text(account.account_code + ' - ' + account.account_name));
                        });
                        
                        // Set stored value if exists
                        if (storedAccountPk) {
                            accountSelect.val(storedAccountPk);
                        }
                    });
                }
            }
        });
    }
    
    // Populate Tracking Category dropdowns for all allocation rows
    function populateAllTrackingCategoryDropdowns(instancePk) {
        if (!instancePk) return;
        
        $.ajax({
            url: '/core/get_tracking_categories/' + instancePk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success' && response.tracking_categories) {
                    $('#billsDirectAllocationsTableBody tr').each(function() {
                        var row = $(this);
                        var trackingSelect = row.find('.tracking-category-select');
                        var storedTrackingPk = row.attr('data-tracking-category-pk');
                        
                        // Clear existing options except first
                        trackingSelect.find('option:not(:first)').remove();
                        
                        response.tracking_categories.forEach(function(cat) {
                            trackingSelect.append($('<option>')
                                .val(cat.tracking_category_pk)
                                .text(cat.name));
                        });
                        
                        // Set stored value if exists
                        if (storedTrackingPk) {
                            trackingSelect.val(storedTrackingPk);
                        }
                    });
                }
            }
        });
    }
    
    // Update remaining allocations display
    function updateRemainingAllocations() {
        if (!window.currentBillData) {
            $('#billsDirectRemainingNet').text('$0.00').css('color', 'green');
            $('#billsDirectRemainingGst').text('$0.00').css('color', 'green');
            return;
        }
        
        var billNet = parseFloat(window.currentBillData.total_net) || 0;
        var billGst = parseFloat(window.currentBillData.total_gst) || 0;
        
        var allocatedNet = 0;
        var allocatedGst = 0;
        
        $('#billsDirectAllocationsTableBody tr').each(function() {
            allocatedNet += parseFloat($(this).find('.allocation-net-input').val()) || 0;
            allocatedGst += parseFloat($(this).find('.allocation-gst-input').val()) || 0;
        });
        
        var remainingNet = billNet - allocatedNet;
        var remainingGst = billGst - allocatedGst;
        
        $('#billsDirectRemainingNet').text('$' + Utils.formatMoney(remainingNet));
        $('#billsDirectRemainingGst').text('$' + Utils.formatMoney(remainingGst));
        
        // Color coding
        $('#billsDirectRemainingNet').css('color', Math.abs(remainingNet) < 0.01 ? 'green' : (remainingNet > 0 ? 'blue' : 'red'));
        $('#billsDirectRemainingGst').css('color', Math.abs(remainingGst) < 0.01 ? 'green' : (remainingGst > 0 ? 'blue' : 'red'));
        
        // Validate send button
        if (window.currentSelectedBillPk) {
            validateDirectSendButton(window.currentSelectedBillPk);
        }
    }
    
    // Validate bill on page load (checks bill data directly, not allocations table)
    function validateBillOnLoad(bill) {
        var button = $('button[data-bill-pk="' + bill.bill_pk + '"].approve-btn');
        if (button.length === 0) {
            return;
        }
        
        var isValid = true;
        var reason = '';
        
        // Must have at least one allocation with a Xero account
        if (!bill.allocations || bill.allocations.length === 0) {
            isValid = false;
            reason = 'no allocations';
        } else {
            // All allocations must have Xero Account selected
            var hasAllAccounts = true;
            bill.allocations.forEach(function(alloc) {
                if (!alloc.xero_account_pk) {
                    hasAllAccounts = false;
                }
            });
            if (!hasAllAccounts) {
                isValid = false;
                reason = 'missing xero account';
            }
            
            // Calculate remaining amounts
            var totalNet = parseFloat(bill.total_net) || 0;
            var totalGst = parseFloat(bill.total_gst) || 0;
            var allocatedNet = 0;
            var allocatedGst = 0;
            
            bill.allocations.forEach(function(alloc) {
                allocatedNet += parseFloat(alloc.amount) || 0;
                allocatedGst += parseFloat(alloc.gst_amount) || 0;
            });
            
            var remainingNet = totalNet - allocatedNet;
            var remainingGst = totalGst - allocatedGst;
            
            if (Math.abs(remainingNet) > 0.01 || Math.abs(remainingGst) > 0.01) {
                isValid = false;
                reason = 'remaining not zero: net=' + remainingNet + ', gst=' + remainingGst;
            }
        }
        
        
        if (isValid) {
            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
        } else {
            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
        }
    }
    
    // Validate Approve button (checks allocations table - used after row selection)
    function validateDirectSendButton(billPk) {
        var button = $('button[data-bill-pk="' + billPk + '"].approve-btn');
        if (button.length === 0) return;
        
        var isValid = true;
        
        // Must have at least one allocation
        var allocRows = $('#billsDirectAllocationsTableBody tr');
        if (allocRows.length === 0) {
            isValid = false;
        }
        
        // All allocations must have Xero Account selected
        allocRows.each(function() {
            if (!$(this).find('.xero-account-select').val()) {
                isValid = false;
            }
        });
        
        // Remaining must be zero
        var remainingNet = parseFloat($('#billsDirectRemainingNet').text().replace('$', '').replace(',', '')) || 0;
        var remainingGst = parseFloat($('#billsDirectRemainingGst').text().replace('$', '').replace(',', '')) || 0;
        
        if (Math.abs(remainingNet) > 0.01 || Math.abs(remainingGst) > 0.01) {
            isValid = false;
        }
        
        if (isValid) {
            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
        } else {
            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
        }
    }
    
    // Load Bills Direct data
    window.loadBillsDirect = function() {
        
        $.ajax({
            url: '{% url "core:get_bills_list" %}',
            type: 'GET',
            success: function(response) {
                // Guard: ensure table still exists (user may have navigated away)
                if (!$('#billsDirectMainTableBody').length) {
                    return;
                }
                
                // Store data globally
                window.billsDirectData = response;
                
                // Filter for Direct bills (status = 0, xero_instance set, no project)
                var directBills = response.bills.filter(function(bill) {
                    return bill.bill_status === 0 && 
                           bill.xero_instance_id !== null && 
                           bill.project_pk === null;
                });
                
                // Populate table
                AllocationsManager.populateMainTable('billsDirect', directBills);
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsDirectMainTable');
                
                // Bind event handlers
                bindDirectEventHandlers();
                
                // Validate Send buttons on load (check bill data directly)
                // Small delay to ensure DOM is fully rendered
                setTimeout(function() {
                    directBills.forEach(function(bill) {
                        validateBillOnLoad(bill);
                    });
                }, 100);
            },
            error: function(xhr, status, error) {
                console.error('Failed to load bills:', error);
            }
        });
    };
    
    // Bind event handlers for Direct mode
    function bindDirectEventHandlers() {
        var ns = '.billsDirect';
        
        // Unbind previous handlers
        $(document).off(ns);
        
        // Allocation field changes - update database and recalculate
        $(document).on('change' + ns, '#billsDirectAllocationsTableBody .xero-account-select', function() {
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            var value = $(this).val();
            
            updateAllocationField(allocationPk, 'xero_account_pk', value, row);
            validateDirectSendButton(window.currentSelectedBillPk);
        });
        
        $(document).on('change' + ns, '#billsDirectAllocationsTableBody .tracking-category-select', function() {
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            var value = $(this).val();
            
            updateAllocationField(allocationPk, 'tracking_category_pk', value, row);
        });
        
        $(document).on('change' + ns, '#billsDirectAllocationsTableBody .allocation-net-input', function() {
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            var value = $(this).val();
            
            // Auto-calculate GST
            var gstValue = (parseFloat(value) * 0.1).toFixed(2);
            row.find('.allocation-gst-input').val(gstValue);
            
            // Update both amount and gst together to avoid race condition
            updateAllocationFields(allocationPk, { amount: value, gst_amount: gstValue }, row);
            updateRemainingAllocations();
        });
        
        $(document).on('change' + ns, '#billsDirectAllocationsTableBody .allocation-gst-input', function() {
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            var value = $(this).val();
            
            updateAllocationField(allocationPk, 'gst_amount', value, row);
            updateRemainingAllocations();
        });
        
        $(document).on('input' + ns, '#billsDirectAllocationsTableBody .allocation-net-input, #billsDirectAllocationsTableBody .allocation-gst-input', function() {
            // Update $ Gross cell
            var row = $(this).closest('tr');
            var netVal = parseFloat(row.find('.allocation-net-input').val()) || 0;
            var gstVal = parseFloat(row.find('.allocation-gst-input').val()) || 0;
            row.find('.allocation-gross-cell').text('$' + Utils.formatMoney(netVal + gstVal));
            
            updateRemainingAllocations();
        });
        
        $(document).on('change' + ns, '#billsDirectAllocationsTableBody .allocation-notes-input', function() {
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            updateAllocationField(allocationPk, 'notes', $(this).val(), row);
        });
        
        // Delete allocation button
        $(document).on('click' + ns, '#billsDirectAllocationsTableBody .delete-allocation-btn', function(e) {
            e.preventDefault();
            var row = $(this).closest('tr');
            var allocationPk = row.attr('data-allocation-pk');
            
            if (confirm('Delete this allocation?')) {
                // If no allocation_pk, this is an unsaved row - just remove from DOM
                if (!allocationPk) {
                    row.fadeOut(300, function() {
                        $(this).remove();
                        updateRemainingAllocations();
                    });
                    return;
                }
                
                $.ajax({
                    url: '/core/delete_bill_allocation/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    contentType: 'application/json',
                    data: JSON.stringify({ allocation_pk: allocationPk }),
                    success: function(response) {
                        if (response.status === 'success') {
                            row.fadeOut(300, function() {
                                $(this).remove();
                                updateRemainingAllocations();
                            });
                        }
                    }
                });
            }
        });
        
        // Add allocation button - use AllocationsManager's handler, just populate dropdowns after
        $(document).on('click' + ns, '#billsDirectAddAllocationBtn', function() {
            // AllocationsManager's handler runs first and adds the row
            // We just need to populate the dropdowns for the new row
            setTimeout(function() {
                var instancePk = window.currentBillData ? 
                    (window.currentBillData.xero_instance_pk || window.currentBillData.xero_instance_id) : null;
                if (instancePk) {
                    populateAllXeroAccountDropdowns(instancePk);
                    populateAllTrackingCategoryDropdowns(instancePk);
                }
                updateRemainingAllocations();
            }, 50);
        });
        
        // Return to Inbox button
        $(document).on('click' + ns, '.return-to-inbox-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var billPk = $(this).attr('data-bill-pk');
            var row = $(this).closest('tr');
            
            if (confirm('Return this bill to Inbox?')) {
                $.ajax({
                    url: '{% url "core:return_to_inbox" %}',
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    contentType: 'application/json',
                    data: JSON.stringify({ bill_pk: billPk }),
                    success: function(response) {
                        if (response.status === 'success') {
                            row.fadeOut(400, function() { $(this).remove(); });
                            
                            if (window.currentSelectedBillPk == billPk) {
                                $('#billsDirectAllocationsTableBody').empty();
                                $('#billsDirectRemainingNet').text('$0.00').css('color', 'green');
                                $('#billsDirectRemainingGst').text('$0.00').css('color', 'green');
                                $('#billsDirectPdfViewer').hide();
                                $('#billsDirectViewerPlaceholder').show();
                                window.currentSelectedBillPk = null;
                                window.currentBillData = null;
                            }
                        } else {
                            alert('Failed: ' + response.message);
                        }
                    }
                });
            }
        });
        
        // Pull Xero Accounts button
        $(document).on('click' + ns, '#billsDirectPullAccountsBtn', function(e) {
            e.preventDefault();
            
            var button = $(this);
            var originalHtml = button.html();
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: '{% url "core:pull_xero_accounts_and_divisions" %}',
                type: 'POST',
                headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('Xero accounts pulled successfully');
                        // Refresh dropdowns
                        if (window.currentBillData) {
                            populateAllXeroAccountDropdowns(window.currentBillData.xero_instance_pk || window.currentBillData.xero_instance_id);
                        }
                    } else {
                        alert('Error: ' + response.message);
                    }
                    button.prop('disabled', false).html(originalHtml);
                },
                error: function() {
                    alert('Failed to pull Xero accounts');
                    button.prop('disabled', false).html(originalHtml);
                }
            });
        });
        
        // Prevent scroll changing number inputs
        $(document).on('wheel' + ns + ' mousewheel' + ns, '#billsDirectAllocationsTableBody input[type="number"]', function() {
            $(this).blur();
        });
    }
    
    // Update multiple allocation fields in database at once
    function updateAllocationFields(allocationPk, fields, row) {
        if (!allocationPk) {
            // No allocation yet - create one first with all fields
            if (!window.currentBillData) return;
            
            var createData = {
                bill_pk: window.currentBillData.bill_pk,
                amount: 0,
                gst_amount: 0
            };
            // Merge all fields into createData
            Object.assign(createData, fields);
            
            $.ajax({
                url: '/core/create_bill_allocation/',
                type: 'POST',
                headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                contentType: 'application/json',
                data: JSON.stringify(createData),
                success: function(response) {
                    if (response.status === 'success' && response.allocation_pk) {
                        // Update the row with the new allocation_pk
                        if (row) {
                            row.attr('data-allocation-pk', response.allocation_pk);
                        }
                    }
                }
            });
            return;
        }
        
        // Update existing allocation with all fields at once
        var data = { allocation_pk: allocationPk };
        Object.assign(data, fields);
        
        $.ajax({
            url: '/core/update_bill_allocation/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify(data)
        });
    }
    
    // Update single allocation field in database
    function updateAllocationField(allocationPk, field, value, row) {
        var fields = {};
        fields[field] = value;
        updateAllocationFields(allocationPk, fields, row);
    }
    
})();
</script>

<!-- PDF Confirmation Modal for Direct Bills -->
<style>
    #pdfConfirmModalDirect { z-index: 1060 !important; }
    #pdfConfirmModalDirect + .modal-backdrop { z-index: 1055 !important; }
</style>
<div class="modal fade" id="pdfConfirmModalDirect" tabindex="-1" aria-labelledby="pdfConfirmModalDirectLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-height: 90vh; margin-top: 5vh;">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h5 class="modal-title" id="pdfConfirmModalDirectLabel">Confirm PDF Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 140px);">
                <div class="alert alert-info mb-2 py-2">
                    <strong>PDF Source:</strong> <span id="pdfSourceInfoDirect">Loading...</span>
                </div>
                <div class="alert alert-warning mb-2 py-2" id="pdfUrlDisplayDirect">
                    <strong>URL:</strong> <code id="pdfUrlTextDirect" style="word-break: break-all; font-size: 0.8em;"></code>
                </div>
                <div id="pdfPreviewContainerDirect" style="height: 350px; border: 1px solid #ddd; background: #f5f5f5;">
                    <iframe id="pdfPreviewFrameDirect" style="width: 100%; height: 100%; border: none;"></iframe>
                    <div id="pdfPreviewErrorDirect" class="text-center text-danger p-4" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Could not load PDF preview. The URL may be invalid or inaccessible.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmDirectSendToXeroBtn">
                    <i class="fas fa-check"></i> Confirm & Send to Xero
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    var pendingBillPk = null;
    var pendingButton = null;
    var pendingRow = null;
    var pdfConfirmModalDirect = null;
    
    // Initialize modal
    $(document).ready(function() {
        var modalEl = document.getElementById('pdfConfirmModalDirect');
        if (modalEl) {
            // Move modal to body to escape any overflow:hidden containers
            document.body.appendChild(modalEl);
            
            pdfConfirmModalDirect = new bootstrap.Modal(modalEl, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Ensure modal gets focus when shown
            modalEl.addEventListener('shown.bs.modal', function() {
                modalEl.focus();
                $('#confirmDirectSendToXeroBtn').focus();
            });
        }
    });
    
    // Approve button - approve bill and move to Approvals section
    $(document).on('click.approveDirect', '.approve-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var billPk = button.attr('data-bill-pk');
        var row = button.closest('tr');
        
        // Disable button and show spinner
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '{% url "core:approve_bill_direct" %}',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: billPk }),
            success: function(response) {
                if (response.status === 'success') {
                    // Show success and fade out row
                    AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                        if (window.currentSelectedBillPk == billPk) {
                            $('#billsDirectAllocationsTableBody').empty();
                            $('#billsDirectPdfViewer').hide();
                            $('#billsDirectViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    });
                } else {
                    button.prop('disabled', false).text('Approve');
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                button.prop('disabled', false).text('Approve');
                var errMsg = 'Failed to approve bill.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errMsg += '\n' + xhr.responseJSON.message;
                }
                alert(errMsg);
            }
        });
    });
    
})();
</script>

<!-- =====================================================
     APPROVALS SECTION JS
     ===================================================== -->
<script>
(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#billsApprovalsMainTableBody').length === 0) {
        return;
    }
    
    
    // Initialize AllocationsManager for Bills Approvals
    AllocationsManager.init({
        sectionId: 'billsApprovals',
        features: {
            saveRowBtn: false,
            deleteRowBtn: false,
            constructionMode: false,
            gstField: true,
            confirmDelete: false,
            reloadAfterDelete: false,
            showSaveButton: false,
            alwaysShowAddButton: false
        },
        data: {
            pkField: 'bill_pk'
        },
        mainTable: {
            emptyMessage: 'No approved bills waiting to be sent to Xero.',
            showFooter: false,
            renderRow: function(bill, index, cfg) {
                var pdfUrl = bill.pdf_url || '';
                var row = $('<tr>')
                    .attr('data-pk', bill.bill_pk)
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', pdfUrl);
                
                // 1. Project
                var projectName = bill.project_name || '-';
                row.append($('<td>').attr('title', projectName).text(projectName));
                
                // 2. Xero Instance
                var xeroInstanceName = bill.xero_instance_name || '-';
                row.append($('<td>').attr('title', xeroInstanceName).text(xeroInstanceName));
                
                // 3. Supplier
                var supplierName = bill.supplier_name || '-';
                row.append($('<td>').attr('title', supplierName).text(supplierName));
                
                // 4. Bill #
                var billNumber = bill.supplier_bill_number || '-';
                row.append($('<td>').attr('title', billNumber).text(billNumber));
                
                // 5. Currency (FX - display only, added 2026-02-14)
                var currencyDisplay = (bill.currency && bill.currency !== 'AUD') ? bill.currency : '';
                row.append($('<td>').addClass('currency-cell').text(currencyDisplay));
                // Add fx-unfixed class and inline style for orange highlighting
                if (isUnfixedFxBill(bill)) {
                    row.addClass('fx-unfixed').css('background-color', 'rgba(255, 140, 0, 0.5)');
                    console.log('[FX] Approvals row', bill.bill_pk, 'is unfixed FX - adding orange styling');
                }
                
                // 6. $ Gross
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gross)));
                
                // 7. $ Net
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_net)));
                
                // 8. $ GST
                row.append($('<td>').text('$' + Utils.formatMoney(bill.total_gst)));
                
                // 9. Date (display only, dd-mmm-yy format)
                row.append($('<td>').text(bill.bill_date ? Utils.formatDateDMY(bill.bill_date) : '-'));
                
                // 10. Due Date (display only, dd-mmm-yy format)
                row.append($('<td>').text(bill.bill_due_date ? Utils.formatDateDMY(bill.bill_due_date) : '-'));
                
                // 11. Send to Xero button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-success approvals-send-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Send');
                row.append($('<td>').addClass('col-action-first').css('text-align', 'center').append(sendBtn));
                
                // 12. Mark X button (marks as sent without actually sending to Xero)
                var markXBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary approvals-mark-x-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Mark X')
                    .attr('title', 'Mark as sent to Xero without sending');
                row.append($('<td>').addClass('col-action').css('text-align', 'center').append(markXBtn));
                
                // 13. Return to Project button
                var returnBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning approvals-return-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .html('<i class="fas fa-undo"></i>')
                    .attr('title', 'Return to Project');
                row.append($('<td>').addClass('col-action').css('text-align', 'center').append(returnBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                window.currentSelectedBillPk = pk;
                
                // Find full bill data
                var bill = window.billsApprovalsData.find(function(b) {
                    return b.bill_pk === parseInt(pk);
                });
                window.currentBillData = bill;
                
                // Load allocations for this bill (read-only)
                loadBillAllocations(bill);
            }
        },
        allocations: {
            editable: false,
            showStillToAllocate: false,
            columnWidths: ['18%', '18%', '14%', '12%', '12%', '12%', '14%']
        },
        api: {},
        callbacks: {}
    });
    
    // Load bill allocations (read-only display)
    function loadBillAllocations(bill) {
        var allocationsTableBody = $('#billsApprovalsAllocationsTableBody');
        allocationsTableBody.empty();
        
        if (bill && bill.allocations && bill.allocations.length > 0) {
            bill.allocations.forEach(function(alloc) {
                var row = $('<tr>');
                
                // 1. Xero Account (20%)
                row.append($('<td>').text(alloc.xero_account_name || '-'));
                
                // 2. Tracking Category (20%)
                row.append($('<td>').text(alloc.tracking_category_name || '-'));
                
                // 3. Costing Item (14%)
                row.append($('<td>').text(alloc.costing_name || '-'));
                
                // 4. $ Gross (12%)
                var allocNet = parseFloat(alloc.amount) || 0;
                var allocGst = parseFloat(alloc.gst_amount) || 0;
                row.append($('<td>').text('$' + Utils.formatMoney(allocNet + allocGst)));
                
                // 5. $ Net (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.amount)));
                
                // 6. $ GST (12%)
                row.append($('<td>').text('$' + Utils.formatMoney(alloc.gst_amount)));
                
                // 7. Notes (14%)
                row.append($('<td>').text(alloc.notes || ''));
                
                allocationsTableBody.append(row);
            });
        }
        
        // Hide allocations footer (not needed for approvals)
        $('#billsApprovalsAllocationsFooter').hide();
        
        // Apply column widths for proper alignment (tbody uses display:block for scrolling)
        Utils.applyColumnStyles('billsApprovals', ['18%', '18%', '14%', '12%', '12%', '12%', '14%'], { addEditableClass: false });
    }
    
    // Load Approved Bills data
    window.loadApprovedBills = function() {
        console.log('=== loadApprovedBills called ===');
        
        $.ajax({
            url: '{% url "core:get_approved_bills" %}',
            type: 'GET',
            success: function(response) {
                // Guard: ensure table still exists (user may have navigated away)
                if (!$('#billsApprovalsMainTableBody').length) {
                    return;
                }
                
                console.log('Approvals - API response:', response);
                console.log('Approvals - Bills count:', response.bills ? response.bills.length : 0);
                if (response.bills) {
                    response.bills.forEach(function(b) {
                        console.log('  bill_pk=' + b.bill_pk + ', status=' + b.bill_status + ', project=' + b.project_name);
                    });
                }
                
                // Store data globally
                window.billsApprovalsData = response.bills;
                
                // Populate table
                AllocationsManager.populateMainTable('billsApprovals', response.bills);
                
                // Add truncation tooltips
                Utils.addTruncationTooltips('billsApprovalsMainTable');
                
                // Initialize sortable table functionality
                Utils.initSortableTable('billsApprovalsMainTable', {
                    tbodyId: 'billsApprovalsMainTableBody'
                });
                
                // Bind event handlers
                bindApprovalsEventHandlers();
            },
            error: function(xhr, status, error) {
                console.error('Failed to load approved bills:', error);
                $('#billsApprovalsMainTableBody').html('<tr><td colspan="12" class="text-center text-danger">Failed to load bills</td></tr>');
            }
        });
    };
    
    // Bind event handlers for Approvals mode
    function bindApprovalsEventHandlers() {
        var ns = '.billsApprovals';
        
        // Unbind previous handlers
        $(document).off(ns);
        
        // Mark X button - marks as sent without actually sending to Xero
        $(document).on('click' + ns, '.approvals-mark-x-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var button = $(this);
            var billPk = button.attr('data-bill-pk');
            var row = button.closest('tr');
            
            if (confirm('Mark this bill as sent to Xero WITHOUT actually sending it?\n\nThis will update the status as if sent, but no data will be pushed to Xero.')) {
                button.prop('disabled', true).text('...');
                
                $.ajax({
                    url: '/core/mark_bill_as_sent/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    contentType: 'application/json',
                    data: JSON.stringify({ bill_pk: billPk }),
                    success: function(response) {
                        if (response.status === 'success') {
                            AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                                if (window.currentSelectedBillPk == billPk) {
                                    $('#billsApprovalsAllocationsTableBody').empty();
                                    $('#billsApprovalsPdfViewer').hide();
                                    $('#billsApprovalsViewerPlaceholder').show();
                                    window.currentSelectedBillPk = null;
                                    window.currentBillData = null;
                                }
                                
                                // Check if table is now empty
                                if ($('#billsApprovalsMainTableBody tr').length === 0) {
                                    $('#billsApprovalsMainTableBody').html('<tr><td colspan="12" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                                }
                            });
                        } else {
                            alert('Error: ' + response.message);
                            button.prop('disabled', false).text('Mark X');
                        }
                    },
                    error: function(xhr) {
                        alert('Failed to mark bill: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        button.prop('disabled', false).text('Mark X');
                    }
                });
            }
        });
        
        // Return to Project button
        $(document).on('click' + ns, '.approvals-return-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var button = $(this);
            var billPk = button.attr('data-bill-pk');
            var row = button.closest('tr');
            
            if (confirm('Return this bill to the project?')) {
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: '{% url "core:return_bill_to_project" invoice_id=0 %}'.replace('0', billPk),
                    type: 'POST',
                    headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                    success: function(response) {
                        AllocationsManager.showSuccessAndFadeRow(button, row, function() {
                            if (window.currentSelectedBillPk == billPk) {
                                $('#billsApprovalsAllocationsTableBody').empty();
                                $('#billsApprovalsPdfViewer').hide();
                                $('#billsApprovalsViewerPlaceholder').show();
                                window.currentSelectedBillPk = null;
                                window.currentBillData = null;
                            }
                            
                            // Check if table is now empty
                            if ($('#billsApprovalsMainTableBody tr').length === 0) {
                                $('#billsApprovalsMainTableBody').html('<tr><td colspan="12" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                            }
                        });
                    },
                    error: function(xhr) {
                        alert('Failed to return bill: ' + (xhr.responseJSON?.message || 'Unknown error'));
                        button.prop('disabled', false).html('<i class="fas fa-undo"></i>');
                    }
                });
            }
        });
    }
    
})();
</script>

<!-- PDF Confirmation Modal for Approvals -->
<style>
    #pdfConfirmModal { z-index: 1060 !important; }
    #pdfConfirmModal + .modal-backdrop { z-index: 1055 !important; }
</style>
<div class="modal fade" id="pdfConfirmModal" tabindex="-1" aria-labelledby="pdfConfirmModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-height: 90vh; margin-top: 5vh;">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h5 class="modal-title" id="pdfConfirmModalLabel">Confirm PDF Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 140px);">
                <div class="alert alert-info mb-2 py-2">
                    <strong>PDF Source:</strong> <span id="pdfSourceInfo">Loading...</span>
                </div>
                <div class="alert alert-warning mb-2 py-2" id="pdfUrlDisplay">
                    <strong>URL:</strong> <code id="pdfUrlText" style="word-break: break-all; font-size: 0.8em;"></code>
                </div>
                <div id="pdfPreviewContainer" style="height: 350px; border: 1px solid #ddd; background: #f5f5f5;">
                    <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
                    <div id="pdfPreviewError" class="text-center text-danger p-4" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Could not load PDF preview. The URL may be invalid or inaccessible.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSendToXeroBtn">
                    <i class="fas fa-check"></i> Confirm & Send to Xero
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    var pendingBillPk = null;
    var pendingButton = null;
    var pendingRow = null;
    var pdfConfirmModal = null;
    
    // Initialize modal
    $(document).ready(function() {
        var modalEl = document.getElementById('pdfConfirmModal');
        if (modalEl) {
            // Move modal to body to escape any overflow:hidden containers
            document.body.appendChild(modalEl);
            
            pdfConfirmModal = new bootstrap.Modal(modalEl, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Ensure modal gets focus when shown
            modalEl.addEventListener('shown.bs.modal', function() {
                modalEl.focus();
                $('#confirmSendToXeroBtn').focus();
            });
        }
    });
    
    // Override the send button handler to show confirmation first
    $(document).off('click.billsApprovals', '.approvals-send-btn');
    $(document).on('click.pdfConfirm', '.approvals-send-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var button = $(this);
        var billPk = button.attr('data-bill-pk');
        var row = button.closest('tr');
        
        // Store for later
        pendingBillPk = billPk;
        pendingButton = button;
        pendingRow = row;
        
        // Fetch PDF info from backend
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/core/get_bill_pdf_info/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: billPk }),
            success: function(response) {
                button.prop('disabled', false).text('Send');
                
                if (response.status === 'success') {
                    // Show PDF info in modal
                    $('#pdfSourceInfo').text(response.source || 'Unknown');
                    $('#pdfUrlText').text(response.pdf_url || 'No URL');
                    
                    // Load PDF in iframe
                    var pdfUrl = response.pdf_url;
                    if (pdfUrl) {
                        $('#pdfPreviewFrame').attr('src', pdfUrl).show();
                        $('#pdfPreviewError').hide();
                        $('#pdfUrlDisplay').removeClass('alert-danger').addClass('alert-warning');
                    } else {
                        $('#pdfPreviewFrame').hide();
                        $('#pdfPreviewError').show();
                        $('#pdfUrlDisplay').removeClass('alert-warning').addClass('alert-danger');
                        $('#pdfSourceInfo').text('NO PDF FOUND - ' + (response.source || 'Unknown'));
                    }
                    
                    // Show modal
                    pdfConfirmModal.show();
                } else {
                    alert('Error getting PDF info: ' + response.message);
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).text('Send');
                alert('Failed to get PDF info: ' + (xhr.responseJSON?.message || 'Unknown error'));
            }
        });
    });
    
    // Confirm send button
    $(document).on('click', '#confirmSendToXeroBtn', function() {
        if (!pendingBillPk || !pendingButton) return;
        
        var confirmBtn = $(this);
        confirmBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
        
        $.ajax({
            url: '/core/send_bill_to_xero/',
            type: 'POST',
            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
            contentType: 'application/json',
            data: JSON.stringify({ bill_pk: pendingBillPk }),
            success: function(response) {
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                
                // Log full response for debugging
                console.log('=== SEND TO XERO RESPONSE ===');
                console.log('Full response:', response);
                console.log('Status:', response.status);
                console.log('Message:', response.message);
                console.log('Xero Invoice ID:', response.xero_invoice_id);
                console.log('Attachment Status:', response.attachment_status);
                if (response.attachment_debug) {
                    console.log('=== ATTACHMENT DEBUG INFO ===');
                    console.log('PDF Source:', response.attachment_debug.pdf_source);
                    console.log('PDF URL:', response.attachment_debug.pdf_url);
                    console.log('Filename:', response.attachment_debug.filename);
                    console.log('Encoded Filename:', response.attachment_debug.encoded_filename);
                    console.log('Download Status:', response.attachment_debug.download_status);
                    console.log('File Size:', response.attachment_debug.file_size);
                    console.log('Content-Type Received:', response.attachment_debug.content_type_received);
                    console.log('Is Valid PDF:', response.attachment_debug.is_valid_pdf);
                    console.log('Xero Response Status:', response.attachment_debug.xero_response_status);
                    console.log('Xero Response Text:', response.attachment_debug.xero_response_text);
                    console.log('Error:', response.attachment_debug.error);
                    console.log('Exception:', response.attachment_debug.exception);
                    console.log('Full attachment_debug:', JSON.stringify(response.attachment_debug, null, 2));
                }
                
                if (response.status === 'success') {
                    pdfConfirmModal.hide();
                    // Show attachment status
                    var msg = 'Bill sent to Xero!';
                    if (response.attachment_status) {
                        msg += '\nAttachment status: ' + response.attachment_status;
                    }
                    alert(msg);
                    
                    AllocationsManager.showSuccessAndFadeRow(pendingButton, pendingRow, function() {
                        if (window.currentSelectedBillPk == pendingBillPk) {
                            $('#billsApprovalsAllocationsTableBody').empty();
                            $('#billsApprovalsPdfViewer').hide();
                            $('#billsApprovalsViewerPlaceholder').show();
                            window.currentSelectedBillPk = null;
                            window.currentBillData = null;
                        }
                    });
                } else if (response.status === 'duplicate_found') {
                    // Duplicate invoice found in Xero - ask user for confirmation
                    var existing = response.existing_invoice || {};
                    var confirmMsg = 'Invoice #' + existing.invoice_number + ' already exists in Xero!\n\n' +
                        'Existing Invoice Details:\n' +
                        '- Status: ' + existing.status + '\n' +
                        '- Date: ' + existing.date + '\n' +
                        '- Total: $' + existing.total + '\n\n' +
                        'Do you want to UPDATE the existing invoice in Xero?\n\n' +
                        'WARNING: If the existing invoice is locked or has payments, this will fail.';
                    
                    if (confirm(confirmMsg)) {
                        // User confirmed - retry with force_update=true
                        confirmBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');
                        $.ajax({
                            url: '/core/send_bill_to_xero/',
                            type: 'POST',
                            headers: { 'X-CSRFToken': Utils.getCSRFToken() },
                            contentType: 'application/json',
                            data: JSON.stringify({ bill_pk: pendingBillPk, force_update: true }),
                            success: function(retryResponse) {
                                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                                if (retryResponse.status === 'success') {
                                    pdfConfirmModal.hide();
                                    alert('Invoice updated in Xero!');
                                    AllocationsManager.showSuccessAndFadeRow(pendingButton, pendingRow, function() {
                                        if (window.currentSelectedBillPk == pendingBillPk) {
                                            $('#billsApprovalsAllocationsTableBody').empty();
                                            $('#billsApprovalsPdfViewer').hide();
                                            $('#billsApprovalsViewerPlaceholder').show();
                                            window.currentSelectedBillPk = null;
                                            window.currentBillData = null;
                                        }
                                    });
                                } else {
                                    alert('Error updating invoice: ' + retryResponse.message);
                                }
                            },
                            error: function(xhr) {
                                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                                var errMsg = 'Failed to update invoice in Xero.';
                                if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errMsg += '\n' + xhr.responseJSON.message;
                                }
                                alert(errMsg);
                            }
                        });
                    }
                    // If user clicked Cancel, modal stays open - they can retry or close
                } else {
                    // Keep modal open on error so user can retry or cancel
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // Keep modal open on error so user can retry or cancel
                confirmBtn.prop('disabled', false).html('<i class="fas fa-check"></i> Confirm & Send to Xero');
                var errMsg = 'Failed to send to Xero.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errMsg += '\n' + xhr.responseJSON.message;
                } else if (xhr.status) {
                    errMsg += '\nStatus: ' + xhr.status + ' ' + error;
                }
                console.error('Send to Xero error:', xhr, status, error);
                
                // Log debug info if available
                if (xhr.responseJSON && xhr.responseJSON.debug) {
                    console.log('=== XERO DEBUG INFO ===');
                    console.log('Debug data:', JSON.stringify(xhr.responseJSON.debug, null, 2));
                    errMsg += '\n\n--- Debug Info ---';
                    errMsg += '\nSupplier Bill #: ' + xhr.responseJSON.debug.supplier_bill_number;
                    errMsg += '\nBill Date (raw): ' + xhr.responseJSON.debug.bill_date_raw;
                    errMsg += '\nBill Date (sent): ' + xhr.responseJSON.debug.bill_date_formatted;
                    errMsg += '\nBill Xero ID: ' + (xhr.responseJSON.debug.bill_xero_id || 'None');
                }
                
                alert(errMsg);
            }
        });
    });
    
})();

// Debug function to inspect padding/margin between containers
window.debugBillsLayout = function(sectionId) {
    sectionId = sectionId || 'billsApprovals';
    var leftPanel = $('.' + sectionId + '-left-panel');
    var tableContainer = $('#' + sectionId + 'TableContainer');
    var allocationsSection = $('#' + sectionId + 'AllocationsSection');
    var outerTableContainer = tableContainer.parent();
    
    console.log('=== DEBUG: ' + sectionId + ' Layout ===');
    console.log('Left Panel:', leftPanel.length ? leftPanel[0] : 'NOT FOUND');
    console.log('  - padding:', leftPanel.css('padding'));
    console.log('  - gap:', leftPanel.css('gap'));
    console.log('  - computed style:', window.getComputedStyle(leftPanel[0]));
    
    console.log('Outer Table Container (.table-container):', outerTableContainer.length ? outerTableContainer[0] : 'NOT FOUND');
    console.log('  - margin:', outerTableContainer.css('margin'));
    console.log('  - margin-top:', outerTableContainer.css('margin-top'));
    console.log('  - padding:', outerTableContainer.css('padding'));
    
    console.log('Table Container (#' + sectionId + 'TableContainer):', tableContainer.length ? tableContainer[0] : 'NOT FOUND');
    console.log('  - margin:', tableContainer.css('margin'));
    console.log('  - padding:', tableContainer.css('padding'));
    
    console.log('Allocations Section:', allocationsSection.length ? allocationsSection[0] : 'NOT FOUND');
    console.log('  - margin:', allocationsSection.css('margin'));
    console.log('  - padding:', allocationsSection.css('padding'));
    
    // Return structured data
    return {
        leftPanel: {
            el: leftPanel[0],
            padding: leftPanel.css('padding'),
            gap: leftPanel.css('gap'),
            paddingTop: leftPanel.css('padding-top')
        },
        outerTableContainer: {
            el: outerTableContainer[0],
            margin: outerTableContainer.css('margin'),
            marginTop: outerTableContainer.css('margin-top'),
            padding: outerTableContainer.css('padding')
        },
        tableContainer: {
            el: tableContainer[0],
            margin: tableContainer.css('margin'),
            padding: tableContainer.css('padding')
        },
        allocationsSection: {
            el: allocationsSection[0],
            margin: allocationsSection.css('margin'),
            padding: allocationsSection.css('padding')
        }
    };
};

// Auto-bind xero-project-select handlers when inbox loads
$(document).on('ajaxComplete', function(event, xhr, settings) {
    if (settings.url && settings.url.indexOf('get_bills_list') !== -1) {
        setTimeout(function() {
            window.bindXeroProjectSelectHandlers();
        }, 100);
    }
});

// Bind xero-project-select change handlers
window.bindXeroProjectSelectHandlers = function() {
    var selects = $('#billsInboxMainTableBody .xero-project-select');
    if (selects.length === 0) return;
    
    selects.off('change.xeroProject').on('change.xeroProject', function() {
        var $this = $(this);
        var $row = $this.closest('tr');
        var value = $this.val();
        
        if (value && value.startsWith('stocktake_')) {
            // Stocktake selected - show Xero instance radio buttons
            var stocktakeInstances = (window.billsInboxData.xero_instances || []).filter(function(xi) {
                return xi.stocktake === 1;
            });
            
            if (stocktakeInstances.length > 0) {
                var supplierCell = $row.find('.supplier-cell');
                var supplierSelect = $row.find('.supplier-select');
                
                // Mark row as stocktake mode - CSS will hide the searchable-dropdown-wrapper
                $row.addClass('stocktake-mode');
                
                // Hide original supplier select
                supplierSelect.hide();
                
                // Remove any existing stocktake UI (will recreate)
                supplierCell.find('.stocktake-instance-selector').remove();
                supplierCell.find('.stocktake-supplier-dropdown').remove();
                
                // Create instance selector with radio buttons
                var instanceSelector = $('<div class="stocktake-instance-selector" style="margin-bottom: 6px;">');
                stocktakeInstances.forEach(function(xi, index) {
                    var radioId = 'stocktake_radio_' + $row.attr('data-bill-pk') + '_' + xi.xero_instance_pk;
                    var label = $('<label style="display: block; margin: 2px 0; font-size: 11px; cursor: pointer;">');
                    var radio = $('<input type="radio">')
                        .attr('name', 'xero_instance_' + $row.attr('data-bill-pk'))
                        .attr('id', radioId)
                        .val(xi.xero_instance_pk)
                        .addClass('stocktake-xero-radio');
                    if (index === 0) radio.prop('checked', true);
                    label.append(radio).append($('<span>').text(' ' + xi.xero_name));
                    instanceSelector.append(label);
                });
                
                supplierCell.prepend(instanceSelector);
                
                // Create supplier dropdown for stocktake
                var stocktakeSupplierSelect = $('<select class="form-control form-control-sm stocktake-supplier-dropdown">');
                stocktakeSupplierSelect.append($('<option>').val('').text('Select Supplier...'));
                supplierCell.append(stocktakeSupplierSelect);
                
                // Function to populate suppliers based on selected instance
                var populateStocktakeSuppliers = function(xeroInstanceId) {
                    stocktakeSupplierSelect.empty().append($('<option>').val('').text('Select Supplier...'));
                    if (window.billsInboxData && window.billsInboxData.suppliers) {
                        window.billsInboxData.suppliers.forEach(function(supplier) {
                            if (supplier.xero_instance_id === xeroInstanceId) {
                                stocktakeSupplierSelect.append(
                                    $('<option>').val(supplier.contact_pk).text(supplier.name)
                                );
                            }
                        });
                    }
                };
                
                // Initial populate with first instance
                populateStocktakeSuppliers(stocktakeInstances[0].xero_instance_pk);
                
                // Bind radio button change handler
                instanceSelector.find('.stocktake-xero-radio').on('change', function() {
                    var selectedInstanceId = parseInt($(this).val());
                    populateStocktakeSuppliers(selectedInstanceId);
                    // Trigger validation after changing xero instance (supplier will be reset)
                    var billPk = $row.attr('data-bill-pk');
                    if (typeof validateInboxSendButton === 'function') {
                        validateInboxSendButton(billPk);
                    }
                });
                
                // Bind stocktake supplier dropdown change handler to trigger validation
                stocktakeSupplierSelect.on('change', function() {
                    var billPk = $row.attr('data-bill-pk');
                    console.log('[Stocktake] Supplier changed, billPk:', billPk, 'value:', $(this).val());
                    if (typeof validateInboxSendButton === 'function') {
                        validateInboxSendButton(billPk);
                    }
                });
            }
        } else {
            // Not stocktake - remove stocktake mode and show normal supplier dropdown
            $row.removeClass('stocktake-mode');
            var supplierCell = $row.find('.supplier-cell');
            supplierCell.find('.stocktake-instance-selector').remove();
            supplierCell.find('.stocktake-supplier-dropdown').remove();
        }
    });
};

// Debug function for stocktake supplier dropdown issue
window.debugStocktakeDropdowns = function() {
    console.log('=== DEBUG: Stocktake Dropdowns ===');
    
    var rows = $('#billsInboxMainTableBody tr');
    console.log('1. Total rows in inbox:', rows.length);
    
    rows.each(function(i) {
        var $row = $(this);
        var billPk = $row.attr('data-bill-pk');
        var projectSelect = $row.find('.xero-project-select');
        var selectedValue = projectSelect.val();
        
        if (selectedValue && selectedValue.startsWith('stocktake')) {
            console.log('\n--- Row', i, '(bill_pk:', billPk, ') has Stocktake selected ---');
            
            var supplierCell = $row.find('.supplier-cell');
            console.log('2. Supplier cell children:', supplierCell.children().length);
            supplierCell.children().each(function(j) {
                console.log('   Child', j + ':', this.tagName, this.className, 'visible:', $(this).is(':visible'));
            });
            
            // Check for all select elements
            var allSelects = supplierCell.find('select');
            console.log('3. All select elements in supplier cell:', allSelects.length);
            allSelects.each(function(k) {
                var $sel = $(this);
                console.log('   Select', k + ':', $sel.attr('class'), 'visible:', $sel.is(':visible'), 'options:', $sel.find('option').length);
                console.log('      First 5 options:', $sel.find('option').slice(0, 5).map(function() { return $(this).text(); }).get());
            });
            
            // Check for stocktake-specific elements
            console.log('4. .stocktake-instance-selector:', supplierCell.find('.stocktake-instance-selector').length);
            console.log('5. .stocktake-supplier-dropdown:', supplierCell.find('.stocktake-supplier-dropdown').length);
            console.log('6. .stocktake-supplier-ui:', supplierCell.find('.stocktake-supplier-ui').length);
            console.log('7. .searchable-dropdown-wrapper:', supplierCell.find('.searchable-dropdown-wrapper').length, 'visible:', supplierCell.find('.searchable-dropdown-wrapper').is(':visible'));
            console.log('8. .supplier-select:', supplierCell.find('.supplier-select').length, 'visible:', supplierCell.find('.supplier-select').is(':visible'));
        }
    });
    
    // Check billsInboxData suppliers
    console.log('\n9. billsInboxData.suppliers sample:');
    if (window.billsInboxData && window.billsInboxData.suppliers) {
        console.log('   Total suppliers:', window.billsInboxData.suppliers.length);
        console.log('   First 3 FULL:', JSON.stringify(window.billsInboxData.suppliers.slice(0, 3), null, 2));
        console.log('   Field names:', Object.keys(window.billsInboxData.suppliers[0] || {}));
        
        // Group by xero_instance_id
        var byInstance = {};
        window.billsInboxData.suppliers.forEach(function(s) {
            byInstance[s.xero_instance_id] = (byInstance[s.xero_instance_id] || 0) + 1;
        });
        console.log('   Suppliers per xero_instance_id:', byInstance);
    }
    
    console.log('\n10. xero_instances with stocktake:');
    if (window.billsInboxData && window.billsInboxData.xero_instances) {
        window.billsInboxData.xero_instances.forEach(function(xi) {
            console.log('   pk:', xi.xero_instance_pk, 'name:', xi.xero_name, 'stocktake:', xi.stocktake);
        });
    }
};

// Debug function to check if handlers are bound
window.debugBillsHandlers = function() {
    console.log('=== DEBUG: Bills Handlers ===');
    
    // Check tbody ID
    var tbody = $('#billsInboxMainTableBody');
    console.log('0. #billsInboxMainTableBody found:', tbody.length > 0, tbody[0]);
    
    var selects = $('#billsInboxMainTableBody .xero-project-select');
    console.log('1. xero-project-select elements found:', selects.length);
    if (selects.length > 0) {
        console.log('   First select:', selects[0]);
        console.log('   Is hidden:', selects.first().is(':hidden'));
        console.log('   Parent chain:', selects.first().parents().map(function() { return this.tagName + (this.id ? '#'+this.id : ''); }).get().join(' > '));
    }
    
    // Check if there's a wrapper
    var wrappers = $('#billsInboxMainTableBody .searchable-dropdown-wrapper');
    console.log('2. searchable-dropdown-wrapper elements:', wrappers.length);
    
    // Check events bound to document
    var events = $._data(document, 'events');
    console.log('3. Document events:', events);
    if (events && events.change) {
        var billsEvents = events.change.filter(function(e) { return e.namespace === 'billsInbox'; });
        console.log('4. Change events with billsInbox namespace:', billsEvents.length);
        billsEvents.forEach(function(e, i) {
            console.log('   Event ' + i + ':', e.selector, e.handler.toString().substring(0, 100));
        });
    }
    
    // Try direct binding test
    console.log('5. Testing direct event binding...');
    var testSelect = selects.first();
    testSelect.off('change.test').on('change.test', function() {
        console.log('[DIRECT HANDLER] Change fired!');
    });
    testSelect.val('stocktake_-1').trigger('change');
};

// Debug function for stocktake supplier dropdown
window.debugStocktakeSupplierDropdown = function() {
    console.log('=== DEBUG: Stocktake Supplier Dropdown ===');
    console.log('1. billsInboxData exists:', !!window.billsInboxData);
    console.log('2. xero_instances:', window.billsInboxData ? window.billsInboxData.xero_instances : 'N/A');
    if (window.billsInboxData && window.billsInboxData.xero_instances) {
        console.log('3. xero_instances details:');
        window.billsInboxData.xero_instances.forEach(function(xi, i) {
            console.log('   [' + i + '] pk:', xi.xero_instance_pk, 'name:', xi.xero_name, 'stocktake:', xi.stocktake, 'type:', typeof xi.stocktake);
        });
        var filtered = window.billsInboxData.xero_instances.filter(function(xi) { return xi.stocktake === 1; });
        console.log('4. Filtered (stocktake===1):', filtered);
        var filteredLoose = window.billsInboxData.xero_instances.filter(function(xi) { return xi.stocktake == 1; });
        console.log('5. Filtered (stocktake==1):', filteredLoose);
    }
    console.log('6. suppliers count:', window.billsInboxData ? (window.billsInboxData.suppliers || []).length : 'N/A');
    return window.billsInboxData;
};
</script>

<!-- =====================================================
     SECTION TOGGLE LOGIC
     ===================================================== -->
<script>
(function() {
    'use strict';
    
    // Toggle section visibility based on button clicks from bills_global_buttons.html
    window.showBillsSection = function(section) {
        // Hide all section wrappers (use css to preserve flex-direction etc)
        $('#billsInboxSectionWrapper').css('display', 'none');
        $('#billsDirectSectionWrapper').css('display', 'none');
        $('#billsApprovalsSectionWrapper').css('display', 'none');
        
        // Show the requested section (use display: flex to fill height)
        if (section === 'inbox') {
            $('#billsInboxSectionWrapper').css('display', 'flex');
            if (typeof window.loadBillsInbox === 'function') {
                window.loadBillsInbox();
            }
        } else if (section === 'direct') {
            $('#billsDirectSectionWrapper').css('display', 'flex');
            if (typeof window.loadBillsDirect === 'function') {
                window.loadBillsDirect();
            }
        } else if (section === 'approvals') {
            $('#billsApprovalsSectionWrapper').css('display', 'flex');
            if (typeof window.loadApprovedBills === 'function') {
                window.loadApprovedBills();
            }
        }
    };
    
    // Load inbox by default on page load
    $(document).ready(function() {
        if ($('#billsInboxSectionWrapper').length) {
            window.showBillsSection('inbox');
        }
    });
    
})();
</script>
