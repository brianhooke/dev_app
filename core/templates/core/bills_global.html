    <style>
        /* Compact Bills Table Styling */
        #billsTable {
            font-size: 12px;
        }
        
        #billsTable th {
            padding: 6px 4px !important;
            font-size: 11px;
            white-space: nowrap;
            vertical-align: middle;
            line-height: 1.2;
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
        
        #billsTable td {
            padding: 4px 4px !important;
            vertical-align: middle;
            line-height: 1.3;
        }
        
        /* Compact form controls in table */
        #billsTable .form-control-sm {
            font-size: 11px;
            padding: 2px 4px;
            height: 26px;
            min-height: 26px;
        }
        
        #billsTable select.form-control-sm {
            padding-top: 2px;
            padding-bottom: 2px;
        }
        
        #billsTable input[type="text"],
        #billsTable input[type="number"] {
            font-size: 11px;
            padding: 2px 4px;
            height: 26px;
        }
        
        /* Compact buttons in table */
        #billsTable .btn {
            padding: 3px 8px;
            font-size: 11px;
            line-height: 1.2;
            min-height: 26px;
            height: 26px;
        }
        
        #billsTable .btn i {
            font-size: 12px;
        }
        
        /* Compact Allocations Table Styling */
        #allocationsTable {
            font-size: 11px;
        }
        
        #allocationsTable th {
            padding: 5px 4px !important;
            font-size: 10px;
            white-space: nowrap;
            vertical-align: middle;
            line-height: 1.2;
        }
        
        #allocationsTable td {
            padding: 3px 4px !important;
            vertical-align: middle;
            line-height: 1.2;
        }
        
        #allocationsTable .form-control-sm {
            font-size: 10px;
            padding: 2px 3px;
            height: 24px;
            min-height: 24px;
        }
        
        #allocationsTable input[type="text"],
        #allocationsTable input[type="number"] {
            font-size: 10px;
            padding: 2px 3px;
            height: 24px;
        }
        
        /* Sticky header for allocations table */
        #allocationsTable tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
            background-color: #ffffff;
        }
        
        #allocationsTable tbody td {
            display: table-cell;
        }
        
        #allocationsTable tbody td:nth-child(1) {
            width: 28%;
        }
        
        #allocationsTable tbody td:nth-child(2) {
            width: 15%;
        }
        
        #allocationsTable tbody td:nth-child(3) {
            width: 15%;
        }
        
        #allocationsTable tbody td:nth-child(4) {
            width: 42%;
        }
    </style>

    <!-- Bills Section (hidden initially, shown when Bills clicked) -->
    <div id="billsInboxSection" style="display: none; height: 100%; flex-direction: column;">
        <!-- Bills navigation buttons -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary bills-nav-btn" id="billsInboxBtn" data-mode="inbox">Inbox</button>
            <button class="btn btn-outline-primary bills-nav-btn" id="billsDirectBtn" data-mode="direct">Direct</button>
            <button class="btn btn-outline-primary bills-nav-btn" id="billsApprovalsBtn" data-mode="approvals">Approvals</button>
        </div>
        
        <div style="display: flex; flex: 1;">
            <!-- Left side: Bills Table (top 2/3) and Allocations (bottom 1/3) (50%) -->
            <div style="width: 50%; padding-right: 15px; display: flex; flex-direction: column;">
                <!-- Bills Table (flex to fill available space) -->
                <div id="billsTableContainer" style="flex: 1; overflow-y: auto; margin-bottom: 15px;">
                    <table class="table table-bordered table-hover" id="billsTable">
                        <thead>
                            <tr>
                                <th>Xero Instance / Project</th>
                                <th>Supplier</th>
                                <th>Bill #</th>
                                <th>$ Net</th>
                                <th>$ GST</th>
                                <th>Email</th>
                                <th id="sendColumnHeader">Send to Xero</th>
                                <th id="lastColumnHeader">Archive</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody">
                            <!-- Bills will be populated here via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Allocations section (bottom 1/3 - hidden for Bills - Inbox) -->
                <div id="allocationsSection" style="height: 33%; display: none; flex-direction: column;">
                    <div style="text-align: center; margin-bottom: 5px; flex-shrink: 0;">
                        <h6 id="allocationsTitle">Bill Allocations</h6>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden;">
                        <table class="table table-bordered table-sm" id="allocationsTable" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%;">
                            <thead style="flex-shrink: 0; display: block; position: sticky; top: 0; z-index: 10; background: white;">
                                <tr style="display: table; width: 100%; table-layout: fixed;">
                                    <th style="width: 28%;">Xero Account</th>
                                    <th style="width: 15%;">$ Net</th>
                                    <th style="width: 15%;">$ GST</th>
                                    <th style="width: 42%;">Description</th>
                                </tr>
                            </thead>
                            <tbody id="allocationsTableBody" style="flex: 1; display: block; overflow-y: auto;">
                                <!-- Allocations will be populated here via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 5px; display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                        <div style="flex: 0 0 28%; padding-left: 5px;">
                            <strong>Still to allocate:</strong>
                        </div>
                        <div style="flex: 0 0 15%; text-align: center; font-weight: bold;" id="remainingNet">
                            $0.00
                        </div>
                        <div style="flex: 0 0 15%; text-align: center; font-weight: bold;" id="remainingGst">
                            $0.00
                        </div>
                        <div style="flex: 1;"></div>
                        <button type="button" class="btn btn-sm btn-info" id="pullXeroAccountsBtn" style="display: none;">
                            <i class="fas fa-download"></i> Pull Accounts
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="addAllocationBtn">
                            <i class="fas fa-plus"></i> Add Row
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right side: PDF Viewer (50% - full height) -->
            <div style="width: 50%; padding-left: 15px; display: flex; flex-direction: column; height: 100%;">
                <div id="viewerSection" style="flex: 1; display: flex; flex-direction: column;">
                    <div style="flex: 1; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <iframe 
                            id="billViewer" 
                            style="width: 100%; height: 100%; border: none; display: none;"
                            allow="fullscreen"
                            src="">
                        </iframe>
                        <div id="viewerPlaceholder" style="text-align: center; color: #6c757d;">
                            <i class="fas fa-file-pdf" style="font-size: 64px; margin-bottom: 10px;"></i>
                            <p>Click on a bill to view the attachment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approvals Section (hidden initially, loaded via AJAX) -->
    <div id="billsApprovalsSection" style="display: none; height: 100%; flex-direction: column;">
        <!-- Bills navigation buttons (duplicated for this section) -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-outline-primary bills-nav-btn approvals-nav-btn" data-mode="inbox">Inbox</button>
            <button class="btn btn-outline-primary bills-nav-btn approvals-nav-btn" data-mode="direct">Direct</button>
            <button class="btn btn-primary bills-nav-btn approvals-nav-btn" data-mode="approvals">Approvals</button>
        </div>
        
        <!-- Approvals content loaded via AJAX -->
        <div id="approvalsContent" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Content will be loaded via AJAX from bills_approvals.html -->
        </div>
    </div>


<!-- Bills Global JavaScript (consolidated - bills_scripts.html removed) -->
<script>
    $(document).ready(function() {
        // ==========================================
        // BILLS SECTION - Initialize AllocationsManager
        // ==========================================
        // Note: Bills uses custom layout (50/50, Inbox/Direct modes)
        // AllocationsManager is initialized for future use and consistency
        if (typeof AllocationsManager !== 'undefined') {
            AllocationsManager.init({
                sectionId: 'bill',
                mainTable: {
                    emptyMessage: 'No bills to display.',
                    showFooter: false
                },
                allocations: {
                    emptyMessage: 'No allocations for this bill',
                    editable: true
                },
                api: {
                    // Bills allocations are managed differently (Xero accounts)
                }
            });
        }
        
        // Load Bills - Inbox function (called when navbar link is clicked)
        function loadBillsInbox() {
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Populate table with status = -2 (Inbox: unprocessed email bills)
                    populateBillsTable(response, function(bill) {
                        return bill.bill_status === -2;
                    }, 'inbox');
                    
                    // Hide all sections using universal function
                    if (typeof window.hideAllSections === 'function') {
                        window.hideAllSections();
                    }
                    
                    // Show Bills Inbox section and add has-content class to hide background
                    $('#billsInboxSection').show();
                    $('#dynamicContentArea').addClass('has-content');
                    
                    // Hide allocations section for Inbox mode and let bills table fill space
                    $('#allocationsSection').hide();
                    $('#billsTableContainer').css('flex', '1');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        }
        
        // Function to populate bills table with filtering
        function populateBillsTable(billsData, filterFn, modalType) {
            // Clear existing table and selection state
            $('#billsTableBody').empty();
            $('#billsTableBody').removeClass('has-selection');
            $('#allocationsTableBody').empty();
            currentSelectedBillPk = null; // Reset selected bill tracking
            
            // Update modal title and last column header based on type
            currentBillsModalType = modalType; // Store current modal type
            
            if (modalType === 'inbox') {
                $('#billsModalTitle').text('Bills - Inbox');
                $('#sendColumnHeader').text('Send');
                $('#lastColumnHeader').text('Archive');
                // Hide allocations section for Inbox
                $('#allocationsSection').hide();
                $('#viewerSection').css('flex', '1');
                // Hide Pull Xero button in Inbox mode
                $('#pullXeroAccountsBtn').hide();
            } else if (modalType === 'direct') {
                $('#billsModalTitle').text('Bills - Direct');
                $('#sendColumnHeader').text('Send to Xero');
                $('#lastColumnHeader').text('Return to Inbox');
                // Show allocations section for Direct (on LHS, doesn't affect RHS viewer height)
                $('#allocationsSection').css('display', 'flex');
                $('#viewerSection').css('flex', '1');
                // Show Pull Xero button in Direct mode
                $('#pullXeroAccountsBtn').show();
            }
            
            // Filter bills using provided filter function
            var filteredBills = billsData.bills.filter(filterFn);
            
            
            if (filteredBills.length === 0) {
                $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                return;
            }
            
            // Populate table with filtered bills
            filteredBills.forEach(function(bill) {
                try {
                        var row = $('<tr>').attr('data-bill-pk', bill.bill_pk);
                        
                        // 1. Combined Xero Instance / Project dropdown
                        var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                        combinedSelect.append($('<option>').val('').text('Select...'));
                        
                        // Add Xero Instances section
                        if (billsData.xero_instances.length > 0) {
                            var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                            xeroHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(xeroHeader);
                            
                            billsData.xero_instances.forEach(function(instance) {
                                var option = $('<option>')
                                    .val('xero_' + instance.xero_instance_pk)
                                    .text('  ' + instance.xero_name);
                                if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        // Add Projects section
                        if (billsData.projects.length > 0) {
                            var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                            projectHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(projectHeader);
                            
                            billsData.projects.forEach(function(project) {
                                var option = $('<option>')
                                    .val('project_' + project.projects_pk)
                                    .text('  ' + project.project);
                                if (bill.project_pk === project.projects_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        row.append($('<td>').append(combinedSelect));
                        
                        // 2. Supplier dropdown (will be populated based on Xero Instance)
                        var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                        
                        // Determine the xero_instance_id for filtering
                        var selectedXeroInstanceId = null;
                        if (bill.project_pk) {
                            // Find the project's xero_instance_id
                            var project = billsData.projects.find(p => p.projects_pk === bill.project_pk);
                            if (project) {
                                selectedXeroInstanceId = project.xero_instance_id;
                            }
                        } else if (bill.xero_instance_id) {
                            selectedXeroInstanceId = bill.xero_instance_id;
                        }
                        
                        // Only populate suppliers if a Xero Instance is selected
                        if (selectedXeroInstanceId) {
                            // Add "Select Supplier..." option
                            supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator1').text('─────────').prop('disabled', true));
                            
                            // Add "Add..." option
                            supplierSelect.append($('<option>').val('add_supplier').text('Add +'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator2').text('─────────').prop('disabled', true));
                            
                            // Populate suppliers filtered by xero_instance_id
                            billsData.suppliers.forEach(function(supplier) {
                                if (supplier.xero_instance_id === selectedXeroInstanceId) {
                                    var option = $('<option>')
                                        .val(supplier.contact_pk)
                                        .text(supplier.name)
                                        .attr('data-xero-instance', supplier.xero_instance_id);
                                    if (bill.contact_pk === supplier.contact_pk) {
                                        option.prop('selected', true);
                                    }
                                    supplierSelect.append(option);
                                }
                            });
                        } else {
                            // No Xero Instance selected - show placeholder
                            supplierSelect.append($('<option>').val('').text('Select Xero Instance first...'));
                            supplierSelect.prop('disabled', true);
                        }
                        row.append($('<td>').append(supplierSelect));
                        
                        // 3. Bill # input
                        var billNumberInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm bill-number-input')
                            .val(bill.supplier_bill_number || '');
                        row.append($('<td>').append(billNumberInput));
                        
                        // 4. $ NET input (limit to 2 decimal places, no negatives)
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .attr('min', '0')
                            .addClass('form-control form-control-sm net-input')
                            .val(bill.total_net !== null && bill.total_net !== undefined ? bill.total_net : '')
                            .on('input', function() {
                                var value = $(this).val();
                                // Prevent negative numbers
                                if (parseFloat(value) < 0) {
                                    $(this).val(0);
                                    return;
                                }
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                                // Auto-calculate GST as 10% of NET
                                var netValue = parseFloat($(this).val());
                                if (!isNaN(netValue)) {
                                    var gstValue = (netValue * 0.1).toFixed(2);
                                    $(this).closest('tr').find('.gst-input').val(gstValue);
                                    // Update remaining allocations since bill totals changed
                                    if (currentBillData && currentBillData.bill_pk === parseInt($(this).closest('tr').attr('data-bill-pk'))) {
                                        currentBillData.total_net = netValue;
                                        currentBillData.total_gst = parseFloat(gstValue);
                                        updateRemainingAllocations();
                                    }
                                }
                            });
                        row.append($('<td>').append(netInput));
                        
                        // 5. $ GST input (limit to 2 decimal places, no negatives)
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .attr('min', '0')
                            .addClass('form-control form-control-sm gst-input')
                            .val(bill.total_gst !== null && bill.total_gst !== undefined ? bill.total_gst : '')
                            .on('input', function() {
                                var value = $(this).val();
                                // Prevent negative numbers
                                if (parseFloat(value) < 0) {
                                    $(this).val(0);
                                    return;
                                }
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                                // Update remaining allocations in real-time if this is the selected bill
                                var billPk = $(this).closest('tr').attr('data-bill-pk');
                                if (currentBillData && currentBillData.bill_pk === parseInt(billPk)) {
                                    currentBillData.total_gst = parseFloat($(this).val()) || 0;
                                    updateRemainingAllocations();
                                }
                            });
                        row.append($('<td>').append(gstInput));
                        
                        // 6. Email link
                        var emailLink = $('<a>')
                            .attr('href', '#')
                            .text('email')
                            .addClass('email-link')
                            .attr('data-email-html', bill.email_body_html)
                            .attr('data-email-text', bill.email_body_text)
                            .attr('data-email-subject', bill.email_subject)
                            .attr('data-email-from', bill.email_from)
                            .attr('title', bill.email_subject + ' from ' + bill.email_from);
                        row.append($('<td>').append(emailLink));
                        
                        // Store PDF URL on the row for auto-loading
                        row.attr('data-pdf-url', bill.pdf_url || bill.attachment_url);  // Prefer pdf_url, fallback to attachment_url
                        row.attr('data-filename', bill.attachment_filename);
                        
                        // 7. Send button (text depends on modal type)
                        var sendBtnText = modalType === 'direct' ? 'Send to Xero' : 'Send';
                        var sendBtn = $('<button>')
                            .addClass('btn btn-sm btn-secondary send-bill-btn')
                            .text(sendBtnText)
                            .attr('data-bill-pk', bill.bill_pk)
                            .prop('disabled', true); // Start disabled, will be enabled if valid
                        row.append($('<td>').append(sendBtn));
                        
                        // 8. Archive or Return to Inbox button (depending on modal type)
                        if (modalType === 'direct') {
                            // Return to Inbox button with email icon
                            var returnBtn = $('<button>')
                                .addClass('btn btn-sm btn-primary return-to-inbox-btn')
                                .html('<i class="fas fa-envelope"></i>')
                                .attr('data-bill-pk', bill.bill_pk)
                                .attr('title', 'Return to Inbox');
                            row.append($('<td>').append(returnBtn));
                        } else {
                            // Archive button with icon
                            var archiveBtn = $('<button>')
                                .addClass('btn btn-sm btn-danger archive-bill-btn')
                                .html('<i class="fas fa-archive"></i>')
                                .attr('data-bill-pk', bill.bill_pk)
                                .attr('title', 'Archive');
                            row.append($('<td>').append(archiveBtn));
                        }
                        
                        // Check if bill has valid allocations (for Direct mode button validation)
                        if (modalType === 'direct' && bill.allocations && Array.isArray(bill.allocations) && bill.allocations.length > 0) {
                            // Check if all allocations have xero_account_pk
                            var allHaveAccounts = bill.allocations.every(function(alloc) {
                                return alloc.xero_account_pk !== null && alloc.xero_account_pk !== undefined;
                            });
                            
                            // Calculate total allocated amounts
                            var totalAllocatedNet = bill.allocations.reduce(function(sum, alloc) {
                                return sum + (alloc.amount || 0);
                            }, 0);
                            var totalAllocatedGst = bill.allocations.reduce(function(sum, alloc) {
                                return sum + (alloc.gst_amount || 0);
                            }, 0);
                            
                            // Check if allocations match bill totals (within 0.01)
                            var netMatches = Math.abs((bill.total_net || 0) - totalAllocatedNet) < 0.01;
                            var gstMatches = Math.abs((bill.total_gst || 0) - totalAllocatedGst) < 0.01;
                            
                            // Set data attribute based on validation
                            if (allHaveAccounts && netMatches && gstMatches) {
                                row.attr('data-allocations-valid', 'true');
                            } else {
                                row.attr('data-allocations-valid', 'false');
                            }
                        } else if (modalType === 'direct') {
                            // No allocations or empty allocations
                            row.attr('data-allocations-valid', 'false');
                        }
                        
                        // Add row to table
                        $('#billsTableBody').append(row);
                        
                        // Validate button state for this bill
                        validateAndUpdateSendButton(bill.bill_pk);
                } catch (error) {
                    console.error('Error rendering bill row:', bill.bill_pk, error);
                }
            });
            
            // Auto-select first row after table is populated
            setTimeout(function() {
                var firstRow = $('#billsTableBody tr:first');
                if (firstRow.length > 0 && firstRow.attr('data-bill-pk')) {
                    firstRow.trigger('click');
                }
            }, 100);
        }
        
        // Handle main Bills navbar link click - shows Bills section with Inbox selected by default
        $('#billsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Hide all sections using universal function
            if (typeof window.hideAllSections === 'function') {
                window.hideAllSections();
            }
            
            // Show Bills section and add has-content class to hide background
            $('#billsInboxSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Load Inbox by default
            loadBillsInbox();
            
            // Update button states - Inbox active (reset all first)
            resetAllBillsNavButtons();
            $('#billsInboxBtn').removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Scroll to top to show the bills section
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Helper function to reset ALL bills navigation buttons across BOTH sections
        function resetAllBillsNavButtons() {
            // Reset main section buttons
            $('#billsInboxBtn').removeClass('btn-primary').addClass('btn-outline-primary');
            $('#billsDirectBtn').removeClass('btn-primary').addClass('btn-outline-primary');
            $('#billsApprovalsBtn').removeClass('btn-primary').addClass('btn-outline-primary');
            // Reset approvals section buttons
            $('.approvals-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
        }
        
        // Handle Inbox button click
        $('#billsInboxBtn').click(function(e) {
            e.preventDefault();
            
            // Reset ALL buttons, then activate this one
            resetAllBillsNavButtons();
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Load Bills - Inbox
            loadBillsInbox();
        });
        
        // Handle Direct button click
        $('#billsDirectBtn').click(function(e) {
            e.preventDefault();
            
            // Reset ALL buttons, then activate this one
            resetAllBillsNavButtons();
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Fetch bills data and populate workspace
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Populate table with Direct bills: status=0, xero_instance non-null, project null
                    populateBillsTable(response, function(bill) {
                        return bill.bill_status === 0 && 
                               bill.xero_instance_id !== null && 
                               bill.project_pk === null;
                    }, 'direct');
                    
                    // Show allocations section for Direct and adjust bills table to 67% height
                    $('#allocationsSection').css('display', 'flex');
                    $('#billsTableContainer').css('flex', '0 0 67%');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        });
        
        // Handle Approvals button click
        $('#billsApprovalsBtn').click(function(e) {
            e.preventDefault();
            
            // Prevent double-clicks during loading
            if (window.approvalsLoading) {
                return;
            }
            
            // Reset ALL buttons, then activate this one AND the matching one in approvals section
            resetAllBillsNavButtons();
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            $('.approvals-nav-btn[data-mode="approvals"]').removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide main bills section, show approvals section
            $('#billsInboxSection').find('> div:not(:first-child)').hide();
            $('#billsInboxSection').hide();
            $('#billsApprovalsSection').css('display', 'flex').show();
            
            // Load approvals template if not already loaded
            if ($('#approvalsContent').children().length === 0) {
                window.approvalsLoading = true;
                // Show loading indicator
                $('#approvalsContent').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading approvals...</div>');
                
                $.ajax({
                    url: '{% url "core:bills" %}?template=approvals',
                    type: 'GET',
                    success: function(html) {
                        $('#approvalsContent').html(html);
                        // Load approved bills data
                        loadApprovedBills();
                        window.approvalsLoading = false;
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load approvals template:', error);
                        $('#approvalsContent').html('<p class="text-danger text-center p-4">Failed to load approvals section</p>');
                        window.approvalsLoading = false;
                    }
                });
            } else {
                // Reload data
                loadApprovedBills();
            }
        });
        
        // Handle navigation buttons in Approvals section
        $(document).on('click', '.approvals-nav-btn', function(e) {
            e.preventDefault();
            var mode = $(this).data('mode');
            
            if (mode === 'inbox') {
                // Switch back to Inbox - hide approvals, show main, trigger inbox button
                $('#billsApprovalsSection').hide();
                $('#billsInboxSection').css('display', 'flex').show();
                $('#billsInboxSection').find('> div:not(:first-child)').show();
                $('#billsInboxBtn').click();  // This will call resetAllBillsNavButtons()
            } else if (mode === 'direct') {
                // Switch to Direct - hide approvals, show main, trigger direct button
                $('#billsApprovalsSection').hide();
                $('#billsInboxSection').css('display', 'flex').show();
                $('#billsInboxSection').find('> div:not(:first-child)').show();
                $('#billsDirectBtn').click();  // This will call resetAllBillsNavButtons()
            } else if (mode === 'approvals') {
                // Already on approvals - just ensure correct button state
                resetAllBillsNavButtons();
                $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                $('#billsApprovalsBtn').removeClass('btn-outline-primary').addClass('btn-primary');
            }
        });
        
        // Function to load approved bills
        function loadApprovedBills() {
            $.ajax({
                url: '{% url "core:get_approved_bills" %}',
                type: 'GET',
                success: function(response) {
                    window.approvedBillsData = response.bills;
                    populateApprovalsTable(response.bills);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load approved bills:', error);
                    $('#approvalsMainTableBody').html('<tr><td colspan="8" class="text-center text-danger">Failed to load bills</td></tr>');
                }
            });
        }
        
        // Function to populate the approvals table
        function populateApprovalsTable(bills) {
            var tbody = $('#approvalsMainTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (!bills || bills.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                return;
            }
            
            bills.forEach(function(bill) {
                var row = $('<tr>')
                    .attr('data-bill-pk', bill.bill_pk)
                    .attr('data-pdf-url', bill.pdf_url || '');
                
                // 1. Project
                var projectName = bill.project_name || '-';
                row.append($('<td>').append(
                    $('<div>').addClass('truncate-2-lines').attr('title', projectName).text(projectName)
                ));
                
                // 2. Xero Instance
                var xeroInstanceName = bill.xero_instance_name || '-';
                row.append($('<td>').append(
                    $('<div>').addClass('truncate-2-lines').attr('title', xeroInstanceName).text(xeroInstanceName)
                ));
                
                // 3. Xero Account
                row.append($('<td>').text(bill.xero_account_name || '-'));
                
                // 4. Supplier
                var supplierName = bill.supplier_name || '-';
                row.append($('<td>').append(
                    $('<div>').addClass('truncate-2-lines').attr('title', supplierName).text(supplierName)
                ));
                
                // 5. $ Gross
                row.append($('<td>').css('text-align', 'right').text('$' + Utils.formatMoney(bill.total_gross)));
                
                // 6. $ Net
                row.append($('<td>').css('text-align', 'right').text('$' + Utils.formatMoney(bill.total_net)));
                
                // 7. $ GST
                row.append($('<td>').css('text-align', 'right').text('$' + Utils.formatMoney(bill.total_gst)));
                
                // 8. Send to Xero button
                var sendBtn = $('<button>')
                    .addClass('btn btn-sm btn-success approvals-send-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Send')
                    .on('click', function(e) {
                        e.stopPropagation();
                        sendApprovedBillToXero(bill.bill_pk, $(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(sendBtn));
                
                // 9. Return to Project button
                var returnBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning approvals-return-btn')
                    .attr('data-bill-pk', bill.bill_pk)
                    .text('Return')
                    .on('click', function(e) {
                        e.stopPropagation();
                        returnBillToProject(bill.bill_pk, $(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(returnBtn));
                
                tbody.append(row);
            });
            
            // Auto-select first row
            setTimeout(function() {
                var firstRow = tbody.find('tr').first();
                if (firstRow.length && firstRow.attr('data-bill-pk')) {
                    selectApprovalsRow(firstRow);
                }
            }, 100);
        }
        
        // Function to select an approvals row
        function selectApprovalsRow(row) {
            var tbody = $('#approvalsMainTableBody');
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            tbody.addClass('has-selection');
            
            var billPk = row.attr('data-bill-pk');
            var pdfUrl = row.attr('data-pdf-url');
            
            // Show PDF in viewer
            if (pdfUrl) {
                $('#approvalsPdfViewer').attr('src', pdfUrl).show();
                $('#approvalsViewerPlaceholder').hide();
            } else {
                $('#approvalsPdfViewer').hide();
                $('#approvalsViewerPlaceholder').show();
            }
            
            // Populate allocations table
            var bill = window.approvedBillsData.find(function(inv) {
                return inv.bill_pk === parseInt(billPk);
            });
            
            if (bill && bill.allocations) {
                populateApprovalsAllocations(bill.allocations);
            }
        }
        
        // Function to populate approvals allocations
        function populateApprovalsAllocations(allocations) {
            var tbody = $('#approvalsAllocationsTableBody');
            tbody.empty();
            
            var totalNet = 0;
            var totalGst = 0;
            
            allocations.forEach(function(allocation) {
                var row = $('<tr>');
                row.append($('<td>').text(allocation.costing_name || '-'));
                row.append($('<td>').css('text-align', 'right').text('$' + Utils.formatMoney(allocation.amount)));
                row.append($('<td>').css('text-align', 'right').text('$' + Utils.formatMoney(allocation.gst_amount)));
                row.append($('<td>').text(allocation.notes || ''));
                tbody.append(row);
                
                totalNet += allocation.amount || 0;
                totalGst += allocation.gst_amount || 0;
            });
            
            // Update totals
            $('#approvalsTotalNet').text('$' + Utils.formatMoney(totalNet));
            $('#approvalsTotalGst').text('$' + Utils.formatMoney(totalGst));
        }
        
        // Row click handler for approvals table
        $(document).on('click', '#approvalsMainTableBody tr', function() {
            selectApprovalsRow($(this));
        });
        
        // Function to send approved bill to Xero (placeholder)
        function sendApprovedBillToXero(billPk, btn) {
            btn.prop('disabled', true).text('Sending...');
            
            // TODO: Implement actual Xero send logic
            // For now, show a placeholder alert
            setTimeout(function() {
                alert('Send to Xero functionality will be implemented. Bill PK: ' + billPk);
                btn.prop('disabled', false).text('Send to Xero');
            }, 500);
        }
        
        // Function to return an bill back to project
        function returnBillToProject(billPk, btn) {
            btn.prop('disabled', true).text('Returning...');
            
            $.ajax({
                url: '/core/return_bill_to_project/' + billPk + '/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': Utils.getCSRFToken()
                },
                success: function(response) {
                    // Remove the row from the table
                    $('tr[data-bill-pk="' + billPk + '"]').fadeOut(300, function() {
                        $(this).remove();
                        // Check if table is now empty
                        if ($('#approvalsMainTableBody tr').length === 0) {
                            $('#approvalsMainTableBody').html('<tr><td colspan="9" class="text-center text-muted p-4">No approved bills waiting to be sent to Xero</td></tr>');
                        } else {
                            // Select first remaining row
                            var firstRow = $('#approvalsMainTableBody tr').first();
                            if (firstRow.attr('data-bill-pk')) {
                                selectApprovalsRow(firstRow);
                            }
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Failed to return bill:', error);
                    alert('Failed to return bill: ' + (xhr.responseJSON?.message || error));
                    btn.prop('disabled', false).text('Return to Project');
                }
            });
        }
        
        // Add click handler for email links
        $(document).on('click', '.email-link', function(e) {
            e.preventDefault();
            var emailHtml = $(this).attr('data-email-html');
            var emailText = $(this).attr('data-email-text');
            var emailSubject = $(this).attr('data-email-subject');
            var emailFrom = $(this).attr('data-email-from');
            
            // Update viewer title
            $('#viewerTitle').text('Email: ' + emailSubject);
            
            // Create HTML content with email header
            var emailContent = '<div style="padding: 20px; font-family: Arial, sans-serif;">';
            emailContent += '<div style="border-bottom: 2px solid #ddd; margin-bottom: 20px; padding-bottom: 10px;">';
            emailContent += '<p style="margin: 5px 0;"><strong>From:</strong> ' + emailFrom + '</p>';
            emailContent += '<p style="margin: 5px 0;"><strong>Subject:</strong> ' + emailSubject + '</p>';
            emailContent += '</div>';
            
            // Add email body (HTML or text)
            if (emailHtml) {
                emailContent += emailHtml;
            } else if (emailText) {
                emailContent += '<pre style="white-space: pre-wrap; font-family: Arial, sans-serif;">' + emailText + '</pre>';
            } else {
                emailContent += '<p><em>No email content available</em></p>';
            }
            emailContent += '</div>';
            
            // Create a blob URL for the HTML content
            var blob = new Blob([emailContent], { type: 'text/html' });
            var blobUrl = URL.createObjectURL(blob);
            
            // Load HTML in iframe
            $('#billViewer').attr('src', blobUrl).show();
            $('#viewerPlaceholder').hide();
        });
        
        // Note: PDF loading is now handled by the main row click handler
        // to prevent duplicate loads and ensure proper selection tracking
        
        // Add change handler for Xero Instance / Project dropdown
        $(document).on('change', '.xero-project-select', function() {
            var selectedValue = $(this).val();
            var row = $(this).closest('tr');
            var supplierSelect = row.find('.supplier-select');
            var selectedSupplier = supplierSelect.val(); // Remember current selection
            
            // Determine the xero_instance_id
            var xeroInstanceId = null;
            if (selectedValue.startsWith('xero_')) {
                xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
            } else if (selectedValue.startsWith('project_')) {
                var projectPk = parseInt(selectedValue.replace('project_', ''));
                var project = window.billsData.projects.find(p => p.projects_pk === projectPk);
                if (project) {
                    xeroInstanceId = project.xero_instance_id;
                }
            }
            
            // Update bill in database and handle allocations
            var billPk = row.attr('data-bill-pk');
            
            // Determine if this is a Xero Instance or Project selection
            var updateData = { bill_pk: billPk };
            if (selectedValue.startsWith('xero_')) {
                updateData.xero_instance_id = xeroInstanceId;
                updateData.project_pk = null;
            } else if (selectedValue.startsWith('project_')) {
                var projectPk = parseInt(selectedValue.replace('project_', ''));
                updateData.project_pk = projectPk;
                updateData.xero_instance_id = null;
            }
            
            // Update bill in database
            $.ajax({
                url: '/core/update_bill/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(updateData),
                success: function(response) {
                },
                error: function(xhr, status, error) {
                    console.error('Error updating bill:', error);
                }
            });
            
            // If Xero Instance changed, null out allocation Xero fields
            if (selectedValue.startsWith('xero_')) {
                $.ajax({
                    url: '/core/null_allocation_xero_fields/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ bill_pk: billPk }),
                    success: function(response) {
                        // If this is the selected row, clear dropdowns in UI
                        if (currentSelectedBillPk === billPk) {
                            $('#allocationsTableBody tr').each(function() {
                                $(this).find('.xero-account-select').val('');
                                $(this).removeAttr('data-xero-account-pk');
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error nulling allocation Xero fields:', error);
                    }
                });
            }
            
            // Update currentBillData with new xero_instance_pk if this is the selected row
            if (currentSelectedBillPk === billPk && currentBillData) {
                currentBillData.xero_instance_pk = xeroInstanceId;
                // Repopulate allocation dropdowns with new instance data
                populateAllAllocationDropdowns();
            }
            
            // Rebuild supplier dropdown
            supplierSelect.empty();
            
            if (xeroInstanceId) {
                // Enable and populate suppliers
                supplierSelect.prop('disabled', false);
                
                // Add "Select Supplier..." option
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                
                // Add separator
                supplierSelect.append($('<option>').val('separator1').text('─────────').prop('disabled', true));
                
                // Add "Add..." option
                supplierSelect.append($('<option>').val('add_supplier').text('Add...'));
                
                // Add separator
                supplierSelect.append($('<option>').val('separator2').text('─────────').prop('disabled', true));
                
                window.billsData.suppliers.forEach(function(supplier) {
                    if (supplier.xero_instance_id === xeroInstanceId) {
                        var option = $('<option>')
                            .val(supplier.contact_pk)
                            .text(supplier.name)
                            .attr('data-xero-instance', supplier.xero_instance_id);
                        supplierSelect.append(option);
                    }
                });
                
                // Restore selection if still valid
                if (selectedSupplier && supplierSelect.find('option[value="' + selectedSupplier + '"]').length > 0) {
                    supplierSelect.val(selectedSupplier);
                }
            } else {
                // Disable and show placeholder
                supplierSelect.append($('<option>').val('').text('Select Xero Instance first...'));
                supplierSelect.prop('disabled', true);
            }
            
            // Update button state
            validateAndUpdateSendButton(billPk);
        });
        
        // Handle supplier dropdown change - open Add Supplier modal if selected
        $(document).on('change', '.supplier-select', function() {
            var selectedValue = $(this).val();
            var row = $(this).closest('tr');
            
            if (selectedValue === 'add_supplier') {
                // Get the Xero Instance ID from the combined dropdown
                var combinedSelect = row.find('.xero-project-select');
                var combinedValue = combinedSelect.val();
                var xeroInstanceId = null;
                
                if (combinedValue.startsWith('xero_')) {
                    xeroInstanceId = parseInt(combinedValue.replace('xero_', ''));
                } else if (combinedValue.startsWith('project_')) {
                    var projectPk = parseInt(combinedValue.replace('project_', ''));
                    var project = window.billsData.projects.find(p => p.projects_pk === projectPk);
                    if (project) {
                        xeroInstanceId = project.xero_instance_id;
                    }
                }
                
                if (xeroInstanceId) {
                    // Reset dropdown to empty
                    $(this).val('');
                    
                    // Open Add Supplier modal
                    window.openAddSupplierModal(xeroInstanceId, row);
                }
            }
        });
        
        // Add click handler for send buttons
        $(document).on('click', '.send-bill-btn', function(e) {
            e.preventDefault();
            
            var button = $(this);
            var row = button.closest('tr');
            var billPk = button.attr('data-bill-pk');
            
            // Get values from row
            var xeroInstanceOrProject = row.find('.xero-project-select').val();
            var supplierPk = row.find('.supplier-select').val();
            var billNumber = row.find('.bill-number-input').val();
            var netValue = row.find('.net-input').val();
            var gstValue = row.find('.gst-input').val();
            var totalNet = parseFloat(netValue);
            var totalGst = parseFloat(gstValue);
            
            // Validate all required fields
            var errors = [];
            if (!xeroInstanceOrProject) {
                errors.push('Please select a Xero Instance or Project');
            }
            if (!supplierPk || supplierPk === 'add_supplier') {
                errors.push('Please select a Supplier');
            }
            if (!billNumber || billNumber.trim() === '') {
                errors.push('Please enter an Bill Number');
            }
            if (!totalNet || isNaN(totalNet) || totalNet === 0) {
                errors.push('Please enter a non-zero Net amount');
            }
            // GST can be 0, but field cannot be empty
            if (gstValue === null || gstValue === undefined || gstValue === '' || isNaN(totalGst)) {
                errors.push('Please enter a GST amount (can be 0)');
            }
            
            // Check if we're in Bills - Direct modal using stored modal type
            var isDirectModal = (currentBillsModalType === 'direct');
            
            if (isDirectModal) {
                // Additional validation for Bills - Direct
                
                // Check if this is the currently selected bill
                if (currentSelectedBillPk !== billPk) {
                    errors.push('Please select this bill row to view and complete allocations');
                } else {
                    // Validate allocations
                    var hasAllocations = $('#allocationsTableBody tr').length > 0;
                    if (!hasAllocations) {
                        errors.push('No allocations found. Please add at least one allocation');
                    } else {
                        // Check that all allocations have Xero Account selected
                        var missingAccount = false;
                        $('#allocationsTableBody tr').each(function() {
                            var accountVal = $(this).find('.xero-account-select').val();
                            if (!accountVal) {
                                missingAccount = true;
                            }
                        });
                        
                        if (missingAccount) {
                            errors.push('All allocations must have a Xero Account selected');
                        }
                        
                        // Check remaining allocations are exactly 0.00
                        var remainingNetText = $('#remainingNet').text().replace('$', '');
                        var remainingGstText = $('#remainingGst').text().replace('$', '');
                        var remainingNet = parseFloat(remainingNetText);
                        var remainingGst = parseFloat(remainingGstText);
                        
                        if (Math.abs(remainingNet) >= 0.01) {
                            errors.push('Still to allocate Net must be exactly $0.00 (currently: $' + Utils.formatMoney(remainingNet) + ')');
                        }
                        if (Math.abs(remainingGst) >= 0.01) {
                            errors.push('Still to allocate GST must be exactly $0.00 (currently: $' + Utils.formatMoney(remainingGst) + ')');
                        }
                    }
                }
            }
            
            if (errors.length > 0) {
                alert('Please fix the following errors:\n\n' + errors.join('\n'));
                return;
            }
            
            // Store original button text for restoration on error
            var originalBtnText = button.text();
            
            // Disable button and show processing state
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
            
            // Send AJAX request
            fetch('/core/send_bill/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': Utils.getCSRFToken()
                },
                body: JSON.stringify({
                    bill_pk: billPk,
                    xero_instance_or_project: xeroInstanceOrProject,
                    supplier_pk: supplierPk,
                    bill_number: billNumber,
                    total_net: totalNet,
                    total_gst: totalGst
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Check if this was the currently selected row
                    var wasSelected = (currentSelectedBillPk === billPk);
                    
                    // Remove row from table with fade effect
                    row.fadeOut(400, function() {
                        $(this).remove();
                        
                        // Check if table is empty
                        if ($('#billsTableBody tr').length === 0) {
                            $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                        }
                    });
                    
                    // If this was the selected row, clear RHS allocations and PDF viewer
                    if (wasSelected) {
                        // Clear allocations table
                        $('#allocationsTableBody').empty();
                        
                        // Reset "still to allocate" values
                        $('#remainingNet').text('$0.00').css('color', 'green');
                        $('#remainingGst').text('$0.00').css('color', 'green');
                        
                        // Clear PDF viewer
                        $('#billViewer').attr('src', '').hide();
                        $('#viewerPlaceholder').show();
                        $('#viewerTitle').text('');
                        
                        // Clear current selection
                        currentSelectedBillPk = null;
                        currentBillData = null;
                    }
                } else {
                    // Re-enable button on error
                    button.prop('disabled', false).html(originalBtnText);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error sending bill:', error);
                button.prop('disabled', false).html(originalBtnText);
                alert('Failed to send bill. Please try again.');
            });
        });
        
        // Add click handler for archive buttons
        $(document).on('click', '.archive-bill-btn', function(e) {
            e.preventDefault();
            var billPk = $(this).attr('data-bill-pk');
            var row = $(this).closest('tr');
            
            if (confirm('Are you sure you want to archive this Bill?')) {
                // Send AJAX request to archive the bill
                $.ajax({
                    url: '{% url "core:archive_bill" %}',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': Utils.getCSRFToken()
                    },
                    data: JSON.stringify({
                        bill_pk: billPk
                    }),
                    contentType: 'application/json',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Check if this was the currently selected row
                            var wasSelected = (currentSelectedBillPk === billPk);
                            
                            // Remove row from table with fade effect
                            row.fadeOut(300, function() {
                                $(this).remove();
                            });
                            
                            // If this was the selected row, clear RHS allocations and PDF viewer
                            if (wasSelected) {
                                // Clear allocations table
                                $('#allocationsTableBody').empty();
                                
                                // Reset "still to allocate" values
                                $('#remainingNet').text('$0.00').css('color', 'green');
                                $('#remainingGst').text('$0.00').css('color', 'green');
                                
                                // Clear PDF viewer
                                $('#billViewer').attr('src', '').hide();
                                $('#viewerPlaceholder').show();
                                $('#viewerTitle').text('');
                                
                                // Clear current selection
                                currentSelectedBillPk = null;
                                currentBillData = null;
                            }
                        } else {
                            alert('Failed to archive bill: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Archive error:', error);
                        alert('Failed to archive bill. Please try again.');
                    }
                });
            }
        });
        
        // Add click handler for return to inbox buttons
        $(document).on('click', '.return-to-inbox-btn', function(e) {
            e.preventDefault();
            var billPk = $(this).attr('data-bill-pk');
            var row = $(this).closest('tr');
            
            if (confirm('Are you sure you want to return this bill to the inbox?')) {
                // Send AJAX request to return to inbox
                $.ajax({
                    url: '{% url "core:return_to_inbox" %}',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        bill_pk: billPk
                    }),
                    headers: {
                        'X-CSRFToken': Utils.getCSRFToken()
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            // Check if this was the currently selected row
                            var wasSelected = (currentSelectedBillPk === billPk);
                            
                            // Update the bill in the global bills data
                            if (window.billsData && window.billsData.bills) {
                                var bill = window.billsData.bills.find(b => b.bill_pk === parseInt(billPk));
                                if (bill) {
                                    bill.bill_status = -2;
                                    bill.xero_instance_id = null;
                                    bill.project_pk = null;
                                    bill.total_net = null;
                                    bill.total_gst = null;
                                    bill.supplier_bill_number = null;
                                    bill.contact_pk = null;
                                }
                            }
                            
                            // Remove row from table with fade effect
                            row.fadeOut(400, function() {
                                $(this).remove();
                                
                                // Check if table is empty
                                if ($('#billsTableBody tr').length === 0) {
                                    $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                                }
                            });
                            
                            // If this was the selected row, clear RHS allocations and PDF viewer
                            if (wasSelected) {
                                // Clear allocations table
                                $('#allocationsTableBody').empty();
                                
                                // Reset "still to allocate" values
                                $('#remainingNet').text('$0.00').css('color', 'green');
                                $('#remainingGst').text('$0.00').css('color', 'green');
                                
                                // Clear PDF viewer
                                $('#billViewer').attr('src', '').hide();
                                $('#viewerPlaceholder').show();
                                $('#viewerTitle').text('');
                                
                                // Clear current selection
                                currentSelectedBillPk = null;
                                currentBillData = null;
                            }
                        } else {
                            alert('Failed to return bill to inbox: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Return to inbox error:', error);
                        alert('Failed to return bill to inbox. Please try again.');
                    }
                });
            }
        });
        
        // Global variable to store current bill data for allocations
        var currentBillData = null;
        var currentSelectedBillPk = null;
                    
                    // Function to create an allocation row
                    function createAllocationRow(netAmount, gstAmount, allocationPk, xeroAccountPk, notes) {
                        var row = $('<tr>');
                        
                        // Store allocation_pk as data attribute
                        if (allocationPk) {
                            row.attr('data-allocation-pk', allocationPk);
                        }
                        
                        // 1. Xero Account dropdown
                        var accountSelect = $('<select>')
                            .addClass('form-control form-control-sm xero-account-select')
                            .attr('data-instance-pk', '');
                        accountSelect.append($('<option>').val('').text('Select Account...'));
                        row.append($('<td>').append(accountSelect));
                        
                        // 2. $ Net input (with 2dp validation, no negatives)
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .attr('min', '0')
                            .addClass('form-control form-control-sm allocation-net-input')
                            .val(netAmount || '')
                            .on('input', function() {
                                var value = $(this).val();
                                // Prevent negative numbers
                                if (parseFloat(value) < 0) {
                                    $(this).val(0);
                                    return;
                                }
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                                // Auto-calculate GST as 10% of NET
                                var netValue = parseFloat($(this).val());
                                if (!isNaN(netValue)) {
                                    var gstValue = (netValue * 0.1).toFixed(2);
                                    $(this).closest('tr').find('.allocation-gst-input').val(gstValue);
                                    // Update remaining allocations since GST changed
                                    updateRemainingAllocations();
                                }
                            });
                        row.append($('<td>').append(netInput));
                        
                        // 4. $ GST input (with 2dp validation, no negatives)
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .attr('min', '0')
                            .addClass('form-control form-control-sm allocation-gst-input')
                            .val(gstAmount || '')
                            .on('input', function() {
                                var value = $(this).val();
                                // Prevent negative numbers
                                if (parseFloat(value) < 0) {
                                    $(this).val(0);
                                    return;
                                }
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                            });
                        row.append($('<td>').append(gstInput));
                        
                        // 5. Notes input (text)
                        var notesInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm allocation-notes-input')
                            .attr('placeholder', 'Description...')
                            .val(notes || '');
                        row.append($('<td>').append(notesInput));
                        
                        // 6. Delete button
                        var deleteBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger delete-allocation-btn')
                            .html('<i class="fas fa-times"></i>')
                            .attr('title', 'Delete allocation');
                        row.append($('<td>').css('text-align', 'center').append(deleteBtn));
                        
                        // Store xero_account_pk for later selection
                        if (xeroAccountPk) {
                            row.attr('data-xero-account-pk', xeroAccountPk);
                        }
                        
                        return row;
                    }
                    
                    // Function to populate Xero Account dropdown for a specific row
                    function populateXeroAccounts(row, instancePk) {
                        var accountSelect = row.find('.xero-account-select');
                        accountSelect.attr('data-instance-pk', instancePk);
                        
                        // Clear existing options except the first one
                        accountSelect.find('option:not(:first)').remove();
                        
                        if (!instancePk) {
                            return;
                        }
                        
                        // Get the stored xero_account_pk if it exists
                        var storedAccountPk = row.attr('data-xero-account-pk');
                        
                        // Fetch accounts from backend
                        $.ajax({
                            url: '/core/get_xero_accounts/' + instancePk + '/',
                            type: 'GET',
                            success: function(response) {
                                if (response.status === 'success' && response.accounts) {
                                    response.accounts.forEach(function(account) {
                                        accountSelect.append($('<option>')
                                            .val(account.xero_account_pk)
                                            .text(account.account_code + ' - ' + account.account_name)
                                            .attr('data-account-type', account.account_type));
                                    });
                                    
                                    // Set stored value if it exists
                                    if (storedAccountPk) {
                                        accountSelect.val(storedAccountPk);
                                    }
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error fetching Xero accounts:', error);
                            }
                        });
                    }
                    
                    // Function to populate all allocation rows with current instance data
                    function populateAllAllocationDropdowns() {
                        if (!currentBillData || !currentBillData.xero_instance_pk) {
                            return;
                        }
                        
                        var instancePk = currentBillData.xero_instance_pk;
                        
                        // Populate all rows in the allocations table
                        $('#allocationsTableBody tr').each(function() {
                            populateXeroAccounts($(this), instancePk);
                        });
                    }
                    
                    // Function to calculate and update remaining allocation amounts
                    function updateRemainingAllocations() {
                        if (!currentBillData) {
                            $('#remainingNet').text('$0.00');
                            $('#remainingGst').text('$0.00');
                            return;
                        }
                        
                        var billNet = parseFloat(currentBillData.total_net) || 0;
                        var billGst = parseFloat(currentBillData.total_gst) || 0;
                        
                        var allocatedNet = 0;
                        var allocatedGst = 0;
                        
                        // Sum up all allocation amounts
                        $('#allocationsTableBody tr').each(function() {
                            var netVal = parseFloat($(this).find('.allocation-net-input').val()) || 0;
                            var gstVal = parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                            allocatedNet += netVal;
                            allocatedGst += gstVal;
                        });
                        
                        var remainingNet = billNet - allocatedNet;
                        var remainingGst = billGst - allocatedGst;
                        
                        // Update display with color coding
                        $('#remainingNet').text('$' + Utils.formatMoney(remainingNet));
                        $('#remainingGst').text('$' + Utils.formatMoney(remainingGst));
                        
                        // Color code: green if zero, blue if positive, red if negative
                        if (Math.abs(remainingNet) < 0.01) {
                            $('#remainingNet').css('color', 'green');
                        } else if (remainingNet > 0) {
                            $('#remainingNet').css('color', 'blue');
                        } else {
                            $('#remainingNet').css('color', 'red');
                        }
                        
                        if (Math.abs(remainingGst) < 0.01) {
                            $('#remainingGst').css('color', 'green');
                        } else if (remainingGst > 0) {
                            $('#remainingGst').css('color', 'blue');
                        } else {
                            $('#remainingGst').css('color', 'red');
                        }
                        
                        // Update Send to Xero button state
                        if (currentSelectedBillPk) {
                            validateAndUpdateSendButton(currentSelectedBillPk);
                            
                            // Mark row as having valid allocations if all checks pass
                            var row = $('tr[data-bill-pk="' + currentSelectedBillPk + '"]');
                            var remainingNetVal = parseFloat($('#remainingNet').text().replace('$', ''));
                            var remainingGstVal = parseFloat($('#remainingGst').text().replace('$', ''));
                            var hasAllocations = $('#allocationsTableBody tr').length > 0;
                            var allAccountsSelected = true;
                            $('#allocationsTableBody tr').each(function() {
                                if (!$(this).find('.xero-account-select').val()) {
                                    allAccountsSelected = false;
                                }
                            });
                            
                            if (hasAllocations && allAccountsSelected && 
                                Math.abs(remainingNetVal) < 0.01 && Math.abs(remainingGstVal) < 0.01) {
                                row.attr('data-allocations-valid', 'true');
                            } else {
                                row.attr('data-allocations-valid', 'false');
                            }
                        }
                    }
                    
                    // Function to validate and update Send to Xero button state
                    function validateAndUpdateSendButton(billPk) {
                        var button = $('button[data-bill-pk="' + billPk + '"].send-bill-btn');
                        if (button.length === 0) return;
                        
                        var row = button.closest('tr');
                        var isValid = true;
                        
                        // LHS table validations
                        var xeroInstanceOrProject = row.find('.xero-project-select').val();
                        var supplierPk = row.find('.supplier-select').val();
                        var billNumber = row.find('.bill-number-input').val();
                        var netValue = row.find('.net-input').val();
                        var gstValue = row.find('.gst-input').val();
                        var totalNet = parseFloat(netValue);
                        var totalGst = parseFloat(gstValue);
                        
                        if (!xeroInstanceOrProject) isValid = false;
                        if (!supplierPk || supplierPk === 'add_supplier') isValid = false;
                        if (!billNumber || billNumber.trim() === '') isValid = false;
                        if (!totalNet || isNaN(totalNet) || totalNet === 0) isValid = false;
                        // GST can be 0, but field cannot be empty
                        if (gstValue === null || gstValue === undefined || gstValue === '' || isNaN(totalGst)) isValid = false;
                        
                        // Check if we're in Bills - Direct modal using stored modal type
                        var isDirectModal = (currentBillsModalType === 'direct');
                        
                        if (isDirectModal) {
                            // In Direct mode, check if bill is selected OR has valid allocations saved
                            if (currentSelectedBillPk !== billPk) {
                                // Bill not currently selected - check if it has valid allocations from before
                                var hasValidAllocations = row.attr('data-allocations-valid') === 'true';
                                if (!hasValidAllocations) {
                                    isValid = false;
                                }
                                // If hasValidAllocations is true, isValid stays true (from LHS validation)
                            } else {
                                // Bill is selected - validate allocations
                                var hasAllocations = $('#allocationsTableBody tr').length > 0;
                                if (!hasAllocations) {
                                    isValid = false;
                                } else {
                                    // Check that all allocations have Xero Account selected
                                    $('#allocationsTableBody tr').each(function() {
                                        var accountVal = $(this).find('.xero-account-select').val();
                                        if (!accountVal) {
                                            isValid = false;
                                        }
                                    });
                                    
                                    // Check remaining allocations are exactly 0.00
                                    var remainingNetText = $('#remainingNet').text().replace('$', '');
                                    var remainingGstText = $('#remainingGst').text().replace('$', '');
                                    var remainingNet = parseFloat(remainingNetText);
                                    var remainingGst = parseFloat(remainingGstText);
                                    
                                    if (Math.abs(remainingNet) >= 0.01) isValid = false;
                                    if (Math.abs(remainingGst) >= 0.01) isValid = false;
                                }
                            }
                        }
                        
                        // Update button state
                        if (isValid) {
                            button.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
                        } else {
                            button.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
                        }
                    }
                    
                    // Function to update an allocation in the database
                    function updateAllocation(row, field, value) {
                        var allocationPk = row.attr('data-allocation-pk');
                        if (!allocationPk) {
                            console.warn('No allocation_pk found for row');
                            return;
                        }
                        
                        var data = {
                            allocation_pk: allocationPk
                        };
                        data[field] = value;
                        
                        $.ajax({
                            url: '/core/update_bill_allocation/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(data),
                            success: function(response) {
                            },
                            error: function(xhr, status, error) {
                                console.error('Error updating allocation:', error);
                            }
                        });
                    }
                    
                    // Add event handlers for allocation field changes
                    $(document).on('change', '.xero-account-select', function() {
                        var row = $(this).closest('tr');
                        var value = $(this).val();
                        updateAllocation(row, 'xero_account_pk', value);
                        
                        // Update button state
                        if (currentSelectedBillPk) {
                            validateAndUpdateSendButton(currentSelectedBillPk);
                        }
                    });
                    
                    $(document).on('change', '.allocation-net-input', function() {
                        var row = $(this).closest('tr');
                        var value = $(this).val();
                        updateAllocation(row, 'amount', value);
                        updateRemainingAllocations();
                    });
                    
                    $(document).on('change', '.allocation-gst-input', function() {
                        var row = $(this).closest('tr');
                        var value = $(this).val();
                        updateAllocation(row, 'gst_amount', value);
                        updateRemainingAllocations();
                    });
                    
                    // Also update on input (real-time) for better UX
                    $(document).on('input', '.allocation-net-input, .allocation-gst-input', function() {
                        updateRemainingAllocations();
                    });
                    
                    // Prevent scroll from changing number input values by blurring on scroll
                    $(document).on('wheel', '.allocation-net-input, .allocation-gst-input', function(e) {
                        $(this).blur();
                    });
                    
                    // Also prevent mousewheel event as fallback
                    $(document).on('mousewheel', '.allocation-net-input, .allocation-gst-input', function(e) {
                        $(this).blur();
                    });
                    
                    $(document).on('change', '.allocation-notes-input', function() {
                        var row = $(this).closest('tr');
                        var value = $(this).val();
                        updateAllocation(row, 'notes', value);
                    });
                    
                    // Add change handlers for LHS table fields to update bill
                    $(document).on('change', '.supplier-select', function() {
                        var row = $(this).closest('tr');
                        var billPk = row.attr('data-bill-pk');
                        var supplierPk = $(this).val();
                        
                        if (supplierPk && supplierPk !== 'add_supplier') {
                            $.ajax({
                                url: '/core/update_bill/',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    bill_pk: billPk,
                                    contact_pk: supplierPk
                                }),
                                success: function(response) {
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error updating bill supplier:', error);
                                }
                            });
                        }
                        
                        // Update button state
                        validateAndUpdateSendButton(billPk);
                    });
                    
                    $(document).on('change', '.bill-number-input', function() {
                        var row = $(this).closest('tr');
                        var billPk = row.attr('data-bill-pk');
                        var billNumber = $(this).val();
                        
                        $.ajax({
                            url: '/core/update_bill/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                bill_pk: billPk,
                                supplier_bill_number: billNumber
                            }),
                            success: function(response) {
                            },
                            error: function(xhr, status, error) {
                                console.error('Error updating bill number:', error);
                            }
                        });
                        
                        // Update button state
                        validateAndUpdateSendButton(billPk);
                    });
                    
                    $(document).on('change', '.net-input', function() {
                        var row = $(this).closest('tr');
                        var billPk = row.attr('data-bill-pk');
                        var netValue = $(this).val();
                        
                        $.ajax({
                            url: '/core/update_bill/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                bill_pk: billPk,
                                total_net: netValue
                            }),
                            success: function(response) {
                                // Update currentBillData if this is the selected row
                                if (currentSelectedBillPk === billPk && currentBillData) {
                                    currentBillData.total_net = parseFloat(netValue);
                                    updateRemainingAllocations();
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error updating bill net:', error);
                            }
                        });
                        
                        // Update button state
                        validateAndUpdateSendButton(billPk);
                    });
                    
                    $(document).on('change', '.gst-input', function() {
                        var row = $(this).closest('tr');
                        var billPk = row.attr('data-bill-pk');
                        var gstValue = $(this).val();
                        
                        $.ajax({
                            url: '/core/update_bill/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                bill_pk: billPk,
                                total_gst: gstValue
                            }),
                            success: function(response) {
                                // Update currentBillData if this is the selected row
                                if (currentSelectedBillPk === billPk && currentBillData) {
                                    currentBillData.total_gst = parseFloat(gstValue);
                                    updateRemainingAllocations();
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error updating bill gst:', error);
                            }
                        });
                        
                        // Update button state
                        validateAndUpdateSendButton(billPk);
                    });
                    
                    // Add click handler for delete allocation button
                    $(document).on('click', '.delete-allocation-btn', function(e) {
                        e.preventDefault();
                        
                        var row = $(this).closest('tr');
                        var allocationPk = row.attr('data-allocation-pk');
                        
                        if (!allocationPk) {
                            // Just remove the row if no allocation_pk (shouldn't happen)
                            row.remove();
                            updateRemainingAllocations();
                            return;
                        }
                        
                        if (confirm('Are you sure you want to delete this allocation?')) {
                            // Delete from database
                            $.ajax({
                                url: '/core/delete_bill_allocation/',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    allocation_pk: allocationPk
                                }),
                                success: function(response) {
                                    if (response.status === 'success') {
                                        // Remove row with fade effect
                                        row.fadeOut(300, function() {
                                            $(this).remove();
                                            updateRemainingAllocations();
                                        });
                                    } else {
                                        alert('Error deleting allocation: ' + response.message);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error deleting allocation:', error);
                                    alert('Failed to delete allocation. Please try again.');
                                }
                            });
                        }
                    });
                    
                    // Add click handler for LHS table rows to populate allocations
                    $(document).on('click', '#billsTableBody tr', function(e) {
                        // Only prevent if clicking buttons or email links (allow inputs/selects)
                        if ($(e.target).is('button, a, i')) {
                            return;
                        }
                        
                        // Also check if clicking inside a button (for icons inside buttons)
                        if ($(e.target).closest('button, a').length > 0) {
                            return;
                        }
                        
                        var billPk = $(this).attr('data-bill-pk');
                        var clickedRow = $(this);
                        
                        // Check if this is the same row that's already selected
                        var isSameRow = (currentSelectedBillPk === billPk);
                        
                        // Remove previous selection styling
                        $('#billsTableBody tr').removeClass('selected-bill-row');
                        
                        // Add selection styling to clicked row
                        clickedRow.addClass('selected-bill-row');
                        
                        // Add class to tbody to trigger dimming effect
                        $('#billsTableBody').addClass('has-selection');
                        
                        // Only load PDF if switching to a different row (prevent unnecessary reloads)
                        if (!isSameRow) {
                            var pdfUrl = clickedRow.attr('data-pdf-url');
                            var filename = clickedRow.attr('data-filename');
                            
                            if (pdfUrl) {
                                // Update viewer title
                                $('#viewerTitle').text(filename);
                                
                                // Load PDF in iframe
                                $('#billViewer').attr('src', pdfUrl).show();
                                $('#viewerPlaceholder').hide();
                            }
                            
                            // Update data when switching to a different row
                            // Update current selection
                            currentSelectedBillPk = billPk;
                            
                            // Find the bill in the bills data
                            if (window.billsData && window.billsData.bills) {
                                var bill = window.billsData.bills.find(b => b.bill_pk === parseInt(billPk));
                                if (bill) {
                                    currentBillData = bill;
                                    
                                    // Only populate allocations if we're in Bills - Direct modal
                                    var isDirectModal = $('#allocationsSection').is(':visible');
                                    
                                    if (isDirectModal) {
                                        // Clear and populate allocations table
                                        $('#allocationsTableBody').empty();
                                        
                                        // Check if there are existing allocations
                                        if (bill.allocations && bill.allocations.length > 0) {
                                            // Load existing allocations
                                            bill.allocations.forEach(function(allocation) {
                                                var row = createAllocationRow(
                                                    allocation.amount,
                                                    allocation.gst_amount,
                                                    allocation.allocation_pk,
                                                    allocation.xero_account_pk,
                                                    allocation.notes
                                                );
                                                $('#allocationsTableBody').append(row);
                                            });
                                        } else {
                                            // Create new allocation row with bill totals
                                            var row = createAllocationRow(bill.total_net, bill.total_gst);
                                            $('#allocationsTableBody').append(row);
                                            
                                            // Create allocation in database via AJAX
                                            $.ajax({
                                                url: '/core/create_bill_allocation/',
                                                type: 'POST',
                                                contentType: 'application/json',
                                                data: JSON.stringify({
                                                    bill_pk: bill.bill_pk,
                                                    amount: bill.total_net,
                                                    gst_amount: bill.total_gst
                                                }),
                                                success: function(response) {
                                                    if (response.status === 'success') {
                                                        row.attr('data-allocation-pk', response.allocation_pk);
                                                    }
                                                },
                                                error: function(xhr, status, error) {
                                                    console.error('Error creating allocation:', error);
                                                }
                                            });
                                        }
                                        
                                        // Populate dropdowns with Xero data for this instance
                                        populateAllAllocationDropdowns();
                                        
                                        // Update remaining allocation calculations
                                        updateRemainingAllocations();
                                        
                                        // After loading allocations, check if they're valid and mark the row
                                        // This happens after a short delay to ensure dropdowns are populated
                                        setTimeout(function() {
                                            var remainingNetVal = parseFloat($('#remainingNet').text().replace('$', ''));
                                            var remainingGstVal = parseFloat($('#remainingGst').text().replace('$', ''));
                                            var hasAllocations = $('#allocationsTableBody tr').length > 0;
                                            var allAccountsSelected = true;
                                            $('#allocationsTableBody tr').each(function() {
                                                if (!$(this).find('.xero-account-select').val()) {
                                                    allAccountsSelected = false;
                                                }
                                            });
                                            
                                            if (hasAllocations && allAccountsSelected && 
                                                Math.abs(remainingNetVal) < 0.01 && Math.abs(remainingGstVal) < 0.01) {
                                                clickedRow.attr('data-allocations-valid', 'true');
                                            } else {
                                                clickedRow.attr('data-allocations-valid', 'false');
                                            }
                                            
                                            // Re-validate button state with new allocation status
                                            validateAndUpdateSendButton(billPk);
                                        }, 100);
                                    }
                                }
                            }
                            
                            // Validate button state for the newly selected row
                            validateAndUpdateSendButton(billPk);
                        }
                    });
                    
                    // Add click handler for '+' button to add new allocation rows
                    $(document).on('click', '#addAllocationBtn', function(e) {
                        e.preventDefault();
                        
                        if (!currentBillData) {
                            alert('Please select a bill first');
                            return;
                        }
                        
                        // Add empty row
                        var row = createAllocationRow(null, null);
                        $('#allocationsTableBody').append(row);
                        
                        // Create allocation in database
                        $.ajax({
                            url: '/core/create_bill_allocation/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                bill_pk: currentBillData.bill_pk,
                                amount: 0,
                                gst_amount: 0
                            }),
                            success: function(response) {
                                if (response.status === 'success') {
                                    row.attr('data-allocation-pk', response.allocation_pk);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error creating allocation:', error);
                            }
                        });
                        
                        // Populate dropdowns for the new row
                        if (currentBillData.xero_instance_pk) {
                            populateXeroAccounts(row, currentBillData.xero_instance_pk);
                            populateDivisions(row, currentBillData.xero_instance_pk);
                        }
                        
                        // Update remaining allocations (new row has 0 amounts)
                        updateRemainingAllocations();
                    });
                    
                    // Add click handler for Pull Xero Accounts button
                    $(document).on('click', '#pullXeroAccountsBtn', function(e) {
                        e.preventDefault();
                        
                        var button = $(this);
                        var originalHtml = button.html();
                        
                        // Disable button and show loading state
                        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Pulling...');
                        
                        // Send AJAX request
                        $.ajax({
                            url: '{% url "core:pull_xero_accounts_and_divisions" %}',
                            type: 'POST',
                            headers: {
                                'X-CSRFToken': Utils.getCSRFToken()
                            },
                            success: function(response) {
                                if (response.status === 'success') {
                                    var message = response.message + '\n\n';
                                    message += '--- Summary ---\n';
                                    message += 'Accounts: ' + response.summary.total_accounts_added + ' added, ' + 
                                               response.summary.total_accounts_updated + ' updated, ' + 
                                               response.summary.total_accounts_unchanged + ' unchanged\n';
                                    
                                    if (response.instances && response.instances.length > 0) {
                                        message += '\n--- Instance Details ---\n';
                                        response.instances.forEach(function(inst) {
                                            message += '\n' + inst.instance_name + ': ' + inst.status;
                                            if (inst.accounts_added !== undefined) {
                                                message += '\n  Accounts: ' + inst.accounts_added + ' added, ' + 
                                                           inst.accounts_updated + ' updated, ' + 
                                                           inst.accounts_unchanged + ' unchanged';
                                            }
                                            if (inst.message) {
                                                message += '\n  ' + inst.message;
                                            }
                                        });
                                    }
                                    
                                    alert(message);
                                } else {
                                    alert('Error: ' + response.message);
                                }
                                
                                // Re-enable button
                                button.prop('disabled', false).html(originalHtml);
                            },
                            error: function(xhr, status, error) {
                                console.error('Error pulling Xero accounts:', error);
                                alert('Failed to pull Xero accounts. Please try again.');
                                
                                // Re-enable button
                                button.prop('disabled', false).html(originalHtml);
                            }
                        });
                    });
        });
</script>
