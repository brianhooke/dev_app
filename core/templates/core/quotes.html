<!-- Quotes Section Template -->
<!-- Uses reusable allocations section with AllocationsManager -->
{% load static %}

{% include "core/components/reusable_allocations_section.html" with section_id="quote" main_table_columns=main_table_columns allocations_columns=allocations_columns allocations_title="Quote Allocations" viewer_placeholder_text="Click on a quote to view the PDF" viewer_placeholder_icon="fas fa-file-alt" %}

<!-- Load AllocationsManager (shared) -->
<script src="{% static 'core/js/allocations_manager.js' %}"></script>

<!-- Pass project PK to JavaScript -->
<script>
    if ('{{ project_pk }}' && '{{ project_pk }}' !== 'None') {
        window.projectPk = '{{ project_pk }}';
    }
</script>

<!-- Inlined Quotes Section JS -->
<script>
$(document).ready(function() {
    if ($('#quoteMainTableBody').length === 0) return;
    
    // Skip if running within Projects page
    if (window.loadQuotesData || window.initQuotesAllocationsManager) {
        console.log('Quotes section: Skipping auto-init (running within Projects page)');
        return;
    }
    
    console.log('Initializing quotes section with AllocationsManager (standalone)...');
    
    var projectPk = window.projectPk || 
                    (window.currentQuotesProject && window.currentQuotesProject.pk) ||
                    (window.currentConstructionProject && window.currentConstructionProject.pk) ||
                    (window.currentProject && window.currentProject.pk) ||
                    getProjectPkFromUrl();
    
    AllocationsManager.init({
        sectionId: 'quote',
        mainTable: {
            emptyMessage: 'No quotes found. Click "Add Quote" to create one.',
            showFooter: true,
            footerTotals: [{ colIndex: 2, valueKey: 'total_cost' }],
            renderRow: function(quote, index, cfg) {
                var row = $('<tr>')
                    .attr('data-pk', quote.quotes_pk)
                    .attr('data-pdf-url', quote.pdf_url || quote.pdf || '');
                
                row.append($('<td>').text(quote.supplier_name || quote.contact_pk__contact_name || '-'));
                
                var netAmount = parseFloat(quote.total_cost) || 0;
                var formattedNet = '$' + netAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                row.append($('<td>').text(formattedNet));
                row.append($('<td>').text(quote.supplier_quote_number || '-'));
                
                var saveBtn = $('<button>')
                    .addClass('btn btn-sm btn-success')
                    .html('<i class="fas fa-save"></i>')
                    .on('click', function(e) {
                        e.stopPropagation();
                        saveQuote(quote.quotes_pk);
                    });
                row.append($('<td>').addClass('text-center').append(saveBtn));
                
                var deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger')
                    .html('<i class="fas fa-trash"></i>')
                    .on('click', function(e) {
                        e.stopPropagation();
                        deleteQuote(quote.quotes_pk, quote.supplier_quote_number);
                    });
                row.append($('<td>').addClass('text-center').append(deleteBtn));
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                console.log('Quote selected:', pk);
                AllocationsManager.setEditMode('quote', true);
            }
        },
        allocations: {
            emptyMessage: 'No allocations. Click "+ Add Row" to allocate costs.',
            editable: true,
            renderEditableRow: function(allocation, cfg, onChange) {
                var row = $('<tr>');
                if (allocation) row.attr('data-allocation-pk', allocation.quote_allocations_pk || allocation.pk);
                
                var itemSelect = $('<select>').addClass('form-control form-control-sm quote-allocation-item-select');
                itemSelect.append($('<option>').val('').text('Select Item...'));
                var costingItems = cfg.data.costingItems || window.quoteCostingItems || window.costings || [];
                costingItems.forEach(function(item) {
                    var option = $('<option>')
                        .val(item.costing_pk || item.pk)
                        .attr('data-costing-id', item.costing_pk || item.pk)
                        .text(item.item || item.name);
                    if (allocation && allocation.item_pk == (item.costing_pk || item.pk)) option.prop('selected', true);
                    itemSelect.append(option);
                });
                itemSelect.on('change', onChange);
                row.append($('<td>').append(itemSelect));
                
                var amountInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm quote-allocation-amount-input')
                    .val(allocation ? parseFloat(allocation.amount).toFixed(2) : '')
                    .on('change input', onChange);
                row.append($('<td>').append(amountInput));
                
                var notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm quote-allocation-notes-input')
                    .val(allocation ? allocation.notes || '' : '');
                row.append($('<td>').append(notesInput));
                
                var deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger')
                    .html('<i class="fas fa-times"></i>')
                    .on('click', function() {
                        row.remove();
                        onChange();
                        if (window.adjustAllocationsHeight && window.adjustAllocationsHeight['quote']) {
                            window.adjustAllocationsHeight['quote']();
                        }
                    });
                row.append($('<td>').css('text-align', 'center').append(deleteBtn));
                
                return row;
            },
            onUpdate: function(sectionId, totals) {
                console.log('Quote allocations updated:', totals);
            }
        },
        api: {
            loadData: '/get_project_quotes/{pk}/',
            loadAllocations: function(quotePk) {
                return '/get_allocations_for_quote/' + quotePk + '/';
            }
        }
    });
    
    if (projectPk) AllocationsManager.loadData('quote', { projectPk: projectPk });
    
    function getProjectPkFromUrl() {
        var match = window.location.pathname.match(/\/project\/(\d+)/);
        return match ? match[1] : null;
    }
    
    function saveQuote(quotePk) {
        var allocations = AllocationsManager.getAllocations('quote');
        if (!allocations || allocations.length === 0) {
            alert('Please add at least one allocation.');
            return;
        }
        
        $.ajax({
            url: '/update_quote/',
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            data: JSON.stringify({
                quote_id: quotePk,
                allocations: allocations.map(function(a) {
                    return { item: a.item_pk, amount: a.amount, notes: a.notes };
                })
            }),
            success: function(response) {
                if (response.status === 'success') {
                    alert('Quote saved successfully!');
                } else {
                    alert('Error: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to save quote: ' + error);
            }
        });
    }
    
    function deleteQuote(quotePk, quoteNumber) {
        if (!confirm('Are you sure you want to delete quote "' + quoteNumber + '"?')) return;
        
        $.ajax({
            url: '/delete_quote/',
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({ supplier_quote_number: quoteNumber }),
            success: function(response) {
                if (response.status === 'success') {
                    var projectPk = window.projectPk || getProjectPkFromUrl();
                    if (projectPk) AllocationsManager.loadData('quote', { projectPk: projectPk });
                } else {
                    alert('Error: ' + (response.message || 'Failed to delete quote'));
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to delete quote: ' + error);
            }
        });
    }
});
</script>
