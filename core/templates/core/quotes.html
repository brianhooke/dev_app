<!-- Quotes Section Template -->
<!-- SELF-CONTAINED: All quote logic is in this file - does not depend on projects_scripts.html -->
{% load static %}

<style>
    /* Constrain quotes main table height */
    .quote-table-container { max-height: 300px; }
</style>

{% include "core/components/allocations_layout.html" with section_id="quote" main_table_columns=main_table_columns allocations_columns=allocations_columns allocations_title="Quote Allocations" viewer_placeholder_text="Click on a quote to view the PDF" viewer_placeholder_icon="fas fa-file-alt" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Pass context to JavaScript -->
<script>
    if ('{{ project_pk }}' && '{{ project_pk }}' !== 'None') {
        window.projectPk = '{{ project_pk }}';
    }
    window.quoteIsConstruction = {{ is_construction|yesno:"true,false" }};
    // Column widths from Python context (single source of truth)
    window.quoteAllocationWidths = [{% for col in allocations_columns %}'{{ col.width }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    console.log('üîç [QUOTE DEBUG] Template widths loaded:', window.quoteAllocationWidths);
</script>

<!-- Self-Contained Quotes Section JS -->
<script>
$(document).ready(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#quoteMainTableBody').length === 0) {
        console.log('Quotes section: Table not found, skipping init');
        return;
    }
    
    console.log('Quotes section: Self-initializing...');
    
    // Get project info from various sources
    var projectPk = window.projectPk || 
                    (window.currentQuotesProject && window.currentQuotesProject.pk) ||
                    (window.currentConstructionProject && window.currentConstructionProject.pk) ||
                    (window.currentProject && window.currentProject.pk) ||
                    Utils.getProjectPkFromUrl();
    
    var isConstruction = window.quoteIsConstruction || 
                         (window.currentQuotesProject && window.currentQuotesProject.project_type === 'construction') ||
                         false;
    
    // State
    window.newQuoteMode = false;
    window.newQuotePdfData = null;
    window.newQuotePdfUrl = null;
    window.newQuoteAllocations = [];
    window.currentSelectedQuote = null;
    window.editingQuotePk = null;
    
    
    // Initialize AllocationsManager
    console.log('üîç [QUOTE DEBUG] Document ready, initializing AllocationsManager with widths:', window.quoteAllocationWidths);
    AllocationsManager.init({
        sectionId: 'quote',
        features: {
            saveRowBtn: true,
            deleteRowBtn: true,
            constructionMode: isConstruction,
            gstField: false,
            confirmDelete: true,
            reloadAfterDelete: false,  // Use onDeleteSuccess callback instead
            showSaveButton: false,  // Using main table Save button instead of footer
            alwaysShowAddButton: false
        },
        data: {
            pkField: 'quotes_pk'
        },
        mainTable: {
            emptyMessage: 'No quotes found. Click "+ New Quote" to create one.',
            showFooter: true,
            alwaysShowFooter: true,
            footerTotals: [{ colIndex: 2, valueKey: 'total_cost' }],
            renderRow: function(quote, index, cfg) {
                var row = $('<tr>').attr('data-pk', quote.quotes_pk);
                // Store quote data on row for later access
                row.data('quote', quote);
                
                // Supplier
                var supplierName = quote.supplier_name || '-';
                row.append($('<td>').text(supplierName).attr('title', supplierName));
                
                // $ Net
                var netAmount = quote.total_cost ? parseFloat(quote.total_cost) : 0;
                var netText = '$' + Utils.formatMoney(netAmount);
                row.append($('<td>').text(netText));
                
                // Quote #
                var quoteNum = quote.supplier_quote_number || '-';
                row.append($('<td>').text(quoteNum).attr('title', quoteNum));
                
                // Update button
                if (cfg.features.saveRowBtn) {
                    row.append($('<td>').addClass('col-action-first').append(AllocationsManager.createUpdateButton(quote, cfg)));
                }
                
                // Delete button
                if (cfg.features.deleteRowBtn) {
                    row.append($('<td>').addClass('col-action').append(AllocationsManager.createDeleteButton(quote, cfg)));
                }
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                console.log('Quote row selected:', pk);
                // If we were in edit mode, cancel it (switch to read-only view)
                if (window.editingQuotePk) {
                    console.log('Cancelling edit mode - user clicked another row');
                    AllocationsManager.setEditMode('quote', false);
                    // Revert the Save button back to Update button
                    revertSaveToUpdateButton(window.editingQuotePk);
                }
                window.editingQuotePk = null;
                window.currentSelectedQuote = cfg.data.currentItem;
            }
        },
        allocations: {
            emptyMessage: 'No allocations for this quote',
            editable: true,
            columnWidths: window.quoteAllocationWidths || [],  // Use template widths like bills
            renderRow: function(alloc, cfg) {
                return renderQuoteAllocationRow(alloc, false);
            },
            renderEditableRow: function(allocation, cfg, onChange) {
                // Use shared createEditableAllocationRow from AllocationsManager
                return AllocationsManager.createEditableAllocationRow({
                    sectionId: 'quote',
                    allocation: allocation,
                    isConstruction: Utils.isConstructionProject('quote'),
                    costingItems: window.quotesCostingItems || window.itemsItems || [],
                    onUpdate: function() {
                        AllocationsManager.updateStillToAllocate('quote');
                        if (onChange) onChange();
                    },
                    api: {
                        save: '/core/update_quote_allocation/{pk}/',
                        delete: '/core/delete_quote_allocation/{pk}/'
                    }
                });
            },
            onUpdate: function(sectionId, data) {
                // For quotes in edit mode, update the main table Save button (not footer)
                if (window.editingQuotePk) {
                    var mainSaveBtn = $('#quoteMainTableBody tr[data-pk="' + window.editingQuotePk + '"] .quote-save-btn');
                    if (mainSaveBtn.length) {
                        var isValid = Math.abs(data.remainingNet) < 0.01;
                        // Check all allocations have items selected
                        var allocations = AllocationsManager.getAllocations('quote');
                        for (var i = 0; i < allocations.length; i++) {
                            if (!allocations[i].item_pk) {
                                isValid = false;
                                break;
                            }
                        }
                        mainSaveBtn.prop('disabled', !isValid);
                        if (isValid) {
                            mainSaveBtn.removeClass('btn-warning btn-secondary').addClass('btn-success');
                        } else {
                            mainSaveBtn.removeClass('btn-success btn-warning').addClass('btn-secondary');
                        }
                    }
                }
                // Also validate new quote if in new mode
                if (window.newQuoteMode && typeof window.validateNewQuote === 'function') {
                    window.validateNewQuote();
                }
            }
        },
        api: {
            loadAllocations: '/core/get_allocations_for_quote/{pk}/',
            save: '/core/save_quote_allocations/',
            delete: '/core/delete_quote/'
        },
        callbacks: {
            onUpdate: function(item, cfg, row) {
                openQuoteForEditing(item);
            },
            onAllocationsLoaded: function(sectionId, allocations) {
                console.log('Quote allocations loaded:', allocations.length);
            },
            onSave: function(itemPk, allocations, cfg) {
                // Validate allocations before saving
                var result = AllocationsManager.updateStillToAllocate('quote');
                if (!result) {
                    alert('Unable to calculate allocation totals.');
                    return false;
                }
                
                // Check if all allocations have an item selected
                for (var i = 0; i < allocations.length; i++) {
                    if (!allocations[i].item_pk) {
                        alert('Please select an item for all allocation rows.');
                        return false;
                    }
                }
                
                // Check if still to allocate is zero (within tolerance)
                if (Math.abs(result.remainingNet) > 0.01) {
                    alert('Still to Allocate must be $0.00. Current: $' + result.remainingNet.toFixed(2));
                    return false;
                }
                
                return true; // Continue with save
            },
            onSaveSuccess: function(response, itemPk, cfg) {
                alert('Quote allocations saved successfully!');
                AllocationsManager.setEditMode('quote', false);
                
                // Revert Save button back to Update button
                revertSaveToUpdateButton(itemPk);
                
                window.editingQuotePk = null;
                // Reload allocations to show saved state
                AllocationsManager.loadAllocations('quote', itemPk);
            },
            onDeleteSuccess: function(response, itemPk, cfg) {
                // Clear allocations table and reload quotes list
                $('#quoteAllocationsTableBody').empty();
                $('#quoteAddAllocationBtn').hide();
                $('#quoteSaveAllocationsBtn').hide();
                window.currentSelectedQuote = null;
                
                // Reload the quotes list using custom function
                loadQuotesData();
            }
        }
    });
    
    // Manually trigger column width application for quotes (since allocations might not load immediately)
    console.log('üîç [QUOTE DEBUG] Manually applying column styles for quotes');
    if (window.quoteAllocationWidths && window.quoteAllocationWidths.length > 0) {
        Utils.applyColumnStyles('quote', window.quoteAllocationWidths, { addEditableClass: true });
        console.log('üîç [QUOTE DEBUG] Manual column styles applied for quotes');
    } else {
        console.log('üîç [QUOTE DEBUG] No quote widths available for manual application');
    }
    
    // NOTE: Column widths now handled by AllocationsManager via allocations.columnWidths config
    
    // Render a quote allocation row (read-only mode only - editable uses shared createEditableAllocationRow)
    function renderQuoteAllocationRow(allocation, editable, onChange) {
        var row = $('<tr>');
        var isConstr = Utils.isConstructionProject('quote');
        
        if (allocation) {
            row.attr('data-allocation-pk', allocation.quote_allocations_pk || allocation.pk);
            row.attr('data-item-pk', allocation.item_pk);
        }
        
        // Read-only mode (editable mode now uses AllocationsManager.createEditableAllocationRow)
        if (isConstr) {
            row.append($('<td>').text(allocation.item_name || '-'));
            row.append($('<td>').text(allocation.unit || '-'));
            row.append($('<td>').text(allocation.qty ? parseFloat(allocation.qty).toFixed(2) : '0.00'));
            var rate = allocation.rate ? parseFloat(allocation.rate) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(rate)));
            var amount = allocation.amount ? parseFloat(allocation.amount) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(amount)));
            row.append($('<td>').text(allocation.notes || '-'));
            row.append($('<td>').addClass('col-action-first').attr('data-edit-only', 'true').hide()); // Hidden delete column
        } else {
            row.append($('<td>').text(allocation.item_name || '-'));
            var amount = allocation.amount ? parseFloat(allocation.amount) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(amount)));
            row.append($('<td>').text(allocation.notes || '-'));
            row.append($('<td>').addClass('col-action-first').attr('data-edit-only', 'true').hide()); // Hidden delete column
        }
        
        return row;
    }
    
    // NOTE: updateRowAmount removed - now handled by AllocationsManager.createEditableAllocationRow
    
    // Helper function to revert Save button back to Update button
    function revertSaveToUpdateButton(quotePk) {
        var row = $('#quoteMainTableBody tr[data-pk="' + quotePk + '"]');
        var saveBtn = row.find('.quote-save-btn');
        if (saveBtn.length) {
            // Get the quote data from the row
            var quoteData = row.data('quote') || { quotes_pk: quotePk };
            
            saveBtn
                .removeClass('btn-success btn-secondary quote-save-btn')
                .addClass('btn-warning quote-update-btn')
                .text('Update')
                .attr('title', 'Update')
                .prop('disabled', false)
                .off('click')
                .on('click', function(e) {
                    e.stopPropagation();
                    openQuoteForEditing(quoteData);
                });
        }
    }
    
    // Open quote for editing
    function openQuoteForEditing(quote) {
        console.log('Opening quote for editing:', quote);
        
        // Set edit mode BEFORE anything else
        AllocationsManager.setEditMode('quote', true);
        
        window.currentSelectedQuote = quote;
        window.editingQuotePk = quote.quotes_pk;
        
        // Change Update button to Save button in the main table
        var row = $('#quoteMainTableBody tr[data-pk="' + quote.quotes_pk + '"]');
        var updateBtn = row.find('.quote-update-btn');
        if (updateBtn.length) {
            updateBtn
                .removeClass('btn-warning quote-update-btn')
                .addClass('btn-secondary quote-save-btn')
                .text('Save')
                .attr('title', 'Save allocations')
                .off('click')
                .on('click', function(e) {
                    e.stopPropagation();
                    // Use AllocationsManager to save
                    AllocationsManager.saveItem('quote', quote.quotes_pk);
                });
        }
        
        // Hide the footer Save button (we're using the main table Save button now)
        $('#quoteSaveAllocationsBtn').hide();
        
        if (row.length) {
            if (!row.hasClass('selected-row')) {
                // Row not selected - select it (this will load allocations with editMode: true)
                AllocationsManager.selectRow('quote', row);
            } else {
                // Row already selected - reload allocations with editMode: true
                AllocationsManager.loadAllocations('quote', quote.quotes_pk);
            }
        }
    }
    
    // Load quotes data
    function loadQuotesData() {
        var pk = projectPk || (window.currentQuotesProject && window.currentQuotesProject.pk);
        if (!pk) {
            console.error('No project PK for loading quotes');
            return;
        }
        
        console.log('Loading quotes for project:', pk);
        
        // Load items first
        $.ajax({
            url: '/core/get_project_items/' + pk + '/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    window.itemsItems = response.items;
                    window.quotesCostingItems = response.items;
                    console.log('Loaded costing items:', response.items.length);
                }
            }
        }).always(function() {
            // Then load quotes
            $.ajax({
                url: '/core/get_project_quotes/' + pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Loaded quotes:', response.quotes.length);
                        AllocationsManager.populateMainTable('quote', response.quotes);
                        // Initialize sortable table after data loads
                        Utils.initSortableTable('quoteMainTable', { tbodyId: 'quoteMainTableBody' });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes:', error);
                }
            });
        });
    }
    
    
    // Make functions globally available
    window.loadQuotesData = loadQuotesData;
    window.openQuoteForEditing = openQuoteForEditing;
    
    // Auto-load data
    if (projectPk) {
        loadQuotesData();
    }
    
});
</script>
