<!-- Quotes Section Template -->
<!-- SELF-CONTAINED: All quote logic is in this file - does not depend on projects_scripts.html -->
{% load static %}

<style>
    /* Constrain quotes main table height */
    .quote-table-container { max-height: 300px; }
</style>

{% include "core/components/allocations_layout.html" with section_id="quote" main_table_columns=main_table_columns allocations_columns=allocations_columns allocations_title="Quote Allocations" viewer_placeholder_text="Click on a quote to view the PDF" viewer_placeholder_icon="fas fa-file-alt" %}

<!-- Load shared utilities and AllocationsManager -->
<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>

<!-- Pass context to JavaScript -->
<script>
    if ('{{ project_pk }}' && '{{ project_pk }}' !== 'None') {
        window.projectPk = '{{ project_pk }}';
    }
    window.quoteIsConstruction = {{ is_construction|yesno:"true,false" }};
    window.quoteProjectStatus = {{ project_status }};
    // Column widths from Python context (single source of truth)
    window.quoteAllocationWidths = [{% for col in allocations_columns %}'{{ col.width }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
</script>

<!-- Self-Contained Quotes Section JS -->
<script>
$(document).ready(function() {
    'use strict';
    
    // Wait for DOM and ensure we have the table
    if ($('#quoteMainTableBody').length === 0) {
        return;
    }
    
    
    // Get project info from various sources
    var projectPk = window.projectPk || 
                    (window.currentQuotesProject && window.currentQuotesProject.pk) ||
                    (window.currentConstructionProject && window.currentConstructionProject.pk) ||
                    (window.currentProject && window.currentProject.pk) ||
                    Utils.getProjectPkFromUrl();
    
    // Use rates_based flag from backend (passed as quoteIsConstruction) or project's is_rates_based property
    var isConstruction = window.quoteIsConstruction || 
                         (window.currentQuotesProject && window.currentQuotesProject.is_rates_based) ||
                         false;
    
    // State
    window.newQuoteMode = false;
    window.newQuotePdfData = null;
    window.newQuotePdfUrl = null;
    window.newQuoteAllocations = [];
    window.currentSelectedQuote = null;
    window.editingQuotePk = null;
    
    
    // Initialize AllocationsManager
    AllocationsManager.init({
        sectionId: 'quote',
        features: {
            saveRowBtn: true,
            deleteRowBtn: true,
            constructionMode: isConstruction,
            gstField: false,
            confirmDelete: true,
            reloadAfterDelete: false,  // Use onDeleteSuccess callback instead
            showSaveButton: false,  // Using main table Save button instead of footer
            alwaysShowAddButton: false
        },
        data: {
            pkField: 'quotes_pk'
        },
        mainTable: {
            emptyMessage: 'No quotes found. Click "+ New Quote" to create one.',
            showFooter: true,
            alwaysShowFooter: true,
            footerTotals: [{ colIndex: 2, valueKey: 'total_cost' }],
            renderRow: function(quote, index, cfg) {
                var row = $('<tr>').attr('data-pk', quote.quotes_pk);
                // Set PDF URL for iviewer - check both pdf_url and pdf fields
                var pdfUrl = quote.pdf_url || quote.pdf || null;
                if (pdfUrl) {
                    row.attr('data-pdf-url', pdfUrl);
                }
                // Store quote data on row for later access
                row.data('quote', quote);
                
                // Supplier
                var supplierName = quote.supplier_name || '-';
                row.append($('<td>').text(supplierName).attr('title', supplierName));
                
                // $ Net
                var netAmount = quote.total_cost ? parseFloat(quote.total_cost) : 0;
                var netText = '$' + Utils.formatMoney(netAmount);
                row.append($('<td>').text(netText));
                
                // Quote #
                var quoteNum = quote.supplier_quote_number || '-';
                row.append($('<td>').text(quoteNum).attr('title', quoteNum));
                
                // Update button
                if (cfg.features.saveRowBtn) {
                    row.append($('<td>').addClass('col-action-first').append(AllocationsManager.createUpdateButton(quote, cfg)));
                }
                
                // Delete button
                if (cfg.features.deleteRowBtn) {
                    row.append($('<td>').addClass('col-action').append(AllocationsManager.createDeleteButton(quote, cfg)));
                }
                
                return row;
            },
            onRowSelect: function(row, pk, cfg) {
                // If we were in edit mode, cancel it (switch to read-only view)
                if (window.editingQuotePk) {
                    AllocationsManager.setEditMode('quote', false);
                    // Revert the Save button back to Update button
                    revertSaveToUpdateButton(window.editingQuotePk);
                }
                window.editingQuotePk = null;
                window.currentSelectedQuote = cfg.data.currentItem;
            }
        },
        allocations: {
            emptyMessage: 'No allocations for this quote',
            editable: true,
            columnWidths: window.quoteAllocationWidths || [],  // Use template widths like bills
            renderRow: function(alloc, cfg) {
                return renderQuoteAllocationRow(alloc, false);
            },
            renderEditableRow: function(allocation, cfg, onChange) {
                // Use shared createEditableAllocationRow from AllocationsManager
                return AllocationsManager.createEditableAllocationRow({
                    sectionId: 'quote',
                    allocation: allocation,
                    isConstruction: Utils.isConstructionProject('quote'),
                    costingItems: window.quotesCostingItems || window.itemsItems || [],
                    onUpdate: function() {
                        AllocationsManager.updateStillToAllocate('quote');
                        if (onChange) onChange();
                    },
                    api: {
                        save: '/core/update_quote_allocation/{pk}/',
                        delete: '/core/delete_quote_allocation/{pk}/'
                    }
                });
            },
            onUpdate: function(sectionId, data) {
                // For quotes in edit mode, update the main table Save button (not footer)
                if (window.editingQuotePk) {
                    var mainSaveBtn = $('#quoteMainTableBody tr[data-pk="' + window.editingQuotePk + '"] .quote-save-btn');
                    if (mainSaveBtn.length) {
                        var isValid = Math.abs(data.remainingNet) < 0.01;
                        // Check all allocations have items selected
                        var allocations = AllocationsManager.getAllocations('quote');
                        for (var i = 0; i < allocations.length; i++) {
                            if (!allocations[i].item_pk) {
                                isValid = false;
                                break;
                            }
                        }
                        mainSaveBtn.prop('disabled', !isValid);
                        if (isValid) {
                            mainSaveBtn.removeClass('btn-warning btn-secondary').addClass('btn-success');
                        } else {
                            mainSaveBtn.removeClass('btn-success btn-warning').addClass('btn-secondary');
                        }
                    }
                }
                // Also validate new quote if in new mode
                if (window.newQuoteMode && typeof window.validateNewQuote === 'function') {
                    window.validateNewQuote();
                }
            }
        },
        api: {
            loadAllocations: '/core/get_allocations_for_quote/{pk}/',
            save: '/core/save_quote_allocations/',
            delete: '/core/delete_quote/'
        },
        callbacks: {
            onUpdate: function(item, cfg, row) {
                openQuoteForEditing(item);
            },
            onAllocationsLoaded: function(sectionId, allocations) {
            },
            preparePayload: function(payload, cfg) {
                // Add main quote fields from editable inputs if in edit mode
                if (window.editingQuotePk) {
                    var row = $('#quoteMainTableBody tr[data-pk="' + window.editingQuotePk + '"]');
                    var supplierSelect = row.find('.quote-edit-supplier');
                    var netInput = row.find('.quote-edit-net');
                    var quoteNumInput = row.find('.quote-edit-number');
                    
                    if (supplierSelect.length && supplierSelect.val()) {
                        payload.supplier_pk = supplierSelect.val();
                    }
                    if (netInput.length) {
                        payload.total_cost = parseFloat(netInput.val()) || 0;
                    }
                    if (quoteNumInput.length) {
                        payload.supplier_quote_number = quoteNumInput.val();
                    }
                    
                    console.log('[quotes.html] preparePayload - added main fields:', {
                        supplier_pk: payload.supplier_pk,
                        total_cost: payload.total_cost,
                        supplier_quote_number: payload.supplier_quote_number
                    });
                }
                return payload;
            },
            onSave: function(itemPk, allocations, cfg) {
                // Validate allocations before saving
                var result = AllocationsManager.updateStillToAllocate('quote');
                if (!result) {
                    alert('Unable to calculate allocation totals.');
                    return false;
                }
                
                // Check if all allocations have an item selected
                for (var i = 0; i < allocations.length; i++) {
                    if (!allocations[i].item_pk) {
                        alert('Please select an item for all allocation rows.');
                        return false;
                    }
                }
                
                // Check if still to allocate is zero (within tolerance)
                if (Math.abs(result.remainingNet) > 0.01) {
                    alert('Still to Allocate must be $0.00. Current: $' + result.remainingNet.toFixed(2));
                    return false;
                }
                
                return true; // Continue with save
            },
            onSaveSuccess: function(response, itemPk, cfg) {
                alert('Quote allocations saved successfully!');
                AllocationsManager.setEditMode('quote', false);
                
                // Revert Save button back to Update button
                revertSaveToUpdateButton(itemPk);
                
                window.editingQuotePk = null;
                // Reload allocations to show saved state
                AllocationsManager.loadAllocations('quote', itemPk);
            },
            onDeleteSuccess: function(response, itemPk, cfg) {
                // Clear allocations table and reload quotes list
                $('#quoteAllocationsTableBody').empty();
                $('#quoteAddAllocationBtn').hide();
                $('#quoteSaveAllocationsBtn').hide();
                window.currentSelectedQuote = null;
                
                // Reload the quotes list using custom function
                loadQuotesData();
            }
        }
    });
    
    // Manually trigger column width application for quotes (since allocations might not load immediately)
    if (window.quoteAllocationWidths && window.quoteAllocationWidths.length > 0) {
        Utils.applyColumnStyles('quote', window.quoteAllocationWidths, { addEditableClass: true });
    } else {
    }
    
    // NOTE: Column widths now handled by AllocationsManager via allocations.columnWidths config
    
    // Render a quote allocation row (read-only mode only - editable uses shared createEditableAllocationRow)
    function renderQuoteAllocationRow(allocation, editable, onChange) {
        var row = $('<tr>');
        var isConstr = Utils.isConstructionProject('quote');
        
        if (allocation) {
            row.attr('data-allocation-pk', allocation.quote_allocations_pk || allocation.pk);
            row.attr('data-item-pk', allocation.item_pk);
        }
        
        // Read-only mode (editable mode now uses AllocationsManager.createEditableAllocationRow)
        if (isConstr) {
            row.append($('<td>').text(allocation.item_name || '-'));
            row.append($('<td>').text(allocation.unit || '-'));
            row.append($('<td>').text(allocation.qty ? parseFloat(allocation.qty).toFixed(2) : '0.00'));
            var rate = allocation.rate ? parseFloat(allocation.rate) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(rate)));
            var amount = allocation.amount ? parseFloat(allocation.amount) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(amount)));
            row.append($('<td>').text(allocation.notes || '-'));
            row.append($('<td>').addClass('col-action-first').attr('data-edit-only', 'true').hide()); // Hidden delete column
        } else {
            row.append($('<td>').text(allocation.item_name || '-'));
            var amount = allocation.amount ? parseFloat(allocation.amount) : 0;
            row.append($('<td>').text('$' + Utils.formatMoney(amount)));
            row.append($('<td>').text(allocation.notes || '-'));
            row.append($('<td>').addClass('col-action-first').attr('data-edit-only', 'true').hide()); // Hidden delete column
        }
        
        return row;
    }
    
    // NOTE: updateRowAmount removed - now handled by AllocationsManager.createEditableAllocationRow
    
    // Helper function to revert Save button back to Update button
    function revertSaveToUpdateButton(quotePk) {
        var row = $('#quoteMainTableBody tr[data-pk="' + quotePk + '"]');
        var saveBtn = row.find('.quote-save-btn');
        if (saveBtn.length) {
            // Get the updated quote data from the editable fields
            var quoteData = row.data('quote') || { quotes_pk: quotePk };
            
            // Read values from edit fields if they exist
            var supplierSelect = row.find('.quote-edit-supplier');
            var netInput = row.find('.quote-edit-net');
            var quoteNumInput = row.find('.quote-edit-number');
            
            if (supplierSelect.length) {
                quoteData.supplier_pk = supplierSelect.val();
                quoteData.supplier_name = supplierSelect.find('option:selected').text();
            }
            if (netInput.length) {
                quoteData.total_cost = parseFloat(netInput.val()) || 0;
            }
            if (quoteNumInput.length) {
                quoteData.supplier_quote_number = quoteNumInput.val();
            }
            
            // Update stored data
            row.data('quote', quoteData);
            
            // Restore cells to read-only display
            var cells = row.find('td');
            $(cells[0]).empty().text(quoteData.supplier_name || '-').attr('title', quoteData.supplier_name || '');
            $(cells[1]).empty().text('$' + Utils.formatMoney(quoteData.total_cost || 0));
            $(cells[2]).empty().text(quoteData.supplier_quote_number || '-').attr('title', quoteData.supplier_quote_number || '');
            
            saveBtn
                .removeClass('btn-success btn-secondary quote-save-btn')
                .addClass('btn-warning quote-update-btn')
                .text('Update')
                .attr('title', 'Update')
                .prop('disabled', false)
                .off('click')
                .on('click', function(e) {
                    e.stopPropagation();
                    openQuoteForEditing(quoteData);
                });
        }
    }
    
    // Open quote for editing
    function openQuoteForEditing(quote) {
        console.log('[quotes.html] openQuoteForEditing called, quote:', quote);
        console.log('[quotes.html] window.quotesCostingItems:', window.quotesCostingItems);
        console.log('[quotes.html] window.itemsItems:', window.itemsItems);
        console.log('[quotes.html] costingItems count:', (window.quotesCostingItems || window.itemsItems || []).length);
        
        // Set edit mode BEFORE anything else
        AllocationsManager.setEditMode('quote', true);
        
        window.currentSelectedQuote = quote;
        window.editingQuotePk = quote.quotes_pk;
        
        // Change Update button to Save button in the main table
        var row = $('#quoteMainTableBody tr[data-pk="' + quote.quotes_pk + '"]');
        var updateBtn = row.find('.quote-update-btn');
        if (updateBtn.length) {
            updateBtn
                .removeClass('btn-warning quote-update-btn')
                .addClass('btn-secondary quote-save-btn')
                .text('Save')
                .attr('title', 'Save allocations')
                .off('click')
                .on('click', function(e) {
                    e.stopPropagation();
                    // Use AllocationsManager to save
                    AllocationsManager.saveItem('quote', quote.quotes_pk);
                });
        }
        
        // Make Supplier, $ Net, Quote # cells editable
        var cells = row.find('td');
        
        // Cell 0: Supplier - convert to supplier dropdown
        var supplierCell = $(cells[0]);
        var currentSupplierName = quote.supplier_name || supplierCell.text();
        var currentSupplierPk = quote.supplier_pk || '';
        var supplierSelect = $('<select>').addClass('form-control form-control-sm quote-edit-supplier');
        supplierSelect.append($('<option>').val('').text('Select Supplier...'));
        // Load suppliers for this project
        var pk = projectPk || (window.currentQuotesProject && window.currentQuotesProject.pk);
        if (pk) {
            $.ajax({
                url: '/core/get_project_contacts/' + pk + '/',
                type: 'GET',
                async: false,  // Need synchronous to populate before continuing
                success: function(response) {
                    if (response.status === 'success' && response.contacts) {
                        response.contacts.forEach(function(contact) {
                            var opt = $('<option>').val(contact.contact_pk).text(contact.name);
                            if (contact.contact_pk == currentSupplierPk) {
                                opt.prop('selected', true);
                            }
                            supplierSelect.append(opt);
                        });
                    }
                }
            });
        }
        supplierCell.empty().append(supplierSelect);
        
        // Cell 1: $ Net - convert to input
        var netCell = $(cells[1]);
        var currentNet = quote.total_cost ? parseFloat(quote.total_cost) : 0;
        var netInput = $('<input>').attr('type', 'number').attr('step', '0.01')
            .addClass('form-control form-control-sm quote-edit-net')
            .val(currentNet.toFixed(2));
        // Update still-to-allocate when net value changes
        netInput.on('input change', function() {
            AllocationsManager.updateStillToAllocate('quote');
        });
        netCell.empty().append(netInput);
        
        // Cell 2: Quote # - convert to input
        var quoteNumCell = $(cells[2]);
        var currentQuoteNum = quote.supplier_quote_number || '';
        var quoteNumInput = $('<input>').attr('type', 'text')
            .addClass('form-control form-control-sm quote-edit-number')
            .val(currentQuoteNum);
        quoteNumCell.empty().append(quoteNumInput);
        
        // Hide the footer Save button (we're using the main table Save button now)
        $('#quoteSaveAllocationsBtn').hide();
        
        if (row.length) {
            if (!row.hasClass('selected-row')) {
                // Row not selected - select it (this will load allocations with editMode: true)
                AllocationsManager.selectRow('quote', row);
            } else {
                // Row already selected - reload allocations with editMode: true
                AllocationsManager.loadAllocations('quote', quote.quotes_pk);
            }
        }
    }
    
    // Load quotes data
    function loadQuotesData() {
        var pk = projectPk || (window.currentQuotesProject && window.currentQuotesProject.pk);
        if (!pk) {
            console.error('No project PK for loading quotes');
            return;
        }
        
        console.log('[quotes.html] loadQuotesData called, projectPk:', pk);
        
        // Determine tender_or_execution based on project status (from backend)
        // project_status: 1=tender, 2=execution -> tender_or_execution: 1=tender, 2=execution
        var projectStatus = window.quoteProjectStatus || 1;
        var tenderOrExecution = (projectStatus == 2) ? 2 : 1;
        console.log('[quotes.html] projectStatus:', projectStatus, 'tenderOrExecution:', tenderOrExecution);
        
        // Load items first (exclude internal category items for allocations)
        $.ajax({
            url: '/core/get_project_items/' + pk + '/?exclude_internal=1&tender_or_execution=' + tenderOrExecution,
            type: 'GET',
            success: function(response) {
                console.log('[quotes.html] get_project_items response:', response);
                if (response.status === 'success') {
                    window.itemsItems = response.items;
                    window.quotesCostingItems = response.items;
                    console.log('[quotes.html] Loaded costingItems count:', response.items.length);
                    if (response.items.length > 0) {
                        console.log('[quotes.html] First item sample:', response.items[0]);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('[quotes.html] Failed to load items:', error);
            }
        }).always(function() {
            // Then load quotes
            $.ajax({
                url: '/core/get_project_quotes/' + pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        AllocationsManager.populateMainTable('quote', response.quotes);
                        // Initialize sortable table after data loads
                        Utils.initSortableTable('quoteMainTable', { tbodyId: 'quoteMainTableBody' });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes:', error);
                }
            });
        });
    }
    
    
    // Make functions globally available
    window.loadQuotesData = loadQuotesData;
    window.openQuoteForEditing = openQuoteForEditing;
    
    // Auto-load data
    if (projectPk) {
        loadQuotesData();
    }
    
});
</script>
