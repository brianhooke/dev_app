<!-- Rates Section -->
{% include 'core/components/rates_table.html' %}
<div id="ratesSection" style="display: none; flex-direction: column; height: 100%;">
<style>
    .rates-page-container {
        display: flex;
        height: 100%;
        gap: 15px;
        padding: 20px;
    }
    
    .rates-left-panel {
        width: 40%;
        overflow-y: auto;
        border-right: 1px solid #dee2e6;
        padding-right: 15px;
    }
    
    .rates-right-panel {
        width: 60%;
        overflow-y: auto;
    }
    
    /* List column with left border */
    .rates-left-panel .reusable-table th.col-list,
    .rates-left-panel .reusable-table td.col-list {
        border-left: 1px solid #dee2e6;
    }
    
    /* Add column - narrow and centered */
    .rates-left-panel .reusable-table th.col-add,
    .rates-left-panel .reusable-table td.col-add {
        width: 75px;
        text-align: center;
    }
    
    /* Table border - match rates_table.html component styling */
    .rates-left-panel .reusable-table {
        border: 1px solid #000;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 4px;
        overflow: hidden;
    }
    
    /* Match th styling from component */
    .rates-left-panel .reusable-table thead th {
        box-shadow: none;
        border-bottom: 1px solid var(--color-border);
        font-size: 14px;
    }
    
    .rates-section {
        margin-bottom: 30px;
    }
    
    .rates-section h5 {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }
    
    /* Compact form inputs for rates tables */
    .rates-left-panel .reusable-table input[type="text"],
    .rates-left-panel .reusable-table select {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    
    .rates-add-btn {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .rates-add-btn.disabled {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    
    .rates-add-btn.enabled {
        background-color: #28a745;
        color: white;
    }
    
    .rates-add-btn.enabled:hover {
        background-color: #218838;
    }
    
    /* Units display table styling */
    .rates-left-panel .reusable-table tr.unit-row {
        cursor: move;
    }
    
    .rates-left-panel .reusable-table tr.unit-row:hover {
        background-color: #f5f5f5;
    }
    
    /* Drag-and-drop styles for units */
    .units-drag-over {
        border-top: 3px solid #007bff !important;
        background-color: #e3f2fd !important;
    }
    
    /* Delete button styling */
    .delete-unit-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 16px;
        padding: 0 5px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    .delete-unit-btn:hover {
        opacity: 1;
    }
    
    .delete-unit-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    /* Project type selector styling */
    .rates-type-selector {
        margin-bottom: 20px;
    }
    
    .rates-type-selector h5 {
        margin-bottom: 10px;
    }
    
    .rates-type-selector select {
        width: 100%;
        padding: 8px;
        font-size: 13px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
</style>

<div class="rates-page-container">
    <!-- Left Panel: Units Management (30%) -->
    <div class="rates-left-panel">
        <!-- Project Type Selector -->
        <div class="rates-type-selector">
            <h5>Project Type</h5>
            <select id="ratesProjectTypeSelect">
                <option value="">Select a project type...</option>
                <option value="general">General</option>
                <option value="development">Development</option>
                <option value="construction">Construction</option>
                <option value="precast">Precast</option>
                <option value="pods">Pods</option>
            </select>
        </div>
        
        <!-- Add Category/Item/Unit forms container (rendered by component) -->
        <div id="ratesInputFormsContainer"></div>
        
    </div>
    
    <!-- Right Panel: Category/Item Table (60%) -->
    <div class="rates-right-panel">
        <!-- Category/Item Table (uses shared component - renders complete table) -->
        <div id="ratesTableContainer">
            <div class="rates-flex-empty">
                Select a project type to view items.
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Get CSRF token from cookie
    function getCSRFToken() {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Data storage
    var ratesData = {
        categories: [],
        items: [],
        units: [],
        quantities: []
    };
    var selectedProjectType = null;
    
    // Initialize on page load
    $(document).ready(function() {
        // Render empty UI on page load (forms disabled, empty table)
        renderEmptyUI();
    });
    
    // Render empty UI with all headings and empty tables visible
    function renderEmptyUI() {
        // Render input forms in disabled state (no project type selected)
        if (typeof window.renderRatesInputForms === 'function') {
            window.renderRatesInputForms('#ratesInputFormsContainer', {
                mode: 'project_type',
                modeValue: null,  // No project type selected
                categories: [],
                items: [],
                units: [],
                showListColumn: true,
                disabled: true,  // Disable forms until project type selected
                onReload: function() {
                    if (selectedProjectType) {
                        loadRatesData(selectedProjectType);
                    }
                }
            });
        }
        
        // Render empty table
        if (typeof window.renderRatesTable === 'function') {
            window.renderRatesTable('#ratesTableContainer', [], [], {
                allowDrag: false,
                allowDelete: false,
                projectPk: null,
                useRatesEndpoint: true,
                projectType: null,
                units: [],
                emptyMessage: 'Select a project type to view items.',
                onReload: function() {
                    if (selectedProjectType) {
                        loadRatesData(selectedProjectType);
                    }
                }
            });
        }
    }
    
    // Project type selection change handler
    $('#ratesProjectTypeSelect').on('change', function() {
        selectedProjectType = $(this).val();
        if (selectedProjectType) {
            loadRatesData(selectedProjectType);
        } else {
            clearAllData();
        }
    });
    
    // Clear all data and reset UI
    function clearAllData() {
        ratesData = { categories: [], items: [], units: [] };
        renderEmptyUI();
    }
    
    // Load all rates data for selected project type
    function loadRatesData(projectType) {
        console.log('[Rates] loadRatesData called with projectType:', projectType);
        console.log('[Rates] Document cookies:', document.cookie);
        console.log('[Rates] Session cookie present:', document.cookie.includes('sessionid'));
        console.log('[Rates] CSRF cookie present:', document.cookie.includes('csrftoken'));
        $('#ratesTableContainer').html('<div class="rates-flex-empty">Loading data for ' + projectType + ' projects...</div>');
        
        var requestUrl = '/core/get_rates_data/';
        var requestData = { project_type: projectType };
        var csrfToken = getCSRFToken();
        console.log('[Rates] Making AJAX request to:', requestUrl, 'with data:', requestData);
        console.log('[Rates] CSRF Token:', csrfToken);
        
        $.ajax({
            url: requestUrl,
            type: 'GET',
            data: requestData,
            headers: { 'X-CSRFToken': csrfToken },
            xhrFields: { withCredentials: true },
            success: function(response, textStatus, xhr) {
                console.log('[Rates] AJAX success callback');
                console.log('[Rates] Response status code:', xhr.status);
                console.log('[Rates] Response headers:', xhr.getAllResponseHeaders());
                console.log('[Rates] Full response object:', response);
                console.log('[Rates] Response type:', typeof response);
                console.log('[Rates] Response.status:', response ? response.status : 'response is null/undefined');
                
                if (response && response.status === 'success') {
                    console.log('[Rates] Response status is success');
                    console.log('[Rates] Categories count:', response.categories ? response.categories.length : 0);
                    console.log('[Rates] Items count:', response.items ? response.items.length : 0);
                    console.log('[Rates] Units count:', response.units ? response.units.length : 0);
                    
                    ratesData.categories = response.categories || [];
                    ratesData.items = response.items || [];
                    ratesData.units = response.units || [];
                    
                    console.log('[Rates] About to render input forms');
                    renderRatesInputFormsUI();
                    
                    console.log('[Rates] About to render items table');
                    renderRatesItemsTable();
                    console.log('[Rates] Rendering complete');
                } else {
                    console.error('[Rates] Error loading rates data - response.status is not success');
                    console.error('[Rates] response:', response);
                    console.error('[Rates] response.message:', response ? response.message : 'no response');
                    console.error('[Rates] Full error details:', JSON.stringify(response, null, 2));
                    clearAllData();
                }
            },
            error: function(xhr, status, error) {
                console.error('[Rates] AJAX error callback');
                console.error('[Rates] XHR status:', xhr.status);
                console.error('[Rates] XHR statusText:', xhr.statusText);
                console.error('[Rates] XHR responseText:', xhr.responseText);
                console.error('[Rates] Status:', status);
                console.error('[Rates] Error:', error);
                try {
                    var errorResponse = JSON.parse(xhr.responseText);
                    console.error('[Rates] Parsed error response:', errorResponse);
                } catch(e) {
                    console.error('[Rates] Could not parse responseText as JSON');
                }
                clearAllData();
            }
        });
    }
    
    // Render the input forms using the shared component
    function renderRatesInputFormsUI() {
        if (typeof window.renderRatesInputForms === 'function') {
            window.renderRatesInputForms('#ratesInputFormsContainer', {
                mode: 'project_type',
                modeValue: selectedProjectType,
                categories: ratesData.categories,
                items: ratesData.items,
                units: ratesData.units,
                showListColumn: true,
                onReload: function() {
                    loadRatesData(selectedProjectType);
                }
            });
        }
    }
    
    // Render the RHS items table using shared component
    function renderRatesItemsTable() {
        if (ratesData.categories.length === 0 && ratesData.items.length === 0) {
            $('#ratesItemsTableBody').html('<div class="rates-flex-empty">No categories or items for this project type yet.</div>');
            return;
        }
        
        if (typeof window.renderRatesTable === 'function') {
            // Format data for the shared component
            var formattedCategories = ratesData.categories.map(function(cat) {
                return {
                    categories_pk: cat.categories_pk,
                    category: cat.category,
                    order_in_list: cat.order_in_list
                };
            });
            
            var formattedItems = ratesData.items.map(function(item) {
                return {
                    costing_pk: item.costing_pk,
                    item: item.item,
                    category_pk: item.category_pk,
                    category__category: item.category,  // Component expects this format
                    order_in_list: item.order_in_list,
                    unit: item.unit || '',
                    rate: item.rate,
                    operator: item.operator,
                    operator_value: item.operator_value
                };
            });
            
            window.renderRatesTable('#ratesTableContainer', formattedCategories, formattedItems, {
                allowDrag: true,
                allowDelete: false,
                projectPk: null,
                useRatesEndpoint: true,  // Use the rates-specific endpoint
                projectType: selectedProjectType,
                units: ratesData.units,  // Pass units for dropdown
                onReload: function() {
                    if (selectedProjectType) {
                        loadRatesData(selectedProjectType);
                    }
                }
            });
        }
    }
    
    // Validation and button click handlers are now in renderRatesInputForms component
    
    // Legacy reference - keeping for compatibility if needed
    // All Add Category/Item/Unit handlers moved to rates_table.html component
    
})();
</script>
</div> <!-- End Rates Section -->
