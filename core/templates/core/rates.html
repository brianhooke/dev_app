<!-- Rates Section -->
{% include 'core/components/rates_table.html' %}
<div id="ratesSection" style="display: none; flex-direction: column; height: 100%;">
<style>
    .rates-page-container {
        display: flex;
        height: 100%;
        gap: 15px;
        padding: 20px;
    }
    
    .rates-left-panel {
        width: 40%;
        overflow-y: auto;
    }
    
    .rates-right-panel {
        width: 60%;
        overflow-y: auto;
    }
    
    /* List column with left border */
    .rates-left-panel .reusable-table th.col-list,
    .rates-left-panel .reusable-table td.col-list {
        border-left: 1px solid #dee2e6;
    }
    
    /* Add column - narrow and centered */
    .rates-left-panel .reusable-table th.col-add,
    .rates-left-panel .reusable-table td.col-add {
        width: 75px;
        text-align: center;
    }
    
    /* Table border */
    .rates-left-panel .reusable-table {
        border: 1px solid #dee2e6;
    }
    
    .rates-section {
        margin-bottom: 30px;
    }
    
    .rates-section h5 {
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }
    
    /* Compact form inputs for rates tables */
    .rates-left-panel .reusable-table input[type="text"],
    .rates-left-panel .reusable-table select {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    
    .rates-add-btn {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .rates-add-btn.disabled {
        background-color: #6c757d;
        color: white;
        cursor: not-allowed;
    }
    
    .rates-add-btn.enabled {
        background-color: #28a745;
        color: white;
    }
    
    .rates-add-btn.enabled:hover {
        background-color: #218838;
    }
    
    /* Units display table styling */
    .rates-left-panel .reusable-table tr.unit-row {
        cursor: move;
    }
    
    .rates-left-panel .reusable-table tr.unit-row:hover {
        background-color: #f5f5f5;
    }
    
    /* Drag-and-drop styles for units */
    .units-drag-over {
        border-top: 3px solid #007bff !important;
        background-color: #e3f2fd !important;
    }
    
    /* Delete button styling */
    .delete-unit-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 16px;
        padding: 0 5px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    
    .delete-unit-btn:hover {
        opacity: 1;
    }
    
    .delete-unit-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    /* Project type selector styling */
    .rates-type-selector {
        margin-bottom: 20px;
    }
    
    .rates-type-selector h5 {
        margin-bottom: 10px;
    }
    
    .rates-type-selector select {
        width: 100%;
        padding: 8px;
        font-size: 13px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
</style>

<div class="rates-page-container">
    <!-- Left Panel: Units Management (30%) -->
    <div class="rates-left-panel">
        <!-- Project Type Selector -->
        <div class="rates-type-selector">
            <h5>Project Type</h5>
            <select id="ratesProjectTypeSelect">
                <option value="">Select a project type...</option>
                <option value="general">General</option>
                <option value="development">Development</option>
                <option value="construction">Construction</option>
                <option value="precast">Precast</option>
                <option value="pods">Pods</option>
            </select>
        </div>
        
        <!-- Add Category/Item/Unit forms container (rendered by component) -->
        <div id="ratesInputFormsContainer"></div>
        
    </div>
    
    <!-- Right Panel: Category/Item Table (60%) -->
    <div class="rates-right-panel">
        <h5>Rates and Quantities</h5>
        <!-- Category/Item Table (uses shared component - renders complete table) -->
        <div id="ratesTableContainer">
            <div class="rates-flex-empty">
                Select a project type to view items.
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Get CSRF token from cookie
    function getCSRFToken() {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Data storage
    var ratesData = {
        categories: [],
        items: [],
        units: [],
        quantities: []
    };
    var selectedProjectType = null;
    
    // Initialize on page load
    $(document).ready(function() {
        // Set initial empty state for dropdowns
        populateOrderDropdowns();
    });
    
    // Project type selection change handler
    $('#ratesProjectTypeSelect').on('change', function() {
        selectedProjectType = $(this).val();
        if (selectedProjectType) {
            loadRatesData(selectedProjectType);
        } else {
            clearAllData();
        }
    });
    
    // Clear all data and reset UI
    function clearAllData() {
        ratesData = { categories: [], items: [], units: [] };
        $('#ratesInputFormsContainer').empty();
        $('#ratesTableContainer').html('<div class="rates-flex-empty">Select a project type to view items.</div>');
    }
    
    // Load all rates data for selected project type
    function loadRatesData(projectType) {
        $('#ratesTableContainer').html('<div class="rates-flex-empty">Loading data for ' + projectType + ' projects...</div>');
        
        $.ajax({
            url: '/core/get_rates_data/',
            type: 'GET',
            data: { project_type: projectType },
            success: function(response) {
                if (response.status === 'success') {
                    ratesData.categories = response.categories || [];
                    ratesData.items = response.items || [];
                    ratesData.units = response.units || [];
                    
                    // Render input forms using component
                    renderRatesInputFormsUI();
                    
                    // Render table
                    renderRatesItemsTable();
                } else {
                    console.error('Error loading rates data:', response.message);
                    clearAllData();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading rates data:', error);
                clearAllData();
            }
        });
    }
    
    // Render the input forms using the shared component
    function renderRatesInputFormsUI() {
        if (typeof window.renderRatesInputForms === 'function') {
            window.renderRatesInputForms('#ratesInputFormsContainer', {
                mode: 'project_type',
                modeValue: selectedProjectType,
                categories: ratesData.categories,
                items: ratesData.items,
                units: ratesData.units,
                showListColumn: true,
                onReload: function() {
                    loadRatesData(selectedProjectType);
                }
            });
        }
    }
    
    // Render the RHS items table using shared component
    function renderRatesItemsTable() {
        if (ratesData.categories.length === 0 && ratesData.items.length === 0) {
            $('#ratesItemsTableBody').html('<div class="rates-flex-empty">No categories or items for this project type yet.</div>');
            return;
        }
        
        if (typeof window.renderRatesTable === 'function') {
            // Format data for the shared component
            var formattedCategories = ratesData.categories.map(function(cat) {
                return {
                    categories_pk: cat.categories_pk,
                    category: cat.category,
                    order_in_list: cat.order_in_list
                };
            });
            
            var formattedItems = ratesData.items.map(function(item) {
                return {
                    costing_pk: item.costing_pk,
                    item: item.item,
                    category_pk: item.category_pk,
                    category__category: item.category,  // Component expects this format
                    order_in_list: item.order_in_list,
                    unit: item.unit || '',
                    operator: item.operator,
                    operator_value: item.operator_value
                };
            });
            
            window.renderRatesTable('#ratesTableContainer', formattedCategories, formattedItems, {
                allowDrag: true,
                allowDelete: false,
                projectPk: null,
                useRatesEndpoint: true,  // Use the rates-specific endpoint
                projectType: selectedProjectType,
                units: ratesData.units,  // Pass units for dropdown
                onReload: function() {
                    if (selectedProjectType) {
                        loadRatesData(selectedProjectType);
                    }
                }
            });
        }
    }
    
    // Validation and button click handlers are now in renderRatesInputForms component
    
    // Legacy reference - keeping for compatibility if needed
    // All Add Category/Item/Unit handlers moved to rates_table.html component
    
})();
</script>
</div> <!-- End Rates Section -->
