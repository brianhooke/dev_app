{% extends "core/dashboard_master.html" %}
{% load static %}
{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Add styles for background image */
        body {
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static "core/media/background.png" %}');
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Makes the image greyed out */
            z-index: -1; /* Puts it behind all content */
            pointer-events: none; /* Prevents interference with clicks */
        }
    </style>
</head>

<div style="position: relative;">
    <h3 style="text-align: center;">Project <img src="{% static 'core/images/logo.png' %}" alt="Icon" style="height: 1.6em; vertical-align: middle; position: relative; bottom: 0.3em;">anagement App</h3>
    <div style="position: absolute; top: 0; right: 20px; font-size: 12px; color: #666;">v27</div>
</div>

<div style="padding: 20px;">
    <h4>Welcome to the Project Management Dashboard</h4>
    <p>This is your central hub for managing all projects.</p>
</div>

{% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %}

{% include 'core/xero_modals.html' %}
{% include 'core/contacts.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>

<script>
    $(document).ready(function() {
        // Function to load contacts for selected instance
        function loadContacts(instancePk) {
            if (!instancePk) {
                // Clear table if no instance selected
                $('#contactsModal tbody').html('<tr><td colspan="2" style="text-align: center;">Please select a Xero instance</td></tr>');
                return;
            }
            
            fetch(`/get_contacts_by_instance/${instancePk}/`)
                .then(response => response.json())
                .then(contacts => {
                    const tbody = $('#contactsModal tbody');
                    tbody.empty();
                    
                    if (contacts.length === 0) {
                        tbody.html('<tr><td colspan="2" style="text-align: center;">No contacts found. Click "Pull Xero Contacts" to import.</td></tr>');
                    } else {
                        contacts.forEach(contact => {
                            const row = `
                                <tr data-contact='${JSON.stringify(contact)}'>
                                    <td>${contact.name || ''}</td>
                                    <td>${contact.email || ''}</td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    $('#contactsModal tbody').html('<tr><td colspan="2" style="text-align: center; color: red;">Error loading contacts</td></tr>');
                });
        }
        
        // Open Contacts modal when navbar link is clicked
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            $('#contactsModal').modal('show');
        });
        
        // Load contacts when modal is shown
        $('#contactsModal').on('shown.bs.modal', function() {
            const instancePk = $('#xeroInstanceSelect').val();
            loadContacts(instancePk);
        });
        
        // Reload contacts when dropdown changes
        $(document).on('change', '#xeroInstanceSelect', function() {
            const instancePk = $(this).val();
            loadContacts(instancePk);
        });
        
        // Pull Xero Contacts button handler
        $(document).on('click', '#pullXeroContactsBtn', function() {
            const xeroInstancePk = $('#xeroInstanceSelect').val();
            
            if (!xeroInstancePk) {
                alert('Please select a Xero instance');
                return;
            }
            
            // Disable button and show loading state
            const button = $(this);
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Pulling Contacts...');
            
            fetch(`/pull_xero_contacts/${xeroInstancePk}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Success! ${data.details.new_contacts_added} new contacts added, ${data.details.existing_contacts_skipped} existing contacts skipped.`);
                    // Reload contacts table instead of page reload
                    loadContacts(xeroInstancePk);
                    button.prop('disabled', false).html('Pull Xero Contacts');
                } else {
                    alert(`Error: ${data.message}`);
                    button.prop('disabled', false).html('Pull Xero Contacts');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to pull contacts. Please try again.');
                button.prop('disabled', false).html('Pull Xero Contacts');
            });
        });
    });
</script>

{% endblock %}
