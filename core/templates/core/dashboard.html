{% extends "core/dashboard_master.html" %}
{% load static %}

<!--
Template: Dashboard Main Application Template

Purpose:
Main dashboard interface for the Project Management App. Provides navigation and modal interfaces
for Bills, Contacts, Xero management, and other core functionality.

Structure:
1. Master Template Extension
   - Extends core/dashboard_master.html
   - Includes global styles, favicon, background image
   - Navigation bar with dropdown menus

2. Included Modal Templates
   - Bills Section (using allocations_layout pattern):
     * {% include 'core/bills_global_buttons.html' %} - Navigation buttons, content loaded via AJAX
     * bills_global_inbox.html - Uses allocations_layout with hide_allocations=True
     * bills_global_direct.html - Uses allocations_layout with all 3 sections
     * bills_global_approvals.html - Uses allocations_layout with all 3 sections
   - {% include 'core/contacts.html' %} - Extended contacts modal with verification
   - {% include 'core/xero_modals.html' %} - Xero instance management

Bills Functionality (status-based workflows):
- Bills - Inbox (bill_status = -2):
  * Unprocessed email bills
  * LHS table: Xero Instance, Supplier, Bill #, Net, GST fields
  * Send button ‚Üí Updates bill, sets status to 0, moves to Bills - Direct
  * Archive button ‚Üí Sets status to 4

- Bills - Direct (bill_status = 0):
  * Ready for allocation
  * LHS table: Same fields as Inbox
  * RHS table: Allocations with Xero Account selection, amounts, notes
  * PDF viewer: Display bill attachment
  * "Still to allocate" calculations (Net/GST must = $0.00)
  * Send to Xero button ‚Üí Validates allocations, posts to Xero API as DRAFT, sets status to 2
  * Return to Inbox (mail icon) ‚Üí Deletes allocations, clears fields, sets status to -2
  * Archive button ‚Üí Sets status to 4

Contacts Functionality:
- Pull contacts from Xero API (insert/update)
- Create new contacts in Xero + local DB
- Update contact details (bank, email, ABN) in Xero
- Archive/unarchive contacts in Xero
- Verify contact details with side-by-side comparison
- Verified status indicators: 0=not verified, 1=verified+matches, 2=verified+changed

Xero Functionality:
- Manage Xero OAuth2 instances (create, test, delete)
- Pull accounts from Xero for all instances
- Display accounts by instance for allocation dropdowns

Key JavaScript Features:
- Dynamic table population for bills, allocations, contacts
- Real-time "Still to allocate" calculations with color coding
- Auto-calculate GST (10% of Net) with immediate updates
- Row selection with highlighting
- PDF viewer integration
- Modal state management (show/hide, data persistence)
- AJAX form submissions with validation
- Xero API integration via backend endpoints

Backend Endpoints Used:
Bills:
- GET  /get_bills_list/ - Fetch all bills with allocations
- POST /send_bill/ - Smart endpoint (Inbox‚ÜíDirect or Direct‚ÜíXero)
- POST /core/archive_bill/ - Archive bill
- POST /core/return_to_inbox/ - Return bill to inbox, delete allocations
- POST /core/create_bill_allocation/ - Create allocation
- POST /core/update_bill_allocation/ - Update allocation
- POST /core/delete_bill_allocation/ - Delete allocation
- POST /core/update_bill/ - Update bill fields
- POST /core/null_allocation_xero_fields/ - Clear Xero accounts on instance change
- GET  /core/get_xero_accounts_by_instance/{pk}/ - Get accounts for dropdown

Contacts:
- GET  /get_contacts_by_instance/{pk}/ - Get active contacts
- POST /pull_xero_contacts/{pk}/ - Sync from Xero
- POST /create_contact/{pk}/ - Create in Xero + DB
- POST /update_contact_details/{pk}/{contact_pk}/ - Update in Xero
- POST /update_contact_status/{pk}/{contact_pk}/ - Archive/unarchive
- POST /verify_contact_details/{contact_pk}/ - Save verified details

Xero:
- GET  /core/get_xero_instances/ - Fetch all instances
- POST /core/create_xero_instance/ - Create new instance
- POST /core/delete_xero_instance/ - Delete instance
- POST /core/test_xero_connection/{pk}/ - Test API connection
- POST /core/pull_xero_accounts_and_divisions/ - Sync accounts

Data Structures:
- Bill status codes: -2=Inbox, 0=Direct, 2=Sent to Xero, 4=Archived
- Contact verified status: 0=not verified, 1=verified+matches, 2=verified+changed
- Global variables: window.billsData, currentBillData, currentSelectedBillPk

Version: v89 (displayed in navbar bottom-left)
-->

{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<!-- Database Wipe Button -->
<button id="wipeDbBtn" title="Wipe All Database Data" aria-label="Wipe Database">
    <i class="fas fa-trash-alt"></i>
</button>

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Prevent page scrolling */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        
        /* Database Wipe Button - Top Left, Right of Navbar */
        #wipeDbBtn {
            position: fixed;
            top: 20px;
            left: 90px;
            z-index: 9999;
            background-color: #dc3545;
            color: white;
            border: 2px solid #c82333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: none; /* Hidden by default - show with SHIFT+B */
            align-items: center;
            justify-content: center;
        }
        
        #wipeDbBtn.visible {
            display: flex;
        }
        
        #wipeDbBtn:hover {
            background-color: #c82333;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
        }
        
        #wipeDbBtn:active {
            transform: scale(0.95);
        }
        
        
        /* Bills table row selection styling - applies to BOTH Inbox and Direct modals */
        #billsTableBody tr {
            transition: opacity 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        /* When there's a selected row, dim all non-selected rows */
        #billsTableBody.has-selection tr:not(.selected-bill-row) {
            opacity: 0.4;
        }
        
        /* Highlight the selected row */
        #billsTableBody tr.selected-bill-row {
            opacity: 1 !important;
            background-color: #e3f2fd !important;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            position: relative;
        }
        
        /* Keep hover effect visible on all rows */
        #billsTableBody tr:hover {
            opacity: 0.8 !important;
        }
        
        /* Xero section now uses allocations_layout.html (no custom overrides needed) */
        
        /* Navbar active state is already defined in reusable_navbar.html */
        
        /* Mason logo background for workspace */
        #dynamicContentArea::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('{% static "core/images/mason_logo.png" %}');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 1;
            pointer-events: none;
            z-index: 0;
        }

        /* Hide background when any section is active */
        #dynamicContentArea.has-content::before {
            display: none;
        }

        /* Ensure content appears above background */
        #dynamicContentArea > * {
            position: relative;
            z-index: 1;
        }
    </style>
</head>

<!-- Dynamic Content Area (Workspace) -->
<div id="dynamicContentArea" style="margin: 0; padding: 20px; height: 100vh; position: relative; overflow: hidden;">
    <!-- Dashboard Home Section (shown on page load) -->
    <div id="dashboardHomeSection" style="display: flex; flex-direction: column; height: 100%; overflow-y: auto;">
        <style>
            /* Dashboard Summary Cards */
            .dashboard-summary-cards {
                display: flex;
                gap: 20px;
                margin-bottom: 30px;
                flex-wrap: wrap;
            }
            
            .summary-card {
                flex: 1;
                min-width: 150px;
                max-width: 200px;
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                text-align: center;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .summary-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .summary-card .card-icon {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .summary-card .card-number {
                font-size: 32px;
                font-weight: 700;
                line-height: 1;
                margin-bottom: 4px;
            }
            
            .summary-card .card-label {
                font-size: 12px;
                color: #6c757d;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .summary-card.urgent { border-left: 4px solid #dc3545; }
            .summary-card.urgent .card-number { color: #dc3545; }
            
            .summary-card.warning { border-left: 4px solid #ffc107; }
            .summary-card.warning .card-number { color: #d39e00; }
            
            .summary-card.success { border-left: 4px solid #28a745; }
            .summary-card.success .card-number { color: #28a745; }
            
            .summary-card.info { border-left: 4px solid #17a2b8; }
            .summary-card.info .card-number { color: #17a2b8; }
            
            /* Dashboard Sections */
            .dashboard-section {
                background: white;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .dashboard-section-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            
            .dashboard-section-header h5 {
                margin: 0;
                font-weight: 600;
                color: #2c3e50;
            }
            
            .dashboard-section-header .section-icon {
                margin-right: 10px;
                font-size: 18px;
            }
            
            /* Action Items List */
            .action-item {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                margin-bottom: 8px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #6c757d;
                transition: background 0.2s;
            }
            
            .action-item:hover {
                background: #e9ecef;
            }
            
            .action-item.urgent { border-left-color: #dc3545; }
            .action-item.warning { border-left-color: #ffc107; }
            .action-item.success { border-left-color: #28a745; }
            
            .action-item .item-icon {
                margin-right: 12px;
                font-size: 16px;
            }
            
            .action-item .item-content {
                flex: 1;
            }
            
            .action-item .item-title {
                font-weight: 500;
                color: #2c3e50;
                margin-bottom: 2px;
            }
            
            .action-item .item-subtitle {
                font-size: 12px;
                color: #6c757d;
            }
            
            .action-item .item-action {
                margin-left: 15px;
            }
            
            .action-item .item-action a {
                color: #007bff;
                text-decoration: none;
                font-size: 13px;
                font-weight: 500;
            }
            
            .action-item .item-action a:hover {
                text-decoration: underline;
            }
            
            /* Activity Items */
            .activity-item {
                display: flex;
                align-items: flex-start;
                padding: 10px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .activity-item:last-child {
                border-bottom: none;
            }
            
            .activity-item .activity-icon {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: #e9ecef;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 12px;
                font-size: 14px;
                color: #6c757d;
            }
            
            .activity-item .activity-icon.success { background: #d4edda; color: #28a745; }
            .activity-item .activity-icon.info { background: #d1ecf1; color: #17a2b8; }
            
            .activity-item .activity-content {
                flex: 1;
            }
            
            .activity-item .activity-text {
                font-size: 13px;
                color: #2c3e50;
            }
            
            .activity-item .activity-time {
                font-size: 11px;
                color: #adb5bd;
                margin-top: 2px;
            }
            
            /* Empty state within sections */
            .dashboard-empty {
                text-align: center;
                padding: 30px;
                color: #adb5bd;
            }
            
            .dashboard-empty i {
                font-size: 40px;
                margin-bottom: 10px;
            }
        </style>
        
        <!-- Summary Cards Row -->
        <div class="dashboard-summary-cards">
            <div class="summary-card urgent" id="cardActionItems">
                <div class="card-icon">üî¥</div>
                <div class="card-number" id="actionItemsCount">-</div>
                <div class="card-label">Action Items</div>
            </div>
            <div class="summary-card warning" id="cardPending">
                <div class="card-icon">üü°</div>
                <div class="card-number" id="pendingCount">-</div>
                <div class="card-label">Pending</div>
            </div>
            <div class="summary-card success" id="cardCompleted">
                <div class="card-icon">üü¢</div>
                <div class="card-number" id="completedCount">-</div>
                <div class="card-label">Completed Today</div>
            </div>
            <div class="summary-card info" id="cardProjects">
                <div class="card-icon">üìä</div>
                <div class="card-number" id="activeProjectsCount">-</div>
                <div class="card-label">Active Projects</div>
            </div>
        </div>
        
        <!-- Two Column Layout for Action Items and Activity -->
        <div style="display: flex; gap: 20px; flex: 1; min-height: 0;">
            <!-- Action Items Section (Left) -->
            <div class="dashboard-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="dashboard-section-header">
                    <span class="section-icon">‚ö†Ô∏è</span>
                    <h5>Action Items</h5>
                </div>
                <div id="actionItemsList" style="flex: 1; overflow-y: auto;">
                    <!-- Action items will be populated here -->
                    <div class="dashboard-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>Loading action items...</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Section (Right) -->
            <div class="dashboard-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="dashboard-section-header">
                    <span class="section-icon">üìã</span>
                    <h5>Recent Activity</h5>
                </div>
                <div id="activityList" style="flex: 1; overflow-y: auto;">
                    <!-- Activity items will be populated here -->
                    <div class="dashboard-empty">
                        <i class="fas fa-history"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Xero Section (hidden initially, shown when Xero clicked) -->
    <div id="xeroSection" style="display: none; height: 100%; flex-direction: column;">
        
        <!-- Xero Table using allocations_layout.html -->
        <div style="flex: 1; overflow: hidden;">
            {% include 'core/components/allocations_layout.html' with section_id=xero_config.section_id main_table_columns=xero_config.main_table_columns hide_viewer=xero_config.hide_viewer hide_allocations=xero_config.hide_allocations %}
        </div>
        
        <!-- Footer Buttons -->
        <div style="display: flex; justify-content: flex-end; align-items: center; flex-shrink: 0; padding: 10px 0;">
            <button type="button" class="btn btn-light" id="addNewXeroBtn" style="border: 1px solid black;">Add New</button>
        </div>
    </div>

    <!-- Contacts Section (hidden initially, shown when Contacts clicked) -->
    <div id="contactsSection" style="display: none; height: 100%; flex-direction: column;">
        
        <!-- Xero Instance Dropdown - inline with label -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-shrink: 0;">
            <label for="contactsXeroInstanceSelect" style="margin: 0; white-space: nowrap; font-weight: bold;">Xero Instance:</label>
            <select class="form-control" id="contactsXeroInstanceSelect" style="max-width: 300px;">
                {% for instance in xero_instances %}
                    <option value="{{ instance.xero_instance_pk }}" {% if forloop.first %}selected{% endif %}>
                        {{ instance.xero_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Contacts Table using allocations_layout.html -->
        <div style="flex: 1; overflow: hidden;">
            {% include 'core/components/allocations_layout.html' with section_id=contacts_config.section_id main_table_columns=contacts_config.main_table_columns hide_viewer=contacts_config.hide_viewer hide_allocations=contacts_config.hide_allocations %}
        </div>
        
        <!-- Footer Buttons -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; padding: 10px 0;">
            <button type="button" class="btn btn-light" id="pullXeroContactsBtn" style="border: 1px solid black;">Pull/Update Xero Contacts</button>
            <button type="button" class="btn btn-light" id="addContactBtn" style="border: 1px solid black;">Add Contact</button>
        </div>
    </div>

    <!-- Project Type Config - must load before projects.html -->
    <script src="{% static 'core/js/project_type_config.js' %}"></script>
    
    <!-- Projects Section -->
    {% include 'core/projects.html' %}

    <!-- Bills Section (Content loaded via AJAX) -->
    {% include 'core/bills_global_buttons.html' %}
    
    <!-- Settings Section -->
    {% include 'core/settings.html' %}
    </div>
</div>

<!-- Old reusable table replaced above -->
<!-- {% include 'core/components/data_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %} -->

{{ ... }}
{% include 'core/xero.html' %}
{% include 'core/contacts.html' %}

<script src="{% static 'core/js/utils.js' %}"></script>
<script src="{% static 'core/js/allocations_layout.js' %}"></script>
<script src="{% static 'core/js/documents.js' %}"></script>

<script>
    $(document).ready(function() {
        // Global variable to track current Bills modal type ('inbox' or 'direct')
        var currentBillsModalType = null;
        
        // Universal function to hide all workspace sections
        window.hideAllSections = function() {
            $('#dashboardHomeSection').hide();
            $('#billsInboxSection').hide();
            $('#billsApprovalsSection').hide();
            $('#allocationsSection').hide();
            $('#contactsSection').hide();
            $('#projectsSection').hide();
            $('#xeroSection').hide();
            $('#settingsSection').hide();
            
            // Remove tender view background image and overlay
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            $('.workspace-background-overlay').remove();
        };
        
        // Function to load dashboard data
        function loadDashboardData() {
            // Load action items
            loadActionItems();
            
            // Load recent activities
            loadRecentActivities();
            
            // Load active projects count
            loadActiveProjectsCount();
        }
        
        // Function to load action items
        function loadActionItems() {
            $('#actionItemsList').html(`
                <div class="dashboard-empty">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading action items...</p>
                </div>
            `);
            
            $.ajax({
                url: '{% url "core:get_action_items" %}',
                method: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        // Update summary counts
                        $('#actionItemsCount').text(response.summary.total);
                        $('#pendingCount').text(response.summary.pending);
                        
                        if (response.action_items.length > 0) {
                            renderActionItems(response.action_items);
                        } else {
                            $('#actionItemsList').html(`
                                <div class="dashboard-empty">
                                    <i class="fas fa-check-circle"></i>
                                    <p>No action items at this time</p>
                                </div>
                            `);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load action items:', error);
                    $('#actionItemsList').html(`
                        <div class="dashboard-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load action items</p>
                        </div>
                    `);
                }
            });
        }
        
        // Function to render action items
        function renderActionItems(items) {
            var html = '';
            
            items.forEach(function(item) {
                var subtitle = item.subtitle ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${item.subtitle}</div>` : '';
                
                html += `
                    <div class="action-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                        <div class="action-icon" style="width: 40px; height: 40px; border-radius: 8px; background-color: ${item.color}20; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="${item.icon}" style="color: ${item.color}; font-size: 16px;"></i>
                        </div>
                        <div class="action-content" style="flex: 1; min-width: 0;">
                            <div class="action-title" style="font-size: 13px; font-weight: 600; color: #333;">${item.title}</div>
                            ${subtitle}
                            <div class="action-message" style="font-size: 11px; color: #888; margin-top: 3px;">${item.message}</div>
                        </div>
                        <div class="action-count" style="background-color: ${item.color}15; color: ${item.color}; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; margin-right: 10px;">
                            ${item.count}
                        </div>
                        <button class="btn btn-sm" style="background-color: ${item.color}; color: white; font-size: 11px; padding: 6px 12px; border: none; border-radius: 6px; white-space: nowrap;" onclick="handleActionItemClick('${item.action_type}', ${item.project_pk || 'null'})">
                            ${item.action} <i class="fas fa-arrow-right" style="margin-left: 4px; font-size: 10px;"></i>
                        </button>
                    </div>
                `;
            });
            
            $('#actionItemsList').html(html);
        }
        
        // Function to handle action item clicks (global for onclick handlers)
        window.handleActionItemClick = function(actionType, projectPk) {
            switch(actionType) {
                case 'bills_inbox':
                    // Navigate to Bills > Inbox
                    $('#billsLink').click();
                    setTimeout(function() {
                        $('.btn-outline-secondary:contains("Inbox")').click();
                    }, 100);
                    break;
                case 'bills_approvals':
                    // Navigate to Bills > Approvals
                    $('#billsLink').click();
                    setTimeout(function() {
                        $('.btn-outline-primary:contains("Approvals")').click();
                    }, 100);
                    break;
                case 'project_bills':
                    // Navigate to project's Bills > Unallocated
                    navigateToProjectSection(projectPk, 'bills', 'unallocated');
                    break;
                case 'project_allocated':
                    // Navigate to project's Bills > Allocated
                    navigateToProjectSection(projectPk, 'bills', 'allocated');
                    break;
                case 'po_claims':
                    // Navigate to project's POs section
                    navigateToProjectSection(projectPk, 'pos', null);
                    break;
                default:
                    console.log('Unknown action type:', actionType);
            }
        };
        
        // Navigate to a project section within the SPA
        function navigateToProjectSection(projectPk, section, subsection) {
            if (!projectPk) {
                console.error('No project PK provided');
                return;
            }
            
            // Store the target navigation for after project loads
            window.pendingProjectNavigation = {
                section: section,
                subsection: subsection
            };
            
            // First, click on Projects link
            $('#projectsLink').click();
            
            // Wait for projects to load, then find and click the project
            setTimeout(function() {
                // Find the project card with matching pk
                var projectCard = $(`.project-card[data-project-pk="${projectPk}"]`);
                
                if (projectCard.length) {
                    // Click the construction link to open the project
                    projectCard.find('.construction-link').click();
                    
                    // After project view opens, navigate to the target section
                    setTimeout(function() {
                        if (section === 'bills') {
                            // Click on bills button group
                            $('#billsButtonGroup .bills-main-btn').click();
                            
                            // Then click the specific subsection
                            setTimeout(function() {
                                if (subsection === 'unallocated') {
                                    $('#billsButtonGroup .btn:contains("Unallocated")').click();
                                } else if (subsection === 'allocated') {
                                    $('#billsButtonGroup .btn:contains("Allocated")').click();
                                }
                            }, 100);
                        } else if (section === 'pos') {
                            // Click on POs button
                            $('.construction-nav-btn[data-section="pos"]').click();
                        } else if (section === 'quotes') {
                            $('.construction-nav-btn[data-section="quotes"]').click();
                        }
                        
                        // Clear pending navigation
                        window.pendingProjectNavigation = null;
                    }, 300);
                } else {
                    console.error('Project card not found for pk:', projectPk);
                    alert('Project not found. It may have been archived.');
                }
            }, 500);
        }
        
        // Function to load active projects count
        function loadActiveProjectsCount() {
            // For now, just count all projects
            $.ajax({
                url: '/core/get_projects/',
                method: 'GET',
                success: function(response) {
                    if (response.projects) {
                        $('#activeProjectsCount').text(response.projects.length);
                    }
                },
                error: function() {
                    $('#activeProjectsCount').text('0');
                }
            });
            
            // Completed today placeholder
            $('#completedCount').text('0');
        }
        
        // Function to load recent activities
        function loadRecentActivities() {
            $('#activityList').html(`
                <div class="dashboard-empty">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading activity...</p>
                </div>
            `);
            
            $.ajax({
                url: '{% url "core:get_recent_activities" %}',
                method: 'GET',
                success: function(response) {
                    if (response.status === 'success' && response.activities.length > 0) {
                        renderActivities(response.activities);
                    } else {
                        $('#activityList').html(`
                            <div class="dashboard-empty">
                                <i class="fas fa-history"></i>
                                <p>No recent activity</p>
                            </div>
                        `);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load activities:', error);
                    $('#activityList').html(`
                        <div class="dashboard-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load activity</p>
                        </div>
                    `);
                }
            });
        }
        
        // Function to render activity items
        function renderActivities(activities) {
            var html = '';
            
            activities.forEach(function(activity) {
                var timeAgo = formatTimeAgo(activity.timestamp);
                
                html += `
                    <div class="activity-item" style="display: flex; align-items: flex-start; padding: 10px 12px; border-bottom: 1px solid #eee; cursor: ${activity.link ? 'pointer' : 'default'};" ${activity.link ? 'onclick="window.location.href=\'' + activity.link + '\'"' : ''}>
                        <div class="activity-icon" style="width: 32px; height: 32px; border-radius: 50%; background-color: ${activity.color}20; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="${activity.icon}" style="color: ${activity.color}; font-size: 14px;"></i>
                        </div>
                        <div class="activity-content" style="flex: 1; min-width: 0;">
                            <div class="activity-message" style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 2px;">${activity.message}</div>
                            <div class="activity-detail" style="font-size: 11px; color: #666;">${activity.detail}</div>
                        </div>
                        <div class="activity-time" style="font-size: 11px; color: #999; white-space: nowrap; margin-left: 8px;">${timeAgo}</div>
                    </div>
                `;
            });
            
            $('#activityList').html(html);
        }
        
        // Helper function to format timestamp as "time ago"
        function formatTimeAgo(isoTimestamp) {
            if (!isoTimestamp) return '';
            
            var date = new Date(isoTimestamp);
            var now = new Date();
            var diffMs = now - date;
            var diffMins = Math.floor(diffMs / 60000);
            var diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            
            // Format as date if older than 24h
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }
        
        // Initialize dashboard on page load
        $('#dynamicContentArea').addClass('has-content');
        loadDashboardData();
        
        // Handle navbar dropdown toggle
        $('.nav-dropdown-toggle').click(function(e) {
            e.preventDefault();
            var menu = $(this).siblings('.nav-dropdown-menu');
            var dropdown = $(this).closest('.nav-dropdown');
            menu.toggleClass('show');
            dropdown.toggleClass('open');
        });
        
        // Dashboard link - shows dashboard home with alerts/activity
        $('#dashboardLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show dashboard home section
            $('#dashboardHomeSection').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Load dashboard data (to be implemented)
            loadDashboardData();
            
            // Clear any selected bills
            currentSelectedBillPk = null;
            $('#billsTableBody').empty();
            $('#allocationsTableBody').empty();
            $('#billViewer').hide();
            $('#viewerPlaceholder').show();
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Xero controller - shows inline in workspace
        $('#xeroLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show Xero section and add has-content class to hide background
            $('#xeroSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Load Xero instances
            if (typeof loadXeroInstances === 'function') {
                loadXeroInstances();
            }
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Contacts controller - shows inline in workspace
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show contacts section and add has-content class to hide background
            $('#contactsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Load contacts for the selected Xero instance
            const instancePk = $('#contactsXeroInstanceSelect').val();
            if (instancePk && typeof loadContacts === 'function') {
                loadContacts(instancePk);
            }
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Settings controller - shows inline in workspace
        $('#settingsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show settings section and add has-content class to hide background
            $('#settingsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Handle Xero instance change in workspace contacts dropdown
        $(document).on('change', '#contactsXeroInstanceSelect', function() {
            const instancePk = $(this).val();
            if (instancePk && typeof loadContacts === 'function') {
                loadContacts(instancePk);
            }
        });
        
        // Toggle Database Wipe Button visibility with SHIFT+BIN sequence
        let binSequence = [];
        const BIN_SEQUENCE = ['b', 'i', 'n'];
        let shiftHeld = false;
        
        $(document).on('keydown', function(e) {
            // Track shift key
            if (e.key === 'Shift') {
                shiftHeld = true;
                binSequence = []; // Reset sequence when shift is pressed
                return;
            }
            
            // Only track keys while shift is held
            if (!shiftHeld) {
                binSequence = [];
                return;
            }
            
            const key = e.key.toLowerCase();
            binSequence.push(key);
            
            // Check if sequence matches so far
            for (let i = 0; i < binSequence.length; i++) {
                if (binSequence[i] !== BIN_SEQUENCE[i]) {
                    binSequence = [];
                    return;
                }
            }
            
            // Check if full sequence is complete (SHIFT+B+I+N)
            if (binSequence.length === BIN_SEQUENCE.length) {
                e.preventDefault();
                $('#wipeDbBtn').toggleClass('visible');
                binSequence = [];
            }
        });
        
        $(document).on('keyup', function(e) {
            if (e.key === 'Shift') {
                shiftHeld = false;
                binSequence = [];
            }
        });
        
        // Database Wipe Button Handler
        $('#wipeDbBtn').click(function() {
            // First confirmation
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL data from the database!\n\nThis includes:\n‚Ä¢ All projects\n‚Ä¢ All quotes and allocations\n‚Ä¢ All bills and bills\n‚Ä¢ All contacts\n‚Ä¢ All documents\n‚Ä¢ All claims and variations\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to continue?')) {
                return;
            }
            
            // Second confirmation (type to confirm)
            const confirmText = prompt('To confirm, type "DELETE ALL DATA" (in capital letters):');
            if (confirmText !== 'DELETE ALL DATA') {
                alert('Confirmation text did not match. Database wipe cancelled.');
                return;
            }
            
            // Show loading state
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Send request to wipe database
            fetch('/core/wipe_database/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úì Database wiped successfully!\n\n' + data.tables_wiped + ' tables were cleared.\n\nThe page will now reload.');
                    // Reload the page
                    window.location.reload();
                } else {
                    alert('‚úó Error wiping database:\n\n' + data.message);
                    $('#wipeDbBtn').prop('disabled', false).html('<i class="fas fa-trash-alt"></i>');
                }
            })
            .catch(error => {
                console.error('Error wiping database:', error);
                alert('‚úó Error wiping database:\n\n' + error);
                $('#wipeDbBtn').prop('disabled', false).html('<i class="fas fa-trash-alt"></i>');
            });
        });
    });
</script>

{% endblock %}
