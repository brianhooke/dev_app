{% extends "core/dashboard_master.html" %}
{% load static %}
{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Add styles for background image */
        body {
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static "core/media/background_reduced.png" %}');
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Makes the image greyed out */
            z-index: -1; /* Puts it behind all content */
            pointer-events: none; /* Prevents interference with clicks */
        }
    </style>
</head>

<div style="position: relative;">
    <h3 style="text-align: center;">Project <img src="{% static 'core/images/logo.png' %}" alt="Icon" style="height: 1.6em; vertical-align: middle; position: relative; bottom: 0.3em;">anagement App</h3>
    <div style="position: absolute; top: 0; right: 20px; font-size: 12px; color: #666;">v31</div>
</div>

<div style="padding: 20px;">
    <h4>Welcome to the Project Management Dashboard</h4>
    <p>This is your central hub for managing all projects.</p>
</div>

{% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %}

{% include 'core/xero_modals.html' %}
{% include 'core/contacts.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>

<script>
    $(document).ready(function() {
        let showArchiveColumn = false;
        
        // Function to load contacts for selected instance
        function loadContacts(instancePk) {
            if (!instancePk) {
                // Clear table if no instance selected
                const colspan = showArchiveColumn ? 3 : 2;
                $('#contactsModal tbody').html(`<tr><td colspan="${colspan}" style="text-align: center;">Please select a Xero instance</td></tr>`);
                return;
            }
            
            fetch(`/get_contacts_by_instance/${instancePk}/`)
                .then(response => response.json())
                .then(contacts => {
                    const tbody = $('#contactsModal tbody');
                    tbody.empty();
                    
                    if (contacts.length === 0) {
                        const colspan = showArchiveColumn ? 3 : 2;
                        tbody.html(`<tr><td colspan="${colspan}" style="text-align: center;">No contacts found. Click "Pull Xero Contacts" to import.</td></tr>`);
                    } else {
                        contacts.forEach(contact => {
                            const isArchived = contact.status !== 'ACTIVE';
                            const greyedStyle = isArchived ? 'color: #999; opacity: 0.6;' : '';
                            
                            let row = `<tr data-contact='${JSON.stringify(contact)}' data-contact-pk="${contact.contact_pk}" style="${greyedStyle}">`;
                            
                            if (showArchiveColumn) {
                                row += `<td><input type="checkbox" class="archive-checkbox" ${isArchived ? 'checked' : ''}></td>`;
                            }
                            
                            row += `
                                <td>${contact.name || ''}</td>
                                <td>${contact.email || ''}</td>
                            </tr>`;
                            
                            tbody.append(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const colspan = showArchiveColumn ? 3 : 2;
                    $('#contactsModal tbody').html(`<tr><td colspan="${colspan}" style="text-align: center; color: red;">Error loading contacts</td></tr>`);
                });
        }
        
        // Toggle Archive column visibility
        function toggleArchiveColumn() {
            showArchiveColumn = !showArchiveColumn;
            const thead = $('#contactsModal thead tr');
            
            if (showArchiveColumn) {
                // Add Archived column header
                thead.prepend('<th>Archived</th>');
            } else {
                // Remove Archived column header
                thead.find('th:first').remove();
            }
            
            // Reload contacts to update table
            const instancePk = $('#xeroInstanceSelect').val();
            loadContacts(instancePk);
        }
        
        // Open Contacts modal when navbar link is clicked
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            $('#contactsModal').modal('show');
        });
        
        // Load contacts when modal is shown
        $('#contactsModal').on('shown.bs.modal', function() {
            const instancePk = $('#xeroInstanceSelect').val();
            loadContacts(instancePk);
        });
        
        // Reload contacts when dropdown changes
        $(document).on('change', '#xeroInstanceSelect', function() {
            const instancePk = $(this).val();
            loadContacts(instancePk);
        });
        
        // Archive button handler - toggle Archive column
        $(document).on('click', '#archiveContactBtn', function() {
            toggleArchiveColumn();
        });
        
        // Handle archive checkbox changes
        $(document).on('change', '.archive-checkbox', function() {
            const checkbox = $(this);
            const row = checkbox.closest('tr');
            const contactPk = row.data('contact-pk');
            const instancePk = $('#xeroInstanceSelect').val();
            const archive = checkbox.is(':checked');
            
            // Disable checkbox during request
            checkbox.prop('disabled', true);
            
            // Keep current visual state (greyed or not) until success
            const currentStyle = row.attr('style') || '';
            
            // Make AJAX call to update status in Xero
            fetch(`/update_contact_status/${instancePk}/${contactPk}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ archive: archive })
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                console.log('Response status:', status);
                console.log('Response body:', body);
                
                // Handle OAuth authorization needed
                if (status === 401 && body.needs_auth) {
                    checkbox.prop('checked', !archive);
                    checkbox.prop('disabled', false);
                    
                    if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                        window.location.href = `/xero_oauth_authorize/${instancePk}/`;
                    }
                    return;
                }
                
                if (status !== 200) {
                    throw new Error(body.message || `HTTP error! status: ${status}`);
                }
                
                if (body.status === 'success') {
                    // Update visual state after success
                    if (archive) {
                        row.attr('style', 'color: #999; opacity: 0.6;');
                    } else {
                        row.attr('style', '');
                    }
                    
                    // Update contact data in row
                    const contact = JSON.parse(row.attr('data-contact'));
                    contact.status = body.new_status;
                    row.attr('data-contact', JSON.stringify(contact));
                    
                    checkbox.prop('disabled', false);
                } else {
                    throw new Error(body.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error updating contact status:', error);
                
                // Revert checkbox on error
                checkbox.prop('checked', !archive);
                checkbox.prop('disabled', false);
                
                // Show timeout/error alert
                if (error.message.includes('408') || error.message.includes('timeout')) {
                    alert('Request timed out. The Xero API is not responding. Please try again.');
                } else if (error.message.includes('503') || error.message.includes('Connection')) {
                    alert('Connection error. Cannot reach Xero API. Please check your internet connection.');
                } else {
                    alert(`Failed to update contact status: ${error.message}`);
                }
            });
        });
        
        // Pull Xero Contacts button handler
        $(document).on('click', '#pullXeroContactsBtn', function() {
            const xeroInstancePk = $('#xeroInstanceSelect').val();
            
            if (!xeroInstancePk) {
                alert('Please select a Xero instance');
                return;
            }
            
            // Disable button and show loading state
            const button = $(this);
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Pulling Contacts...');
            
            fetch(`/pull_xero_contacts/${xeroInstancePk}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                // Handle OAuth authorization needed
                if (status === 401 && body.needs_auth) {
                    button.prop('disabled', false).html('Pull Xero Contacts');
                    if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                        window.location.href = `/xero_oauth_authorize/${xeroInstancePk}/`;
                    }
                    return;
                }
                
                if (body.status === 'success') {
                    alert(`Success! ${body.details.new_contacts_added} new contacts added, ${body.details.existing_contacts_skipped} existing contacts skipped.`);
                    // Reload contacts table instead of page reload
                    loadContacts(xeroInstancePk);
                    button.prop('disabled', false).html('Pull Xero Contacts');
                } else {
                    alert(`Error: ${body.message}`);
                    button.prop('disabled', false).html('Pull Xero Contacts');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to pull contacts. Please try again.');
                button.prop('disabled', false).html('Pull Xero Contacts');
            });
        });
    });
</script>

{% endblock %}
