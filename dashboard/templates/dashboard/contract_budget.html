<!-- Contract Budget Template -->
<style>
    .contract-budget-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 20px 20px 0 20px;
        position: relative;
    }
    
    .contract-budget-container .table-wrapper {
        flex: 1;
        overflow-y: auto;
        position: relative;
    }
    
    
    /* Category row styling */
    .contract-budget-container .reusable-table tr.category-row {
        background-color: #f9f9f9;
        font-weight: 600;
        color: #495057;
    }
    
    .contract-budget-container .reusable-table tr.category-row:hover {
        background-color: #ececec;
    }
    
    /* Internal category styling - purple */
    .contract-budget-container .reusable-table tr.category-row.internal-category {
        background-color: #e6d5f5;
        color: #6f2da8;
    }
    
    .contract-budget-container .reusable-table tr.category-row.internal-category:hover {
        background-color: #d9c5ed;
    }
    
    .contract-budget-container .reusable-table tr.item-row.internal-item {
        color: #6f2da8;
    }
    
    .contract-budget-container .reusable-table tr.item-row.internal-item td {
        color: #6f2da8;
    }
    
    /* Item row indent */
    .contract-budget-container .reusable-table td.indent {
        padding-left: 30px;
    }
    
    /* Compact inputs for contract budget */
    .contract-budget-container .reusable-table input[type="number"] {
        width: 100%;
        padding: 3px 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 11px;
        text-align: right;
    }
    
    .contract-budget-container .reusable-table input[type="number"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .contract-budget-container .reusable-table .budget-amount {
        text-align: right;
        font-weight: 500;
    }
    
    .contract-budget-container .reusable-table .committed-amount {
        text-align: right;
        color: #6c757d;
    }
    
    /* Totals row styling - fixed at bottom */
    .contract-budget-container .totals-row {
        display: flex;
        background: var(--gradient-primary);
        color: white;
        font-weight: bold;
        border-top: 2px solid #dee2e6;
        border-radius: 0 0 8px 8px;
        flex-shrink: 0;
    }
    
    .contract-budget-container .totals-row > div {
        padding: 6px 6px;
        text-align: right;
        font-size: 12px;
    }
    
    .contract-budget-container .totals-row > div:first-child {
        text-align: left;
    }
    
    .contract-budget-container .totals-row > div {
        padding: 6px 6px;
        text-align: right;
        font-size: 12px;
    }
</style>

<div class="contract-budget-container">
    <div class="table-wrapper">
        <table class="reusable-table" id="contractBudgetTable">
            <thead id="contractBudgetTableHead">
                <!-- Table headers will be rendered by JavaScript based on project type -->
            </thead>
            <tbody id="contractBudgetTableBody">
                <tr>
                    <td colspan="4" style="text-align: center; color: #6c757d; padding: 20px;">
                        Loading...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="totals-row" id="totalsRow">
        <!-- Totals will be rendered by JavaScript based on project type -->
    </div>
</div>

<script>
(function() {
    'use strict';
    
    console.log('Contract Budget script loaded');
    
    // Initialize Contract Budget when loaded - use setTimeout to ensure DOM is ready
    setTimeout(function() {
        if (window.currentContractBudgetProject && window.currentContractBudgetProject.pk) {
            console.log('Initializing contract budget for project:', window.currentContractBudgetProject.pk, 'in container:', window.currentContractBudgetContainer);
            loadContractBudget(window.currentContractBudgetProject.pk);
        } else {
            // No project selected yet - this is normal on page load
            console.log('Contract Budget waiting for project selection...');
        }
    }, 100);
    
    function renderTableHeaders(isConstruction) {
        var thead = $(window.currentContractBudgetContainer + ' #contractBudgetTableHead');
        thead.empty();
        
        var headerRow = $('<tr></tr>');
        
        if (isConstruction) {
            // Construction: Category/Item | Unit | Contract Budget | Uncommitted (Qty | Rate | Amount) | Committed
            headerRow.append('<th>Category / Item</th>');
            headerRow.append('<th>Unit</th>');
            headerRow.append('<th>Contract Budget</th>');
            headerRow.append('<th>Qty</th>');
            headerRow.append('<th>Rate</th>');
            headerRow.append('<th>Amount</th>');
            headerRow.append('<th>Committed</th>');
        } else {
            // Non-construction: Category/Item | Contract Budget | Uncommitted | Committed
            headerRow.append('<th>Category / Item</th>');
            headerRow.append('<th>Contract Budget</th>');
            headerRow.append('<th>Uncommitted</th>');
            headerRow.append('<th>Committed</th>');
        }
        
        thead.append(headerRow);
    }
    
    function renderTotalsRow(isConstruction) {
        var totalsRow = $(window.currentContractBudgetContainer + ' #totalsRow');
        totalsRow.empty();
        
        if (isConstruction) {
            // Construction: Label | Unit (empty) | Contract Budget | Qty (empty) | Rate (empty) | Amount | Committed
            totalsRow.append('<div style="width: 25%;"><strong>TOTALS</strong></div>');
            totalsRow.append('<div style="width: 8%;"></div>'); // Empty Unit
            totalsRow.append('<div style="width: 15%;" id="totalContractBudget">$0.00</div>');
            totalsRow.append('<div style="width: 10%;"></div>'); // Empty Qty
            totalsRow.append('<div style="width: 10%;"></div>'); // Empty Rate
            totalsRow.append('<div style="width: 12%;" id="totalUncommittedAmount">$0.00</div>');
            totalsRow.append('<div style="width: 15%;" id="totalCommitted">$0.00</div>');
        } else {
            // Non-construction: Label | Contract Budget | Uncommitted | Committed
            totalsRow.append('<div style="width: 40%;"><strong>TOTALS</strong></div>');
            totalsRow.append('<div style="width: 20%;" id="totalContractBudget">$0.00</div>');
            totalsRow.append('<div style="width: 20%;" id="totalUncommitted">$0.00</div>');
            totalsRow.append('<div style="width: 20%;" id="totalCommitted">$0.00</div>');
        }
    }
    
    function loadContractBudget(projectPk) {
        console.log('Loading contract budget for project:', projectPk);
        
        // Determine if construction project
        var isConstruction = window.currentContractBudgetProject && window.currentContractBudgetProject.project_type === 'construction';
        console.log('Is construction project:', isConstruction);
        
        // Render headers and totals row based on project type
        renderTableHeaders(isConstruction);
        renderTotalsRow(isConstruction);
        
        // Load categories, items, and committed amounts
        $.ajax({
            url: '/get_project_categories/' + projectPk + '/',
            type: 'GET',
            success: function(categoriesResponse) {
                console.log('Categories loaded:', categoriesResponse);
                
                // Load items
                $.ajax({
                    url: '/get_project_items/' + projectPk + '/',
                    type: 'GET',
                    success: function(itemsResponse) {
                        console.log('Items loaded:', itemsResponse);
                        
                        // Load committed amounts
                        $.ajax({
                            url: '/core/get_project_committed_amounts/' + projectPk + '/',
                            type: 'GET',
                            success: function(committedResponse) {
                                console.log('Committed amounts loaded:', committedResponse);
                                renderContractBudgetTable(
                                    categoriesResponse.categories, 
                                    itemsResponse.items,
                                    committedResponse.committed_amounts || {},
                                    isConstruction
                                );
                            },
                            error: function(xhr, status, error) {
                                console.error('Error loading committed amounts:', error);
                                // Still render table with empty committed amounts
                                renderContractBudgetTable(
                                    categoriesResponse.categories, 
                                    itemsResponse.items,
                                    {},
                                    isConstruction
                                );
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading items:', error);
                        var colspan = isConstruction ? 7 : 4;
                        $(window.currentContractBudgetContainer + ' #contractBudgetTableBody').html('<tr><td colspan="' + colspan + '" style="text-align: center; color: #dc3545; padding: 20px;">Error loading items</td></tr>');
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error loading categories:', error);
                var colspan = isConstruction ? 7 : 4;
                $(window.currentContractBudgetContainer + ' #contractBudgetTableBody').html('<tr><td colspan="' + colspan + '" style="text-align: center; color: #dc3545; padding: 20px;">Error loading categories</td></tr>');
            }
        });
    }
    
    function renderContractBudgetTable(categories, items, committedAmounts, isConstruction) {
        console.log('renderContractBudgetTable called, isConstruction:', isConstruction);
        console.log('Categories:', categories);
        console.log('Items:', items);
        console.log('Committed amounts:', committedAmounts);
        
        // Target tbody within current container to avoid template storage
        var tbody = $(window.currentContractBudgetContainer + ' #contractBudgetTableBody');
        console.log('Found tbody in', window.currentContractBudgetContainer, ':', tbody.length > 0);
        
        tbody.empty();
        
        var colspan = isConstruction ? 7 : 4;
        
        if (!categories || categories.length === 0) {
            console.log('No categories found');
            tbody.html('<tr><td colspan="' + colspan + '" style="text-align: center; color: #6c757d; padding: 20px;">No categories yet. Add categories and items in the Items section first.</td></tr>');
            return;
        }
        
        console.log('Rendering', categories.length, 'categories');
        
        // Sort categories by order_in_list
        categories.sort(function(a, b) {
            return a.order_in_list - b.order_in_list;
        });
        
        // Render each category and its items
        categories.forEach(function(category) {
            // Check if this is the Internal category
            var isInternal = category.category === 'Internal';
            
            // Render category row
            var categoryRow = $('<tr class="category-row"></tr>');
            if (isInternal) {
                categoryRow.addClass('internal-category');
            }
            categoryRow.append('<td><strong>' + escapeHtml(category.category) + '</strong></td>');
            
            if (isConstruction) {
                // Construction: Category/Item | Unit | Contract Budget | Qty | Rate | Amount | Committed
                categoryRow.append('<td>-</td>'); // Unit
                categoryRow.append('<td class="budget-amount">-</td>'); // Contract Budget
                categoryRow.append('<td>-</td>'); // Qty
                categoryRow.append('<td>-</td>'); // Rate
                categoryRow.append('<td>-</td>'); // Amount
                categoryRow.append('<td class="committed-amount">-</td>'); // Committed
            } else {
                // Non-construction: Category/Item | Contract Budget | Uncommitted | Committed
                categoryRow.append('<td class="budget-amount">-</td>');
                categoryRow.append('<td>-</td>');
                categoryRow.append('<td class="committed-amount">-</td>');
            }
            
            tbody.append(categoryRow);
            
            // Get items for this category
            var categoryItems = items.filter(function(item) {
                return item.category__category === category.category;
            });
            
            // Sort items by order_in_list
            categoryItems.sort(function(a, b) {
                return a.order_in_list - b.order_in_list;
            });
            
            // Render item rows
            categoryItems.forEach(function(item) {
                var itemRow = $('<tr class="item-row"></tr>');
                
                // Add internal-item class if this is an Internal category item
                if (isInternal) {
                    itemRow.addClass('internal-item');
                    itemRow.attr('data-is-internal', 'true');
                }
                
                // Category / Item column with indent
                itemRow.append('<td class="indent">' + escapeHtml(item.item) + '</td>');
                
                // Unit column (construction only)
                if (isConstruction) {
                    var unitCell = $('<td></td>');
                    unitCell.text(item.unit || '-');
                    itemRow.append(unitCell);
                }
                
                // Contract Budget column (calculated: Uncommitted + Committed)
                var budgetCell = $('<td class="budget-amount"></td>');
                budgetCell.attr('data-item-pk', item.costing_pk);
                budgetCell.text('$0.00');
                itemRow.append(budgetCell);
                
                // Uncommitted columns
                if (isConstruction) {
                    // Construction: Qty | Rate | Amount (Amount = Qty × Rate)
                    if (isInternal) {
                        // Internal items: show dashes
                        itemRow.append('<td>-</td>'); // Qty
                        itemRow.append('<td>-</td>'); // Rate
                        itemRow.append('<td>-</td>'); // Amount
                    } else {
                        // Regular items: editable Qty and Rate, calculated Amount
                        
                        // Qty input
                        var qtyCell = $('<td></td>');
                        var qtyInput = $('<input type="number" step="0.01" min="0" placeholder="0.00" class="uncommitted-qty">');
                        qtyInput.attr('data-item-pk', item.costing_pk);
                        if (item.uncommitted_qty !== undefined && item.uncommitted_qty !== null) {
                            qtyInput.val(parseFloat(item.uncommitted_qty).toFixed(2));
                        }
                        qtyInput.on('input', function() {
                            updateUncommittedAmount(item.costing_pk);
                            updateContractBudget(item.costing_pk);
                            updateTotals();
                        });
                        qtyInput.on('blur', function() {
                            saveUncommittedConstruction(item.costing_pk);
                        });
                        qtyCell.append(qtyInput);
                        itemRow.append(qtyCell);
                        
                        // Rate input
                        var rateCell = $('<td></td>');
                        var rateInput = $('<input type="number" step="0.01" min="0" placeholder="0.00" class="uncommitted-rate">');
                        rateInput.attr('data-item-pk', item.costing_pk);
                        if (item.uncommitted_rate !== undefined && item.uncommitted_rate !== null) {
                            rateInput.val(parseFloat(item.uncommitted_rate).toFixed(2));
                        }
                        rateInput.on('input', function() {
                            updateUncommittedAmount(item.costing_pk);
                            updateContractBudget(item.costing_pk);
                            updateTotals();
                        });
                        rateInput.on('blur', function() {
                            saveUncommittedConstruction(item.costing_pk);
                        });
                        rateCell.append(rateInput);
                        itemRow.append(rateCell);
                        
                        // Amount (calculated, read-only display)
                        var amountCell = $('<td class="uncommitted-amount"></td>');
                        amountCell.attr('data-item-pk', item.costing_pk);
                        amountCell.text('$0.00');
                        itemRow.append(amountCell);
                    }
                } else {
                    // Non-construction: Single Uncommitted input
                    var uncommittedCell = $('<td></td>');
                    if (isInternal) {
                        // For Internal items, show '-' (not editable)
                        uncommittedCell.text('-');
                        uncommittedCell.attr('data-item-pk', item.costing_pk);
                    } else {
                        // For regular items, editable input
                        var uncommittedInput = $('<input type="number" step="0.01" min="0" placeholder="0.00">');
                        uncommittedInput.attr('data-item-pk', item.costing_pk);
                        
                        // Set initial value from database (if exists, including 0)
                        if (item.uncommitted_amount !== undefined && item.uncommitted_amount !== null) {
                            uncommittedInput.val(parseFloat(item.uncommitted_amount).toFixed(2));
                        }
                        
                        uncommittedInput.on('input', function() {
                            // Enforce 2 decimal places
                            var value = $(this).val();
                            if (value && value.indexOf('.') !== -1) {
                                var parts = value.split('.');
                                if (parts[1].length > 2) {
                                    $(this).val(parseFloat(value).toFixed(2));
                                }
                            }
                            // Update Contract Budget and totals
                            updateContractBudget(item.costing_pk);
                            updateTotals();
                        });
                        
                        // Blur event to save to backend
                        uncommittedInput.on('blur', function() {
                            var newUncommitted = parseFloat($(this).val()) || 0;
                            saveUncommitted(item.costing_pk, newUncommitted);
                        });
                        
                        uncommittedCell.append(uncommittedInput);
                    }
                    itemRow.append(uncommittedCell);
                }
                
                // Committed column
                var committedAmount = committedAmounts[item.costing_pk] || 0;
                var committedCell = $('<td class="committed-amount"></td>');
                committedCell.attr('data-item-pk', item.costing_pk);
                committedCell.attr('data-committed-amount', committedAmount);
                
                if (isInternal) {
                    // For Internal items, committed is editable via input
                    var committedInput = $('<input type="number" step="0.01" min="0" placeholder="0.00" class="committed-input">');
                    committedInput.attr('data-item-pk', item.costing_pk);
                    committedInput.val(committedAmount > 0 ? committedAmount.toFixed(2) : '');
                    committedInput.on('input', function() {
                        // Enforce 2 decimal places
                        var value = $(this).val();
                        if (value && value.indexOf('.') !== -1) {
                            var parts = value.split('.');
                            if (parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                        // Update committed amount in data attribute
                        var newCommitted = parseFloat($(this).val()) || 0;
                        committedCell.attr('data-committed-amount', newCommitted);
                        // Update Contract Budget and totals
                        updateContractBudget(item.costing_pk);
                        updateTotals();
                    });
                    
                    // Blur event to save to backend
                    committedInput.on('blur', function() {
                        var newCommitted = parseFloat($(this).val()) || 0;
                        saveInternalCommitted(item.costing_pk, newCommitted);
                    });
                    
                    committedCell.append(committedInput);
                } else {
                    // For regular items, committed is read-only
                    committedCell.text('$' + committedAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
                }
                
                itemRow.append(committedCell);
                
                tbody.append(itemRow);
                
                // Initial calculations
                if (isConstruction && !isInternal) {
                    // For construction projects, calculate initial uncommitted amount
                    updateUncommittedAmount(item.costing_pk);
                }
                updateContractBudget(item.costing_pk);
            });
        });
        
        // Calculate initial totals
        updateTotals();
    }
    
    function updateUncommittedAmount(itemPk) {
        // For construction projects: calculate Amount = Qty × Rate
        var qtyInput = $('input.uncommitted-qty[data-item-pk="' + itemPk + '"]');
        var rateInput = $('input.uncommitted-rate[data-item-pk="' + itemPk + '"]');
        var amountCell = $('td.uncommitted-amount[data-item-pk="' + itemPk + '"]');
        
        var qty = parseFloat(qtyInput.val()) || 0;
        var rate = parseFloat(rateInput.val()) || 0;
        var amount = qty * rate;
        
        amountCell.text('$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
        amountCell.attr('data-amount', amount);
    }
    
    function updateContractBudget(itemPk) {
        // Check if this is an Internal item
        var itemRow = $('tr.item-row').filter(function() {
            return $(this).find('[data-item-pk="' + itemPk + '"]').length > 0;
        });
        var isInternal = itemRow.attr('data-is-internal') === 'true';
        
        // Determine if construction project
        var isConstruction = window.currentContractBudgetProject && window.currentContractBudgetProject.project_type === 'construction';
        
        var uncommitted = 0;
        var committed = 0;
        
        if (isInternal) {
            // For Internal items: uncommitted is always 0, get committed from input value
            var committedInput = $('input.committed-input[data-item-pk="' + itemPk + '"]');
            committed = parseFloat(committedInput.val()) || 0;
        } else {
            // For regular items: get uncommitted value
            if (isConstruction) {
                // Construction: get from calculated amount cell
                var amountCell = $('td.uncommitted-amount[data-item-pk="' + itemPk + '"]');
                uncommitted = parseFloat(amountCell.attr('data-amount')) || 0;
            } else {
                // Non-construction: get from input field
                var uncommittedInput = $('input[type="number"][data-item-pk="' + itemPk + '"]').not('.committed-input').not('.uncommitted-qty').not('.uncommitted-rate');
                uncommitted = parseFloat(uncommittedInput.val()) || 0;
            }
            
            var committedCell = $('td.committed-amount[data-item-pk="' + itemPk + '"]');
            committed = parseFloat(committedCell.attr('data-committed-amount')) || 0;
        }
        
        // Calculate contract budget
        var contractBudget = uncommitted + committed;
        
        // Update Contract Budget cell
        var budgetCell = $('td.budget-amount[data-item-pk="' + itemPk + '"]');
        budgetCell.text('$' + contractBudget.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
    }
    
    function updateTotals() {
        var totalContractBudget = 0;
        var totalUncommitted = 0;
        var totalCommitted = 0;
        
        // Determine if construction project
        var isConstruction = window.currentContractBudgetProject && window.currentContractBudgetProject.project_type === 'construction';
        
        // Sum up only item rows (not category rows) - target the one in current container
        var itemRows = $(window.currentContractBudgetContainer + ' #contractBudgetTableBody tr.item-row');
        console.log('updateTotals: found', itemRows.length, 'item rows in', window.currentContractBudgetContainer);
        
        itemRows.each(function() {
            var isInternal = $(this).attr('data-is-internal') === 'true';
            
            // Contract Budget - parse from text content
            var budgetText = $(this).find('.budget-amount').text().replace(/[$,]/g, '');
            var budgetAmount = parseFloat(budgetText) || 0;
            totalContractBudget += budgetAmount;
            
            // Uncommitted - handle '-' as 0 for Internal items
            var uncommittedAmount = 0;
            if (isInternal) {
                // Internal items show '-' in uncommitted, treat as 0
                uncommittedAmount = 0;
            } else {
                if (isConstruction) {
                    // Construction: get amount from calculated cell
                    var amountCell = $(this).find('td.uncommitted-amount');
                    uncommittedAmount = parseFloat(amountCell.attr('data-amount')) || 0;
                } else {
                    // Non-construction: get from input field
                    var uncommittedValue = $(this).find('input[type="number"]').not('.committed-input').not('.uncommitted-qty').not('.uncommitted-rate').val();
                    uncommittedAmount = parseFloat(uncommittedValue) || 0;
                }
            }
            totalUncommitted += uncommittedAmount;
            
            // Committed - parse from data attribute
            var committedAmount = parseFloat($(this).find('.committed-amount').attr('data-committed-amount')) || 0;
            totalCommitted += committedAmount;
        });
        
        console.log('Totals - Budget:', totalContractBudget, 'Uncommitted:', totalUncommitted, 'Committed:', totalCommitted);
        
        // Update totals row (in current container)
        $(window.currentContractBudgetContainer + ' #totalContractBudget').text('$' + totalContractBudget.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
        
        if (isConstruction) {
            // Construction: update uncommitted amount total
            $(window.currentContractBudgetContainer + ' #totalUncommittedAmount').text('$' + totalUncommitted.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
        } else {
            // Non-construction: update uncommitted total
            $(window.currentContractBudgetContainer + ' #totalUncommitted').text('$' + totalUncommitted.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
        }
        
        $(window.currentContractBudgetContainer + ' #totalCommitted').text('$' + totalCommitted.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','));
    }
    
    function saveUncommitted(itemPk, uncommittedAmount) {
        if (!window.currentContractBudgetProject || !window.currentContractBudgetProject.pk) {
            console.error('No project selected');
            return;
        }
        
        console.log('Saving uncommitted amount:', itemPk, uncommittedAmount);
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                costing_pk: itemPk,
                uncommitted: uncommittedAmount,
                notes: ''
            }),
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Uncommitted amount saved successfully');
                } else {
                    console.error('Error saving uncommitted amount:', response.message);
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to save uncommitted amount:', error);
                var errorMessage = 'Failed to save uncommitted amount';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(errorMessage);
            }
        });
    }
    
    function saveUncommittedConstruction(itemPk) {
        if (!window.currentContractBudgetProject || !window.currentContractBudgetProject.pk) {
            console.error('No project selected');
            return;
        }
        
        // Get qty, rate, and calculated amount
        var qtyInput = $('input.uncommitted-qty[data-item-pk="' + itemPk + '"]');
        var rateInput = $('input.uncommitted-rate[data-item-pk="' + itemPk + '"]');
        var amountCell = $('td.uncommitted-amount[data-item-pk="' + itemPk + '"]');
        
        var qty = parseFloat(qtyInput.val()) || 0;
        var rate = parseFloat(rateInput.val()) || 0;
        var amount = parseFloat(amountCell.attr('data-amount')) || 0;
        
        console.log('Saving uncommitted construction:', itemPk, 'qty:', qty, 'rate:', rate, 'amount:', amount);
        
        $.ajax({
            url: '/core/update_uncommitted/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                costing_pk: itemPk,
                uncommitted_qty: qty,
                uncommitted_rate: rate,
                uncommitted: amount,
                notes: ''
            }),
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Uncommitted construction values saved successfully');
                } else {
                    console.error('Error saving uncommitted values:', response.message);
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to save uncommitted values:', error);
                var errorMessage = 'Failed to save uncommitted values';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(errorMessage);
            }
        });
    }
    
    function saveInternalCommitted(itemPk, committedAmount) {
        if (!window.currentContractBudgetProject || !window.currentContractBudgetProject.pk) {
            console.error('No project selected');
            return;
        }
        
        console.log('Saving Internal item committed:', itemPk, committedAmount);
        
        $.ajax({
            url: '/core/update_internal_committed/',
            type: 'POST',
            data: {
                project_pk: window.currentContractBudgetProject.pk,
                item_pk: itemPk,
                committed_amount: committedAmount
            },
            success: function(response) {
                if (response.status === 'success') {
                    console.log('Internal committed amount saved successfully');
                } else {
                    console.error('Error saving committed amount:', response.message);
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to save committed amount:', error);
                var errorMessage = 'Failed to save committed amount';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(errorMessage);
            }
        });
    }
    
    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
})();
</script>
