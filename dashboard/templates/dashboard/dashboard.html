{% extends "dashboard/dashboard_master.html" %}
{% load static %}
{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Add styles for background image */
        body {
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static "core/media/background_reduced.png" %}');
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Makes the image greyed out */
            z-index: -1; /* Puts it behind all content */
            pointer-events: none; /* Prevents interference with clicks */
        }
        
        /* Bills table row selection styling - applies to BOTH Inbox and Direct modals */
        #billsTableBody tr {
            transition: opacity 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        /* When there's a selected row, dim all non-selected rows */
        #billsTableBody.has-selection tr:not(.selected-bill-row) {
            opacity: 0.4;
        }
        
        /* Highlight the selected row */
        #billsTableBody tr.selected-bill-row {
            opacity: 1 !important;
            background-color: #e3f2fd !important;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            position: relative;
        }
        
        /* Keep hover effect visible on all rows */
        #billsTableBody tr:hover {
            opacity: 0.8 !important;
        }
    </style>
</head>

<div style="position: relative;">
    <h3 style="text-align: center;">Project <img src="{% static 'core/images/logo.png' %}" alt="Icon" style="height: 1.6em; vertical-align: middle; position: relative; bottom: 0.3em;">anagement App</h3>
    <div style="position: absolute; top: 0; right: 20px; font-size: 12px; color: #666;">v52</div>
</div>

<div style="padding: 20px;">
    <h4>Welcome to the Project Management Dashboard</h4>
    <p>This is your central hub for managing all projects.</p>
</div>

{% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %}

{{ ... }}
{% include 'dashboard/xero_modals.html' %}
{% include 'dashboard/contacts.html' %}
{% include 'core/components/reusable_bills_modal.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>

<script>
    $(document).ready(function() {
        // Handle navbar dropdown toggle
        $('.nav-dropdown-toggle').click(function(e) {
            e.preventDefault();
            var menu = $(this).siblings('.nav-dropdown-menu');
            var dropdown = $(this).closest('.nav-dropdown');
            menu.toggleClass('show');
            dropdown.toggleClass('open');
        });
        
        // Dashboard controller - opens contacts modal
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            $('#contactsModal').modal('show');
        });
        
        // Function to populate bills table with filtering
        function populateBillsTable(billsData, filterFn, modalType) {
            // Clear existing table and selection state
            $('#billsTableBody').empty();
            $('#billsTableBody').removeClass('has-selection');
            $('#allocationsTableBody').empty();
            currentSelectedInvoicePk = null; // Reset selected invoice tracking
            
            // Update modal title and last column header based on type
            if (modalType === 'inbox') {
                $('#billsModalTitle').text('Bills - Inbox');
                $('#lastColumnHeader').text('Archive');
                // Hide allocations section for Inbox
                $('#allocationsSection').hide();
                $('#viewerSection').css('flex', '1');
            } else if (modalType === 'direct') {
                $('#billsModalTitle').text('Bills - Direct');
                $('#lastColumnHeader').text('Return to Inbox');
                // Show allocations section for Direct
                $('#allocationsSection').css('display', 'flex');
                $('#viewerSection').css('flex', '0 0 66%');
            }
            
            // Filter bills using provided filter function
            var filteredBills = billsData.bills.filter(filterFn);
            
            if (filteredBills.length === 0) {
                $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                return;
            }
            
            // Populate table with filtered bills
            filteredBills.forEach(function(bill) {
                        var row = $('<tr>').attr('data-invoice-pk', bill.invoice_pk);
                        
                        // 1. Combined Xero Instance / Project dropdown
                        var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                        combinedSelect.append($('<option>').val('').text('Select...'));
                        
                        // Add Xero Instances section
                        if (billsData.xero_instances.length > 0) {
                            var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                            xeroHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(xeroHeader);
                            
                            billsData.xero_instances.forEach(function(instance) {
                                var option = $('<option>')
                                    .val('xero_' + instance.xero_instance_pk)
                                    .text('  ' + instance.xero_name);
                                if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        // Add Projects section
                        if (billsData.projects.length > 0) {
                            var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                            projectHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(projectHeader);
                            
                            billsData.projects.forEach(function(project) {
                                var option = $('<option>')
                                    .val('project_' + project.projects_pk)
                                    .text('  ' + project.project);
                                if (bill.project_pk === project.projects_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        row.append($('<td>').append(combinedSelect));
                        
                        // 2. Supplier dropdown (will be populated based on Xero Instance)
                        var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                        
                        // Determine the xero_instance_id for filtering
                        var selectedXeroInstanceId = null;
                        if (bill.project_pk) {
                            // Find the project's xero_instance_id
                            var project = response.projects.find(p => p.projects_pk === bill.project_pk);
                            if (project) {
                                selectedXeroInstanceId = project.xero_instance_id;
                            }
                        } else if (bill.xero_instance_id) {
                            selectedXeroInstanceId = bill.xero_instance_id;
                        }
                        
                        // Only populate suppliers if a Xero Instance is selected
                        if (selectedXeroInstanceId) {
                            // Add "Select Supplier..." option
                            supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator1').text('─────────').prop('disabled', true));
                            
                            // Add "Add..." option
                            supplierSelect.append($('<option>').val('add_supplier').text('Add +'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator2').text('─────────').prop('disabled', true));
                            
                            // Populate suppliers filtered by xero_instance_id
                            billsData.suppliers.forEach(function(supplier) {
                                if (supplier.xero_instance_id === selectedXeroInstanceId) {
                                    var option = $('<option>')
                                        .val(supplier.contact_pk)
                                        .text(supplier.name)
                                        .attr('data-xero-instance', supplier.xero_instance_id);
                                    if (bill.contact_pk === supplier.contact_pk) {
                                        option.prop('selected', true);
                                    }
                                    supplierSelect.append(option);
                                }
                            });
                        } else {
                            // No Xero Instance selected - show placeholder
                            supplierSelect.append($('<option>').val('').text('Select Xero Instance first...'));
                            supplierSelect.prop('disabled', true);
                        }
                        row.append($('<td>').append(supplierSelect));
                        
                        // 3. Invoice # input
                        var invoiceNumberInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm invoice-number-input')
                            .val(bill.supplier_invoice_number || '');
                        row.append($('<td>').append(invoiceNumberInput));
                        
                        // 4. $ Net input (limit to 2 decimal places)
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm net-input')
                            .val(bill.total_net || '')
                            .on('input', function() {
                                var value = $(this).val();
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                            });
                        row.append($('<td>').append(netInput));
                        
                        // 5. $ GST input (limit to 2 decimal places)
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm gst-input')
                            .val(bill.total_gst || '')
                            .on('input', function() {
                                var value = $(this).val();
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                            });
                        row.append($('<td>').append(gstInput));
                        
                        // 6. Email link
                        var emailLink = $('<a>')
                            .attr('href', '#')
                            .text('email')
                            .addClass('email-link')
                            .attr('data-email-html', bill.email_body_html)
                            .attr('data-email-text', bill.email_body_text)
                            .attr('data-email-subject', bill.email_subject)
                            .attr('data-email-from', bill.email_from)
                            .attr('title', bill.email_subject + ' from ' + bill.email_from);
                        row.append($('<td>').append(emailLink));
                        
                        // Store attachment data on the row for auto-loading
                        row.attr('data-attachment-url', bill.attachment_url);
                        row.attr('data-filename', bill.attachment_filename);
                        
                        // 7. Send button
                        var sendBtn = $('<button>')
                            .addClass('btn btn-sm btn-success send-bill-btn')
                            .text('Send')
                            .attr('data-invoice-pk', bill.invoice_pk);
                        row.append($('<td>').append(sendBtn));
                        
                        // 8. Archive or Return to Inbox button (depending on modal type)
                        if (modalType === 'direct') {
                            // Return to Inbox button with email icon
                            var returnBtn = $('<button>')
                                .addClass('btn btn-sm btn-primary return-to-inbox-btn')
                                .html('<i class="fas fa-envelope"></i>')
                                .attr('data-invoice-pk', bill.invoice_pk)
                                .attr('title', 'Return to Inbox');
                            row.append($('<td>').append(returnBtn));
                        } else {
                            // Archive button with icon
                            var archiveBtn = $('<button>')
                                .addClass('btn btn-sm btn-danger archive-bill-btn')
                                .html('<i class="fas fa-archive"></i>')
                                .attr('data-invoice-pk', bill.invoice_pk)
                                .attr('title', 'Archive');
                            row.append($('<td>').append(archiveBtn));
                        }
                        
                        // Add row to table
                        $('#billsTableBody').append(row);
                    });
        }
        
        // Handle Bills Inbox link click
        $('#billsInboxLink').click(function(e) {
            e.preventDefault();
            
            // Fetch bills data and populate modal
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    console.log('Bills loaded:', response);
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Populate table with status = -2 (Inbox: unprocessed email bills)
                    populateBillsTable(response, function(bill) {
                        return bill.invoice_status === -2;
                    }, 'inbox');
                    
                    // Show modal
                    $('#billsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        });
        
        // Handle Bills Direct link click
        $('#billsDirectLink').click(function(e) {
            e.preventDefault();
            
            // Fetch bills data and populate modal
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    console.log('Bills loaded:', response);
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Populate table with Direct bills: status=0, xero_instance non-null, project null
                    populateBillsTable(response, function(bill) {
                        return bill.invoice_status === 0 && 
                               bill.xero_instance_id !== null && 
                               bill.project_pk === null;
                    }, 'direct');
                    
                    // Show modal
                    $('#billsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        });
                    
                    // Add click handler for email links
                    $(document).on('click', '.email-link', function(e) {
                        e.preventDefault();
                        var emailHtml = $(this).attr('data-email-html');
                        var emailText = $(this).attr('data-email-text');
                        var emailSubject = $(this).attr('data-email-subject');
                        var emailFrom = $(this).attr('data-email-from');
                        
                        // Update viewer title
                        $('#viewerTitle').text('Email: ' + emailSubject);
                        
                        // Create HTML content with email header
                        var emailContent = '<div style="padding: 20px; font-family: Arial, sans-serif;">';
                        emailContent += '<div style="border-bottom: 2px solid #ddd; margin-bottom: 20px; padding-bottom: 10px;">';
                        emailContent += '<p style="margin: 5px 0;"><strong>From:</strong> ' + emailFrom + '</p>';
                        emailContent += '<p style="margin: 5px 0;"><strong>Subject:</strong> ' + emailSubject + '</p>';
                        emailContent += '</div>';
                        
                        // Add email body (HTML or text)
                        if (emailHtml) {
                            emailContent += emailHtml;
                        } else if (emailText) {
                            emailContent += '<pre style="white-space: pre-wrap; font-family: Arial, sans-serif;">' + emailText + '</pre>';
                        } else {
                            emailContent += '<p><em>No email content available</em></p>';
                        }
                        emailContent += '</div>';
                        
                        // Create a blob URL for the HTML content
                        var blob = new Blob([emailContent], { type: 'text/html' });
                        var blobUrl = URL.createObjectURL(blob);
                        
                        // Load HTML in iframe
                        $('#billViewer').attr('src', blobUrl).show();
                        $('#viewerPlaceholder').hide();
                    });
                    
                    // Auto-load PDF when user interacts with any cell in a row
                    $(document).on('click focus change', '#billsTableBody tr select, #billsTableBody tr input', function(e) {
                        var row = $(this).closest('tr');
                        var attachmentUrl = row.attr('data-attachment-url');
                        var filename = row.attr('data-filename');
                        
                        if (attachmentUrl) {
                            // Update viewer title
                            $('#viewerTitle').text(filename);
                            
                            // Load PDF in iframe
                            $('#billViewer').attr('src', attachmentUrl).show();
                            $('#viewerPlaceholder').hide();
                        }
                    });
                    
                    // Add change handler for Xero Instance / Project dropdown
                    $(document).on('change', '.xero-project-select', function() {
                        var selectedValue = $(this).val();
                        var row = $(this).closest('tr');
                        var supplierSelect = row.find('.supplier-select');
                        var selectedSupplier = supplierSelect.val(); // Remember current selection
                        
                        // Determine the xero_instance_id
                        var xeroInstanceId = null;
                        if (selectedValue.startsWith('xero_')) {
                            xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
                        } else if (selectedValue.startsWith('project_')) {
                            var projectPk = parseInt(selectedValue.replace('project_', ''));
                            var project = window.billsData.projects.find(p => p.projects_pk === projectPk);
                            if (project) {
                                xeroInstanceId = project.xero_instance_id;
                            }
                        }
                        
                        // Rebuild supplier dropdown
                        supplierSelect.empty();
                        
                        if (xeroInstanceId) {
                            // Enable and populate suppliers
                            supplierSelect.prop('disabled', false);
                            
                            // Add "Select Supplier..." option
                            supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator1').text('─────────').prop('disabled', true));
                            
                            // Add "Add..." option
                            supplierSelect.append($('<option>').val('add_supplier').text('Add...'));
                            
                            // Add separator
                            supplierSelect.append($('<option>').val('separator2').text('─────────').prop('disabled', true));
                            
                            window.billsData.suppliers.forEach(function(supplier) {
                                if (supplier.xero_instance_id === xeroInstanceId) {
                                    var option = $('<option>')
                                        .val(supplier.contact_pk)
                                        .text(supplier.name)
                                        .attr('data-xero-instance', supplier.xero_instance_id);
                                    supplierSelect.append(option);
                                }
                            });
                            
                            // Restore selection if still valid
                            if (selectedSupplier && supplierSelect.find('option[value="' + selectedSupplier + '"]').length > 0) {
                                supplierSelect.val(selectedSupplier);
                            }
                        } else {
                            // Disable and show placeholder
                            supplierSelect.append($('<option>').val('').text('Select Xero Instance first...'));
                            supplierSelect.prop('disabled', true);
                        }
                    });
                    
                    // Handle supplier dropdown change - open Add Supplier modal if selected
                    $(document).on('change', '.supplier-select', function() {
                        var selectedValue = $(this).val();
                        var row = $(this).closest('tr');
                        
                        if (selectedValue === 'add_supplier') {
                            // Get the Xero Instance ID from the combined dropdown
                            var combinedSelect = row.find('.xero-project-select');
                            var combinedValue = combinedSelect.val();
                            var xeroInstanceId = null;
                            
                            if (combinedValue.startsWith('xero_')) {
                                xeroInstanceId = parseInt(combinedValue.replace('xero_', ''));
                            } else if (combinedValue.startsWith('project_')) {
                                var projectPk = parseInt(combinedValue.replace('project_', ''));
                                var project = window.billsData.projects.find(p => p.projects_pk === projectPk);
                                if (project) {
                                    xeroInstanceId = project.xero_instance_id;
                                }
                            }
                            
                            if (xeroInstanceId) {
                                // Reset dropdown to empty
                                $(this).val('');
                                
                                // Open Add Supplier modal
                                window.openAddSupplierModal(xeroInstanceId, row);
                            }
                        }
                    });
                    
                    // Add click handler for send buttons
                    $(document).on('click', '.send-bill-btn', function(e) {
                        e.preventDefault();
                        
                        var button = $(this);
                        var row = button.closest('tr');
                        var invoicePk = button.attr('data-invoice-pk');
                        
                        // Get values from row
                        var xeroInstanceOrProject = row.find('.xero-project-select').val();
                        var supplierPk = row.find('.supplier-select').val();
                        var invoiceNumber = row.find('.invoice-number-input').val();
                        var totalNet = row.find('.net-input').val();
                        var totalGst = row.find('.gst-input').val();
                        
                        // Validate all required fields
                        var errors = [];
                        if (!xeroInstanceOrProject) {
                            errors.push('Please select a Xero Instance or Project');
                        }
                        if (!supplierPk || supplierPk === 'add_supplier') {
                            errors.push('Please select a Supplier');
                        }
                        if (!invoiceNumber || invoiceNumber.trim() === '') {
                            errors.push('Please enter an Invoice Number');
                        }
                        if (!totalNet || totalNet === '') {
                            errors.push('Please enter a Net amount');
                        }
                        if (!totalGst || totalGst === '') {
                            errors.push('Please enter a GST amount');
                        }
                        
                        if (errors.length > 0) {
                            alert('Please fix the following errors:\n\n' + errors.join('\n'));
                            return;
                        }
                        
                        // Disable button and show processing state
                        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
                        
                        // Send AJAX request
                        fetch('/send_bill/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                            },
                            body: JSON.stringify({
                                invoice_pk: invoicePk,
                                xero_instance_or_project: xeroInstanceOrProject,
                                supplier_pk: supplierPk,
                                invoice_number: invoiceNumber,
                                total_net: totalNet,
                                total_gst: totalGst
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Remove row from table with fade effect
                                row.fadeOut(400, function() {
                                    $(this).remove();
                                    
                                    // Check if table is empty
                                    if ($('#billsTableBody tr').length === 0) {
                                        $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                                    }
                                });
                            } else {
                                // Re-enable button on error
                                button.prop('disabled', false).html('Send');
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error sending bill:', error);
                            button.prop('disabled', false).html('Send');
                            alert('Failed to send bill. Please try again.');
                        });
                    });
                    
                    // Add click handler for archive buttons
                    $(document).on('click', '.archive-bill-btn', function(e) {
                        e.preventDefault();
                        var invoicePk = $(this).attr('data-invoice-pk');
                        var row = $(this).closest('tr');
                        
                        if (confirm('Are you sure you want to archive this Bill?')) {
                            // Send AJAX request to archive the invoice
                            $.ajax({
                                url: '{% url "core:archive_bill" %}',
                                type: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                data: JSON.stringify({
                                    invoice_pk: invoicePk
                                }),
                                contentType: 'application/json',
                                success: function(response) {
                                    if (response.status === 'success') {
                                        // Remove row from table with fade effect
                                        row.fadeOut(300, function() {
                                            $(this).remove();
                                        });
                                    } else {
                                        alert('Failed to archive bill: ' + response.message);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Archive error:', error);
                                    alert('Failed to archive bill. Please try again.');
                                }
                            });
                        }
                    });
                    
                    // Add click handler for return to inbox buttons
                    $(document).on('click', '.return-to-inbox-btn', function(e) {
                        e.preventDefault();
                        var invoicePk = $(this).attr('data-invoice-pk');
                        var row = $(this).closest('tr');
                        
                        if (confirm('Are you sure you want to return this bill to the inbox?')) {
                            // Send AJAX request to return to inbox
                            $.ajax({
                                url: '{% url "core:return_to_inbox" %}',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    invoice_pk: invoicePk
                                }),
                                headers: {
                                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                                },
                                success: function(response) {
                                    if (response.status === 'success') {
                                        // Update the invoice in the global bills data
                                        if (window.billsData && window.billsData.bills) {
                                            var invoice = window.billsData.bills.find(b => b.invoice_pk === parseInt(invoicePk));
                                            if (invoice) {
                                                invoice.invoice_status = -2;
                                                invoice.xero_instance_id = null;
                                                invoice.project_pk = null;
                                                invoice.total_net = null;
                                                invoice.total_gst = null;
                                                invoice.supplier_invoice_number = null;
                                                invoice.contact_pk = null;
                                            }
                                        }
                                        
                                        // Remove row from table with fade effect
                                        row.fadeOut(400, function() {
                                            $(this).remove();
                                            
                                            // Check if table is empty
                                            if ($('#billsTableBody tr').length === 0) {
                                                $('#billsTableBody').html('<tr><td colspan="8" style="text-align: center;">No bills to display</td></tr>');
                                            }
                                        });
                                    } else {
                                        alert('Failed to return bill to inbox: ' + response.message);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Return to inbox error:', error);
                                    alert('Failed to return bill to inbox. Please try again.');
                                }
                            });
                        }
                    });
                    
                    // Global variable to store current invoice data for allocations
                    var currentInvoiceData = null;
                    var currentSelectedInvoicePk = null;
                    
                    // Function to create an allocation row
                    function createAllocationRow(netAmount, gstAmount) {
                        var row = $('<tr>');
                        
                        // 1. Xero Account dropdown
                        var accountSelect = $('<select>').addClass('form-control form-control-sm');
                        accountSelect.append($('<option>').val('').text('Select Account...'));
                        // TODO: Populate with Xero accounts from backend
                        // For now, add placeholder options
                        accountSelect.append($('<option>').val('account1').text('Account 1'));
                        accountSelect.append($('<option>').val('account2').text('Account 2'));
                        row.append($('<td>').append(accountSelect));
                        
                        // 2. Division dropdown (Projects)
                        var divisionSelect = $('<select>').addClass('form-control form-control-sm');
                        divisionSelect.append($('<option>').val('').text('Select Division...'));
                        // Populate with projects from global billsData
                        if (window.billsData && window.billsData.projects) {
                            window.billsData.projects.forEach(function(project) {
                                divisionSelect.append($('<option>')
                                    .val(project.projects_pk)
                                    .text(project.project));
                            });
                        }
                        row.append($('<td>').append(divisionSelect));
                        
                        // 3. $ Net input (with 2dp validation)
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm allocation-net-input')
                            .val(netAmount || '')
                            .on('input', function() {
                                var value = $(this).val();
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                            });
                        row.append($('<td>').append(netInput));
                        
                        // 4. $ GST input (with 2dp validation)
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm allocation-gst-input')
                            .val(gstAmount || '')
                            .on('input', function() {
                                var value = $(this).val();
                                if (value.includes('.')) {
                                    var parts = value.split('.');
                                    if (parts[1] && parts[1].length > 2) {
                                        $(this).val(parseFloat(value).toFixed(2));
                                    }
                                }
                            });
                        row.append($('<td>').append(gstInput));
                        
                        // 5. Notes input (text)
                        var notesInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm allocation-notes-input')
                            .attr('placeholder', 'Notes...');
                        row.append($('<td>').append(notesInput));
                        
                        return row;
                    }
                    
                    // Add click handler for LHS table rows to populate allocations
                    $(document).on('click', '#billsTableBody tr', function(e) {
                        // Only prevent if clicking buttons or email links (allow inputs/selects)
                        if ($(e.target).is('button, a, i')) {
                            return;
                        }
                        
                        // Also check if clicking inside a button (for icons inside buttons)
                        if ($(e.target).closest('button, a').length > 0) {
                            return;
                        }
                        
                        var invoicePk = $(this).attr('data-invoice-pk');
                        var clickedRow = $(this);
                        
                        // Check if this is the same row that's already selected
                        var isSameRow = (currentSelectedInvoicePk === invoicePk);
                        
                        // Remove previous selection styling
                        $('#billsTableBody tr').removeClass('selected-bill-row');
                        
                        // Add selection styling to clicked row
                        clickedRow.addClass('selected-bill-row');
                        
                        // Add class to tbody to trigger dimming effect
                        $('#billsTableBody').addClass('has-selection');
                        
                        // Only update data if switching to a different row
                        if (!isSameRow) {
                            // Update current selection
                            currentSelectedInvoicePk = invoicePk;
                            
                            // Find the invoice in the bills data
                            if (window.billsData && window.billsData.bills) {
                                var invoice = window.billsData.bills.find(b => b.invoice_pk === parseInt(invoicePk));
                                if (invoice) {
                                    currentInvoiceData = invoice;
                                    
                                    // Clear and populate allocations table
                                    $('#allocationsTableBody').empty();
                                    
                                    // Add one row with net and gst pre-populated
                                    var row = createAllocationRow(invoice.total_net, invoice.total_gst);
                                    $('#allocationsTableBody').append(row);
                                }
                            }
                            
                            // Load PDF when switching to different row
                            var attachmentUrl = clickedRow.attr('data-attachment-url');
                            var filename = clickedRow.attr('data-filename');
                            
                            if (attachmentUrl) {
                                // Update viewer title
                                $('#viewerTitle').text(filename);
                                
                                // Load PDF in iframe
                                $('#billViewer').attr('src', attachmentUrl).show();
                                $('#viewerPlaceholder').hide();
                            }
                        }
                    });
                    
                    // Add click handler for '+' button to add new allocation rows
                    $(document).on('click', '#addAllocationBtn', function(e) {
                        e.preventDefault();
                        
                        // Add empty row
                        var row = createAllocationRow(null, null);
                        $('#allocationsTableBody').append(row);
                    });
    });
</script>

{% endblock %}
