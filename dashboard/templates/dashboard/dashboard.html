{% extends "dashboard/dashboard_master.html" %}
{% load static %}
{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Add styles for background image */
        body {
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static "core/media/background_reduced.png" %}');
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Makes the image greyed out */
            z-index: -1; /* Puts it behind all content */
            pointer-events: none; /* Prevents interference with clicks */
        }
    </style>
</head>

<div style="position: relative;">
    <h3 style="text-align: center;">Project <img src="{% static 'core/images/logo.png' %}" alt="Icon" style="height: 1.6em; vertical-align: middle; position: relative; bottom: 0.3em;">anagement App</h3>
    <div style="position: absolute; top: 0; right: 20px; font-size: 12px; color: #666;">v50</div>
</div>

<div style="padding: 20px;">
    <h4>Welcome to the Project Management Dashboard</h4>
    <p>This is your central hub for managing all projects.</p>
</div>

{% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %}

{{ ... }}
{% include 'dashboard/xero_modals.html' %}
{% include 'dashboard/contacts.html' %}
{% include 'core/components/reusable_bills_modal.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>

<script>
    $(document).ready(function() {
        // Dashboard controller - opens contacts modal
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            $('#contactsModal').modal('show');
        });
        
        // Bills modal controller
        $('#billsLink').click(function(e) {
            e.preventDefault();
            
            // Fetch bills data and populate modal
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    console.log('Bills loaded:', response);
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Clear existing table
                    $('#billsTableBody').empty();
                    
                    // Populate table with bills
                    response.bills.forEach(function(bill) {
                        var row = $('<tr>').attr('data-invoice-pk', bill.invoice_pk);
                        
                        // 1. Combined Xero Instance / Project dropdown
                        var combinedSelect = $('<select>').addClass('form-control form-control-sm xero-project-select');
                        combinedSelect.append($('<option>').val('').text('Select...'));
                        
                        // Add Xero Instances section
                        if (response.xero_instances.length > 0) {
                            var xeroHeader = $('<option>').val('').text('─── Xero Instances ───').prop('disabled', true);
                            xeroHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(xeroHeader);
                            
                            response.xero_instances.forEach(function(instance) {
                                var option = $('<option>')
                                    .val('xero_' + instance.xero_instance_pk)
                                    .text('  ' + instance.xero_name);
                                if (bill.xero_instance_id === instance.xero_instance_pk && !bill.project_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        // Add Projects section
                        if (response.projects.length > 0) {
                            var projectHeader = $('<option>').val('').text('─── Projects ───').prop('disabled', true);
                            projectHeader.css({'font-weight': 'bold', 'background-color': '#f0f0f0'});
                            combinedSelect.append(projectHeader);
                            
                            response.projects.forEach(function(project) {
                                var option = $('<option>')
                                    .val('project_' + project.projects_pk)
                                    .text('  ' + project.project);
                                if (bill.project_pk === project.projects_pk) {
                                    option.prop('selected', true);
                                }
                                combinedSelect.append(option);
                            });
                        }
                        
                        row.append($('<td>').append(combinedSelect));
                        
                        // 2. Supplier dropdown (will be populated based on Xero Instance)
                        var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                        supplierSelect.append($('<option>').val('').text('Select...'));
                        
                        // Determine the xero_instance_id for filtering
                        var selectedXeroInstanceId = null;
                        if (bill.project_pk) {
                            // Find the project's xero_instance_id
                            var project = response.projects.find(p => p.projects_pk === bill.project_pk);
                            if (project) {
                                selectedXeroInstanceId = project.xero_instance_id;
                            }
                        } else if (bill.xero_instance_id) {
                            selectedXeroInstanceId = bill.xero_instance_id;
                        }
                        
                        // Populate suppliers filtered by xero_instance_id
                        response.suppliers.forEach(function(supplier) {
                            // Only show suppliers for the selected Xero Instance
                            if (!selectedXeroInstanceId || supplier.xero_instance_id === selectedXeroInstanceId) {
                                var option = $('<option>')
                                    .val(supplier.contact_pk)
                                    .text(supplier.name)
                                    .attr('data-xero-instance', supplier.xero_instance_id);
                                if (bill.contact_pk === supplier.contact_pk) {
                                    option.prop('selected', true);
                                }
                                supplierSelect.append(option);
                            }
                        });
                        row.append($('<td>').append(supplierSelect));
                        
                        // 3. Invoice # input
                        var invoiceNumberInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm invoice-number-input')
                            .val(bill.supplier_invoice_number || '');
                        row.append($('<td>').append(invoiceNumberInput));
                        
                        // 4. $ Net input
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm net-input')
                            .val(bill.total_net || '');
                        row.append($('<td>').append(netInput));
                        
                        // 5. $ GST input
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm gst-input')
                            .val(bill.total_gst || '');
                        row.append($('<td>').append(gstInput));
                        
                        // 6. Email link
                        var emailLink = $('<a>')
                            .attr('href', '#')
                            .text('email')
                            .addClass('email-link')
                            .attr('data-email-html', bill.email_body_html)
                            .attr('data-email-text', bill.email_body_text)
                            .attr('data-email-subject', bill.email_subject)
                            .attr('data-email-from', bill.email_from)
                            .attr('title', bill.email_subject + ' from ' + bill.email_from);
                        row.append($('<td>').append(emailLink));
                        
                        // 7. View link (attachment)
                        var viewLink = $('<a>')
                            .attr('href', '#')
                            .text('view')
                            .addClass('view-link')
                            .attr('data-attachment-url', bill.attachment_url)
                            .attr('data-filename', bill.attachment_filename);
                        row.append($('<td>').append(viewLink));
                        
                        // 8. Send button
                        var sendBtn = $('<button>')
                            .addClass('btn btn-sm btn-success send-bill-btn')
                            .text('Send')
                            .attr('data-invoice-pk', bill.invoice_pk);
                        row.append($('<td>').append(sendBtn));
                        
                        // 9. Archive button
                        var archiveBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger archive-bill-btn')
                            .text('Archive')
                            .attr('data-invoice-pk', bill.invoice_pk);
                        row.append($('<td>').append(archiveBtn));
                        
                        // Add row to table
                        $('#billsTableBody').append(row);
                    });
                    
                    // Add click handler for email links
                    $(document).on('click', '.email-link', function(e) {
                        e.preventDefault();
                        var emailHtml = $(this).attr('data-email-html');
                        var emailText = $(this).attr('data-email-text');
                        var emailSubject = $(this).attr('data-email-subject');
                        var emailFrom = $(this).attr('data-email-from');
                        
                        // Update viewer title
                        $('#viewerTitle').text('Email: ' + emailSubject);
                        
                        // Create HTML content with email header
                        var emailContent = '<div style="padding: 20px; font-family: Arial, sans-serif;">';
                        emailContent += '<div style="border-bottom: 2px solid #ddd; margin-bottom: 20px; padding-bottom: 10px;">';
                        emailContent += '<p style="margin: 5px 0;"><strong>From:</strong> ' + emailFrom + '</p>';
                        emailContent += '<p style="margin: 5px 0;"><strong>Subject:</strong> ' + emailSubject + '</p>';
                        emailContent += '</div>';
                        
                        // Add email body (HTML or text)
                        if (emailHtml) {
                            emailContent += emailHtml;
                        } else if (emailText) {
                            emailContent += '<pre style="white-space: pre-wrap; font-family: Arial, sans-serif;">' + emailText + '</pre>';
                        } else {
                            emailContent += '<p><em>No email content available</em></p>';
                        }
                        emailContent += '</div>';
                        
                        // Create a blob URL for the HTML content
                        var blob = new Blob([emailContent], { type: 'text/html' });
                        var blobUrl = URL.createObjectURL(blob);
                        
                        // Load HTML in iframe
                        $('#billViewer').attr('src', blobUrl).show();
                        $('#viewerPlaceholder').hide();
                    });
                    
                    // Add click handler for view links (PDFs)
                    $(document).on('click', '.view-link', function(e) {
                        e.preventDefault();
                        var attachmentUrl = $(this).attr('data-attachment-url');
                        var filename = $(this).attr('data-filename');
                        
                        if (attachmentUrl) {
                            // Update viewer title
                            $('#viewerTitle').text(filename);
                            
                            // Load PDF in iframe
                            $('#billViewer').attr('src', attachmentUrl).show();
                            $('#viewerPlaceholder').hide();
                        } else {
                            alert('No attachment available for this bill');
                        }
                    });
                    
                    // Add change handler for Xero Instance / Project dropdown
                    $(document).on('change', '.xero-project-select', function() {
                        var selectedValue = $(this).val();
                        var row = $(this).closest('tr');
                        var supplierSelect = row.find('.supplier-select');
                        var selectedSupplier = supplierSelect.val(); // Remember current selection
                        
                        // Determine the xero_instance_id
                        var xeroInstanceId = null;
                        if (selectedValue.startsWith('xero_')) {
                            xeroInstanceId = parseInt(selectedValue.replace('xero_', ''));
                        } else if (selectedValue.startsWith('project_')) {
                            var projectPk = parseInt(selectedValue.replace('project_', ''));
                            var project = window.billsData.projects.find(p => p.projects_pk === projectPk);
                            if (project) {
                                xeroInstanceId = project.xero_instance_id;
                            }
                        }
                        
                        // Rebuild supplier dropdown
                        supplierSelect.empty();
                        supplierSelect.append($('<option>').val('').text('Select...'));
                        
                        window.billsData.suppliers.forEach(function(supplier) {
                            if (!xeroInstanceId || supplier.xero_instance_id === xeroInstanceId) {
                                var option = $('<option>')
                                    .val(supplier.contact_pk)
                                    .text(supplier.name)
                                    .attr('data-xero-instance', supplier.xero_instance_id);
                                supplierSelect.append(option);
                            }
                        });
                        
                        // Restore selection if still valid
                        if (selectedSupplier && supplierSelect.find('option[value="' + selectedSupplier + '"]').length > 0) {
                            supplierSelect.val(selectedSupplier);
                        }
                    });
                    
                    // Add click handler for send buttons
                    $(document).on('click', '.send-bill-btn', function(e) {
                        e.preventDefault();
                        alert('Placeholder only for now');
                    });
                    
                    // Add click handler for archive buttons
                    $(document).on('click', '.archive-bill-btn', function(e) {
                        e.preventDefault();
                        var invoicePk = $(this).attr('data-invoice-pk');
                        var row = $(this).closest('tr');
                        
                        if (confirm('Are you sure you want to archive this Bill?')) {
                            // Send AJAX request to archive the invoice
                            $.ajax({
                                url: '{% url "core:archive_bill" %}',
                                type: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                data: JSON.stringify({
                                    invoice_pk: invoicePk
                                }),
                                contentType: 'application/json',
                                success: function(response) {
                                    if (response.status === 'success') {
                                        // Remove row from table with fade effect
                                        row.fadeOut(300, function() {
                                            $(this).remove();
                                        });
                                    } else {
                                        alert('Failed to archive bill: ' + response.message);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Archive error:', error);
                                    alert('Failed to archive bill. Please try again.');
                                }
                            });
                        }
                    });
                    
                    // Show modal
                    $('#billsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        });
    });
</script>

{% endblock %}
