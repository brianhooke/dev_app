{% extends "dashboard/dashboard_master.html" %}
{% load static %}
{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Add styles for background image */
        body {
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('{% static "core/media/background_reduced.png" %}');
            background-size: 100% auto;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15; /* Makes the image greyed out */
            z-index: -1; /* Puts it behind all content */
            pointer-events: none; /* Prevents interference with clicks */
        }
    </style>
</head>

<div style="position: relative;">
    <h3 style="text-align: center;">Project <img src="{% static 'core/images/logo.png' %}" alt="Icon" style="height: 1.6em; vertical-align: middle; position: relative; bottom: 0.3em;">anagement App</h3>
    <div style="position: absolute; top: 0; right: 20px; font-size: 12px; color: #666;">v50</div>
</div>

<div style="padding: 20px;">
    <h4>Welcome to the Project Management Dashboard</h4>
    <p>This is your central hub for managing all projects.</p>
</div>

{% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %}

{{ ... }}
{% include 'dashboard/xero_modals.html' %}
{% include 'dashboard/contacts.html' %}
{% include 'core/components/reusable_bills_modal.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>

<script>
    $(document).ready(function() {
        // Dashboard controller - opens contacts modal
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            $('#contactsModal').modal('show');
        });
        
        // Bills modal controller
        $('#billsLink').click(function(e) {
            e.preventDefault();
            
            // Fetch bills data and populate modal
            $.ajax({
                url: '{% url "core:get_bills_list" %}',
                type: 'GET',
                success: function(response) {
                    console.log('Bills loaded:', response);
                    
                    // Store data globally for later use
                    window.billsData = response;
                    
                    // Clear existing table
                    $('#billsTableBody').empty();
                    
                    // Populate table with bills
                    response.bills.forEach(function(bill) {
                        var row = $('<tr>').attr('data-invoice-pk', bill.invoice_pk);
                        
                        // 1. Xero Instance dropdown
                        var xeroSelect = $('<select>').addClass('form-control form-control-sm xero-instance-select');
                        xeroSelect.append($('<option>').val('').text('Select...'));
                        response.xero_instances.forEach(function(instance) {
                            var option = $('<option>').val(instance.xero_instance_pk).text(instance.xero_name);
                            if (bill.xero_instance_id === instance.xero_instance_pk) {
                                option.prop('selected', true);
                            }
                            xeroSelect.append(option);
                        });
                        row.append($('<td>').append(xeroSelect));
                        
                        // 2. Supplier dropdown
                        var supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                        supplierSelect.append($('<option>').val('').text('Select...'));
                        response.suppliers.forEach(function(supplier) {
                            var option = $('<option>').val(supplier.contact_pk).text(supplier.name);
                            if (bill.contact_pk === supplier.contact_pk) {
                                option.prop('selected', true);
                            }
                            supplierSelect.append(option);
                        });
                        row.append($('<td>').append(supplierSelect));
                        
                        // 3. Project dropdown
                        var projectSelect = $('<select>').addClass('form-control form-control-sm project-select');
                        projectSelect.append($('<option>').val('').text('Select...'));
                        response.projects.forEach(function(project) {
                            var option = $('<option>').val(project.projects_pk).text(project.project);
                            if (bill.project_pk === project.projects_pk) {
                                option.prop('selected', true);
                            }
                            projectSelect.append(option);
                        });
                        row.append($('<td>').append(projectSelect));
                        
                        // 4. $ Net input
                        var netInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm net-input')
                            .val(bill.total_net || '');
                        row.append($('<td>').append(netInput));
                        
                        // 5. $ GST input
                        var gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .addClass('form-control form-control-sm gst-input')
                            .val(bill.total_gst || '');
                        row.append($('<td>').append(gstInput));
                        
                        // 6. Email link
                        var emailLink = $('<a>')
                            .attr('href', bill.email_url)
                            .attr('target', '_blank')
                            .text('email')
                            .attr('title', bill.email_subject + ' from ' + bill.email_from);
                        row.append($('<td>').append(emailLink));
                        
                        // 7. View link (attachment)
                        var viewLink = $('<a>')
                            .attr('href', '#')
                            .text('view')
                            .addClass('view-link')
                            .attr('data-attachment-url', bill.attachment_url)
                            .attr('data-filename', bill.attachment_filename);
                        row.append($('<td>').append(viewLink));
                        
                        // Add row to table
                        $('#billsTableBody').append(row);
                    });
                    
                    // Add click handler for view links
                    $(document).on('click', '.view-link', function(e) {
                        e.preventDefault();
                        var attachmentUrl = $(this).attr('data-attachment-url');
                        var filename = $(this).attr('data-filename');
                        
                        if (attachmentUrl) {
                            // Update viewer title
                            $('#viewerTitle').text(filename);
                            
                            // Load PDF in iframe
                            $('#billViewer').attr('src', attachmentUrl).show();
                            $('#viewerPlaceholder').hide();
                        } else {
                            alert('No attachment available for this bill');
                        }
                    });
                    
                    // Show modal
                    $('#billsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load bills:', error);
                    alert('Failed to load bills. Please try again.');
                }
            });
        });
    });
</script>

{% endblock %}
