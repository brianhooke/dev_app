{% extends "dashboard/dashboard_master.html" %}
{% load static %}

<!--
Template: Dashboard Main Application Template

Purpose:
Main dashboard interface for the Project Management App. Provides navigation and modal interfaces
for Bills, Contacts, Xero management, and other core functionality.

Structure:
1. Master Template Extension
   - Extends dashboard/dashboard_master.html
   - Includes global styles, favicon, background image
   - Navigation bar with dropdown menus

2. Included Modal Templates
   - {% include 'dashboard/bills.html' %} - Bills modals (Inbox, Direct)
   - {% include 'dashboard/contacts.html' %} - Extended contacts modal with verification
   - {% include 'dashboard/xero_modals.html' %} - Xero instance management

Bills Functionality (status-based workflows):
- Bills - Inbox (invoice_status = -2):
  * Unprocessed email bills
  * LHS table: Xero Instance, Supplier, Invoice #, Net, GST fields
  * Send button → Updates invoice, sets status to 0, moves to Bills - Direct
  * Archive button → Sets status to 4

- Bills - Direct (invoice_status = 0):
  * Ready for allocation
  * LHS table: Same fields as Inbox
  * RHS table: Allocations with Xero Account selection, amounts, notes
  * PDF viewer: Display bill attachment
  * "Still to allocate" calculations (Net/GST must = $0.00)
  * Send to Xero button → Validates allocations, posts to Xero API as DRAFT, sets status to 2
  * Return to Inbox (mail icon) → Deletes allocations, clears fields, sets status to -2
  * Archive button → Sets status to 4

Contacts Functionality:
- Pull contacts from Xero API (insert/update)
- Create new contacts in Xero + local DB
- Update contact details (bank, email, ABN) in Xero
- Archive/unarchive contacts in Xero
- Verify contact details with side-by-side comparison
- Verified status indicators: 0=not verified, 1=verified+matches, 2=verified+changed

Xero Functionality:
- Manage Xero OAuth2 instances (create, test, delete)
- Pull accounts from Xero for all instances
- Display accounts by instance for allocation dropdowns

Key JavaScript Features:
- Dynamic table population for bills, allocations, contacts
- Real-time "Still to allocate" calculations with color coding
- Auto-calculate GST (10% of Net) with immediate updates
- Row selection with highlighting
- PDF viewer integration
- Modal state management (show/hide, data persistence)
- AJAX form submissions with validation
- Xero API integration via backend endpoints

Backend Endpoints Used:
Bills:
- GET  /get_bills_list/ - Fetch all bills with allocations
- POST /send_bill/ - Smart endpoint (Inbox→Direct or Direct→Xero)
- POST /core/archive_bill/ - Archive bill
- POST /core/return_to_inbox/ - Return bill to inbox, delete allocations
- POST /core/create_invoice_allocation/ - Create allocation
- POST /core/update_invoice_allocation/ - Update allocation
- POST /core/delete_invoice_allocation/ - Delete allocation
- POST /core/update_invoice/ - Update invoice fields
- POST /core/null_allocation_xero_fields/ - Clear Xero accounts on instance change
- GET  /core/get_xero_accounts_by_instance/{pk}/ - Get accounts for dropdown

Contacts:
- GET  /get_contacts_by_instance/{pk}/ - Get active contacts
- POST /pull_xero_contacts/{pk}/ - Sync from Xero
- POST /create_contact/{pk}/ - Create in Xero + DB
- POST /update_contact_details/{pk}/{contact_pk}/ - Update in Xero
- POST /update_contact_status/{pk}/{contact_pk}/ - Archive/unarchive
- POST /verify_contact_details/{contact_pk}/ - Save verified details

Xero:
- GET  /core/get_xero_instances/ - Fetch all instances
- POST /core/create_xero_instance/ - Create new instance
- POST /core/delete_xero_instance/ - Delete instance
- POST /core/test_xero_connection/{pk}/ - Test API connection
- POST /core/pull_xero_accounts_and_divisions/ - Sync accounts

Data Structures:
- Invoice status codes: -2=Inbox, 0=Direct, 2=Sent to Xero, 4=Archived
- Contact verified status: 0=not verified, 1=verified+matches, 2=verified+changed
- Global variables: window.billsData, currentInvoiceData, currentSelectedInvoicePk

Version: v78 (displayed in header)
-->

{% block title %}
  Project Management Dashboard
{% endblock %}
{% block content %}

{% csrf_token %}

<!-- Database Wipe Button -->
<button id="wipeDbBtn" title="Wipe All Database Data" aria-label="Wipe Database">
    <i class="fas fa-trash-alt"></i>
</button>

<head>
    <link rel="icon" href="{% static 'core/images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'core/css/global_styles.css' %}">
    <style>
        /* Prevent page scrolling */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        
        /* Database Wipe Button - Top Left, Right of Navbar */
        #wipeDbBtn {
            position: fixed;
            top: 20px;
            left: 90px;
            z-index: 9999;
            background-color: #dc3545;
            color: white;
            border: 2px solid #c82333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: none; /* Hidden by default - show with SHIFT+B */
            align-items: center;
            justify-content: center;
        }
        
        #wipeDbBtn.visible {
            display: flex;
        }
        
        #wipeDbBtn:hover {
            background-color: #c82333;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
        }
        
        #wipeDbBtn:active {
            transform: scale(0.95);
        }
        
        
        /* Bills table row selection styling - applies to BOTH Inbox and Direct modals */
        #billsTableBody tr {
            transition: opacity 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        /* When there's a selected row, dim all non-selected rows */
        #billsTableBody.has-selection tr:not(.selected-bill-row) {
            opacity: 0.4;
        }
        
        /* Highlight the selected row */
        #billsTableBody tr.selected-bill-row {
            opacity: 1 !important;
            background-color: #e3f2fd !important;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            position: relative;
        }
        
        /* Keep hover effect visible on all rows */
        #billsTableBody tr:hover {
            opacity: 0.8 !important;
        }
        
        /* Force sticky headers for all workspace tables */
        #contactsSection .reusable-table thead,
        #xeroSection .reusable-table thead {
            position: -webkit-sticky !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            background: var(--gradient-primary) !important;
        }
        
        #contactsSection .reusable-table thead tr,
        #xeroSection .reusable-table thead tr {
            position: -webkit-sticky !important;
            position: sticky !important;
            top: 0 !important;
            background: var(--gradient-primary) !important;
            z-index: 1000 !important;
        }
        
        #contactsSection .reusable-table th,
        #xeroSection .reusable-table th {
            position: -webkit-sticky !important;
            position: sticky !important;
            top: 0 !important;
            background: var(--gradient-primary) !important;
            z-index: 1000 !important;
        }
        
        /* Navbar active state is already defined in reusable_navbar.html */
        
        /* Mason logo background for workspace */
        #dynamicContentArea::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('{% static "core/images/mason_logo.png" %}');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 1;
            pointer-events: none;
            z-index: 0;
        }

        /* Hide background when any section is active */
        #dynamicContentArea.has-content::before {
            display: none;
        }

        /* Ensure content appears above background */
        #dynamicContentArea > * {
            position: relative;
            z-index: 1;
        }
    </style>
</head>

<!-- Dynamic Content Area (Workspace) -->
<div id="dynamicContentArea" style="margin: 0; padding: 20px; height: 100vh; position: relative; overflow: hidden;">
    <!-- Empty State (shown on page load) -->
    <div id="emptyState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
    </div>

    <!-- Xero Section (hidden initially, shown when Xero clicked) -->
    <div id="xeroSection" style="display: none; height: 100%; flex-direction: column;">
        
        <!-- Xero Instances Table (scrollable) -->
        <div style="flex: 1; overflow-y: auto; position: relative;">
            <style>
                #xeroSection .reusable-table thead {
                    position: sticky !important;
                    top: 0 !important;
                    z-index: 10 !important;
                }
                #xeroSection .reusable-table thead tr {
                    background: var(--gradient-primary) !important;
                }
                #xeroSection .reusable-table th {
                    position: sticky !important;
                    top: 0 !important;
                    background: var(--gradient-primary) !important;
                    z-index: 10 !important;
                    border-bottom: 2px solid #dee2e6 !important;
                }
            </style>
            <table class="reusable-table" id="xeroInstancesTable">
                <thead>
                    <tr>
                        <th>Xero Instance</th>
                        <th>Test</th>
                        <th>Authorise</th>
                        <th>Pull Contacts</th>
                        <th>Pull Accounts</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="xeroInstancesTableBody">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Footer Button - sticky at bottom -->
        <div style="display: flex; justify-content: flex-end; align-items: center; flex-shrink: 0; padding: 10px 15px; margin-top: auto; background: var(--gradient-primary); border-radius: 0 0 8px 8px;">
            <button type="button" class="btn btn-light" id="addNewXeroBtn">Add New</button>
        </div>
    </div>

    <!-- Contacts Section (hidden initially, shown when Contacts clicked) -->
    <div id="contactsSection" style="display: none; height: 100%; flex-direction: column;">
        
        <!-- Xero Instance Dropdown -->
        <div class="form-group" style="margin-bottom: 20px; max-width: 400px; flex-shrink: 0;">
            <label for="contactsXeroInstanceSelect">Xero Instance:</label>
            <select class="form-control" id="contactsXeroInstanceSelect">
                {% for instance in xero_instances %}
                    <option value="{{ instance.xero_instance_pk }}" {% if forloop.first %}selected{% endif %}>
                        {{ instance.xero_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Contacts Table (scrollable) -->
        <div style="flex: 1; overflow-y: auto; position: relative;">
            {% include 'core/components/reusable_table.html' with columns=contacts_columns rows=contacts_rows show_totals=False %}
        </div>
        
        <!-- Footer Buttons - sticky at bottom -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; padding: 10px 15px; margin-top: auto; background: var(--gradient-primary); border-radius: 0 0 8px 8px;">
            <button type="button" class="btn btn-light" id="pullXeroContactsBtn">Pull/Update Xero Contacts</button>
            <button type="button" class="btn btn-light" id="addContactBtn">Add Contact</button>
        </div>
    </div>

    <!-- Projects Section -->
    {% include 'dashboard/projects.html' %}

    <!-- Bills Section -->
    {% include 'dashboard/bills.html' %}
    
    <!-- Settings Section -->
    {% include 'dashboard/settings.html' %}
    </div>
</div>

<!-- Old reusable table replaced above -->
<!-- {% include 'core/components/reusable_table.html' with columns=table_columns rows=table_rows show_totals=show_totals %} -->

{{ ... }}
{% include 'dashboard/xero_modals.html' %}
{% include 'dashboard/contacts.html' %}
{% include 'core/components/reusable_bills_modal.html' %}
{% include 'core/quotes_modals.html' %}

<script src="{% static 'core/js/xero.js' %}"></script>
<script src="{% static 'core/js/quotes_entry.js' %}"></script>
<script src="{% static 'core/js/documents.js' %}"></script>

<script>
    $(document).ready(function() {
        // Global variable to track current Bills modal type ('inbox' or 'direct')
        var currentBillsModalType = null;
        
        // Universal function to hide all workspace sections
        window.hideAllSections = function() {
            $('#emptyState').hide();
            $('#billsInboxSection').hide();
            $('#allocationsSection').hide();
            $('#contactsSection').hide();
            $('#projectsSection').hide();
            $('#xeroSection').hide();
            $('#settingsSection').hide();
            
            // Remove tender view background image and overlay
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            $('.workspace-background-overlay').remove();
        };
        
        // Handle navbar dropdown toggle
        $('.nav-dropdown-toggle').click(function(e) {
            e.preventDefault();
            var menu = $(this).siblings('.nav-dropdown-menu');
            var dropdown = $(this).closest('.nav-dropdown');
            menu.toggleClass('show');
            dropdown.toggleClass('open');
        });
        
        // Dashboard link - resets workspace to empty state
        $('#dashboardLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show empty state and remove has-content class to show background
            $('#emptyState').show();
            $('#dynamicContentArea').removeClass('has-content');
            
            // Clear any selected bills
            currentSelectedInvoicePk = null;
            $('#billsTableBody').empty();
            $('#allocationsTableBody').empty();
            $('#billViewer').hide();
            $('#viewerPlaceholder').show();
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Contacts controller - shows inline in workspace
        $('#contactsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show contacts section and add has-content class to hide background
            $('#contactsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Load contacts for the selected Xero instance
            const instancePk = $('#contactsXeroInstanceSelect').val();
            if (instancePk && typeof loadContacts === 'function') {
                loadContacts(instancePk);
            }
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Settings controller - shows inline in workspace
        $('#settingsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            window.hideAllSections();
            
            // Reset tender view state
            if (typeof window.resetTenderViewState === 'function') {
                window.resetTenderViewState();
            }
            
            // Show settings section and add has-content class to hide background
            $('#settingsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Handle Xero instance change in workspace contacts dropdown
        $(document).on('change', '#contactsXeroInstanceSelect', function() {
            const instancePk = $(this).val();
            if (instancePk && typeof loadContacts === 'function') {
                loadContacts(instancePk);
            }
        });
        
        // Toggle Database Wipe Button visibility with SHIFT+BIN sequence
        let binSequence = [];
        const BIN_SEQUENCE = ['b', 'i', 'n'];
        let shiftHeld = false;
        
        $(document).on('keydown', function(e) {
            // Track shift key
            if (e.key === 'Shift') {
                shiftHeld = true;
                binSequence = []; // Reset sequence when shift is pressed
                return;
            }
            
            // Only track keys while shift is held
            if (!shiftHeld) {
                binSequence = [];
                return;
            }
            
            const key = e.key.toLowerCase();
            binSequence.push(key);
            
            // Check if sequence matches so far
            for (let i = 0; i < binSequence.length; i++) {
                if (binSequence[i] !== BIN_SEQUENCE[i]) {
                    binSequence = [];
                    return;
                }
            }
            
            // Check if full sequence is complete (SHIFT+B+I+N)
            if (binSequence.length === BIN_SEQUENCE.length) {
                e.preventDefault();
                $('#wipeDbBtn').toggleClass('visible');
                binSequence = [];
            }
        });
        
        $(document).on('keyup', function(e) {
            if (e.key === 'Shift') {
                shiftHeld = false;
                binSequence = [];
            }
        });
        
        // Database Wipe Button Handler
        $('#wipeDbBtn').click(function() {
            // First confirmation
            if (!confirm('⚠️ WARNING: This will permanently delete ALL data from the database!\n\nThis includes:\n• All projects\n• All quotes and allocations\n• All bills and invoices\n• All contacts\n• All documents\n• All claims and variations\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to continue?')) {
                return;
            }
            
            // Second confirmation (type to confirm)
            const confirmText = prompt('To confirm, type "DELETE ALL DATA" (in capital letters):');
            if (confirmText !== 'DELETE ALL DATA') {
                alert('Confirmation text did not match. Database wipe cancelled.');
                return;
            }
            
            // Show loading state
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Send request to wipe database
            fetch('/core/wipe_database/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('✓ Database wiped successfully!\n\n' + data.tables_wiped + ' tables were cleared.\n\nThe page will now reload.');
                    // Reload the page
                    window.location.reload();
                } else {
                    alert('✗ Error wiping database:\n\n' + data.message);
                    $('#wipeDbBtn').prop('disabled', false).html('<i class="fas fa-trash-alt"></i>');
                }
            })
            .catch(error => {
                console.error('Error wiping database:', error);
                alert('✗ Error wiping database:\n\n' + error);
                $('#wipeDbBtn').prop('disabled', false).html('<i class="fas fa-trash-alt"></i>');
            });
        });
    });
</script>

{% endblock %}
