{% load static %}

<!--
Template: Contacts Modal (Dashboard Extended Version)

Purpose:
Extended contacts management modal that adds Xero instance selection, contact verification,
and additional functionality to the base reusable_contacts_modal.html component.

Components:
1. Base Modal Extension
   - Includes core/components/reusable_contacts_modal.html
   - Dynamically adds Xero Instance dropdown to modal body
   - Adds Delete button to modal footer

2. Verify Details Modal (#verifyContactModal)
   - Side-by-side comparison of Xero data vs Verified data
   - Highlights mismatches in yellow (Xero) and red (Verified)
   - Fields: Name, Email, BSB, Account Number, ABN
   - Notes section with previous/new notes comparison
   - Verify button to save verified details via /verify_contact_details/

JavaScript Features:
- MutationObserver to add "Verify" buttons to contact rows
- Click handler for Verify buttons - opens verification modal
- Format BSB as XXX-XXX and ABN as XX XXX XXX XXX
- Mismatch detection and highlighting
- AJAX submission to verify_contact_details endpoint
- Updates contact row with verified badge after successful verification

Backend Endpoints Used:
- POST /verify_contact_details/{contact_pk}/ - Save verified contact details
-->

<!-- Extended Contacts Modal with XeroInstances dropdown, Pull Xero Contacts, and Delete button -->

<!-- Wrapper to override blocks in base modal -->
<div style="display: none;">
    {% block contacts_modal_body %}
    {% endblock %}
    {% block contacts_modal_footer %}
    {% endblock %}
</div>

<!-- Include base modal -->
{% include 'core/components/reusable_contacts_modal.html' %}

<!-- Verify Details Modal -->
<div class="modal fade" id="verifyContactModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 900px; margin-top: 80px;">
        <div class="modal-content" style="border: 3px solid black;">
            <div class="modal-header" style="text-align: center; background: var(--gradient-primary-45deg);">
                <h5 class="modal-title">Verify Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-sm table-bordered" style="margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #e9ecef;">
                            <th style="width: 20%;">Detail</th>
                            <th style="width: 40%;">Xero Data</th>
                            <th style="width: 40%;">Verified Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th style="background-color: #f8f9fa;">Name</th>
                            <td id="verify-name"></td>
                            <td id="verify-name-verified" style="color: #6c757d; font-style: italic;"></td>
                        </tr>
                        <tr>
                            <th style="background-color: #f8f9fa;">Email</th>
                            <td id="verify-email"></td>
                            <td id="verify-email-verified" style="color: #6c757d; font-style: italic;"></td>
                        </tr>
                        <tr>
                            <th style="background-color: #f8f9fa;">BSB</th>
                            <td id="verify-bsb"></td>
                            <td id="verify-bsb-verified" style="color: #6c757d; font-style: italic;"></td>
                        </tr>
                        <tr>
                            <th style="background-color: #f8f9fa;">Account</th>
                            <td id="verify-account"></td>
                            <td id="verify-account-verified" style="color: #6c757d; font-style: italic;"></td>
                        </tr>
                        <tr>
                            <th style="background-color: #f8f9fa;">ABN</th>
                            <td id="verify-abn"></td>
                            <td id="verify-abn-verified" style="color: #6c757d; font-style: italic;"></td>
                        </tr>
                    </tbody>
                </table>
                
                <h6 style="margin-bottom: 10px;">Notes</h6>
                <div class="row">
                    <div class="col-md-6">
                        <label style="font-size: 0.9em; color: #6c757d;">New Notes</label>
                        <textarea class="form-control" id="verify-notes" rows="4" placeholder="Enter verification notes..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label style="font-size: 0.9em; color: #6c757d;">Previous Notes</label>
                        <div id="verify-notes-verified" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; min-height: 92px; background-color: #f8f9fa; color: #6c757d; font-style: italic; overflow-y: auto; white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="verifyContactBtn">Verify</button>
            </div>
        </div>
    </div>
</div>

<!-- Override modal body and footer with JavaScript -->
<script>
    $(document).ready(function() {
        // Add XeroInstances dropdown to modal body
        const xeroDropdown = `
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="xeroInstanceSelect">Xero Instance:</label>
                <select class="form-control" id="xeroInstanceSelect">
                    {% for instance in xero_instances %}
                        <option value="{{ instance.xero_instance_pk }}" {% if forloop.first %}selected{% endif %}>
                            {{ instance.xero_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        `;
        
        // Insert dropdown before the table when modal is shown
        $('#contactsModal').on('show.bs.modal', function() {
            const modalBody = $(this).find('.modal-body > div[style*="overflow-x"]');
            if (!$(this).find('#xeroInstanceSelect').length) {
                modalBody.before(xeroDropdown);
            }
            
            // Add Delete button after Archive button if not already present
            const archiveBtn = $(this).find('#archiveContactBtn');
            if (archiveBtn.length && !$(this).find('#deleteContactBtn').length) {
                archiveBtn.after('<button type="button" class="btn btn-danger" id="deleteContactBtn" style="margin-left: 10px;">Delete</button>');
            }
        });
        
        function updateVerifiedRow(contactPk, updatedData) {
            const rows = $(`#contactsSection tbody tr[data-contact-pk="${contactPk}"], #contactsModal tbody tr[data-contact-pk="${contactPk}"]`);
            if (!rows.length) {
                return;
            }

            rows.each(function() {
                const row = $(this);
                const nameCell = row.find('.contact-name');
                nameCell.find('.verified-badge').remove();
                nameCell.append(' <span class="badge badge-success verified-badge" style="font-size: 0.7em;">âœ“ Verified</span>');

                const contactData = row.data('contact') || {};
                row.data('contact', {
                    ...contactData,
                    ...updatedData,
                    verified: 1
                });
            });
        }

        // Handle Verify button click
        $(document).on('click', '.verify-contact-btn', function() {
            const row = $(this).closest('tr');
            const contact = row.data('contact');
            
            if (!contact) {
                alert('Contact data not found');
                return;
            }
            
            // Format BSB as XXX-XXX
            let formattedBsb = '';
            if (contact.bank_bsb && contact.bank_bsb.length === 6) {
                formattedBsb = contact.bank_bsb.substring(0, 3) + '-' + contact.bank_bsb.substring(3);
            } else {
                formattedBsb = contact.bank_bsb || '';
            }
            
            // Format ABN as XX XXX XXX XXX
            let formattedAbn = '';
            if (contact.tax_number) {
                const abn = contact.tax_number.replace(/\s/g, '');
                if (abn.length === 11) {
                    formattedAbn = abn.substring(0, 2) + ' ' + abn.substring(2, 5) + ' ' + abn.substring(5, 8) + ' ' + abn.substring(8);
                } else {
                    formattedAbn = contact.tax_number;
                }
            }
            
            // Format verified BSB
            let formattedVerifiedBsb = '';
            if (contact.verified_bank_bsb && contact.verified_bank_bsb.length === 6) {
                formattedVerifiedBsb = contact.verified_bank_bsb.substring(0, 3) + '-' + contact.verified_bank_bsb.substring(3);
            } else {
                formattedVerifiedBsb = contact.verified_bank_bsb || '';
            }
            
            // Format verified ABN
            let formattedVerifiedAbn = '';
            if (contact.verified_tax_number) {
                const abn = contact.verified_tax_number.replace(/\s/g, '');
                if (abn.length === 11) {
                    formattedVerifiedAbn = abn.substring(0, 2) + ' ' + abn.substring(2, 5) + ' ' + abn.substring(5, 8) + ' ' + abn.substring(8);
                } else {
                    formattedVerifiedAbn = contact.verified_tax_number;
                }
            }
            
            // Check for mismatches
            const nameMatches = contact.verified_name === contact.name;
            const emailMatches = contact.verified_email === contact.email;
            const bsbMatches = contact.verified_bank_bsb === contact.bank_bsb;
            const accountMatches = contact.verified_bank_account_number === contact.bank_account_number;
            
            // Populate verification modal - Xero Data column with mismatch highlighting
            $('#verify-name').text(contact.name || '')
                .css('background-color', contact.verified_name && !nameMatches ? '#fff3cd' : '');
            $('#verify-email').text(contact.email || '')
                .css('background-color', contact.verified_email && !emailMatches ? '#fff3cd' : '');
            $('#verify-bsb').text(formattedBsb)
                .css('background-color', contact.verified_bank_bsb && !bsbMatches ? '#fff3cd' : '');
            $('#verify-account').text(contact.bank_account_number || '')
                .css('background-color', contact.verified_bank_account_number && !accountMatches ? '#fff3cd' : '');
            $('#verify-abn').text(formattedAbn);
            
            $('#verify-name-verified').text(contact.verified_name || '(not verified)')
                .css('background-color', contact.verified_name && !nameMatches ? '#ffebee' : '');
            $('#verify-email-verified').text(contact.verified_email || '(not verified)')
                .css('background-color', contact.verified_email && !emailMatches ? '#ffebee' : '');
            $('#verify-bsb-verified').text(formattedVerifiedBsb || '(not verified)')
                .css('background-color', contact.verified_bank_bsb && !bsbMatches ? '#ffebee' : '');
            $('#verify-account-verified').text(contact.verified_bank_account_number || '(not verified)')
                .css('background-color', contact.verified_bank_account_number && !accountMatches ? '#ffebee' : '');
            $('#verify-abn-verified').text(formattedVerifiedAbn || '(not verified)');
            
            // Populate notes sections
            $('#verify-notes').val('');
            $('#verify-notes-verified').text(contact.verified_notes || '(no previous notes)');
            
            // Store contact_pk for later use
            $('#verifyContactModal').data('contact-pk', contact.contact_pk);
            
            // Show verification modal
            $('#verifyContactModal').modal('show');
        });
        
        // Verify button handler
        $(document).on('click', '#verifyContactBtn', function() {
            const button = $(this);
            const contactPk = $('#verifyContactModal').data('contact-pk');
            
            // Get values from modal
            const name = $('#verify-name').text().trim();
            const email = $('#verify-email').text().trim();
            const bsb = $('#verify-bsb').text().trim();
            const accountNumber = $('#verify-account').text().trim();
            const abn = $('#verify-abn').text().trim();
            const notes = $('#verify-notes').val().trim();
            
            // Validation - all fields required except ABN
            if (!name) {
                alert('Name is required');
                return;
            }
            
            if (!email) {
                alert('Email is required');
                return;
            }
            
            if (!bsb) {
                alert('BSB is required');
                return;
            }
            
            if (!accountNumber) {
                alert('Account Number is required');
                return;
            }
            
            if (!notes) {
                alert('Notes are required');
                return;
            }
            
            // Show processing state
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Verifying...');
            
            // Make AJAX call to verify contact
            fetch(`/verify_contact_details/${contactPk}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    bsb: bsb.replace('-', ''), // Remove dash for storage
                    account_number: accountNumber,
                    tax_number: abn.replace(/\s/g, ''), // Remove spaces for storage
                    notes: notes
                })
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                if (body.status === 'success') {
                    alert('Contact details verified successfully!');
                    
                    // Close the verification modal
                    $('#verifyContactModal').modal('hide');
                    
                    // Update the main contacts table to show verified status
                    updateVerifiedRow(contactPk, {
                        verified_name: name,
                        verified_email: email,
                        verified_bank_bsb: bsb.replace('-', ''),
                        verified_bank_account_number: accountNumber,
                        verified_tax_number: abn.replace(/\s/g, ''),
                        verified_notes: notes
                    });
                    
                    button.prop('disabled', false).html('Verify');
                } else {
                    throw new Error(body.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error verifying contact:', error);
                button.prop('disabled', false).html('Verify');
                alert(`Failed to verify contact: ${error.message}`);
            });
        });
    });
</script>
