<!-- Hidden template storage for items template -->
<div id="itemsTemplateStorage" style="display: none;">
    {% include 'dashboard/items_template.html' %}
</div>

<!-- Hidden template storage for documents template -->
<div id="documentsTemplateStorage" style="display: none;">
    {% include 'core/documents.html' %}
</div>

<!-- Hidden template storage for contract budget template -->
<div id="contractBudgetTemplateStorage" style="display: none;">
    {% include 'dashboard/contract_budget.html' %}
</div>

<!-- Hidden template storage for PO template -->
<div id="poTemplateStorage" style="display: none;">
    {% include 'core/po.html' %}
</div>

<style>
    /* Compact Projects Table Styling */
    #projectsTable .form-control-sm {
        font-size: 11px !important;
        padding: 2px 4px !important;
        height: 26px !important;
        min-height: 26px !important;
    }
    
    #projectsTable select.form-control-sm {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
    }
    
    #projectsTable input[type="text"],
    #projectsTable input[type="file"] {
        font-size: 11px !important;
        padding: 2px 4px !important;
        height: 26px !important;
    }
    
    #projectsTable .btn-sm {
        padding: 3px 8px !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        min-height: 26px !important;
        height: 26px !important;
    }
    
    #projectsTable .btn-sm i {
        font-size: 12px !important;
    }
    
    #projectsTable .btn {
        padding: 3px 8px !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        min-height: 26px !important;
        height: 26px !important;
    }
    
    /* Keep update button at normal height for better UX */
    #projectsTable .update-project-btn,
    #projectsTable .save-new-project-btn,
    #projectsTable .cancel-add-project-btn {
        height: auto !important;
        min-height: 28px !important;
        padding: 4px 10px !important;
    }
    
    /* Compact background images */
    #projectsTable img {
        max-width: 50px !important;
        max-height: 28px !important;
    }
    
    /* Override Bootstrap table cell padding */
    #projectsTable td {
        padding: 5px 6px !important;
        vertical-align: middle !important;
    }
    
    #projectsTable th {
        padding: 6px 6px !important;
    }
    
    /* Sticky header for Tender Quotes table */
    #tenderCommittedQuotesTable thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Quotes/POs table row selection styling */
    .quotes-table tbody tr,
    .pos-table tbody tr {
        transition: opacity 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    /* When there's a selected row, dim all non-selected rows */
    .quotes-table tbody.has-selection tr:not(.selected-row),
    .pos-table tbody.has-selection tr:not(.selected-row) {
        opacity: 0.4;
    }
    
    /* Highlight the selected row */
    .quotes-table tbody tr.selected-row,
    .pos-table tbody tr.selected-row {
        opacity: 1 !important;
        background-color: #e3f2fd !important;
        box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        position: relative;
    }
    
    /* Keep hover effect visible on all rows */
    .quotes-table tbody tr:hover,
    .pos-table tbody tr:hover {
        opacity: 0.8 !important;
    }
    
    /* Invoices Button Group Styling */
    .invoices-btn-group {
        display: inline-flex;
        align-items: center;
        border: 2px solid transparent;
        border-radius: 8px;
        background: transparent;
        padding: 4px;
        gap: 4px;
        transition: all 0.2s ease;
    }
    
    .invoices-btn-group.active {
        background: linear-gradient(white, white) padding-box,
                    linear-gradient(45deg, var(--gradient-start, #cf66ff) 0%, var(--gradient-end, #0a88ef) 100%) border-box;
        box-shadow: 0 2px 8px rgba(207, 102, 255, 0.3);
    }
    
    .invoices-btn-group .invoices-main-btn {
        border-radius: 0.375rem;
    }
    
    .invoices-btn-group .invoices-sub-btn {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 0.375rem;
        background-color: #e9ecef;
        border: none;
        color: #495057;
        transition: all 0.2s ease;
        display: none;
    }
    
    .invoices-btn-group.active .invoices-sub-btn {
        display: inline-block;
    }
    
    .invoices-btn-group .invoices-sub-btn:hover {
        background-color: #dee2e6;
    }
    
    .invoices-btn-group .invoices-sub-btn.active {
        background: linear-gradient(45deg, var(--gradient-start, #cf66ff) 0%, var(--gradient-end, #0a88ef) 100%);
        color: white;
    }
    
    /* Keep Invoices button blue when group is active */
    .invoices-btn-group.active .invoices-main-btn {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>

<!-- Projects Section (hidden initially, shown when Projects clicked) -->
<div id="projectsSection" style="display: none; height: 100%; flex-direction: column;">
    
    <!-- Projects Table (scrollable with fixed header) -->
    <div style="flex: 1; margin-bottom: 15px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="overflow-y: auto; flex: 1;">
            <table class="reusable-table" id="projectsTable" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Status</th>
                        <th>Test</th>
                        <th>Type</th>
                        <th>Xero Instance</th>
                        <th>Sales Account</th>
                        <th>Manager</th>
                        <th>Manager Email</th>
                        <th>Contracts Admin Emails</th>
                        <th>Background Image</th>
                        <th>Last Edited</th>
                        <th>Last Invoiced</th>
                        <th>Bills Status</th>
                        <th style="width: 100px; text-align: center;">Update</th>
                        <th style="width: 80px; text-align: center;" id="archiveColumnHeader">Archive</th>
                    </tr>
                </thead>
                <tbody id="projectsTableBody">
                    <!-- Projects will be populated here via JavaScript -->
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 40px; color: #6c757d;">
                            No projects found. Click "Add Project" to create one.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Construction View (hidden initially, shown when Construction link clicked) -->
    <div id="constructionView" style="display: none; height: 100%; flex-direction: column;">
        <!-- Back button and Project heading -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; position: relative;">
            <button id="backToProjectsFromConstructionBtn" class="btn btn-secondary" style="position: absolute; left: 0;">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </button>
            <h3 id="constructionProjectName" style="margin: 0; flex: 1; text-align: center;"></h3>
        </div>
        
        <!-- Construction navigation buttons -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-primary construction-nav-btn" data-section="quotes">Quotes</button>
            <button class="btn btn-primary construction-nav-btn" data-section="pos">POs</button>
            
            <!-- Invoices button group with sub-menu -->
            <div id="invoicesButtonGroup" class="invoices-btn-group">
                <button class="btn btn-primary construction-nav-btn invoices-main-btn" data-section="invoices">Invoices</button>
                <button class="btn invoices-sub-btn active" data-subsection="unallocated">Unallocated</button>
                <button class="btn invoices-sub-btn" data-subsection="allocated">Allocated</button>
            </div>
            
            <button class="btn btn-primary construction-nav-btn" data-section="contract-budget">Contract Budget</button>
            <button class="btn btn-primary construction-nav-btn" data-section="hc-variations">HC Variations</button>
            <button class="btn btn-primary construction-nav-btn" data-section="hc-claims">HC Claims</button>
            <button class="btn btn-primary construction-nav-btn" data-section="documents">Documents</button>
            
            <!-- Dynamic action buttons (shown based on selected section) -->
            <button id="constructionNewQuoteBtn" class="btn btn-success" style="display: none; margin-left: 10px;">
                <i class="fas fa-plus"></i> New Quote
            </button>
        </div>
        
        <!-- Hidden file input for quote PDF upload -->
        <input type="file" id="constructionQuotePdfInput" accept="application/pdf" style="display: none;">
        
        <!-- Construction content area -->
        <div id="constructionContentArea" style="flex: 1; padding: 0; overflow-y: auto;">
            <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
        </div>
    </div>
    
    <!-- Tender View (hidden initially, shown when Tender link clicked) -->
    <div id="tenderView" style="display: none; height: 100%; flex-direction: column;">
        <!-- Back button and Project heading -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; position: relative;">
            <button id="backToProjectsBtn" class="btn btn-secondary" style="position: absolute; left: 0;">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </button>
            <h3 id="tenderProjectName" style="margin: 0; flex: 1; text-align: center;"></h3>
        </div>
        
        <!-- Tender navigation buttons -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary tender-nav-btn" data-section="items">Items</button>
            <button class="btn btn-primary tender-nav-btn" data-section="quotes">Quotes</button>
            <button class="btn btn-primary tender-nav-btn" data-section="documents">Documents</button>
            <button class="btn btn-primary tender-nav-btn" data-section="contract-budget">Contract Budget</button>
            
            <!-- Dynamic action buttons (shown based on selected section) -->
            <button id="newQuoteBtn" class="btn btn-success" style="display: none; margin-left: 10px;">
                <i class="fas fa-plus"></i> New Quote
            </button>
        </div>
        
        <!-- Hidden file input for quote PDF upload -->
        <input type="file" id="tenderQuotePdfInput" accept="application/pdf" style="display: none;">
        
        <!-- Tender content area -->
        <div id="tenderContentArea" style="flex: 1; padding: 0; overflow-y: auto;">
            <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
        </div>
    </div>
    
    <!-- Footer Buttons -->
    <div id="projectsFooterButtons" style="display: flex; justify-content: space-between; flex-shrink: 0;">
        <button id="toggleArchiveBtn" class="btn btn-secondary" data-showing-archived="0">
            <i class="fas fa-archive"></i> Show Archived
        </button>
        <button id="addProjectBtn" class="btn btn-success">Add Project</button>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Function to reset tender view state (make it global so other scripts can call it)
        window.resetTenderViewState = function() {
            // Reset all tender navigation buttons to default state
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Hide all dynamic action buttons
            $('#newQuoteBtn').hide();
            
            // Clear tender content area
            $('#tenderContentArea').html(`
                <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
            `);
            
            // Clear current tender project
            window.currentTenderProject = null;
        };
        
        // Projects controller - shows inline in workspace
        $('#projectsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            if (typeof window.hideAllSections === 'function') {
                window.hideAllSections();
            }
            
            // Reset tender view state when returning to projects
            resetTenderViewState();
            
            // Reset construction view state when returning to projects
            if (typeof window.resetConstructionViewState === 'function') {
                resetConstructionViewState();
            }
            
            // Hide tender and construction views if showing
            $('#tenderView').hide();
            $('#constructionView').hide();
            
            // Show projects section and add has-content class to hide background
            $('#projectsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Show projects table and footer buttons
            $('#projectsTable').closest('div').parent().show();
            $('#projectsFooterButtons').show();
            
            // Load projects data
            loadProjects();
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Function to load and display projects
        function loadProjects(showArchived) {
            const archived = showArchived ? '1' : '0';
            
            $.ajax({
                url: '{% url "core:get_projects" %}',
                type: 'GET',
                data: { archived: archived },
                success: function(response) {
                    if (response.status === 'success') {
                        populateProjectsTable(response.projects, showArchived);
                    } else {
                        alert('Error loading projects: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading projects:', error);
                    alert('Failed to load projects. Please try again.');
                }
            });
        }
        
        // Function to populate projects table with data
        function populateProjectsTable(projects, showingArchived) {
            const tbody = $('#projectsTableBody');
            const archiveHeader = $('#archiveColumnHeader');
            
            console.log('üìä Populating projects table with', projects.length, 'projects');
            
            // Update archive column header based on view
            if (showingArchived) {
                archiveHeader.html('Unarchive');
            } else {
                archiveHeader.html('Archive');
            }
            
            // Clear existing rows (except add row if present)
            tbody.find('tr:not(.add-project-row)').remove();
            
            if (projects.length === 0) {
                // Show empty state if no projects and no add row
                if (tbody.find('.add-project-row').length === 0) {
                    const message = showingArchived ? 'No archived projects found.' : 'No projects found. Click "Add Project" to create one.';
                    tbody.html(`
                        <tr>
                            <td colspan="15" style="text-align: center; padding: 40px; color: #6c757d;">
                                ${message}
                            </td>
                        </tr>
                    `);
                }
                return;
            }
            
            // Add project rows
            projects.forEach(project => {
                console.log(`üìÅ Project: ${project.project}`);
                console.log(`  - Background URL: ${project.background_url || '(none)'}`);
                
                const row = $(`<tr data-project-pk="${project.projects_pk}"></tr>`);
                
                // Store original data for update functionality
                row.data('original-project', project.project);
                row.data('original-sales-account', project.xero_sales_account || '');
                row.data('original-manager', project.manager || '');
                row.data('original-manager-email', project.manager_email || '');
                row.data('original-contracts-admin-emails', project.contracts_admin_emails || '');
                row.data('xero-instance-pk', project.xero_instance_pk);
                row.data('background-url', project.background_url || '');
                row.data('project-type', project.project_type);
                
                // Build background image cell
                let backgroundCell = '-';
                if (project.background_url) {
                    console.log(`  - Creating img tag for: ${project.background_url}`);
                    backgroundCell = `<img src="${project.background_url}" alt="Background" style="max-width: 60px; max-height: 40px; cursor: pointer;" onclick="window.open('${project.background_url}', '_blank')">`;
                } else {
                    console.log(`  - No background URL, showing "-"`);
                }
                
                // Build archive/unarchive button
                let archiveButton;
                if (showingArchived) {
                    archiveButton = `<button class="btn btn-sm btn-info unarchive-project-btn" title="Unarchive project">
                        <i class="fas fa-box-open"></i>
                    </button>`;
                } else {
                    archiveButton = `<button class="btn btn-sm btn-danger archive-project-btn" title="Archive project">
                        <i class="fas fa-archive"></i>
                    </button>`;
                }
                
                // Build status display
                let statusDisplay = '-';
                if (project.project_status === 0) {
                    statusDisplay = '<a href="#" class="project-status-link" data-status="0">Tender</a>';
                } else if (project.project_status === 1) {
                    statusDisplay = 'Won (Not Started)';
                } else if (project.project_status === 2) {
                    statusDisplay = 'Started';
                } else if (project.project_status === 3) {
                    statusDisplay = 'Finished';
                }
                
                row.append(`
                    <td class="project-name">${project.project}</td>
                    <td class="project-status">${statusDisplay}</td>
                    <td class="project-test"><a href="#" class="construction-link">construction</a></td>
                    <td>${project.project_type_display}</td>
                    <td>${project.xero_instance_name || '-'}</td>
                    <td class="sales-account">${project.xero_sales_account_display || '-'}</td>
                    <td class="manager">${project.manager || '-'}</td>
                    <td class="manager-email">${project.manager_email || '-'}</td>
                    <td class="contracts-admin-emails">${project.contracts_admin_emails || '-'}</td>
                    <td class="background-image">${backgroundCell}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-primary update-project-btn">Update</button>
                    </td>
                    <td style="text-align: center;">
                        ${archiveButton}
                    </td>
                `);
                
                tbody.append(row);
            });
        }
        
        // Toggle Archive button handler
        $('#toggleArchiveBtn').click(function() {
            const currentlyShowingArchived = $(this).data('showing-archived') === 1;
            const newShowingArchived = !currentlyShowingArchived;
            
            // Update button state
            $(this).data('showing-archived', newShowingArchived ? 1 : 0);
            
            if (newShowingArchived) {
                $(this).html('<i class="fas fa-list"></i> Show Active');
            } else {
                $(this).html('<i class="fas fa-archive"></i> Show Archived');
            }
            
            // Load projects with new filter
            loadProjects(newShowingArchived);
        });
        
        // Add Project button handler - insert blank row at top
        $(document).on('click', '#addProjectBtn', function() {
            const tbody = $('#projectsTableBody');
            
            // Check if add row already exists
            if (tbody.find('.add-project-row').length > 0) {
                alert('Please complete or cancel the current add operation first.');
                return;
            }
            
            // Clear empty state message if present
            tbody.find('tr').filter(function() {
                return $(this).find('td[colspan]').length > 0;
            }).remove();
            
            // Build Xero Instance dropdown options
            const xeroInstances = {{ xero_instances_json|safe }};
            let xeroInstanceOptions = '<option value="">Select Xero Instance *</option>';
            xeroInstances.forEach(instance => {
                xeroInstanceOptions += `<option value="${instance.xero_instance_pk}">${instance.xero_name}</option>`;
            });
            
            // Create add row
            const addRow = $('<tr class="add-project-row" style="background-color: #f8f9fa;"></tr>');
            
            addRow.html(`
                <td><input type="text" class="form-control form-control-sm add-project-name" placeholder="Project name *" required></td>
                <td>-</td>
                <td>-</td>
                <td>
                    <select class="form-control form-control-sm add-project-type">
                        <option value="general">General</option>
                        <option value="development">Development</option>
                        <option value="construction">Construction</option>
                        <option value="precast">Precast</option>
                        <option value="pods">Pods</option>
                    </select>
                </td>
                <td>
                    <select class="form-control form-control-sm add-xero-instance" required>
                        ${xeroInstanceOptions}
                    </select>
                </td>
                <td>
                    <select class="form-control form-control-sm add-sales-account" disabled>
                        <option value="">Select Xero Instance first</option>
                    </select>
                </td>
                <td><input type="text" class="form-control form-control-sm add-manager" placeholder="Manager name"></td>
                <td><input type="email" class="form-control form-control-sm add-manager-email" placeholder="Manager email"></td>
                <td><input type="text" class="form-control form-control-sm add-contracts-admin-emails" placeholder="Emails (semicolon separated)"></td>
                <td><input type="file" class="form-control form-control-sm add-background-image" accept="image/*"></td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td style="text-align: center;">
                    <button class="btn btn-sm btn-success save-new-project-btn">Save</button>
                </td>
                <td style="text-align: center;">
                    <button class="btn btn-sm btn-secondary cancel-add-project-btn">Cancel</button>
                </td>
            `);
            
            tbody.prepend(addRow);
            
            // Focus on project name input
            addRow.find('.add-project-name').focus();
        });
        
        // Handle Xero Instance selection to populate Sales Account dropdown
        $(document).on('change', '.add-xero-instance', function() {
            const xeroInstancePk = $(this).val();
            const salesAccountSelect = $(this).closest('tr').find('.add-sales-account');
            
            if (!xeroInstancePk) {
                salesAccountSelect.prop('disabled', true).html('<option value="">Select Xero Instance first</option>');
                return;
            }
            
            // Fetch accounts for this Xero instance
            $.ajax({
                url: `/core/get_xero_accounts/${xeroInstancePk}/`,
                type: 'GET',
                success: function(response) {
                    salesAccountSelect.prop('disabled', false);
                    salesAccountSelect.empty();
                    salesAccountSelect.append('<option value="">Select Sales Account</option>');
                    
                    if (response.accounts && response.accounts.length > 0) {
                        // Filter for REVENUE, SALES, and OTHERINCOME accounts
                        const revenueAccounts = response.accounts.filter(acc => 
                            acc.account_type === 'REVENUE' || 
                            acc.account_type === 'SALES' || 
                            acc.account_type === 'OTHERINCOME'
                        );
                        
                        revenueAccounts.forEach(account => {
                            salesAccountSelect.append(
                                `<option value="${account.account_code}">${account.account_code} - ${account.account_name}</option>`
                            );
                        });
                    } else {
                        salesAccountSelect.append('<option value="">No accounts found</option>');
                    }
                },
                error: function() {
                    alert('Failed to load Xero accounts');
                    salesAccountSelect.prop('disabled', true).html('<option value="">Error loading accounts</option>');
                }
            });
        });
        
        // Save new project handler
        $(document).on('click', '.save-new-project-btn', function() {
            const row = $(this).closest('tr');
            const projectName = row.find('.add-project-name').val().trim();
            const projectType = row.find('.add-project-type').val();
            const xeroInstancePk = row.find('.add-xero-instance').val();
            const salesAccount = row.find('.add-sales-account').val();
            const manager = row.find('.add-manager').val().trim();
            const managerEmail = row.find('.add-manager-email').val().trim();
            const contractsAdminEmails = row.find('.add-contracts-admin-emails').val().trim();
            const backgroundFile = row.find('.add-background-image')[0].files[0];
            
            // Validate required fields
            if (!projectName) {
                alert('Project name is required');
                row.find('.add-project-name').focus();
                return;
            }
            
            if (!xeroInstancePk) {
                alert('Xero Instance is required');
                row.find('.add-xero-instance').focus();
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('project_name', projectName);
            formData.append('project_type', projectType);
            formData.append('xero_instance_pk', xeroInstancePk);
            if (salesAccount) {
                formData.append('xero_sales_account', salesAccount);
            }
            if (manager) {
                formData.append('manager', manager);
            }
            if (managerEmail) {
                formData.append('manager_email', managerEmail);
            }
            if (contractsAdminEmails) {
                formData.append('contracts_admin_emails', contractsAdminEmails);
            }
            if (backgroundFile) {
                formData.append('background', backgroundFile);
            }
            // Note: project_status will default to 0 (Tender) in the backend
            
            // Show processing state
            $(this).prop('disabled', true).text('Saving...');
            
            // Make AJAX call to create project
            $.ajax({
                url: '{% url "core:create_project" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        // Remove add row
                        row.remove();
                        
                        // Reload projects list to show new project
                        loadProjects();
                        
                        alert('Project created successfully!');
                    } else {
                        alert('Error creating project: ' + response.message);
                        row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating project:', error);
                    alert('Failed to create project. Please try again.');
                    row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                }
            });
        });
        
        // Cancel add project handler
        $(document).on('click', '.cancel-add-project-btn', function() {
            const row = $(this).closest('tr');
            row.remove();
            
            // If no rows left, show empty state
            const tbody = $('#projectsTableBody');
            if (tbody.find('tr').length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #6c757d;">
                            No projects found. Click "Add Project" to create one.
                        </td>
                    </tr>
                `);
            }
        });
        
        // Handle Construction link click - show construction view
        $(document).on('click', '.construction-link', function(e) {
            e.preventDefault();
            
            const row = $(this).closest('tr');
            const projectPk = row.data('project-pk');
            const projectName = row.find('.project-name').text();
            const backgroundUrl = row.data('background-url');
            const xeroInstancePk = row.data('xero-instance-pk');
            const projectType = row.data('project-type');
            
            console.log(`Opening construction view for project: ${projectName} (pk=${projectPk})`);
            console.log(`Background URL: ${backgroundUrl}`);
            console.log(`Xero Instance PK: ${xeroInstancePk}`);
            console.log(`Project Type: ${projectType}`);
            
            // Store current project info globally
            window.currentConstructionProject = {
                pk: projectPk,
                name: projectName,
                backgroundUrl: backgroundUrl,
                xero_instance_pk: xeroInstancePk,
                project_type: projectType
            };
            
            // Apply background image to workspace if it exists
            if (backgroundUrl) {
                $('#dynamicContentArea').css({
                    'background-image': `url(${backgroundUrl})`,
                    'background-size': 'cover',
                    'background-position': 'center',
                    'background-repeat': 'no-repeat',
                    'background-attachment': 'fixed',
                    'position': 'relative'
                });
                
                // Add overlay to darken/fade the background
                if ($('#dynamicContentArea').find('.workspace-background-overlay').length === 0) {
                    $('#dynamicContentArea').prepend('<div class="workspace-background-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); pointer-events: none; z-index: 0;"></div>');
                }
            }
            
            // Hide projects table and footer buttons
            $('#projectsTable').closest('div').parent().hide();
            $('#projectsFooterButtons').hide();
            
            // Show construction view
            $('#constructionView').css('display', 'flex').show();
            $('#constructionProjectName').text(projectName);
        });
        
        // Handle Construction navigation button clicks
        $(document).on('click', '.construction-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Construction section clicked: ${section}`);
            
            // Remove active class from all buttons (except invoices main btn which is handled separately)
            $('.construction-nav-btn:not(.invoices-main-btn)').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Deactivate invoices button group if clicking another section
            if (section !== 'invoices') {
                $('#invoicesButtonGroup').removeClass('active');
                $('.invoices-main-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            }
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#constructionNewQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadConstructionQuotesSection();
            } else if (section === 'pos') {
                loadConstructionPOSection();
            } else if (section === 'contract-budget') {
                loadConstructionContractBudgetSection();
            } else if (section === 'hc-variations') {
                loadConstructionHCVariationsSection();
            } else if (section === 'hc-claims') {
                loadConstructionHCClaimsSection();
            } else if (section === 'invoices') {
                // Activate the invoices button group and show sub-buttons
                $('#invoicesButtonGroup').addClass('active');
                $('.invoices-main-btn').removeClass('btn-outline-primary').addClass('btn-primary');
                // Default to unallocated if no sub-button is active
                const activeSubBtn = $('.invoices-sub-btn.active');
                const subsection = activeSubBtn.length ? activeSubBtn.data('subsection') : 'unallocated';
                loadConstructionInvoicesSection(subsection);
            } else if (section === 'documents') {
                loadConstructionDocumentsSection();
            }
        });
        
        // Handle Invoices sub-menu button clicks
        $(document).on('click', '.invoices-sub-btn', function() {
            const subsection = $(this).data('subsection');
            console.log(`Invoices subsection clicked: ${subsection}`);
            
            // Update active state on sub-buttons
            $('.invoices-sub-btn').removeClass('active');
            $(this).addClass('active');
            
            // Load the appropriate invoices view
            loadConstructionInvoicesSection(subsection);
        });
        
        // Construction Quote Functions - Uses reusable template
        
        // Load the quotes section view for CONSTRUCTION
        function loadConstructionQuotesSection() {
            console.log('Loading quotes section with reusable template');
            
            // Show New Quote button
            $('#constructionNewQuoteBtn').show();
            
            // Load contacts for the project if not already loaded
            if (!window.constructionProjectContacts || window.constructionProjectContacts.length === 0) {
                const projectPk = window.currentConstructionProject.pk;
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectPk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.constructionProjectContacts = response.contacts;
                            console.log('Loaded', response.contacts.length, 'contacts for quotes');
                        }
                    }
                });
            }
            
            $.ajax({
                url: '{% url "core:quotes" %}',
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                    // Now fetch and populate the quotes
                    loadQuotesData();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Quotes</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load quotes data for the current project
        function loadQuotesData() {
            const projectPk = window.currentConstructionProject.pk;
            console.log('Loading quotes for project:', projectPk);
            
            // First ensure items are loaded for the allocation dropdowns
            const loadItemsIfNeeded = function() {
                return new Promise((resolve) => {
                    if (window.itemsItems && window.itemsItems.length > 0) {
                        resolve();
                    } else {
                        $.ajax({
                            url: `/get_project_items/${projectPk}/`,
                            type: 'GET',
                            success: function(response) {
                                if (response.status === 'success') {
                                    window.itemsItems = response.items;
                                    console.log('Loaded items for quotes:', window.itemsItems.length);
                                }
                                resolve();
                            },
                            error: function() {
                                console.error('Failed to load items for quotes');
                                resolve();
                            }
                        });
                    }
                });
            };
            
            loadItemsIfNeeded().then(function() {
                $.ajax({
                    url: `/core/get_project_quotes/${projectPk}/`,
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Loaded quotes:', response.quotes.length);
                            window.quotesCostingItems = window.itemsItems || [];
                            console.log('Costing items for quotes:', window.quotesCostingItems.length);
                            populateQuotesTable(response.quotes, window.constructionProjectContacts || []);
                        } else {
                            console.error('Error loading quotes:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load quotes:', error);
                        $('#quoteMainTableBody').html(`
                            <tr><td colspan="5" style="text-align: center; color: #dc3545;">Failed to load quotes</td></tr>
                        `);
                    }
                });
            });
        }
        
        // ==========================================
        // NEW QUOTE INLINE ENTRY (Construction)
        // ==========================================
        
        // State for new quote mode
        window.newQuoteMode = false;
        window.newQuotePdfData = null;
        window.newQuotePdfUrl = null;
        window.newQuoteAllocations = [];
        
        // Click handler for New Quote button (construction)
        $(document).on('click', '#constructionNewQuoteBtn', function() {
            console.log('Construction New Quote button clicked');
            $('#constructionQuotePdfInput').click();
        });
        
        // File input change handler for new quote PDF (construction)
        $(document).on('change', '#constructionQuotePdfInput', function(event) {
            var file = event.target.files[0];
            if (file) {
                console.log('Quote PDF selected:', file.name);
                
                var pdfBlobUrl = URL.createObjectURL(file);
                var reader = new FileReader();
                reader.onload = function(e) {
                    var pdfData = e.target.result;
                    
                    // Store PDF data for later save
                    window.newQuotePdfData = pdfData;
                    window.newQuotePdfUrl = pdfBlobUrl;
                    
                    // Enter new quote mode - add editable row inline
                    enterNewQuoteMode();
                };
                reader.onerror = function(e) {
                    console.error('Error reading PDF file:', e);
                    alert('Error reading PDF file. Please try again.');
                };
                reader.readAsDataURL(file);
                
                $(this).val('');
            }
        });
        
        // Enter new quote mode - add editable row at top of table
        function enterNewQuoteMode() {
            window.newQuoteMode = true;
            window.newQuoteAllocations = [];
            
            const tbody = $('#quoteMainTableBody');
            
            // Remove any existing new quote row
            tbody.find('.new-quote-row').remove();
            
            // Remove "no quotes" placeholder if present
            if (tbody.find('tr').length === 1 && tbody.find('tr td[colspan]').length === 1) {
                tbody.empty();
            }
            
            // Build supplier dropdown options
            const suppliers = window.constructionProjectContacts || [];
            let supplierOptions = '<option value="">Select Supplier...</option>';
            suppliers.forEach(function(contact) {
                supplierOptions += `<option value="${contact.contact_pk}">${contact.name}</option>`;
            });
            
            // Create new editable row at TOP
            const newRow = $(`
                <tr class="new-quote-row selected-row" style="background-color: #fffde7 !important; opacity: 1 !important;">
                    <td>
                        <select class="form-control form-control-sm new-quote-supplier" style="font-size: 11px;">
                            ${supplierOptions}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm new-quote-net" 
                               step="0.01" min="0" placeholder="0.00" style="font-size: 11px;">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm new-quote-number" 
                               placeholder="Quote #" maxlength="255" style="font-size: 11px;">
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-secondary new-quote-save-btn" disabled 
                                style="font-size: 10px; padding: 2px 8px;">Save</button>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-outline-danger new-quote-cancel-btn"
                                style="font-size: 10px; padding: 2px 6px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `);
            
            // Prepend to table
            tbody.prepend(newRow);
            
            // Select the new row visually
            tbody.addClass('has-selection');
            tbody.find('tr').removeClass('selected-row');
            newRow.addClass('selected-row');
            
            // Show PDF in viewer
            $('#quotePdfViewer').attr('src', window.newQuotePdfUrl).show();
            $('#quoteViewerPlaceholder').hide();
            
            // Clear allocations table and add empty row for new quote
            const allocBody = $('#quoteAllocationsTableBody');
            allocBody.empty();
            addQuoteAllocationRow(); // Add one empty row
            
            // Update title
            $('#quoteAllocationsTitle').text('Quote Allocations (New Quote)');
            
            // Reset still to allocate
            updateNewQuoteStillToAllocate();
            
            // Focus on supplier dropdown
            newRow.find('.new-quote-supplier').focus();
        }
        
        // Exit new quote mode
        function exitNewQuoteMode() {
            window.newQuoteMode = false;
            window.newQuotePdfData = null;
            window.newQuotePdfUrl = null;
            window.newQuoteAllocations = [];
            
            // Remove new quote row
            $('#quoteMainTableBody').find('.new-quote-row').remove();
            
            // Reset title
            $('#quoteAllocationsTitle').text('Quote Allocations');
            
            // Reload quotes data
            loadQuotesData();
        }
        
        // Validate new quote and update save button state
        function validateNewQuote() {
            const row = $('.new-quote-row');
            if (row.length === 0) return false;
            
            const supplier = row.find('.new-quote-supplier').val();
            const net = parseFloat(row.find('.new-quote-net').val()) || 0;
            const quoteNumber = row.find('.new-quote-number').val().trim();
            
            // Check if we have allocations
            const allocations = getNewQuoteAllocations();
            const totalAllocated = allocations.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            
            // Validation: supplier required, quote number required, allocations should match total
            const isValid = supplier && quoteNumber && allocations.length > 0 && 
                           allocations.some(a => a.item_pk && parseFloat(a.amount) > 0);
            
            // Update save button
            const saveBtn = row.find('.new-quote-save-btn');
            if (isValid) {
                saveBtn.removeClass('btn-secondary').addClass('btn-success').prop('disabled', false);
            } else {
                saveBtn.removeClass('btn-success').addClass('btn-secondary').prop('disabled', true);
            }
            
            return isValid;
        }
        
        // Get allocations for new quote from table
        function getNewQuoteAllocations() {
            const allocations = [];
            $('#quoteAllocationsTableBody tr').each(function() {
                const row = $(this);
                const itemPk = row.find('.quote-allocation-item-select').val();
                const amount = parseFloat(row.find('.quote-allocation-net-input').val()) || 0;
                const notes = row.find('.quote-allocation-notes-input').val() || '';
                
                if (itemPk) {
                    allocations.push({ item_pk: itemPk, amount, notes, qty: null, unit: '', rate: null });
                }
            });
            return allocations;
        }
        
        // Update still to allocate for new quote
        function updateNewQuoteStillToAllocate() {
            if (!window.newQuoteMode) return;
            
            const row = $('.new-quote-row');
            const totalNet = parseFloat(row.find('.new-quote-net').val()) || 0;
            const allocations = getNewQuoteAllocations();
            const totalAllocated = allocations.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            const stillToAllocate = totalNet - totalAllocated;
            
            // Update the still to allocate display
            const stillToAllocateEl = $('#quoteStillToAllocateNet');
            if (stillToAllocateEl.length) {
                stillToAllocateEl.text('$' + stillToAllocate.toFixed(2));
                // Color coding
                if (Math.abs(stillToAllocate) < 0.01) {
                    stillToAllocateEl.css('color', '#90EE90'); // Light green
                } else {
                    stillToAllocateEl.css('color', '#ffcccc'); // Light red
                }
            }
            
            // Validate after updating
            validateNewQuote();
        }
        
        // Save new quote
        function saveNewQuote() {
            if (!validateNewQuote()) {
                alert('Please fill in all required fields and add at least one allocation.');
                return;
            }
            
            const row = $('.new-quote-row');
            const supplierPk = row.find('.new-quote-supplier').val();
            const totalCost = parseFloat(row.find('.new-quote-net').val()) || 0;
            const quoteNumber = row.find('.new-quote-number').val().trim();
            const allocations = getNewQuoteAllocations();
            
            // Prepare data for save
            const saveData = {
                project_pk: window.currentConstructionProject.pk,
                supplier: supplierPk,
                total_cost: totalCost,
                quote_number: quoteNumber,
                line_items: allocations.map(a => ({
                    item: a.item_pk,
                    amount: a.amount,
                    notes: a.notes,
                    qty: a.qty,
                    unit: a.unit,
                    rate: a.rate
                })),
                pdf_data_url: window.newQuotePdfData
            };
            
            // Disable save button while saving
            row.find('.new-quote-save-btn').prop('disabled', true).text('Saving...');
            
            $.ajax({
                url: '/core/save_project_quote/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(saveData),
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Quote saved successfully:', response);
                        exitNewQuoteMode();
                    } else {
                        alert('Error saving quote: ' + response.message);
                        row.find('.new-quote-save-btn').prop('disabled', false).text('Save');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to save quote:', error);
                    alert('Failed to save quote. Please try again.');
                    row.find('.new-quote-save-btn').prop('disabled', false).text('Save');
                }
            });
        }
        
        // Event handlers for new quote row inputs
        $(document).on('change input', '.new-quote-supplier, .new-quote-net, .new-quote-number', function() {
            validateNewQuote();
            if ($(this).hasClass('new-quote-net')) {
                updateNewQuoteStillToAllocate();
            }
        });
        
        // Cancel new quote
        $(document).on('click', '.new-quote-cancel-btn', function() {
            if (confirm('Cancel this new quote entry?')) {
                exitNewQuoteMode();
            }
        });
        
        // Save new quote
        $(document).on('click', '.new-quote-save-btn', function() {
            saveNewQuote();
        });
        
        // Update validation when allocations change (in new quote mode)
        $(document).on('change input', '#quoteAllocationsTableBody input, #quoteAllocationsTableBody select', function() {
            if (window.newQuoteMode) {
                updateNewQuoteStillToAllocate();
            }
        });
        
        // Populate quotes table
        function populateQuotesTable(quotes, suppliers) {
            const tbody = $('#quoteMainTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (quotes.length === 0) {
                tbody.html(`
                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                        No quotes found for this project.
                    </td></tr>
                `);
                $('#quoteMainTableFooter').hide();
                return;
            }
            
            // Store suppliers globally
            window.quoteSectionSuppliers = suppliers;
            
            let totalNet = 0;
            
            quotes.forEach(function(quote) {
                const pdfUrl = quote.pdf_url || '';
                const row = $('<tr>').attr('data-quote-pk', quote.quotes_pk).attr('data-pdf-url', pdfUrl);
                
                // 1. Supplier (read-only text)
                row.append($('<td>').text(quote.supplier_name || '-'));
                
                // 2. $ Net (read-only)
                const netAmount = quote.total_cost ? parseFloat(quote.total_cost) : 0;
                totalNet += netAmount;
                row.append($('<td>').text('$' + netAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                
                // 3. Quote # (read-only)
                row.append($('<td>').text(quote.supplier_quote_number || '-'));
                
                // 4. Update button
                const updateBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning quote-update-btn')
                    .text('Update')
                    .attr('data-quote-pk', quote.quotes_pk)
                    .on('click', function(e) {
                        e.stopPropagation();
                        openQuoteUpdateModal(quote);
                    });
                row.append($('<td>').css('text-align', 'center').append(updateBtn));
                
                // 5. Delete button
                const deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger quote-delete-btn')
                    .html('<i class="fas fa-trash"></i>')
                    .attr('data-quote-pk', quote.quotes_pk)
                    .on('click', function(e) {
                        e.stopPropagation();
                        deleteQuote(quote.quotes_pk, $(this).closest('tr'));
                    });
                row.append($('<td>').css('text-align', 'center').append(deleteBtn));
                
                // Row click handler for selection
                row.on('click', function(e) {
                    if ($(e.target).closest('.quote-update-btn, .quote-delete-btn').length) return;
                    selectQuoteRow($(this));
                });
                
                tbody.append(row);
            });
            
            // Update footer totals
            $('#quoteFooterCol2').text('$' + totalNet.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            $('#quoteMainTableFooter').show();
            
            // Auto-select first row
            setTimeout(function() {
                const firstRow = $('#quoteMainTableBody tr').first();
                if (firstRow.length && firstRow.attr('data-quote-pk')) {
                    selectQuoteRow(firstRow);
                }
            }, 100);
        }
        
        // Select a quote row
        function selectQuoteRow(row) {
            // Skip if already selected (don't refresh PDF or allocations)
            if (row.hasClass('selected-row')) {
                return;
            }
            
            const tbody = $('#quoteMainTableBody');
            tbody.addClass('has-selection');
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            
            const quotePk = row.attr('data-quote-pk');
            const pdfUrl = row.attr('data-pdf-url');
            
            // Load PDF only if different row
            if (pdfUrl) {
                $('#quotePdfViewer').attr('src', pdfUrl).show();
                $('#quoteViewerPlaceholder').hide();
            } else {
                $('#quotePdfViewer').hide();
                $('#quoteViewerPlaceholder').show();
            }
            
            // Load quote allocations
            loadQuoteAllocations(quotePk);
        }
        
        // Load allocations for a quote
        function loadQuoteAllocations(quotePk) {
            console.log('Loading allocations for quote:', quotePk);
            
            $.ajax({
                url: `/core/get_allocations_for_quote/${quotePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        window.currentSelectedQuote = response.quote;
                        populateQuoteAllocationsTable(response.allocations);
                        updateQuoteStillToAllocate();
                    } else {
                        console.error('Error loading quote allocations:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quote allocations:', error);
                }
            });
        }
        
        // Populate quote allocations table
        function populateQuoteAllocationsTable(allocations) {
            const tbody = $('#quoteAllocationsTableBody');
            tbody.empty();
            
            if (!allocations || allocations.length === 0) {
                // Add one empty row for new entry
                addQuoteAllocationRow();
            } else {
                allocations.forEach(function(alloc) {
                    addQuoteAllocationRow(alloc);
                });
            }
            
            // Always update still to allocate after populating
            if (window.newQuoteMode) {
                updateNewQuoteStillToAllocate();
            } else {
                updateQuoteStillToAllocate();
            }
        }
        
        // Add a quote allocation row
        function addQuoteAllocationRow(allocation = null) {
            const tbody = $('#quoteAllocationsTableBody');
            const row = $('<tr>');
            
            if (allocation) {
                row.attr('data-allocation-pk', allocation.quote_allocations_pk);
            }
            
            // 1. Item dropdown
            const itemSelect = $('<select>').addClass('form-control form-control-sm quote-allocation-item-select');
            itemSelect.append($('<option>').val('').text('Select Item...'));
            (window.quotesCostingItems || []).forEach(function(item) {
                const option = $('<option>').val(item.costing_pk).text(item.item);
                if (allocation && allocation.item_pk === item.costing_pk) {
                    option.prop('selected', true);
                }
                itemSelect.append(option);
            });
            itemSelect.on('change', function() {
                if (window.newQuoteMode) {
                    updateNewQuoteStillToAllocate();
                } else {
                    saveQuoteAllocationRow(row);
                }
            });
            row.append($('<td>').append(itemSelect));
            
            // 2. $ Net input
            const netInput = $('<input>')
                .attr('type', 'number')
                .attr('step', '0.01')
                .addClass('form-control form-control-sm quote-allocation-net-input')
                .val(allocation ? parseFloat(allocation.amount).toFixed(2) : '')
                .on('change', function() {
                    if (window.newQuoteMode) {
                        updateNewQuoteStillToAllocate();
                    } else {
                        updateQuoteStillToAllocate();
                        saveQuoteAllocationRow(row);
                    }
                });
            row.append($('<td>').append(netInput));
            
            // 3. Notes input
            const notesInput = $('<input>')
                .attr('type', 'text')
                .addClass('form-control form-control-sm quote-allocation-notes-input')
                .val(allocation ? allocation.notes || '' : '')
                .on('change', function() {
                    if (!window.newQuoteMode) {
                        saveQuoteAllocationRow(row);
                    }
                });
            row.append($('<td>').append(notesInput));
            
            // 4. Delete button
            const deleteBtn = $('<button>')
                .addClass('btn btn-sm btn-danger')
                .html('<i class="fas fa-times"></i>')
                .on('click', function() {
                    deleteQuoteAllocationRow(row);
                });
            row.append($('<td>').css('text-align', 'center').append(deleteBtn));
            
            tbody.append(row);
        }
        
        // Update quote still to allocate values
        function updateQuoteStillToAllocate() {
            if (!window.currentSelectedQuote) return;
            
            const totalNet = parseFloat(window.currentSelectedQuote.total_cost) || 0;
            
            let allocatedNet = 0;
            $('#quoteAllocationsTableBody tr').each(function() {
                allocatedNet += parseFloat($(this).find('.quote-allocation-net-input').val()) || 0;
            });
            
            const remainingNet = totalNet - allocatedNet;
            
            $('#quoteRemainingNet')
                .text('$' + remainingNet.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}))
                .css('color', Math.abs(remainingNet) < 0.01 ? '#90EE90' : '#ffcccc');
        }
        
        // Save a quote allocation row (debounced)
        let quoteAllocationSaveTimeout = null;
        function saveQuoteAllocationRow(row) {
            clearTimeout(quoteAllocationSaveTimeout);
            quoteAllocationSaveTimeout = setTimeout(function() {
                const allocationPk = row.attr('data-allocation-pk');
                const itemPk = row.find('.quote-allocation-item-select').val();
                const net = row.find('.quote-allocation-net-input').val();
                const notes = row.find('.quote-allocation-notes-input').val();
                
                if (!window.currentSelectedQuote) return;
                
                const data = {
                    quote_pk: window.currentSelectedQuote.quotes_pk,
                    item_pk: itemPk || null,
                    amount: net || 0,
                    notes: notes || ''
                };
                
                if (allocationPk) {
                    // Update existing
                    $.ajax({
                        url: `/core/update_quote_allocation/${allocationPk}/`,
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            console.log('Quote allocation updated:', response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to update quote allocation:', error);
                        }
                    });
                } else if (itemPk || net) {
                    // Create new
                    $.ajax({
                        url: '/core/create_quote_allocation/',
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            if (response.status === 'success') {
                                row.attr('data-allocation-pk', response.allocation_pk);
                                console.log('Quote allocation created:', response);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to create quote allocation:', error);
                        }
                    });
                }
            }, 500);
        }
        
        // Delete a quote allocation row
        function deleteQuoteAllocationRow(row) {
            // In new quote mode, just remove the row without AJAX
            if (window.newQuoteMode) {
                row.remove();
                updateNewQuoteStillToAllocate();
                return;
            }
            
            const allocationPk = row.attr('data-allocation-pk');
            
            if (allocationPk) {
                $.ajax({
                    url: `/core/delete_quote_allocation/${allocationPk}/`,
                    type: 'DELETE',
                    success: function(response) {
                        row.remove();
                        updateQuoteStillToAllocate();
                        console.log('Quote allocation deleted');
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete quote allocation:', error);
                    }
                });
            } else {
                row.remove();
                updateQuoteStillToAllocate();
            }
        }
        
        // Delete a quote
        function deleteQuote(quotePk, row) {
            if (!confirm('Are you sure you want to delete this quote?')) return;
            
            $.ajax({
                url: `/core/delete_quote/${quotePk}/`,
                type: 'DELETE',
                success: function(response) {
                    row.remove();
                    // Clear allocations and PDF viewer
                    $('#quoteAllocationsTableBody').empty();
                    $('#quotePdfViewer').hide();
                    $('#quoteViewerPlaceholder').show();
                    console.log('Quote deleted');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to delete quote:', error);
                    alert('Failed to delete quote. Please try again.');
                }
            });
        }
        
        // Open quote update modal (placeholder - uses existing QuotesEntry)
        function openQuoteUpdateModal(quote) {
            console.log('Opening update modal for quote:', quote);
            // This uses the existing QuotesEntry module
            QuotesEntry.init({
                pdfUrl: quote.pdf_url,
                pdfDataUrl: null,
                containerSelector: '#constructionContentArea',
                projectPk: window.currentConstructionProject.pk,
                projectType: window.currentConstructionProject.project_type,
                suppliers: window.constructionProjectContacts,
                items: window.itemsItems,
                existingQuote: quote,
                onSave: function(response) {
                    console.log('Quote updated:', response);
                    loadConstructionQuotesSection();
                },
                onCancel: function() {
                    loadConstructionQuotesSection();
                }
            });
        }
        
        // Add allocation button handler
        $(document).on('click', '#quoteAddAllocationBtn', function() {
            addQuoteAllocationRow();
        });
        
        // Load construction documents section for CONSTRUCTION
        function loadConstructionDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction contract budget section for CONSTRUCTION
        function loadConstructionContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction PO section for CONSTRUCTION
        function loadConstructionPOSection() {
            window.loadSharedPOSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction HC Variations section for CONSTRUCTION
        function loadConstructionHCVariationsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-exchange-alt" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Variations</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // Load construction HC Claims section for CONSTRUCTION
        function loadConstructionHCClaimsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Claims</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // Load construction Invoices section for CONSTRUCTION
        function loadConstructionInvoicesSection(subsection = 'unallocated') {
            console.log(`Loading invoices section: ${subsection}`);
            
            // Determine which template to load based on subsection
            const templateUrl = subsection === 'allocated' 
                ? '/core/invoices/?template=allocated'
                : '{% url "core:invoices" %}';
            const loadFunction = subsection === 'allocated' 
                ? loadAllocatedInvoices 
                : loadUnallocatedInvoices;
            
            $.ajax({
                url: templateUrl,
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                    // Now fetch and populate the invoices
                    loadFunction();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load invoices section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Invoices</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load unallocated invoices data
        function loadUnallocatedInvoices() {
            const projectPk = window.currentConstructionProject.pk;
            console.log('Loading unallocated invoices for project:', projectPk);
            
            $.ajax({
                url: `/core/get_project_invoices/${projectPk}/?status=0`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Loaded invoices:', response.invoices.length);
                        // Store costing items globally for allocation dropdown
                        window.invoiceCostingItems = response.costing_items || [];
                        console.log('Loaded costing items:', window.invoiceCostingItems.length);
                        populateUnallocatedInvoicesTable(response.invoices, response.suppliers);
                    } else {
                        console.error('Error loading invoices:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load invoices:', error);
                    $('#unallocatedInvoicesTableBody').html(`
                        <tr><td colspan="5" style="text-align: center; color: #dc3545;">Failed to load invoices</td></tr>
                    `);
                }
            });
        }
        
        // Populate unallocated invoices table
        function populateUnallocatedInvoicesTable(invoices, suppliers) {
            const tbody = $('#unallocatedInvoicesTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (invoices.length === 0) {
                tbody.html(`
                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                        No unallocated invoices found for this project.
                    </td></tr>
                `);
                return;
            }
            
            // Store suppliers globally for this section
            window.invoiceSectionSuppliers = suppliers;
            
            invoices.forEach(function(invoice) {
                // Use pdf_url if available, otherwise fallback to attachment_url
                const pdfUrl = invoice.pdf_url || invoice.attachment_url || '';
                console.log(`Invoice ${invoice.invoice_pk}: pdf_url=${invoice.pdf_url}, attachment_url=${invoice.attachment_url}, using=${pdfUrl}`);
                const row = $('<tr>').attr('data-invoice-pk', invoice.invoice_pk).attr('data-pdf-url', pdfUrl);
                
                // 1. Supplier dropdown
                const supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                suppliers.forEach(function(supplier) {
                    const option = $('<option>').val(supplier.contact_pk).text(supplier.name);
                    if (invoice.supplier_pk === supplier.contact_pk) {
                        option.prop('selected', true);
                    }
                    supplierSelect.append(option);
                });
                row.append($('<td>').append(supplierSelect));
                
                // 2. Invoice # input
                const invoiceNumberInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm invoice-number-input')
                    .val(invoice.invoice_number || '')
                    .attr('placeholder', 'Invoice #');
                row.append($('<td>').append(invoiceNumberInput));
                
                // 3. $ Net input (limit to 2dp)
                const netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm net-input')
                    .val(invoice.total_net !== null ? invoice.total_net : '')
                    .attr('placeholder', '0.00')
                    .on('input', function() {
                        let value = $(this).val();
                        // Prevent negative
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        // Limit to 2dp
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                        // Auto-calculate GST as 10% of NET (unless GST has been manually edited)
                        const gstInput = $(this).closest('tr').find('.gst-input');
                        if (!gstInput.data('manually-edited')) {
                            const netValue = parseFloat($(this).val());
                            if (!isNaN(netValue)) {
                                gstInput.val((netValue * 0.1).toFixed(2));
                            }
                        }
                    });
                row.append($('<td>').append(netInput));
                
                // 4. $ GST input (limit to 2dp, predicts 10% until manually edited)
                const gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm gst-input')
                    .val(invoice.total_gst !== null ? invoice.total_gst : '')
                    .attr('placeholder', '0.00')
                    .on('focus', function() {
                        // Mark as manually edited once user focuses on it
                        $(this).data('manually-edited', true);
                    })
                    .on('input', function() {
                        let value = $(this).val();
                        // Prevent negative
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        // Limit to 2dp
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                    });
                row.append($('<td>').append(gstInput));
                
                // 5. Allocate button (greyed out initially, turns green when fully allocated)
                const allocateBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary allocate-invoice-btn')
                    .text('Allocate')
                    .css('font-size', '10px')
                    .attr('data-invoice-pk', invoice.invoice_pk)
                    .prop('disabled', true)
                    .attr('title', 'Allocate invoice (enabled when fully allocated)')
                    .on('click', function(e) {
                        e.stopPropagation();
                        allocateInvoice($(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(allocateBtn));
                
                // 6. Delete button
                const deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger delete-invoice-btn')
                    .html('<i class="fas fa-trash"></i>')
                    .attr('data-invoice-pk', invoice.invoice_pk);
                row.append($('<td>').append(deleteBtn));
                
                // Row click handler for selection and PDF viewing (works on any click in the row)
                row.on('click', function(e) {
                    // Don't trigger on delete or allocate button
                    if ($(e.target).closest('.delete-invoice-btn, .allocate-invoice-btn').length) return;
                    
                    selectInvoiceRow($(this));
                });
                
                tbody.append(row);
            });
            
            // Calculate and show footer totals
            let totalNet = 0;
            let totalGst = 0;
            invoices.forEach(function(invoice) {
                totalNet += invoice.total_net || 0;
                totalGst += invoice.total_gst || 0;
            });
            $('#unallocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
            $('#unallocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
            $('#unallocatedInvoicesTableFooter').show();
            
            // Auto-select the first row on page load
            setTimeout(function() {
                const firstRow = $('#unallocatedInvoicesTableBody tr').first();
                console.log('Auto-selecting first row:', firstRow.length, 'invoice_pk:', firstRow.attr('data-invoice-pk'), 'pdf_url:', firstRow.attr('data-pdf-url'));
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectInvoiceRow(firstRow);
                }
            }, 100);
        }
        
        // Helper function to select an invoice row
        function selectInvoiceRow(row) {
            // Skip if already selected (don't refresh PDF or allocations)
            if (row.hasClass('selected-row')) {
                return;
            }
            
            console.log('selectInvoiceRow called, pdf_url:', row.attr('data-pdf-url'));
            const tbody = $('#unallocatedInvoicesTableBody');
            
            // Remove selection from other rows
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            
            // Add has-selection class to tbody for dimming effect
            tbody.addClass('has-selection');
            
            // Store current selected invoice data
            window.currentSelectedInvoice = {
                invoice_pk: row.attr('data-invoice-pk'),
                total_net: parseFloat(row.find('.net-input').val()) || 0,
                total_gst: parseFloat(row.find('.gst-input').val()) || 0
            };
            
            // Clear allocations section and load existing allocations
            $('#invoiceAllocationsTableBody').empty();
            loadInvoiceAllocations(window.currentSelectedInvoice.invoice_pk);
            
            // Load PDF in viewer
            const pdfUrl = row.attr('data-pdf-url');
            console.log('Loading PDF URL:', pdfUrl);
            if (pdfUrl && pdfUrl !== 'null' && pdfUrl !== '') {
                $('#invoicePdfViewer').attr('src', pdfUrl).show();
                $('#invoiceViewerPlaceholder').hide();
            } else {
                console.log('No PDF URL available for this invoice');
                $('#invoicePdfViewer').hide();
                $('#invoiceViewerPlaceholder').html(`
                    <i class="fas fa-file-pdf" style="font-size: 64px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>No PDF attached to this invoice</p>
                `).show();
            }
        }
        
        // Load existing allocations for an invoice
        function loadInvoiceAllocations(invoicePk) {
            $.ajax({
                url: `/core/get_unallocated_invoice_allocations/${invoicePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        const allocations = response.allocations;
                        console.log('Loaded allocations:', allocations.length);
                        
                        if (allocations.length === 0) {
                            // No existing allocations - create one empty row in database
                            addNewAllocationRow();
                        } else {
                            // Display existing allocations
                            allocations.forEach(function(alloc) {
                                const row = createInvoiceAllocationRow(alloc.allocation_pk, alloc.item_pk, alloc.amount, alloc.gst_amount, alloc.notes);
                                $('#invoiceAllocationsTableBody').append(row);
                            });
                        }
                        
                        updateInvoiceStillToAllocate();
                    } else {
                        console.error('Error loading allocations:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocations:', error);
                }
            });
        }
        
        // Update Still to Allocate values
        function updateInvoiceStillToAllocate() {
            if (!window.currentSelectedInvoice) return;
            
            const totalNet = window.currentSelectedInvoice.total_net;
            const totalGst = window.currentSelectedInvoice.total_gst;
            
            // Calculate allocated amounts from allocation rows
            let allocatedNet = 0;
            let allocatedGst = 0;
            
            $('#invoiceAllocationsTableBody tr').each(function() {
                allocatedNet += parseFloat($(this).find('.allocation-net-input').val()) || 0;
                allocatedGst += parseFloat($(this).find('.allocation-gst-input').val()) || 0;
            });
            
            const remainingNet = totalNet - allocatedNet;
            const remainingGst = totalGst - allocatedGst;
            
            // Update display with thousand comma separators (light colors for gradient background)
            $('#invoiceRemainingNet').text('$' + remainingNet.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})).css('color', Math.abs(remainingNet) < 0.01 ? '#90EE90' : '#ffcccc');
            $('#invoiceRemainingGst').text('$' + remainingGst.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})).css('color', Math.abs(remainingGst) < 0.01 ? '#90EE90' : '#ffcccc');
            
            // Update Allocate button state for the selected row
            const selectedRow = $('#unallocatedInvoicesTableBody tr.selected-row');
            if (selectedRow.length) {
                const allocateBtn = selectedRow.find('.allocate-invoice-btn');
                const isFullyAllocated = Math.abs(remainingNet) < 0.01 && Math.abs(remainingGst) < 0.01;
                
                // Check if all non-zero allocation rows have an item selected
                let allItemsSelected = true;
                $('#invoiceAllocationsTableBody tr').each(function() {
                    const itemVal = $(this).find('.allocation-item-select').val();
                    const netVal = parseFloat($(this).find('.allocation-net-input').val()) || 0;
                    const gstVal = parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                    
                    // Only require item for rows with non-zero amounts
                    if ((netVal > 0 || gstVal > 0) && !itemVal) {
                        allItemsSelected = false;
                        return false; // break
                    }
                });
                
                const canAllocate = isFullyAllocated && allItemsSelected;
                
                if (canAllocate) {
                    allocateBtn.prop('disabled', false)
                        .removeClass('btn-secondary')
                        .addClass('btn-success')
                        .attr('title', 'Click to allocate this invoice');
                } else {
                    let title = 'Allocate invoice (enabled when fully allocated)';
                    if (isFullyAllocated && !allItemsSelected) {
                        title = 'All allocation rows must have an Item selected';
                    }
                    allocateBtn.prop('disabled', true)
                        .removeClass('btn-success')
                        .addClass('btn-secondary')
                        .attr('title', title);
                }
            }
        }
        
        // Allocate invoice - set status to 1 and remove from table
        function allocateInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            
            // Show loading state
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // First, delete any zero-value allocation rows (they're redundant)
            const zeroRowsToDelete = [];
            $('#invoiceAllocationsTableBody tr').each(function() {
                const pk = $(this).attr('data-allocation-pk');
                const netVal = parseFloat($(this).find('.allocation-net-input').val()) || 0;
                const gstVal = parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                
                if (pk && Math.abs(netVal) < 0.01 && Math.abs(gstVal) < 0.01) {
                    zeroRowsToDelete.push(pk);
                }
            });
            
            // Delete zero rows first, then allocate
            const deletePromises = zeroRowsToDelete.map(pk => {
                return $.ajax({
                    url: `/core/delete_unallocated_invoice_allocation/${pk}/`,
                    type: 'POST'
                });
            });
            
            // Wait for all deletes to complete, then allocate
            $.when.apply($, deletePromises).always(function() {
                if (zeroRowsToDelete.length > 0) {
                    console.log('Deleted', zeroRowsToDelete.length, 'zero-value allocation rows');
                }
                
                $.ajax({
                    url: `/core/allocate_invoice/${invoicePk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Invoice allocated:', invoicePk);
                            
                            // Remove the row with a fade effect
                            row.fadeOut(300, function() {
                                $(this).remove();
                                
                                // Clear allocations section
                                $('#invoiceAllocationsTableBody').empty();
                                window.currentSelectedInvoice = null;
                                
                                // Update footer totals
                                recalculateFooterTotals();
                                
                                // Select next available row or show placeholder
                                const firstRow = $('#unallocatedInvoicesTableBody tr').first();
                                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                                    selectInvoiceRow(firstRow);
                                } else {
                                    // No more invoices
                                    $('#unallocatedInvoicesTableBody').html(`
                                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
                                            No unallocated invoices found for this project.
                                        </td></tr>
                                    `);
                                    $('#unallocatedInvoicesTableBody').removeClass('has-selection');
                                    $('#invoicePdfViewer').hide();
                                    $('#invoiceViewerPlaceholder').show();
                                    $('#unallocatedInvoicesTableFooter').hide();
                                }
                            });
                        } else {
                            console.error('Error allocating invoice:', response.message);
                            btn.prop('disabled', false).text(originalText).addClass('btn-success');
                            alert('Failed to allocate invoice: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to allocate invoice:', error);
                        btn.prop('disabled', false).text(originalText).addClass('btn-success');
                        alert('Failed to allocate invoice. Please try again.');
                    }
                });
            });
        }
        
        // Recalculate footer totals
        function recalculateFooterTotals() {
            let totalNet = 0;
            let totalGst = 0;
            
            $('#unallocatedInvoicesTableBody tr').each(function() {
                totalNet += parseFloat($(this).find('.net-input').val()) || 0;
                totalGst += parseFloat($(this).find('.gst-input').val()) || 0;
            });
            
            $('#unallocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
            $('#unallocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
        }
        
        // Add a new allocation row (creates in database first)
        function addNewAllocationRow() {
            if (!window.currentSelectedInvoice) return;
            
            $.ajax({
                url: '/core/create_unallocated_invoice_allocation/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    invoice_pk: window.currentSelectedInvoice.invoice_pk,
                    amount: 0,
                    gst_amount: 0
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        const row = createInvoiceAllocationRow(response.allocation_pk, null, 0, 0, '');
                        $('#invoiceAllocationsTableBody').append(row);
                        updateInvoiceStillToAllocate();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating allocation:', error);
                }
            });
        }
        
        // Add Row button handler for invoice allocations
        $(document).on('click', '#addInvoiceAllocationBtn', function(e) {
            e.preventDefault();
            
            if (!window.currentSelectedInvoice) {
                alert('Please select an invoice first');
                return;
            }
            
            addNewAllocationRow();
        });
        
        // Create an invoice allocation row
        function createInvoiceAllocationRow(allocationPk, itemValue, netAmount, gstAmount, notes) {
            const row = $('<tr>').attr('data-allocation-pk', allocationPk);
            
            // Helper function to save allocation to database (debounced)
            let saveTimeout = null;
            function saveAllocation() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(function() {
                    const pk = row.attr('data-allocation-pk');
                    if (!pk) return;
                    
                    const data = {
                        item_pk: row.find('.allocation-item-select').val() || null,
                        amount: parseFloat(row.find('.allocation-net-input').val()) || 0,
                        gst_amount: parseFloat(row.find('.allocation-gst-input').val()) || 0,
                        notes: row.find('.allocation-notes-input').val() || ''
                    };
                    
                    $.ajax({
                        url: `/core/update_unallocated_invoice_allocation/${pk}/`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function(response) {
                            console.log('Allocation saved:', pk);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error saving allocation:', error);
                        }
                    });
                }, 500); // Debounce 500ms
            }
            
            // 1. Item dropdown (populated with costing items from the project)
            const itemSelect = $('<select>').addClass('form-control form-control-sm allocation-item-select');
            itemSelect.append($('<option>').val('').text('Select Item...'));
            
            // Populate with costing items, grouped by category
            const costingItems = window.invoiceCostingItems || [];
            let currentCategory = null;
            costingItems.forEach(function(item) {
                // Add category optgroup if category changed
                if (item.category__category !== currentCategory) {
                    currentCategory = item.category__category;
                    itemSelect.append($('<optgroup>').attr('label', currentCategory || 'Uncategorized'));
                }
                const option = $('<option>').val(item.costing_pk).text(item.item);
                if (itemValue && item.costing_pk == itemValue) {
                    option.prop('selected', true);
                }
                itemSelect.find('optgroup').last().append(option);
            });
            
            // Save on change and update validation
            itemSelect.on('change', function() {
                saveAllocation();
                updateInvoiceStillToAllocate();
            });
            
            row.append($('<td>').append(itemSelect));
            
            // 2. $ Net input
            const netInput = $('<input>')
                .attr('type', 'number')
                .attr('step', '0.01')
                .attr('min', '0')
                .addClass('form-control form-control-sm allocation-net-input')
                .val(netAmount || '')
                .on('input', function() {
                    let value = $(this).val();
                    if (parseFloat(value) < 0) {
                        $(this).val(0);
                        return;
                    }
                    if (value.includes('.')) {
                        const parts = value.split('.');
                        if (parts[1] && parts[1].length > 2) {
                            $(this).val(parseFloat(value).toFixed(2));
                        }
                    }
                    // Auto-calculate GST as 10%
                    const gstInputEl = $(this).closest('tr').find('.allocation-gst-input');
                    if (!gstInputEl.data('manually-edited')) {
                        const netVal = parseFloat($(this).val());
                        if (!isNaN(netVal)) {
                            gstInputEl.val((netVal * 0.1).toFixed(2));
                        }
                    }
                    updateInvoiceStillToAllocate();
                    saveAllocation();
                });
            row.append($('<td>').append(netInput));
            
            // 3. $ GST input
            const gstInput = $('<input>')
                .attr('type', 'number')
                .attr('step', '0.01')
                .attr('min', '0')
                .addClass('form-control form-control-sm allocation-gst-input')
                .val(gstAmount || '')
                .on('focus', function() {
                    $(this).data('manually-edited', true);
                })
                .on('input', function() {
                    let value = $(this).val();
                    if (parseFloat(value) < 0) {
                        $(this).val(0);
                        return;
                    }
                    if (value.includes('.')) {
                        const parts = value.split('.');
                        if (parts[1] && parts[1].length > 2) {
                            $(this).val(parseFloat(value).toFixed(2));
                        }
                    }
                    updateInvoiceStillToAllocate();
                    saveAllocation();
                });
            row.append($('<td>').append(gstInput));
            
            // 4. Notes input
            const notesInput = $('<input>')
                .attr('type', 'text')
                .addClass('form-control form-control-sm allocation-notes-input')
                .attr('placeholder', 'Notes...')
                .val(notes || '')
                .on('blur', saveAllocation);
            row.append($('<td>').append(notesInput));
            
            // 5. Delete button
            const deleteBtn = $('<button>')
                .addClass('btn btn-sm btn-danger delete-allocation-btn')
                .html('<i class="fas fa-times"></i>')
                .on('click', function() {
                    const pk = row.attr('data-allocation-pk');
                    if (pk) {
                        $.ajax({
                            url: `/core/delete_unallocated_invoice_allocation/${pk}/`,
                            type: 'POST',
                            success: function(response) {
                                console.log('Allocation deleted:', pk);
                                row.remove();
                                updateInvoiceStillToAllocate();
                            },
                            error: function(xhr, status, error) {
                                console.error('Error deleting allocation:', error);
                            }
                        });
                    } else {
                        row.remove();
                        updateInvoiceStillToAllocate();
                    }
                });
            row.append($('<td>').append(deleteBtn));
            
            return row;
        }
        
        // Update invoice totals when net/gst inputs change in the main table
        $(document).on('input', '#unallocatedInvoicesTable .net-input, #unallocatedInvoicesTable .gst-input', function() {
            const row = $(this).closest('tr');
            if (row.hasClass('selected-row') && window.currentSelectedInvoice) {
                window.currentSelectedInvoice.total_net = parseFloat(row.find('.net-input').val()) || 0;
                window.currentSelectedInvoice.total_gst = parseFloat(row.find('.gst-input').val()) || 0;
                updateInvoiceStillToAllocate();
            }
        });
        
        // =====================================================
        // ALLOCATED INVOICES SECTION
        // =====================================================
        
        // Load allocated invoices data
        function loadAllocatedInvoices() {
            const projectPk = window.currentConstructionProject.pk;
            console.log('Loading allocated invoices for project:', projectPk);
            
            $.ajax({
                url: `/core/get_project_invoices/${projectPk}/?status=1`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Loaded allocated invoices:', response.invoices.length);
                        populateAllocatedInvoicesTable(response.invoices, response.suppliers);
                    } else {
                        console.error('Error loading allocated invoices:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocated invoices:', error);
                    $('#allocatedInvoicesTableBody').html(`
                        <tr><td colspan="6" style="text-align: center; color: #dc3545;">Failed to load invoices</td></tr>
                    `);
                }
            });
        }
        
        // Populate allocated invoices table
        function populateAllocatedInvoicesTable(invoices, suppliers) {
            const tbody = $('#allocatedInvoicesTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (invoices.length === 0) {
                tbody.html(`
                    <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
                        No allocated invoices found for this project.
                    </td></tr>
                `);
                return;
            }
            
            invoices.forEach(function(invoice) {
                const pdfUrl = invoice.pdf_url || invoice.attachment_url || '';
                const row = $('<tr>').attr('data-invoice-pk', invoice.invoice_pk).attr('data-pdf-url', pdfUrl);
                
                // 1. Supplier (read-only)
                const supplierName = invoice.supplier_name || 'Unknown';
                row.append($('<td>').text(supplierName));
                
                // 2. Invoice # (read-only)
                row.append($('<td>').text(invoice.invoice_number || '-'));
                
                // 3. $ Net (read-only)
                const netAmount = invoice.total_net ? parseFloat(invoice.total_net).toFixed(2) : '0.00';
                row.append($('<td>').text('$' + netAmount));
                
                // 4. $ GST (read-only)
                const gstAmount = invoice.total_gst ? parseFloat(invoice.total_gst).toFixed(2) : '0.00';
                row.append($('<td>').text('$' + gstAmount));
                
                // 5. Unallocate button
                const unallocateBtn = $('<button>')
                    .addClass('btn btn-sm btn-warning allocated-action-btn')
                    .text('Unallocate')
                    .attr('data-invoice-pk', invoice.invoice_pk)
                    .on('click', function(e) {
                        e.stopPropagation();
                        unallocateInvoice($(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(unallocateBtn));
                
                // 6. Approve button
                const approveBtn = $('<button>')
                    .addClass('btn btn-sm btn-success allocated-action-btn')
                    .text('Approve')
                    .attr('data-invoice-pk', invoice.invoice_pk)
                    .on('click', function(e) {
                        e.stopPropagation();
                        approveInvoice($(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(approveBtn));
                
                // Row click handler for selection and PDF viewing
                row.on('click', function(e) {
                    if ($(e.target).closest('.allocated-action-btn').length) return;
                    selectAllocatedInvoiceRow($(this));
                });
                
                tbody.append(row);
            });
            
            // Calculate and show footer totals
            let totalNet = 0;
            let totalGst = 0;
            invoices.forEach(function(invoice) {
                totalNet += invoice.total_net || 0;
                totalGst += invoice.total_gst || 0;
            });
            $('#allocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
            $('#allocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
            $('#allocatedInvoicesTableFooter').show();
            
            // Auto-select the first row
            setTimeout(function() {
                const firstRow = $('#allocatedInvoicesTableBody tr').first();
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectAllocatedInvoiceRow(firstRow);
                }
            }, 100);
        }
        
        // Select an allocated invoice row
        function selectAllocatedInvoiceRow(row) {
            // Skip if already selected (don't refresh PDF or allocations)
            if (row.hasClass('selected-row')) {
                return;
            }
            
            const tbody = $('#allocatedInvoicesTableBody');
            
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            tbody.addClass('has-selection');
            
            const invoicePk = row.attr('data-invoice-pk');
            
            // Load allocations for this invoice (read-only)
            loadAllocatedInvoiceAllocations(invoicePk);
            
            // Load PDF
            const pdfUrl = row.attr('data-pdf-url');
            if (pdfUrl && pdfUrl !== 'null' && pdfUrl !== '') {
                $('#allocatedInvoicePdfViewer').attr('src', pdfUrl).show();
                $('#allocatedInvoiceViewerPlaceholder').hide();
            } else {
                $('#allocatedInvoicePdfViewer').hide();
                $('#allocatedInvoiceViewerPlaceholder').html(`
                    <i class="fas fa-file-pdf" style="font-size: 64px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>No PDF attached to this invoice</p>
                `).show();
            }
        }
        
        // Load allocations for an allocated invoice (read-only display)
        function loadAllocatedInvoiceAllocations(invoicePk) {
            $.ajax({
                url: `/core/get_unallocated_invoice_allocations/${invoicePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        const allocations = response.allocations;
                        const tbody = $('#allocatedInvoiceAllocationsTableBody');
                        tbody.empty();
                        
                        let totalNet = 0;
                        let totalGst = 0;
                        
                        allocations.forEach(function(alloc) {
                            const row = $('<tr>');
                            row.append($('<td>').text(alloc.item_name || '-'));
                            row.append($('<td>').text('$' + (alloc.amount || 0).toFixed(2)));
                            row.append($('<td>').text('$' + (alloc.gst_amount || 0).toFixed(2)));
                            row.append($('<td>').text(alloc.notes || '-'));
                            tbody.append(row);
                            
                            totalNet += alloc.amount || 0;
                            totalGst += alloc.gst_amount || 0;
                        });
                        
                        // Update totals
                        $('#allocatedTotalNet').text('$' + totalNet.toFixed(2));
                        $('#allocatedTotalGst').text('$' + totalGst.toFixed(2));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocations:', error);
                }
            });
        }
        
        // Unallocate invoice - set status back to 0
        function unallocateInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: `/core/unallocate_invoice/${invoicePk}/`,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Invoice unallocated:', invoicePk);
                        removeAllocatedInvoiceRow(row);
                    } else {
                        console.error('Error unallocating invoice:', response.message);
                        btn.prop('disabled', false).text(originalText);
                        alert('Failed to unallocate invoice: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to unallocate invoice:', error);
                    btn.prop('disabled', false).text(originalText);
                    alert('Failed to unallocate invoice. Please try again.');
                }
            });
        }
        
        // Approve invoice - set status to 2
        function approveInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: `/core/approve_invoice/${invoicePk}/`,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Invoice approved:', invoicePk);
                        removeAllocatedInvoiceRow(row);
                    } else {
                        console.error('Error approving invoice:', response.message);
                        btn.prop('disabled', false).text(originalText);
                        alert('Failed to approve invoice: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to approve invoice:', error);
                    btn.prop('disabled', false).text(originalText);
                    alert('Failed to approve invoice. Please try again.');
                }
            });
        }
        
        // Remove an allocated invoice row and update the view
        function removeAllocatedInvoiceRow(row) {
            row.fadeOut(300, function() {
                $(this).remove();
                
                // Clear allocations section
                $('#allocatedInvoiceAllocationsTableBody').empty();
                $('#allocatedTotalNet').text('$0.00');
                $('#allocatedTotalGst').text('$0.00');
                
                // Recalculate footer totals
                let totalNet = 0;
                let totalGst = 0;
                $('#allocatedInvoicesTableBody tr').each(function() {
                    const netText = $(this).find('td:eq(2)').text().replace('$', '');
                    const gstText = $(this).find('td:eq(3)').text().replace('$', '');
                    totalNet += parseFloat(netText) || 0;
                    totalGst += parseFloat(gstText) || 0;
                });
                $('#allocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
                $('#allocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
                
                // Select next available row or show placeholder
                const firstRow = $('#allocatedInvoicesTableBody tr').first();
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectAllocatedInvoiceRow(firstRow);
                } else {
                    $('#allocatedInvoicesTableBody').html(`
                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
                            No allocated invoices found for this project.
                        </td></tr>
                    `);
                    $('#allocatedInvoicesTableBody').removeClass('has-selection');
                    $('#allocatedInvoicePdfViewer').hide();
                    $('#allocatedInvoiceViewerPlaceholder').show();
                    $('#allocatedInvoicesTableFooter').hide();
                }
            });
        }
        
        // Update project button handler
        $(document).on('click', '.update-project-btn', function() {
            const row = $(this).closest('tr');
            const projectPk = row.data('project-pk');
            const currentName = row.find('.project-name').text();
            const currentSalesAccount = row.find('.sales-account').text();
            const originalName = row.data('original-project');
            const originalSalesAccount = row.data('original-sales-account');
            const originalManager = row.data('original-manager');
            const originalManagerEmail = row.data('original-manager-email');
            const originalContractsAdminEmails = row.data('original-contracts-admin-emails');
            
            // Check if already in edit mode
            if (row.hasClass('editing')) {
                // Save changes
                const newName = row.find('.edit-project-name').val().trim();
                const newSalesAccount = row.find('.edit-sales-account').val().trim();
                const newManager = row.find('.edit-manager').val().trim();
                const newManagerEmail = row.find('.edit-manager-email').val().trim();
                const newContractsAdminEmails = row.find('.edit-contracts-admin-emails').val().trim();
                const backgroundFile = row.find('.edit-background-image')[0].files[0];
                
                // Validate
                if (!newName) {
                    alert('Project name is required');
                    return;
                }
                
                // Check if anything changed
                if (newName === originalName && newSalesAccount === originalSalesAccount && 
                    newManager === originalManager && newManagerEmail === originalManagerEmail &&
                    newContractsAdminEmails === originalContractsAdminEmails && !backgroundFile) {
                    // No changes, just exit edit mode
                    row.removeClass('editing');
                    row.find('.project-name').html(originalName);
                    row.find('.sales-account').html(originalSalesAccount || '-');
                    row.find('.manager').html(originalManager || '-');
                    row.find('.manager-email').html(originalManagerEmail || '-');
                    row.find('.contracts-admin-emails').html(originalContractsAdminEmails || '-');
                    $(this).text('Update');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('project_name', newName);
                formData.append('xero_sales_account', newSalesAccount);
                formData.append('manager', newManager);
                formData.append('manager_email', newManagerEmail);
                formData.append('contracts_admin_emails', newContractsAdminEmails);
                if (backgroundFile) {
                    formData.append('background', backgroundFile);
                }
                
                // Show processing state
                $(this).prop('disabled', true).text('Saving...');
                
                // Make AJAX call to update project
                $.ajax({
                    url: `/core/update_project/${projectPk}/`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update row data
                            row.data('original-project', response.project.project);
                            row.data('original-sales-account', response.project.xero_sales_account || '');
                            row.data('original-manager', response.project.manager || '');
                            row.data('original-manager-email', response.project.manager_email || '');
                            row.data('original-contracts-admin-emails', response.project.contracts_admin_emails || '');
                            row.data('background-url', response.project.background_url || '');
                            
                            // Exit edit mode and reload to show updated data
                            row.removeClass('editing');
                            loadProjects();
                            
                            alert('Project updated successfully!');
                        } else {
                            alert('Error updating project: ' + response.message);
                            row.find('.update-project-btn').prop('disabled', false).text('Save');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error updating project:', error);
                        alert('Failed to update project. Please try again.');
                        row.find('.update-project-btn').prop('disabled', false).text('Save');
                    }
                });
            } else {
                // Enter edit mode
                row.addClass('editing');
                
                // Replace project name with input
                row.find('.project-name').html(`<input type="text" class="form-control form-control-sm edit-project-name" value="${currentName}">`);
                
                // Replace sales account with dropdown (populated dynamically)
                const xeroInstancePk = row.data('xero-instance-pk');
                const currentSalesAccountCode = row.data('original-sales-account');
                
                // Create dropdown with loading state
                row.find('.sales-account').html(`
                    <select class="form-control form-control-sm edit-sales-account" disabled>
                        <option value="">Loading accounts...</option>
                    </select>
                `);
                
                // Fetch and populate accounts if xero instance exists
                if (xeroInstancePk) {
                    $.ajax({
                        url: `/core/get_xero_accounts/${xeroInstancePk}/`,
                        type: 'GET',
                        success: function(response) {
                            const salesAccountSelect = row.find('.edit-sales-account');
                            salesAccountSelect.prop('disabled', false);
                            salesAccountSelect.empty();
                            salesAccountSelect.append('<option value="">Select Sales Account</option>');
                            
                            if (response.accounts && response.accounts.length > 0) {
                                // Filter for REVENUE, SALES, and OTHERINCOME accounts
                                const revenueAccounts = response.accounts.filter(acc => 
                                    acc.account_type === 'REVENUE' || 
                                    acc.account_type === 'SALES' || 
                                    acc.account_type === 'OTHERINCOME'
                                );
                                
                                revenueAccounts.forEach(account => {
                                    const isSelected = account.account_code === currentSalesAccountCode ? 'selected' : '';
                                    salesAccountSelect.append(
                                        `<option value="${account.account_code}" ${isSelected}>${account.account_code} - ${account.account_name}</option>`
                                    );
                                });
                            } else {
                                salesAccountSelect.append('<option value="">No sales accounts found</option>');
                            }
                        },
                        error: function() {
                            row.find('.edit-sales-account').html('<option value="">Error loading accounts</option>');
                        }
                    });
                } else {
                    row.find('.edit-sales-account').html('<option value="">No Xero Instance assigned</option>');
                }
                
                // Add inputs for manager fields
                row.find('.manager').html(`<input type="text" class="form-control form-control-sm edit-manager" value="${originalManager}">`);
                row.find('.manager-email').html(`<input type="email" class="form-control form-control-sm edit-manager-email" value="${originalManagerEmail}">`);
                row.find('.contracts-admin-emails').html(`<input type="text" class="form-control form-control-sm edit-contracts-admin-emails" value="${originalContractsAdminEmails}" placeholder="comma-separated">`);
                
                // Add file input for background image
                row.find('.background-image').html(`<input type="file" class="form-control form-control-sm edit-background-image" accept="image/*">`);  
                
                // Change button text
                $(this).text('Save');
                
                // Focus on project name
                row.find('.edit-project-name').focus();
            }
        });
        
        // Archive project button handler
        $(document).on('click', '.archive-project-btn', function() {
            const button = $(this);
            const row = button.closest('tr');
            const projectPk = row.data('project-pk');
            const projectName = row.find('.project-name').text();
            
            if (!confirm(`Are you sure you want to archive "${projectName}"?`)) {
                return;
            }
            
            // Show processing state
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Make AJAX call to archive project
            $.ajax({
                url: `/core/toggle_project_archive/${projectPk}/`,
                type: 'POST',
                data: { archived: '1' },
                success: function(response) {
                    if (response.status === 'success') {
                        // Reload projects list (will remove archived project from active view)
                        loadProjects(false);
                    } else {
                        alert(response.message || 'Error archiving project');
                        button.prop('disabled', false).html('<i class="fas fa-archive"></i>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error archiving project:', error);
                    alert('Error archiving project. Please try again.');
                    button.prop('disabled', false).html('<i class="fas fa-archive"></i>');
                }
            });
        });
        
        // Unarchive project button handler
        $(document).on('click', '.unarchive-project-btn', function() {
            const button = $(this);
            const row = button.closest('tr');
            const projectPk = row.data('project-pk');
            const projectName = row.find('.project-name').text();
            
            if (!confirm(`Are you sure you want to unarchive "${projectName}"?`)) {
                return;
            }
            
            // Show processing state
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Make AJAX call to unarchive project
            $.ajax({
                url: `/core/toggle_project_archive/${projectPk}/`,
                type: 'POST',
                data: { archived: '0' },
                success: function(response) {
                    if (response.status === 'success') {
                        // Reload projects list (will remove unarchived project from archived view)
                        loadProjects(true);
                    } else {
                        alert(response.message || 'Error unarchiving project');
                        button.prop('disabled', false).html('<i class="fas fa-box-open"></i>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error unarchiving project:', error);
                    alert('Error unarchiving project. Please try again.');
                    button.prop('disabled', false).html('<i class="fas fa-box-open"></i>');
                }
            });
        });
        
        // Handle Tender link click - show tender view
        $(document).on('click', '.project-status-link', function(e) {
            e.preventDefault();
            
            const row = $(this).closest('tr');
            const projectPk = row.data('project-pk');
            const projectName = row.find('.project-name').text();
            const backgroundUrl = row.data('background-url');
            const projectType = row.data('project-type');
            
            console.log(`Opening tender view for project: ${projectName} (pk=${projectPk})`);
            console.log(`Background URL: ${backgroundUrl}`);
            console.log(`Project Type: ${projectType}`);
            
            // Store current project info globally
            window.currentTenderProject = {
                pk: projectPk,
                name: projectName,
                backgroundUrl: backgroundUrl,
                project_type: projectType
            };
            
            // Apply background image to workspace if it exists
            if (backgroundUrl) {
                $('#dynamicContentArea').css({
                    'background-image': `url(${backgroundUrl})`,
                    'background-size': 'cover',
                    'background-position': 'center',
                    'background-repeat': 'no-repeat',
                    'background-attachment': 'fixed',
                    'position': 'relative'
                });
                
                // Add overlay to darken/fade the background
                if ($('#dynamicContentArea').find('.workspace-background-overlay').length === 0) {
                    $('#dynamicContentArea').prepend('<div class="workspace-background-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); pointer-events: none; z-index: 0;"></div>');
                }
            }
            
            // Hide projects table and footer buttons
            $('#projectsTable').closest('div').parent().hide();
            $('#projectsFooterButtons').hide();
            
            // Show tender view
            $('#tenderView').css('display', 'flex').show();
            $('#tenderProjectName').text(projectName);
        });
        
        // Handle Back to Projects button
        $('#backToProjectsBtn').click(function() {
            console.log('Returning to projects list');
            
            // Reset tender view state
            resetTenderViewState();
            
            // Remove background image from workspace
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            
            // Remove overlay
            $('.workspace-background-overlay').remove();
            
            // Hide tender view
            $('#tenderView').hide();
            
            // Show projects table and footer buttons
            $('#projectsTable').closest('div').parent().show();
            $('#projectsFooterButtons').show();
        });
        
        // Handle Back to Projects button from Construction view
        $('#backToProjectsFromConstructionBtn').click(function() {
            console.log('Returning to projects list from construction');
            
            // Reset construction view state
            resetConstructionViewState();
            
            // Remove background image from workspace
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            
            // Remove overlay
            $('.workspace-background-overlay').remove();
            
            // Hide construction view
            $('#constructionView').hide();
            
            // Show projects table and footer buttons
            $('#projectsTable').closest('div').parent().show();
            $('#projectsFooterButtons').show();
        });
        
        // Function to reset construction view state
        window.resetConstructionViewState = function() {
            // Reset all construction navigation buttons to default state
            $('.construction-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Reset invoices button group
            $('#invoicesButtonGroup').removeClass('active');
            $('.invoices-sub-btn').removeClass('active');
            $('.invoices-sub-btn[data-subsection="unallocated"]').addClass('active');
            
            // Hide all dynamic action buttons
            $('#constructionNewQuoteBtn').hide();
            
            // Clear construction content area
            $('#constructionContentArea').html(`
                <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
            `);
            
            // Clear current construction project
            window.currentConstructionProject = null;
        };
        
        // ==========================================
        // SHARED QUOTES FUNCTIONS (used by Tender, Construction, and future project types)
        // ==========================================
        
        // Generic function to load quotes section for any project view
        window.loadSharedQuotesSection = function(config) {
            // config should contain: projectObj, contentAreaId, tableId, pdfViewerId, newQuoteBtnId, pdfInputId, contactsVarName
            const { projectObj, contentAreaId, tableId, pdfViewerId, newQuoteBtnId, pdfInputId, contactsVarName } = config;
            
            // Show New Quote button
            $(`#${newQuoteBtnId}`).show();
            
            // Fetch contacts for this project's Xero instance
            if (projectObj && projectObj.pk) {
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectObj.pk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window[contactsVarName] = response.contacts;
                            console.log(`Loaded ${response.contacts.length} contacts for project from ${response.xero_instance_name}`);
                        } else {
                            console.error('Error loading contacts:', response.message);
                            window[contactsVarName] = [];
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load project contacts:', error);
                        window[contactsVarName] = [];
                    }
                });
            }
            
            // Show Committed Quotes view
            $(`#${contentAreaId}`).html(`
                <div style="display: flex; height: 100%; gap: 15px;">
                    <div style="width: 55%; height: 100%; display: flex; flex-direction: column;">
                        <div style="flex: 1; overflow-y: auto;">
                            <table id="${tableId}" class="reusable-table quotes-table" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Quote #</th>
                                        <th style="width: 35%;">Supplier</th>
                                        <th style="width: 20%;">Total Cost</th>
                                        <th style="width: 10%;">Update</th>
                                        <th style="width: 10%;">Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                            Loading quotes...
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot id="${tableId}-footer" style="display: none;">
                                    <tr style="background: var(--gradient-primary); color: white; font-weight: bold;">
                                        <td>TOTAL</td>
                                        <td></td>
                                        <td id="${tableId}-total">$0.00</td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div style="width: 45%; height: 100%;">
                        <iframe id="${pdfViewerId}" style="width: 100%; height: 100%; border: none;" src=""></iframe>
                    </div>
                </div>
            `);
            
            // Load quotes for this project
            loadSharedProjectQuotes(config);
            
            // Attach handler for New Quote button (using event delegation)
            $(document).off('click', `#${newQuoteBtnId}`).on('click', `#${newQuoteBtnId}`, function() {
                console.log('New Quote button clicked');
                $(`#${pdfInputId}`).click();
            });
            
            // Attach handler for file input change
            $(document).off('change', `#${pdfInputId}`).on('change', `#${pdfInputId}`, function(event) {
                var file = event.target.files[0];
                if (file) {
                    console.log('Quote PDF selected:', file.name);
                    
                    var pdfBlobUrl = URL.createObjectURL(file);
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var pdfData = e.target.result;
                        
                        // Display quote entry form using QuotesEntry module
                        QuotesEntry.init({
                            pdfUrl: pdfBlobUrl,
                            pdfDataUrl: pdfData,
                            containerSelector: `#${contentAreaId}`,
                            projectPk: projectObj.pk,
                            projectType: projectObj.project_type,
                            suppliers: window[contactsVarName],
                            items: window.itemsItems,
                            onSave: function(response) {
                                console.log('Quote saved:', response);
                                window.loadSharedQuotesSection(config);
                            },
                            onCancel: function() {
                                window.loadSharedQuotesSection(config);
                            }
                        });
                    };
                    reader.onerror = function(e) {
                        console.error('Error reading PDF file:', e);
                        alert('Error reading PDF file. Please try again.');
                    };
                    reader.readAsDataURL(file);
                    
                    $(this).val('');
                }
            });
        };
        
        // Generic function to load and display quotes for any project view
        window.loadSharedProjectQuotes = function(config) {
            const { projectObj, tableId, pdfViewerId, contentAreaId, contactsVarName } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected');
                return;
            }
            
            $.ajax({
                url: '/core/get_project_quotes/' + projectObj.pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        var quotes = response.quotes || [];
                        var tbody = $(`#${tableId} tbody`);
                        tbody.empty();
                        
                        if (quotes.length === 0) {
                            tbody.html(`
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                        No quotes found for this project.
                                    </td>
                                </tr>
                            `);
                        } else {
                            quotes.forEach(function(quote) {
                                var row = $('<tr></tr>');
                                
                                row.attr('data-pdf-url', quote.pdf_url);
                                row.attr('data-quote-number', quote.supplier_quote_number);
                                row.css('cursor', 'pointer');
                                
                                row.append('<td>' + quote.supplier_quote_number + '</td>');
                                row.append('<td>' + quote.supplier_name + '</td>');
                                
                                var formattedCost = parseFloat(quote.total_cost).toLocaleString('en-AU', {
                                    style: 'currency',
                                    currency: 'AUD'
                                });
                                row.append('<td>' + formattedCost + '</td>');
                                
                                // Update button
                                var updateBtn = $('<button></button>')
                                    .addClass('btn btn-sm btn-warning')
                                    .text('Update')
                                    .on('click', function(e) {
                                        e.stopPropagation();
                                        
                                        QuotesEntry.init({
                                            pdfUrl: quote.pdf_url,
                                            pdfDataUrl: null,
                                            containerSelector: `#${contentAreaId}`,
                                            projectPk: projectObj.pk,
                                            projectType: projectObj.project_type,
                                            suppliers: window[contactsVarName],
                                            items: window.itemsItems,
                                            isUpdate: true,
                                            quoteId: quote.quotes_pk,
                                            existingData: {
                                                supplier: quote.supplier_pk || quote.contact_pk,
                                                totalCost: quote.total_cost,
                                                quoteNumber: quote.supplier_quote_number,
                                                allocations: quote.allocations.map(function(alloc) {
                                                    return {
                                                        item: alloc.item_name,
                                                        costing_pk: alloc.costing_pk,
                                                        amount: alloc.amount,
                                                        qty: alloc.qty,
                                                        unit: alloc.unit,
                                                        rate: alloc.rate,
                                                        notes: alloc.notes || ''
                                                    };
                                                })
                                            },
                                            onSave: function(response) {
                                                console.log('Quote updated:', response);
                                                window.loadSharedQuotesSection(config);
                                            },
                                            onCancel: function() {
                                                window.loadSharedQuotesSection(config);
                                            }
                                        });
                                    });
                                row.append($('<td></td>').append(updateBtn));
                                
                                // Delete button
                                var deleteBtn = $('<button></button>')
                                    .addClass('btn btn-sm btn-danger')
                                    .text('Delete')
                                    .on('click', function(e) {
                                        e.stopPropagation();
                                        if (confirm('Are you sure you want to delete quote ' + quote.supplier_quote_number + '?')) {
                                            deleteSharedProjectQuote(quote.quotes_pk, config);
                                        }
                                    });
                                row.append($('<td></td>').append(deleteBtn));
                                
                                tbody.append(row);
                            });
                            
                            // Add click handler for quote rows to show PDF and selection styling
                            $(document).off('click', `#${tableId} tbody tr`).on('click', `#${tableId} tbody tr`, function(e) {
                                if ($(e.target).is('button') || $(e.target).closest('button').length > 0) {
                                    return;
                                }
                                
                                // Remove previous selection styling
                                $(`#${tableId} tbody tr`).removeClass('selected-row');
                                
                                // Add selection styling to clicked row
                                $(this).addClass('selected-row');
                                
                                // Add class to tbody to trigger dimming effect
                                $(`#${tableId} tbody`).addClass('has-selection');
                                
                                var pdfUrl = $(this).attr('data-pdf-url');
                                var quoteNumber = $(this).attr('data-quote-number');
                                
                                if (pdfUrl) {
                                    $(`#${pdfViewerId}`).attr('src', pdfUrl);
                                } else {
                                    alert('No PDF available for quote ' + quoteNumber);
                                }
                            });
                            
                            // Calculate and show total
                            var totalCost = quotes.reduce(function(sum, quote) {
                                return sum + parseFloat(quote.total_cost || 0);
                            }, 0);
                            
                            var formattedTotal = totalCost.toLocaleString('en-AU', {
                                style: 'currency',
                                currency: 'AUD'
                            });
                            
                            $(`#${tableId}-total`).text(formattedTotal);
                            $(`#${tableId}-footer`).show();
                            
                            // Auto-select first quote row (triggers click to load PDF and apply selection styling)
                            if (quotes.length > 0) {
                                setTimeout(function() {
                                    $(`#${tableId} tbody tr:first`).trigger('click');
                                }, 100);
                            }
                        }
                        
                        console.log('Loaded ' + quotes.length + ' quotes for project');
                    } else {
                        console.error('Error loading quotes:', response.message);
                        alert('Error loading quotes: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error loading quotes:', error);
                    alert('Error loading quotes. Please try again.');
                }
            });
        };
        
        // Generic function to delete a quote
        window.deleteSharedProjectQuote = function(quotePk, config) {
            $.ajax({
                url: '/core/delete_quote/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    quote_pk: quotePk
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Quote deleted successfully');
                        window.loadSharedProjectQuotes(config);
                    } else {
                        alert('Error deleting quote: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting quote:', error);
                    var errorMessage = 'Error deleting quote. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    alert(errorMessage);
                }
            });
        };
        
        // ==========================================
        // END SHARED QUOTES FUNCTIONS
        // ==========================================
        
        // ==========================================
        // SHARED DOCUMENTS FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedDocumentsSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for documents');
                return;
            }
            
            // Load the documents template from hidden storage
            var documentsHtml = $('#documentsTemplateStorage').html();
            $(`#${contentAreaId}`).html(documentsHtml);
            
            // Initialize DocumentsManager module with container context
            DocumentsManager.init({
                projectPk: projectObj.pk,
                containerSelector: `#${contentAreaId}`
            });
            
            console.log('Documents section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED CONTRACT BUDGET FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedContractBudgetSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for contract budget');
                return;
            }
            
            // Set global context variables BEFORE loading template
            // The template's inline script will read these
            window.currentContractBudgetProject = projectObj;
            window.currentContractBudgetContainer = `#${contentAreaId}`;
            
            // Load the contract budget template from hidden storage
            var contractBudgetHtml = $('#contractBudgetTemplateStorage').html();
            $(`#${contentAreaId}`).html(contractBudgetHtml);
            
            console.log('Contract Budget section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED PO FUNCTION (used by Construction and future project types)
        // ==========================================
        
        window.loadSharedPOSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for POs');
                return;
            }
            
            // Load the PO template from hidden storage
            var poHtml = $('#poTemplateStorage').html();
            $(`#${contentAreaId}`).html(poHtml);
            
            console.log('PO section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
            
            // Load suppliers from project quotes with contact details
            $.ajax({
                url: '/core/get_project_quotes/' + projectObj.pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        var quotes = response.quotes || [];
                        console.log('Loaded', quotes.length, 'quotes for PO suppliers');
                        
                        // Extract unique suppliers with contact info
                        var supplierMap = {};
                        quotes.forEach(function(quote) {
                            var contactPk = quote.supplier_pk || quote.contact_pk;
                            if (contactPk && !supplierMap[contactPk]) {
                                supplierMap[contactPk] = {
                                    contact_pk: contactPk,
                                    name: quote.supplier_name,
                                    first_name: quote.supplier_first_name || '',
                                    last_name: quote.supplier_last_name || '',
                                    email: quote.supplier_email || '',
                                    contact_person: quote.supplier_contact_person || '',
                                    quotes: []
                                };
                            }
                            if (supplierMap[contactPk]) {
                                supplierMap[contactPk].quotes.push(quote);
                            }
                        });
                        
                        var suppliers = Object.values(supplierMap);
                        console.log('Found', suppliers.length, 'unique suppliers');
                        
                        // Fetch PO status for all suppliers
                        $.ajax({
                            url: '/get_po_status/' + projectObj.pk + '/',
                            type: 'GET',
                            success: function(statusResponse) {
                                var poStatus = statusResponse.po_status || {};
                                populatePOTable(suppliers, poStatus, projectObj, contentAreaId);
                            },
                            error: function() {
                                // If status fetch fails, populate without status
                                populatePOTable(suppliers, {}, projectObj, contentAreaId);
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading quotes for PO suppliers:', error);
                }
            });
            
            // Helper function to populate PO table with status
            function populatePOTable(suppliers, poStatus, projectObj, contentAreaId) {
                var tbody = $(`#${contentAreaId} #poSuppliersTableBody`);
                tbody.empty();
                
                if (suppliers.length === 0) {
                    tbody.html('<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 20px;">No suppliers found in quotes</td></tr>');
                } else {
                    // Sort by name
                    suppliers.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    
                    // Track total amount
                    var grandTotal = 0;
                    
                    // Add table rows
                    suppliers.forEach(function(supplier) {
                        // Calculate total amount for this supplier from their quotes
                        var supplierTotal = supplier.quotes.reduce(function(sum, quote) {
                            return sum + parseFloat(quote.total_cost || 0);
                        }, 0);
                        grandTotal += supplierTotal;
                        
                        // Check if PO was sent for this supplier
                        var supplierStatus = poStatus[supplier.contact_pk] || {};
                        var isSent = supplierStatus.sent || false;
                        var pdfUrl = supplierStatus.pdf_url || null;
                        
                        var row = $('<tr></tr>')
                            .attr('data-supplier-pk', supplier.contact_pk)
                            .attr('data-supplier-name', supplier.name)
                            .attr('data-supplier-email', supplier.email)
                            .attr('data-po-sent', isSent ? 'true' : 'false')
                            .attr('data-pdf-url', pdfUrl || '');
                        
                        row.append('<td class="po-supplier-name">' + escapeHtml(supplier.name) + '</td>');
                        
                        // Display first name
                        var firstNameDisplay = supplier.first_name ? 
                            escapeHtml(supplier.first_name) : 
                            '<span style="color: #999; font-style: italic;">-</span>';
                        row.append('<td class="po-first-name">' + firstNameDisplay + '</td>');
                        
                        // Display last name
                        var lastNameDisplay = supplier.last_name ? 
                            escapeHtml(supplier.last_name) : 
                            '<span style="color: #999; font-style: italic;">-</span>';
                        row.append('<td class="po-last-name">' + lastNameDisplay + '</td>');
                        
                        // Display email address
                        var emailDisplay = supplier.email ? 
                            escapeHtml(supplier.email) : 
                            '<span style="color: #999; font-style: italic;">No email</span>';
                        row.append('<td class="po-email">' + emailDisplay + '</td>');
                        
                        // Display amount
                        var formattedAmount = supplierTotal.toLocaleString('en-AU', {
                            style: 'currency',
                            currency: 'AUD'
                        });
                        row.append('<td class="po-amount" style="text-align: right;">' + formattedAmount + '</td>');
                        
                        // Sent status column
                        var sentDisplay = isSent ? 
                            '<i class="fa fa-check" style="color: #28a745;"></i>' : 
                            '<span style="color: #999;">-</span>';
                        row.append('<td style="text-align: center;">' + sentDisplay + '</td>');
                        
                        // Update button
                        var updateBtn = $('<button class="btn btn-sm btn-warning po-update-btn">Update</button>');
                        var updateCell = $('<td></td>').append(updateBtn);
                        row.append(updateCell);
                        
                        // Email button
                        var emailBtn = $('<button class="btn btn-sm btn-primary po-email-btn" title="Send PO email"><i class="fa fa-envelope"></i></button>');
                        emailBtn.on('click', function(e) {
                            e.stopPropagation();
                            if (!supplier.email) {
                                alert('No email address available for this supplier');
                                return;
                            }
                            
                            if (!confirm(`Send purchase order to ${supplier.email}?`)) {
                                return;
                            }
                            
                            // Disable button and show spinner
                            emailBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                            
                            // Send PO email via backend
                            fetch(`/send_po_email/${projectObj.pk}/${supplier.contact_pk}/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                emailBtn.prop('disabled', false).html('<i class="fa fa-envelope"></i>');
                                if (data.status === 'success') {
                                    alert(data.message);
                                    // Update the sent status in the row
                                    row.attr('data-po-sent', 'true');
                                    row.attr('data-pdf-url', data.pdf_url || '');
                                    row.find('td:eq(5)').html('<i class="fa fa-check" style="color: #28a745;"></i>');
                                } else {
                                    alert(`Error: ${data.message}`);
                                }
                            })
                            .catch(error => {
                                emailBtn.prop('disabled', false).html('<i class="fa fa-envelope"></i>');
                                console.error('Error sending PO email:', error);
                                alert('Failed to send email. Please try again.');
                            });
                        });
                        
                        var emailCell = $('<td></td>').append(emailBtn);
                        row.append(emailCell);
                        
                        tbody.append(row);
                    });
                    
                    // Show footer with grand total
                    var formattedGrandTotal = grandTotal.toLocaleString('en-AU', {
                        style: 'currency',
                        currency: 'AUD'
                    });
                    $(`#${contentAreaId} #poTotalAmount`).text(formattedGrandTotal);
                    $(`#${contentAreaId} #poSuppliersTableFooter`).show();
                    
                    // Auto-select first row (triggers click to load PDF and apply selection styling)
                    setTimeout(function() {
                        $(`#${contentAreaId} #poSuppliersTableBody tr:first`).trigger('click');
                    }, 100);
                }
                
                console.log('Suppliers table populated');
            }
            
            // Attach click handler for supplier row selection
            $(`#${contentAreaId}`).off('click', '#poSuppliersTableBody tr').on('click', '#poSuppliersTableBody tr', function() {
                var row = $(this);
                var supplierPk = row.attr('data-supplier-pk');
                var supplierName = row.attr('data-supplier-name');
                var poSent = row.attr('data-po-sent') === 'true';
                var pdfUrl = row.attr('data-pdf-url');
                
                if (!supplierPk) return; // Skip if no supplier data
                
                // Remove previous selection styling
                $(`#${contentAreaId} #poSuppliersTableBody tr`).removeClass('selected-row');
                
                // Add selection styling to clicked row
                row.addClass('selected-row');
                
                // Add class to tbody to trigger dimming effect
                $(`#${contentAreaId} #poSuppliersTableBody`).addClass('has-selection');
                
                console.log('Supplier row clicked:', supplierName, '(PK:', supplierPk, '), Sent:', poSent);
                
                // If PO was sent and we have a PDF URL, display the stored PDF
                // Otherwise, generate a preview
                if (poSent && pdfUrl) {
                    console.log('Displaying stored PO PDF:', pdfUrl);
                    $(`#${contentAreaId} #poPlaceholder`).hide();
                    $(`#${contentAreaId} #poPreviewFrame`).attr('src', pdfUrl).show();
                    $(`#${contentAreaId} #poViewerFooter`).addClass('visible');
                    
                    // Store current supplier info for download
                    $(`#${contentAreaId} #downloadPOBtn`).data('supplierPk', supplierPk);
                    $(`#${contentAreaId} #downloadPOBtn`).data('supplierName', supplierName);
                } else {
                    // Generate PO preview for unsent POs
                    generatePODocument(projectObj, supplierPk, supplierName, contentAreaId);
                }
            });
            
            // PO Update button handler - convert row to editable inputs
            $(`#${contentAreaId}`).off('click', '.po-update-btn').on('click', '.po-update-btn', function(e) {
                e.stopPropagation(); // Don't trigger row click
                const button = $(this);
                const row = button.closest('tr');
                
                // Get current values
                const supplierCell = row.find('.po-supplier-name');
                const firstNameCell = row.find('.po-first-name');
                const lastNameCell = row.find('.po-last-name');
                const emailCell = row.find('.po-email');
                
                const supplier = supplierCell.text().trim();
                const firstName = firstNameCell.text().trim().replace(/-/g, '');
                const lastName = lastNameCell.text().trim().replace(/-/g, '');
                const email = emailCell.text().trim().replace('No email', '');
                
                // Replace cells with input fields
                supplierCell.html(`<input type="text" class="form-control form-control-sm po-supplier-input" value="${escapeHtml(supplier)}" style="width: 100%;">`);
                firstNameCell.html(`<input type="text" class="form-control form-control-sm po-first-name-input" value="${escapeHtml(firstName)}" style="width: 100%;">`);
                lastNameCell.html(`<input type="text" class="form-control form-control-sm po-last-name-input" value="${escapeHtml(lastName)}" style="width: 100%;">`);
                emailCell.html(`<input type="text" class="form-control form-control-sm po-email-input" value="${escapeHtml(email)}" style="width: 100%;">`);
                
                // Change button to Save/Cancel
                button.replaceWith(`
                    <button class="btn btn-sm btn-warning po-save-btn">Update</button>
                    <button class="btn btn-sm btn-secondary po-cancel-btn">Cancel</button>
                `);
            });
            
            // PO Cancel button handler - restore original values
            $(`#${contentAreaId}`).off('click', '.po-cancel-btn').on('click', '.po-cancel-btn', function(e) {
                e.stopPropagation();
                // Reload the section to restore original state
                window.loadSharedPOSection({
                    projectObj: projectObj,
                    contentAreaId: contentAreaId
                });
            });
            
            // PO Save button handler - update contact in Xero
            $(`#${contentAreaId}`).off('click', '.po-save-btn').on('click', '.po-save-btn', function(e) {
                e.stopPropagation();
                const button = $(this);
                const row = button.closest('tr');
                const contactPk = row.attr('data-supplier-pk');
                const xeroInstancePk = projectObj.xero_instance_pk;
                
                // Get new values
                const supplierName = row.find('.po-supplier-input').val().trim();
                const firstName = row.find('.po-first-name-input').val().trim();
                const lastName = row.find('.po-last-name-input').val().trim();
                const email = row.find('.po-email-input').val().trim();
                
                // Basic validation
                if (!supplierName && !firstName && !lastName) {
                    alert('Please provide at least a supplier name or contact name');
                    return;
                }
                
                // Show processing state
                const inputs = row.find('input');
                inputs.prop('disabled', true).css('background-color', '#e9ecef');
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                row.find('.po-cancel-btn').prop('disabled', true);
                
                // Make AJAX call to update contact
                fetch(`/update_contact_details/${xeroInstancePk}/${contactPk}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    body: JSON.stringify({
                        name: supplierName,
                        first_name: firstName,
                        last_name: lastName,
                        email: email
                    })
                })
                .then(response => response.json().then(data => ({status: response.status, body: data})))
                .then(({status, body}) => {
                    if (status === 401 && body.needs_auth) {
                        inputs.prop('disabled', false).css('background-color', '');
                        button.prop('disabled', false).html('Save');
                        row.find('.po-cancel-btn').prop('disabled', false);
                        
                        if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                            window.location.href = `/core/xero_oauth_authorize/${xeroInstancePk}/`;
                        }
                        return;
                    }
                    
                    if (body.status === 'success') {
                        alert('Contact updated successfully!');
                        // Reload the PO section to show updated data
                        window.loadSharedPOSection({
                            projectObj: projectObj,
                            contentAreaId: contentAreaId
                        });
                    } else {
                        alert(`Error: ${body.message}`);
                        inputs.prop('disabled', false).css('background-color', '');
                        button.prop('disabled', false).html('Save');
                        row.find('.po-cancel-btn').prop('disabled', false);
                    }
                })
                .catch(error => {
                    console.error('Error updating contact:', error);
                    alert('Failed to update contact. Please try again.');
                    inputs.prop('disabled', false).css('background-color', '');
                    button.prop('disabled', false).html('Save');
                    row.find('.po-cancel-btn').prop('disabled', false);
                });
            });
        };
        
        function generatePODocument(projectObj, supplierPk, supplierName, contentAreaId) {
            console.log('Loading PO preview for supplier:', supplierName);
            
            // Load the full PO preview in the iframe
            var previewUrl = `/preview_po/${projectObj.pk}/${supplierPk}/`;
            
            $(`#${contentAreaId} #poPlaceholder`).hide();
            $(`#${contentAreaId} #poPreviewFrame`).attr('src', previewUrl).show();
            $(`#${contentAreaId} #poViewerFooter`).addClass('visible');
            
            // Store current supplier info for download
            $(`#${contentAreaId} #downloadPOBtn`).data('supplierPk', supplierPk);
            $(`#${contentAreaId} #downloadPOBtn`).data('supplierName', supplierName);
        }
        
        // Handle PO Download button
        $(document).on('click', '#downloadPOBtn', function() {
            const button = $(this);
            const supplierPk = button.data('supplierPk');
            const supplierName = button.data('supplierName');
            const projectPk = window.currentConstructionProject?.pk;
            
            if (!supplierPk || !projectPk) {
                alert('Please select a supplier first');
                return;
            }
            
            console.log('Downloading PO for supplier:', supplierName);
            
            // Disable button and show loading
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generating...');
            
            // Create a form and submit it to trigger download
            const form = $('<form>', {
                method: 'POST',
                action: `/download_po_pdf/${projectPk}/${supplierPk}/`,
                target: '_blank'
            });
            
            // Add CSRF token
            form.append($('<input>', {
                type: 'hidden',
                name: 'csrfmiddlewaretoken',
                value: $('[name=csrfmiddlewaretoken]').val()
            }));
            
            // Append to body, submit, and remove
            form.appendTo('body').submit().remove();
            
            // Re-enable button after a short delay
            setTimeout(function() {
                button.prop('disabled', false).html('<i class="fa fa-download"></i> Download PDF');
            }, 2000);
        });
        
        function escapeHtml(text) {
            if (!text) return '';
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Handle Tender navigation button clicks
        $(document).on('click', '.tender-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Tender section clicked: ${section}`);
            
            // Remove active class from all buttons
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#newQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadQuotesSection();
            } else if (section === 'items') {
                // Load Items section from hidden storage
                var itemsContent = $('#itemsTemplateStorage').html();
                
                // Build the category order dropdown HTML (0 categories = option 1, 3 categories = options 1-4)
                var categoryOrderOptions = '<option value="">Select order...</option><option value="1">1</option>';
                
                // Build the item category dropdown HTML  
                var itemCategoryOptions = '<option value="">Select category...</option>';
                
                // Build the item order dropdown HTML
                var itemOrderOptions = '<option value="">Select category first...</option>';
                
                // Replace the empty selects with pre-populated ones
                itemsContent = itemsContent.replace('<select id="categoryOrderSelect"></select>', 
                    '<select id="categoryOrderSelect">' + categoryOrderOptions + '</select>');
                itemsContent = itemsContent.replace('<select id="itemCategorySelect"></select>', 
                    '<select id="itemCategorySelect">' + itemCategoryOptions + '</select>');
                itemsContent = itemsContent.replace('<select id="itemOrderSelect" disabled></select>', 
                    '<select id="itemOrderSelect" disabled>' + itemOrderOptions + '</select>');
                
                $('#tenderContentArea').html(itemsContent);
                console.log('Items section loaded with pre-populated dropdowns');
                
                // Initialize items functionality after DOM is ready
                setTimeout(function() {
                    initializeItemsSection();
                }, 0);
            } else if (section === 'documents') {
                // Load Documents section
                loadDocumentsSection();
            } else if (section === 'contract-budget') {
                // Load Contract Budget section
                loadContractBudgetSection();
            } else {
                // Placeholder for other sections
                $('#tenderContentArea').html(`
                    <h4>${section.charAt(0).toUpperCase() + section.slice(1).replace('-', ' ')}</h4>
                    <p style="color: #6c757d;">Content for ${section} will be implemented next.</p>
                `);
            }
        });
        
        // Tender Quote Functions - Uses shared functions (defined above)
        
        // Load the quotes section view for TENDER
        function loadQuotesSection() {
            window.loadSharedQuotesSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea',
                tableId: 'tenderCommittedQuotesTable',
                pdfViewerId: 'tenderQuotePdfViewer',
                newQuoteBtnId: 'newQuoteBtn',
                pdfInputId: 'tenderQuotePdfInput',
                contactsVarName: 'projectContacts'
            });
        }
        
        // Load the documents section view for TENDER
        function loadDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
        
        // Load the contract budget section view for TENDER
        function loadContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
        
        // Initialize Items Section Function
        function initializeItemsSection() {
            // Clear global variables for items management
            window.itemsCategories = [];
            window.itemsItems = [];
            
            // Clear the table immediately to prevent showing stale data
            var tbody = $('#tenderContentArea #itemsDisplayTableBody');
            if (tbody.length > 0) {
                tbody.html('<tr><td style="text-align: center; color: #6c757d; padding: 20px;">Loading...</td></tr>');
            }
            
            // Dropdown update functions
            // Update category order dropdown
            function updateCategoryOrderDropdown() {
                var select = document.querySelector('#tenderContentArea #categoryOrderSelect');
                if (!select) return;
                
                // Add 1 to number of categories: if 0 categories, show option 1; if 3 categories, show 1,2,3,4
                var maxOrder = window.itemsCategories.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Update item category dropdown
            function updateItemCategoryDropdown() {
                var select = document.querySelector('#tenderContentArea #itemCategorySelect');
                if (!select) return;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select category...</option>';
                window.itemsCategories.forEach(function(category) {
                    optionsHTML += '<option value="' + category.categories_pk + '">' + category.category + '</option>';
                });
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Load and populate unit dropdown
            function loadAndPopulateUnits() {
                $.ajax({
                    url: '/get_units/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            var select = document.querySelector('#tenderContentArea #itemUnitSelect');
                            if (!select) return;
                            
                            // Build options HTML string
                            var optionsHTML = '<option value="">Select unit...</option>';
                            response.units.forEach(function(unit) {
                                optionsHTML += '<option value="' + unit.unit_pk + '">' + unit.unit_name + '</option>';
                            });
                            
                            // Replace select's innerHTML
                            select.innerHTML = optionsHTML;
                        } else {
                            console.error('Error loading units:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading units:', error);
                    }
                });
            }
            
            // Update item order dropdown based on selected category
            function updateItemOrderDropdown(categoryPk) {
                var select = document.querySelector('#tenderContentArea #itemOrderSelect');
                if (!select) return;
                
                if (!categoryPk) {
                    select.innerHTML = '<option value="">Select category first...</option>';
                    select.disabled = true;
                    return;
                }
                
                // Count items in this category
                var itemsInCategory = window.itemsItems.filter(function(item) {
                    return item.category__category === getCategoryName(categoryPk);
                });
                
                // Add 1 to number of items: if 0 items, show option 1; if 3 items, show 1,2,3,4
                var maxOrder = itemsInCategory.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
                select.disabled = false;
            }
            
            // Get category name by PK
            function getCategoryName(categoryPk) {
                var category = window.itemsCategories.find(function(cat) {
                    return cat.categories_pk == categoryPk;
                });
                return category ? category.category : '';
            }
            
            // Load units for the unit dropdown
            loadAndPopulateUnits();
            
            // Load categories and items for current project
            if (window.currentTenderProject && window.currentTenderProject.pk) {
                loadProjectItems(window.currentTenderProject.pk);
            }
            
            // Load categories and items for a project
            function loadProjectItems(projectPk) {
                console.log('Loading items for project:', projectPk);
                
                // Load categories
                $.ajax({
                    url: '/get_project_categories/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsCategories = response.categories;
                            console.log('Loaded categories:', window.itemsCategories);
                            updateCategoryOrderDropdown();
                            updateItemCategoryDropdown();
                            loadItems(projectPk);
                        } else {
                            console.error('Error loading categories:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load categories:', error);
                    }
                });
            }
            
            // Load items
            function loadItems(projectPk) {
                $.ajax({
                    url: '/get_project_items/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsItems = response.items;
                            console.log('Loaded items:', window.itemsItems);
                            renderItemsTable();
                        } else {
                            console.error('Error loading items:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load items:', error);
                    }
                });
            }
            
            // Render items display table with drag-and-drop
            function renderItemsTable() {
                // Use scoped selector to ensure we target the correct table in tenderContentArea
                var tbody = $('#tenderContentArea #itemsDisplayTableBody');
                if (tbody.length === 0) {
                    console.error('Table body not found in DOM');
                    return;
                }
                
                tbody.empty();
                
                if (window.itemsItems.length === 0) {
                    tbody.append('<tr><td colspan="3" style="text-align: center; color: #6c757d; padding: 20px;">No items yet. Add a category and items to get started.</td></tr>');
                    return;
                }
                
                // Group items by category
                var groupedItems = {};
                window.itemsItems.forEach(function(item) {
                    var categoryName = item.category__category;
                    if (!groupedItems[categoryName]) {
                        groupedItems[categoryName] = [];
                    }
                    groupedItems[categoryName].push(item);
                });
                
                // Sort categories by order_in_list
                window.itemsCategories.sort(function(a, b) {
                    return a.order_in_list - b.order_in_list;
                });
                
                // Render each category and its items
                window.itemsCategories.forEach(function(category, catIndex) {
                    var items = groupedItems[category.category] || [];
                    
                    // Sort items by order_in_list
                    items.sort(function(a, b) {
                        return (a.order_in_list || 0) - (b.order_in_list || 0);
                    });
                    
                    // Render category header row (draggable unless Internal)
                    var isInternal = category.category === 'Internal';
                    var categoryRow = $('<tr></tr>')
                        .addClass('category-row')
                        .attr('data-category-pk', category.categories_pk)
                        .attr('data-category-order', category.order_in_list);
                    
                    if (isInternal) {
                        // Internal category: purple, not draggable, can't be deleted
                        categoryRow.addClass('internal-category');
                    } else {
                        // Regular category: draggable, can be deleted
                        categoryRow.attr('draggable', 'true')
                            .css({
                                'background-color': '#f0f0f0',
                                'font-weight': 'bold',
                                'cursor': 'move'
                            });
                    }
                    
                    // Add category name cell (no emoji, clean like Contract Budget)
                    categoryRow.append('<td>' + category.category + '</td>');
                    
                    // Add empty unit cell for category rows
                    categoryRow.append('<td></td>');
                    
                    // Add delete button cell
                    var deleteCell = $('<td style="text-align: center;"></td>');
                    if (isInternal) {
                        // Internal category cannot be deleted
                        deleteCell.append('<button class="delete-btn" disabled title="Internal category cannot be deleted">‚úï</button>');
                    } else {
                        // Regular category can be deleted
                        var deleteBtn = $('<button class="delete-btn delete-category-btn" title="Delete category and all items"></button>')
                            .attr('data-category-pk', category.categories_pk)
                            .attr('data-category-name', category.category)
                            .text('‚úï');
                        deleteCell.append(deleteBtn);
                    }
                    categoryRow.append(deleteCell);
                    
                    tbody.append(categoryRow);
                    
                    // Render items under this category (draggable within category)
                    items.forEach(function(item, itemIndex) {
                        var itemRow = $('<tr></tr>')
                            .addClass('item-row')
                            .attr('draggable', 'true')
                            .attr('data-item-pk', item.costing_pk)
                            .attr('data-category-pk', category.categories_pk)
                            .attr('data-item-order', item.order_in_list || (itemIndex + 1))
                            .css('cursor', 'move');
                        
                        // Apply purple styling if item is in Internal category
                        if (isInternal) {
                            itemRow.addClass('internal-item');
                        }
                        
                        // Add item name cell with indent class (no tree characters, clean like Contract Budget)
                        itemRow.append('<td class="indent">' + item.item + '</td>');
                        
                        // Add unit cell
                        var unitDisplay = item.unit || '-';
                        itemRow.append('<td>' + unitDisplay + '</td>');
                        
                        // Add delete button cell for items
                        var itemDeleteCell = $('<td style="text-align: center;"></td>');
                        var itemDeleteBtn = $('<button class="delete-btn delete-item-btn" title="Delete item"></button>')
                            .attr('data-item-pk', item.costing_pk)
                            .attr('data-item-name', item.item)
                            .text('‚úï');
                        itemDeleteCell.append(itemDeleteBtn);
                        itemRow.append(itemDeleteCell);
                        
                        tbody.append(itemRow);
                    });
                });
                
                // Attach drag-and-drop event handlers
                attachDragHandlers();
            }
            
            // Drag-and-drop event handlers
            var draggedElement = null;
            var draggedType = null; // 'category' or 'item'
            
            function attachDragHandlers() {
                // Category rows - can drag anywhere (except Internal)
                $('.category-row:not(.internal-category)').on('dragstart', function(e) {
                    draggedElement = this;
                    draggedType = 'category';
                    $(this).css('opacity', '0.4');
                    e.originalEvent.dataTransfer.effectAllowed = 'move';
                });
                
                $('.category-row').on('dragend', function(e) {
                    $(this).css('opacity', '1');
                    $('.drag-over').removeClass('drag-over');
                });
                
                $('.category-row').on('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.originalEvent.dataTransfer.dropEffect = 'move';
                    
                    if ($(this)[0] !== draggedElement) {
                        $(this).addClass('drag-over');
                    }
                    return false;
                });
                
                $('.category-row').on('dragleave', function(e) {
                    $(this).removeClass('drag-over');
                });
                
                $('.category-row').on('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    $(this).removeClass('drag-over');
                    
                    if (draggedElement !== this) {
                        if (draggedType === 'category') {
                            // Moving a category
                            var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                            var targetCategoryOrder = parseInt($(this).attr('data-category-order'));
                            
                            reorderCategory(draggedCategoryPk, targetCategoryOrder);
                        }
                    }
                    
                    return false;
                });
                
                // Item rows - can only drag within category
                $('.item-row').on('dragstart', function(e) {
                    draggedElement = this;
                    draggedType = 'item';
                    $(this).css('opacity', '0.4');
                    e.originalEvent.dataTransfer.effectAllowed = 'move';
                });
                
                $('.item-row').on('dragend', function(e) {
                    $(this).css('opacity', '1');
                    $('.drag-over').removeClass('drag-over');
                });
                
                $('.item-row').on('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    
                    // Only allow drop if same category
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryPk = $(this).attr('data-category-pk');
                    
                    if (draggedType === 'item' && draggedCategoryPk === targetCategoryPk) {
                        e.originalEvent.dataTransfer.dropEffect = 'move';
                        if ($(this)[0] !== draggedElement) {
                            $(this).addClass('drag-over');
                        }
                    } else {
                        e.originalEvent.dataTransfer.dropEffect = 'none';
                    }
                    
                    return false;
                });
                
                $('.item-row').on('dragleave', function(e) {
                    $(this).removeClass('drag-over');
                });
                
                $('.item-row').on('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    $(this).removeClass('drag-over');
                    
                    // Only allow drop if same category
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryPk = $(this).attr('data-category-pk');
                    
                    if (draggedElement !== this && draggedType === 'item' && draggedCategoryPk === targetCategoryPk) {
                        var draggedItemPk = $(draggedElement).attr('data-item-pk');
                        var targetItemOrder = parseInt($(this).attr('data-item-order'));
                        
                        reorderItem(draggedItemPk, targetItemOrder);
                    }
                    
                    return false;
                });
            }
            
            // Reorder category via AJAX
            function reorderCategory(categoryPk, newOrder) {
                $.ajax({
                    url: '/reorder_category/' + window.currentTenderProject.pk + '/' + categoryPk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        new_order: newOrder
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Reload all data to reflect new order
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to reorder category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            }
            
            // Reorder item via AJAX
            function reorderItem(itemPk, newOrder) {
                $.ajax({
                    url: '/reorder_item/' + window.currentTenderProject.pk + '/' + itemPk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        new_order: newOrder
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Reload all data to reflect new order
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to reorder item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            }
            
            // Validation for Add Category button
            function validateCategoryForm() {
                // Use scoped selectors to only target elements within tenderContentArea
                var categoryName = $('#tenderContentArea #categoryNameInput').val();
                if (categoryName) categoryName = categoryName.trim();
                var orderInList = $('#tenderContentArea #categoryOrderSelect').val();
                
                var isValid = categoryName && categoryName.length > 0 && orderInList !== '';
                
                var btn = $('#tenderContentArea #addCategoryBtn');
                
                if (isValid) {
                    btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
                } else {
                    btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
                }
            }
            
            // Validation for Add Item button
            function validateItemForm() {
                // Use scoped selectors to only target elements within tenderContentArea
                var itemName = $('#tenderContentArea #itemNameInput').val();
                if (itemName) itemName = itemName.trim();
                var itemUnit = $('#tenderContentArea #itemUnitSelect').val();
                var categoryPk = $('#tenderContentArea #itemCategorySelect').val();
                var orderInList = $('#tenderContentArea #itemOrderSelect').val();
                
                var isValid = itemName && itemName.length > 0 && itemUnit && itemUnit.length > 0 && categoryPk !== '' && orderInList !== '';
                
                var btn = $('#tenderContentArea #addItemBtn');
                if (isValid) {
                    btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
                } else {
                    btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
                }
            }
            
            // Event listeners for validation (scoped to tenderContentArea)
            // Remove old handlers first to prevent duplicates
            $('#tenderContentArea').off('input change', '#categoryNameInput, #categoryOrderSelect').on('input change', '#categoryNameInput, #categoryOrderSelect', function(e) {
                validateCategoryForm();
            });
            $('#tenderContentArea').off('input change', '#itemNameInput, #itemUnitSelect, #itemCategorySelect, #itemOrderSelect').on('input change', '#itemNameInput, #itemUnitSelect, #itemCategorySelect, #itemOrderSelect', function(e) {
                validateItemForm();
            });
            
            // Event listener for item category selection
            // Remove old handler first to prevent duplicates
            $('#tenderContentArea').off('change', '#itemCategorySelect').on('change', '#itemCategorySelect', function() {
                var categoryPk = $(this).val();
                updateItemOrderDropdown(categoryPk);
                validateItemForm();
            });
            
            // Trigger validation on page load to set initial button states
            setTimeout(function() {
                validateCategoryForm();
                validateItemForm();
            }, 100);
            
            // Add Category button click (scoped to tenderContentArea)
            // Remove old handler first to prevent duplicate submissions
            $('#tenderContentArea').off('click', '#addCategoryBtn').on('click', '#addCategoryBtn', function() {
                if ($(this).hasClass('disabled')) return;
                
                var categoryName = $('#tenderContentArea #categoryNameInput').val().trim();
                var orderInList = $('#tenderContentArea #categoryOrderSelect').val();
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                $.ajax({
                    url: '/create_category/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        category: categoryName,
                        order_in_list: parseInt(orderInList)
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Category created:', response.category);
                            
                            // Reload all categories since order may have changed
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear form
                            $('#tenderContentArea #categoryNameInput').val('');
                            $('#tenderContentArea #categoryOrderSelect').val('');
                            validateCategoryForm();
                            
                            alert('Category added successfully!');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to create category:', error);
                        var errorMessage = 'Failed to create category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to create category: ' + error;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Add Item button click (scoped to tenderContentArea)
            // Remove old handler first to prevent duplicate submissions
            $('#tenderContentArea').off('click', '#addItemBtn').on('click', '#addItemBtn', function() {
                if ($(this).hasClass('disabled')) return;
                
                var itemName = $('#tenderContentArea #itemNameInput').val().trim();
                var itemUnit = $('#tenderContentArea #itemUnitSelect').val();
                var categoryPk = $('#tenderContentArea #itemCategorySelect').val();
                var orderInList = $('#tenderContentArea #itemOrderSelect').val();
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                $.ajax({
                    url: '/create_item/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        item: itemName,
                        unit: itemUnit,
                        category_pk: parseInt(categoryPk),
                        order_in_list: parseInt(orderInList)
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Item created:', response.item);
                            
                            // Reload all items since order may have changed
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear form
                            $('#tenderContentArea #itemNameInput').val('');
                            $('#tenderContentArea #itemUnitSelect').val('');
                            $('#tenderContentArea #itemOrderSelect').val('');
                            
                            // Keep category selected for convenience
                            // (user might want to add more items to same category)
                            updateItemOrderDropdown(categoryPk);
                            validateItemForm();
                            
                            alert('Item added successfully!');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to create item:', error);
                        var errorMessage = 'Failed to create item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to create item: ' + error;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Download Example CSV button
            $('#tenderContentArea').off('click', '#downloadExampleCsvBtn').on('click', '#downloadExampleCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger download of example CSV
                window.location.href = '/download_items_csv_template/';
            });
            
            // Upload CSV button - triggers file picker
            $('#tenderContentArea').off('click', '#uploadCsvBtn').on('click', '#uploadCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger the hidden file input
                $('#tenderContentArea #csvFileInput').click();
            });
            
            // CSV File input change handler - immediately upload when file selected
            $('#tenderContentArea').off('change', '#csvFileInput').on('change', '#csvFileInput', function() {
                const fileInput = this;
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Validate file type
                if (!file.name.endsWith('.csv')) {
                    alert('Please select a valid CSV file');
                    fileInput.value = '';
                    return;
                }
                
                // Create FormData and upload
                const formData = new FormData();
                formData.append('csv_file', file);
                formData.append('project_pk', window.currentTenderProject.pk);
                
                // Show uploading state on upload button
                const uploadBtn = $('#uploadCsvBtn');
                const originalText = uploadBtn.html();
                uploadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                
                $.ajax({
                    url: '/upload_items_csv/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            let message = `Success! Created ${response.categories_created} categories and ${response.items_created} items.`;
                            
                            // Add warnings if any
                            if (response.warnings && response.warnings.length > 0) {
                                message += '\n\nWarnings:\n' + response.warnings.slice(0, 5).join('\n');
                                if (response.warnings.length > 5) {
                                    message += `\n... and ${response.warnings.length - 5} more warnings`;
                                }
                            }
                            
                            alert(message);
                            
                            // Reload items to show new data
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear file input
                            fileInput.value = '';
                        } else {
                            alert('Error: ' + response.message);
                        }
                        
                        uploadBtn.prop('disabled', false).html(originalText);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to upload CSV:', error);
                        let errorMessage = 'Failed to upload CSV';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to upload CSV: ' + error;
                        }
                        alert(errorMessage);
                        uploadBtn.prop('disabled', false).html(originalText);
                        fileInput.value = '';
                    }
                });
            });
            
            // Delete Category button handler
            $('#tenderContentArea').off('click', '.delete-category-btn').on('click', '.delete-category-btn', function(e) {
                e.stopPropagation(); // Prevent drag events
                
                var categoryPk = $(this).attr('data-category-pk');
                var categoryName = $(this).attr('data-category-name');
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Confirmation dialog
                var itemCount = window.itemsItems.filter(function(item) {
                    return item.category__category === categoryName;
                }).length;
                
                var message = `Are you sure you want to delete the category "${categoryName}"?`;
                if (itemCount > 0) {
                    message += `\n\nThis will also delete ${itemCount} item(s) in this category.`;
                }
                
                if (!confirm(message)) {
                    return;
                }
                
                // Make AJAX call to delete category
                $.ajax({
                    url: `/core/delete_category/${window.currentTenderProject.pk}/${categoryPk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            // Reload items to reflect deletion
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete category:', error);
                        var errorMessage = 'Failed to delete category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Delete Item button handler
            $('#tenderContentArea').off('click', '.delete-item-btn').on('click', '.delete-item-btn', function(e) {
                e.stopPropagation(); // Prevent drag events
                
                var itemPk = $(this).attr('data-item-pk');
                var itemName = $(this).attr('data-item-name');
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Confirmation dialog
                if (!confirm(`Are you sure you want to delete the item "${itemName}"?`)) {
                    return;
                }
                
                // Make AJAX call to delete item
                $.ajax({
                    url: `/core/delete_item/${window.currentTenderProject.pk}/${itemPk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            // Reload items to reflect deletion
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete item:', error);
                        var errorMessage = 'Failed to delete item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            });
        }
    });
</script>
