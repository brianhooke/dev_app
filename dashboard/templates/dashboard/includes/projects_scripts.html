<!-- Global zebra stripe styles for all allocation tables -->
<style>
    /* Zebra striping for ALL allocations tables - regardless of section */
    [id$="AllocationsTableBody"] tr:nth-child(even) {
        background-color: #f8f9fa !important;
    }
    [id$="AllocationsTableBody"] tr:nth-child(odd) {
        background-color: #ffffff !important;
    }
    [id$="AllocationsTableBody"] tr:hover {
        background-color: #eef2f7 !important;
    }
</style>

<script>
    $(document).ready(function() {
        // Function to reset tender view state (make it global so other scripts can call it)
        window.resetTenderViewState = function() {
            // Reset all tender navigation buttons to default state
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Hide all dynamic action buttons
            $('#newQuoteBtn').hide();
            
            // Clear tender content area
            $('#tenderContentArea').html(`
                <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
            `);
            
            // Clear current tender project
            window.currentTenderProject = null;
        };
        
        // Projects controller - shows inline in workspace
        $('#projectsLink').click(function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items and set this one
            $('.reusable-navbar a').removeClass('active');
            $(this).addClass('active');
            
            // Hide all sections using universal function
            if (typeof window.hideAllSections === 'function') {
                window.hideAllSections();
            }
            
            // Reset tender view state when returning to projects
            resetTenderViewState();
            
            // Reset construction view state when returning to projects
            if (typeof window.resetConstructionViewState === 'function') {
                resetConstructionViewState();
            }
            
            // Hide tender and construction views if showing
            $('#tenderView').hide();
            $('#constructionView').hide();
            
            // Show projects section and add has-content class to hide background
            $('#projectsSection').css('display', 'flex').show();
            $('#dynamicContentArea').addClass('has-content');
            
            // Show projects header and grid
            $('#projectsHeader').show();
            $('#projectsGridContainer').show();
            
            // Load projects data
            loadProjects();
            
            // Scroll to top
            $('html, body').animate({ scrollTop: 0 }, 300);
        });
        
        // Function to load and display projects
        function loadProjects(showArchived) {
            const archived = showArchived ? '1' : '0';
            
            $.ajax({
                url: '{% url "core:get_projects" %}',
                type: 'GET',
                data: { archived: archived },
                success: function(response) {
                    if (response.status === 'success') {
                        populateProjectsTable(response.projects, showArchived);
                    } else {
                        alert('Error loading projects: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading projects:', error);
                    alert('Failed to load projects. Please try again.');
                }
            });
        }
        
        // Function to populate projects table with data
        // Populate projects as card grid (replaces old table-based populateProjectsTable)
        function populateProjectsTable(projects, showingArchived) {
            const grid = $('#projectsGrid');
            
            console.log('üìä Populating projects grid with', projects.length, 'projects');
            
            // Clear existing cards
            grid.empty();
            
            if (projects.length === 0) {
                const message = showingArchived ? 'No archived projects found.' : 'No projects found. Click "Add Project" to create one.';
                grid.html(`<div class="projects-empty"><i class="fas fa-folder-open"></i><p>${message}</p></div>`);
                return;
            }
            
            // Determine archive button appearance based on view
            const archiveBtnClass = showingArchived ? 'btn-outline-success' : 'btn-outline-danger';
            const archiveBtnIcon = showingArchived ? 'fa-box-open' : 'fa-archive';
            const archiveBtnTitle = showingArchived ? 'Restore' : 'Archive';
            
            // Add project cards
            projects.forEach(project => {
                console.log(`üìÅ Project: ${project.project}`);
                
                const typeClass = project.project_type || 'general';
                const hasBackground = project.background_url ? 'has-bg' : '';
                const backgroundStyle = project.background_url ? `background-image: url('${project.background_url}');` : '';
                
                const card = $(`
                    <div class="project-card" data-project-pk="${project.projects_pk}">
                        <div class="card-header ${hasBackground}" style="${backgroundStyle}">
                            <h5 class="card-title">${project.project}</h5>
                        </div>
                        <div class="card-body">
                            <div class="card-info">
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-tag"></i></span>
                                    <span class="type-badge ${typeClass}">${project.project_type_display || 'General'}</span>
                                </div>
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-user"></i></span>
                                    <span class="card-label">Manager:</span>
                                    <span class="card-value">${project.manager || '-'}</span>
                                </div>
                                <div class="card-row">
                                    <span class="card-icon"><i class="fas fa-building"></i></span>
                                    <span class="card-label">Xero:</span>
                                    <span class="card-value">${project.xero_instance_name || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <a href="#" class="project-status-link" data-status="${project.project_status}">Tender</a>
                                <a href="#" class="construction-link">Execution</a>
                            </div>
                            <div class="card-actions">
                                <button class="btn ${archiveBtnClass} btn-sm archive-project-btn" title="${archiveBtnTitle}">
                                    <i class="fas ${archiveBtnIcon}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                // Store project data on the card for click handlers
                card.data('project-pk', project.projects_pk);
                card.data('original-project', project.project);
                card.data('original-sales-account', project.xero_sales_account || '');
                card.data('original-manager', project.manager || '');
                card.data('original-manager-email', project.manager_email || '');
                card.data('original-contracts-admin-emails', project.contracts_admin_emails || '');
                card.data('xero-instance-pk', project.xero_instance_pk);
                card.data('background-url', project.background_url || '');
                card.data('project-type', project.project_type);
                
                grid.append(card);
            });
        }
        
        // Toggle Archive button handler
        $('#toggleArchiveBtn').click(function() {
            const currentlyShowingArchived = $(this).data('showing-archived') === 1;
            const newShowingArchived = !currentlyShowingArchived;
            
            // Update button state
            $(this).data('showing-archived', newShowingArchived ? 1 : 0);
            
            if (newShowingArchived) {
                $(this).html('<i class="fas fa-list"></i> Show Active');
            } else {
                $(this).html('<i class="fas fa-archive"></i> Show Archived');
            }
            
            // Load projects with new filter
            loadProjects(newShowingArchived);
        });
        
        // ========== PROJECT MODAL FUNCTIONALITY ==========
        var currentModalProject = null;
        var isEditMode = false;
        var isCreateMode = false;
        var xeroInstancesCache = null;
        var xeroAccountsCache = {};
        
        // Add Project button - open modal in create mode
        $(document).on('click', '#addProjectBtn', function() {
            openProjectModal(null, true);
        });
        
        // Click on project card to open modal
        $(document).on('click', '.project-card', function(e) {
            // Don't open modal if clicking on a button or link
            if ($(e.target).closest('a, button').length) return;
            
            const card = $(this);
            const project = {
                projects_pk: card.data('project-pk'),
                project: card.find('.card-title').text(),
                project_type: card.data('project-type'),
                manager: card.data('original-manager'),
                manager_email: card.data('original-manager-email'),
                contracts_admin_emails: card.data('original-contracts-admin-emails'),
                xero_instance_pk: card.data('xero-instance-pk'),
                xero_sales_account: card.data('original-sales-account'),
                background_url: card.data('background-url')
            };
            openProjectModal(project, false);
        });
        
        // Open project modal
        function openProjectModal(project, createMode) {
            currentModalProject = project;
            isCreateMode = createMode;
            isEditMode = false;
            
            // Reset modal state
            clearValidationErrors();
            
            // Load Xero instances for dropdown
            loadXeroInstances().then(function() {
                if (createMode) {
                    // Create mode
                    $('#projectModalTitle').text('New Project');
                    $('#projectModalHeader').removeClass('has-bg').css('background-image', '');
                    
                    // Clear all fields
                    $('#modalProjectName').val('');
                    $('#modalProjectType').val('general');
                    $('#modalManager').val('');
                    $('#modalManagerEmail').val('');
                    $('#modalContractsAdminEmails').val('');
                    $('#modalXeroInstance').val('');
                    $('#modalSalesAccount').html('<option value="">Select Xero Instance first...</option>');
                    $('#modalBackgroundImage').val('');
                    
                    // Enable all inputs for create mode
                    enableFormInputs(true);
                    
                    // Show create button, hide others
                    $('#modalUpdateBtn').hide();
                    $('#modalSaveBtn').hide();
                    $('#modalCreateBtn').show();
                    $('.nav-buttons').hide();
                } else {
                    // View mode
                    $('#projectModalTitle').text(project.project);
                    
                    // Set header background
                    if (project.background_url) {
                        $('#projectModalHeader').addClass('has-bg')
                            .css('background-image', `url('${project.background_url}')`);
                    } else {
                        $('#projectModalHeader').removeClass('has-bg').css('background-image', '');
                    }
                    
                    // Populate fields
                    $('#modalProjectName').val(project.project);
                    $('#modalProjectType').val(project.project_type);
                    $('#modalManager').val(project.manager || '');
                    $('#modalManagerEmail').val(project.manager_email || '');
                    $('#modalContractsAdminEmails').val(project.contracts_admin_emails || '');
                    $('#modalXeroInstance').val(project.xero_instance_pk || '');
                    
                    // Load sales accounts for the selected Xero instance
                    if (project.xero_instance_pk) {
                        loadXeroAccounts(project.xero_instance_pk).then(function() {
                            $('#modalSalesAccount').val(project.xero_sales_account || '');
                        });
                    }
                    
                    // Disable all inputs (view mode)
                    enableFormInputs(false);
                    
                    // Show update button, hide save/create
                    $('#modalUpdateBtn').show();
                    $('#modalSaveBtn').hide();
                    $('#modalCreateBtn').hide();
                    $('.nav-buttons').show();
                }
                
                $('#projectModal').addClass('show');
            });
        }
        
        // Load Xero instances
        function loadXeroInstances() {
            if (xeroInstancesCache) {
                populateXeroInstances(xeroInstancesCache);
                return Promise.resolve();
            }
            
            return $.ajax({
                url: '/core/get_xero_instances/',
                type: 'GET'
            }).then(function(response) {
                // API returns array directly
                xeroInstancesCache = Array.isArray(response) ? response : [];
                populateXeroInstances(xeroInstancesCache);
            });
        }
        
        function populateXeroInstances(instances) {
            const select = $('#modalXeroInstance');
            select.html('<option value="">Select Xero Instance...</option>');
            instances.forEach(function(inst) {
                select.append(`<option value="${inst.xero_instance_pk}">${inst.xero_name}</option>`);
            });
        }
        
        // Load Xero accounts for an instance
        function loadXeroAccounts(instancePk) {
            if (xeroAccountsCache[instancePk]) {
                populateXeroAccounts(xeroAccountsCache[instancePk]);
                return Promise.resolve();
            }
            
            return $.ajax({
                url: `/core/get_xero_accounts/${instancePk}/`,
                type: 'GET'
            }).then(function(response) {
                const accounts = response.accounts || [];
                // Filter for revenue/sales accounts
                const filtered = accounts.filter(acc => 
                    acc.account_type === 'REVENUE' || 
                    acc.account_type === 'SALES' || 
                    acc.account_type === 'OTHERINCOME'
                );
                xeroAccountsCache[instancePk] = filtered;
                populateXeroAccounts(filtered);
            });
        }
        
        function populateXeroAccounts(accounts) {
            const select = $('#modalSalesAccount');
            select.html('<option value="">Select Sales Account...</option>');
            accounts.forEach(function(acc) {
                select.append(`<option value="${acc.account_code}">${acc.account_code} - ${acc.account_name}</option>`);
            });
        }
        
        // Xero instance change handler
        $('#modalXeroInstance').on('change', function() {
            const instancePk = $(this).val();
            if (instancePk) {
                loadXeroAccounts(instancePk);
            } else {
                $('#modalSalesAccount').html('<option value="">Select Xero Instance first...</option>');
            }
        });
        
        // Enable/disable form inputs
        function enableFormInputs(enable) {
            $('#modalProjectName').prop('disabled', !enable);
            $('#modalProjectType').prop('disabled', !enable);
            $('#modalManager').prop('disabled', !enable);
            $('#modalManagerEmail').prop('disabled', !enable);
            $('#modalContractsAdminEmails').prop('disabled', !enable);
            $('#modalXeroInstance').prop('disabled', !enable);
            $('#modalSalesAccount').prop('disabled', !enable);
            $('#modalBackgroundImage').prop('disabled', !enable);
        }
        
        // Validation
        function validateForm() {
            let isValid = true;
            clearValidationErrors();
            
            // Project name required
            if (!$('#modalProjectName').val().trim()) {
                $('#modalProjectName').addClass('is-invalid');
                isValid = false;
            }
            
            // Xero instance required
            if (!$('#modalXeroInstance').val()) {
                $('#modalXeroInstance').addClass('is-invalid');
                isValid = false;
            }
            
            // Sales account required
            if (!$('#modalSalesAccount').val()) {
                $('#modalSalesAccount').addClass('is-invalid');
                isValid = false;
            }
            
            return isValid;
        }
        
        function clearValidationErrors() {
            $('.form-control').removeClass('is-invalid');
        }
        
        // Update button - enable edit mode
        $('#modalUpdateBtn').on('click', function() {
            isEditMode = true;
            enableFormInputs(true);
            // Disable project type change for existing projects
            $('#modalProjectType').prop('disabled', true);
            
            $(this).hide();
            $('#modalSaveBtn').show();
        });
        
        // Save Changes button
        $('#modalSaveBtn').on('click', function() {
            if (!validateForm()) return;
            
            const formData = new FormData();
            formData.append('project_name', $('#modalProjectName').val().trim());
            formData.append('xero_instance_pk', $('#modalXeroInstance').val());
            formData.append('xero_sales_account', $('#modalSalesAccount').val());
            formData.append('manager', $('#modalManager').val().trim());
            formData.append('manager_email', $('#modalManagerEmail').val().trim());
            formData.append('contracts_admin_emails', $('#modalContractsAdminEmails').val().trim());
            
            const bgFile = $('#modalBackgroundImage')[0].files[0];
            if (bgFile) {
                formData.append('background', bgFile);
            }
            
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            
            $.ajax({
                url: `/core/update_project/${currentModalProject.projects_pk}/`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#projectModal').removeClass('show');
                        loadProjects($('#toggleArchiveBtn').data('showing-archived') === 1);
                    } else {
                        alert(response.message || 'Error saving project');
                    }
                    btn.prop('disabled', false).html('Save Changes');
                },
                error: function() {
                    alert('Error saving project');
                    btn.prop('disabled', false).html('Save Changes');
                }
            });
        });
        
        // Create Project button
        $('#modalCreateBtn').on('click', function() {
            if (!validateForm()) return;
            
            const formData = new FormData();
            formData.append('project_name', $('#modalProjectName').val().trim());
            formData.append('project_type', $('#modalProjectType').val());
            formData.append('xero_instance_pk', $('#modalXeroInstance').val());
            formData.append('xero_sales_account', $('#modalSalesAccount').val());
            formData.append('manager', $('#modalManager').val().trim());
            formData.append('manager_email', $('#modalManagerEmail').val().trim());
            formData.append('contracts_admin_emails', $('#modalContractsAdminEmails').val().trim());
            
            const bgFile = $('#modalBackgroundImage')[0].files[0];
            if (bgFile) {
                formData.append('background', bgFile);
            }
            
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');
            
            $.ajax({
                url: '/core/create_project/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#projectModal').removeClass('show');
                        loadProjects(false);
                    } else {
                        alert(response.message || 'Error creating project');
                    }
                    btn.prop('disabled', false).html('Create Project');
                },
                error: function() {
                    alert('Error creating project');
                    btn.prop('disabled', false).html('Create Project');
                }
            });
        });
        
        // Modal Tender button
        $('#modalTenderBtn').on('click', function(e) {
            e.preventDefault();
            if (!currentModalProject) return;
            
            // Close modal and trigger tender view
            $('#projectModal').removeClass('show');
            
            // Find the card and trigger tender link click
            const card = $(`.project-card[data-project-pk="${currentModalProject.projects_pk}"]`);
            card.find('.project-status-link').click();
        });
        
        // Modal Execution button
        $('#modalExecutionBtn').on('click', function(e) {
            e.preventDefault();
            if (!currentModalProject) return;
            
            // Close modal and trigger execution view
            $('#projectModal').removeClass('show');
            
            // Find the card and trigger construction link click
            const card = $(`.project-card[data-project-pk="${currentModalProject.projects_pk}"]`);
            card.find('.construction-link').click();
        });
        
        // Close modal handlers
        $('#projectModalClose, #modalCancelBtn').on('click', function() {
            $('#projectModal').removeClass('show');
            currentModalProject = null;
            isEditMode = false;
            isCreateMode = false;
        });
        
        // Click outside modal to close
        $('#projectModal').on('click', function(e) {
            if ($(e.target).hasClass('project-modal')) {
                $(this).removeClass('show');
                currentModalProject = null;
                isEditMode = false;
                isCreateMode = false;
            }
        });
        // ========== END PROJECT MODAL FUNCTIONALITY ==========
        
        // Handle Xero Instance selection to populate Sales Account dropdown
        $(document).on('change', '.add-xero-instance', function() {
            const xeroInstancePk = $(this).val();
            const salesAccountSelect = $(this).closest('tr').find('.add-sales-account');
            
            if (!xeroInstancePk) {
                salesAccountSelect.prop('disabled', true).html('<option value="">Select Xero Instance first</option>');
                return;
            }
            
            // Fetch accounts for this Xero instance
            $.ajax({
                url: `/core/get_xero_accounts/${xeroInstancePk}/`,
                type: 'GET',
                success: function(response) {
                    salesAccountSelect.prop('disabled', false);
                    salesAccountSelect.empty();
                    salesAccountSelect.append('<option value="">Select Sales Account</option>');
                    
                    if (response.accounts && response.accounts.length > 0) {
                        // Filter for REVENUE, SALES, and OTHERINCOME accounts
                        const revenueAccounts = response.accounts.filter(acc => 
                            acc.account_type === 'REVENUE' || 
                            acc.account_type === 'SALES' || 
                            acc.account_type === 'OTHERINCOME'
                        );
                        
                        revenueAccounts.forEach(account => {
                            salesAccountSelect.append(
                                `<option value="${account.account_code}">${account.account_code} - ${account.account_name}</option>`
                            );
                        });
                    } else {
                        salesAccountSelect.append('<option value="">No accounts found</option>');
                    }
                },
                error: function() {
                    alert('Failed to load Xero accounts');
                    salesAccountSelect.prop('disabled', true).html('<option value="">Error loading accounts</option>');
                }
            });
        });
        
        // Save new project handler
        $(document).on('click', '.save-new-project-btn', function() {
            const row = $(this).closest('tr');
            const projectName = row.find('.add-project-name').val().trim();
            const projectType = row.find('.add-project-type').val();
            const xeroInstancePk = row.find('.add-xero-instance').val();
            const salesAccount = row.find('.add-sales-account').val();
            const manager = row.find('.add-manager').val().trim();
            const managerEmail = row.find('.add-manager-email').val().trim();
            const contractsAdminEmails = row.find('.add-contracts-admin-emails').val().trim();
            const backgroundFile = row.find('.add-background-image')[0].files[0];
            
            // Validate required fields
            if (!projectName) {
                alert('Project name is required');
                row.find('.add-project-name').focus();
                return;
            }
            
            if (!xeroInstancePk) {
                alert('Xero Instance is required');
                row.find('.add-xero-instance').focus();
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('project_name', projectName);
            formData.append('project_type', projectType);
            formData.append('xero_instance_pk', xeroInstancePk);
            if (salesAccount) {
                formData.append('xero_sales_account', salesAccount);
            }
            if (manager) {
                formData.append('manager', manager);
            }
            if (managerEmail) {
                formData.append('manager_email', managerEmail);
            }
            if (contractsAdminEmails) {
                formData.append('contracts_admin_emails', contractsAdminEmails);
            }
            if (backgroundFile) {
                formData.append('background', backgroundFile);
            }
            // Note: project_status will default to 0 (Tender) in the backend
            
            // Show processing state
            $(this).prop('disabled', true).text('Saving...');
            
            // Make AJAX call to create project
            $.ajax({
                url: '{% url "core:create_project" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        // Remove add row
                        row.remove();
                        
                        // Reload projects list to show new project
                        loadProjects();
                        
                        alert('Project created successfully!');
                    } else {
                        alert('Error creating project: ' + response.message);
                        row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating project:', error);
                    alert('Failed to create project. Please try again.');
                    row.find('.save-new-project-btn').prop('disabled', false).text('Save');
                }
            });
        });
        
        // Cancel add project handler
        $(document).on('click', '.cancel-add-project-btn', function() {
            const row = $(this).closest('tr');
            row.remove();
            
            // If no rows left, show empty state
            const tbody = $('#projectsTableBody');
            if (tbody.find('tr').length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #6c757d;">
                            No projects found. Click "Add Project" to create one.
                        </td>
                    </tr>
                `);
            }
        });
        
        // Handle Construction link click - show construction view (Execution mode)
        $(document).on('click', '.construction-link', function(e) {
            e.preventDefault();
            
            // Support both card grid and legacy table row
            const card = $(this).closest('.project-card');
            const row = card.length ? card : $(this).closest('tr');
            
            const projectPk = row.data('project-pk');
            const projectName = card.length ? card.find('.card-title').text() : row.find('.project-name').text();
            const backgroundUrl = row.data('background-url');
            const xeroInstancePk = row.data('xero-instance-pk');
            const projectType = row.data('project-type');
            
            console.log(`Opening construction view for project: ${projectName} (pk=${projectPk})`);
            console.log(`Background URL: ${backgroundUrl}`);
            console.log(`Xero Instance PK: ${xeroInstancePk}`);
            console.log(`Project Type: ${projectType}`);
            
            // Store current project info globally
            window.currentConstructionProject = {
                pk: projectPk,
                name: projectName,
                backgroundUrl: backgroundUrl,
                xero_instance_pk: xeroInstancePk,
                project_type: projectType
            };
            
            // Apply background image to workspace if it exists
            if (backgroundUrl) {
                $('#dynamicContentArea').css({
                    'background-image': `url(${backgroundUrl})`,
                    'background-size': 'cover',
                    'background-position': 'center center',
                    'background-repeat': 'no-repeat',
                    'position': 'relative'
                });
                
                // Add overlay to darken/fade the background
                if ($('#dynamicContentArea').find('.workspace-background-overlay').length === 0) {
                    $('#dynamicContentArea').prepend('<div class="workspace-background-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.85); pointer-events: none; z-index: 0;"></div>');
                }
            }
            
            // Hide projects header and grid
            $('#projectsHeader').hide();
            $('#projectsGridContainer').hide();
            
            // Show construction view
            $('#constructionView').css('display', 'flex').show();
            $('#constructionProjectName').text(projectName);
        });
        
        // Handle Construction navigation button clicks
        $(document).on('click', '.construction-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Construction section clicked: ${section}`);
            
            // Remove active class from all buttons (except invoices main btn which is handled separately)
            $('.construction-nav-btn:not(.invoices-main-btn)').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Deactivate invoices button group if clicking another section
            if (section !== 'invoices') {
                $('#invoicesButtonGroup').removeClass('active');
                $('.invoices-main-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            }
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#constructionNewQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadConstructionQuotesSection();
            } else if (section === 'pos') {
                loadConstructionPOSection();
            } else if (section === 'contract-budget') {
                loadConstructionContractBudgetSection();
            } else if (section === 'hc-variations') {
                loadConstructionHCVariationsSection();
            } else if (section === 'hc-claims') {
                loadConstructionHCClaimsSection();
            } else if (section === 'invoices') {
                // Activate the invoices button group and show sub-buttons
                $('#invoicesButtonGroup').addClass('active');
                $('.invoices-main-btn').removeClass('btn-outline-primary').addClass('btn-primary');
                // Default to unallocated if no sub-button is active
                const activeSubBtn = $('.invoices-sub-btn.active');
                const subsection = activeSubBtn.length ? activeSubBtn.data('subsection') : 'unallocated';
                loadConstructionInvoicesSection(subsection);
            } else if (section === 'documents') {
                loadConstructionDocumentsSection();
            }
        });
        
        // Handle Invoices sub-menu button clicks
        $(document).on('click', '.invoices-sub-btn', function() {
            const subsection = $(this).data('subsection');
            console.log(`Invoices subsection clicked: ${subsection}`);
            
            // Update active state on sub-buttons
            $('.invoices-sub-btn').removeClass('active');
            $(this).addClass('active');
            
            // Load the appropriate invoices view
            loadConstructionInvoicesSection(subsection);
        });
        
        // ==========================================
        // QUOTES SECTION - Uses AllocationsManager
        // ==========================================
        
        // Initialize quotes AllocationsManager configuration
        // Made global so quotes_section.js can detect it and skip auto-init
        window.initQuotesAllocationsManager = function initQuotesAllocationsManager() {
            if (window.quotesManagerInitialized) return;
            
            AllocationsManager.init({
                sectionId: 'quote',
                mainTable: {
                    emptyMessage: 'No quotes found for this project.',
                    showFooter: true,
                    footerTotals: [{ colIndex: 2, valueKey: 'total_cost' }],
                    // Custom row renderer for quotes
                    renderRow: function(quote, index, cfg) {
                        var pdfUrl = quote.pdf_url || '';
                        var row = $('<tr>').attr('data-pk', quote.quotes_pk).attr('data-quote-pk', quote.quotes_pk).attr('data-pdf-url', pdfUrl);
                        
                        // 1. Supplier
                        row.append($('<td>').text(quote.supplier_name || '-'));
                        
                        // 2. $ Net
                        var netAmount = quote.total_cost ? parseFloat(quote.total_cost) : 0;
                        row.append($('<td>').text('$' + netAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                        
                        // 3. Quote #
                        row.append($('<td>').text(quote.supplier_quote_number || '-'));
                        
                        // 4. Update button
                        var updateBtn = $('<button>')
                            .addClass('btn btn-sm btn-warning quote-update-btn')
                            .text('Update')
                            .attr('data-quote-pk', quote.quotes_pk)
                            .on('click', function(e) {
                                e.stopPropagation();
                                openQuoteUpdateModal(quote);
                            });
                        row.append($('<td>').css('text-align', 'center').append(updateBtn));
                        
                        // 5. Delete button
                        var deleteBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger quote-delete-btn')
                            .html('<i class="fas fa-trash"></i>')
                            .attr('data-quote-pk', quote.quotes_pk)
                            .on('click', function(e) {
                                e.stopPropagation();
                                deleteQuote(quote.quotes_pk, $(this).closest('tr'));
                            });
                        row.append($('<td>').css('text-align', 'center').append(deleteBtn));
                        
                        return row;
                    },
                    // Custom row selection handler
                    onRowSelect: function(row, pk, cfg) {
                        // Hide Add Row button in view mode
                        $('#quoteAddAllocationBtn').hide();
                    }
                },
                allocations: {
                    emptyMessage: 'No allocations for this quote',
                    editable: false,
                    // Custom read-only allocation row renderer - construction aware
                    renderRow: function(alloc, cfg) {
                        var row = $('<tr>').attr('data-allocation-pk', alloc.quote_allocations_pk);
                        var isConstruction = isQuotesConstructionProject();
                        
                        if (isConstruction) {
                            // Construction: Item | Unit | Qty | $ Rate | $ Amount | Notes
                            row.append($('<td>').text(alloc.item_name || '-'));
                            row.append($('<td>').text(alloc.unit || '-'));
                            var qty = alloc.qty ? parseFloat(alloc.qty) : 0;
                            row.append($('<td>').text(qty.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                            var rate = alloc.rate ? parseFloat(alloc.rate) : 0;
                            row.append($('<td>').text('$' + rate.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                            var amount = alloc.amount ? parseFloat(alloc.amount) : 0;
                            row.append($('<td>').text('$' + amount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                            row.append($('<td>').text(alloc.notes || '-'));
                            row.append($('<td>')); // Empty for delete column
                        } else {
                            // Non-construction: Item | $ Net | Notes
                            row.append($('<td>').text(alloc.item_name || '-'));
                            var amount = alloc.amount ? parseFloat(alloc.amount) : 0;
                            row.append($('<td>').text('$' + amount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                            row.append($('<td>').text(alloc.notes || '-'));
                            row.append($('<td>')); // Empty cell for delete column
                        }
                        return row;
                    },
                    // Custom editable allocation row renderer (for new/update mode) - construction aware
                    renderEditableRow: function(allocation, cfg, onChange) {
                        var row = $('<tr>');
                        var isConstruction = isQuotesConstructionProject();
                        if (allocation) row.attr('data-allocation-pk', allocation.quote_allocations_pk);
                        
                        // Item dropdown with category optgroups (both modes)
                        var itemSelect = $('<select>').addClass('form-control form-control-sm quote-allocation-item-select');
                        itemSelect.append($('<option>').val('').text('Select Item...'));
                        
                        // Populate with costing items, grouped by category
                        var costingItems = window.quotesCostingItems || window.itemsItems || [];
                        var currentCategory = null;
                        costingItems.forEach(function(item) {
                            // Add category optgroup if category changed
                            if (item.category__category !== currentCategory) {
                                currentCategory = item.category__category;
                                itemSelect.append($('<optgroup>').attr('label', currentCategory || 'Uncategorized'));
                            }
                            var option = $('<option>').val(item.costing_pk).text(item.item);
                            option.attr('data-unit', item.unit__unit_name || item.unit || ''); // Store unit for construction mode
                            if (allocation && allocation.item_pk === item.costing_pk) option.prop('selected', true);
                            itemSelect.find('optgroup').last().append(option);
                        });
                        
                        if (isConstruction) {
                            // Construction mode: Item | Unit | Qty | $ Rate | $ Amount | Notes | Del
                            itemSelect.on('change', function() {
                                var selectedOption = $(this).find('option:selected');
                                var unit = selectedOption.attr('data-unit') || '';
                                row.find('.quote-allocation-unit-display').text(unit);
                                row.find('.quote-allocation-unit-input').val(unit);
                                onChange();
                            });
                            row.append($('<td>').append(itemSelect));
                            
                            // Unit (read-only, auto-populated from item)
                            var selectedUnit = allocation ? (allocation.unit || '') : '';
                            var unitDisplay = $('<span>').addClass('quote-allocation-unit-display').text(selectedUnit);
                            var unitInput = $('<input>').attr('type', 'hidden').addClass('quote-allocation-unit-input').val(selectedUnit);
                            row.append($('<td>').append(unitDisplay).append(unitInput));
                            
                            // Qty input
                            var qtyInput = $('<input>')
                                .attr('type', 'number').attr('step', '0.01')
                                .addClass('form-control form-control-sm quote-allocation-qty-input')
                                .val(allocation && allocation.qty ? parseFloat(allocation.qty).toFixed(2) : '')
                                .on('change input', function() {
                                    var qty = parseFloat($(this).val()) || 0;
                                    var rate = parseFloat(row.find('.quote-allocation-rate-input').val()) || 0;
                                    var amount = (qty * rate).toFixed(2);
                                    row.find('.quote-allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                                    row.find('.quote-allocation-net-input').val(amount);
                                    onChange();
                                });
                            row.append($('<td>').append(qtyInput));
                            
                            // Rate input
                            var rateInput = $('<input>')
                                .attr('type', 'number').attr('step', '0.01')
                                .addClass('form-control form-control-sm quote-allocation-rate-input')
                                .val(allocation && allocation.rate ? parseFloat(allocation.rate).toFixed(2) : '')
                                .on('change input', function() {
                                    var qty = parseFloat(row.find('.quote-allocation-qty-input').val()) || 0;
                                    var rate = parseFloat($(this).val()) || 0;
                                    var amount = (qty * rate).toFixed(2);
                                    row.find('.quote-allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                                    row.find('.quote-allocation-net-input').val(amount);
                                    onChange();
                                });
                            row.append($('<td>').append(rateInput));
                            
                            // Amount (calculated, read-only display)
                            var calcAmount = allocation && allocation.amount ? parseFloat(allocation.amount) : 0;
                            var amountDisplay = $('<span>').addClass('quote-allocation-amount-display')
                                .text('$' + calcAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                            var amountHidden = $('<input>').attr('type', 'hidden')
                                .addClass('quote-allocation-net-input').val(calcAmount.toFixed(2));
                            row.append($('<td>').append(amountDisplay).append(amountHidden));
                            
                            // Notes input
                            var notesInput = $('<input>')
                                .attr('type', 'text')
                                .addClass('form-control form-control-sm quote-allocation-notes-input')
                                .val(allocation ? allocation.notes || '' : '');
                            row.append($('<td>').append(notesInput));
                        } else {
                            // Non-construction mode: Item | $ Net | Notes | Del
                            itemSelect.on('change', onChange);
                            row.append($('<td>').append(itemSelect));
                            
                            // Amount input
                            var amountInput = $('<input>')
                                .attr('type', 'number').attr('step', '0.01')
                                .addClass('form-control form-control-sm quote-allocation-net-input')
                                .val(allocation ? parseFloat(allocation.amount).toFixed(2) : '')
                                .on('change input', onChange);
                            row.append($('<td>').append(amountInput));
                            
                            // Notes input
                            var notesInput = $('<input>')
                                .attr('type', 'text')
                                .addClass('form-control form-control-sm quote-allocation-notes-input')
                                .val(allocation ? allocation.notes || '' : '');
                            row.append($('<td>').append(notesInput));
                        }
                        
                        // Delete button (both modes)
                        var deleteBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger')
                            .html('<i class="fas fa-times"></i>')
                            .on('click', function() {
                                row.remove();
                                onChange();
                            });
                        row.append($('<td>').css('text-align', 'center').append(deleteBtn));
                        
                        return row;
                    },
                    // Callback when allocations change
                    onUpdate: function(sectionId, totals) {
                        // Validate new quote if in new mode
                        if (window.newQuoteMode) {
                            validateNewQuote();
                        }
                    }
                },
                api: {
                    loadAllocations: '/core/get_allocations_for_quote/{pk}/'
                }
            });
            
            window.quotesManagerInitialized = true;
            console.log('Quotes AllocationsManager initialized');
        }
        
        // Load the quotes section view for CONSTRUCTION
        function loadConstructionQuotesSection() {
            console.log('Loading quotes section with reusable template');
            
            // Initialize AllocationsManager for quotes
            initQuotesAllocationsManager();
            
            // Show New Quote button
            $('#constructionNewQuoteBtn').show();
            
            // Set shared project reference for quotes
            window.currentQuotesProject = {
                pk: window.currentConstructionProject.pk,
                project_type: window.currentConstructionProject.project_type,
                contacts: window.constructionProjectContacts || []
            };
            
            // Load contacts for the project if not already loaded
            if (!window.constructionProjectContacts || window.constructionProjectContacts.length === 0) {
                const projectPk = window.currentConstructionProject.pk;
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectPk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.constructionProjectContacts = response.contacts;
                            window.currentQuotesProject.contacts = response.contacts;
                            console.log('Loaded', response.contacts.length, 'contacts for quotes');
                        }
                    }
                });
            }
            
            $.ajax({
                url: '{% url "core:quotes" %}',
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                    // Update headers for construction mode before loading data
                    updateQuoteAllocationsHeaders();
                    // Now fetch and populate the quotes
                    loadQuotesData();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Quotes</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load quotes data for the current project (shared for Construction & Tender)
        // Made global so quotes_section.js can detect it and skip auto-init
        window.loadQuotesData = function loadQuotesData() {
            const projectPk = window.currentQuotesProject ? window.currentQuotesProject.pk : 
                              (window.currentConstructionProject ? window.currentConstructionProject.pk : 
                               window.currentTenderProject ? window.currentTenderProject.pk : null);
            if (!projectPk) {
                console.error('No project available for loading quotes');
                return;
            }
            console.log('Loading quotes for project:', projectPk);
            
            // First ensure items are loaded for the allocation dropdowns
            const loadItemsIfNeeded = function() {
                return new Promise((resolve) => {
                    if (window.itemsItems && window.itemsItems.length > 0) {
                        resolve();
                    } else {
                        $.ajax({
                            url: `/get_project_items/${projectPk}/`,
                            type: 'GET',
                            success: function(response) {
                                if (response.status === 'success') {
                                    window.itemsItems = response.items;
                                    console.log('Loaded items for quotes:', window.itemsItems.length);
                                }
                                resolve();
                            },
                            error: function() {
                                console.error('Failed to load items for quotes');
                                resolve();
                            }
                        });
                    }
                });
            };
            
            loadItemsIfNeeded().then(function() {
                $.ajax({
                    url: `/core/get_project_quotes/${projectPk}/`,
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Loaded quotes:', response.quotes.length);
                            window.quotesCostingItems = window.itemsItems || [];
                            console.log('Costing items for quotes:', window.quotesCostingItems.length);
                            const contacts = (window.currentQuotesProject && window.currentQuotesProject.contacts) || [];
                            populateQuotesTable(response.quotes, contacts);
                        } else {
                            console.error('Error loading quotes:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load quotes:', error);
                        $('#quoteMainTableBody').html(`
                            <tr><td colspan="5" style="text-align: center; color: #dc3545;">Failed to load quotes</td></tr>
                        `);
                    }
                });
            });
        }
        
        // ==========================================
        // NEW QUOTE INLINE ENTRY (Shared for Construction & Tender)
        // ==========================================
        
        // State for new quote mode
        window.newQuoteMode = false;
        window.newQuotePdfData = null;
        window.newQuotePdfUrl = null;
        window.newQuoteAllocations = [];
        window.currentQuotesProject = null; // Shared project reference for quotes
        
        // Click handler for New Quote button (construction)
        $(document).on('click', '#constructionNewQuoteBtn', function() {
            console.log('Construction New Quote button clicked');
            $('#constructionQuotePdfInput').click();
        });
        
        // Click handler for New Quote button (tender) - triggers file input
        $(document).on('click', '#newQuoteBtn', function() {
            console.log('Tender New Quote button clicked');
            $('#tenderQuotePdfInput').click();
        });
        
        // File input change handler for new quote PDF (Construction & Tender - both use enterNewQuoteMode)
        $(document).on('change', '#constructionQuotePdfInput, #tenderQuotePdfInput', function(event) {
            var file = event.target.files[0];
            if (file) {
                console.log('Quote PDF selected:', file.name);
                
                var pdfBlobUrl = URL.createObjectURL(file);
                var reader = new FileReader();
                reader.onload = function(e) {
                    var pdfData = e.target.result;
                    
                    // Store PDF data for later save
                    window.newQuotePdfData = pdfData;
                    window.newQuotePdfUrl = pdfBlobUrl;
                    
                    // Enter new quote mode - add editable row inline
                    enterNewQuoteMode();
                };
                reader.onerror = function(e) {
                    console.error('Error reading PDF file:', e);
                    alert('Error reading PDF file. Please try again.');
                };
                reader.readAsDataURL(file);
                
                $(this).val('');
            }
        });
        
        // Enter new quote mode - add editable row at top of table
        function enterNewQuoteMode() {
            window.newQuoteMode = true;
            window.newQuoteAllocations = [];
            
            const tbody = $('#quoteMainTableBody');
            
            // Remove any existing new quote row
            tbody.find('.new-quote-row').remove();
            
            // Remove "no quotes" placeholder if present
            if (tbody.find('tr').length === 1 && tbody.find('tr td[colspan]').length === 1) {
                tbody.empty();
            }
            
            // Build supplier dropdown options (use shared currentQuotesProject)
            const suppliers = (window.currentQuotesProject && window.currentQuotesProject.contacts) || [];
            let supplierOptions = '<option value="">Select Supplier...</option>';
            suppliers.forEach(function(contact) {
                supplierOptions += `<option value="${contact.contact_pk}">${contact.name}</option>`;
            });
            
            // Create new editable row at TOP
            const newRow = $(`
                <tr class="new-quote-row selected-row" style="background-color: #fffde7 !important; opacity: 1 !important;">
                    <td>
                        <select class="form-control form-control-sm new-quote-supplier" style="font-size: 11px;">
                            ${supplierOptions}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm new-quote-net" 
                               step="0.01" min="0" placeholder="0.00" style="font-size: 11px;">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm new-quote-number" 
                               placeholder="Quote #" maxlength="255" style="font-size: 11px;">
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-secondary new-quote-save-btn" disabled 
                                style="font-size: 10px; padding: 2px 8px;">Save</button>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-outline-danger new-quote-cancel-btn"
                                style="font-size: 10px; padding: 2px 6px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `);
            
            // Prepend to table
            tbody.prepend(newRow);
            
            // Select the new row visually
            tbody.addClass('has-selection');
            tbody.find('tr').removeClass('selected-row');
            newRow.addClass('selected-row');
            
            // Show PDF in viewer
            $('#quotePdfViewer').attr('src', window.newQuotePdfUrl).show();
            $('#quoteViewerPlaceholder').hide();
            
            // Clear allocations table and add empty row for new quote
            const allocBody = $('#quoteAllocationsTableBody');
            allocBody.empty();
            
            // Update headers based on project type (construction vs non-construction)
            updateQuoteAllocationsHeaders();
            
            addQuoteAllocationRow(); // Add one empty row
            
            // Update title
            $('#quoteAllocationsTitle').text('Quote Allocations (New Quote)');
            
            // Show Add Row button in new quote mode
            $('#quoteAddAllocationBtn').show();
            
            // Reset still to allocate
            updateNewQuoteStillToAllocate();
            
            // Focus on supplier dropdown
            newRow.find('.new-quote-supplier').focus();
        }
        
        // Exit new quote mode
        function exitNewQuoteMode() {
            window.newQuoteMode = false;
            window.newQuotePdfData = null;
            window.newQuotePdfUrl = null;
            window.newQuoteAllocations = [];
            
            // Remove new quote row
            $('#quoteMainTableBody').find('.new-quote-row').remove();
            
            // Reset title
            $('#quoteAllocationsTitle').text('Quote Allocations');
            
            // Reload quotes data
            loadQuotesData();
        }
        
        // Validate new quote and update save button state
        function validateNewQuote() {
            const row = $('.new-quote-row');
            if (row.length === 0) return false;
            
            const supplier = row.find('.new-quote-supplier').val();
            const net = parseFloat(row.find('.new-quote-net').val()) || 0;
            const quoteNumber = row.find('.new-quote-number').val().trim();
            
            // Check if we have allocations
            const allocations = getNewQuoteAllocations();
            const totalAllocated = allocations.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            const stillToAllocate = net - totalAllocated;
            
            // Validation: supplier, quote #, net > 0, at least one allocation, fully allocated
            const hasValidAllocations = allocations.length > 0 && 
                                        allocations.some(a => a.item_pk && parseFloat(a.amount) > 0);
            const isFullyAllocated = Math.abs(stillToAllocate) < 0.01; // Within 1 cent
            
            const isValid = supplier && quoteNumber && net > 0 && hasValidAllocations && isFullyAllocated;
            
            // Update save button
            const saveBtn = row.find('.new-quote-save-btn');
            if (isValid) {
                saveBtn.removeClass('btn-secondary').addClass('btn-success').prop('disabled', false);
            } else {
                saveBtn.removeClass('btn-success').addClass('btn-secondary').prop('disabled', true);
            }
            
            return isValid;
        }
        
        // Get allocations for new quote from table
        function getNewQuoteAllocations() {
            const allocations = [];
            const isConstruction = isQuotesConstructionProject();
            
            $('#quoteAllocationsTableBody tr').each(function() {
                const row = $(this);
                const itemPk = row.find('.quote-allocation-item-select').val();
                const amount = parseFloat(row.find('.quote-allocation-net-input').val()) || 0;
                const notes = row.find('.quote-allocation-notes-input').val() || '';
                
                if (itemPk) {
                    if (isConstruction) {
                        // Construction: gather qty, rate, unit
                        const qty = parseFloat(row.find('.quote-allocation-qty-input').val()) || 0;
                        const rate = parseFloat(row.find('.quote-allocation-rate-input').val()) || 0;
                        const unit = row.find('.quote-allocation-unit-input').val() || '';
                        allocations.push({ item_pk: itemPk, amount, notes, qty, unit, rate });
                    } else {
                        // Non-construction: just amount
                        allocations.push({ item_pk: itemPk, amount, notes, qty: null, unit: '', rate: null });
                    }
                }
            });
            return allocations;
        }
        
        // Update still to allocate for new quote
        function updateNewQuoteStillToAllocate() {
            if (!window.newQuoteMode) return;
            
            const row = $('.new-quote-row');
            const totalNet = parseFloat(row.find('.new-quote-net').val()) || 0;
            const allocations = getNewQuoteAllocations();
            const totalAllocated = allocations.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            const stillToAllocate = totalNet - totalAllocated;
            
            // Update the still to allocate display (ID is quoteRemainingNet per quotes.html config)
            const stillToAllocateEl = $('#quoteRemainingNet');
            if (stillToAllocateEl.length) {
                stillToAllocateEl.text('$' + stillToAllocate.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                // Color coding
                if (Math.abs(stillToAllocate) < 0.01) {
                    stillToAllocateEl.css('color', '#90EE90'); // Light green
                } else {
                    stillToAllocateEl.css('color', '#ffcccc'); // Light red
                }
            }
            
            // Validate after updating
            validateNewQuote();
        }
        
        // Save new quote
        function saveNewQuote() {
            if (!validateNewQuote()) {
                alert('Please fill in all required fields and add at least one allocation.');
                return;
            }
            
            const row = $('.new-quote-row');
            const supplierPk = row.find('.new-quote-supplier').val();
            const totalCost = parseFloat(row.find('.new-quote-net').val()) || 0;
            const quoteNumber = row.find('.new-quote-number').val().trim();
            const allocations = getNewQuoteAllocations();
            
            // Prepare data for save (use shared currentQuotesProject)
            const saveData = {
                project_pk: window.currentQuotesProject.pk,
                supplier: supplierPk,
                total_cost: totalCost,
                quote_number: quoteNumber,
                line_items: allocations.map(a => ({
                    item: a.item_pk,
                    amount: a.amount,
                    notes: a.notes,
                    qty: a.qty,
                    unit: a.unit,
                    rate: a.rate
                })),
                pdf_data_url: window.newQuotePdfData
            };
            
            // Disable save button while saving
            row.find('.new-quote-save-btn').prop('disabled', true).text('Saving...');
            
            $.ajax({
                url: '/core/save_project_quote/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(saveData),
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Quote saved successfully:', response);
                        exitNewQuoteMode();
                    } else {
                        alert('Error saving quote: ' + response.message);
                        row.find('.new-quote-save-btn').prop('disabled', false).text('Save');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to save quote:', error);
                    alert('Failed to save quote. Please try again.');
                    row.find('.new-quote-save-btn').prop('disabled', false).text('Save');
                }
            });
        }
        
        // Event handlers for new quote row inputs
        $(document).on('change input', '.new-quote-supplier, .new-quote-net, .new-quote-number', function() {
            validateNewQuote();
            if ($(this).hasClass('new-quote-net')) {
                updateNewQuoteStillToAllocate();
            }
        });
        
        // Cancel new quote
        $(document).on('click', '.new-quote-cancel-btn', function() {
            if (confirm('Cancel this new quote entry?')) {
                exitNewQuoteMode();
            }
        });
        
        // Save new quote
        $(document).on('click', '.new-quote-save-btn', function() {
            saveNewQuote();
        });
        
        // Update validation when allocations change (in new quote mode)
        $(document).on('change input', '#quoteAllocationsTableBody input, #quoteAllocationsTableBody select', function() {
            if (window.newQuoteMode) {
                updateNewQuoteStillToAllocate();
            }
        });
        
        // Populate quotes table - delegates to AllocationsManager
        function populateQuotesTable(quotes, suppliers) {
            // Store suppliers globally for backward compatibility
            window.quoteSectionSuppliers = suppliers;
            // Delegate to AllocationsManager (uses custom renderRow from config)
            AllocationsManager.populateMainTable('quote', quotes);
        }
        
        // Select a quote row - delegates to AllocationsManager
        function selectQuoteRow(row) {
            AllocationsManager.selectRow('quote', row);
        }
        
        // Load allocations for a quote - delegates to AllocationsManager
        function loadQuoteAllocations(quotePk) {
            AllocationsManager.loadAllocations('quote', quotePk);
        }
        
        // Populate quote allocations table
        function populateQuoteAllocationsTable(allocations) {
            const tbody = $('#quoteAllocationsTableBody');
            tbody.empty();
            
            // Update headers based on project type (construction vs non-construction)
            updateQuoteAllocationsHeaders();
            const colCount = isQuotesConstructionProject() ? 7 : 4;
            
            if (window.newQuoteMode) {
                // New quote mode: show editable rows
                if (!allocations || allocations.length === 0) {
                    addQuoteAllocationRow();
                } else {
                    allocations.forEach(function(alloc) {
                        addQuoteAllocationRow(alloc);
                    });
                }
                // Set label to "Still to Allocate"
                $('#quoteAllocationFooterLabel').text('Still to Allocate:');
                updateNewQuoteStillToAllocate();
            } else {
                // View mode: show read-only rows
                if (!allocations || allocations.length === 0) {
                    tbody.html('<tr><td colspan="' + colCount + '" style="text-align: center; color: #6c757d; padding: 20px;">No allocations for this quote</td></tr>');
                    $('#quoteRemainingNet').text('$0.00').css('color', '#90EE90');
                } else {
                    allocations.forEach(function(alloc) {
                        displayQuoteAllocationRow(alloc);
                    });
                    // Calculate and display total allocated
                    const totalAllocated = allocations.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
                    $('#quoteRemainingNet').text('$' + totalAllocated.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})).css('color', '#90EE90');
                }
                // Set label to "Total Allocated"
                $('#quoteAllocationFooterLabel').text('Total Allocated:');
            }
        }
        
        // Check if current quotes project is construction type
        function isQuotesConstructionProject() {
            return window.currentQuotesProject && window.currentQuotesProject.project_type === 'construction';
        }
        
        // Column width definitions for quote allocations table
        var quoteAllocationsColumnWidths = {
            construction: ['25%', '10%', '12%', '13%', '13%', '22%', '5%'], // Item, Unit, Qty, Rate, Amount, Notes, Del
            nonConstruction: ['40%', '25%', '30%', '5%'] // Item, $ Net, Notes, Del
        };
        
        // Update quote allocations table headers and inject CSS for alignment
        function updateQuoteAllocationsHeaders() {
            const thead = $('#quoteAllocationsTable thead');
            if (thead.length === 0) return;
            
            const isConstruction = isQuotesConstructionProject();
            const widths = isConstruction ? quoteAllocationsColumnWidths.construction : quoteAllocationsColumnWidths.nonConstruction;
            
            // Clear and rebuild headers with inline widths
            thead.empty();
            const headerRow = $('<tr>');
            
            if (isConstruction) {
                const headers = ['Item', 'Unit', 'Qty', '$ Rate', '$ Amount', 'Notes', ''];
                headers.forEach((h, i) => headerRow.append($('<th>').css('width', widths[i]).text(h)));
            } else {
                const headers = ['Item', '$ Net', 'Notes', ''];
                headers.forEach((h, i) => headerRow.append($('<th>').css('width', widths[i]).text(h)));
            }
            thead.append(headerRow);
            
            // Inject/update CSS to override nth-child rules for tbody cells
            let styleId = 'quoteAllocationsColumnStyles';
            let styleEl = $('#' + styleId);
            if (styleEl.length === 0) {
                styleEl = $('<style>').attr('id', styleId);
                $('head').append(styleEl);
            }
            
            // Build CSS rules for each column
            let css = '';
            widths.forEach((w, i) => {
                css += `#quoteAllocationsTable tbody td:nth-child(${i + 1}) { width: ${w} !important; }\n`;
            });
            styleEl.text(css);
        }
        
        // Display a read-only quote allocation row (for viewing saved quotes)
        function displayQuoteAllocationRow(allocation) {
            const tbody = $('#quoteAllocationsTableBody');
            const row = $('<tr>').attr('data-allocation-pk', allocation.quote_allocations_pk);
            
            if (isQuotesConstructionProject()) {
                // Construction: Item | Unit | Qty | $ Rate | $ Amount | Notes
                row.append($('<td>').text(allocation.item_name || '-'));
                row.append($('<td>').text(allocation.unit || '-'));
                const qty = allocation.qty ? parseFloat(allocation.qty) : 0;
                row.append($('<td>').text(qty.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                const rate = allocation.rate ? parseFloat(allocation.rate) : 0;
                row.append($('<td>').text('$' + rate.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                const amount = allocation.amount ? parseFloat(allocation.amount) : 0;
                row.append($('<td>').text('$' + amount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                row.append($('<td>').text(allocation.notes || '-'));
                row.append($('<td>')); // Empty for delete column
            } else {
                // Non-construction: Item | $ Net | Notes
                row.append($('<td>').text(allocation.item_name || '-'));
                const amount = allocation.amount ? parseFloat(allocation.amount) : 0;
                row.append($('<td>').text('$' + amount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                row.append($('<td>').text(allocation.notes || '-'));
                row.append($('<td>')); // Empty for delete column
            }
            
            tbody.append(row);
        }
        
        // Add an editable quote allocation row (for new quotes / update mode)
        function addQuoteAllocationRow(allocation = null) {
            const tbody = $('#quoteAllocationsTableBody');
            const row = $('<tr>');
            const isConstruction = isQuotesConstructionProject();
            
            if (allocation) {
                row.attr('data-allocation-pk', allocation.quote_allocations_pk);
            }
            
            // 1. Item dropdown with category optgroups
            const itemSelect = $('<select>').addClass('form-control form-control-sm quote-allocation-item-select');
            itemSelect.append($('<option>').val('').text('Select Item...'));
            
            // Populate with costing items, grouped by category
            const costingItems = window.quotesCostingItems || [];
            let currentCategory = null;
            costingItems.forEach(function(item) {
                // Add category optgroup if category changed
                if (item.category__category !== currentCategory) {
                    currentCategory = item.category__category;
                    itemSelect.append($('<optgroup>').attr('label', currentCategory || 'Uncategorized'));
                }
                const option = $('<option>').val(item.costing_pk).text(item.item);
                // Store unit as data attribute for construction mode
                option.attr('data-unit', item.unit__unit_name || item.unit || '');
                if (allocation && allocation.item_pk === item.costing_pk) {
                    option.prop('selected', true);
                }
                itemSelect.find('optgroup').last().append(option);
            });
            
            if (isConstruction) {
                // Construction mode: Item | Unit | Qty | $ Rate | $ Amount | Notes | Del
                
                // Item dropdown with unit auto-populate
                itemSelect.on('change', function() {
                    // Update Unit field when item changes
                    const selectedOption = $(this).find('option:selected');
                    const unit = selectedOption.attr('data-unit') || '';
                    row.find('.quote-allocation-unit-display').text(unit);
                    row.find('.quote-allocation-unit-input').val(unit);
                    
                    if (window.newQuoteMode) {
                        updateNewQuoteStillToAllocate();
                    } else {
                        saveQuoteAllocationRow(row);
                    }
                });
                row.append($('<td>').append(itemSelect));
                
                // 2. Unit (read-only, auto-populated from item)
                const selectedUnit = allocation ? (allocation.unit || '') : '';
                const unitDisplay = $('<span>').addClass('quote-allocation-unit-display').text(selectedUnit);
                const unitInput = $('<input>').attr('type', 'hidden').addClass('quote-allocation-unit-input').val(selectedUnit);
                row.append($('<td>').append(unitDisplay).append(unitInput));
                
                // 3. Qty input
                const qtyInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm quote-allocation-qty-input')
                    .val(allocation && allocation.qty ? parseFloat(allocation.qty).toFixed(2) : '')
                    .on('change input', function() {
                        // Calculate amount = qty * rate
                        const qty = parseFloat($(this).val()) || 0;
                        const rate = parseFloat(row.find('.quote-allocation-rate-input').val()) || 0;
                        const amount = (qty * rate).toFixed(2);
                        row.find('.quote-allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        row.find('.quote-allocation-net-input').val(amount);
                        
                        if (window.newQuoteMode) {
                            updateNewQuoteStillToAllocate();
                        } else {
                            updateQuoteStillToAllocate();
                            saveQuoteAllocationRow(row);
                        }
                    });
                row.append($('<td>').append(qtyInput));
                
                // 4. $ Rate input
                const rateInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm quote-allocation-rate-input')
                    .val(allocation && allocation.rate ? parseFloat(allocation.rate).toFixed(2) : '')
                    .on('change input', function() {
                        // Calculate amount = qty * rate
                        const qty = parseFloat(row.find('.quote-allocation-qty-input').val()) || 0;
                        const rate = parseFloat($(this).val()) || 0;
                        const amount = (qty * rate).toFixed(2);
                        row.find('.quote-allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        row.find('.quote-allocation-net-input').val(amount);
                        
                        if (window.newQuoteMode) {
                            updateNewQuoteStillToAllocate();
                        } else {
                            updateQuoteStillToAllocate();
                            saveQuoteAllocationRow(row);
                        }
                    });
                row.append($('<td>').append(rateInput));
                
                // 5. $ Amount (calculated, read-only display but hidden input for data)
                const calcAmount = allocation && allocation.amount ? parseFloat(allocation.amount) : 0;
                const amountDisplay = $('<span>').addClass('quote-allocation-amount-display')
                    .text('$' + calcAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                const amountHidden = $('<input>').attr('type', 'hidden')
                    .addClass('form-control form-control-sm quote-allocation-net-input')
                    .val(calcAmount.toFixed(2));
                row.append($('<td>').append(amountDisplay).append(amountHidden));
                
                // 6. Notes input
                const notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm quote-allocation-notes-input')
                    .val(allocation ? allocation.notes || '' : '')
                    .on('change', function() {
                        if (!window.newQuoteMode) {
                            saveQuoteAllocationRow(row);
                        }
                    });
                row.append($('<td>').append(notesInput));
                
            } else {
                // Non-construction mode: Item | $ Net | Notes | Del
                itemSelect.on('change', function() {
                    if (window.newQuoteMode) {
                        updateNewQuoteStillToAllocate();
                    } else {
                        saveQuoteAllocationRow(row);
                    }
                });
                row.append($('<td>').append(itemSelect));
                
                // 2. $ Net input
                const netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm quote-allocation-net-input')
                    .val(allocation ? parseFloat(allocation.amount).toFixed(2) : '')
                    .on('change', function() {
                        if (window.newQuoteMode) {
                            updateNewQuoteStillToAllocate();
                        } else {
                            updateQuoteStillToAllocate();
                            saveQuoteAllocationRow(row);
                        }
                    });
                row.append($('<td>').append(netInput));
                
                // 3. Notes input
                const notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm quote-allocation-notes-input')
                    .val(allocation ? allocation.notes || '' : '')
                    .on('change', function() {
                        if (!window.newQuoteMode) {
                            saveQuoteAllocationRow(row);
                        }
                    });
                row.append($('<td>').append(notesInput));
            }
            
            // Delete button (same for both modes)
            const deleteBtn = $('<button>')
                .addClass('btn btn-sm btn-danger')
                .html('<i class="fas fa-times"></i>')
                .on('click', function() {
                    deleteQuoteAllocationRow(row);
                });
            row.append($('<td>').css('text-align', 'center').append(deleteBtn));
            
            tbody.append(row);
        }
        
        // Update quote still to allocate values
        function updateQuoteStillToAllocate() {
            if (!window.currentSelectedQuote) return;
            
            const totalNet = parseFloat(window.currentSelectedQuote.total_cost) || 0;
            
            let allocatedNet = 0;
            $('#quoteAllocationsTableBody tr').each(function() {
                allocatedNet += parseFloat($(this).find('.quote-allocation-net-input').val()) || 0;
            });
            
            const remainingNet = totalNet - allocatedNet;
            
            $('#quoteRemainingNet')
                .text('$' + remainingNet.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}))
                .css('color', Math.abs(remainingNet) < 0.01 ? '#90EE90' : '#ffcccc');
        }
        
        // Save a quote allocation row (debounced)
        let quoteAllocationSaveTimeout = null;
        function saveQuoteAllocationRow(row) {
            clearTimeout(quoteAllocationSaveTimeout);
            quoteAllocationSaveTimeout = setTimeout(function() {
                const allocationPk = row.attr('data-allocation-pk');
                const itemPk = row.find('.quote-allocation-item-select').val();
                const net = row.find('.quote-allocation-net-input').val();
                const notes = row.find('.quote-allocation-notes-input').val();
                const isConstruction = isQuotesConstructionProject();
                
                if (!window.currentSelectedQuote) return;
                
                const data = {
                    quote_pk: window.currentSelectedQuote.quotes_pk,
                    item_pk: itemPk || null,
                    amount: net || 0,
                    notes: notes || ''
                };
                
                // Add construction-specific fields
                if (isConstruction) {
                    data.qty = row.find('.quote-allocation-qty-input').val() || '';
                    data.rate = row.find('.quote-allocation-rate-input').val() || '';
                    data.unit = row.find('.quote-allocation-unit-input').val() || '';
                }
                
                if (allocationPk) {
                    // Update existing
                    $.ajax({
                        url: `/core/update_quote_allocation/${allocationPk}/`,
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            console.log('Quote allocation updated:', response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to update quote allocation:', error);
                        }
                    });
                } else if (itemPk || net) {
                    // Create new
                    $.ajax({
                        url: '/core/create_quote_allocation/',
                        type: 'POST',
                        data: data,
                        success: function(response) {
                            if (response.status === 'success') {
                                row.attr('data-allocation-pk', response.allocation_pk);
                                console.log('Quote allocation created:', response);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to create quote allocation:', error);
                        }
                    });
                }
            }, 500);
        }
        
        // Delete a quote allocation row
        function deleteQuoteAllocationRow(row) {
            // In new quote mode, just remove the row without AJAX
            if (window.newQuoteMode) {
                row.remove();
                updateNewQuoteStillToAllocate();
                return;
            }
            
            const allocationPk = row.attr('data-allocation-pk');
            
            if (allocationPk) {
                $.ajax({
                    url: `/core/delete_quote_allocation/${allocationPk}/`,
                    type: 'DELETE',
                    success: function(response) {
                        row.remove();
                        updateQuoteStillToAllocate();
                        console.log('Quote allocation deleted');
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete quote allocation:', error);
                    }
                });
            } else {
                row.remove();
                updateQuoteStillToAllocate();
            }
        }
        
        // Delete a quote
        function deleteQuote(quotePk, row) {
            if (!confirm('Are you sure you want to delete this quote?')) return;
            
            $.ajax({
                url: `/core/delete_quote/${quotePk}/`,
                type: 'DELETE',
                success: function(response) {
                    row.remove();
                    // Clear allocations and PDF viewer
                    $('#quoteAllocationsTableBody').empty();
                    $('#quotePdfViewer').hide();
                    $('#quoteViewerPlaceholder').show();
                    console.log('Quote deleted');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to delete quote:', error);
                    alert('Failed to delete quote. Please try again.');
                }
            });
        }
        
        // Open quote update modal (placeholder - uses existing QuotesEntry)
        function openQuoteUpdateModal(quote) {
            console.log('Opening update modal for quote:', quote);
            // This uses the existing QuotesEntry module
            QuotesEntry.init({
                pdfUrl: quote.pdf_url,
                pdfDataUrl: null,
                containerSelector: '#constructionContentArea',
                projectPk: window.currentConstructionProject.pk,
                projectType: window.currentConstructionProject.project_type,
                suppliers: window.constructionProjectContacts,
                items: window.itemsItems,
                existingQuote: quote,
                onSave: function(response) {
                    console.log('Quote updated:', response);
                    loadConstructionQuotesSection();
                },
                onCancel: function() {
                    loadConstructionQuotesSection();
                }
            });
        }
        
        // Add allocation button handler
        $(document).on('click', '#quoteAddAllocationBtn', function() {
            addQuoteAllocationRow();
        });
        
        // Load construction documents section for CONSTRUCTION
        function loadConstructionDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction contract budget section for CONSTRUCTION
        function loadConstructionContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction PO section for CONSTRUCTION
        function loadConstructionPOSection() {
            window.loadSharedPOSection({
                projectObj: window.currentConstructionProject,
                contentAreaId: 'constructionContentArea'
            });
        }
        
        // Load construction HC Variations section for CONSTRUCTION
        function loadConstructionHCVariationsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-exchange-alt" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Variations</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // Load construction HC Claims section for CONSTRUCTION
        function loadConstructionHCClaimsSection() {
            // Placeholder - will be implemented next
            $('#constructionContentArea').html(`
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 64px; margin-bottom: 20px;"></i>
                    <h4>HC Claims</h4>
                    <p>Coming soon...</p>
                </div>
            `);
        }
        
        // ==========================================
        // INVOICES SECTION - Uses AllocationsManager
        // ==========================================
        
        // Check if current invoices project is construction type
        function isInvoicesConstructionProject() {
            return window.currentConstructionProject && window.currentConstructionProject.project_type === 'construction';
        }
        
        // Column width definitions for invoice allocations table
        var invoiceAllocationsColumnWidths = {
            construction: ['25%', '8%', '10%', '12%', '12%', '28%', '5%'], // Item, Unit, Qty, Rate, Amount, Notes, Del
            constructionReadonly: ['26%', '10%', '12%', '14%', '14%', '24%'], // Item, Unit, Qty, Rate, Amount, Notes (no Del)
            nonConstruction: ['35%', '15%', '15%', '30%', '5%'], // Item, $ Net, $ GST, Notes, Del
            nonConstructionReadonly: ['35%', '18%', '18%', '29%'] // Item, $ Net, $ GST, Notes (no Del)
        };
        
        // Update invoice allocations table headers and inject CSS for alignment
        function updateInvoiceAllocationsHeaders(tableId = 'invoiceAllocationsTable') {
            const thead = $('#' + tableId + ' thead');
            if (thead.length === 0) return;
            
            const isConstruction = isInvoicesConstructionProject();
            const isAllocated = tableId.includes('allocated'); // Allocated tables are read-only (no delete column)
            
            // Select appropriate widths based on construction mode and readonly status
            let widths;
            if (isConstruction) {
                widths = isAllocated ? invoiceAllocationsColumnWidths.constructionReadonly : invoiceAllocationsColumnWidths.construction;
            } else {
                widths = isAllocated ? invoiceAllocationsColumnWidths.nonConstructionReadonly : invoiceAllocationsColumnWidths.nonConstruction;
            }
            
            // Clear and rebuild headers with inline widths
            thead.empty();
            const headerRow = $('<tr>');
            
            if (isConstruction) {
                // Construction: Item | Unit | Qty | $ Rate | $ Amount | Notes | [Del if not readonly]
                const headers = isAllocated 
                    ? ['Item', 'Unit', 'Qty', '$ Rate', '$ Amount', 'Notes']
                    : ['Item', 'Unit', 'Qty', '$ Rate', '$ Amount', 'Notes', ''];
                headers.forEach((h, i) => headerRow.append($('<th>').css('width', widths[i]).text(h)));
            } else {
                // Non-construction: Item | $ Net | $ GST | Notes | [Del if not readonly]
                const headers = isAllocated 
                    ? ['Item', '$ Net', '$ GST', 'Notes']
                    : ['Item', '$ Net', '$ GST', 'Notes', ''];
                headers.forEach((h, i) => headerRow.append($('<th>').css('width', widths[i]).text(h)));
            }
            thead.append(headerRow);
            
            // Inject/update CSS to override nth-child rules for tbody cells
            let styleId = tableId + 'ColumnStyles';
            let styleEl = $('#' + styleId);
            if (styleEl.length === 0) {
                styleEl = $('<style>').attr('id', styleId);
                $('head').append(styleEl);
            }
            
            // Build CSS rules for each column
            let css = '';
            widths.forEach((w, i) => {
                css += `#${tableId} tbody td:nth-child(${i + 1}) { width: ${w} !important; }\n`;
            });
            styleEl.text(css);
            
            // Update footer layout for construction mode
            const footerId = isAllocated ? '#allocatedInvoiceAllocationsFooter' : '#invoiceAllocationsFooter';
            const footer = $(footerId);
            
            if (footer.length) {
                // Rebuild footer to match new column structure
                footer.empty();
                const footerLabel = isAllocated ? 'Total Allocated:' : 'Still to Allocate:';
                
                if (isConstruction) {
                    // Construction footer: Item | Unit | Qty | Rate | Amount (with value) | Notes | [Del]
                    footer.append($('<div>').css({width: widths[0], padding: '6px 8px'}).html(`<span>${footerLabel}</span>`));
                    footer.append($('<div>').css({width: widths[1], padding: '6px 8px'}));
                    footer.append($('<div>').css({width: widths[2], padding: '6px 8px'}));
                    footer.append($('<div>').css({width: widths[3], padding: '6px 8px'}));
                    const netSpanId = isAllocated ? 'allocatedTotalNet' : 'invoiceRemainingNet';
                    footer.append($('<div>').css({width: widths[4], padding: '6px 8px'}).html(`<span id="${netSpanId}" style="color: ${isAllocated ? '#90EE90' : '#ffcccc'};">$0.00</span>`));
                    footer.append($('<div>').css({width: widths[5], padding: '6px 8px'}));
                    if (!isAllocated) {
                        footer.append($('<div>').css({width: widths[6], padding: '6px 8px'}));
                    }
                } else {
                    // Non-construction footer: Item | Net (with value) | GST (with value) | Notes | [Del]
                    footer.append($('<div>').css({width: widths[0], padding: '6px 8px'}).html(`<span>${footerLabel}</span>`));
                    const netSpanId = isAllocated ? 'allocatedTotalNet' : 'invoiceRemainingNet';
                    const gstSpanId = isAllocated ? 'allocatedTotalGst' : 'invoiceRemainingGst';
                    footer.append($('<div>').css({width: widths[1], padding: '6px 8px'}).html(`<span id="${netSpanId}" style="color: ${isAllocated ? '#90EE90' : '#ffcccc'};">$0.00</span>`));
                    footer.append($('<div>').css({width: widths[2], padding: '6px 8px'}).html(`<span id="${gstSpanId}" style="color: ${isAllocated ? '#90EE90' : '#ffcccc'};">$0.00</span>`));
                    footer.append($('<div>').css({width: widths[3], padding: '6px 8px'}));
                    if (!isAllocated) {
                        footer.append($('<div>').css({width: widths[4], padding: '6px 8px'}));
                    }
                }
            }
        }
        
        // Initialize invoices AllocationsManager configuration
        function initInvoicesAllocationsManager() {
            if (window.invoicesManagerInitialized) return;
            
            AllocationsManager.init({
                sectionId: 'invoice',
                mainTable: {
                    emptyMessage: 'No unallocated invoices found for this project.',
                    showFooter: true,
                    footerTotals: [
                        { colIndex: 3, valueKey: 'total_net' },
                        { colIndex: 4, valueKey: 'total_gst' }
                    ],
                    // Note: Invoices use custom populateUnallocatedInvoicesTable due to editable fields
                    onRowSelect: function(row, pk, cfg) {
                        // Store current selected invoice data
                        window.currentSelectedInvoice = {
                            invoice_pk: pk,
                            total_net: parseFloat(row.find('.net-input').val()) || 0,
                            total_gst: parseFloat(row.find('.gst-input').val()) || 0
                        };
                    }
                },
                allocations: {
                    emptyMessage: 'No allocations for this invoice',
                    editable: true,
                    // Custom allocation row renderer for invoices
                    renderEditableRow: function(allocation, cfg, onChange) {
                        // Uses createInvoiceAllocationRow from existing code
                        return createInvoiceAllocationRow(
                            allocation ? allocation.allocation_pk : null,
                            allocation ? allocation.item_pk : '',
                            allocation ? allocation.amount : '',
                            allocation ? allocation.gst_amount : '',
                            allocation ? allocation.notes : ''
                        );
                    },
                    onUpdate: function(sectionId, totals) {
                        updateInvoiceStillToAllocate();
                        validateInvoiceAllocation();
                    }
                },
                api: {
                    loadAllocations: '/core/get_unallocated_invoice_allocations/{pk}/'
                }
            });
            
            window.invoicesManagerInitialized = true;
            console.log('Invoices AllocationsManager initialized');
        }
        
        // Load construction Invoices section for CONSTRUCTION
        function loadConstructionInvoicesSection(subsection = 'unallocated') {
            console.log(`Loading invoices section: ${subsection}`);
            
            // Initialize AllocationsManager for invoices
            initInvoicesAllocationsManager();
            
            // Determine which template to load based on subsection
            const templateUrl = subsection === 'allocated' 
                ? '/core/invoices/?template=allocated'
                : '{% url "core:invoices" %}';
            const loadFunction = subsection === 'allocated' 
                ? loadAllocatedInvoices 
                : loadUnallocatedInvoices;
            
            $.ajax({
                url: templateUrl,
                type: 'GET',
                success: function(response) {
                    $('#constructionContentArea').html(response);
                    // Now fetch and populate the invoices
                    loadFunction();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load invoices section:', error);
                    $('#constructionContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Invoices</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load unallocated invoices data
        // Made global so invoices_section.js can detect it and skip auto-init
        window.loadUnallocatedInvoices = function loadUnallocatedInvoices() {
            if (!window.currentConstructionProject || !window.currentConstructionProject.pk) {
                console.error('No construction project available for loading unallocated invoices');
                return;
            }
            const projectPk = window.currentConstructionProject.pk;
            console.log('Loading unallocated invoices for project:', projectPk);
            
            $.ajax({
                url: `/core/get_project_invoices/${projectPk}/?status=0`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Loaded invoices:', response.invoices.length);
                        // Store costing items globally for allocation dropdown
                        window.invoiceCostingItems = response.costing_items || [];
                        console.log('Loaded costing items:', window.invoiceCostingItems.length);
                        populateUnallocatedInvoicesTable(response.invoices, response.suppliers);
                    } else {
                        console.error('Error loading invoices:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load invoices:', error);
                    $('#unallocatedInvoicesTableBody').html(`
                        <tr><td colspan="5" style="text-align: center; color: #dc3545;">Failed to load invoices</td></tr>
                    `);
                }
            });
        }
        
        // Populate unallocated invoices table
        // Made global so invoices_section.js can detect it and skip auto-init
        window.populateUnallocatedInvoicesTable = function populateUnallocatedInvoicesTable(invoices, suppliers) {
            const tbody = $('#unallocatedInvoicesTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (invoices.length === 0) {
                tbody.html(`
                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                        No unallocated invoices found for this project.
                    </td></tr>
                `);
                return;
            }
            
            // Store suppliers globally for this section
            window.invoiceSectionSuppliers = suppliers;
            
            invoices.forEach(function(invoice) {
                // Use pdf_url if available, otherwise fallback to attachment_url
                const pdfUrl = invoice.pdf_url || invoice.attachment_url || '';
                console.log(`Invoice ${invoice.invoice_pk}: pdf_url=${invoice.pdf_url}, attachment_url=${invoice.attachment_url}, using=${pdfUrl}`);
                const row = $('<tr>').attr('data-invoice-pk', invoice.invoice_pk).attr('data-pdf-url', pdfUrl);
                
                // 1. Supplier dropdown
                const supplierSelect = $('<select>').addClass('form-control form-control-sm supplier-select');
                supplierSelect.append($('<option>').val('').text('Select Supplier...'));
                suppliers.forEach(function(supplier) {
                    const option = $('<option>').val(supplier.contact_pk).text(supplier.name);
                    if (invoice.supplier_pk === supplier.contact_pk) {
                        option.prop('selected', true);
                    }
                    supplierSelect.append(option);
                });
                row.append($('<td>').append(supplierSelect));
                
                // 2. Invoice # input
                const invoiceNumberInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm invoice-number-input')
                    .val(invoice.invoice_number || '')
                    .attr('placeholder', 'Invoice #');
                row.append($('<td>').append(invoiceNumberInput));
                
                // 3. $ Net input (limit to 2dp)
                const netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm net-input')
                    .val(invoice.total_net !== null ? invoice.total_net : '')
                    .attr('placeholder', '0.00')
                    .on('input', function() {
                        let value = $(this).val();
                        // Prevent negative
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        // Limit to 2dp
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                        // Auto-calculate GST as 10% of NET (unless GST has been manually edited)
                        const gstInput = $(this).closest('tr').find('.gst-input');
                        if (!gstInput.data('manually-edited')) {
                            const netValue = parseFloat($(this).val());
                            if (!isNaN(netValue)) {
                                gstInput.val((netValue * 0.1).toFixed(2));
                            }
                        }
                    });
                row.append($('<td>').append(netInput));
                
                // 4. $ GST input (limit to 2dp, predicts 10% until manually edited)
                const gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm gst-input')
                    .val(invoice.total_gst !== null ? invoice.total_gst : '')
                    .attr('placeholder', '0.00')
                    .on('focus', function() {
                        // Mark as manually edited once user focuses on it
                        $(this).data('manually-edited', true);
                    })
                    .on('input', function() {
                        let value = $(this).val();
                        // Prevent negative
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        // Limit to 2dp
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                    });
                row.append($('<td>').append(gstInput));
                
                // 5. Allocate button (greyed out initially, turns green when fully allocated)
                const allocateBtn = $('<button>')
                    .addClass('btn btn-sm btn-secondary allocate-invoice-btn')
                    .text('Allocate')
                    .css('font-size', '10px')
                    .attr('data-invoice-pk', invoice.invoice_pk)
                    .prop('disabled', true)
                    .attr('title', 'Allocate invoice (enabled when fully allocated)')
                    .on('click', function(e) {
                        e.stopPropagation();
                        allocateInvoice($(this));
                    });
                row.append($('<td>').css('text-align', 'center').append(allocateBtn));
                
                // 6. Delete button
                const deleteBtn = $('<button>')
                    .addClass('btn btn-sm btn-danger delete-invoice-btn')
                    .html('<i class="fas fa-trash"></i>')
                    .attr('data-invoice-pk', invoice.invoice_pk);
                row.append($('<td>').append(deleteBtn));
                
                // Row click handler for selection and PDF viewing (works on any click in the row)
                row.on('click', function(e) {
                    // Don't trigger on delete or allocate button
                    if ($(e.target).closest('.delete-invoice-btn, .allocate-invoice-btn').length) return;
                    
                    selectInvoiceRow($(this));
                });
                
                tbody.append(row);
            });
            
            // Calculate and show footer totals
            let totalNet = 0;
            let totalGst = 0;
            invoices.forEach(function(invoice) {
                totalNet += invoice.total_net || 0;
                totalGst += invoice.total_gst || 0;
            });
            $('#unallocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
            $('#unallocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
            $('#unallocatedInvoicesTableFooter').show();
            
            // Auto-select the first row on page load
            setTimeout(function() {
                const firstRow = $('#unallocatedInvoicesTableBody tr').first();
                console.log('Auto-selecting first row:', firstRow.length, 'invoice_pk:', firstRow.attr('data-invoice-pk'), 'pdf_url:', firstRow.attr('data-pdf-url'));
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectInvoiceRow(firstRow);
                }
            }, 100);
        }
        
        // Helper function to select an invoice row
        // Note: Invoices have editable rows so we keep custom logic, but use AllocationsManager for visual selection
        function selectInvoiceRow(row) {
            // Skip if already selected
            if (row.hasClass('selected-row')) {
                return;
            }
            
            const tbody = $('#unallocatedInvoicesTableBody');
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            tbody.addClass('has-selection');
            
            // Store current selected invoice data (invoice-specific)
            const invoicePk = row.attr('data-invoice-pk') || row.attr('data-pk');
            window.currentSelectedInvoice = {
                invoice_pk: invoicePk,
                total_net: parseFloat(row.find('.net-input').val()) || 0,
                total_gst: parseFloat(row.find('.gst-input').val()) || 0
            };
            
            // Load allocations
            $('#invoiceAllocationsTableBody').empty();
            loadInvoiceAllocations(invoicePk);
            
            // Load PDF in viewer
            const pdfUrl = row.attr('data-pdf-url');
            if (pdfUrl && pdfUrl !== 'null' && pdfUrl !== '') {
                $('#invoicePdfViewer').attr('src', pdfUrl).show();
                $('#invoiceViewerPlaceholder').hide();
            } else {
                $('#invoicePdfViewer').hide();
                $('#invoiceViewerPlaceholder').html(`
                    <i class="fas fa-file-pdf" style="font-size: 64px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>No PDF attached to this invoice</p>
                `).show();
            }
        }
        
        // Load existing allocations for an invoice
        function loadInvoiceAllocations(invoicePk) {
            // Update headers based on project type before loading allocations
            updateInvoiceAllocationsHeaders('invoiceAllocationsTable');
            
            $.ajax({
                url: `/core/get_unallocated_invoice_allocations/${invoicePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        const allocations = response.allocations;
                        console.log('Loaded allocations:', allocations.length);
                        
                        if (allocations.length === 0) {
                            // No existing allocations - create one empty row in database
                            addNewAllocationRow();
                        } else {
                            // Display existing allocations
                            allocations.forEach(function(alloc) {
                                const row = createInvoiceAllocationRow(alloc);
                                $('#invoiceAllocationsTableBody').append(row);
                            });
                        }
                        
                        updateInvoiceStillToAllocate();
                    } else {
                        console.error('Error loading allocations:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocations:', error);
                }
            });
        }
        
        // Update Still to Allocate values
        function updateInvoiceStillToAllocate() {
            if (!window.currentSelectedInvoice) return;
            
            const isConstruction = isInvoicesConstructionProject();
            const totalNet = window.currentSelectedInvoice.total_net;
            const totalGst = window.currentSelectedInvoice.total_gst;
            
            // Calculate allocated amounts from allocation rows
            let allocatedNet = 0;
            let allocatedGst = 0;
            
            $('#invoiceAllocationsTableBody tr').each(function() {
                allocatedNet += parseFloat($(this).find('.allocation-net-input').val()) || 0;
                if (!isConstruction) {
                    allocatedGst += parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                }
            });
            
            const remainingNet = totalNet - allocatedNet;
            const remainingGst = isConstruction ? 0 : totalGst - allocatedGst;
            
            // Update display with thousand comma separators (light colors for gradient background)
            $('#invoiceRemainingNet').text('$' + remainingNet.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})).css('color', Math.abs(remainingNet) < 0.01 ? '#90EE90' : '#ffcccc');
            if (!isConstruction) {
                $('#invoiceRemainingGst').text('$' + remainingGst.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})).css('color', Math.abs(remainingGst) < 0.01 ? '#90EE90' : '#ffcccc');
            }
            
            // Update Allocate button state for the selected row
            const selectedRow = $('#unallocatedInvoicesTableBody tr.selected-row');
            if (selectedRow.length) {
                const allocateBtn = selectedRow.find('.allocate-invoice-btn');
                // For construction mode, only check net; for non-construction, check both
                const isFullyAllocated = isConstruction 
                    ? Math.abs(remainingNet) < 0.01 
                    : Math.abs(remainingNet) < 0.01 && Math.abs(remainingGst) < 0.01;
                
                // Check if all non-zero allocation rows have an item selected
                let allItemsSelected = true;
                $('#invoiceAllocationsTableBody tr').each(function() {
                    const itemVal = $(this).find('.allocation-item-select').val();
                    const netVal = parseFloat($(this).find('.allocation-net-input').val()) || 0;
                    const gstVal = isConstruction ? 0 : parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                    
                    // Only require item for rows with non-zero amounts
                    if ((netVal > 0 || gstVal > 0) && !itemVal) {
                        allItemsSelected = false;
                        return false; // break
                    }
                });
                
                const canAllocate = isFullyAllocated && allItemsSelected;
                
                if (canAllocate) {
                    allocateBtn.prop('disabled', false)
                        .removeClass('btn-secondary')
                        .addClass('btn-success')
                        .attr('title', 'Click to allocate this invoice');
                } else {
                    let title = 'Allocate invoice (enabled when fully allocated)';
                    if (isFullyAllocated && !allItemsSelected) {
                        title = 'All allocation rows must have an Item selected';
                    }
                    allocateBtn.prop('disabled', true)
                        .removeClass('btn-success')
                        .addClass('btn-secondary')
                        .attr('title', title);
                }
            }
        }
        
        // Allocate invoice - set status to 1 and remove from table
        function allocateInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            
            // Show loading state
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // First, delete any zero-value allocation rows (they're redundant)
            const zeroRowsToDelete = [];
            $('#invoiceAllocationsTableBody tr').each(function() {
                const pk = $(this).attr('data-allocation-pk');
                const netVal = parseFloat($(this).find('.allocation-net-input').val()) || 0;
                const gstVal = parseFloat($(this).find('.allocation-gst-input').val()) || 0;
                
                if (pk && Math.abs(netVal) < 0.01 && Math.abs(gstVal) < 0.01) {
                    zeroRowsToDelete.push(pk);
                }
            });
            
            // Delete zero rows first, then allocate
            const deletePromises = zeroRowsToDelete.map(pk => {
                return $.ajax({
                    url: `/core/delete_unallocated_invoice_allocation/${pk}/`,
                    type: 'POST'
                });
            });
            
            // Wait for all deletes to complete, then allocate
            $.when.apply($, deletePromises).always(function() {
                if (zeroRowsToDelete.length > 0) {
                    console.log('Deleted', zeroRowsToDelete.length, 'zero-value allocation rows');
                }
                
                $.ajax({
                    url: `/core/allocate_invoice/${invoicePk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Invoice allocated:', invoicePk);
                            
                            // Remove the row with a fade effect
                            row.fadeOut(300, function() {
                                $(this).remove();
                                
                                // Clear allocations section
                                $('#invoiceAllocationsTableBody').empty();
                                window.currentSelectedInvoice = null;
                                
                                // Update footer totals
                                recalculateFooterTotals();
                                
                                // Select next available row or show placeholder
                                const firstRow = $('#unallocatedInvoicesTableBody tr').first();
                                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                                    selectInvoiceRow(firstRow);
                                } else {
                                    // No more invoices
                                    $('#unallocatedInvoicesTableBody').html(`
                                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
                                            No unallocated invoices found for this project.
                                        </td></tr>
                                    `);
                                    $('#unallocatedInvoicesTableBody').removeClass('has-selection');
                                    $('#invoicePdfViewer').hide();
                                    $('#invoiceViewerPlaceholder').show();
                                    $('#unallocatedInvoicesTableFooter').hide();
                                }
                            });
                        } else {
                            console.error('Error allocating invoice:', response.message);
                            btn.prop('disabled', false).text(originalText).addClass('btn-success');
                            alert('Failed to allocate invoice: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to allocate invoice:', error);
                        btn.prop('disabled', false).text(originalText).addClass('btn-success');
                        alert('Failed to allocate invoice. Please try again.');
                    }
                });
            });
        }
        
        // Recalculate footer totals
        function recalculateFooterTotals() {
            let totalNet = 0;
            let totalGst = 0;
            
            $('#unallocatedInvoicesTableBody tr').each(function() {
                totalNet += parseFloat($(this).find('.net-input').val()) || 0;
                totalGst += parseFloat($(this).find('.gst-input').val()) || 0;
            });
            
            $('#unallocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
            $('#unallocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
        }
        
        // Add a new allocation row (creates in database first)
        function addNewAllocationRow() {
            if (!window.currentSelectedInvoice) return;
            
            $.ajax({
                url: '/core/create_unallocated_invoice_allocation/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    invoice_pk: window.currentSelectedInvoice.invoice_pk,
                    amount: 0,
                    gst_amount: 0,
                    qty: null,
                    unit: '',
                    rate: null
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        // Pass allocation object for construction mode support
                        const row = createInvoiceAllocationRow({
                            allocation_pk: response.allocation_pk,
                            item_pk: null,
                            amount: 0,
                            gst_amount: 0,
                            qty: null,
                            unit: '',
                            rate: null,
                            notes: ''
                        });
                        $('#invoiceAllocationsTableBody').append(row);
                        updateInvoiceStillToAllocate();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating allocation:', error);
                }
            });
        }
        
        // Add Row button handler for invoice allocations
        $(document).on('click', '#addInvoiceAllocationBtn', function(e) {
            e.preventDefault();
            
            if (!window.currentSelectedInvoice) {
                alert('Please select an invoice first');
                return;
            }
            
            addNewAllocationRow();
        });
        
        // Create an invoice allocation row
        // Accepts either an allocation object or individual parameters for backwards compatibility
        function createInvoiceAllocationRow(allocOrPk, itemValue, netAmount, gstAmount, notes) {
            // Support both object and individual params
            let alloc = {};
            if (typeof allocOrPk === 'object' && allocOrPk !== null) {
                alloc = allocOrPk;
            } else {
                alloc = {
                    allocation_pk: allocOrPk,
                    item_pk: itemValue,
                    amount: netAmount,
                    gst_amount: gstAmount,
                    notes: notes,
                    qty: null,
                    unit: null,
                    rate: null
                };
            }
            
            const row = $('<tr>').attr('data-allocation-pk', alloc.allocation_pk);
            const isConstruction = isInvoicesConstructionProject();
            
            // Helper function to save allocation to database (debounced)
            let saveTimeout = null;
            function saveAllocation() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(function() {
                    const pk = row.attr('data-allocation-pk');
                    if (!pk) return;
                    
                    let data;
                    if (isConstruction) {
                        // Construction mode: save qty, rate, unit, amount (calculated)
                        const qty = parseFloat(row.find('.allocation-qty-input').val()) || 0;
                        const rate = parseFloat(row.find('.allocation-rate-input').val()) || 0;
                        data = {
                            item_pk: row.find('.allocation-item-select').val() || null,
                            qty: qty,
                            rate: rate,
                            unit: row.find('.allocation-unit-input').val() || '',
                            amount: qty * rate,
                            gst_amount: 0, // Not used in construction mode
                            notes: row.find('.allocation-notes-input').val() || ''
                        };
                    } else {
                        // Non-construction mode: save net and gst
                        data = {
                            item_pk: row.find('.allocation-item-select').val() || null,
                            amount: parseFloat(row.find('.allocation-net-input').val()) || 0,
                            gst_amount: parseFloat(row.find('.allocation-gst-input').val()) || 0,
                            notes: row.find('.allocation-notes-input').val() || ''
                        };
                    }
                    
                    $.ajax({
                        url: `/core/update_unallocated_invoice_allocation/${pk}/`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function(response) {
                            console.log('Allocation saved:', pk);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error saving allocation:', error);
                        }
                    });
                }, 500); // Debounce 500ms
            }
            
            // 1. Item dropdown (populated with costing items from the project)
            const itemSelect = $('<select>').addClass('form-control form-control-sm allocation-item-select');
            itemSelect.append($('<option>').val('').text('Select Item...'));
            
            // Populate with costing items, grouped by category
            const costingItems = window.invoiceCostingItems || [];
            let currentCategory = null;
            costingItems.forEach(function(item) {
                // Add category optgroup if category changed
                if (item.category__category !== currentCategory) {
                    currentCategory = item.category__category;
                    itemSelect.append($('<optgroup>').attr('label', currentCategory || 'Uncategorized'));
                }
                const option = $('<option>').val(item.costing_pk).text(item.item);
                // Store unit as data attribute for construction mode
                option.attr('data-unit', item.unit__unit_name || item.unit || '');
                if (alloc.item_pk && item.costing_pk == alloc.item_pk) {
                    option.prop('selected', true);
                }
                itemSelect.find('optgroup').last().append(option);
            });
            
            if (isConstruction) {
                // Construction mode: Item | Unit | Qty | $ Rate | $ Amount | Notes | Del
                
                // Item dropdown with unit auto-populate
                itemSelect.on('change', function() {
                    const selectedOption = $(this).find('option:selected');
                    const unit = selectedOption.attr('data-unit') || '';
                    row.find('.allocation-unit-display').text(unit);
                    row.find('.allocation-unit-input').val(unit);
                    saveAllocation();
                    updateInvoiceStillToAllocate();
                });
                row.append($('<td>').append(itemSelect));
                
                // 2. Unit (read-only, auto-populated from item)
                const selectedUnit = alloc.unit || '';
                const unitDisplay = $('<span>').addClass('allocation-unit-display').text(selectedUnit);
                const unitInput = $('<input>').attr('type', 'hidden').addClass('allocation-unit-input').val(selectedUnit);
                row.append($('<td>').append(unitDisplay).append(unitInput));
                
                // 3. Qty input
                const qtyInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm allocation-qty-input')
                    .val(alloc.qty ? parseFloat(alloc.qty).toFixed(2) : '')
                    .on('change input', function() {
                        // Calculate amount = qty * rate
                        const qty = parseFloat($(this).val()) || 0;
                        const rate = parseFloat(row.find('.allocation-rate-input').val()) || 0;
                        const amount = (qty * rate).toFixed(2);
                        row.find('.allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        row.find('.allocation-net-input').val(amount);
                        updateInvoiceStillToAllocate();
                        saveAllocation();
                    });
                row.append($('<td>').append(qtyInput));
                
                // 4. $ Rate input
                const rateInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .addClass('form-control form-control-sm allocation-rate-input')
                    .val(alloc.rate ? parseFloat(alloc.rate).toFixed(2) : '')
                    .on('change input', function() {
                        // Calculate amount = qty * rate
                        const qty = parseFloat(row.find('.allocation-qty-input').val()) || 0;
                        const rate = parseFloat($(this).val()) || 0;
                        const amount = (qty * rate).toFixed(2);
                        row.find('.allocation-amount-display').text('$' + parseFloat(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        row.find('.allocation-net-input').val(amount);
                        updateInvoiceStillToAllocate();
                        saveAllocation();
                    });
                row.append($('<td>').append(rateInput));
                
                // 5. $ Amount (calculated, read-only display but hidden input for data)
                const calcAmount = alloc.amount ? parseFloat(alloc.amount) : 0;
                const amountDisplay = $('<span>').addClass('allocation-amount-display')
                    .text('$' + calcAmount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                const amountHidden = $('<input>').attr('type', 'hidden')
                    .addClass('allocation-net-input').val(calcAmount.toFixed(2));
                row.append($('<td>').append(amountDisplay).append(amountHidden));
                
                // 6. Notes input
                const notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm allocation-notes-input')
                    .attr('placeholder', 'Notes...')
                    .val(alloc.notes || '')
                    .on('blur', saveAllocation);
                row.append($('<td>').append(notesInput));
                
            } else {
                // Non-construction mode: Item | $ Net | $ GST | Notes | Del
                
                // Save on change and update validation
                itemSelect.on('change', function() {
                    saveAllocation();
                    updateInvoiceStillToAllocate();
                });
                row.append($('<td>').append(itemSelect));
                
                // 2. $ Net input
                const netInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm allocation-net-input')
                    .val(alloc.amount || '')
                    .on('input', function() {
                        let value = $(this).val();
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                        // Auto-calculate GST as 10%
                        const gstInputEl = $(this).closest('tr').find('.allocation-gst-input');
                        if (!gstInputEl.data('manually-edited')) {
                            const netVal = parseFloat($(this).val());
                            if (!isNaN(netVal)) {
                                gstInputEl.val((netVal * 0.1).toFixed(2));
                            }
                        }
                        updateInvoiceStillToAllocate();
                        saveAllocation();
                    });
                row.append($('<td>').append(netInput));
                
                // 3. $ GST input
                const gstInput = $('<input>')
                    .attr('type', 'number')
                    .attr('step', '0.01')
                    .attr('min', '0')
                    .addClass('form-control form-control-sm allocation-gst-input')
                    .val(alloc.gst_amount || '')
                    .on('focus', function() {
                        $(this).data('manually-edited', true);
                    })
                    .on('input', function() {
                        let value = $(this).val();
                        if (parseFloat(value) < 0) {
                            $(this).val(0);
                            return;
                        }
                        if (value.includes('.')) {
                            const parts = value.split('.');
                            if (parts[1] && parts[1].length > 2) {
                                $(this).val(parseFloat(value).toFixed(2));
                            }
                        }
                        updateInvoiceStillToAllocate();
                        saveAllocation();
                    });
                row.append($('<td>').append(gstInput));
                
                // 4. Notes input
                const notesInput = $('<input>')
                    .attr('type', 'text')
                    .addClass('form-control form-control-sm allocation-notes-input')
                    .attr('placeholder', 'Notes...')
                    .val(alloc.notes || '')
                    .on('blur', saveAllocation);
                row.append($('<td>').append(notesInput));
            }
            
            // Delete button (both modes)
            const deleteBtn = $('<button>')
                .addClass('btn btn-sm btn-danger delete-allocation-btn')
                .html('<i class="fas fa-times"></i>')
                .on('click', function() {
                    const pk = row.attr('data-allocation-pk');
                    if (pk) {
                        $.ajax({
                            url: `/core/delete_unallocated_invoice_allocation/${pk}/`,
                            type: 'POST',
                            success: function(response) {
                                console.log('Allocation deleted:', pk);
                                row.remove();
                                updateInvoiceStillToAllocate();
                            },
                            error: function(xhr, status, error) {
                                console.error('Error deleting allocation:', error);
                            }
                        });
                    } else {
                        row.remove();
                        updateInvoiceStillToAllocate();
                    }
                });
            row.append($('<td>').append(deleteBtn));
            
            return row;
        }
        
        // Update invoice totals when net/gst inputs change in the main table
        $(document).on('input', '#unallocatedInvoicesTable .net-input, #unallocatedInvoicesTable .gst-input', function() {
            const row = $(this).closest('tr');
            if (row.hasClass('selected-row') && window.currentSelectedInvoice) {
                window.currentSelectedInvoice.total_net = parseFloat(row.find('.net-input').val()) || 0;
                window.currentSelectedInvoice.total_gst = parseFloat(row.find('.gst-input').val()) || 0;
                updateInvoiceStillToAllocate();
            }
        });
        
        // =====================================================
        // ALLOCATED INVOICES SECTION
        // =====================================================
        
        // Load allocated invoices data
        function loadAllocatedInvoices() {
            if (!window.currentConstructionProject || !window.currentConstructionProject.pk) {
                console.error('No construction project available for loading allocated invoices');
                return;
            }
            const projectPk = window.currentConstructionProject.pk;
            console.log('Loading allocated invoices for project:', projectPk);
            
            $.ajax({
                url: `/core/get_project_invoices/${projectPk}/?status=1`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Loaded allocated invoices:', response.invoices.length);
                        populateAllocatedInvoicesTable(response.invoices, response.suppliers);
                    } else {
                        console.error('Error loading allocated invoices:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocated invoices:', error);
                    $('#allocatedInvoicesTableBody').html(`
                        <tr><td colspan="7" style="text-align: center; color: #dc3545;">Failed to load invoices</td></tr>
                    `);
                }
            });
        }
        
        // Helper function to format money with thousand separators
        function formatAllocatedMoney(num) {
            return parseFloat(num || 0).toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Populate allocated invoices table
        function populateAllocatedInvoicesTable(invoices, suppliers) {
            const tbody = $('#allocatedInvoicesTableBody');
            tbody.empty();
            tbody.removeClass('has-selection');
            
            if (invoices.length === 0) {
                tbody.html(`
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                        No allocated invoices found for this project.
                    </td></tr>
                `);
                return;
            }
            
            invoices.forEach(function(invoice) {
                const pdfUrl = invoice.pdf_url || invoice.attachment_url || '';
                const isPOClaim = invoice.invoice_status === 102;
                const row = $('<tr>').attr('data-invoice-pk', invoice.invoice_pk).attr('data-pdf-url', pdfUrl).attr('data-invoice-status', invoice.invoice_status);
                
                // 1. Supplier (read-only)
                const supplierName = invoice.supplier_name || 'Unknown';
                row.append($('<td>').text(supplierName));
                
                // 2. Invoice # 
                const invoiceNumCell = $('<td>');
                if (isPOClaim) {
                    const hasInvoiceNumber = invoice.invoice_number && invoice.invoice_number.trim() !== '';
                    if (hasInvoiceNumber) {
                        // Has invoice number - show as text (can be made editable via Edit button)
                        invoiceNumCell.addClass('allocated-invoice-number-cell')
                            .text(invoice.invoice_number)
                            .attr('data-value', invoice.invoice_number);
                    } else {
                        // No invoice number - show editable input
                        const invoiceNumInput = $('<input>')
                            .attr('type', 'text')
                            .addClass('form-control form-control-sm allocated-invoice-number-input')
                            .val('')
                            .attr('data-original-value', '')
                            .on('input', function(e) {
                                e.stopPropagation();
                                updateAllocatedSaveButtonState(row);
                            })
                            .on('click', function(e) { e.stopPropagation(); });
                        invoiceNumCell.append(invoiceNumInput);
                    }
                } else {
                    invoiceNumCell.text(invoice.invoice_number || '-');
                }
                row.append(invoiceNumCell);
                
                // 3. $ Net (read-only)
                row.append($('<td>').text('$' + formatAllocatedMoney(invoice.total_net)));
                
                // 4. $ GST
                const gstCell = $('<td>');
                if (isPOClaim) {
                    const hasInvoiceNumber = invoice.invoice_number && invoice.invoice_number.trim() !== '';
                    const gstRawValue = invoice.total_gst ? parseFloat(invoice.total_gst).toFixed(2) : '0.00';
                    if (hasInvoiceNumber) {
                        // Has invoice number - show as text (can be made editable via Edit button)
                        gstCell.addClass('allocated-gst-cell')
                            .text('$' + formatAllocatedMoney(invoice.total_gst))
                            .attr('data-value', gstRawValue);
                    } else {
                        // No invoice number - show editable input
                        const gstInput = $('<input>')
                            .attr('type', 'number')
                            .attr('step', '0.01')
                            .attr('min', '0')
                            .addClass('form-control form-control-sm allocated-gst-input')
                            .css({'width': '70px'})
                            .val(gstRawValue)
                            .attr('data-original-value', gstRawValue)
                            .on('click', function(e) { e.stopPropagation(); });
                        gstCell.append(gstInput);
                    }
                } else {
                    gstCell.text('$' + formatAllocatedMoney(invoice.total_gst));
                }
                row.append(gstCell);
                
                // 5. Progress Claim column - show green tick + "view" link for PO claim invoices (status=102)
                const poCell = $('<td>').css('text-align', 'center');
                if (isPOClaim) {
                    // Green tick icon
                    const tickIcon = $('<i>')
                        .addClass('fas fa-check')
                        .css({'color': '#28a745', 'margin-right': '4px'});
                    poCell.append(tickIcon);
                    
                    // View link
                    const viewLink = $('<a>')
                        .attr('href', '#')
                        .addClass('po-view-link')
                        .css({'color': '#007bff', 'cursor': 'pointer', 'text-decoration': 'underline'})
                        .text('view')
                        .attr('data-invoice-pk', invoice.invoice_pk)
                        .on('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            showPOTableForInvoice(invoice.invoice_pk, invoice.invoice_pk);
                        });
                    poCell.append(viewLink);
                }
                // Non-PO claims: leave cell empty
                row.append(poCell);
                
                // 6. Unallocate button - disabled for PO claim invoices
                const unallocateBtn = $('<button>')
                    .addClass('btn btn-sm allocated-action-btn')
                    .text('Unallocate')
                    .attr('data-invoice-pk', invoice.invoice_pk);
                
                if (isPOClaim) {
                    unallocateBtn.addClass('btn-secondary').prop('disabled', true).css('opacity', '0.5');
                } else {
                    unallocateBtn.addClass('btn-warning').on('click', function(e) {
                        e.stopPropagation();
                        unallocateInvoice($(this));
                    });
                }
                row.append($('<td>').css('text-align', 'center').append(unallocateBtn));
                
                // 7. Approve button
                const approveBtn = $('<button>')
                    .addClass('btn btn-sm allocated-action-btn allocated-approve-btn')
                    .text('Approve')
                    .attr('data-invoice-pk', invoice.invoice_pk)
                    .on('click', function(e) {
                        e.stopPropagation();
                        if (!$(this).prop('disabled')) {
                            approveInvoice($(this));
                        }
                    });
                
                // Set approve button state based on PO claim and invoice number
                if (isPOClaim) {
                    const hasInvoiceNumber = invoice.invoice_number && invoice.invoice_number.trim() !== '';
                    if (hasInvoiceNumber) {
                        // Has invoice number - approve is enabled
                        approveBtn.addClass('btn-success').prop('disabled', false);
                    } else {
                        // No invoice number - approve is disabled
                        approveBtn.addClass('btn-secondary').prop('disabled', true).css('opacity', '0.5');
                    }
                } else {
                    approveBtn.addClass('btn-success').prop('disabled', false);
                }
                row.append($('<td>').css('text-align', 'center').append(approveBtn));
                
                // 8. Save/Edit button - only for PO claims
                if (isPOClaim) {
                    const hasInvoiceNumber = invoice.invoice_number && invoice.invoice_number.trim() !== '';
                    const saveEditBtn = $('<button>')
                        .addClass('btn btn-sm allocated-action-btn allocated-save-btn')
                        .attr('data-invoice-pk', invoice.invoice_pk)
                        .attr('data-mode', hasInvoiceNumber ? 'edit' : 'save');
                    
                    if (hasInvoiceNumber) {
                        // Has invoice number - show Edit button (green, enabled)
                        saveEditBtn.addClass('btn-info').text('Edit').prop('disabled', false)
                            .on('click', function(e) {
                                e.stopPropagation();
                                enableEditMode(row);
                            });
                    } else {
                        // No invoice number - show Save button (grey, disabled until validation)
                        saveEditBtn.addClass('btn-secondary').text('Save').prop('disabled', true)
                            .on('click', function(e) {
                                e.stopPropagation();
                                saveAllocatedInvoice($(this));
                            });
                    }
                    row.append($('<td>').css('text-align', 'center').append(saveEditBtn));
                    
                    // Initialize save button state if in save mode
                    if (!hasInvoiceNumber) {
                        updateAllocatedSaveButtonState(row);
                    }
                } else {
                    row.append($('<td>').css('text-align', 'center').text('-'));
                }
                
                // Row click handler for selection and PDF viewing
                row.on('click', function(e) {
                    if ($(e.target).closest('.allocated-action-btn').length) return;
                    if ($(e.target).closest('.po-view-link').length) return;
                    if ($(e.target).closest('input').length) return;
                    selectAllocatedInvoiceRow($(this));
                });
                
                tbody.append(row);
            });
            
            // Calculate and show footer totals
            let totalNet = 0;
            let totalGst = 0;
            invoices.forEach(function(invoice) {
                totalNet += invoice.total_net || 0;
                totalGst += invoice.total_gst || 0;
            });
            $('#allocatedInvoicesNetTotal').text('$' + formatAllocatedMoney(totalNet));
            $('#allocatedInvoicesGstTotal').text('$' + formatAllocatedMoney(totalGst));
            $('#allocatedInvoicesTableFooter').show();
            
            // Auto-select the first row
            setTimeout(function() {
                const firstRow = $('#allocatedInvoicesTableBody tr').first();
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectAllocatedInvoiceRow(firstRow);
                }
            }, 100);
        }
        
        // Update Save button state based on Invoice # field having a value
        function updateAllocatedSaveButtonState(row) {
            const invoiceNumInput = row.find('.allocated-invoice-number-input');
            const saveBtn = row.find('.allocated-save-btn');
            const hasInvoiceNumber = invoiceNumInput.length && invoiceNumInput.val().trim() !== '';
            
            if (hasInvoiceNumber) {
                saveBtn.removeClass('btn-secondary btn-info').addClass('btn-success').prop('disabled', false);
            } else {
                saveBtn.removeClass('btn-success btn-info').addClass('btn-secondary').prop('disabled', true);
            }
        }
        
        // Enable edit mode for a PO claim row
        function enableEditMode(row) {
            const invoiceNumCell = row.find('.allocated-invoice-number-cell');
            const gstCell = row.find('.allocated-gst-cell');
            const saveBtn = row.find('.allocated-save-btn');
            const approveBtn = row.find('.allocated-approve-btn');
            
            // Get current values
            const currentInvoiceNum = invoiceNumCell.attr('data-value') || '';
            const currentGst = gstCell.attr('data-value') || '0.00';
            
            // Replace invoice number cell with input
            const invoiceNumInput = $('<input>')
                .attr('type', 'text')
                .addClass('form-control form-control-sm allocated-invoice-number-input')
                .val(currentInvoiceNum)
                .attr('data-original-value', currentInvoiceNum)
                .on('input', function(e) {
                    e.stopPropagation();
                    updateAllocatedSaveButtonState(row);
                })
                .on('click', function(e) { e.stopPropagation(); });
            invoiceNumCell.removeClass('allocated-invoice-number-cell').empty().append(invoiceNumInput);
            
            // Replace GST cell with input
            const gstInput = $('<input>')
                .attr('type', 'number')
                .attr('step', '0.01')
                .attr('min', '0')
                .addClass('form-control form-control-sm allocated-gst-input')
                .css({'width': '70px'})
                .val(currentGst)
                .attr('data-original-value', currentGst)
                .on('click', function(e) { e.stopPropagation(); });
            gstCell.removeClass('allocated-gst-cell').empty().append(gstInput);
            
            // Change Edit button to Save button
            saveBtn.attr('data-mode', 'save')
                .text('Save')
                .removeClass('btn-info btn-success')
                .addClass('btn-secondary')
                .prop('disabled', true)
                .off('click')
                .on('click', function(e) {
                    e.stopPropagation();
                    saveAllocatedInvoice($(this));
                });
            
            // Disable Approve button while in edit mode
            approveBtn.removeClass('btn-success').addClass('btn-secondary')
                .prop('disabled', true).css('opacity', '0.5');
            
            // Update save button state
            updateAllocatedSaveButtonState(row);
        }
        
        // Save allocated invoice changes (Invoice # and GST)
        function saveAllocatedInvoice(btn) {
            const row = btn.closest('tr');
            const invoicePk = row.attr('data-invoice-pk');
            const invoiceNumber = row.find('.allocated-invoice-number-input').val().trim();
            const totalGst = parseFloat(row.find('.allocated-gst-input').val()) || 0;
            
            // Confirm if GST is 0
            if (totalGst === 0) {
                if (!confirm('Are you sure GST is $0.00 for this Bill?')) {
                    return; // User cancelled
                }
            }
            
            btn.prop('disabled', true).text('Saving...');
            
            $.ajax({
                url: `/core/update_allocated_invoice/${invoicePk}/`,
                type: 'POST',
                data: JSON.stringify({
                    invoice_number: invoiceNumber,
                    total_gst: totalGst.toFixed(2)
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        btn.text('Saved!').addClass('btn-success');
                        setTimeout(function() {
                            // Transition to view mode - convert inputs back to text
                            const invoiceNumCell = row.find('.allocated-invoice-number-input').parent();
                            const gstCell = row.find('.allocated-gst-input').parent();
                            
                            // Replace input with text for invoice number
                            invoiceNumCell.addClass('allocated-invoice-number-cell')
                                .attr('data-value', invoiceNumber)
                                .empty()
                                .text(invoiceNumber);
                            
                            // Replace input with text for GST
                            gstCell.addClass('allocated-gst-cell')
                                .attr('data-value', totalGst.toFixed(2))
                                .empty()
                                .text('$' + formatAllocatedMoney(totalGst));
                            
                            // Change Save button back to Edit button
                            btn.attr('data-mode', 'edit')
                                .text('Edit')
                                .removeClass('btn-success btn-secondary btn-danger')
                                .addClass('btn-info')
                                .prop('disabled', false)
                                .off('click')
                                .on('click', function(e) {
                                    e.stopPropagation();
                                    enableEditMode(row);
                                });
                            
                            // Enable Approve button
                            const approveBtn = row.find('.allocated-approve-btn');
                            approveBtn.removeClass('btn-secondary').addClass('btn-success')
                                .prop('disabled', false).css('opacity', '1');
                        }, 1500);
                    } else {
                        btn.text('Error').removeClass('btn-success').addClass('btn-danger');
                        setTimeout(function() {
                            btn.text('Save').removeClass('btn-danger');
                            updateAllocatedSaveButtonState(row);
                        }, 2000);
                    }
                },
                error: function() {
                    btn.text('Error').removeClass('btn-success').addClass('btn-danger');
                    setTimeout(function() {
                        btn.text('Save').removeClass('btn-danger');
                        updateAllocatedSaveButtonState(row);
                    }, 2000);
                }
            });
        }
        
        // Show PO table for invoice in the viewer area
        function showPOTableForInvoice(invoicePk, currentInvoicePk) {
            console.log('Loading PO table for invoice:', invoicePk);
            
            $.ajax({
                url: `/core/get_po_table_data_for_invoice/${invoicePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        renderPOTableInViewer(response, currentInvoicePk);
                    } else {
                        console.error('Error loading PO data:', response.message);
                        $('#allocatedInvoicePdfViewer').hide();
                        $('#allocatedInvoiceViewerPlaceholder').html(`
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 10px; color: #dc3545;"></i>
                            <p style="color: #dc3545;">${response.message || 'Error loading PO data'}</p>
                        `).show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load PO data:', error);
                    $('#allocatedInvoicePdfViewer').hide();
                    $('#allocatedInvoiceViewerPlaceholder').html(`
                        <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 10px; color: #dc3545;"></i>
                        <p style="color: #dc3545;">Failed to load PO data</p>
                    `).show();
                }
            });
        }
        
        // Render PO table in the viewer area
        function renderPOTableInViewer(data, currentInvoicePk) {
            const isConstruction = data.is_construction;
            const items = data.items;
            const claims = data.individual_claims || [];
            
            // Helper function to format numbers with thousand separators
            function formatMoney(num) {
                return num.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            function formatQty(num) {
                return num.toLocaleString('en-AU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            
            // Find the claim number and allocations for the current invoice
            let currentClaimNumber = null;
            let currentClaimAllocations = {};
            for (let i = 0; i < claims.length; i++) {
                if (claims[i].invoice_pk === currentInvoicePk) {
                    currentClaimNumber = claims[i].claim_number;
                    currentClaimAllocations = claims[i].allocations || {};
                    break;
                }
            }
            
            // Build table HTML
            let tableHtml = `
                <div style="padding: 6px; background: white; height: 100%; overflow-y: auto; overflow-x: auto;">
                    <div style="margin-bottom: 6px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px;">
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 2px;">Payment Schedule</div>
                        <div style="font-size: 9px; color: #6c757d;">
                            <strong>${data.supplier_name}</strong> - ${data.project_name}
                        </div>
                        ${currentClaimNumber ? `<div style="font-size: 10px; font-weight: 700; color: #dc3545; margin-top: 3px;">Progress Claim ${currentClaimNumber}</div>` : ''}
                    </div>
                    
                    <!-- This Claim Table -->
                    <table class="table table-sm" style="font-size: 9px; margin-bottom: 0; table-layout: fixed; width: 100%;">
                        <thead style="background: #34495e; color: white; font-size: 8px;">
                            <tr>
                                <th rowspan="2" style="padding: 3px 2px; width: ${isConstruction ? '20%' : '35%'}; vertical-align: middle;">Description</th>
                                <th rowspan="2" style="padding: 3px 2px; text-align: right; width: ${isConstruction ? '14%' : '22%'}; vertical-align: middle;">Contract $</th>
                                ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: center; width: 8%; vertical-align: middle;">Units</th>' : ''}
                                ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: right; width: 8%; vertical-align: middle;">Qty</th>' : ''}
                                ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: right; width: 12%; vertical-align: middle;">Rate</th>' : ''}
                                <th colspan="2" style="padding: 3px 2px; text-align: center; width: ${isConstruction ? '26%' : '43%'}; background: #dc3545;">This Claim</th>
                            </tr>
                            <tr>
                                <th style="padding: 3px 2px; text-align: right; background: #dc3545;">%</th>
                                <th style="padding: 3px 2px; text-align: right; background: #dc3545;">$</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalContractSum = 0;
            let totalThisClaim = 0;
            let totalAllClaims = 0;
            let totalStillToClaim = 0;
            
            items.forEach(function(item) {
                totalContractSum += item.contract_sum || 0;
                totalAllClaims += item.previous_claims || 0;
                totalStillToClaim += item.still_to_claim || 0;
                
                // Get this claim's amount for this item
                const thisClaimAmount = currentClaimAllocations[item.description] || 0;
                totalThisClaim += thisClaimAmount;
                const thisClaimPercent = item.contract_sum > 0 ? (thisClaimAmount / item.contract_sum * 100) : 0;
                
                tableHtml += `
                    <tr>
                        <td style="padding: 3px 2px; word-break: break-word;">${item.description}</td>
                        <td style="padding: 3px 2px; text-align: right; white-space: nowrap;">$${formatMoney(item.contract_sum || 0)}</td>
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: center;">${item.unit || '-'}</td>` : ''}
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: right;">${formatQty(item.contract_qty || 0)}</td>` : ''}
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: right; white-space: nowrap;">$${formatMoney(item.contract_rate || 0)}</td>` : ''}
                        <td style="padding: 3px 2px; text-align: right; color: #dc3545;">${thisClaimPercent.toFixed(0)}%</td>
                        <td style="padding: 3px 2px; text-align: right; font-weight: 600; color: #dc3545; white-space: nowrap;">$${formatMoney(thisClaimAmount)}</td>
                    </tr>
                `;
            });
            
            // Total row for This Claim table
            tableHtml += `
                        <tr style="background: #f8f9fa; font-weight: 700; border-top: 1px solid #34495e;">
                            <td style="padding: 4px 2px;"><strong>TOTAL</strong></td>
                            <td style="padding: 4px 2px; text-align: right;">$${formatMoney(totalContractSum)}</td>
                            ${isConstruction ? '<td></td><td></td><td></td>' : ''}
                            <td style="padding: 4px 2px; text-align: right; color: #dc3545;">${totalContractSum > 0 ? ((totalThisClaim / totalContractSum) * 100).toFixed(0) : 0}%</td>
                            <td style="padding: 4px 2px; text-align: right; color: #dc3545;">$${formatMoney(totalThisClaim)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Spacing rows -->
                <div style="height: 36px;"></div>
                
                <!-- All Claims To Date Section -->
                <div style="margin-bottom: 6px;">
                    <div style="font-size: 10px; font-weight: 600; color: #2c3e50;">All Claims To Date</div>
                </div>
                <table class="table table-sm" style="font-size: 9px; margin-bottom: 0; table-layout: fixed; width: 100%;">
                    <thead style="background: #34495e; color: white; font-size: 8px;">
                        <tr>
                            <th rowspan="2" style="padding: 3px 2px; width: ${isConstruction ? '16%' : '24%'}; vertical-align: middle;">Description</th>
                            <th rowspan="2" style="padding: 3px 2px; text-align: right; width: ${isConstruction ? '12%' : '16%'}; vertical-align: middle;">Contract $</th>
                            ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: center; width: 6%; vertical-align: middle;">Units</th>' : ''}
                            ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: right; width: 5%; vertical-align: middle;">Qty</th>' : ''}
                            ${isConstruction ? '<th rowspan="2" style="padding: 3px 2px; text-align: right; width: 9%; vertical-align: middle;">Rate</th>' : ''}
                            <th colspan="2" style="padding: 3px 2px; text-align: center; width: ${isConstruction ? '20%' : '30%'};">All Claims</th>
                            <th colspan="2" style="padding: 3px 2px; text-align: center; width: ${isConstruction ? '20%' : '30%'};">Remaining</th>
                        </tr>
                        <tr>
                            <th style="padding: 3px 2px; text-align: right;">%</th>
                            <th style="padding: 3px 2px; text-align: right;">$</th>
                            <th style="padding: 3px 2px; text-align: right;">%</th>
                            <th style="padding: 3px 2px; text-align: right;">$</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach(function(item) {
                const remainingPercent = item.contract_sum > 0 ? ((item.still_to_claim || 0) / item.contract_sum * 100) : 0;
                tableHtml += `
                    <tr>
                        <td style="padding: 3px 2px; word-break: break-word;">${item.description}</td>
                        <td style="padding: 3px 2px; text-align: right; white-space: nowrap;">$${formatMoney(item.contract_sum || 0)}</td>
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: center;">${item.unit || '-'}</td>` : ''}
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: right;">${formatQty(item.contract_qty || 0)}</td>` : ''}
                        ${isConstruction ? `<td style="padding: 3px 2px; text-align: right; white-space: nowrap;">$${formatMoney(item.contract_rate || 0)}</td>` : ''}
                        <td style="padding: 3px 2px; text-align: right;">${(item.complete_percent || 0).toFixed(0)}%</td>
                        <td style="padding: 3px 2px; text-align: right; white-space: nowrap;">$${formatMoney(item.previous_claims || 0)}</td>
                        <td style="padding: 3px 2px; text-align: right;">${remainingPercent.toFixed(0)}%</td>
                        <td style="padding: 3px 2px; text-align: right; font-weight: 600; white-space: nowrap;">$${formatMoney(item.still_to_claim || 0)}</td>
                    </tr>
                `;
            });
            
            // Total row for All Claims table
            tableHtml += `
                        <tr style="background: #f8f9fa; font-weight: 700; border-top: 1px solid #34495e;">
                            <td style="padding: 4px 2px;"><strong>TOTAL</strong></td>
                            <td style="padding: 4px 2px; text-align: right;">$${formatMoney(totalContractSum)}</td>
                            ${isConstruction ? '<td></td><td></td><td></td>' : ''}
                            <td style="padding: 4px 2px; text-align: right;">${totalContractSum > 0 ? ((totalAllClaims / totalContractSum) * 100).toFixed(0) : 0}%</td>
                            <td style="padding: 4px 2px; text-align: right;">$${formatMoney(totalAllClaims)}</td>
                            <td style="padding: 4px 2px; text-align: right;">${totalContractSum > 0 ? ((totalStillToClaim / totalContractSum) * 100).toFixed(0) : 0}%</td>
                            <td style="padding: 4px 2px; text-align: right; font-weight: 600;">$${formatMoney(totalStillToClaim)}</td>
                        </tr>
                    </tbody>
                </table>
                </div>
            `;
            
            // Show table in viewer area (replace PDF viewer)
            $('#allocatedInvoicePdfViewer').hide();
            // Override parent's centering to align content at top, keep horizontal center
            $('#allocatedInvoiceViewerPlaceholder').parent().css({
                'align-items': 'flex-start',
                'justify-content': 'center'
            });
            $('#allocatedInvoiceViewerPlaceholder').css({
                'width': '100%',
                'height': '100%',
                'text-align': 'center'
            }).html(tableHtml).show();
        }
        
        // Select an allocated invoice row
        function selectAllocatedInvoiceRow(row) {
            // Skip if already selected (don't refresh PDF or allocations)
            if (row.hasClass('selected-row')) {
                return;
            }
            
            const tbody = $('#allocatedInvoicesTableBody');
            
            tbody.find('tr').removeClass('selected-row');
            row.addClass('selected-row');
            tbody.addClass('has-selection');
            
            const invoicePk = row.attr('data-invoice-pk');
            
            // Load allocations for this invoice (read-only)
            loadAllocatedInvoiceAllocations(invoicePk);
            
            // Load PDF - restore centering for PDF/placeholder views
            $('#allocatedInvoiceViewerPlaceholder').parent().css({
                'align-items': 'center',
                'justify-content': 'center'
            });
            $('#allocatedInvoiceViewerPlaceholder').css({
                'width': '',
                'height': '',
                'text-align': 'center'
            });
            
            const pdfUrl = row.attr('data-pdf-url');
            if (pdfUrl && pdfUrl !== 'null' && pdfUrl !== '') {
                $('#allocatedInvoicePdfViewer').attr('src', pdfUrl).show();
                $('#allocatedInvoiceViewerPlaceholder').hide();
            } else {
                $('#allocatedInvoicePdfViewer').hide();
                $('#allocatedInvoiceViewerPlaceholder').html(`
                    <i class="fas fa-file-pdf" style="font-size: 64px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>No PDF attached to this invoice</p>
                `).show();
            }
        }
        
        // Load allocations for an allocated invoice (read-only display)
        function loadAllocatedInvoiceAllocations(invoicePk) {
            // Update headers based on project type before loading allocations
            updateInvoiceAllocationsHeaders('allocatedInvoiceAllocationsTable');
            
            $.ajax({
                url: `/core/get_unallocated_invoice_allocations/${invoicePk}/`,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        const allocations = response.allocations;
                        const tbody = $('#allocatedInvoiceAllocationsTableBody');
                        tbody.empty();
                        
                        const isConstruction = isInvoicesConstructionProject();
                        let totalNet = 0;
                        let totalGst = 0;
                        
                        allocations.forEach(function(alloc) {
                            const row = $('<tr>');
                            
                            if (isConstruction) {
                                // Construction: Item | Unit | Qty | $ Rate | $ Amount | Notes
                                row.append($('<td>').text(alloc.item_name || '-'));
                                row.append($('<td>').text(alloc.unit || '-'));
                                const qty = alloc.qty ? parseFloat(alloc.qty) : 0;
                                row.append($('<td>').text(qty.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                                const rate = alloc.rate ? parseFloat(alloc.rate) : 0;
                                row.append($('<td>').text('$' + rate.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                                const amount = alloc.amount ? parseFloat(alloc.amount) : 0;
                                row.append($('<td>').text('$' + amount.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                                row.append($('<td>').text(alloc.notes || '-'));
                                totalNet += amount;
                            } else {
                                // Non-construction: Item | $ Net | $ GST | Notes
                                row.append($('<td>').text(alloc.item_name || '-'));
                                row.append($('<td>').text('$' + (alloc.amount || 0).toFixed(2)));
                                row.append($('<td>').text('$' + (alloc.gst_amount || 0).toFixed(2)));
                                row.append($('<td>').text(alloc.notes || '-'));
                                totalNet += alloc.amount || 0;
                                totalGst += alloc.gst_amount || 0;
                            }
                            
                            tbody.append(row);
                        });
                        
                        // Update totals
                        $('#allocatedTotalNet').text('$' + totalNet.toFixed(2));
                        if (!isConstruction) {
                            $('#allocatedTotalGst').text('$' + totalGst.toFixed(2));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load allocations:', error);
                }
            });
        }
        
        // Unallocate invoice - set status back to 0
        function unallocateInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: `/core/unallocate_invoice/${invoicePk}/`,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Invoice unallocated:', invoicePk);
                        removeAllocatedInvoiceRow(row);
                    } else {
                        console.error('Error unallocating invoice:', response.message);
                        btn.prop('disabled', false).text(originalText);
                        alert('Failed to unallocate invoice: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to unallocate invoice:', error);
                    btn.prop('disabled', false).text(originalText);
                    alert('Failed to unallocate invoice. Please try again.');
                }
            });
        }
        
        // Approve invoice - set status to 2 (or 103 for PO claims)
        function approveInvoice(btn) {
            const invoicePk = btn.attr('data-invoice-pk');
            const row = btn.closest('tr');
            const currentStatus = parseInt(row.attr('data-invoice-status')) || 1;
            
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            $.ajax({
                url: `/core/approve_invoice/${invoicePk}/`,
                type: 'POST',
                data: JSON.stringify({ current_status: currentStatus }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Invoice approved:', invoicePk);
                        removeAllocatedInvoiceRow(row);
                    } else {
                        console.error('Error approving invoice:', response.message);
                        btn.prop('disabled', false).text(originalText);
                        alert('Failed to approve invoice: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to approve invoice:', error);
                    btn.prop('disabled', false).text(originalText);
                    alert('Failed to approve invoice. Please try again.');
                }
            });
        }
        
        // Remove an allocated invoice row and update the view
        function removeAllocatedInvoiceRow(row) {
            row.fadeOut(300, function() {
                $(this).remove();
                
                // Clear allocations section
                $('#allocatedInvoiceAllocationsTableBody').empty();
                $('#allocatedTotalNet').text('$0.00');
                $('#allocatedTotalGst').text('$0.00');
                
                // Recalculate footer totals
                let totalNet = 0;
                let totalGst = 0;
                $('#allocatedInvoicesTableBody tr').each(function() {
                    const netText = $(this).find('td:eq(2)').text().replace('$', '');
                    const gstText = $(this).find('td:eq(3)').text().replace('$', '');
                    totalNet += parseFloat(netText) || 0;
                    totalGst += parseFloat(gstText) || 0;
                });
                $('#allocatedInvoicesNetTotal').text('$' + totalNet.toFixed(2));
                $('#allocatedInvoicesGstTotal').text('$' + totalGst.toFixed(2));
                
                // Select next available row or show placeholder
                const firstRow = $('#allocatedInvoicesTableBody tr').first();
                if (firstRow.length && firstRow.attr('data-invoice-pk')) {
                    selectAllocatedInvoiceRow(firstRow);
                } else {
                    $('#allocatedInvoicesTableBody').html(`
                        <tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                            No allocated invoices found for this project.
                        </td></tr>
                    `);
                    $('#allocatedInvoicesTableBody').removeClass('has-selection');
                    $('#allocatedInvoicePdfViewer').hide();
                    $('#allocatedInvoiceViewerPlaceholder').show();
                    $('#allocatedInvoicesTableFooter').hide();
                }
            });
        }
        
        // Update project button handler
        $(document).on('click', '.update-project-btn', function() {
            const row = $(this).closest('tr');
            const projectPk = row.data('project-pk');
            const currentName = row.find('.project-name').text();
            const currentSalesAccount = row.find('.sales-account').text();
            const originalName = row.data('original-project');
            const originalSalesAccount = row.data('original-sales-account');
            const originalManager = row.data('original-manager');
            const originalManagerEmail = row.data('original-manager-email');
            const originalContractsAdminEmails = row.data('original-contracts-admin-emails');
            
            // Check if already in edit mode
            if (row.hasClass('editing')) {
                // Save changes
                const newName = row.find('.edit-project-name').val().trim();
                const newSalesAccount = row.find('.edit-sales-account').val().trim();
                const newManager = row.find('.edit-manager').val().trim();
                const newManagerEmail = row.find('.edit-manager-email').val().trim();
                const newContractsAdminEmails = row.find('.edit-contracts-admin-emails').val().trim();
                const backgroundFile = row.find('.edit-background-image')[0].files[0];
                
                // Validate
                if (!newName) {
                    alert('Project name is required');
                    return;
                }
                
                // Check if anything changed
                if (newName === originalName && newSalesAccount === originalSalesAccount && 
                    newManager === originalManager && newManagerEmail === originalManagerEmail &&
                    newContractsAdminEmails === originalContractsAdminEmails && !backgroundFile) {
                    // No changes, just exit edit mode
                    row.removeClass('editing');
                    row.find('.project-name').html(originalName);
                    row.find('.sales-account').html(originalSalesAccount || '-');
                    row.find('.manager').html(originalManager || '-');
                    row.find('.manager-email').html(originalManagerEmail || '-');
                    row.find('.contracts-admin-emails').html(originalContractsAdminEmails || '-');
                    $(this).text('Update');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('project_name', newName);
                formData.append('xero_sales_account', newSalesAccount);
                formData.append('manager', newManager);
                formData.append('manager_email', newManagerEmail);
                formData.append('contracts_admin_emails', newContractsAdminEmails);
                if (backgroundFile) {
                    formData.append('background', backgroundFile);
                }
                
                // Show processing state
                $(this).prop('disabled', true).text('Saving...');
                
                // Make AJAX call to update project
                $.ajax({
                    url: `/core/update_project/${projectPk}/`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update row data
                            row.data('original-project', response.project.project);
                            row.data('original-sales-account', response.project.xero_sales_account || '');
                            row.data('original-manager', response.project.manager || '');
                            row.data('original-manager-email', response.project.manager_email || '');
                            row.data('original-contracts-admin-emails', response.project.contracts_admin_emails || '');
                            row.data('background-url', response.project.background_url || '');
                            
                            // Exit edit mode and reload to show updated data
                            row.removeClass('editing');
                            loadProjects();
                            
                            alert('Project updated successfully!');
                        } else {
                            alert('Error updating project: ' + response.message);
                            row.find('.update-project-btn').prop('disabled', false).text('Save');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error updating project:', error);
                        alert('Failed to update project. Please try again.');
                        row.find('.update-project-btn').prop('disabled', false).text('Save');
                    }
                });
            } else {
                // Enter edit mode
                row.addClass('editing');
                
                // Replace project name with input
                row.find('.project-name').html(`<input type="text" class="form-control form-control-sm edit-project-name" value="${currentName}">`);
                
                // Replace sales account with dropdown (populated dynamically)
                const xeroInstancePk = row.data('xero-instance-pk');
                const currentSalesAccountCode = row.data('original-sales-account');
                
                // Create dropdown with loading state
                row.find('.sales-account').html(`
                    <select class="form-control form-control-sm edit-sales-account" disabled>
                        <option value="">Loading accounts...</option>
                    </select>
                `);
                
                // Fetch and populate accounts if xero instance exists
                if (xeroInstancePk) {
                    $.ajax({
                        url: `/core/get_xero_accounts/${xeroInstancePk}/`,
                        type: 'GET',
                        success: function(response) {
                            const salesAccountSelect = row.find('.edit-sales-account');
                            salesAccountSelect.prop('disabled', false);
                            salesAccountSelect.empty();
                            salesAccountSelect.append('<option value="">Select Sales Account</option>');
                            
                            if (response.accounts && response.accounts.length > 0) {
                                // Filter for REVENUE, SALES, and OTHERINCOME accounts
                                const revenueAccounts = response.accounts.filter(acc => 
                                    acc.account_type === 'REVENUE' || 
                                    acc.account_type === 'SALES' || 
                                    acc.account_type === 'OTHERINCOME'
                                );
                                
                                revenueAccounts.forEach(account => {
                                    const isSelected = account.account_code === currentSalesAccountCode ? 'selected' : '';
                                    salesAccountSelect.append(
                                        `<option value="${account.account_code}" ${isSelected}>${account.account_code} - ${account.account_name}</option>`
                                    );
                                });
                            } else {
                                salesAccountSelect.append('<option value="">No sales accounts found</option>');
                            }
                        },
                        error: function() {
                            row.find('.edit-sales-account').html('<option value="">Error loading accounts</option>');
                        }
                    });
                } else {
                    row.find('.edit-sales-account').html('<option value="">No Xero Instance assigned</option>');
                }
                
                // Add inputs for manager fields
                row.find('.manager').html(`<input type="text" class="form-control form-control-sm edit-manager" value="${originalManager}">`);
                row.find('.manager-email').html(`<input type="email" class="form-control form-control-sm edit-manager-email" value="${originalManagerEmail}">`);
                row.find('.contracts-admin-emails').html(`<input type="text" class="form-control form-control-sm edit-contracts-admin-emails" value="${originalContractsAdminEmails}" placeholder="comma-separated">`);
                
                // Add file input for background image
                row.find('.background-image').html(`<input type="file" class="form-control form-control-sm edit-background-image" accept="image/*">`);  
                
                // Change button text
                $(this).text('Save');
                
                // Focus on project name
                row.find('.edit-project-name').focus();
            }
        });
        
        // Archive project button handler (works with both cards and table rows)
        $(document).on('click', '.archive-project-btn', function(e) {
            e.stopPropagation();
            const button = $(this);
            const card = button.closest('.project-card');
            const row = card.length ? card : button.closest('tr');
            const projectPk = row.data('project-pk');
            const projectName = card.length ? card.find('.card-title').text() : row.find('.project-name').text();
            
            // Check if we're viewing archived (restore) or active (archive)
            const isShowingArchived = $('#toggleArchiveBtn').data('showing-archived') === 1;
            const action = isShowingArchived ? 'restore' : 'archive';
            
            if (!confirm(`Are you sure you want to ${action} "${projectName}"?`)) {
                return;
            }
            
            // Show processing state
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Make AJAX call to toggle archive status
            $.ajax({
                url: `/core/toggle_project_archive/${projectPk}/`,
                type: 'POST',
                data: { archived: isShowingArchived ? '0' : '1' },
                success: function(response) {
                    if (response.status === 'success') {
                        // Reload projects list
                        loadProjects(isShowingArchived);
                    } else {
                        alert(response.message || `Error ${action}ing project`);
                        button.prop('disabled', false).html('<i class="fas fa-archive"></i>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error(`Error ${action}ing project:`, error);
                    alert(`Error ${action}ing project. Please try again.`);
                    button.prop('disabled', false).html('<i class="fas fa-archive"></i>');
                }
            });
        });
        
        // Handle Tender link click - show tender view
        $(document).on('click', '.project-status-link', function(e) {
            e.preventDefault();
            
            // Support both card grid and legacy table row
            const card = $(this).closest('.project-card');
            const row = card.length ? card : $(this).closest('tr');
            
            const projectPk = row.data('project-pk');
            const projectName = card.length ? card.find('.card-title').text() : row.find('.project-name').text();
            const backgroundUrl = row.data('background-url');
            const projectType = row.data('project-type');
            
            console.log(`Opening tender view for project: ${projectName} (pk=${projectPk})`);
            console.log(`Background URL: ${backgroundUrl}`);
            console.log(`Project Type: ${projectType}`);
            
            // Store current project info globally
            window.currentTenderProject = {
                pk: projectPk,
                name: projectName,
                backgroundUrl: backgroundUrl,
                project_type: projectType
            };
            
            // Apply background image to workspace if it exists
            if (backgroundUrl) {
                $('#dynamicContentArea').css({
                    'background-image': `url(${backgroundUrl})`,
                    'background-size': 'cover',
                    'background-position': 'center center',
                    'background-repeat': 'no-repeat',
                    'position': 'relative'
                });
                
                // Add overlay to darken/fade the background
                if ($('#dynamicContentArea').find('.workspace-background-overlay').length === 0) {
                    $('#dynamicContentArea').prepend('<div class="workspace-background-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.85); pointer-events: none; z-index: 0;"></div>');
                }
            }
            
            // Hide projects header and grid
            $('#projectsHeader').hide();
            $('#projectsGridContainer').hide();
            
            // Show tender view
            $('#tenderView').css('display', 'flex').show();
            $('#tenderProjectName').text(projectName);
        });
        
        // Handle Back to Projects button (from Tender view)
        $('#backToProjectsBtn').click(function() {
            console.log('Returning to projects list');
            
            // Reset tender view state
            resetTenderViewState();
            
            // Remove background image from workspace
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            
            // Remove overlay
            $('.workspace-background-overlay').remove();
            
            // Hide tender view
            $('#tenderView').hide();
            
            // Show projects header and grid
            $('#projectsHeader').show();
            $('#projectsGridContainer').show();
        });
        
        // Handle Back to Projects button from Construction view
        $('#backToProjectsFromConstructionBtn').click(function() {
            console.log('Returning to projects list from construction');
            
            // Reset construction view state
            resetConstructionViewState();
            
            // Remove background image from workspace
            $('#dynamicContentArea').css({
                'background-image': 'none'
            });
            
            // Remove overlay
            $('.workspace-background-overlay').remove();
            
            // Hide construction view
            $('#constructionView').hide();
            
            // Show projects header and grid
            $('#projectsHeader').show();
            $('#projectsGridContainer').show();
        });
        
        // Function to reset construction view state
        window.resetConstructionViewState = function() {
            // Reset all construction navigation buttons to default state
            $('.construction-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Reset invoices button group
            $('#invoicesButtonGroup').removeClass('active');
            $('.invoices-sub-btn').removeClass('active');
            $('.invoices-sub-btn[data-subsection="unallocated"]').addClass('active');
            
            // Hide all dynamic action buttons
            $('#constructionNewQuoteBtn').hide();
            
            // Clear construction content area
            $('#constructionContentArea').html(`
                <p style="text-align: center; color: #6c757d;">Select a section above to view content.</p>
            `);
            
            // Clear current construction project
            window.currentConstructionProject = null;
        };
        
        // ==========================================
        // SHARED QUOTES FUNCTIONS (used by Tender, Construction, and future project types)
        // ==========================================
        
        // Generic function to load quotes section for any project view
        window.loadSharedQuotesSection = function(config) {
            // config should contain: projectObj, contentAreaId, tableId, pdfViewerId, newQuoteBtnId, pdfInputId, contactsVarName
            const { projectObj, contentAreaId, tableId, pdfViewerId, newQuoteBtnId, pdfInputId, contactsVarName } = config;
            
            // Show New Quote button
            $(`#${newQuoteBtnId}`).show();
            
            // Fetch contacts for this project's Xero instance
            if (projectObj && projectObj.pk) {
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectObj.pk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window[contactsVarName] = response.contacts;
                            console.log(`Loaded ${response.contacts.length} contacts for project from ${response.xero_instance_name}`);
                        } else {
                            console.error('Error loading contacts:', response.message);
                            window[contactsVarName] = [];
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load project contacts:', error);
                        window[contactsVarName] = [];
                    }
                });
            }
            
            // Show Committed Quotes view
            $(`#${contentAreaId}`).html(`
                <div style="display: flex; height: 100%; gap: 15px;">
                    <div style="width: 55%; height: 100%; display: flex; flex-direction: column;">
                        <div style="flex: 1; overflow-y: auto;">
                            <table id="${tableId}" class="reusable-table quotes-table" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Quote #</th>
                                        <th style="width: 35%;">Supplier</th>
                                        <th style="width: 20%;">Total Cost</th>
                                        <th style="width: 10%;">Update</th>
                                        <th style="width: 10%;">Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                            Loading quotes...
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot id="${tableId}-footer" style="display: none;">
                                    <tr style="background: var(--gradient-primary); color: white; font-weight: bold;">
                                        <td>TOTAL</td>
                                        <td></td>
                                        <td id="${tableId}-total">$0.00</td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div style="width: 45%; height: 100%;">
                        <iframe id="${pdfViewerId}" style="width: 100%; height: 100%; border: none;" src=""></iframe>
                    </div>
                </div>
            `);
            
            // Load quotes for this project
            loadSharedProjectQuotes(config);
            
            // Attach handler for New Quote button (using event delegation)
            $(document).off('click', `#${newQuoteBtnId}`).on('click', `#${newQuoteBtnId}`, function() {
                console.log('New Quote button clicked');
                $(`#${pdfInputId}`).click();
            });
            
            // Attach handler for file input change
            $(document).off('change', `#${pdfInputId}`).on('change', `#${pdfInputId}`, function(event) {
                var file = event.target.files[0];
                if (file) {
                    console.log('Quote PDF selected:', file.name);
                    console.log('contentAreaId:', contentAreaId);
                    console.log('projectObj:', projectObj);
                    console.log('contactsVarName:', contactsVarName, 'value:', window[contactsVarName]);
                    
                    var pdfBlobUrl = URL.createObjectURL(file);
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var pdfData = e.target.result;
                        console.log('FileReader onload fired, pdfData length:', pdfData ? pdfData.length : 0);
                        console.log('QuotesEntry available:', typeof QuotesEntry);
                        
                        // Display quote entry form using QuotesEntry module
                        QuotesEntry.init({
                            pdfUrl: pdfBlobUrl,
                            pdfDataUrl: pdfData,
                            containerSelector: `#${contentAreaId}`,
                            projectPk: projectObj.pk,
                            projectType: projectObj.project_type,
                            suppliers: window[contactsVarName],
                            items: window.itemsItems,
                            onSave: function(response) {
                                console.log('Quote saved:', response);
                                window.loadSharedQuotesSection(config);
                            },
                            onCancel: function() {
                                window.loadSharedQuotesSection(config);
                            }
                        });
                    };
                    reader.onerror = function(e) {
                        console.error('Error reading PDF file:', e);
                        alert('Error reading PDF file. Please try again.');
                    };
                    reader.readAsDataURL(file);
                    
                    $(this).val('');
                }
            });
        };
        
        // Generic function to load and display quotes for any project view
        window.loadSharedProjectQuotes = function(config) {
            const { projectObj, tableId, pdfViewerId, contentAreaId, contactsVarName } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected');
                return;
            }
            
            $.ajax({
                url: '/core/get_project_quotes/' + projectObj.pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        var quotes = response.quotes || [];
                        var tbody = $(`#${tableId} tbody`);
                        tbody.empty();
                        
                        if (quotes.length === 0) {
                            tbody.html(`
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                        No quotes found for this project.
                                    </td>
                                </tr>
                            `);
                        } else {
                            quotes.forEach(function(quote) {
                                var row = $('<tr></tr>');
                                
                                row.attr('data-pdf-url', quote.pdf_url);
                                row.attr('data-quote-number', quote.supplier_quote_number);
                                row.css('cursor', 'pointer');
                                
                                row.append('<td>' + quote.supplier_quote_number + '</td>');
                                row.append('<td>' + quote.supplier_name + '</td>');
                                
                                var formattedCost = parseFloat(quote.total_cost).toLocaleString('en-AU', {
                                    style: 'currency',
                                    currency: 'AUD'
                                });
                                row.append('<td>' + formattedCost + '</td>');
                                
                                // Update button
                                var updateBtn = $('<button></button>')
                                    .addClass('btn btn-sm btn-warning')
                                    .text('Update')
                                    .on('click', function(e) {
                                        e.stopPropagation();
                                        
                                        QuotesEntry.init({
                                            pdfUrl: quote.pdf_url,
                                            pdfDataUrl: null,
                                            containerSelector: `#${contentAreaId}`,
                                            projectPk: projectObj.pk,
                                            projectType: projectObj.project_type,
                                            suppliers: window[contactsVarName],
                                            items: window.itemsItems,
                                            isUpdate: true,
                                            quoteId: quote.quotes_pk,
                                            existingData: {
                                                supplier: quote.supplier_pk || quote.contact_pk,
                                                totalCost: quote.total_cost,
                                                quoteNumber: quote.supplier_quote_number,
                                                allocations: quote.allocations.map(function(alloc) {
                                                    return {
                                                        item: alloc.item_name,
                                                        costing_pk: alloc.costing_pk,
                                                        amount: alloc.amount,
                                                        qty: alloc.qty,
                                                        unit: alloc.unit,
                                                        rate: alloc.rate,
                                                        notes: alloc.notes || ''
                                                    };
                                                })
                                            },
                                            onSave: function(response) {
                                                console.log('Quote updated:', response);
                                                window.loadSharedQuotesSection(config);
                                            },
                                            onCancel: function() {
                                                window.loadSharedQuotesSection(config);
                                            }
                                        });
                                    });
                                row.append($('<td></td>').append(updateBtn));
                                
                                // Delete button
                                var deleteBtn = $('<button></button>')
                                    .addClass('btn btn-sm btn-danger')
                                    .text('Delete')
                                    .on('click', function(e) {
                                        e.stopPropagation();
                                        if (confirm('Are you sure you want to delete quote ' + quote.supplier_quote_number + '?')) {
                                            deleteSharedProjectQuote(quote.quotes_pk, config);
                                        }
                                    });
                                row.append($('<td></td>').append(deleteBtn));
                                
                                tbody.append(row);
                            });
                            
                            // Add click handler for quote rows to show PDF and selection styling
                            $(document).off('click', `#${tableId} tbody tr`).on('click', `#${tableId} tbody tr`, function(e) {
                                if ($(e.target).is('button') || $(e.target).closest('button').length > 0) {
                                    return;
                                }
                                
                                // Remove previous selection styling
                                $(`#${tableId} tbody tr`).removeClass('selected-row');
                                
                                // Add selection styling to clicked row
                                $(this).addClass('selected-row');
                                
                                // Add class to tbody to trigger dimming effect
                                $(`#${tableId} tbody`).addClass('has-selection');
                                
                                var pdfUrl = $(this).attr('data-pdf-url');
                                var quoteNumber = $(this).attr('data-quote-number');
                                
                                if (pdfUrl) {
                                    $(`#${pdfViewerId}`).attr('src', pdfUrl);
                                } else {
                                    alert('No PDF available for quote ' + quoteNumber);
                                }
                            });
                            
                            // Calculate and show total
                            var totalCost = quotes.reduce(function(sum, quote) {
                                return sum + parseFloat(quote.total_cost || 0);
                            }, 0);
                            
                            var formattedTotal = totalCost.toLocaleString('en-AU', {
                                style: 'currency',
                                currency: 'AUD'
                            });
                            
                            $(`#${tableId}-total`).text(formattedTotal);
                            $(`#${tableId}-footer`).show();
                            
                            // Auto-select first quote row (triggers click to load PDF and apply selection styling)
                            if (quotes.length > 0) {
                                setTimeout(function() {
                                    $(`#${tableId} tbody tr:first`).trigger('click');
                                }, 100);
                            }
                        }
                        
                        console.log('Loaded ' + quotes.length + ' quotes for project');
                    } else {
                        console.error('Error loading quotes:', response.message);
                        alert('Error loading quotes: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error loading quotes:', error);
                    alert('Error loading quotes. Please try again.');
                }
            });
        };
        
        // Generic function to delete a quote
        window.deleteSharedProjectQuote = function(quotePk, config) {
            $.ajax({
                url: '/core/delete_quote/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    quote_pk: quotePk
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        console.log('Quote deleted successfully');
                        window.loadSharedProjectQuotes(config);
                    } else {
                        alert('Error deleting quote: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting quote:', error);
                    var errorMessage = 'Error deleting quote. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    alert(errorMessage);
                }
            });
        };
        
        // ==========================================
        // END SHARED QUOTES FUNCTIONS
        // ==========================================
        
        // ==========================================
        // SHARED DOCUMENTS FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedDocumentsSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for documents');
                return;
            }
            
            // Load the documents template from hidden storage
            var documentsHtml = $('#documentsTemplateStorage').html();
            $(`#${contentAreaId}`).html(documentsHtml);
            
            // Initialize DocumentsManager module with container context
            DocumentsManager.init({
                projectPk: projectObj.pk,
                containerSelector: `#${contentAreaId}`
            });
            
            console.log('Documents section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED CONTRACT BUDGET FUNCTION (used by Tender, Construction, and future project types)
        // ==========================================
        
        window.loadSharedContractBudgetSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for contract budget');
                return;
            }
            
            // Set global context variables BEFORE loading template
            // The template's inline script will read these
            window.currentContractBudgetProject = projectObj;
            window.currentContractBudgetContainer = `#${contentAreaId}`;
            
            // Load the contract budget template from hidden storage
            var contractBudgetHtml = $('#contractBudgetTemplateStorage').html();
            $(`#${contentAreaId}`).html(contractBudgetHtml);
            
            console.log('Contract Budget section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
        };
        
        // ==========================================
        // SHARED PO FUNCTION (used by Construction and future project types)
        // ==========================================
        
        window.loadSharedPOSection = function(config) {
            // config should contain: projectObj, contentAreaId
            const { projectObj, contentAreaId } = config;
            
            if (!projectObj || !projectObj.pk) {
                console.error('No project selected for POs');
                return;
            }
            
            // Load the PO template from hidden storage
            var poHtml = $('#poTemplateStorage').html();
            $(`#${contentAreaId}`).html(poHtml);
            
            console.log('PO section loaded for project:', projectObj.pk, 'in container:', contentAreaId);
            
            // Load suppliers from project quotes with contact details
            $.ajax({
                url: '/core/get_project_quotes/' + projectObj.pk + '/',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        var quotes = response.quotes || [];
                        console.log('Loaded', quotes.length, 'quotes for PO suppliers');
                        
                        // Extract unique suppliers with contact info
                        var supplierMap = {};
                        quotes.forEach(function(quote) {
                            var contactPk = quote.supplier_pk || quote.contact_pk;
                            if (contactPk && !supplierMap[contactPk]) {
                                supplierMap[contactPk] = {
                                    contact_pk: contactPk,
                                    name: quote.supplier_name,
                                    first_name: quote.supplier_first_name || '',
                                    last_name: quote.supplier_last_name || '',
                                    email: quote.supplier_email || '',
                                    contact_person: quote.supplier_contact_person || '',
                                    quotes: []
                                };
                            }
                            if (supplierMap[contactPk]) {
                                supplierMap[contactPk].quotes.push(quote);
                            }
                        });
                        
                        var suppliers = Object.values(supplierMap);
                        console.log('Found', suppliers.length, 'unique suppliers');
                        
                        // Fetch PO status for all suppliers
                        $.ajax({
                            url: '/get_po_status/' + projectObj.pk + '/',
                            type: 'GET',
                            success: function(statusResponse) {
                                var poStatus = statusResponse.po_status || {};
                                populatePOTable(suppliers, poStatus, projectObj, contentAreaId);
                            },
                            error: function() {
                                // If status fetch fails, populate without status
                                populatePOTable(suppliers, {}, projectObj, contentAreaId);
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading quotes for PO suppliers:', error);
                }
            });
            
            // Helper function to populate PO table with status
            function populatePOTable(suppliers, poStatus, projectObj, contentAreaId) {
                var tbody = $(`#${contentAreaId} #poSuppliersTableBody`);
                tbody.empty();
                
                if (suppliers.length === 0) {
                    tbody.html('<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 20px;">No suppliers found in quotes</td></tr>');
                } else {
                    // Sort by name
                    suppliers.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    
                    // Track total amount
                    var grandTotal = 0;
                    
                    // Add table rows
                    suppliers.forEach(function(supplier) {
                        // Calculate total amount for this supplier from their quotes
                        var supplierTotal = supplier.quotes.reduce(function(sum, quote) {
                            return sum + parseFloat(quote.total_cost || 0);
                        }, 0);
                        grandTotal += supplierTotal;
                        
                        // Check if PO was sent for this supplier
                        var supplierStatus = poStatus[supplier.contact_pk] || {};
                        var isSent = supplierStatus.sent || false;
                        var pdfUrl = supplierStatus.pdf_url || null;
                        
                        var row = $('<tr></tr>')
                            .attr('data-supplier-pk', supplier.contact_pk)
                            .attr('data-supplier-name', supplier.name)
                            .attr('data-supplier-email', supplier.email)
                            .attr('data-po-sent', isSent ? 'true' : 'false')
                            .attr('data-pdf-url', pdfUrl || '');
                        
                        row.append('<td class="po-supplier-name">' + escapeHtml(supplier.name) + '</td>');
                        
                        // Display first name
                        var firstNameDisplay = supplier.first_name ? 
                            escapeHtml(supplier.first_name) : 
                            '<span style="color: #999; font-style: italic;">-</span>';
                        row.append('<td class="po-first-name">' + firstNameDisplay + '</td>');
                        
                        // Display last name
                        var lastNameDisplay = supplier.last_name ? 
                            escapeHtml(supplier.last_name) : 
                            '<span style="color: #999; font-style: italic;">-</span>';
                        row.append('<td class="po-last-name">' + lastNameDisplay + '</td>');
                        
                        // Display email address
                        var emailDisplay = supplier.email ? 
                            escapeHtml(supplier.email) : 
                            '<span style="color: #999; font-style: italic;">No email</span>';
                        row.append('<td class="po-email">' + emailDisplay + '</td>');
                        
                        // Display amount
                        var formattedAmount = supplierTotal.toLocaleString('en-AU', {
                            style: 'currency',
                            currency: 'AUD'
                        });
                        row.append('<td class="po-amount" style="text-align: right;">' + formattedAmount + '</td>');
                        
                        // Sent status column
                        var sentDisplay = isSent ? 
                            '<i class="fa fa-check" style="color: #28a745;"></i>' : 
                            '<span style="color: #999;">-</span>';
                        row.append('<td style="text-align: center;">' + sentDisplay + '</td>');
                        
                        // Update button
                        var updateBtn = $('<button class="btn btn-sm btn-warning po-update-btn">Update</button>');
                        var updateCell = $('<td></td>').append(updateBtn);
                        row.append(updateCell);
                        
                        // Email button
                        var emailBtn = $('<button class="btn btn-sm btn-primary po-email-btn" title="Send PO email"><i class="fa fa-envelope"></i></button>');
                        emailBtn.on('click', function(e) {
                            e.stopPropagation();
                            if (!supplier.email) {
                                alert('No email address available for this supplier');
                                return;
                            }
                            
                            if (!confirm(`Send purchase order to ${supplier.email}?`)) {
                                return;
                            }
                            
                            // Disable button and show spinner
                            emailBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                            
                            // Send PO email via backend
                            fetch(`/send_po_email/${projectObj.pk}/${supplier.contact_pk}/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                emailBtn.prop('disabled', false).html('<i class="fa fa-envelope"></i>');
                                if (data.status === 'success') {
                                    alert(data.message);
                                    // Update the sent status in the row
                                    row.attr('data-po-sent', 'true');
                                    row.attr('data-pdf-url', data.pdf_url || '');
                                    row.find('td:eq(5)').html('<i class="fa fa-check" style="color: #28a745;"></i>');
                                } else {
                                    alert(`Error: ${data.message}`);
                                }
                            })
                            .catch(error => {
                                emailBtn.prop('disabled', false).html('<i class="fa fa-envelope"></i>');
                                console.error('Error sending PO email:', error);
                                alert('Failed to send email. Please try again.');
                            });
                        });
                        
                        var emailCell = $('<td></td>').append(emailBtn);
                        row.append(emailCell);
                        
                        tbody.append(row);
                    });
                    
                    // Show footer with grand total
                    var formattedGrandTotal = grandTotal.toLocaleString('en-AU', {
                        style: 'currency',
                        currency: 'AUD'
                    });
                    $(`#${contentAreaId} #poTotalAmount`).text(formattedGrandTotal);
                    $(`#${contentAreaId} #poSuppliersTableFooter`).show();
                    
                    // Auto-select first row (triggers click to load PDF and apply selection styling)
                    setTimeout(function() {
                        $(`#${contentAreaId} #poSuppliersTableBody tr:first`).trigger('click');
                    }, 100);
                }
                
                console.log('Suppliers table populated');
            }
            
            // Attach click handler for supplier row selection
            $(`#${contentAreaId}`).off('click', '#poSuppliersTableBody tr').on('click', '#poSuppliersTableBody tr', function() {
                var row = $(this);
                var supplierPk = row.attr('data-supplier-pk');
                var supplierName = row.attr('data-supplier-name');
                var poSent = row.attr('data-po-sent') === 'true';
                var pdfUrl = row.attr('data-pdf-url');
                
                if (!supplierPk) return; // Skip if no supplier data
                
                // Remove previous selection styling
                $(`#${contentAreaId} #poSuppliersTableBody tr`).removeClass('selected-row');
                
                // Add selection styling to clicked row
                row.addClass('selected-row');
                
                // Add class to tbody to trigger dimming effect
                $(`#${contentAreaId} #poSuppliersTableBody`).addClass('has-selection');
                
                // Generate preview on-the-fly (supports construction columns)
                generatePODocument(projectObj, supplierPk, supplierName, contentAreaId);
            });
            
            // PO Update button handler - convert row to editable inputs
            $(`#${contentAreaId}`).off('click', '.po-update-btn').on('click', '.po-update-btn', function(e) {
                e.stopPropagation(); // Don't trigger row click
                const button = $(this);
                const row = button.closest('tr');
                
                // Get current values
                const supplierCell = row.find('.po-supplier-name');
                const firstNameCell = row.find('.po-first-name');
                const lastNameCell = row.find('.po-last-name');
                const emailCell = row.find('.po-email');
                
                const supplier = supplierCell.text().trim();
                const firstName = firstNameCell.text().trim().replace(/-/g, '');
                const lastName = lastNameCell.text().trim().replace(/-/g, '');
                const email = emailCell.text().trim().replace('No email', '');
                
                // Replace cells with input fields
                supplierCell.html(`<input type="text" class="form-control form-control-sm po-supplier-input" value="${escapeHtml(supplier)}" style="width: 100%;">`);
                firstNameCell.html(`<input type="text" class="form-control form-control-sm po-first-name-input" value="${escapeHtml(firstName)}" style="width: 100%;">`);
                lastNameCell.html(`<input type="text" class="form-control form-control-sm po-last-name-input" value="${escapeHtml(lastName)}" style="width: 100%;">`);
                emailCell.html(`<input type="text" class="form-control form-control-sm po-email-input" value="${escapeHtml(email)}" style="width: 100%;">`);
                
                // Change button to Save/Cancel
                button.replaceWith(`
                    <button class="btn btn-sm btn-warning po-save-btn">Update</button>
                    <button class="btn btn-sm btn-secondary po-cancel-btn">Cancel</button>
                `);
            });
            
            // PO Cancel button handler - restore original values
            $(`#${contentAreaId}`).off('click', '.po-cancel-btn').on('click', '.po-cancel-btn', function(e) {
                e.stopPropagation();
                // Reload the section to restore original state
                window.loadSharedPOSection({
                    projectObj: projectObj,
                    contentAreaId: contentAreaId
                });
            });
            
            // PO Save button handler - update contact in Xero
            $(`#${contentAreaId}`).off('click', '.po-save-btn').on('click', '.po-save-btn', function(e) {
                e.stopPropagation();
                const button = $(this);
                const row = button.closest('tr');
                const contactPk = row.attr('data-supplier-pk');
                const xeroInstancePk = projectObj.xero_instance_pk;
                
                // Get new values
                const supplierName = row.find('.po-supplier-input').val().trim();
                const firstName = row.find('.po-first-name-input').val().trim();
                const lastName = row.find('.po-last-name-input').val().trim();
                const email = row.find('.po-email-input').val().trim();
                
                // Basic validation
                if (!supplierName && !firstName && !lastName) {
                    alert('Please provide at least a supplier name or contact name');
                    return;
                }
                
                // Show processing state
                const inputs = row.find('input');
                inputs.prop('disabled', true).css('background-color', '#e9ecef');
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                row.find('.po-cancel-btn').prop('disabled', true);
                
                // Make AJAX call to update contact
                fetch(`/update_contact_details/${xeroInstancePk}/${contactPk}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    body: JSON.stringify({
                        name: supplierName,
                        first_name: firstName,
                        last_name: lastName,
                        email: email
                    })
                })
                .then(response => response.json().then(data => ({status: response.status, body: data})))
                .then(({status, body}) => {
                    if (status === 401 && body.needs_auth) {
                        inputs.prop('disabled', false).css('background-color', '');
                        button.prop('disabled', false).html('Save');
                        row.find('.po-cancel-btn').prop('disabled', false);
                        
                        if (confirm('This Xero instance needs authorization. Would you like to authorize now?')) {
                            window.location.href = `/core/xero_oauth_authorize/${xeroInstancePk}/`;
                        }
                        return;
                    }
                    
                    if (body.status === 'success') {
                        alert('Contact updated successfully!');
                        // Reload the PO section to show updated data
                        window.loadSharedPOSection({
                            projectObj: projectObj,
                            contentAreaId: contentAreaId
                        });
                    } else {
                        alert(`Error: ${body.message}`);
                        inputs.prop('disabled', false).css('background-color', '');
                        button.prop('disabled', false).html('Save');
                        row.find('.po-cancel-btn').prop('disabled', false);
                    }
                })
                .catch(error => {
                    console.error('Error updating contact:', error);
                    alert('Failed to update contact. Please try again.');
                    inputs.prop('disabled', false).css('background-color', '');
                    button.prop('disabled', false).html('Save');
                    row.find('.po-cancel-btn').prop('disabled', false);
                });
            });
        };
        
        function generatePODocument(projectObj, supplierPk, supplierName, contentAreaId) {
            // Load the PO preview in the iframe
            var previewUrl = `/preview_po/${projectObj.pk}/${supplierPk}/`;
            
            $(`#${contentAreaId} #poPlaceholder`).hide();
            $(`#${contentAreaId} #poPreviewFrame`).attr('src', previewUrl).show();
            $(`#${contentAreaId} #poViewerFooter`).addClass('visible');
            
            // Store current supplier info for download
            $(`#${contentAreaId} #downloadPOBtn`).data('supplierPk', supplierPk);
            $(`#${contentAreaId} #downloadPOBtn`).data('supplierName', supplierName);
        }
        
        // Handle PO Download button
        $(document).on('click', '#downloadPOBtn', function() {
            const button = $(this);
            const supplierPk = button.data('supplierPk');
            const supplierName = button.data('supplierName');
            const projectPk = window.currentConstructionProject?.pk;
            
            if (!supplierPk || !projectPk) {
                alert('Please select a supplier first');
                return;
            }
            
            // Disable button and show loading
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generating...');
            
            // Create a form and submit it to trigger download
            const form = $('<form>', {
                method: 'POST',
                action: `/download_po_pdf/${projectPk}/${supplierPk}/`,
                target: '_blank'
            });
            
            // Add CSRF token
            form.append($('<input>', {
                type: 'hidden',
                name: 'csrfmiddlewaretoken',
                value: $('[name=csrfmiddlewaretoken]').val()
            }));
            
            // Append to body, submit, and remove
            form.appendTo('body').submit().remove();
            
            // Re-enable button after a short delay
            setTimeout(function() {
                button.prop('disabled', false).html('<i class="fa fa-download"></i> Download PDF');
            }, 2000);
        });
        
        function escapeHtml(text) {
            if (!text) return '';
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Handle Tender navigation button clicks
        $(document).on('click', '.tender-nav-btn', function() {
            const section = $(this).data('section');
            console.log(`Tender section clicked: ${section}`);
            
            // Remove active class from all buttons
            $('.tender-nav-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            
            // Add active class to clicked button
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            
            // Hide all dynamic action buttons first
            $('#newQuoteBtn').hide();
            
            // Update content area based on section
            if (section === 'quotes') {
                loadQuotesSection();
            } else if (section === 'items') {
                // Load Items section from hidden storage
                var itemsContent = $('#itemsTemplateStorage').html();
                
                // Build the category order dropdown HTML (0 categories = option 1, 3 categories = options 1-4)
                var categoryOrderOptions = '<option value="">Select order...</option><option value="1">1</option>';
                
                // Build the item category dropdown HTML  
                var itemCategoryOptions = '<option value="">Select category...</option>';
                
                // Build the item order dropdown HTML
                var itemOrderOptions = '<option value="">Select category first...</option>';
                
                // Replace the empty selects with pre-populated ones
                itemsContent = itemsContent.replace('<select id="categoryOrderSelect"></select>', 
                    '<select id="categoryOrderSelect">' + categoryOrderOptions + '</select>');
                itemsContent = itemsContent.replace('<select id="itemCategorySelect"></select>', 
                    '<select id="itemCategorySelect">' + itemCategoryOptions + '</select>');
                itemsContent = itemsContent.replace('<select id="itemOrderSelect" disabled></select>', 
                    '<select id="itemOrderSelect" disabled>' + itemOrderOptions + '</select>');
                
                $('#tenderContentArea').html(itemsContent);
                console.log('Items section loaded with pre-populated dropdowns');
                
                // Initialize items functionality after DOM is ready
                setTimeout(function() {
                    initializeItemsSection();
                }, 0);
            } else if (section === 'documents') {
                // Load Documents section
                loadDocumentsSection();
            } else if (section === 'contract-budget') {
                // Load Contract Budget section
                loadContractBudgetSection();
            } else {
                // Placeholder for other sections
                $('#tenderContentArea').html(`
                    <h4>${section.charAt(0).toUpperCase() + section.slice(1).replace('-', ' ')}</h4>
                    <p style="color: #6c757d;">Content for ${section} will be implemented next.</p>
                `);
            }
        });
        
        // Tender Quote Functions - Uses same template as Construction
        
        // Load the quotes section view for TENDER (same format as Construction)
        function loadQuotesSection() {
            console.log('Loading quotes section for Tender with reusable template');
            
            // Initialize AllocationsManager for quotes (shared with Construction)
            initQuotesAllocationsManager();
            
            // Show New Quote button
            $('#newQuoteBtn').show();
            
            // Set shared project reference for quotes (used by loadQuotesData and enterNewQuoteMode)
            window.currentQuotesProject = {
                pk: window.currentTenderProject.pk,
                project_type: window.currentTenderProject.project_type,
                contacts: window.projectContacts || []
            };
            
            // Load contacts for the project if not already loaded
            if (!window.projectContacts || window.projectContacts.length === 0) {
                const projectPk = window.currentTenderProject.pk;
                $.ajax({
                    url: '{% url "core:get_project_contacts" 0 %}'.replace('0', projectPk),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.projectContacts = response.contacts;
                            window.currentQuotesProject.contacts = response.contacts;
                            console.log('Loaded', response.contacts.length, 'contacts for Tender quotes');
                        }
                    }
                });
            }
            
            // Load the same quotes template used by Construction
            $.ajax({
                url: '{% url "core:quotes" %}',
                type: 'GET',
                success: function(response) {
                    $('#tenderContentArea').html(response);
                    // Update headers based on project type before loading data
                    updateQuoteAllocationsHeaders();
                    // Now fetch and populate the quotes
                    loadQuotesData();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load quotes section:', error);
                    $('#tenderContentArea').html(`
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h4>Error Loading Quotes</h4>
                            <p>${error}</p>
                        </div>
                    `);
                }
            });
        }
        
        // Load the documents section view for TENDER
        function loadDocumentsSection() {
            window.loadSharedDocumentsSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
        
        // Load the contract budget section view for TENDER
        function loadContractBudgetSection() {
            window.loadSharedContractBudgetSection({
                projectObj: window.currentTenderProject,
                contentAreaId: 'tenderContentArea'
            });
        }
        
        // Initialize Items Section Function
        function initializeItemsSection() {
            // Clear global variables for items management
            window.itemsCategories = [];
            window.itemsItems = [];
            
            // Clear the table immediately to prevent showing stale data
            var tbody = $('#tenderContentArea #itemsDisplayTableBody');
            if (tbody.length > 0) {
                tbody.html('<tr><td style="text-align: center; color: #6c757d; padding: 20px;">Loading...</td></tr>');
            }
            
            // Dropdown update functions
            // Update category order dropdown
            function updateCategoryOrderDropdown() {
                var select = document.querySelector('#tenderContentArea #categoryOrderSelect');
                if (!select) return;
                
                // Add 1 to number of categories: if 0 categories, show option 1; if 3 categories, show 1,2,3,4
                var maxOrder = window.itemsCategories.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Update item category dropdown
            function updateItemCategoryDropdown() {
                var select = document.querySelector('#tenderContentArea #itemCategorySelect');
                if (!select) return;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select category...</option>';
                window.itemsCategories.forEach(function(category) {
                    optionsHTML += '<option value="' + category.categories_pk + '">' + category.category + '</option>';
                });
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
            }
            
            // Load and populate unit dropdown
            function loadAndPopulateUnits() {
                $.ajax({
                    url: '/get_units/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            var select = document.querySelector('#tenderContentArea #itemUnitSelect');
                            if (!select) return;
                            
                            // Build options HTML string
                            var optionsHTML = '<option value="">Select unit...</option>';
                            response.units.forEach(function(unit) {
                                optionsHTML += '<option value="' + unit.unit_pk + '">' + unit.unit_name + '</option>';
                            });
                            
                            // Replace select's innerHTML
                            select.innerHTML = optionsHTML;
                        } else {
                            console.error('Error loading units:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading units:', error);
                    }
                });
            }
            
            // Update item order dropdown based on selected category
            function updateItemOrderDropdown(categoryPk) {
                var select = document.querySelector('#tenderContentArea #itemOrderSelect');
                if (!select) return;
                
                if (!categoryPk) {
                    select.innerHTML = '<option value="">Select category first...</option>';
                    select.disabled = true;
                    return;
                }
                
                // Count items in this category
                var itemsInCategory = window.itemsItems.filter(function(item) {
                    return item.category__category === getCategoryName(categoryPk);
                });
                
                // Add 1 to number of items: if 0 items, show option 1; if 3 items, show 1,2,3,4
                var maxOrder = itemsInCategory.length + 1;
                
                // Build options HTML string
                var optionsHTML = '<option value="">Select order...</option>';
                for (var i = 1; i <= maxOrder; i++) {
                    optionsHTML += '<option value="' + i + '">' + i + '</option>';
                }
                
                // Replace select's innerHTML
                select.innerHTML = optionsHTML;
                select.disabled = false;
            }
            
            // Get category name by PK
            function getCategoryName(categoryPk) {
                var category = window.itemsCategories.find(function(cat) {
                    return cat.categories_pk == categoryPk;
                });
                return category ? category.category : '';
            }
            
            // Load units for the unit dropdown
            loadAndPopulateUnits();
            
            // Load categories and items for current project
            if (window.currentTenderProject && window.currentTenderProject.pk) {
                loadProjectItems(window.currentTenderProject.pk);
            }
            
            // Load categories and items for a project
            function loadProjectItems(projectPk) {
                console.log('Loading items for project:', projectPk);
                
                // Load categories
                $.ajax({
                    url: '/get_project_categories/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsCategories = response.categories;
                            console.log('Loaded categories:', window.itemsCategories);
                            updateCategoryOrderDropdown();
                            updateItemCategoryDropdown();
                            loadItems(projectPk);
                        } else {
                            console.error('Error loading categories:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load categories:', error);
                    }
                });
            }
            
            // Load items
            function loadItems(projectPk) {
                $.ajax({
                    url: '/get_project_items/' + projectPk + '/',
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.itemsItems = response.items;
                            console.log('Loaded items:', window.itemsItems);
                            renderItemsTable();
                        } else {
                            console.error('Error loading items:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to load items:', error);
                    }
                });
            }
            
            // Render items display table with drag-and-drop
            function renderItemsTable() {
                // Use scoped selector to ensure we target the correct table in tenderContentArea
                var tbody = $('#tenderContentArea #itemsDisplayTableBody');
                if (tbody.length === 0) {
                    console.error('Table body not found in DOM');
                    return;
                }
                
                tbody.empty();
                
                if (window.itemsItems.length === 0) {
                    tbody.append('<tr><td colspan="3" style="text-align: center; color: #6c757d; padding: 20px;">No items yet. Add a category and items to get started.</td></tr>');
                    return;
                }
                
                // Group items by category
                var groupedItems = {};
                window.itemsItems.forEach(function(item) {
                    var categoryName = item.category__category;
                    if (!groupedItems[categoryName]) {
                        groupedItems[categoryName] = [];
                    }
                    groupedItems[categoryName].push(item);
                });
                
                // Sort categories by order_in_list
                window.itemsCategories.sort(function(a, b) {
                    return a.order_in_list - b.order_in_list;
                });
                
                // Render each category and its items
                window.itemsCategories.forEach(function(category, catIndex) {
                    var items = groupedItems[category.category] || [];
                    
                    // Sort items by order_in_list
                    items.sort(function(a, b) {
                        return (a.order_in_list || 0) - (b.order_in_list || 0);
                    });
                    
                    // Render category header row (draggable unless Internal)
                    var isInternal = category.category === 'Internal';
                    var categoryRow = $('<tr></tr>')
                        .addClass('category-row')
                        .attr('data-category-pk', category.categories_pk)
                        .attr('data-category-order', category.order_in_list);
                    
                    if (isInternal) {
                        // Internal category: purple, not draggable, can't be deleted
                        categoryRow.addClass('internal-category');
                    } else {
                        // Regular category: draggable, can be deleted
                        categoryRow.attr('draggable', 'true')
                            .css({
                                'background-color': '#f0f0f0',
                                'font-weight': 'bold',
                                'cursor': 'move'
                            });
                    }
                    
                    // Add category name cell (no emoji, clean like Contract Budget)
                    categoryRow.append('<td>' + category.category + '</td>');
                    
                    // Add empty unit cell for category rows
                    categoryRow.append('<td></td>');
                    
                    // Add delete button cell
                    var deleteCell = $('<td style="text-align: center;"></td>');
                    if (isInternal) {
                        // Internal category cannot be deleted
                        deleteCell.append('<button class="delete-btn" disabled title="Internal category cannot be deleted">‚úï</button>');
                    } else {
                        // Regular category can be deleted
                        var deleteBtn = $('<button class="delete-btn delete-category-btn" title="Delete category and all items"></button>')
                            .attr('data-category-pk', category.categories_pk)
                            .attr('data-category-name', category.category)
                            .text('‚úï');
                        deleteCell.append(deleteBtn);
                    }
                    categoryRow.append(deleteCell);
                    
                    tbody.append(categoryRow);
                    
                    // Render items under this category (draggable within category)
                    items.forEach(function(item, itemIndex) {
                        var itemRow = $('<tr></tr>')
                            .addClass('item-row')
                            .attr('draggable', 'true')
                            .attr('data-item-pk', item.costing_pk)
                            .attr('data-category-pk', category.categories_pk)
                            .attr('data-item-order', item.order_in_list || (itemIndex + 1))
                            .css('cursor', 'move');
                        
                        // Apply purple styling if item is in Internal category
                        if (isInternal) {
                            itemRow.addClass('internal-item');
                        }
                        
                        // Add item name cell with indent class (no tree characters, clean like Contract Budget)
                        itemRow.append('<td class="indent">' + item.item + '</td>');
                        
                        // Add unit cell
                        var unitDisplay = item.unit || '-';
                        itemRow.append('<td>' + unitDisplay + '</td>');
                        
                        // Add delete button cell for items
                        var itemDeleteCell = $('<td style="text-align: center;"></td>');
                        var itemDeleteBtn = $('<button class="delete-btn delete-item-btn" title="Delete item"></button>')
                            .attr('data-item-pk', item.costing_pk)
                            .attr('data-item-name', item.item)
                            .text('‚úï');
                        itemDeleteCell.append(itemDeleteBtn);
                        itemRow.append(itemDeleteCell);
                        
                        tbody.append(itemRow);
                    });
                });
                
                // Attach drag-and-drop event handlers
                attachDragHandlers();
            }
            
            // Drag-and-drop event handlers
            var draggedElement = null;
            var draggedType = null; // 'category' or 'item'
            
            function attachDragHandlers() {
                // Category rows - can drag anywhere (except Internal)
                $('.category-row:not(.internal-category)').on('dragstart', function(e) {
                    draggedElement = this;
                    draggedType = 'category';
                    $(this).css('opacity', '0.4');
                    e.originalEvent.dataTransfer.effectAllowed = 'move';
                });
                
                $('.category-row').on('dragend', function(e) {
                    $(this).css('opacity', '1');
                    $('.drag-over').removeClass('drag-over');
                });
                
                $('.category-row').on('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.originalEvent.dataTransfer.dropEffect = 'move';
                    
                    if ($(this)[0] !== draggedElement) {
                        $(this).addClass('drag-over');
                    }
                    return false;
                });
                
                $('.category-row').on('dragleave', function(e) {
                    $(this).removeClass('drag-over');
                });
                
                $('.category-row').on('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    $(this).removeClass('drag-over');
                    
                    if (draggedElement !== this) {
                        if (draggedType === 'category') {
                            // Moving a category
                            var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                            var targetCategoryOrder = parseInt($(this).attr('data-category-order'));
                            
                            reorderCategory(draggedCategoryPk, targetCategoryOrder);
                        }
                    }
                    
                    return false;
                });
                
                // Item rows - can only drag within category
                $('.item-row').on('dragstart', function(e) {
                    draggedElement = this;
                    draggedType = 'item';
                    $(this).css('opacity', '0.4');
                    e.originalEvent.dataTransfer.effectAllowed = 'move';
                });
                
                $('.item-row').on('dragend', function(e) {
                    $(this).css('opacity', '1');
                    $('.drag-over').removeClass('drag-over');
                });
                
                $('.item-row').on('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    
                    // Only allow drop if same category
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryPk = $(this).attr('data-category-pk');
                    
                    if (draggedType === 'item' && draggedCategoryPk === targetCategoryPk) {
                        e.originalEvent.dataTransfer.dropEffect = 'move';
                        if ($(this)[0] !== draggedElement) {
                            $(this).addClass('drag-over');
                        }
                    } else {
                        e.originalEvent.dataTransfer.dropEffect = 'none';
                    }
                    
                    return false;
                });
                
                $('.item-row').on('dragleave', function(e) {
                    $(this).removeClass('drag-over');
                });
                
                $('.item-row').on('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    $(this).removeClass('drag-over');
                    
                    // Only allow drop if same category
                    var draggedCategoryPk = $(draggedElement).attr('data-category-pk');
                    var targetCategoryPk = $(this).attr('data-category-pk');
                    
                    if (draggedElement !== this && draggedType === 'item' && draggedCategoryPk === targetCategoryPk) {
                        var draggedItemPk = $(draggedElement).attr('data-item-pk');
                        var targetItemOrder = parseInt($(this).attr('data-item-order'));
                        
                        reorderItem(draggedItemPk, targetItemOrder);
                    }
                    
                    return false;
                });
            }
            
            // Reorder category via AJAX
            function reorderCategory(categoryPk, newOrder) {
                $.ajax({
                    url: '/reorder_category/' + window.currentTenderProject.pk + '/' + categoryPk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        new_order: newOrder
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Reload all data to reflect new order
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to reorder category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            }
            
            // Reorder item via AJAX
            function reorderItem(itemPk, newOrder) {
                $.ajax({
                    url: '/reorder_item/' + window.currentTenderProject.pk + '/' + itemPk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        new_order: newOrder
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            // Reload all data to reflect new order
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to reorder item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            }
            
            // Validation for Add Category button
            function validateCategoryForm() {
                // Use scoped selectors to only target elements within tenderContentArea
                var categoryName = $('#tenderContentArea #categoryNameInput').val();
                if (categoryName) categoryName = categoryName.trim();
                var orderInList = $('#tenderContentArea #categoryOrderSelect').val();
                
                var isValid = categoryName && categoryName.length > 0 && orderInList !== '';
                
                var btn = $('#tenderContentArea #addCategoryBtn');
                
                if (isValid) {
                    btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
                } else {
                    btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
                }
            }
            
            // Validation for Add Item button
            function validateItemForm() {
                // Use scoped selectors to only target elements within tenderContentArea
                var itemName = $('#tenderContentArea #itemNameInput').val();
                if (itemName) itemName = itemName.trim();
                var itemUnit = $('#tenderContentArea #itemUnitSelect').val();
                var categoryPk = $('#tenderContentArea #itemCategorySelect').val();
                var orderInList = $('#tenderContentArea #itemOrderSelect').val();
                
                var isValid = itemName && itemName.length > 0 && itemUnit && itemUnit.length > 0 && categoryPk !== '' && orderInList !== '';
                
                var btn = $('#tenderContentArea #addItemBtn');
                if (isValid) {
                    btn.removeClass('disabled').addClass('enabled').prop('disabled', false);
                } else {
                    btn.removeClass('enabled').addClass('disabled').prop('disabled', true);
                }
            }
            
            // Event listeners for validation (scoped to tenderContentArea)
            // Remove old handlers first to prevent duplicates
            $('#tenderContentArea').off('input change', '#categoryNameInput, #categoryOrderSelect').on('input change', '#categoryNameInput, #categoryOrderSelect', function(e) {
                validateCategoryForm();
            });
            $('#tenderContentArea').off('input change', '#itemNameInput, #itemUnitSelect, #itemCategorySelect, #itemOrderSelect').on('input change', '#itemNameInput, #itemUnitSelect, #itemCategorySelect, #itemOrderSelect', function(e) {
                validateItemForm();
            });
            
            // Event listener for item category selection
            // Remove old handler first to prevent duplicates
            $('#tenderContentArea').off('change', '#itemCategorySelect').on('change', '#itemCategorySelect', function() {
                var categoryPk = $(this).val();
                updateItemOrderDropdown(categoryPk);
                validateItemForm();
            });
            
            // Trigger validation on page load to set initial button states
            setTimeout(function() {
                validateCategoryForm();
                validateItemForm();
            }, 100);
            
            // Add Category button click (scoped to tenderContentArea)
            // Remove old handler first to prevent duplicate submissions
            $('#tenderContentArea').off('click', '#addCategoryBtn').on('click', '#addCategoryBtn', function() {
                if ($(this).hasClass('disabled')) return;
                
                var categoryName = $('#tenderContentArea #categoryNameInput').val().trim();
                var orderInList = $('#tenderContentArea #categoryOrderSelect').val();
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                $.ajax({
                    url: '/create_category/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        category: categoryName,
                        order_in_list: parseInt(orderInList)
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Category created:', response.category);
                            
                            // Reload all categories since order may have changed
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear form
                            $('#tenderContentArea #categoryNameInput').val('');
                            $('#tenderContentArea #categoryOrderSelect').val('');
                            validateCategoryForm();
                            
                            alert('Category added successfully!');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to create category:', error);
                        var errorMessage = 'Failed to create category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to create category: ' + error;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Add Item button click (scoped to tenderContentArea)
            // Remove old handler first to prevent duplicate submissions
            $('#tenderContentArea').off('click', '#addItemBtn').on('click', '#addItemBtn', function() {
                if ($(this).hasClass('disabled')) return;
                
                var itemName = $('#tenderContentArea #itemNameInput').val().trim();
                var itemUnit = $('#tenderContentArea #itemUnitSelect').val();
                var categoryPk = $('#tenderContentArea #itemCategorySelect').val();
                var orderInList = $('#tenderContentArea #itemOrderSelect').val();
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                $.ajax({
                    url: '/create_item/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        item: itemName,
                        unit: itemUnit,
                        category_pk: parseInt(categoryPk),
                        order_in_list: parseInt(orderInList)
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Item created:', response.item);
                            
                            // Reload all items since order may have changed
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear form
                            $('#tenderContentArea #itemNameInput').val('');
                            $('#tenderContentArea #itemUnitSelect').val('');
                            $('#tenderContentArea #itemOrderSelect').val('');
                            
                            // Keep category selected for convenience
                            // (user might want to add more items to same category)
                            updateItemOrderDropdown(categoryPk);
                            validateItemForm();
                            
                            alert('Item added successfully!');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to create item:', error);
                        var errorMessage = 'Failed to create item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to create item: ' + error;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Download Example CSV button
            $('#tenderContentArea').off('click', '#downloadExampleCsvBtn').on('click', '#downloadExampleCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger download of example CSV
                window.location.href = '/download_items_csv_template/';
            });
            
            // Upload CSV button - triggers file picker
            $('#tenderContentArea').off('click', '#uploadCsvBtn').on('click', '#uploadCsvBtn', function() {
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Trigger the hidden file input
                $('#tenderContentArea #csvFileInput').click();
            });
            
            // CSV File input change handler - immediately upload when file selected
            $('#tenderContentArea').off('change', '#csvFileInput').on('change', '#csvFileInput', function() {
                const fileInput = this;
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Validate file type
                if (!file.name.endsWith('.csv')) {
                    alert('Please select a valid CSV file');
                    fileInput.value = '';
                    return;
                }
                
                // Create FormData and upload
                const formData = new FormData();
                formData.append('csv_file', file);
                formData.append('project_pk', window.currentTenderProject.pk);
                
                // Show uploading state on upload button
                const uploadBtn = $('#uploadCsvBtn');
                const originalText = uploadBtn.html();
                uploadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
                
                $.ajax({
                    url: '/upload_items_csv/' + window.currentTenderProject.pk + '/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            let message = `Success! Created ${response.categories_created} categories and ${response.items_created} items.`;
                            
                            // Add warnings if any
                            if (response.warnings && response.warnings.length > 0) {
                                message += '\n\nWarnings:\n' + response.warnings.slice(0, 5).join('\n');
                                if (response.warnings.length > 5) {
                                    message += `\n... and ${response.warnings.length - 5} more warnings`;
                                }
                            }
                            
                            alert(message);
                            
                            // Reload items to show new data
                            loadProjectItems(window.currentTenderProject.pk);
                            
                            // Clear file input
                            fileInput.value = '';
                        } else {
                            alert('Error: ' + response.message);
                        }
                        
                        uploadBtn.prop('disabled', false).html(originalText);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to upload CSV:', error);
                        let errorMessage = 'Failed to upload CSV';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (error) {
                            errorMessage = 'Failed to upload CSV: ' + error;
                        }
                        alert(errorMessage);
                        uploadBtn.prop('disabled', false).html(originalText);
                        fileInput.value = '';
                    }
                });
            });
            
            // Delete Category button handler
            $('#tenderContentArea').off('click', '.delete-category-btn').on('click', '.delete-category-btn', function(e) {
                e.stopPropagation(); // Prevent drag events
                
                var categoryPk = $(this).attr('data-category-pk');
                var categoryName = $(this).attr('data-category-name');
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Confirmation dialog
                var itemCount = window.itemsItems.filter(function(item) {
                    return item.category__category === categoryName;
                }).length;
                
                var message = `Are you sure you want to delete the category "${categoryName}"?`;
                if (itemCount > 0) {
                    message += `\n\nThis will also delete ${itemCount} item(s) in this category.`;
                }
                
                if (!confirm(message)) {
                    return;
                }
                
                // Make AJAX call to delete category
                $.ajax({
                    url: `/core/delete_category/${window.currentTenderProject.pk}/${categoryPk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            // Reload items to reflect deletion
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete category:', error);
                        var errorMessage = 'Failed to delete category';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            });
            
            // Delete Item button handler
            $('#tenderContentArea').off('click', '.delete-item-btn').on('click', '.delete-item-btn', function(e) {
                e.stopPropagation(); // Prevent drag events
                
                var itemPk = $(this).attr('data-item-pk');
                var itemName = $(this).attr('data-item-name');
                
                if (!window.currentTenderProject || !window.currentTenderProject.pk) {
                    alert('No project selected');
                    return;
                }
                
                // Confirmation dialog
                if (!confirm(`Are you sure you want to delete the item "${itemName}"?`)) {
                    return;
                }
                
                // Make AJAX call to delete item
                $.ajax({
                    url: `/core/delete_item/${window.currentTenderProject.pk}/${itemPk}/`,
                    type: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);
                            // Reload items to reflect deletion
                            loadProjectItems(window.currentTenderProject.pk);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to delete item:', error);
                        var errorMessage = 'Failed to delete item';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    }
                });
            });
        }
    });
</script>
